<html><head><base href="."/>
<title>Texas Powerball Generator | vE10_D3</title>
<style>
    .section-title-row{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:16px;
        margin-bottom: 10px;
        padding: 0 6px;
    }
    .section-toggle{
        display:flex;
        align-items:center;
        gap:8px;
        font-size: 14px;
        user-select:none;
        white-space:nowrap;
    }
    .section-toggle input[type="checkbox"]{
        transform: scale(1.05);
        accent-color:#0f7a34;
    }
.lottery-header {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 20px;
}
.lottery-logo {
    width: 100%;
    max-width: 300px;
    height: auto;
}
.lottery-header h1 {
    flex: 1;
    text-align: center;
    cursor: default;
}
body {
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg, #f0f8ff, #e6e6fa);
  display: flex;
  justify-content: center;
  align-items: flex-start;   /* keep the container pinned to the top */
  min-height: 100vh;         /* optional—only ensures a minimum height */
  margin: 0;
  padding: 20px;
}
.lottery-container {
    background: white;
    padding: 2rem;
    border-radius: 15px;
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    text-align: center;
    width: 95%;
    max-width: 1200px;
}
.controls {
    display: flex;
    gap: 20px;
    justify-content: center;
    margin: 20px 0;
    flex-wrap: wrap;
}
.control-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
}
.control-label {
    font-weight: bold;
    color: #333;
}
.prediction-methods {
    margin: 20px 0;
}
.radio-group {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 10px;
}
.radio-group label {
    display: flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
    position: relative;
}
.tooltip {
    visibility: hidden;
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 14px;
    width: 200px;
    z-index: 1000;
    text-align: center;
    opacity: 0;
    transition: opacity 0.3s;
}
.tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
}
.radio-group label:hover .tooltip {
    visibility: visible;
    opacity: 1;
}
.export-controls {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin: 20px 0;
    flex-wrap: wrap;
}
.draw-container {
    margin: 15px 0;
    border-bottom: 1px solid #eee;
    padding: 5px;
}
.probability {
    color: #666;
    font-style: italic;
    margin: 10px 0;
    font-size: 14px;
    padding: 5px;
    background: #f5f5f5;
    border-radius: 5px;
    display: inline-block;
}
.draw-date {
    font-weight: bold;
    color: #333;
    margin: 10px 0;
}
.ball-container {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin: 10px 0;
    height: 200px;
    align-items: flex-start;
}
.ball {
    width: 200px;
    height: 200px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 51px;
    font-weight: bold;
    color: #000000;
    background: radial-gradient(circle at 30% 30%,
        rgba(255,255,255,0.8) 0%,
        rgba(255,255,255,0.3) 20%,
        rgba(79,167,255,0.6) 50%,
        #147AFF 90%);
    position: relative;
    top: -400px;
    box-shadow:
        inset -10px -10px 20px rgba(0,0,0,0.3),
        0 4px 8px rgba(0,0,0,0.2);
    scale: 0.5;
    opacity: 0;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.ball:hover {
    transform: scale(1.1) translateY(-5px);
    box-shadow:
        inset -10px -10px 20px rgba(0,0,0,0.3),
        0 8px 16px rgba(0,0,0,0.3);
    z-index: 1;
}
.powerball {
    background: radial-gradient(circle at 30% 30%,
        rgba(255,255,255,0.8) 0%,
        rgba(255,255,255,0.3) 20%,
        rgba(255,75,43,0.6) 50%,
        #ff416c 90%);
}
button, input {
    padding: 10px 20px;
    border-radius: 25px;
    font-size: 16px;
}
button {
    background: linear-gradient(145deg, #2ecc71, #27ae60);
    border: none;
    color: white;
    cursor: pointer;
    transition: transform 0.2s ease;
}
button:disabled {
    background: linear-gradient(145deg, #cccccc, #999999);
    cursor: not-allowed;
    opacity: 0.5;
    transform: none;
}
button:hover {
    transform: scale(1.05);
}
button:disabled:hover {
    transform: none;
}
.input {
    border: 1px solid #ccc;
    text-align: center;
}
.export-btn {
    background: linear-gradient(145deg, #0f7a34, #0b5e27);
    padding: 10px 20px;
    border-radius: 25px;
    border: none;
    color: white;
    cursor: pointer;
    font-size: 16px;
    transition: transform 0.2s ease;
}
.export-btn:hover {
    transform: scale(1.05);
}
.export-btn:disabled {
    background: linear-gradient(145deg, #cccccc, #999999);
    cursor: not-allowed;
    transform: none;
}
.export-btn:disabled:hover {
    transform: none;
}
.automation-controls {
    display: none;
    gap: 20px;
    justify-content: center;
    margin: 20px 0;
    flex-wrap: wrap;
    padding: 15px;
    background: #f5f5f5;
    border-radius: 10px;
}
.progress-container {
    display: none;
    width: 100%;
    margin: 20px 0;
    text-align: center;
}
.progress-bar {
    width: 100%;
    max-width: 500px;
    height: 20px;
    background-color: #f0f0f0;
    border-radius: 10px;
    overflow: hidden;
    margin: 10px auto;
}
.progress-fill {
    height: 100%;
    background: linear-gradient(145deg, #2ecc71, #27ae60);
    width: 0%;
    transition: width 0.3s ease;
}
.progress-text {
    color: #666;
    font-size: 14px;
    margin-top: 5px;
}
#trainingProgressWrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: 20px;
}
#trainingProgressLabel {
    font-size: 1.2em;
    margin-bottom: 10px;
}
#trainingProgress {
    width: 80%;
    height: 20px;
}
@keyframes dropAndBounce {
    0% {
        transform: scale(0.5);
        top: -400px;
        opacity: 0;
    }
    40% {
        transform: scale(1.2);
        top: -80px;
        opacity: 1;
    }
    60% {
        transform: scale(1);
        top: 40px;
        opacity: 1;
    }
    75% {
        transform: scale(1.1);
        top: -20px;
        opacity: 1;
    }
    85% {
        transform: scale(1);
        top: 20px;
        opacity: 1;
    }
    95% {
        transform: scale(1.05);
        top: -10px;
        opacity: 1;
    }
    100% {
        transform: scale(1);
        top: 0;
        opacity: 1;
    }
}
@media print {
    body {
        background: white;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
    }
    .lottery-container {
        box-shadow: none;
        width: 100%;
        padding: 0;
    }
    .controls, .export-controls {
        display: none;
    }
    .draw-container {
        break-inside: avoid;
        page-break-inside: avoid;
    }
    .draw-container:nth-child(5n) {
        page-break-after: always;
    }
    .ball {
        print-color-adjust: exact;
        -webkit-print-color-adjust: exact;
    }
    .print-condensed .lottery-container {
        transform: scale(0.80) !important;
        transform-origin: top center;
        margin: 0 !important;
    }
    .print-condensed .draw-container {
        margin: 5px 0;
        padding: 2px;
    }
    .print-condensed .ball-container {
        margin: 5px 0;
    }
    .print-condensed .draw-date {
        margin: 5px 0;
    }
}
.history-table-container {
    margin: 40px 0;
    padding: 20px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.history-table-title {
    text-align: center;
    color: #333;
    font-size: 24px;
    margin-bottom: 20px;
}
.drawing-history {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
}
.drawing-history tr.all-numbers-match {
    background-color: rgba(0, 0, 255, 0.1) !important;
}
.drawing-history tr.all-numbers-match:hover {
    background-color: rgba(0, 0, 255, 0.2) !important;
}
.drawing-history .number-cell {
    display: inline-block;
    margin-right: 5px;
}
.drawing-history td.powerball-number {
    text-align: left;
}
.drawing-history th,
.drawing-history td {
    text-align: left !important;
    padding: 12px !important;
    vertical-align: top;
}
.duplicate-number {
    color: green;
    font-weight: bold;
}
.drawing-history tr.highest-probability {
    background-color: rgba(255, 255, 0, 0.2) !important;
}
.drawing-history tr.highest-probability:hover {
    background-color: rgba(255, 255, 0, 0.3) !important;
}
@media print {
    .drawing-history th,
    .drawing-history td {
        text-align: left !important;
        padding: 12px !important;
    }
    .powerball-number {
        color: #ff0000 !important;
        font-weight: bold !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
}
.drawing-history .powerball-number {
    color: #ff0000 !important;
    font-weight: bold !important;
}
@media print {
    .powerball-number {
        color: #ff0000 !important;
        font-weight: bold !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
    .duplicate-number {
        color: #008000 !important;
        font-weight: bold !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
}
.drawing-history tr {
    position: relative;
}
.drawing-history tr.all-numbers-match:hover::after,
.drawing-history tr.highest-probability:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    bottom: 100%;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 14px;
    white-space: nowrap;
    z-index: 1000;
}
/* vNext Fix: make manual-entry "ball" inputs comfortably fit 2 digits and remove number spinners */
.number-input {
  width: 88px !important;
  height: 88px !important;
  font-size: 26px !important;
  padding: 0 !important;
  line-height: 1 !important;
}
.number-input::-webkit-outer-spin-button,
.number-input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
.number-input[type=number] {
  -moz-appearance: textfield;
}
/* Play Slip (v35 UI alignment) */
.play-slip-container{
  margin: 40px 0;
  text-align:center;
}
.play-slip-container .history-table-title{
  margin-bottom: 12px;
}
.play-slip-container button,
.play-slip-container select{
  font-size: 15px;
}
.slip-options-row{
  display:flex;
  align-items:center;
  justify-content:flex-start;
  gap:12px;
  flex-wrap:wrap;
  margin: 10px 0 18px;
}
.play-slip-container .slip-row,
.play-slip-container .slip-options-row,
.play-slip-container .export-controls{
  margin-right:auto;
}
.slip-row{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:12px;
  flex-wrap:wrap;
  margin: 10px 0 18px;
}
.option-toggle{
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px 10px;
  border-radius:999px;
  border:1px solid rgba(0,0,0,.10);
  background: rgba(255,255,255,.9);
  box-shadow: 0 2px 8px rgba(0,0,0,.05);
  font-size:14px;
  color:#111827;
  user-select:none;
  white-space:nowrap;
}
.option-toggle input[type="checkbox"],
.option-toggle input[type="radio"]{
  transform: scale(1.05);
  accent-color:#0f7a34;
}
.export-card .history-table-title{
  margin-bottom: 12px;
}
.export-btn{
  font-weight: 700;
}
.export-btn:disabled{
  opacity: .55;
  cursor: not-allowed;
  transform:none !important;
}
.slip-row label{
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px 10px;
  border-radius:999px;
  border:1px solid rgba(0,0,0,.10);
  background: rgba(255,255,255,.9);
  box-shadow: 0 2px 8px rgba(0,0,0,.05);
  font-size:14px;
  color:#111827;
  user-select:none;
  white-space:nowrap;
}
.slip-row label input[type="checkbox"]{ transform: scale(1.05); accent-color:#0f7a34; }
/* Explainability Panel (v32 UI) */
.explainability-panel{
  margin-top:14px;
  padding:14px;
  border-radius:14px;
  border:1px solid rgba(0,0,0,.08);
  background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(250,252,255,.96));
  box-shadow: 0 6px 18px rgba(0,0,0,.06);
}
.explainability-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:10px;
}
.explainability-header h2{
  margin:0;
  font-size:18px;
  color:#111827;
  letter-spacing:.2px;
}
.explainability-sub{
  font-size:12px;
  color:#4b5563;
  margin-left:0;
}
.explainability-content{
  padding:0;
  background:transparent;
  border:none;
}
/* --- Methodology Rationale (static breakdown) --- */

/* When Methodology Rationale is toggled "off", keep Run Breakdown visible */
#explainabilityContent.explainability-collapsed .mr-static,
#explainabilityContent.explainability-collapsed details,
#explainabilityContent.explainability-collapsed .mr-divider,
#explainabilityContent.explainability-collapsed .explainability-sub{
  display:none !important;
}

.mr-static{
  text-align:left;
  margin-bottom: 10px;
}
.mr-meta{
  display:flex;
  flex-wrap:wrap;
  gap:10px 14px;
  align-items:center;
  justify-content:space-between;
  padding: 10px 12px;
  border: 1px dashed rgba(17,24,39,.25);
  border-radius: 12px;
  background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(249,250,251,.92));
}
.mr-meta .mr-meta-item{
  display:flex;
  align-items:baseline;
  gap:8px;
  min-width: 220px;
}
.mr-meta .mr-meta-label{
  font-size:12px;
  color:#374151;
  font-weight:800;
  letter-spacing:.2px;
}
.mr-meta .mr-meta-value{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size:12px;
  color:#111827;
  font-weight:800;
}
.mr-meta-band{
  margin-left:8px;
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  font-size:12px;
  font-weight:800;
  border:1px solid rgba(0,0,0,.08);
  background:#f3f4f6;
  color:#111827;
}
.mr-meta-band.stable{ background:#dcfce7; color:#166534; border-color:#86efac; }
.mr-meta-band.moderate{ background:#fef9c3; color:#854d0e; border-color:#fde047; }
.mr-meta-band.volatile{ background:#fee2e2; color:#991b1b; border-color:#fecaca; }
.mr-version{
  margin-left:10px;
  font-size:12px;
  font-weight:900;
  padding:2px 8px;
  border-radius:999px;
  background:#e0e7ff;
  color:#1e3a8a;
  border:1px solid rgba(30,58,138,.25);
}
.mr-block{
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  padding: 10px 12px;
  margin: 10px 0;
  background: linear-gradient(180deg, #ffffff, #fbfbff);
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}
.mr-block > summary{
  cursor: pointer;
  font-weight: 800;
  color: #111827;
  list-style: none;
  outline: none;
}
.mr-block > summary::-webkit-details-marker{ display:none; }
.mr-block > summary:before{
  content: "▸";
  display:inline-block;
  margin-right: 8px;
  transform: translateY(-1px);
}
.mr-block[open] > summary:before{ content: "▾"; }
.mr-block ul{
  margin: 10px 0 0 18px;
  color:#374151;
}
.mr-divider{
  height: 1px;
  background: #e5e7eb;
  margin: 14px 0 10px 0;
}
.mr-dynamic-header{
  font-weight: 900;
  color:#111827;
  margin: 2px 0 8px 0;
}
.explainability-dynamic{
  min-height: 40px;
}
.explainability-empty{
  padding:12px 14px;
  border-radius:12px;
  border:1px dashed rgba(0,0,0,.12);
  background: rgba(249,250,251,.9);
  color:#374151;
}
/* Card system */
.explain-wrap{
  display:grid;
  grid-template-columns:1.2fr .8fr;
  gap:12px;
}
@media (max-width: 820px){
  .explain-wrap{ grid-template-columns:1fr; }
}
.explain-card{
  border-radius:14px;
  border:1px solid rgba(0,0,0,.08);
  background:#fff;
  box-shadow: 0 4px 14px rgba(0,0,0,.05);
  overflow:hidden;
}
.explain-card .card-h{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  font-weight:700;
  color:#111827;
  font-size:13px;
}
.explain-card .card-b{
  padding:10px 12px 12px 12px;
  color:#1f2937;
}
.card-accent-blue .card-h{ background: rgba(59,130,246,.12); }
.card-accent-green .card-h{ background: rgba(16,185,129,.12); }
.card-accent-amber .card-h{ background: rgba(245,158,11,.14); }
.card-accent-purple .card-h{ background: rgba(139,92,246,.12); }
.card-accent-red .card-h{ background: rgba(239,68,68,.12); }
.badge-row{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
.badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  font-size:12px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(0,0,0,.10);
  background: rgba(255,255,255,.85);
  color:#111827;
  font-weight:700;
}
.badge small{ font-weight:600; color:#374151; }
.badge-method{ border-color: rgba(59,130,246,.25); background: rgba(59,130,246,.10); }
.badge-ok{ border-color: rgba(16,185,129,.25); background: rgba(16,185,129,.10); }
.badge-mid{ border-color: rgba(245,158,11,.25); background: rgba(245,158,11,.12); }
.badge-low{ border-color: rgba(239,68,68,.25); background: rgba(239,68,68,.10); }
.badge-note{ border-color: rgba(139,92,246,.25); background: rgba(139,92,246,.10); }
.explain-kv{
  display:flex;
  justify-content:space-between;
  gap:10px;
  padding:6px 0;
  border-bottom:1px solid rgba(0,0,0,.06);
}
.explain-kv:last-child{ border-bottom:none; }
.explain-kv .k{
  color:#4b5563;
  font-weight:700;
  font-size:12px;
}
.explain-kv .v{
  color:#111827;
  font-weight:700;
  font-size:12px;
  text-align:right;
}
.explain-list{
  list-style:none;
  padding:0;
  margin:0;
  display:grid;
  gap:10px;
}
.explain-item{
  display:grid;
  grid-template-columns: auto 1fr auto;
  gap:10px;
  align-items:center;
}
.ex-num{
  width:34px; height:34px;
  border-radius:999px;
  display:flex; align-items:center; justify-content:center;
  font-weight:800;
  color:#111827;
  border:1px solid rgba(0,0,0,.10);
  background: rgba(243,244,246,.95);
}
.ex-meta{
  color:#374151;
  font-size:12px;
  line-height:1.2;
}
.ex-meta b{ color:#111827; }
.ex-score{
  font-weight:800;
  font-size:12px;
  color:#111827;
  min-width:72px;
  text-align:right;
}
.ex-bar{
  grid-column:1 / -1;
  height:8px;
  border-radius:999px;
  background: rgba(0,0,0,.06);
  overflow:hidden;
  border:1px solid rgba(0,0,0,.06);
}
.ex-bar > div{
  height:100%;
  width:0%;
  border-radius:999px;
  background: linear-gradient(90deg, rgba(239,68,68,.85), rgba(245,158,11,.90), rgba(16,185,129,.90));
}
.explain-pill{
  display:inline-flex;
  font-size:12px;
  padding:6px 10px;
  border-radius:999px;
  background: rgba(59,130,246,.10);
  border:1px solid rgba(59,130,246,.18);
  color:#111827;
  font-weight:700;
  margin:4px 6px 0 0;
}
.explain-muted{
  color:#6b7280;
  font-size:12px;
}
.explain-clickhint{
  margin-top:10px;
  padding:10px 12px;
  border-radius:12px;
  background: rgba(139,92,246,.10);
  border:1px solid rgba(139,92,246,.18);
  color:#1f2937;
  font-size:12px;
  line-height:1.25;
}
/* =========================
   v33 Table UX (Drawing History + Top Duplicates)
   Matches Explainability styling
   ========================= */
/* Setup & Generate card (top controls) */
#setupCard .setup-controls{
  display:flex;
  flex-wrap:wrap;
  align-items:flex-end;
  justify-content:flex-start;
  gap:16px 18px;
  padding: 4px 2px 10px 2px;
}
/* Keep top controls on one line on wider screens (wrap on small screens) */
@media (min-width: 1100px){
  #setupCard .setup-controls{ flex-wrap:nowrap; }
  #setupCard .control-group{ min-width:auto; }
  #setupCard .bypass-group{ min-width:220px; }
}
#setupCard .control-group{
  min-width: 160px;
}
#setupCard .control-label{
  font-weight:700;
  color:#111827;
  font-size:12px;
  margin-bottom:6px;
  text-align:left;
}
#setupCard input[type="date"],
#setupCard input[type="number"],
#setupCard select{
  border-radius:14px;
  border:1px solid rgba(0,0,0,.10);
  padding:10px 12px;
  background: rgba(255,255,255,.95);
  box-shadow: 0 4px 12px rgba(0,0,0,.05);
}
#setupCard #generateNumbersBtn{
  border-radius:999px;
  padding:12px 22px;
  font-weight:800;
  box-shadow: 0 10px 22px rgba(16,185,129,.25);
}
#setupCard .prediction-methods{
  width:100%;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  margin-top: 6px;
}
#setupCard .prediction-methods .control-label{
  text-align:center;
}
#setupCard .prediction-methods > div{
  display:flex;
  flex-wrap:wrap;
  gap:12px 16px;
  justify-content:center;
}
#setupCard .section-note{
  font-size:12px;
  color:#6b7280;
  text-align:center;
  margin-top:2px;
}
#setupCard #autoSaveLight{
  box-shadow:0 0 0 3px rgba(0,0,0,0.06);
}
.vnext-card{
  margin-top:14px;
  padding:14px;
  border-radius:14px;
  border:1px solid rgba(0,0,0,.08);
  background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(250,252,255,.96));
  box-shadow: 0 6px 18px rgba(0,0,0,.06);
}
.vnext-card .section-title-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:10px;
}
.vnext-card .history-table-title{
  margin:0;
  font-size:20px;
  line-height:1.2;
  color:#111827;
  text-align:left;
}
.vnext-card .section-toggle{
  display:inline-flex;
  align-items:center;
  gap:8px;
  font-size:14px;
  padding:8px 12px;
  border-radius:999px;
  border:1px solid rgba(0,0,0,.10);
  background: rgba(59,130,246,.08);
  color:#111827;
  user-select:none;
}
.vnext-card .section-toggle input[type="checkbox"]{
  width:16px;
  height:16px;
  accent-color:#2563eb;
}
/* Table styling */
.vnext-table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  overflow:hidden;
  border-radius:12px;
  border:1px solid rgba(0,0,0,.08);
  background:#fff;
}
.explainability-panel .section-toggle{
  display:inline-flex;
  align-items:center;
  gap:8px;
  font-size:14px;
  padding:8px 12px;
  border-radius:999px;
  border:1px solid rgba(0,0,0,.10);
  background: rgba(59,130,246,.08);
  color:#111827;
  user-select:none;
}
.explainability-panel .section-toggle input[type="checkbox"]{
  width:16px;
  height:16px;
  accent-color:#0f7a34;
}
.vnext-table thead th{
  background: rgba(243,244,246,.95);
  color:#111827;
  font-weight:700;
  font-size:13.5px;
  letter-spacing:.2px;
  padding:10px 12px;
  border-bottom:1px solid rgba(0,0,0,.08);
  text-transform:none;
  cursor:pointer;
  user-select:none;
}
.vnext-table thead th:first-child{ border-top-left-radius:12px; }
.vnext-table thead th:last-child{ border-top-right-radius:12px; }
.vnext-table tbody td{
  padding:10px 12px;
  border-bottom:1px solid rgba(0,0,0,.06);
  color:#111827;
  font-size:14px;
}
.vnext-table tbody tr:nth-child(even){
  background: rgba(249,250,251,.9);
}
.vnext-table tbody tr:hover{
  background: rgba(59,130,246,.08);
}
.vnext-table tbody tr:last-child td{
  border-bottom:none;
}
/* Emphasis for key columns */
.vnext-table td:first-child{
  font-weight:600;
  color:#0f172a;
}
.vnext-table td:last-child{
  font-variant-numeric: tabular-nums;
}
/* Smaller, calmer sort chevron */
.vnext-table thead th[data-sort]::after{
  content:"";
  display:inline-block;
  margin-left:6px;
  width:0;
  height:0;
  border-left:4px solid transparent;
  border-right:4px solid transparent;
  border-top:6px solid rgba(17,24,39,.30);
  transform: translateY(1px);
}
.vnext-table thead th.sorted-asc[data-sort]::after{
  border-top:none;
  border-bottom:6px solid rgba(37,99,235,.75);
}
.vnext-table thead th.sorted-desc[data-sort]::after{
  border-top:6px solid rgba(37,99,235,.75);
}
/* Make long number strings wrap nicely */
.vnext-table td{
  word-break:break-word;
}
/* === v34: Slip area UI refresh (match Explainability styling) === */
#controls-container{
  border:1px solid rgba(0,0,0,.08) !important;
  border-radius:16px !important;
  background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(250,252,255,.96)) !important;
  box-shadow: 0 8px 24px rgba(0,0,0,.08) !important;
  padding:16px 16px 18px !important;
  width: min(980px, 92%) !important;
  margin: 16px auto 10px !important;
  text-align:left !important;
}
#controls-container h2{
  margin: 0 0 10px !important;
  font-size: 18px !important;
  font-weight: 800 !important;
  color:#111827 !important;
  letter-spacing:.2px;
}
#controls-container .slip-subtitle{
  margin: 0 0 12px;
  color:#4b5563;
  font-size:13px;
}
#controls-container .slip-row{
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  gap:10px 12px;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(0,0,0,.06);
  background:#fff;
  box-shadow: 0 4px 14px rgba(0,0,0,.04);
  margin: 10px 0;
}
#controls-container .slip-row .row-title{
  font-weight:800;
  color:#111827;
  margin-right:6px;
}
#controls-container label{
  color:#374151 !important;
  font-weight: 700 !important;
  font-size: 13px !important;
}
#controls-container select,
#controls-container input[type="text"],
#controls-container input[type="number"]{
  border:1px solid rgba(0,0,0,.15) !important;
  border-radius:12px !important;
  padding:10px 12px !important;
  font-size:14px !important;
  background:#fff !important;
  outline:none !important;
}
#controls-container select:focus,
#controls-container input[type="text"]:focus,
#controls-container input[type="number"]:focus{
  box-shadow: 0 0 0 3px rgba(59,130,246,.18) !important;
  border-color: rgba(59,130,246,.55) !important;
}
/* Checkbox pill labels (keeps your existing inputs, improves readability) */
#controls-container .slip-checks{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
}
#controls-container .slip-checks label{
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px 10px;
  border-radius:999px;
  border:1px solid rgba(0,0,0,.08);
  background: rgba(59,130,246,.06);
  font-weight:800 !important;
  user-select:none;
}
#controls-container .slip-checks input[type="checkbox"]{
  width:16px;
  height:16px;
  accent-color:#2563eb;
}
/* Primary action buttons */
#controls-container button#load-file-btn,
#controls-container button#generate-slip{
  border:none !important;
  border-radius:14px !important;
  padding:12px 14px !important;
  font-weight: 900 !important;
  font-size: 14px !important;
  letter-spacing:.2px;
  box-shadow: 0 10px 20px rgba(37,99,235,.18) !important;
  transition: transform .06s ease, filter .15s ease !important;
}
#controls-container button#load-file-btn:not([disabled]),
#controls-container button#generate-slip:not([disabled]){
  cursor:pointer !important;
}
#controls-container button#load-file-btn:not([disabled]):active,
#controls-container button#generate-slip:not([disabled]):active{
  transform: translateY(1px) !important;
}
#controls-container button#load-file-btn[disabled],
#controls-container button#generate-slip[disabled]{
  filter: grayscale(0.25) !important;
  opacity: .55 !important;
  cursor:not-allowed !important;
  box-shadow:none !important;
}
/* Export controls card */
.export-controls{
  width: min(980px, 92%);
  margin: 10px auto 18px;
  padding: 12px;
  border-radius: 16px;
  border:1px solid rgba(0,0,0,.08);
  background:#fff;
  box-shadow: 0 6px 18px rgba(0,0,0,.06);
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  justify-content:flex-start;
}
.export-controls .export-btn{
  border:1px solid rgba(0,0,0,.10);
  border-radius: 12px;
  padding: 10px 12px;
  font-weight: 900;
  font-size: 13px;
  background: rgba(16,185,129,.08);
  cursor:pointer;
  transition: filter .15s ease, transform .06s ease;
}
.export-controls .export-btn:active{ transform: translateY(1px); }
.export-controls .export-btn[disabled]{
  opacity:.55;
  cursor:not-allowed;
  background: rgba(107,114,128,.08);
}
/* v35+ UI polish: centered slip header + exports blue + explainability header alignment */
.play-slip-container .history-table-title{ text-align:center; width:100%; }
.play-slip-container .slip-center-row{ display:flex; justify-content:center; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:16px; }
.play-slip-container .slip-generate-row{ text-align:center; }
.play-slip-container #generate-slip{ display:inline-block; margin: 0 auto; }
.export-card .export-btn{
  background: #007bff !important;
  border: none;
}
.export-card .export-btn:hover:not(:disabled){
  filter: brightness(0.92);
}
.export-card .export-btn:disabled{
  background: rgba(0,0,0,.25) !important;
  cursor: not-allowed;
  filter:none;
}
/* Methodology Rationale controls */
.mr-controls{
  display:flex;
  gap:8px;
  align-items:center;
}
.mr-mini-btn{
  border:1px solid rgba(0,0,0,.14);
  background: rgba(255,255,255,.85);
  color:#111827;
  font-weight:600;
  font-size:12px;
  padding:6px 10px;
  border-radius:10px;
  cursor:pointer;
}
.mr-mini-btn:hover{ background: rgba(255,255,255,.98); }
.mr-mini-btn:active{ transform: translateY(1px); }
.mr-right{ display:flex; gap:10px; align-items:center; }
.top5-row { background: #fff7cc; }
.top-badge{
  display:inline-block;
  font-size:11px;
  font-weight:700;
  padding:3px 8px;
  border-radius:999px;
  background:#f3f4f6;
  color:#111827;
  margin-right:8px;
}
.top-rank-1 .top-badge{ background:#fde68a; }
.top-rank-2 .top-badge{ background:#e5e7eb; }
.top-rank-3 .top-badge{ background:#fed7aa; }
/* --- Enhancement #3 UI polish (tables) --- */
#enh3JackpotHitsCard table th,
#enh3JackpotHitsCard table td{
  text-align:center !important;
  vertical-align:middle;
}
#enh3JackpotHitsCard table th{
  white-space:nowrap;
}
/* ===== Enhancement #9 — USA Mapping (D1 scaffold) ===== */
.e9map-controls{
  display:flex; flex-wrap:wrap; gap:10px; align-items:center;
  border:1px solid #e2e8f0; background:#f8fafc; padding:10px; border-radius:12px;
  margin:8px 0 12px 0;
}
.e9map-toggle{ font-size:13px; color:#0f172a; user-select:none; }
.e9map-toggle input{ margin-right:6px; }
.e9map-spacer{ flex:1 1 auto; }
.e9map-fallback{ font-size:13px; color:#0f172a; display:flex; gap:8px; align-items:center; }
.e9map-fallback select{ padding:6px 8px; border-radius:10px; border:1px solid #cbd5e1; background:#fff; }
.e9map-grid{ display:grid; grid-template-columns: 1fr 280px; gap:12px; align-items:start; }
@media (max-width: 980px){
  .e9map-grid{ grid-template-columns: 1fr; }
}
.e9map-canvas{
  position:relative;
  min-height:420px;
  border:1px solid #e2e8f0;
  border-radius:14px;
  background:#ffffff;
  overflow:hidden;
}
.e9map-placeholder{
  height:100%;
  min-height:420px;
  display:flex; align-items:center; justify-content:center;
  color:#64748b; font-size:13px;
}
.e9map-legend{
  border:1px solid #e2e8f0;
  border-radius:14px;
  background:#ffffff;
  padding:12px;
}
.e9map-legend-title{ font-weight:800; color:#0f172a; margin-bottom:8px; }
.e9map-legend-body{ font-size:13px; color:#334155; line-height:1.45; }
.e9map-legend-footnote{ font-size:12px; color:#64748b; margin-top:10px; }
#enh9MapTooltip{
  position:fixed;
  z-index:9998;
  background:#0b1220;
  color:#f8fafc;
  font-size:12px;
  line-height:1.35;
  padding:8px 10px;
  border-radius:12px;
  box-shadow:0 8px 28px rgba(2,6,23,0.35);
  max-width:260px;
  display:none;
  pointer-events:none;
}
#enh9MapToast{
  position:fixed;
  right:18px;
  bottom:18px;
  width:360px;
  max-width: calc(100vw - 36px);
  background:#ffffff;
  border:1px solid #e2e8f0;
  border-radius:16px;
  box-shadow:0 14px 40px rgba(2,6,23,0.18);
  display:none;
  z-index:9999;
}
.e9map-toast-header{
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 12px;
  border-bottom:1px solid #e2e8f0;
}
.e9map-toast-title{ font-weight:800; color:#0f172a; font-size:13px; }
.e9map-toast-close{
  border:0; background:transparent; cursor:pointer;
  font-size:18px; line-height:18px; padding:4px 8px; color:#334155;
}
.e9map-toast-body{ padding:12px; font-size:13px; color:#334155; line-height:1.5; }
/* ===== /Enhancement #9 — USA Mapping (D1 scaffold) ===== */
/* E9 USA MAP SVG (Stage 2) */
#e9MapCanvas { position: relative; overflow: hidden; }
#e9MapCanvas svg.e9usa-svg { width: 100%; height: 100%; display: block; }
#e9MapCanvas [data-jurisdiction] { cursor: pointer; fill: #f3f6fb !important; stroke: #9aa7b8 !important; stroke-width: 1 !important; vector-effect: non-scaling-stroke; }
#e9MapCanvas [data-jurisdiction]:hover { fill: #dfe9f7 !important; }
#e9MapCanvas .e9map-selected { fill: #b9d3f7 !important; stroke: #2a5bd7 !important; stroke-width: 2 !important; }
</style>
<script>
/* v86u hotfix: global DOM refs to prevent scope-related ReferenceErrors */
let numGamesSelector = null;
let generateSlipButton = null;
document.addEventListener('DOMContentLoaded', () => {
  try {
    // v87: boot-time wiring assertions (detect/report only; no rewires)
    try {
      const missing = [];
      const __dateEl = document.getElementById('drawDate') || document.getElementById('startDate');
      if (!__dateEl) missing.push('startDate/drawDate');
      if (!document.getElementById('generate-slip')) missing.push('generate-slip');
      if (!document.getElementById('num-games')) missing.push('num-games');
      if (missing.length) {
        console.error('v87 wiring assertions: missing elements', missing);
        if (typeof showErrorToast === 'function') {
          showErrorToast('Startup wiring error: missing ' + missing.join(', ') + '.');
        }
      }
    } catch (e) {
      console.error('v87 wiring assertions failed', e);
      if (typeof showErrorToast === 'function') showErrorToast('Startup wiring assertion error. See console.');
    }
    numGamesSelector = document.getElementById('num-games');
    generateSlipButton = document.getElementById('generate-slip');

    // Slip generation gating: prevent auto-fill/duplicate fill when insufficient games exist.
    // Enables "Generate Powerball Play Slip" only when total games (N) are satisfiable by:
    // Drawing History (non-family rows) + QP selections + DUP5 + Family (counts as 2).
    function __pbLocalMidnight(d){
      const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      x.setHours(0,0,0,0);
      return x;
    }
    function __pbCountAvailableTop(){
      try{
        const rows = Array.from(document.querySelectorAll('#historyTableBody tr'));
        let count = 0;
        for (const row of rows){
          const methodTxt = (row.cells?.[0]?.textContent || '').replace(/\bTOP\s*\d+\b/gi,'').trim();
          if (!methodTxt) continue;
          if (/family\b/i.test(methodTxt)) continue;
          if (/duplicates\b/i.test(methodTxt)) continue; // avoid reusing duplicates rows as fill candidates
          const numsTxt = (row.cells?.[2]?.textContent || '');
          const nums = numsTxt.split(',').map(s=>parseInt(String(s).trim(),10)).filter(n=>Number.isFinite(n));
          const pb = parseInt(String(row.cells?.[3]?.textContent||'').trim(),10);
          if (nums.length!==5) continue;
          if (!Number.isFinite(pb)) continue;
          count++;
        }
        return count;
      }catch(e){ return 0; }
    
    function __pbCountFamilyRows(){
      try{
        const rows = Array.from(document.querySelectorAll('#historyTableBody tr'));
        let count = 0;
        for (const row of rows){
          const methodTxt = (row.cells?.[0]?.textContent || '').replace(/\bTOP\s*\d+\b/gi,'').trim();
          if (!methodTxt) continue;
          if (/family\b/i.test(methodTxt)){
            const numsTxt = (row.cells?.[2]?.textContent || '');
            const nums = numsTxt.split(',').map(s=>parseInt(String(s).trim(),10)).filter(n=>Number.isFinite(n));
            const pb = parseInt(String(row.cells?.[3]?.textContent||'').trim(),10);
            if (nums.length===5 && Number.isFinite(pb)) count++;
          }
        }
        return count;
      }catch(e){ return 0; }
    }

}
    function __pbComputeReserved(){
      const qp4 = !!document.getElementById('quick-pick-game-4')?.checked;
      const qp5 = !!document.getElementById('quick-pick-game-5')?.checked;
      const dup5 = !!document.getElementById('use-duplicates-game5')?.checked;
      const fam = !!document.getElementById('use-family-numbers')?.checked;
      return (qp4?1:0) + (qp5?1:0) + (dup5?1:0) + (fam?2:0);
    }
    function __pbUpdateSlipGate(){
      if (!generateSlipButton || !numGamesSelector) return;
      const N = parseInt(String(numGamesSelector.value||'0'),10);
      if (!Number.isFinite(N) || N<=0){
        generateSlipButton.disabled = true;
        generateSlipButton.title = 'Select Number of Games first.';
        generateSlipButton.style.opacity = '0.5';
        generateSlipButton.style.cursor = 'not-allowed';
        return;
      }
      const reserved = __pbComputeReserved();
      const famEnabled = !!document.getElementById('use-family-numbers')?.checked;
      const famRows = __pbCountFamilyRows();
      if (famEnabled && famRows < 2){
        generateSlipButton.disabled = true;
        generateSlipButton.title = 'Family #s requires 2 Family rows in Drawing History.';
        generateSlipButton.style.opacity = '0.5';
        generateSlipButton.style.cursor = 'not-allowed';
        return;
      }
      const requiredTop = Math.max(0, N - reserved);
      const availableTop = __pbCountAvailableTop();
      const ok = (availableTop >= requiredTop);
      generateSlipButton.disabled = !ok;
      generateSlipButton.title = ok ? '' : `Insufficient Drawing History: need ${requiredTop} non-family games; found ${availableTop}. Add predictions or reduce options.`;
      generateSlipButton.style.opacity = ok ? '1' : '0.5';
      generateSlipButton.style.cursor = ok ? 'pointer' : 'not-allowed';
    }
    // Initialize gated state + reactive updates (minimal listeners)
    try{
      __pbUpdateSlipGate();
      document.getElementById('num-games')?.addEventListener('change', __pbUpdateSlipGate);
      document.getElementById('quick-pick-game-4')?.addEventListener('change', __pbUpdateSlipGate);
      document.getElementById('quick-pick-game-5')?.addEventListener('change', __pbUpdateSlipGate);
      document.getElementById('use-duplicates-game5')?.addEventListener('change', __pbUpdateSlipGate);
      document.getElementById('use-family-numbers')?.addEventListener('change', __pbUpdateSlipGate);
      const tbody = document.getElementById('historyTableBody');
      if (tbody && window.MutationObserver){
        const mo = new MutationObserver(()=>{ __pbUpdateSlipGate(); });
        mo.observe(tbody, {childList:true, subtree:true});
      }
    }catch(e){}
} catch(e) {}
});
</script>
</head>
<body>
<!-- vE10_D1 started from vE9_D13 baseline: Deliverable 10.1 UI scaffold for Powerball.net Draw History controls (no functional changes). -->
<div class="lottery-container">
<div class="lottery-header">
<img alt="Texas Powerball Logo - Red and white powerball lottery logo" class="lottery-logo" height="67" src="https://www.texaslottery.com/export/sites/lottery/Images/powerball-banner.png" width="200"/>
<h1>Texas Powerball Generator</h1>
</div>
<div class="history-table-container vnext-card" id="setupCard">
<div class="controls setup-controls">
<div class="control-group">
<label class="control-label" for="startDate">Draw Date</label>
<input id="startDate" min="2024-01-19" type="date"/>
</div>
<div class="control-group">
<label class="control-label" for="drawCount">Number of Draws</label>
<input id="drawCount" max="100" min="1" placeholder="Number of draws" type="number" value="1"/>
</div>
</div>
</div>

<!-- Enhancement #10 (vE10) — Historical Data Section (requested)
     Contains: Historical Data load/reload + bypass + PB10 Powerball.net draw-history controls.
     Placed directly under the main Draw Date controls and above Prediction Method.
-->
<div class="history-table-container vnext-card" id="historicalDataCard">
  <div class="section-title-row">
    <h2 class="history-table-title">Historical Data</h2>
    <label class="section-toggle"><input checked id="toggleHistoricalData" type="checkbox"/> Visible</label>
  </div>
  <div id="historicalDataContent">
    <div class="controls" style="margin-top:6px;">
      <!-- Load/Reload Historical Data + Auto-save light (moved from setup controls; IDs unchanged) -->
      <div class="control-group" style="flex:1; min-width:300px;">
        <div style="display:flex; align-items:center; gap:10px; justify-content:center; flex-wrap:wrap;">
          <button class="export-btn" id="loadDataBtn" style="background: linear-gradient(145deg, #e67e22, #d35400);">Load Historical Data</button>
          <button id="reloadDataBtn" style="display:none; background: linear-gradient(145deg, #c0392b, #8e1f14); color:#fff; border:none; border-radius:24px; padding:14px 24px; font-size:16px; font-weight:700; cursor:pointer; box-shadow:0 10px 24px rgba(0,0,0,0.15);" title="Overwrite Historical Data JSON by re-importing from the backup text file (destructive).">Reload Historical Data</button>
          <span id="autoSaveLight" style="width:14px;height:14px;border-radius:50%;display:inline-block;background:#cc0000;box-shadow:0 0 0 2px rgba(0,0,0,0.08);" title="Auto-save status"></span>
        </div>
      </div>

      <!-- Enter recent numbers (moved; ID unchanged) -->
      <div class="control-group" style="flex:1; min-width:260px;">
        <button class="export-btn" disabled id="manualEntryBtn" onclick="showManualEntryForm()" style="background: linear-gradient(145deg, #9b59b6, #8e44ad);">Enter Recent Powerball Numbers</button>
      </div>

      <!-- Bypass historical data (moved; ID unchanged) -->
      <div class="control-group bypass-group" style="flex:1; min-width:220px;">
        <label class="section-toggle" style="justify-content:center; width:100%;">
          <input id="bypassHistoricalData" type="checkbox"/>
          <span>Bypass Historical Data</span>
        </label>
      </div>
    </div>

    <!-- Enhancement #10 (vE10) — Draw History Data (Powerball.net) Controls (moved from Drawing History) -->
    <div class="pbnet-history-controls" id="pbNetHistoryControls" aria-label="Draw History Data (Powerball.net)">
      <div class="pbnet-history-row">
        <button type="button" id="pbNetHistoryLoadBtn" class="pbnet-btn" title="Load or refresh Powerball.net historical draw history.">Load/Refresh Powerball.net History</button>
        <span id="pbNetHistoryStatusPill" class="pbnet-pill pbnet-bad" title="Draw-history cache is not yet available.">INSUFFICIENT DATA</span>
        <label class="pbnet-toggle" title="Attempt direct fetch (may be blocked). If blocked, import is used automatically.">
          <input type="checkbox" id="pbNetHistoryFetchToggle" /> Direct Fetch (auto)
        </label>
        <span id="pbNetHistoryYearRange" class="pbnet-year-range" title="Year range for Direct Fetch (archives). Used only when Direct Fetch is enabled.">
          <span class="pbnet-year-label">Years:</span>
          <input type="number" id="pbNetHistoryFetchStartYear" class="pbnet-year" min="2003" max="2100" step="1" value="2016" aria-label="Start year"/>
          <span class="pbnet-year-sep">to</span>
          <input type="number" id="pbNetHistoryFetchEndYear" class="pbnet-year" min="2003" max="2100" step="1" value="2026" aria-label="End year"/>
        </span>
        <button type="button" id="pbNetHistoryExportBtn" class="pbnet-btn" disabled title="Export the canonical draw-history object as JSON (enabled when cache is present)">Export Draw History JSON</button>
        <button type="button" id="pbNetHistoryQABtn" class="pbnet-btn" title="Run non-destructive QA checks for PB10 draw-history integration">Run QA Checks</button>
      </div>
      <div class="pbnet-history-details-wrap">
        <div id="pbNetHistoryDetailsLine" class="pbnet-history-details">drawCount: 0 | lastJackpotWinDate: unknown | mostRecent: unknown</div>
        <button type="button" id="pbNetHistoryWarningsBtn" class="pbnet-link" style="display:none" title="View validation warnings for the loaded draw-history cache.">Warnings: 0</button>
      </div>
      <div id="pb10QaOutput" class="pb10-qa-output" style="display:none" aria-live="polite"></div>
      <input type="file" id="pbNetHistoryFileInput" accept=".json,.csv,.html,.htm,text/html,application/json,text/csv" multiple style="display:none" />
      <div class="pbnet-history-help">Enhancement #10 provides deterministic Powerball.net draw-history loading to enable Jackpot Event Forecast (JEF). If direct fetch is blocked by browser policy, save Powerball.net archive pages (e.g., /archive/YYYY) and import them.</div>
    </div>
  </div>
</div>
<div class="control-group prediction-methods">
<label class="control-label">Prediction Method:</label>
<div class="radio-group">
<label>
<input checked="" name="predictionMethod" type="radio" value="exponential"/>
                Exponential
                <span class="tooltip">Uses exponential distribution to generate numbers, considering historical patterns with decay over time. May take a few moments to process.</span>
</label>
<label>
<input name="predictionMethod" type="radio" value="frequency"/>
                Frequency
                <span class="tooltip">Analyzes the frequency of numbers in past draws to make predictions based on most common occurrences.</span>
</label>
<label>
<input name="predictionMethod" type="radio" value="lstm"/>
                LSTM
                <span class="tooltip">Uses Long Short-Term Memory neural networks to learn complex patterns from historical data. Requires initial training.</span>
</label>
<label>
<input name="predictionMethod" type="radio" value="monteCarlo"/>
                Monte Carlo
                <span class="tooltip">Simulates multiple random draws using probability distributions from historical data to make predictions.</span>
</label>
<label>
<input name="predictionMethod" type="radio" value="markov"/>
                Markov
                <span class="tooltip">Uses Weighted Markov Chain Model to predict numbers based on transition probabilities from historical patterns.</span>
</label>
</div>
</div>
<div class="control-group">
<button id="generateNumbersBtn" onclick="generateDraws()">Generate Powerball Numbers</button>
</div>
<div class="progress-container" id="progressContainer" style="display: none;">
<div class="progress-bar">
<div class="progress-fill" id="progressFill"></div>
</div>
<div class="progress-text" id="progressText">Generating predictions...</div>
</div>
<!-- Training Progress Bar with Label -->
<div id="trainingProgressWrapper" style="display: none;">
<label for="trainingProgress" id="trainingProgressLabel">Training Model...0%</label>
<progress id="trainingProgress" max="100" value="0"></progress>
</div>
<div id="drawsContainer"></div>
<div class="explainability-panel" id="explainabilityPanel">
<div class="section-title-row">
<h2>Methodology Rationale </h2><div class="mr-right"><div class="mr-controls"><button class="mr-mini-btn" id="mrExpandAll" type="button">Expand All</button><button class="mr-mini-btn" id="mrCollapseAll" type="button">Collapse All</button></div><label class="section-toggle"><input checked="" id="toggleExplainability" type="checkbox"/> Visible</label></div>
</div>
<div class="explainability-sub">Why these numbers were selected (method, ranks, weights/scores).</div>
<div class="explainability-content" id="explainabilityContent">
<div class="mr-static">
<details class="mr-block" data-mr-key="candidate_pool" open="">
<summary>Candidate Pool Construction</summary>
<ul>
<li>Generate a large candidate universe; score tickets; then focus on a Top-K pool (K=50) for ranking stability.</li>
<li>Reduces noise dominance while preserving diversity of viable tickets.</li>
<li>Final rankings are computed within the Top-K pool using the current scoring logic.</li>
</ul>
</details>
<details class="mr-block" data-mr-key="frozen_window">
<summary>Frozen Reference Window</summary>
<ul>
<li>Uses a fixed 260-draw historical window as the baseline for all weighting and comparisons.</li>
<li>Prevents silent drift caused by changing sample sizes across runs/dates.</li>
<li>Improves repeatability: same inputs yield the same outputs.</li>
</ul>
</details>
<details class="mr-block" data-mr-key="scoring_agreement">
<summary>Scoring, Ranking, and Agreement</summary>
<ul>
<li>Scores combine overlap signals, ranked weights, and (where enabled) cross-method agreement.</li>
<li>The Method Agreement Index rewards candidates supported by multiple independent methods.</li>
<li>Outlier patterns may be penalized to reduce overfit to rare historical artifacts.</li>
</ul>
</details>
<details class="mr-block" data-mr-key="rl_interpretation">
<summary>Run Likelihood % (RL%) Interpretation</summary>
<ul>
<li>Run Likelihood % (RL%) is a percentile-style score normalized within the comparison pool for this run (not jackpot odds).</li>
<li>“Model Run Likelihood %” ranks within a method; “Global Run Likelihood %” ranks across methods for the same draw date.</li>
<li>Run Likelihood % is most meaningful when comparing tickets from the same run and draw date.</li>
</ul>
</details>
<details class="mr-block" data-mr-key="validation_stability">
<summary>Validation Hooks and Stability Controls</summary>
<ul>
<li>Range/duplicate checks, date gating, and data-load readiness guards prevent invalid states.</li>
<li>History reconciliation recomputes Global Run Likelihood % across all entries for a given draw date.</li>
<li>Any scoring or rules change must update this Rationale to remain auditable.</li>
</ul>
</details>
<div class="mr-divider"></div>
<div class="mr-dynamic-header">Run Breakdown (click a generated game or a Drawing History row)</div>
</div>
<div class="explainability-dynamic" id="explainabilityDynamic">
<div class="explainability-empty">Generate a set (or click a result in Drawing History) to see the breakdown here.</div>
</div>
</div>
</div>
<div class="history-table-container vnext-card">
<div class="section-title-row">
<h2 class="history-table-title">Drawing History</h2>
<label class="section-toggle"><input checked="" id="toggleDrawingHistory" type="checkbox"/> Visible</label>
</div>
<div id="drawingHistoryContent">

<style>
  /* Scoped styles for Enhancement #10 Draw History controls (minimal; no dependency changes) */
  .pbnet-history-controls{margin:12px 0 14px;padding:12px 12px 10px;border:1px solid rgba(0,0,0,.08);border-radius:10px;background:rgba(255,255,255,.9);} 
  .pbnet-history-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-start;}
  .pbnet-btn{background:#0b5ed7;color:#fff;border:0;border-radius:8px;padding:8px 12px;font-size:14px;cursor:pointer;}
  .pbnet-btn[disabled]{opacity:.55;cursor:not-allowed;}
  .pbnet-pill{display:inline-flex;align-items:center;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;letter-spacing:.2px;border:1px solid transparent;}
.pbnet-pill.pbnet-ok{ background:#064e3b; border-color:#065f46; color:#ecfdf5; }
.pbnet-pill.pbnet-bad{ background:#7f1d1d; border-color:#991b1b; color:#fef2f2; }

  .pbnet-pill-bad{background:rgba(220,53,69,.12);color:#b02a37;border-color:rgba(220,53,69,.25);}
  .pbnet-pill-ok{background:rgba(25,135,84,.12);color:#146c43;border-color:rgba(25,135,84,.25);}
  .pbnet-history-details{margin-top:8px;font-size:12px;color:rgba(0,0,0,.7);}
  .pbnet-history-details-wrap{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
  .pbnet-toggle{display:inline-flex;gap:6px;align-items:center;font-size:12px;color:rgba(0,0,0,.65);user-select:none;}
.pbnet-year-range{display:inline-flex;align-items:center;gap:6px;margin-left:8px;padding:2px 6px;border:1px solid rgba(255,255,255,0.12);border-radius:10px;background:rgba(255,255,255,0.03);} 
.pbnet-year{width:74px;max-width:74px;padding:4px 6px;border-radius:8px;border:1px solid rgba(255,255,255,0.16);background:rgba(0,0,0,0.18);color:#e9f2ff;font-size:12px;}
.pbnet-year-label,.pbnet-year-sep{font-size:12px;color:#cfe0ff;opacity:0.9;}

  .pbnet-toggle input{transform:translateY(1px);}
  .pbnet-link{background:transparent;border:0;padding:0;margin:0;font-size:12px;color:#0b5ed7;cursor:pointer;text-decoration:underline;}
  .pbnet-link:hover{opacity:.85;}
  .pbnet-pill.pbnet-pending{background:rgba(13,110,253,.12);border-color:rgba(13,110,253,.25);color:#0b5ed7;}
  .pbnet-history-help{margin-top:6px;font-size:12px;color:rgba(0,0,0,.55);}
  .pb10-qa-output{margin-top:8px;padding:8px 10px;border-radius:10px;border:1px solid rgba(0,0,0,.08);background:rgba(255,255,255,.92);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:12px;white-space:pre-wrap;color:rgba(0,0,0,.78);}
</style>

<table class="drawing-history vnext-table">
<thead>
<tr>
<th data-sort="method">Model Type</th>
<th data-sort="date">Draw Date</th>
<th data-sort="numbers">Numbers</th>
<th data-sort="powerball">Powerball</th>
<th data-sort="modelRL">Model RL (%)</th>
<th data-sort="globalRL" title="Run Likelihood % normalized within the comparison pool for this run/date. Not absolute jackpot odds.">Global Run Likelihood (%)</th>
</tr>
</thead>
<tbody id="historyTableBody">
</tbody>
</table>
</div>
</div>
<div class="duplicates-table-container vnext-card">
<div class="section-title-row">
<h2 class="history-table-title">Top Duplicates</h2>
<label class="section-toggle"><input checked="" id="toggleTopDuplicates" type="checkbox"/> Visible</label>
</div>
<div id="topDuplicatesContent">
<table class="drawing-history styled-duplicates-table vnext-table">
<thead>
<tr>
<th style="width: 50%;">Numbers</th>
<th style="width: 15%;">Powerball</th>
<th style="width: 20%;">Score (%)</th>
<th style="width: 15%;">Frequency</th>
</tr>
</thead>
<tbody id="duplicatesTableBody">
</tbody>
</table>
</div>
</div>
<style>
    .duplicates-table-container {
        margin: 40px 0;
        padding: 20px;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .history-table-title {
        text-align: center;
        color: #333;
        font-size: 24px;
        margin-bottom: 20px;
    }
    .drawing-history {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
    }
    .drawing-history th, .drawing-history td {
        padding: 12px;
        text-align: center;
        border-bottom: 1px solid #ddd;
    }
    .drawing-history th {
        background-color: #f4f4f4;
        font-weight: bold;
    }
    .drawing-history td {
        font-size: 16px;
    }
    .powerball-highlight {
        font-weight: bold;
        color: red;
    }
    .duplicate-number {
        font-weight: bold;
        color: #007bff;
    }
</style>
<!-- Generate Slip Section -->
<div class="history-table-container vnext-card play-slip-container" id="controls-container" style="display: none;">
<!-- Heading -->
<h2 class="history-table-title">Generate Powerball Play Slip</h2>
<!-- Load PDF File Section -->
<div style="margin: 10px 0 20px; display:flex; justify-content:center;">
<button disabled="" id="load-file-btn" style="
            background-color: #007bff;
            color: white;
            font-size: 16px;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;">
            Load Powerball Template File (PDF)
        </button>
<span id="templateLoadLight" style="width:14px;height:14px;border-radius:50%;display:inline-block;background:#cc0000;box-shadow:0 0 0 2px rgba(0,0,0,0.08);margin-left:10px;" title="Template PDF not loaded"></span>
<input accept=".pdf" id="pdf-upload" style="display: none;" type="file"/>
</div>
<!-- Number of Games Selector -->
<div class="slip-center-row">
<label for="num-games" style="font-size: 16px; font-weight: bold;">Number of Games:</label>
<select id="num-games" style="
            font-size: 16px;
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-left: 5px;">
<option value="1">1</option>
<option value="2">2</option>
<option selected="" value="3">3</option>
<option value="4">4</option>
<option value="5">5</option>
</select>
</div>
<!-- Checkboxes -->
<div class="slip-row">
<label>
<input id="quick-pick-game-4" type="checkbox"/> Quick Pick for Game 4
  </label>
<label>
<input id="quick-pick-game-5" type="checkbox"/> Quick Pick for Game 5
  </label>
<label>
<input id="use-duplicates-game5" type="checkbox"/> Use Duplicates for Game 5
  </label>
<!-- ✦ NEW: family #s checkbox -->
<label style="margin-left: 10px;">
<input id="use-family-numbers" type="checkbox"/> Use Family #s
  </label>
<span id="familyCapacityWarning" style="display:none; margin-left:8px; color:#b42318; font-weight:700; font-size:12px;">Family disabled: insufficient capacity.</span>
</div>
<div class="slip-options-row">
<label class="option-toggle"><input id="powerplay-checkbox" type="checkbox"/> PowerPlay</label>
<label class="option-toggle">
<input id="payment-30year" name="payment-option" type="radio" value="30Year"/> 30 Year Annual Payment Option
        </label>
<label class="option-toggle">
<input checked="" id="payment-cashvalue" name="payment-option" type="radio" value="CashValue"/> Cash Value Option
        </label>
</div>
<!-- Generate Slip Button -->
<div class="slip-generate-row"><button id="generate-slip" style="
        background-color: green;
        color: white;
        font-size: 16px;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;">
        Generate Powerball Play Slip
    </button>
<div id="slipSaveStatus" style="margin-top:10px; font-size:13px; color:#0b6623; display:block;">No slip saved yet.</div>
<div id="slipSavedMiniWrap" style="margin-top:12px; display:none;">
<div class="section-title-row">
<div style="font-size:14px; font-weight:700; margin-bottom:6px;">Saved Slip / Previous Predictions (Latest per Method)</div>
<label class="section-toggle" title="Show/Hide this section"><input checked="" id="ppSectionVisibleToggle" type="checkbox"/> Visible</label>
</div>
<div style="font-size:12px; color:#555; margin-bottom:8px;">Shows the most recent saved run for each method for the selected draw date. Maximum 5 games per method per date.</div>
<div style="display:flex; align-items:center; gap:14px; margin:10px 0 10px 0; flex-wrap:wrap;">
<label style="display:flex; align-items:center; gap:8px; font-size:12px; color:#111; cursor:pointer; user-select:none;">
<input id="ppShowAllToggle" style="transform:scale(1.05);" type="checkbox"/>
          Show All Previous Predictions (uncheck = Pending only)
        </label>
<span id="ppSummaryPill" style="font-size:12px; color:#334155; background:#eef2ff; border:1px solid #c7d2fe; padding:3px 8px; border-radius:999px;">Rows: 0</span>
</div>
<div id="ppJsonControlsRow" style="display:flex; align-items:center; gap:10px; margin:6px 0 10px 0; flex-wrap:wrap;">
<button class="secondary-btn" id="ppExportJsonBtn" style="padding:7px 10px; border-radius:10px; border:1px solid #cbd5e1; background:#fff; color:#111827; cursor:pointer; font-size:12px; font-weight:700;" type="button">
          Export Predictions (JSON)
        </button>
<button class="secondary-btn" id="ppImportJsonBtn" style="padding:7px 10px; border-radius:10px; border:1px solid #cbd5e1; background:#fff; color:#111827; cursor:pointer; font-size:12px; font-weight:700;" type="button">
          Import Predictions (JSON)
        </button>
<button id="ppDeleteSelectedBtn" style="padding:7px 10px; border-radius:10px; border:1px solid #fed7aa; background:#fff7ed; color:#9a3412; cursor:pointer; font-size:12px; font-weight:800;" type="button">
  Delete Selected
</button>
<button id="ppDeleteAllBtn" style="padding:7px 10px; border-radius:10px; border:1px solid #fecaca; background:#fff5f5; cursor:pointer; font-size:12px; font-weight:800; color:#991b1b;" type="button">
  Delete All
</button>
<span style="font-size:12px; color:#475569;">Going forward, predictions are saved/loaded as JSON (local storage + optional JSON file).</span>
<input accept="application/json,.json" id="ppImportJsonInput" style="display:none;" type="file"/>
</div>
<div id="ppHistoryWrap" style="margin-top:8px; display:block;">
<div style="font-size:13px; font-weight:700; margin:6px 0 6px 0;">Previous Predictions (History)</div>
<div id="ppHistBanner" style="display:none; margin:8px 0 10px 0; padding:10px 12px; border:1px solid rgba(148,163,184,.6); background:rgba(241,245,249,.8); color:#0f172a; border-radius:12px; font-size:13px; line-height:1.35;">
          Historical results are not loaded. Previous Predictions are saved as JSON and will display status as <b>SAVED</b> until you load Historical Data, at which point matches and categories will be computed.
        </div>
<div style="overflow:auto;">
<table id="ppHistoryTable" style="width:100%; border-collapse: collapse; font-size: 13px;">
<thead>
<tr>
<th style="text-align:center; padding:6px 8px; border-bottom:1px solid #ddd; width:44px;">
<input id="ppSelectAll" style="transform:scale(1.05);" title="Select all visible rows" type="checkbox"/>
</th>
<th style="text-align:left; padding:6px 8px; border-bottom:1px solid #ddd;">Draw Date</th>
<th style="text-align:left; padding:6px 8px; border-bottom:1px solid #ddd;">Method</th>
<th style="text-align:left; padding:6px 8px; border-bottom:1px solid #ddd;">Rank</th>
<th style="text-align:left; padding:6px 8px; border-bottom:1px solid #ddd;">Numbers</th>
<th style="text-align:left; padding:6px 8px; border-bottom:1px solid #ddd;">Powerball</th>
<th style="text-align:left; padding:6px 8px; border-bottom:1px solid #ddd;">Status</th>
<th style="text-align:left; padding:6px 8px; border-bottom:1px solid #ddd;">Match Category</th>
</tr>
</thead>
<tbody id="ppHistoryTbody"></tbody>
</table>
</div>
</div>
<div style="overflow:auto;">
<table id="slipSavedMiniTable" style="width:100%; border-collapse: collapse; font-size: 13px;">
<thead>
<tr>
<th style="text-align:left; padding:6px 8px; border-bottom:1px solid #ddd;">Method</th>
<th style="text-align:left; padding:6px 8px; border-bottom:1px solid #ddd;">Game</th>
<th style="text-align:left; padding:6px 8px; border-bottom:1px solid #ddd;">Numbers</th>
<th style="text-align:left; padding:6px 8px; border-bottom:1px solid #ddd;">Powerball</th>
<th style="text-align:left; padding:6px 8px; border-bottom:1px solid #ddd;">Status</th>
<th style="text-align:left; padding:6px 8px; border-bottom:1px solid #ddd;">Matches</th>
</tr>
</thead>
<tbody id="slipSavedMiniTbody"></tbody>
</table>
</div>
</div>
</div>
</div>
<!-- Other Fixes: Export section relocated under Generate Powerball Play Slip (Fix #3) -->
<div class="history-table-container vnext-card export-card">
<div class="section-title-row">
<h2 class="history-table-title">Exports</h2>
</div>
<div class="export-controls">
<button class="export-btn" disabled="" onclick="exportToFile()">💾 Save to File</button>
<button class="export-btn" disabled="" onclick="exportToEmail()">📧 Send via Email</button>
<button class="export-btn" disabled="" onclick="printResults()">🖨️ Print Results</button>
<button class="export-btn" disabled="" onclick="printDrawingHistory()">🗂️ Print Drawing History</button>
</div>
</div>
<!-- =========================================================
     Enhancement #3 — Jackpot Hit Dataset (vE3.1/vE3.2) + Pattern Analytics (vE3.3)
     Non-invasive module. No effect on predictions.
========================================================= -->
<!-- Analysis wrapper (Fix #3): All Enhancements grouped below Export -->
<div class="history-table-container vnext-card" id="analysisSection" style="margin-top:12px;">
<div class="section-title-row">
<h2 class="history-table-title">Analysis</h2>
</div>
<div style="font-size:12px; color:#334155; margin-top:4px; margin-bottom:10px;">
    Enhancements and analytical modules. Additive-only. Sections may be hidden or shown by build version.
  </div>
<div class="vnext-card" id="enh3JackpotHitsCard" style="margin-top:12px;">
<div class="section-title-row" style="align-items:flex-start; gap:12px; flex-wrap:wrap;">
<div style="min-width:260px;">
<div style="font-size:14px; font-weight:800; margin-bottom:6px; text-align:center;">Jackpot Data</div>
</div>
<div style="margin-left:auto; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
<div id="enh3YearsCtrl" style="display:flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid rgba(0,0,0,.12); border-radius:999px; background:#fff;">
<label for="enh3YearsSelect" style="font-size:12px; font-weight:800; color:#111827;">Years</label>
<select aria-label="Jackpot hit analysis window (years)" id="enh3YearsSelect" style="font-size:12px; padding:6px 8px; border:1px solid rgba(0,0,0,.18); border-radius:10px; background:#fff; cursor:pointer;"></select>
</div>
<button id="enh3SeedBaselineBtn" style="padding:10px 12px; border-radius:10px; background:#0f766e; color:#fff; border:none; cursor:pointer; font-weight:800;">Seed Baseline (10Y)</button>
<button id="enh3ExportHitsBtn" style="padding:10px 12px; border-radius:10px; background:#111827; color:#fff; border:none; cursor:pointer; font-weight:800;">Export Hits (JSON)</button>
<button id="enh3ImportHitsBtn" style="padding:10px 12px; border-radius:10px; background:#2563eb; color:#fff; border:none; cursor:pointer; font-weight:800;">Import Hits (JSON)</button>
<button id="enh3ClearHitsBtn" style="padding:10px 12px; border-radius:10px; background:#b91c1c; color:#fff; border:none; cursor:pointer; font-weight:800;">Clear</button>
<input accept=".json,application/json" id="enh3HitsFileInput" style="display:none;" type="file"/>
</div>
<div style="flex-basis:100%; display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:2px;">
<button id="enh3RecomputeEnrichBtn" style="padding:10px 14px; border-radius:10px; border:0; background:#1f6feb; color:#fff; cursor:pointer; font-weight:800; box-shadow:0 4px 14px rgba(0,0,0,.12);">Recompute Enrichment</button>
<button id="enh3ShowStateRatesBtn" style="padding:10px 14px; border-radius:10px; border:0; background:#0f766e; color:#fff; cursor:pointer; font-weight:800; box-shadow:0 4px 14px rgba(0,0,0,.12);">Show State Hit Rates</button>
</div>
</div>
<div style="display:flex; gap:10px; flex-wrap:wrap; margin:6px 0 12px 0;">
<div style="padding:8px 10px; border-radius:10px; background:rgba(17,24,39,.05); border:1px solid rgba(17,24,39,.10); font-size:12px;">
<b>Total Hits:</b> <span id="enh3HitCount">0</span>
</div>
<div style="padding:8px 10px; border-radius:10px; background:rgba(17,24,39,.05); border:1px solid rgba(17,24,39,.10); font-size:12px;">
<b>Dataset:</b> <span id="enh3DatasetStatus">Not loaded</span>
</div>
<div style="padding:8px 10px; border-radius:10px; background:rgba(17,24,39,.05); border:1px solid rgba(17,24,39,.10); font-size:12px;">
<b>Schema:</b> pb_jackpot_hits_vE3_2
    </div>
<span id="enh3InlineMsg" style="font-size:12px; color:#9a3412; padding:8px 0;"></span>
</div>
<div id="enh3StateRatesWrap" style="display:none; margin:0 0 12px 0; overflow:auto; border:1px solid rgba(0,0,0,.12); border-radius:12px;">
<table class="history-table" style="min-width:720px;">
<thead>
<tr>
<th>State</th>
<th>Ticket Hits</th>
<th>Population</th>
<th>Span (Years)</th>
<th>Hits / 1M / Year</th>
</tr>
</thead>
<tbody id="enh3StateRatesTbody"></tbody>
</table>
</div>
<div style="overflow:auto; border:1px solid rgba(0,0,0,.12); border-radius:12px;">
<table class="history-table" style="min-width:980px;">
<thead>
<tr>
<th>Draw Date</th>
<th>Jackpot Advertised</th>
<th>Cash Value</th>
<th>Winners</th>
<th>Winner States</th>
<th>Retailer City</th>
<th>Retailer County</th>
<th>Numbers</th>
<th>Notes</th>
</tr>
</thead>
<tbody id="enh3HitsTbody">
<tr><td colspan="9" style="text-align:center; padding:14px; color:#666;">No jackpot hit records loaded.</td></tr>
</tbody>
</table>
</div>
<div style="margin-top:14px; padding-top:12px; border-top:1px dashed rgba(0,0,0,.18);">
<div style="font-size:14px; font-weight:800; margin-bottom:6px;">Pattern Analytics</div>
<div style="font-size:12px; color:#555; margin-bottom:10px; line-height:1.35;">
      Descriptive pattern analytics on the jackpot-hit dataset.
    </div>
<div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:10px;">
<button id="enh3RunAnalyticsBtn" style="padding:10px 12px; border-radius:12px; background:#111827; color:#fff; border:none; cursor:pointer; font-weight:800;">Run Pattern Analytics</button>
<label style="font-size:12px; color:#333; display:flex; align-items:center; gap:6px;">
        Clusters (k):
        <select id="enh3ClusterK" style="padding:8px 10px; border-radius:10px; border:1px solid rgba(0,0,0,.18);">
<option value="2">2</option>
<option selected="" value="3">3</option>
<option value="4">4</option>
<option value="5">5</option>
</select>
</label>
<label style="font-size:12px; color:#333; display:flex; align-items:center; gap:6px;">
        Outlier sensitivity (z):
        <select id="enh3OutlierZ" style="padding:8px 10px; border-radius:10px; border:1px solid rgba(0,0,0,.18);">
<option value="2.0">2.0</option>
<option selected="" value="2.5">2.5</option>
<option value="3.0">3.0</option>
</select>
</label>
<span id="enh3AnalyticsStatus" style="font-size:12px; color:#555;"></span>
</div>
<div class="vnext-card" style="padding:12px; margin-bottom:10px;">
<div style="font-weight:800; margin-bottom:6px;">Clustering</div>
<div style="font-size:12px; color:#555; margin-bottom:8px;">K-means over normalized features: log(jackpot), roll draws to hit, month-of-year, winnerCount.</div>
<div style="overflow:auto; border:1px solid rgba(0,0,0,.12); border-radius:12px;">
<table class="history-table" style="min-width:820px;">
<thead>
<tr>
<th style="width:46px; text-align:center;">Sel</th><th>Cluster</th>
<th>Count</th>
<th>Avg Jackpot</th>
<th>Avg Cash</th>
<th>Avg Roll Draws</th>
<th>Avg Winners</th>
<th>Dominant Months</th>
</tr>
</thead>
<tbody id="enh3ClustersTbody">
<tr><td colspan="8" style="text-align:center; padding:12px; color:#666;">Run analytics to populate clustering results.</td></tr>
</tbody>
</table>
</div>
</div>
<div class="vnext-card" style="padding:12px; margin-bottom:10px;">
<div style="font-weight:800; margin-bottom:6px;">Outlier detection</div>
<div style="font-size:12px; color:#555; margin-bottom:8px;">Outliers flagged by z-score on log(jackpot) and growth-per-draw (when available).</div>
<div style="overflow:auto; border:1px solid rgba(0,0,0,.12); border-radius:12px;">
<table class="history-table" style="min-width:820px;">
<thead>
<tr>
<th style="width:46px; text-align:center;">Sel</th><th>Draw Date</th>
<th>Jackpot</th>
<th>Cash</th>
<th>Roll Draws</th>
<th>Growth/Draw</th>
<th>z(logJackpot)</th>
<th>z(growth/Draw)</th>
<th>Notes</th>
</tr>
</thead>
<tbody id="enh3OutliersTbody">
<tr><td colspan="9" style="text-align:center; padding:12px; color:#666;">Run analytics to populate outliers.</td></tr>
</tbody>
</table>
</div>
</div>
<div class="vnext-card" style="padding:12px; margin-bottom:10px;">
<div style="font-weight:800; margin-bottom:6px;">State representation vs expected share</div>
<div style="font-size:12px; color:#555; margin-bottom:8px;">Observed state “ticket hits” versus expected share by population.</div>
<div style="overflow:auto; border:1px solid rgba(0,0,0,.12); border-radius:12px;">
<table class="history-table" style="min-width:820px;">
<thead>
<tr>
<th style="width:46px; text-align:center;">Sel</th><th>State</th>
<th>Observed Tickets</th>
<th>Expected Tickets</th>
<th>Obs/Exp</th>
<th>Population</th>
<th>Pop Share</th>
<th>Chi Component</th>
</tr>
</thead>
<tbody id="enh3StateShareTbody">
<tr><td colspan="8" style="text-align:center; padding:12px; color:#666;">Run analytics to populate state representation table.</td></tr>
</tbody>
</table>
</div>
</div>
<!-- Enhancement vE3.4: Overlays (display-only) -->
<div class="vnext-card" style="padding:12px; margin-top:12px;">
<div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
<div style="font-weight:800;">Overlays</div>
<label style="display:flex; align-items:center; gap:8px; font-size:12px; color:#222;">
<input id="enh34Enable" type="checkbox"/>
<span>Enable overlays (display-only)</span>
</label>
</div>
<div style="font-size:12px; color:#555; margin-top:6px;">
        Overlays annotate records and analytics with time-aligned context bands/markers. They do not modify dataset logic or predictive scoring.
      </div>
<div style="display:flex; gap:16px; flex-wrap:wrap; align-items:flex-start; margin-top:10px;">
<div style="min-width:220px;">
<div style="font-weight:700; font-size:12px; margin-bottom:6px;">Categories</div>
<label style="display:flex; align-items:center; gap:8px; font-size:12px; margin:4px 0;">
<input checked="" class="enh34Cat" type="checkbox" value="Macro"/> Macro
          </label>
<label style="display:flex; align-items:center; gap:8px; font-size:12px; margin:4px 0;">
<input checked="" class="enh34Cat" type="checkbox" value="Policy"/> Policy
          </label>
<label style="display:flex; align-items:center; gap:8px; font-size:12px; margin:4px 0;">
<input checked="" class="enh34Cat" type="checkbox" value="Ops"/> Ops
          </label>
<label style="display:flex; align-items:center; gap:8px; font-size:12px; margin:4px 0;">
<input checked="" class="enh34Cat" type="checkbox" value="Market"/> Market
          </label>
<div style="margin-top:10px; display:flex; flex-direction:column; gap:8px;">
<button class="btn-primary" id="enh34Export" style="padding:10px 12px; border-radius:999px;">Export Overlays</button>
<label class="btn-primary" style="display:inline-flex; justify-content:center; padding:10px 12px; border-radius:999px; cursor:pointer;">
              Import Overlays
              <input accept="application/json" id="enh34ImportFile" style="display:none;" type="file"/>
</label>
<button class="btn-secondary" id="enh34Reset" style="padding:10px 12px; border-radius:999px;">Reset Baseline</button>
</div>
<div id="enh34Status" style="font-size:12px; color:#555; margin-top:10px;">Status: ready.</div>
</div>
<div style="flex:1; min-width:420px;">
<div style="font-weight:700; font-size:12px; margin-bottom:6px; text-align:center;">Overlay Coverage (descriptive)</div>
<div style="overflow:auto; border:1px solid rgba(0,0,0,.12); border-radius:12px;">
<table class="history-table" style="min-width:760px;">
<thead>
<tr>
<th>Overlay</th>
<th>Category</th>
<th>Type</th>
<th>Records Covered</th>
<th>Outliers Covered</th>
</tr>
</thead>
<tbody id="enh34CoverageTbody">
<tr><td colspan="5" style="text-align:center; padding:10px; color:#666;">Enable overlays and run analytics to populate coverage.</td></tr>
</tbody>
</table>
</div>
<div style="font-size:11px; color:#666; margin-top:6px; text-align:center;">
<div style="margin-top:12px;">
<div style="font-weight:700; font-size:12px; margin-bottom:6px; text-align:center;">Cluster Overlay Coverage (descriptive)</div>
<div style="overflow:auto; border:1px solid rgba(0,0,0,.12); border-radius:12px;">
<table class="history-table" style="min-width:760px;">
<thead>
<tr>
<th>Cluster</th>
<th>Records</th>
<th>Top Overlays (by record coverage)</th>
<th>Outliers in Cluster</th>
</tr>
</thead>
<tbody id="enh34ClusterCovTbody">
<tr><td colspan="4" style="text-align:center; padding:10px; color:#666;">Enable overlays and run analytics to populate cluster coverage.</td></tr>
</tbody>
</table>
</div>
</div>
Coverage percentages are computed against the currently loaded dataset and current outlier sensitivity.
          </div>
</div>
</div>
</div>
<div class="vnext-card" style="display:none; padding:12px;">
<div style="font-weight:800; margin-bottom:6px;">Official Validation Mode (manual paste)</div>
<div style="font-size:12px; color:#555; margin-bottom:8px;">Paste official draw detail text to cross-check jackpot/cash/winner states. This creates a local validation log.</div>
<div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-start;">
<div style="flex:1; min-width:300px;">
<textarea id="enh3ValidationPaste" placeholder="Paste official draw-page text here..." style="width:100%; min-height:120px; padding:10px; border-radius:12px; border:1px solid rgba(0,0,0,.18); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12px;"></textarea>
<div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
<button id="enh3ValidateBtn" style="padding:10px 12px; border-radius:12px; background:#2563eb; color:#fff; border:none; cursor:pointer; font-weight:800;">Validate Paste</button>
<button id="enh3ClearValidationBtn" style="padding:10px 12px; border-radius:12px; background:#64748b; color:#fff; border:none; cursor:pointer; font-weight:800;">Clear</button>
<button id="enh3ViewValidationsBtn" style="padding:10px 12px; border-radius:10px; border:1px solid rgba(0,0,0,.18); background:#6c757d; color:#fff; cursor:pointer; font-weight:800;">View Validation Log</button>
<span id="enh3ValidationMsg" style="font-size:12px; color:#555; padding:10px 0;"></span>
</div>
</div>
<div style="flex:1; min-width:320px; max-height:190px; overflow:auto; border:1px solid rgba(0,0,0,.12); border-radius:12px;">
<table class="history-table" style="min-width:520px;">
<thead>
<tr>
<th>Date</th>
<th>Status</th>
<th>Mismatches</th>
</tr>
</thead>
<tbody id="enh3ValidationTbody">
<tr><td colspan="3" style="text-align:center; padding:12px; color:#666;">No validations yet.</td></tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
<!-- Other Fixes (Fix #3): Moved vE9 Ranking scaffold under Enhancement #3 analytics -->
<div class="vnext-card" id="enh35ExplainabilityCard" style="padding:12px; margin-top:12px;">
<div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
<div style="font-weight:800;">Analysis Explanations</div>
<label style="display:flex; align-items:center; gap:8px; font-size:12px; color:#222;">
<input checked="" id="enh35EnableExplainability" type="checkbox"/>
<span>Enable explainability (traceable outputs)</span>
</label>
</div>
<div style="display:flex; gap:14px; flex-wrap:wrap; align-items:flex-start; margin-top:10px;">
<div style="min-width:260px; flex:1 1 260px;">
<div style="display:flex; flex-wrap:wrap; gap:8px;">
<button id="enh35ExplainStateBtn" style="padding:10px 12px; border-radius:10px; border:none; cursor:pointer; font-weight:800; color:#fff; background:#2563eb;">Explain Selected State</button>
<button id="enh35ExplainClusterBtn" style="padding:10px 12px; border-radius:10px; border:none; cursor:pointer; font-weight:800; color:#fff; background:#0f766e;">Explain Selected Cluster</button>
<button id="enh35ExplainOutlierBtn" style="padding:10px 12px; border-radius:10px; border:none; cursor:pointer; font-weight:800; color:#fff; background:#7c3aed;">Explain Selected Outlier</button>
<button id="enh35ExplainOverlayBtn" style="padding:10px 12px; border-radius:10px; border:none; cursor:pointer; font-weight:800; color:#fff; background:#111827;">Explain Overlay Coverage</button>
<button id="enh35ExportAuditBtn" style="padding:10px 12px; border-radius:10px; border:none; cursor:pointer; font-weight:800; color:#fff; background:#334155;">Export Audit Log</button>
<button id="enh35ClearAuditBtn" style="padding:10px 12px; border-radius:10px; border:none; cursor:pointer; font-weight:800; color:#fff; background:#b91c1c;">Clear Audit</button>
</div>
<div id="enh35BtnHint" style="font-size:11px; color:#666; margin-top:8px; line-height:1.35;">
            Selections are pulled from the Pattern Analytics tables (Cluster / Outlier / State Share). This module is display-only and does not affect predictions, scoring, or dataset logic.
          </div>
</div>
<div style="min-width:260px; flex:0 0 260px;">
<div style="font-weight:700; font-size:12px; margin-bottom:8px;">Current Selection</div>
<div style="font-size:12px; color:#111; line-height:1.6; border:1px solid rgba(0,0,0,.12); border-radius:12px; padding:10px; background:#fff;">
<div><span style="color:#555;">State:</span> <span id="enh35SelState">—</span></div>
<div><span style="color:#555;">Cluster:</span> <span id="enh35SelCluster">—</span></div>
<div><span style="color:#555;">Outlier Date:</span> <span id="enh35SelOutDate">—</span></div>
<div><span style="color:#555;">Outlier z:</span> <span id="enh35SelOutZ">—</span></div>
</div>
<div id="enh35AuditStatus" style="font-size:11px; color:#666; margin-top:8px;"></div>
</div>
<div style="min-width:320px; flex:2 1 320px;">
<div style="font-weight:700; font-size:12px; margin-bottom:8px;">Explainability Output</div>
<div id="enh35Output" style="font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12px; white-space:pre-wrap; border:1px solid rgba(0,0,0,.12); border-radius:12px; padding:10px; background:#0b1220; color:#e5e7eb; min-height:140px; overflow:auto;">Select a row and run an explanation action.</div>
</div>
</div>
</div>
<div class="vnext-card" id="enh9Panel" style="margin-top:12px;">
<div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
<div style="font-size:16px; font-weight:900;">Scoring</div>
<span id="e9StatusPill" style="font-size:12px; color:#0f172a; background:#e2e8f0; border:1px solid #cbd5e1; padding:3px 8px; border-radius:999px;">Status: Not Run</span>
</div>
<div style="font-size:12px; color:#334155; margin-top:6px; line-height:1.35;">
</div>
<div style="display:flex; align-items:flex-end; gap:12px; margin-top:10px; flex-wrap:wrap;">
<label style="display:flex; flex-direction:column; gap:4px; font-size:12px;">
<span style="font-weight:800; color:#0f172a;">Risk Mode</span>
<select id="e9RiskMode" style="padding:6px 8px; border:1px solid #cbd5e1; border-radius:8px; min-width:220px;">
<option selected="" value="CONSERVATIVE">CONSERVATIVE (default)</option>
<option value="AGGRESSIVE">AGGRESSIVE</option>
<option value="EXPLORATORY">EXPLORATORY</option>
</select>
</label>
<button class="secondary-btn" id="e9InitBtn" style="padding:7px 10px; font-weight:800;" type="button">Initialize vE9 Manifest</button>
<button id="e9RunBtn" style="padding:7px 10px; border-radius:10px; border:1px solid #0f172a; background:#0f172a; color:#fff; font-weight:900; cursor:pointer;" type="button">Run vE9 (D3 Scoring)</button>
<button class="secondary-btn" disabled="" id="e9ExportManifestBtn" style="padding:7px 10px; font-weight:800;" type="button">Export Manifest</button>
<button class="secondary-btn" disabled="" id="e9ExportLedgerBtn" style="padding:7px 10px; font-weight:800;" type="button">Export Audit Ledger</button>
</div>
<details style="margin-top:10px;">
<summary style="cursor:pointer; font-weight:900; color:#0f172a;">Candidate Input (optional)</summary>
<div style="font-size:12px; color:#334155; margin:6px 0 8px 0; line-height:1.35;">
      Deliverable #1 expects candidate generation to be delegated to your existing engine. For this scaffold, you may paste candidate rows in the format:
      <span style="font-family:monospace;">01-12-27-41-63|PB-19</span> (one per line). If empty, vE9 will attempt to read candidates from the “Previous Predictions” table if available.
    </div>
<textarea id="e9CandidatesText" placeholder="01-12-27-41-63|PB-19
05-11-24-33-68|PB-02" rows="6" style="width:100%; resize:vertical; padding:10px; border:1px solid #cbd5e1; border-radius:10px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12px;"></textarea>
<div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:8px;">
<button class="secondary-btn" id="e9LoadFromPPBtn" style="padding:7px 10px; font-weight:800;" type="button">Load Candidates from Previous Predictions</button>
<span id="e9CandidateCount" style="font-size:12px; color:#334155; padding:6px 0;">Candidates: 0</span>
</div>
</details>
<details style="margin-top:10px;">
<summary style="cursor:pointer; font-weight:900; color:#0f172a;">Run Details</summary>
<div style="display:flex; gap:14px; flex-wrap:wrap; margin-top:8px;">
<div style="font-size:12px;"><span style="font-weight:900;">Run ID:</span> <span id="e9RunId">—</span></div>
<div style="font-size:12px;"><span style="font-weight:900;">Fingerprint:</span> <span id="e9Fingerprint">—</span></div>
<div style="font-size:12px;"><span style="font-weight:900;">Enabled Modules:</span> <span id="e9EnabledModules">—</span></div>
</div>
<pre id="e9PrecheckLog" style="margin-top:10px; white-space:pre-wrap; background:#0b1020; color:#e2e8f0; padding:10px; border-radius:10px; font-size:12px; line-height:1.35;">(precheck log)</pre>
</details>
<div style="margin-top:10px; font-size:12px; color:#334155;">
</div>
</div>
<div class="vnext-card" id="jefPanel" style="margin-top:12px;">
  <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
    <div style="font-size:16px; font-weight:900;">Jackpot Event Forecast (Experimental)</div>
    <span id="jefStatusPill" style="font-size:12px; color:#0f172a; background:#e2e8f0; border:1px solid #cbd5e1; padding:3px 8px; border-radius:999px;">Status: Not Run</span>
  </div>

  <div style="font-size:12px; color:#334155; margin-top:6px; line-height:1.35;">
    Produces a deterministic Top 10 list of <b>observational</b> event forecasts (When / Where / How / Why). This panel never states win odds and never uses causal narratives.
  </div>

  <div style="display:flex; align-items:flex-end; gap:12px; margin-top:10px; flex-wrap:wrap;">
    <button id="jefRunBtn" style="padding:7px 10px; border-radius:10px; border:1px solid #0ea5e9; background:#0ea5e9; color:white; font-weight:800; cursor:pointer;" type="button">Run Event Forecast</button>
    <button class="secondary-btn" id="jefExportBtn" disabled type="button">Export JEF JSON</button>
    <div id="jefMissingMsg" style="font-size:12px; color:#b91c1c; font-weight:800; display:none;"></div>
  </div>

  <div id="jefOutputWrap" style="margin-top:12px;">
    <div id="jefOutputEmpty" style="font-size:12px; color:#64748b;">No output yet.</div>
    <div id="jefCards" style="display:none; margin-top:6px; flex-direction:column; gap:10px;"></div>
  
  <details id="jefD6Details" style="margin-top:12px;">
    <summary style="cursor:pointer; font-weight:800; color:#0f172a;">D6 Self-Tests (Fail-Closed + Determinism)</summary>
    <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
      <button id="jefD6InstallMocksBtn" class="btn-secondary" type="button">Install Deterministic Mock Inputs</button>
      <button id="jefD6ClearMocksBtn" class="btn-secondary" type="button">Clear Mocks</button>
      <button id="jefD6RunTestsBtn" class="btn-primary" type="button">Run D6 Self-Tests</button>
    </div>
    <div style="margin-top:10px; font-size:12px; color:#334155; line-height:1.4;">
      These tests verify: (1) fail-closed behavior when required inputs are missing, (2) deterministic repeatability given identical inputs, and (3) map highlight gating.
      They do not modify upstream vE9 logic and can be cleared at any time.
    </div>
    <div id="jefD6Results" style="margin-top:10px;"></div>
  </details>

</div>
</div>
<div class="vnext-card" id="enh9UsaMapCard" style="margin-top:12px;">
<div class="section-title-row">
<h2>US Winners Map</h2>
<label class="section-toggle" title="Show/hide the USA winner map section (display-only).">
<input checked="" id="toggleEnh9Map" type="checkbox"/> Visible
    </label>
</div>
<div id="enh9UsaMapContent">
<div style="font-size:13px; color:#334155; line-height:1.55; margin-bottom:10px;">
      Display-only interactive USA map for state-level winner distribution . Hover to preview; click a state to view
      structured details.
    </div>
<div aria-label="USA map layer controls" class="e9map-controls">
<label class="e9map-toggle" title="Observed share of jackpot wins attributed to the jurisdiction. Descriptive only unless SRES is enabled."><input checked="" name="e9MapLayer" type="radio" value="winnerShare"/> Winner Share</label>
<label class="e9map-toggle" title="Observed share minus expected share (percentage points). Highlights over/under representation. Descriptive only unless SRES is enabled."><input name="e9MapLayer" type="radio" value="deltaExpected"/> Delta vs Expected</label>
<label class="e9map-toggle">
<input id="e9MapToggleCxt" type="checkbox"/> CXT Overlay
  <span aria-label="CXT Overlay information" class="e9info-icon" role="img" tabindex="0" title="Context overlay. Non-causal annotation layer. Never modifies historical data.">(i)</span>
</label>
<div class="e9map-spacer"></div>
<label class="e9map-fallback" title="Accessibility fallback (optional).">
        State:
        <select aria-label="Select a jurisdiction" id="e9MapJurisdictionSelect">
<option value="">— Select —</option>
<!-- populated in later deliverables -->
</select>
</label>
<button class="small-btn" disabled="" id="e9MapClearSelectionBtn" title="Clear the selected state" type="button">Clear</button>
</div>
<div class="e9map-grid">
<div aria-label="USA map canvas" class="e9map-canvas" id="e9MapCanvas">
<!-- (c) ammap.com | SVG map of USA: Mainland Mercator-calibrated - High -->
<svg class="e9usa-svg" height="100%" id="e9UsaSvg" preserveaspectratio="xMidYMid meet" version="1.1" viewbox="0 0 1000 800" width="100%" xmlns="http://www.w3.org/2000/svg" xmlns:amcharts="http://amcharts.com/ammap" xmlns:xlink="http://www.w3.org/1999/xlink">
<defs>
<style type="text/css">
			.land
			{
				fill: #CCCCCC;
				fill-opacity: 1;
				stroke:white;
				stroke-opacity: 1;
				stroke-width:0.5;
			}
		</style>
<amcharts:ammap bottomlatitude="14.808396" leftlongitude="-124.979930" projection="mercator" rightlongitude="-66.983333" toplatitude="49.374568"></amcharts:ammap>
<!-- All areas are listed in the line below. You can use this list in your script. -->
<!--{id:"US-AK"},{id:"US-AL"},{id:"US-AR"},{id:"US-AZ"},{id:"US-CA"},{id:"US-CO"},{id:"US-CT"},{id:"US-DC"},{id:"US-DE"},{id:"US-FL"},{id:"US-GA"},{id:"US-HI"},{id:"US-IA"},{id:"US-ID"},{id:"US-IL"},{id:"US-IN"},{id:"US-KS"},{id:"US-KY"},{id:"US-LA"},{id:"US-MA"},{id:"US-MD"},{id:"US-ME"},{id:"US-MI"},{id:"US-MN"},{id:"US-MO"},{id:"US-MS"},{id:"US-MT"},{id:"US-NC"},{id:"US-ND"},{id:"US-NE"},{id:"US-NH"},{id:"US-NJ"},{id:"US-NM"},{id:"US-NV"},{id:"US-NY"},{id:"US-OH"},{id:"US-OK"},{id:"US-OR"},{id:"US-PA"},{id:"US-RI"},{id:"US-SC"},{id:"US-SD"},{id:"US-TN"},{id:"US-TX"},{id:"US-UT"},{id:"US-VA"},{id:"US-VT"},{id:"US-WA"},{id:"US-WI"},{id:"US-WV"},{id:"US-WY"}-->
</defs>
<g>
<path class="land" d="M624.48,706.69v2.77v2.73v2.7v2.66v2.63v2.59v2.56v2.53v2.5v2.47v2.44v2.41v2.38v2.36v2.33v2.3v2.28v2.25v2.23v2.21v2.18v2.16v2.14v2.12v2.1v2.08v2.06v2.04v2.02v2v1.98v1.96l0.8,0.27l0.79,0.27l0.24,-0.54l0.85,0.42l0.74,0.36l0.47,-0.47l0.51,-0.5l0.69,-0.04l0.77,-0.04l0.52,-0.03v0.43l-0.19,0.71l-0.16,0.59l0.43,0.54l0.04,0.06l0.58,0.32l0.54,0.29l0.24,0.81l0.59,0.62l0.45,0.47l0.43,0.45l0.62,0.65l0.43,0.45l0.58,0.6l0.34,0.36l0.17,0.69l0.2,0.83l-0.12,0.49l0.27,0.08l0.53,-0.55l0.5,-0.34l0.62,-0.42l0.42,-0.28l0.78,-0.01l0.37,-0.83l0,-1.16l0.39,0.02l0.23,-0.16l0.1,-0.34l-0.25,-0.47l0.75,-0.22l0.54,-0.16l0.77,-0.43l0.75,-0.42l0.36,0.33l0.36,0.32l0.7,0.76l0.05,0.18l-0.05,0.36l-0.07,0.36l0.42,1l0.12,0.11l0.35,0.14l0.42,0.33l0.18,0.28l0.6,0.45l0.1,0.19l0.06,0.3l0.1,0.26l0.11,0.19l0.11,0.27l0.26,0.31l0.5,0.35l0.34,0.24l0.48,0.34l0.49,0.69l0.42,0.6l0.48,0.59l-0.07,0.47l0.49,0.72l0.52,0.91l0.4,0.81l0.28,0.45l0.34,0.65l0.41,0.79l0.47,0.9l0.36,0.57l0.47,0.8l0.23,0.48l-0.16,0.33l-0.19,0.4l0.6,0.19l0.42,0.13l-0.1,0.44l-0.14,0.59l0.47,0.23l0.32,0.16l-0.07,0.31l0.18,0.35l0.03,0.57l0.57,-0.04l0.25,-0.02l0.34,0.25l0.45,0.33l0.45,0.31l0.39,0.27l0.51,0.16l0.63,0.23l0.31,0.46l0.57,0.2l0.21,0.64l0.66,0.24l0.39,-0.16l0.14,0.26l0.11,0.3l0.03,0.38l-0.04,0.37l-0.16,0.31l-0.12,0.33l-0.08,0.36l-0.03,0.38l0.02,0.41l0.07,0.36l0.2,0.65l0.07,0.4l0.01,0.27l-0.45,0.94l-0.15,0.44l0.02,0.2l-0.33,0.46l-0.6,0.65l-0.27,0.37l-0.13,-0.12l-0.77,-0.1l-0.28,-0.82l-0.15,-0.64l-0.23,-0.56l0.01,-0.13l0.21,-0.37l0.78,-0.31l0.01,-0.12l-0.29,-0.08l-0.07,-0.13l-0.08,-0.61l0.02,-0.53l-0.02,-0.35l-0.13,-0.73l-0.19,-0.45l-0.5,-0.87l-0.04,-0.22l0.22,-0.28l0.14,-0.26l-0.85,0.45l-1.15,0.47l-0.49,0.33l-0.1,0.13l-0.04,0.11l0.09,0.31l-0.01,0.1l-0.1,0.18l-0.12,0.52l-0.25,0.55l-0.13,0.11l-0.45,-0.2l-0.12,-0.17l-0.23,-0.71l0.05,-0.19l0.17,-0.16l0.22,-0.35l0.28,-0.53l0.54,-1.36l0.35,-0.01l0.62,-0.27l-0.97,-0.14l-0.14,-0.07l-0.13,-0.19l-0.12,-0.3l-0.2,-0.34l-0.37,-0.12l-0.16,-0.12l-0.24,-0.41l-0.16,-0.18l-0.09,-0.23l-0.02,-0.27l-0.07,-0.14l-0.25,-0.05l-0.14,-0.09l-0.04,-0.7l-0.51,-0.18l-0.21,-0.16l-0.33,-0.44l-0.09,-0.21l-0.03,-0.18l0.08,-0.49l-0.04,-0.09l-0.29,0.05l-1.83,-0.76l0.1,-1.01l-0.34,-1.34l-0.36,-0.55l0.07,-0.21l0.08,-0.11l0.16,0l0.7,0.4l0.66,0.47l0.09,-0.07l-1.06,-1l-0.26,-0.3l-0.06,-0.36l0,-0.19l0.08,-0.1l0.99,0.09l0.06,-0.07l-1.01,-0.29l-0.2,0l-0.22,0.42l-0.1,0.1l-0.22,-0.02l-0.07,-0.06l-0.26,-0.51l-0.24,-0.35l-0.45,-0.49l-0.08,-0.35l-0.02,-0.52l0.06,-0.49l0.37,-1.13l0.15,-0.2l0.04,-0.12l-0.11,0.02l-0.11,0.11l-0.31,0.52l-0.31,0.86l-0.26,0.29l-0.16,-0.07l-0.24,-0.35l-0.51,-0.43l-0.59,-0.11l-0.37,-0.44l-0.55,-1.22l-0.07,-0.61l-0.07,-0.15l-0.3,-0.2l-0.18,-0.29l-0.28,-1.5l-0.37,-1.05l-0.09,-0.56l0.03,-0.55l-0.05,-0.06l-0.13,0.43l-0.03,0.23l-0.24,0.06l0.22,0.44l0.06,0.22l-0.11,-0.02l-0.23,0.06l0.39,0.74l0.17,1.15l0.26,0.84l0.17,0.68l0.08,0.52l0.11,0.49l0.3,1.08l0.04,0.22l-0.04,0.18l-0.1,0.21l-0.17,0.08l-0.53,-0.14l-0.2,-0.27l-0.29,-0.49l-0.4,-0.23l-1,0.11l-0.08,-0.04l0,-0.4l0.12,-0.72l-0.09,-0.29l-0.52,-1.06l0.01,-0.21l0.72,-0.49l-0.35,-0.04l-0.28,0.19l-0.11,-0.12l-0.17,-0.68l-0.11,-0.26l-0.05,-0.05l-0.03,0.65l0.12,0.34l0.02,0.2l-0.02,0.28l-0.07,0.2l-0.13,0.12l-0.13,0.03l-0.24,-0.14l-0.27,-0.26l-0.23,-0.12l-0.09,-0.1l-0.11,-0.29l-0.18,-0.22l-0.88,-0.28l-0.52,-0.33l-0.04,0.09l0.16,0.35l0.02,0.21l-0.13,0.06l-0.24,0.33l0.07,0.05l0.25,-0.11l0.28,0.01l0.46,0.2l0.42,0.26l0.15,0.15l0.06,0.22l0.05,0.08l0.41,0.25l0.02,0.13l-0.26,0.4l0.54,-0.04l0.32,0.14l0.4,0.61l0.14,0.34l0.02,0.44l-0.08,0.13l-0.16,0.09l-1.1,0.14l-0.4,0.52l-0.08,0.01l-0.3,-0.14l-0.55,-0.42l-0.69,-0.4l-1.57,-1.18l-0.04,-0.06l-0.02,-0.23l-0.11,-0.12l-0.21,-0.1l-0.3,-0.3l-0.38,-0.5l-0.23,-0.39l-0.09,-0.28l-0.22,-0.32l-0.71,-0.68l-0.37,-0.26l-0.33,-0.15l-0.28,-0.03l-0.08,-0.09l0.13,-0.15l0.02,-0.09l-0.63,-0.14l-0.6,-0.32l-1.52,-0.9l-0.78,-0.56l-0.46,-0.27l-0.19,-0.15l-0.09,-0.12l0.11,-0.13l0.31,-0.14l0.21,-0.15l0.33,-0.58l0.02,-0.18l-0.18,-0.42l-0.08,-0.38l0,-0.21l0.04,-0.21l0.05,-0.14l0.14,-0.13l0.1,-0.07l0.12,0.05l0.39,0.53l0.05,0.19l-0.02,0.72l0.11,0.84l0.04,-0.06l0.04,-0.28l0.02,-0.53l0.04,-0.25l0.08,-0.25l0.14,-0.13l0.43,0.08l0.2,-0.04l-0.84,-0.38l-0.53,-0.72l-0.1,-0.07l-0.29,-0.03l-0.31,0.29l-0.79,0.94l-0.22,0.17l-1,0.52l-0.67,0.1l-0.76,-0.08l-0.65,-0.17l-1.62,-0.82l-0.25,-0.19l0.38,-0.51l0.02,-0.16l-0.13,-0.52l-0.11,-0.15l-0.15,-0.08l-0.04,0.06l0,0.15l0.04,0.29L623,782.7l-0.28,0.16l-0.46,0.17l-1.44,-0.42l-1.48,-0.35l-1.32,-0.07l-1.86,0.28l-0.99,0.28l-0.58,0.03l-0.56,-0.05l-0.04,-0.19l0.25,-0.11l-0.01,-0.14l-0.32,-0.44l-0.49,-0.27l-0.65,-0.1l-0.37,-0.13l-0.09,-0.16l-0.23,-0.16l-0.37,-0.15l-0.16,-0.27l0.13,-0.83l0.13,-0.5l0.13,-0.34l0.32,-0.57l-0.11,0.04l-0.46,0.42l-0.4,0.43l-0.37,0.56l-0.22,0.26l-0.28,0.24l-0.44,-0.06l-0.6,-0.35l-0.52,-0.18l-0.43,-0.01l-0.17,-0.06l0.29,-0.31l0.17,-0.25l0.23,-0.4l0.05,-0.2l-1.57,-0.06l-0.06,-0.21l0,-0.16l-0.05,-0.13l-0.23,-0.1l-0.32,0.07l-0.52,0.25l-0.22,-0.19l0.08,-0.11l0.17,-0.08l0.34,-0.37l-0.46,-0.19l-0.24,-0.22l-0.12,-0.18l0.01,-0.65l0.12,-0.42l1.04,-0.41l-0.33,-0.16l-0.66,0.06l-0.44,0.35l-0.52,0.5l-0.35,0.19l-0.18,-0.13l-0.24,-0.04l-0.3,0.04l-0.2,0.13l-0.1,0.22l-0.12,0.14l-0.13,0.08l-0.1,-0.02l-0.14,-0.22l-0.3,-0.14l-0.15,-0.17l-0.08,0.11l-0.1,0.32l-0.11,0.16l-0.5,0.17l-0.28,-0.03l-0.33,-0.4l-0.05,-0.14l0.11,-0.34l0.73,-1.37l-0.07,0.01l-0.24,0.22l-0.47,0.55l-0.21,0.16l-0.36,0.02l-0.17,-0.06l-0.2,0.04l-0.24,0.15l-0.16,0.16l-0.07,0.18l0.05,0.03l0.36,-0.2l0.2,-0.05l0.06,0.1l-0.28,0.62l-0.17,0.59l-0.16,0.15l-0.26,-0.02l-0.28,0.06l0,0.16l0.53,0.47l0.19,0.07l0.24,0.17l0.04,0.17l-0.09,0.45l-0.07,0.18l-0.11,0.09l-0.43,-0.01l-0.14,0.05l-0.29,0.28l-0.14,0.23l0.05,0.02l0.25,-0.19l0.36,-0.1l0.48,-0.01l0.36,-0.1l0.23,-0.19l0.23,0.05l0.22,0.3l0.07,0.26l-0.09,0.22l-0.18,0.16l-0.28,0.1l-0.17,0.14l-0.07,0.19l-0.04,0.28l-0.01,0.37l0.07,0.67l-0.05,0.09l-0.1,0.05l-0.15,0.01l-0.14,0.16l-0.32,0.88L599.7,783l-0.14,-0.09l-0.12,0.01l-0.1,0.12l-0.23,0.09l-0.36,0.06l-0.3,-0.02l-0.54,-0.19l-0.22,-0.13l-0.17,-0.22l-0.48,0.23l-0.13,-0.1l-0.3,-0.61l-0.06,0.04l-0.06,0.66l-0.09,0.23l-0.3,0.48l-0.16,0.82l-0.05,0.02l-0.06,-0.12l-0.18,-0.73l-0.1,-0.16l-0.27,0.42l-0.03,0.15l0.07,0.54l-0.06,0.08l-0.54,-0.29l-0.13,-0.01l-0.04,0.05l0.19,0.42l-0.02,0.15l-0.77,0.81l-0.2,-0.03l-0.13,-0.08l-0.14,0.01l-0.49,0.3l-0.13,-0.01l-0.18,-0.18l-0.09,0.01l-0.04,0.19l-0.01,0.36l-0.18,0.34l-0.58,0.55l-0.15,0.26l-0.12,0.35l-0.09,0.03l-0.34,-0.22l-0.4,-0.15l-0.05,0.07l0.12,0.21l-0.03,0.13l-0.17,0.05l-0.22,-0.02l-0.26,-0.09l-0.37,0.1l-0.47,0.28l-0.39,-0.01l-0.55,-0.46l-0.15,-0.04l-0.05,-0.13l0.11,-0.37l0.16,-0.28l0.12,-0.13l0.52,-0.36l0.6,-0.13l0.38,-0.22l0.46,-0.45l0.24,-0.34l0.48,-0.88l-0.04,-0.07l-0.11,-0.05l-1.04,0.84l-0.15,0.08l-0.21,-0.01l-0.83,-0.32l-0.18,-0.14l-0.12,-0.4l0.23,-0.92l0.16,-0.44l0.41,-0.69l0.53,-0.74l0.19,-0.48l0.28,-1.29l-0.02,-0.59l-0.12,-0.72l0,-0.43l0.12,-0.14l1.22,-0.67l0.58,-0.5l1.12,-0.74l0.31,0.01l0.23,0.26l0.26,0.21l0.3,0.15l0.38,-0.02l0.47,-0.18l0.74,0.07l1.53,0.49l0.32,0.03l0.01,-0.06l-0.23,-0.34l-1.05,-0.2l-0.44,-0.2l-1.25,-0.88l-0.28,-0.34l0.12,-0.16l0.31,-0.13l0.1,-0.13l0.04,-0.22l0.18,-0.3l0.31,-0.39l0.47,-0.37l0.89,-0.56l-0.35,-0.02l-0.64,0.1l-0.23,0.11l-0.43,0.4l-0.17,0.28l-0.24,0.54l-0.1,0.1l-0.44,0.08l-1.2,0.06l-0.2,-0.28l-0.11,-0.04l-0.15,0.04l-1.11,0.71l-0.4,0.36l-0.28,0.41l-0.44,0.3l-0.59,0.19l-0.44,0.24l-0.47,0.47l-0.16,0.36l-0.01,0.17l0.11,0.53l-0.11,0.1l-0.27,0.04l-0.43,0.35l-0.91,1.04l-0.12,0.38l0.01,0.13l0.15,0.29l-0.1,0.19l-0.26,0.3l-0.57,0.48l-0.37,0.18l-0.24,0.01l-0.23,-0.07l-0.42,-0.31l-0.34,-0.02l-0.02,0.04l0.46,0.33l0.47,0.42l0.29,0.35l0.12,0.28l0.01,0.28l-0.1,0.29l-0.33,0.51l-0.32,0.15l-0.83,0.15l-0.27,0.12l-0.08,0.09l0.57,0.21l0.05,0.11l-0.08,0.42l-0.15,0.14l-0.47,0.25l-0.42,0.07l-0.06,-0.05l0.08,-0.33l-0.02,-0.08l-0.16,-0.07l-0.23,0.13l-0.56,0.49l-0.06,0.08l0.2,0.13l-0.04,0.11l-0.31,0.35l-0.13,0.23l-0.2,0.24l-0.91,0.72l0.07,0.18l-0.24,0.63l-0.13,0.55l0.16,0.23l0.77,0.27l0.37,0.07l0.44,0.19l0.79,0.51l0.26,0.33l0.04,0.16l-0.02,0.17l-0.09,0.23l-0.25,0.43l-0.6,0.64l-0.27,0.18l-0.41,0.14l-0.13,0.1l-0.52,0.6l-0.14,0.33l0.02,0.28l-0.1,0.2l-0.67,0.39l0.02,0.07l0.25,0.03l-0.09,0.34l-0.04,0.47l-0.12,0.08l-0.42,0l-0.54,0.18l-0.04,0.05l-0.01,0.34l-1.4,0.25l-0.31,0.64l-0.16,0.2l-0.55,0.47l-0.34,0.19l-0.38,0.11l-0.2,0.16l-0.02,0.2l-0.11,0.17l-0.33,0.29l-0.16,0.36l-0.12,0.06l-0.62,0.09l-0.12,0.11l-0.06,0.49l-0.11,0.02l-0.22,-0.11l-0.29,0.09l-0.64,0.55l-0.14,0.2l0.02,0.1l0.1,0.11l0.15,0.33l-0.01,0.22l-0.25,0.61l-0.09,0.09l-0.3,0.15l-0.12,0.34l-0.28,-0.04l-0.22,0.06l-0.15,0.22l-0.16,0.13l-0.17,0.03l-0.22,0.18l-0.26,0.32l-0.24,0.2l-0.22,0.09l-0.21,0.02l-0.21,-0.04l-0.19,0.04l-0.17,0.12l-0.16,0.19l-0.13,0.52l-0.16,0.23l-0.1,0.04l-0.21,-0.04l-0.32,-0.11l-0.33,0.04l-0.53,0.32l-0.17,0.24l0.33,0.05l0.17,0.07l0,0.07l-0.17,0.07l-0.29,0l-0.18,0.06l-0.21,0.14l-0.54,0.15l-0.21,0.11l-0.41,0.6l-0.05,0.14l0.05,0.03l0.23,-0.06l0.27,0.1l0.14,0.13l0.09,0.16l0.09,0.3l0.05,0.05l-0.52,0.5l-0.15,0.21l-0.09,0.08l-0.06,-0.06l-0.06,-0.56l-0.04,-0.1l-0.12,-0.01l-0.12,0.18l-0.26,0.66l-0.28,0.33l-2.12,0.85l-0.31,0.19l-0.06,0.36l-0.09,0.31l-0.14,0.25l-0.16,0.16l-0.04,-0.11l0.02,-0.88l-0.04,-0.17l-0.21,-0.11l-0.09,0.02l-0.13,0.05l-0.21,0.19l-0.13,0.05l-0.16,-0.02l-0.28,0.19l-0.66,0.6l-0.43,0.15l-0.11,0.13l-0.18,0.33l-0.12,0.12l-0.18,0.01l-0.24,-0.1l-0.19,0.07l-0.14,0.24l-0.15,0.09l-0.42,-0.17l-0.18,0.12l-0.24,0.31l-0.25,0.2l-0.26,0.1l-0.68,0.1l-0.27,-0.06l-0.05,-0.09l0.01,-0.39l0.11,-0.28l0.1,-0.13l0.14,-0.12l0.2,-0.01l0.37,0.09l-0.04,-0.09l-0.13,-0.11l-0.34,-0.19l-0.34,-0.1l-0.19,0.06l-0.27,0.15l-0.18,0.17l-0.1,0.2l-0.12,0.64l-0.07,0.17l-0.79,1.12l-0.31,0.34l-0.31,-0.02l-0.15,0.13l-0.21,0.28l-0.19,0.13l-0.18,-0.01l-0.14,-0.05l-0.1,-0.09l0.02,-0.09l0.13,-0.08l-0.05,-0.22l-0.23,-0.36l-0.15,-0.2l-0.29,-0.02l-0.05,0.17l0.1,0.85l-0.01,0.19l-0.18,0.24l-0.48,0.27l-0.15,-0.03l-0.43,-0.53l-0.41,-0.11l-0.03,0.17l0.09,0.35l-0.1,0.33l-0.3,0.31l-0.23,0.15l-0.15,-0.01l-0.01,-0.21l0.14,-0.42l0.04,-0.35l-0.07,-0.28l0.01,-0.22l0.08,-0.15l0.55,-0.42l0.23,-0.06l0.12,0.1l0.15,0.02l0.18,-0.07l0.12,-0.13l0.05,-0.2l0.24,-0.26l0.42,-0.31l0.48,-0.58l0.54,-0.85l0.64,-0.73l0.73,-0.62l0.79,-0.49l1.6,-0.68l0.12,0.04l-0.15,0.22l0.1,0.14l0.16,0.02l0.59,-0.11l0.23,-0.14l0.07,0.14l-0.08,0.17l-0.35,0.18l0.01,0.15l0.51,0.68l0.16,0.1l0.13,-0.01l0.06,-0.09l-0.04,-0.49l0.17,-0.09l0.35,-0.02l0.23,0.06l0.11,0.15l0.2,0.13l0.3,0.1l0.19,-0.03l0.07,-0.16l-0.13,-0.19l-0.57,-0.42l-0.16,-0.18l-0.04,-0.24l0.08,-0.31l0.18,-0.46l0.28,-0.62l0.25,-0.43l0.51,-0.49l0.34,-0.24l0.87,-0.75l1.67,-0.76l0.41,-0.49l0.56,-0.55l0.24,-0.13v0.21l0.08,0.19l0.38,0.13l0.24,0.04l0.11,-0.04l0.03,-0.2l-0.05,-0.36l-0.01,-0.34l0.03,-0.32l0.06,-0.26l0.25,-0.45l0.37,-0.52l0.51,-0.6l0.32,-0.28l0.3,-0.15l0.29,-0.26l0.5,-0.63l0.16,-0.1l0.36,-0.12l0.13,0.06l0.08,0.16l0.1,0.1l0.37,0.09l0.24,-0.14l-0.04,-0.07l-0.2,-0.05l-0.13,-0.09l-0.12,-0.37l-0.24,-0.23l-0.05,-0.26l0.04,-0.4l0.21,-0.94l0.03,-0.97l0.19,-0.56l0.37,-0.2l0.83,-0.14l-0.48,-0.25l-0.18,0l-0.31,-0.12l-0.12,-0.61l0,-0.45l0.21,-0.52l0.77,-0.88l0.84,-0.61l-0.11,-0.05l-0.1,-0.18l0.39,-1.23l0.38,-1.1l-0.51,0.94l-0.59,0.72l-1.74,0.83l-1.18,0.69l-0.56,0.17l-0.37,-0.17l-0.29,-0.66l-0.16,-0.23l-0.21,-0.43l0.09,-0.56l0.17,-0.39l0.37,-0.06l0.42,0.19l0.36,0.02l-0.46,-0.39l-0.67,-0.34l-0.3,0.11l-0.23,0.55l-0.31,0.38l-0.27,-0.13l-0.16,-0.15l0.11,0.46l-0.21,0.7l-0.08,0.48l0.3,1.26l-0.05,0.5l-0.54,0.23l-0.44,-0.41l-0.91,-1.6l-0.32,-0.46l-0.72,-0.76l-0.24,0.11l-0.3,0.37l-0.29,0.1l-0.77,-0.55l-0.36,-0.42l-0.34,-0.51l-0.52,0.28l-0.45,0.34l-0.53,0.54l-0.35,0l-0.97,0.46l-0.1,0.01l-0.14,0.25l-0.13,0.11l-0.11,0.47l-1.31,0.37l-1.29,-0.2l0.45,-0.26l0.51,-0.2l0.44,-0.49l-0.19,-0.66l-0.03,-0.34l0.01,-0.43l0.48,-0.6l-0.5,0l-0.32,0.22l-0.3,-0.45l-0.14,-0.89l0.34,-0.53l0.16,-0.41l0.14,-0.56l0.01,-0.48l-0.26,-0.82l-0.76,-1.75l-0.35,-1.32l-0.59,-0.7l0.44,-1.16l0.49,-1.06l0.64,-0.48l-0.05,-0.07l-0.35,0l-0.23,0.06l-0.21,0.35l-0.22,0.27l-0.68,1.35l-0.43,0.66l-0.28,0.19l0.46,0.25l0.07,0.21l0.09,0.48l-0.12,0.59l-0.12,0.32l-0.54,-0.02l-0.48,0.47l-1.13,0.51l-1.53,0.29l-0.75,-0.04l-0.78,-0.59l0.01,-0.34l0.03,-0.3l-1.12,-1.03l-0.64,-1.03l-0.46,-0.02l-0.4,-0.28l-0.47,-0.43l0.04,-0.35l0.07,-0.24l-0.29,-0.17l-0.37,0.02l-0.43,-0.12l1.12,-1.34l0.39,-0.9l0.31,-0.13l0.41,0.14l0.56,0.36l0.47,0.16l0.17,0.17l0.18,0.32l-0.18,0.53l-0.17,0.37l0.21,-0.1l0.59,-0.57l0.44,-0.51l0.21,0.05l0.14,0.09l0.24,0.52l0.3,0.53l0.67,-0.5l0.36,-0.63l-0.3,-0.28l-0.37,-0.16l-0.94,-0.21l0.23,-0.18l0.6,0.02l0.23,-0.17l-0.24,-0.24l-0.3,-0.21l-0.81,0.72l-1.48,-0.04l-1.04,-0.42l-1.03,0.07l-0.16,-0.08l-0.2,-0.22l0.58,-0.53l0.41,-0.3l0.02,-0.17l-0.24,-0.02l-0.45,0.14l-0.2,-0.25l0.03,-0.43l-0.07,0.04l-0.18,0.23l-0.25,-0.11l-0.22,-0.19l0.11,-0.21l0.22,-0.28l-0.1,-0.04l-0.2,0.06l-0.19,0.37l0.04,0.3l0,0.43l-0.33,0.08l-0.28,-0.05l-0.2,-0.43l-0.21,-0.93l-0.57,-0.25l-0.14,-0.47l0.36,-0.61l-0.16,-0.31l-0.38,-0.1l-0.44,0.31l-0.19,-0.27l-0.04,-0.3l-0.01,-0.43l0.12,-0.04l0.1,0.09l0.88,-0.24l0.09,-0.12l-0.7,-0.36l-0.2,-0.38l0.29,-0.22l0.52,-0.02l0.73,-0.23l-0.31,-0.41l-0.06,-0.22l-0.06,-0.37l0.12,-0.63l0.86,-1.45l0.84,-1.21l0.26,-0.28l0.39,-0.15l0.36,0.12l0.37,0.26l0.07,-0.11l-0.13,-0.11l-0.16,-0.5l0.52,-0.2l0.3,-0.56l0.02,-0.16l-0.33,0.24l-0.34,0.39l-0.09,-0.39l-0.09,-0.9l0.15,-0.85l0.12,-0.38l0.29,-0.36l0.83,-0.15l0.15,0.07l0.03,-0.17l-0.5,-0.54l0.21,-0.42l0.18,-0.22l1,-0.34l0.55,0.11l0.69,0.4l0.4,0.5l-0.06,0.26l-0.1,0.15l-0.21,0.17l-0.08,0.13l0.04,0.1l0.29,-0.29l0.48,-0.36l0.27,0.16l0.21,0.28l0.24,0l0.75,-0.24l0.38,-0.26l0.47,-0.67l0.62,-0.44l0.87,-1.38l0.26,-0.57l0.3,-0.09l0.27,0.05l0.19,0.47l0.27,0.14l1.56,-0.11l0.8,-0.21l0.55,-0.45l0.57,-0.77l0.33,-0.51l0.16,-0.67l-0.2,-0.87l-0.21,-0.73l-0.28,-1.67l-0.77,-1.11l-0.55,-0.33l-0.35,0.05l0.25,-0.71l0.74,0.08l0.48,-0.14l0.39,-0.34l0.13,-0.26l0.19,-0.53l-0.07,-0.57l-0.1,-0.31l-0.27,-0.34l-0.32,-0.5l-0.22,-0.17l-0.19,0.01l-0.93,1.01l-0.56,0.02l-0.42,-0.18l-0.36,0.57l-1.01,0.5l-0.54,0.51l-1,1.25l-0.25,0.56l-0.32,0.03l-0.23,-1.09l-1.09,-1.05l-0.33,0.36l0.18,0.33l0.25,0.23l0.41,0.1l-0.17,0.32l-0.13,0.42l-0.41,-0.39l-0.73,-0.57l-0.75,-0.3l-1.96,0.03l-1.29,0.59l-0.12,-0.12l-0.12,-0.05l-0.21,0.14l-0.09,0.24l-0.14,0.15l-0.26,0.05l-0.53,-0.09l-1.02,-0.37l-2.31,-0.54l-0.6,-0.33l-0.52,-0.79l0.01,-0.54l0.23,-0.23l-0.02,-0.78l-0.45,-0.21l-0.92,-1.12l-0.34,-0.48l0.07,-0.05l0.17,0.13l0.31,0.1l0.77,-0.16l0.26,-0.73l0.57,-0.21l0.53,0.1l-0.12,-0.2l-0.13,-0.16l-1.37,-0.37l-0.19,0.12l-2.45,-0.67l-1.94,-1.16l-0.16,-0.22l-0.18,-0.5l0.26,-0.49l0.26,-0.23l0.01,0.27l0.04,0.27l1.11,-0.62l0.58,-0.82l1.1,-0.14l0.26,-0.23l0.34,-0.44l0.49,-0.75l0.69,-0.4l0.47,-0.36l0.61,-0.21l0.52,0.35l0.16,0.05l0.95,0.07l0.31,-0.15l0.13,-0.11l0.1,-0.18l-0.93,-0.64l0.09,-0.36l0.12,-0.25l1.09,-0.75l0.83,-0.25l0.45,0.02l1.29,-0.97l0.71,-0.28l1.34,-0.19l1.1,-0.05l0.3,0.35l-0.59,-0.07l-0.26,0.06l0.19,0.12l0.21,0.25l-0.06,0.32l-0.36,0.95l0.03,0.76l-0.24,0.24l-0.23,0.34l1.12,1.08l1.74,0.07l0.95,-0.19l0.55,0.32l0.45,0.07l1.24,-0.16l0.93,0.23l0.39,-0.09l0.86,-1.61l0.34,-0.25l0.37,0.28l0.48,0.23l0.31,-0.16l0.25,0.42l-0.12,-0.87l-0.17,-0.33l-1.41,-0.6l-0.94,0.3l-0.29,-0.34l0.1,-0.67l-1.01,-1.67l-0.42,-0.34l-0.5,-0.02l-0.25,-0.58l-0.21,-0.75l0.43,-0.31l0.39,-0.14l0.36,0.24l0.41,0.99l0.38,0.15l-0.11,0.98l0.47,0.9l1.06,0.83l0.85,-0.31l0.6,0.01l0.36,0.18l0.88,0.75l0.45,0.09l1.39,-0.39l0.02,-0.73l-0.12,-0.53l-0.33,-0.33l-0.94,0.06l-0.73,-0.55l-0.62,0.15l-1.15,0.84l-0.58,-0.33l-0.36,-0.45l-0.58,-0.46l-0.07,-0.87l0.49,-1l0.36,-0.48l-0.32,-0.35l-0.81,-0.25l-1.41,0.25l-0.07,-0.34l0.01,-0.37l-0.58,0.73l-0.59,-0.15l-0.8,0.08l-1.76,-0.64l-0.63,-0.79l-0.26,-0.65l-0.47,-1.78l-0.61,-1.12l-4.19,-3.86l-1.9,-0.98l-0.92,-1.09l-0.57,-0.27l-0.55,-0.11l-0.7,-0.35l0.47,-0.44l0.33,-0.15l-0.34,0.46l0.26,0.11l0.41,-0.26l0.22,-0.31l0.32,-1.34l0.34,-2.04l-0.09,-0.81l2.32,0.16l1.55,-0.14l0.51,-0.18l1.95,-0.31l0.51,-0.23l0.94,-0.7l1.1,-1.24l0.95,-1.64l0.15,-0.44l0.06,0.11l0.09,-0.07l0.1,-0.63l0.12,-1.48l0.47,-1.41l2,-3.25l0.93,-1.3l0.31,-0.59l0.32,-0.43l0.23,0.41l0.11,0.12l0.06,0.19l-0.19,0.09l-0.31,0.42l-0.43,0.28l-0.1,0.14l0.25,-0.03l0.76,-0.31l0.43,-0.37l2.13,-0.69l1.16,-1.14l0.05,-0.26l1.72,-1.44l0.24,0.06l0.27,0.18l-0.47,0.95l0.33,0.25l-0.3,1.13l0.62,0.02l0.14,0.52l0.04,-0.45l-0.01,-0.64l0.05,-0.63l0.09,-0.44l0.44,0.2l0.99,-0.47l-1.19,-0.06l-0.71,-1.03l-0.4,-0.01l1.33,-1.52l1.22,-0.93l0.28,0.02l0.13,0.17l0.03,0.28l-0.26,0.18l-0.26,0.33l0.12,0.29l0.18,0.04l0.58,-0.24l0.26,-0.3l1.25,0.03l0.37,-0.21l0.09,-0.21l1.61,-0.04l0.3,-0.15l1.01,-0.82l0.93,-1l0.43,-0.55l0.74,-1.4l0.63,-0.92l1.04,-0.92l0.25,0.11l-0.34,0.18l-0.23,0.39l0.32,0.52l2.19,1.06l0.55,0.06l0.22,0.63l-0.18,0.61l-0.56,0.68l-1.14,0.69l0.35,0.26l0.23,0.61l0.34,0.07l0.55,-0.23l0.43,-0.37l0.88,-1.23l0.28,-0.69l0.21,-0.17l0.74,0.17l0.42,0.35l0.48,0.63l-0.17,0.6l-0.19,0.34l0.62,0.47l0.69,0.1l0.65,0.38l0.92,-0.77l0.72,-0.16l0.68,0.03l0.88,-0.42l1.49,0.57l0.38,-0.15l0.6,0.1l0.63,0.35l0.22,0.37l-0.68,0.78l-0.11,0.8l0.24,0.33l0.43,0.06l0.05,0.46l0.27,0.12l1.34,-0.03l-0.1,0.22l-0.06,0.27l-0.41,0.59l2.39,0.33l0.32,-0.32l0.49,-0.13l1.05,-0.45l0.4,0.2l0.47,0.46l0.43,0.1l0.4,-0.09l0.94,-0.65l1.08,-0.03l0.44,0.21l0.47,-0.09l1.41,0.75l0.52,0.09l0.69,0.97l0.36,0.03l0.41,-0.41l0.35,0.01l0.35,0.39l0.56,0.12l0.26,0.62l0.28,0.23l2.13,0.46l1.06,-0.21l1.54,0.06l0.74,0.29l0.78,-0.04l1.27,1.06l0.68,0.17l0.13,0.24l1.92,0.26l0.67,-0.55l1.17,-0.15l1.06,-0.47l0.6,0.01l0.7,0.12l0.27,-0.06l0.19,-0.2l1.7,0.8l0.95,0.91l0.42,0.67l1.98,0.96l0.57,0.53l0.39,0.59l0.23,0.06l0.16,-0.17l0.69,0.05L624.48,706.69zM541.12,736.98l-0.13,0.05l0.01,-0.13l0.38,-0.33l0.7,-0.42l-0.02,0.09l-0.37,0.32L541.12,736.98zM523.35,757.25l0.05,0.18l0.35,-0.03l0.49,0.08l0.54,0.18l0.53,-0.06l0.67,-0.56l0.4,-0.15l0.4,-0.08l0.44,0.14l0.43,0.3l0.16,0.18l0.13,0.31l0.09,0.37l0.13,0.26l0.8,0.32l0.51,0.13l0.12,0.18l0.11,0.25l0.42,0.19l0.44,-0.07l0.25,0.07l0.75,0.01l0.93,0.27l-0.15,0.71l-0.3,0.31l-0.85,-0.1l-0.85,0.1l-0.35,0.37l-0.29,0.46l-0.04,0.45l-0.17,0.21l-0.18,0.09l-0.14,-0.25l-0.19,-0.76l-0.13,-0.21l-0.15,-0.13l-0.41,-0.24l-0.42,-0.15l-0.25,-0.02l-0.18,-0.26l-0.1,-0.38l-0.17,-0.2l-0.33,-0.28l-0.34,-0.22l-1.07,-0.48l-0.35,-0.06l-0.36,0.05l-0.38,0.22l-0.37,0.33l-0.38,0.24l-0.39,0.05l-0.37,-0.14l-0.35,-0.32l-0.18,-0.23l-0.09,-0.39l0.01,-0.39l0.05,-0.38l0.19,-0.92l0.33,-0.18L523.35,757.25zM601.48,777.29l-0.42,0.06l-0.19,-0.09l-0.03,-0.09l0.08,-0.34l-0.01,-0.15l0.21,-0.05l0.24,0.16l0.07,0.17L601.48,777.29zM519.1,779.78l0.72,0.44l0.46,-0.05l0.37,0.37l0.15,0.3l-0.55,-0.21l-0.79,0.02l-1.07,-0.9l-0.38,-0.2l0.09,-0.51l0.41,-0.26l0.21,0.68L519.1,779.78zM587.9,780.42l-0.16,0.02l0.21,-0.33l0.15,-0.65l0.2,0.09l0.04,0.12l-0.33,0.66L587.9,780.42zM602.38,779.83l0,0.18l-0.1,0.17l0.1,0.31l-0.17,0.53l-0.07,0.34l-0.09,0.21l-0.09,0.08l-0.09,-0.05l-0.02,-0.12l0.06,-0.19l-0.22,0.01l-0.07,-0.47l0.12,-0.15l0.04,-0.2l0.01,-0.13l0.14,-0.59l0.05,-0.04l0.02,0.14l0.05,0.04l0.08,-0.06l0.11,-0.26l0.05,-0.03L602.38,779.83zM606.58,779.83l0.07,0.19l0.64,-0.04l0.18,0.03l0.07,0.09l-0.09,0.13l-0.25,0.17l-0.72,0.29l-0.58,0.38l-0.08,-0.04l-0.11,-0.41l-0.11,-0.17l-0.07,-0.23l0,-0.09l0.11,-0.16l0.21,-0.23l0.15,-0.09L606.58,779.83zM610.81,780.59l-0.11,0.16l-0.29,-0.06l-0.15,-0.1l0.52,-0.43l0.09,0.09L610.81,780.59zM541.04,780.27l0.31,0.33l0.16,0.02l0.51,-0.1l0.19,0.07l0.18,0.14l0.11,0.22l0.02,0.38l-0.08,0.34l0.03,0.48l-0.02,0.21l0.27,0.27l0.09,0.37l0.04,0.4l-0.59,0.13l-0.59,0.02l-0.51,0.27l-0.1,0.2l0.08,0.29l-0.14,0.07l-0.13,-0.06l-0.25,-0.27l-0.27,-0.13l-0.94,-0.2l-1.19,-0.79l-0.51,-0.16l-0.52,-0.58l-0.47,-0.74l0.31,-0.12l0.31,-0.06l1.38,0.11l0.17,-0.53l0.18,-0.13l0.44,-0.15l0.41,-0.29l0.18,0.01l0.19,0.11l0.39,-0.18l0.21,-0.04L541.04,780.27zM602.12,784.07l-0.37,0.1l-0.09,-0.19l0.19,-0.49l0.15,-0.28l0.11,-0.06l0.42,-0.55l0.47,-0.4l0.43,-0.59l0.44,-0.84l0.08,-0.31l0.2,-0.03l0.33,0.21l0.21,0.29l-0.1,0.23l-1.1,1.19l-0.09,0.16l-0.1,0.4l-0.09,0.14l-0.14,0.06l-0.11,0.18l-0.06,0.29l-0.14,0.15l-0.2,0.01l-0.14,0.08l-0.08,0.15L602.12,784.07zM601.17,782.4l-0.17,0.2l-0.66,-0.12l0.14,-0.4l0.5,-0.25l0.55,0.4L601.17,782.4zM612.65,784.03l-0.16,0.04l0.24,-0.43l0.32,-0.48l0.3,-0.3l0.39,-0.13l-0.04,0.22l-0.51,0.4L612.65,784.03zM558.36,792.07l-0.24,0.1l-0.26,-0.05l-0.2,-0.63l0.16,-0.02l0.33,-0.41l0.72,-0.34l0.18,-0.04L558.36,792.07zM586.35,792.65l-0.1,0.04l-0.24,-0.19l-0.16,-0.21l0.11,-0.16l0.47,-0.33l0.23,-0.01l0.09,0.05l0.04,0.1l-0.02,0.15l-0.1,0.19L586.35,792.65zM586.58,793.44l0.12,0.05l0.13,-0.38l0.09,-0.01l0.39,0.32l0.24,-0.07l0.16,0.39l0.14,0.04l0.13,-0.05l0.08,0.03l-0.03,0.41l-0.29,0.42l-0.13,0.11l-0.19,-0.11l-0.07,-0.04l-0.12,-0.18l-0.09,-0.23l-0.06,0l-0.22,0.28l0.01,0.14l0.09,0.2l-0.01,0.13l-0.24,0.06l-0.23,-0.03l-0.29,0.18l-0.07,-0.11l-0.04,-0.31l-0.09,0.04l-0.13,0.38l-0.15,0.24l-0.27,0.2l-0.06,0.1l-0.2,0.02l-0.29,0.13l-0.18,-0.02l-1.07,-0.41l-0.25,-0.15l0.88,-0.95l0.46,-0.37l0.27,0.02l0.27,0.12l0.14,-0.02l0.01,-0.42l-0.25,-0.31l0.01,-0.13l0.55,-0.22l0.21,0.03l0.23,0.11l0.22,0.18L586.58,793.44zM645.47,794.69l0.84,0.14l0.62,-0.03l0.56,0.94l0.35,0.75l0.2,0.53l0.12,0.51l0.15,0.49l-0.01,0.07l-0.33,-0.33l-0.23,-0.67l-0.12,-0.26l-0.12,-0.12l-0.12,-0.25l-0.24,-0.64l-0.01,-0.18l-0.11,-0.17l-0.12,-0.07l-0.14,0.03l-0.05,0.07l0.02,0.44l0.11,0.49l0.61,1.07l0.41,0.61l0.08,0.2l0.05,0.55l-0.17,0.25l0.22,0.51l-0.01,0.1l-0.05,0.1l-0.58,0.23l-0.53,0.94l-0.58,0.55l-0.27,0.09l-0.13,-0.09l-0.12,-0.21l-0.07,-0.28l-0.02,-0.35l0.14,-0.22l0.29,-1.16l0.01,-0.38l-0.36,-0.53l-0.22,-0.44l-0.12,-0.61l-0.19,-1.61l-0.09,-0.52L645,794.78l-0.16,-0.35l-0.12,-0.38l-0.08,-0.42l0.03,-0.16l0.29,0.22l0.35,0.6L645.47,794.69zM646.69,794.27l-0.02,0.16l-0.45,-0.01l-0.46,-0.23l-0.22,-0.3l0.05,-0.13l0.43,-0.13l0.4,0.29L646.69,794.27zM641.98,794.17l0.48,0.61l0,0.14l-0.1,0.42l-0.26,0.12l0.07,0.17l0.19,0.13l0.14,-0.1l0.5,-0.59l0.15,-0.12l0.09,-0.01l0.61,0.18l0.53,0.28l0.16,0.23l0.09,0.39l-0.14,0.85l-0.44,0.15l-0.21,-0.01l-0.22,-0.12l-0.36,0.29l0.3,0.23l0.9,0.05l0.27,0.47l0.08,0.36l-0.19,0.67l-0.51,-0.18l-0.45,-0.39l-0.92,-0.55l-0.22,-0.02l-0.15,0.1l-0.04,0.33l0.01,0.72l-0.25,0.37l-0.73,-0.16l-0.28,-0.54l-0.27,-0.86l-1,-1.03l-0.27,-0.21l-0.36,-0.62l0.14,-0.49l0.04,-0.28l0.19,-0.07l0.28,-0.22l0.16,-0.48l0.25,0.39l0.34,0.37l0,-0.35l0.16,-0.28l0.33,0.01l0.16,-0.06l0.22,-0.26l0.31,-0.13L641.98,794.17zM584.98,796.8l0.02,0.34l0.14,-0.04l0.51,-0.35l0.27,-0.1l0.35,-0.02l0.28,0.16l0.06,0.12l-0.02,0.15l-0.22,0.3l0.01,0.19l0.24,0.35l0.58,0.19l0.07,0.11l0,0.13l-0.4,0.59l-0.15,0.14l-0.1,0.03l-0.73,-0.1l-0.66,-0.19l-0.27,-0.03l-0.09,0.06l-0.19,0.18l0.14,0.05l0.58,0.04l0.21,0.26l0.09,0.19l0.05,0.21l-0.12,0.09l-0.25,0.06l-0.3,0l-0.37,0.24l-0.2,0.27l-0.74,0.07l-0.56,0.36l-0.2,0.18l-0.07,0.21l-0.21,0.16l-0.48,0.15l0.29,0.14l0.05,0.12l0.01,0.16l-0.04,0.14l-0.38,0.62l-0.71,0.51l-0.18,-0.02l-0.08,-0.06l-0.06,-0.1l0,-0.1l0.92,-1.02l-0.04,-0.05l-0.25,-0.04l-0.4,-0.28l-0.28,0.18l-0.06,-0.01l0.08,-0.24l0.18,-0.29l-0.03,-0.08l-0.1,-0.07l-0.23,-0.04L580.52,801l-0.27,0.07l-0.17,0.15l-0.01,0.06l0.37,-0.02l0.1,0.08l0.1,0.14l0.06,0.17l0.02,0.19l-0.08,0.25l-0.18,0.32l-0.26,-0.06l-0.53,-0.7l-0.23,-1.03l-0.45,-0.79l-0.02,-0.19l0.13,-0.49l0.46,-0.7l0.49,-0.19l0.35,-0.29l0.34,-0.09l0.21,0.01l0.29,0.13l0.12,0.27l-0.07,0.13l0.03,0.07l0.2,0.16l0.22,0.56l0.25,0.5l0.17,0.2l0.22,0.12l-0.23,-0.38l-0.14,-0.47l-0.07,-0.94l-0.07,-0.25l0.13,-0.07l0.36,0.04l-0.01,-0.14l-0.38,-0.32l-0.24,-0.26l-0.09,-0.21l0.01,-0.18l0.21,-0.27l0.12,-0.08l0.12,-0.03l0.24,0.06l0.11,0.08l0.31,0.6l0.15,0.19h0.12l0.11,-0.1l0.1,-0.2l0.11,-0.12l0.11,-0.04l0.35,0.09l0.12,-0.03l0.06,-0.15l0,-0.27l0.09,-0.1l0.02,-0.2l-0.19,-0.29l0.22,-0.09l0.72,0.23l0.31,0.25L584.98,796.8zM583.85,796.64l-0.09,0.17l-0.09,-0.04l-0.19,-0.2l-0.38,-0.29l-0.17,-0.2l-0.01,-0.09l0.13,-0.1l0.45,0.24l0.19,0.22L583.85,796.64zM644.5,799.72l0.28,0.67l0.21,0.52l0.18,0.63l0.31,1.29l0.14,0.48l0.04,0.27l0.03,0.69l-0.05,0.15l-0.09,0.14l-0.02,0.2l0.08,0.53l0.01,0.8l-0.08,0.45l-0.09,0.07l-0.23,-0.15l-0.19,-0.24l-0.14,-0.25l-0.34,-0.8l-0.1,-0.37l-0.01,-0.27l0.05,-0.2l0.11,-0.12l0.19,-0.33l-0.03,-0.05l-0.15,0.07l-0.3,0.04l-0.26,-0.26l-0.2,-0.14l0.04,-0.46l-0.05,-0.13l-0.4,0.14l-0.15,-0.13l-0.03,-0.17l0.01,-0.26l0.08,-0.23l0.38,-0.58l-0.04,-0.11l-0.19,-0.02l-0.24,-0.2l-0.11,-0.65l-0.26,-0.37l-0.15,0.03l-0.35,1.05l-0.18,0.23l-0.5,0.15l0.1,-0.29l0.05,-0.26l-0.18,-0.79l0,-0.31l0.12,-0.23l0.35,-0.09l0.19,-0.13l0.15,-0.22l0.04,-0.21l0.27,-0.56l0.13,-0.11l0.34,0.01l0.72,0.63l0.22,0.09L644.5,799.72zM527.67,800.75l-0.34,0.29l-0.31,-0.11l-0.09,-0.21l0,-0.09l0.9,-0.24L527.67,800.75zM584.62,801.11l-0.42,0.2l-0.07,-0.01l-0.26,0.4l-0.2,0.17l-0.26,-0.31l0.07,-0.49l0.23,-0.32l1.16,0.11l0.09,0.09l0,0.08l-0.08,0.06L584.62,801.11zM649.83,801.85l0.22,0.19l0.12,-0.2l0.23,0.01l0.42,0.18l0.25,0.27l0.14,0.3l0.01,0.18l-0.04,0.41l0.03,0.42l-0.02,0.22l-0.06,0.18l-0.09,0.14l-0.1,0.02l-0.32,-0.38l-0.37,-0.68l-0.28,-0.21l-0.01,0.07l0.08,0.2l0.23,0.37l0.04,0.22l0.16,0.27l0.07,0.2l0.04,0.27l0,0.23l-0.04,0.2l-0.07,0.13l-0.1,0.06l-0.56,-0.06l-0.34,0.13l-0.39,-0.07l-0.09,-0.12l-0.06,-0.2l-0.03,-0.48l-0.1,-0.69l0.02,-0.53l-0.25,-0.48l-0.22,-0.29l-0.31,-0.26l-0.21,-0.26l0.06,-0.2l0.32,-0.15l0.53,0.04L649.83,801.85zM647.76,802.81l0.22,0.42l0.31,-0.03l0.18,0.32l0.13,0.47l-0.1,0.3l-0.14,-0.07l-0.15,0.18l-0.09,0.58l0.04,0.58l-0.05,0.58l-0.18,0.59l-0.04,0.39l-0.07,0.12l-0.08,0.04l-0.1,-0.11l-0.14,-0.08l-0.18,0.33l-0.22,0l-0.18,-0.75l0.16,-1.26l0.37,-0.26l-0.22,-0.34l-0.46,-0.4l0.04,-0.22l-0.35,-0.64l-0.02,-0.15l0.06,-0.54l0.33,-0.48l0.44,-0.09l0.3,0.21l0.17,0.18L647.76,802.81zM651.88,804.74l-0.04,0.09l-0.42,-0.01l-0.15,-0.07l-0.06,-0.26l0.04,-0.24l0.1,-0.18l0.12,-0.35l0.09,-0.59l0.62,0.67l0.19,0.3l0.1,0.36l-0.22,0.14l-0.27,0.07L651.88,804.74zM529.02,804.08l0.44,0.12l0.24,-0.08l0.22,0.06l0.04,0.14l-0.37,0.31l-0.15,-0.02l-0.44,-0.37L529.02,804.08zM580.63,804.8l-0.16,0.01l-0.25,-0.16l0.03,-0.19l0.35,-0.23l0.35,0.04l0.03,0.13l-0.02,0.14l-0.03,0.08l-0.11,0.09L580.63,804.8zM579.06,805.28l-0.23,0.14l-0.07,-0.05l-0.01,-0.12l0.05,-0.19l0.11,-0.19l0.35,-0.35l0.35,-0.24l0.18,0.02l0.06,0.15l-0.22,0.31L579.06,805.28zM653.99,807.23l-0.07,0.98l-0.13,-0.06l-0.12,0l-0.26,0.14l-0.27,-0.06l-0.13,-0.11l-0.05,-0.13l0.05,-0.29l-0.15,-0.16l-0.5,-0.06l-0.19,-0.07l-0.1,-0.31l-0.02,-0.4l0.08,-0.15l0.26,-0.11l0.2,-0.49l0.11,-0.07l0.42,-0.98l0.21,0.07l0.37,0.6l0.46,0.86L653.99,807.23zM651.77,806.41l-0.17,0.02l-0.2,-0.09l-0.48,-0.49l-0.01,-0.14l0.07,-0.16l0.27,-0.3l0.11,-0.07l0.65,0.03l0.21,0.08l0.05,0.14l-0.01,0.14l-0.07,0.14l-0.02,0.15l0.04,0.16l-0.08,0.15L651.77,806.41zM649.16,805.86l0.63,0.13l0.58,-0.01l0.2,0.25l0.13,0.26l0.08,0.24l0.02,0.23l-0.02,0.16l-0.07,0.17l0.02,0.06l1.13,0.56l0.53,0.59l0.21,0.31l0.12,0.26l0.22,0.65l0.47,0.76l0.25,0.23l0.14,0.22l-0.08,0.01l-0.33,-0.17l-0.72,-0.51l-0.06,0.02l-0.06,0.27l-0.11,0.24l-0.16,0.17l0.13,0.05l0.58,-0.11l0.48,0.49l0.19,0.09l0.18,0.35l0.01,0.14l-0.11,0.26l-0.08,0.11l0.03,0.07l0.14,0.04l0.54,-0.07l0.1,0.13l-0.08,1.01l0.08,0.37l0,0.17l-0.06,0.22l0,0.19l0.05,0.19l0.01,0.17l-0.14,0.45l-0.14,0.08l-0.23,0l-0.18,-0.13l-0.25,-0.39l-0.25,-0.6l-0.1,-0.09l-0.33,-0.09l-0.06,-0.07l-0.21,-0.01l-0.15,-0.25l0.02,-0.33l-0.13,-0.33l0.02,-0.15l-0.14,-0.06l-0.12,0.09l0.06,0.33l-0.07,0.25l-0.26,-0.11l-0.43,-0.81l-0.49,-0.65l-0.19,-0.16l0.05,-0.19l0.24,-0.1l0.2,0.01l0.04,-0.11l-0.41,-0.63l0.01,-0.18l0.15,-0.32l-0.19,-0.13l-0.51,0.1l-0.18,-0.07l-0.15,-0.26l-0.09,-0.22l-0.44,-0.04l-0.17,0.03l-0.29,-0.34l-0.13,-0.21l0.05,-0.11l0.27,-0.19l0.16,0.03l0.3,0.21l0.12,-0.01l0.3,-0.27l0.05,-0.25l0.22,-0.2l-0.04,-0.21l-0.12,-0.36l-0.27,-0.1l-0.56,0.22l-0.48,0.33l-0.19,-0.13l-0.04,-0.2l0.52,-0.56l0.23,-0.31l-0.04,-0.18l-0.17,-0.24l-0.01,-0.6L649.16,805.86zM657.75,810.88l-0.11,0.64l-0.23,0.66l-0.35,0.35l-0.25,-0.08l-0.18,-0.28l-0.17,0.02l-0.18,-0.06l-0.1,-0.23l0.09,-0.3l-0.08,-0.23l-0.09,0.21l-0.16,0.19l-0.4,0.25l-0.27,0.47l-0.13,0.31l-0.16,-0.33l-0.1,-0.79l-0.01,-0.34l0.29,-0.51l0.37,-0.48l0.08,-1.45l1.18,-0.73l0.11,0.04l0.38,0.55l0.41,0.76l0.11,0.34l0,0.6L657.75,810.88zM576.13,808.93l-0.13,0.19l-0.25,-0.01l-0.14,-0.06l-0.05,-0.16l0.39,-0.49l0.09,-0.07l0.07,0.02l0.03,0.2L576.13,808.93zM650.03,810.56l0.07,0.17l0.01,0.1l-0.48,0.39l-0.01,0.08l-0.11,0.24l-0.1,0.09l-0.18,0.26l-0.34,0.28l0.05,-0.84l-0.34,-0.49l0.34,-0.25l0.22,0.07l0.37,0.03l0.36,-0.21L650.03,810.56zM559.13,811.9l0.05,0l0.1,-0.04l0.22,-0.33l0.07,-0.01l0,0.1l-0.1,0.32l0.17,0.43l0.16,0.21l-0.02,0.07l-0.4,0.15l-0.31,-0.11l-0.16,0.04l-0.15,0.15l-0.1,-0.17l-0.07,-0.8l0.02,-0.14l0.17,-0.28l0.22,-0.13l0.09,0.04l0.08,0.11l0.02,0.12L559.13,811.9zM560.31,811.77l-0.05,0.46l-0.46,-0.29l-0.12,-0.14l0.08,-0.11l0.43,-0.03L560.31,811.77zM651.5,814.33l0.08,0.08l0.08,-0.05l0.14,-0.2l0.24,0.04l0.17,0.07l0.1,0.08l-0.06,0.3l-0.04,0.49l-0.1,0.17l-0.1,0.24l-0.34,-0.14l-0.27,-0.31l-0.4,-0.53l-0.22,-0.38l-0.02,-0.16l-0.14,-0.12l-0.27,-0.66l-0.15,-0.52l-0.24,-0.06l-0.31,-0.15l-0.12,-0.29l0.08,-0.25l0.44,-0.13l0.66,0.65l0.1,0.28l0.24,0.32l0.05,0.45l0.12,0.18L651.5,814.33zM561.83,812.98l-0.2,0.13l-0.06,0.16l-0.15,0.07l-0.13,0.13l-0.44,0.59l-0.19,0.11l0.21,-0.51l0.03,-0.16l0,-0.11l-0.06,-0.38l0.13,0.02l0.11,-0.08l0.21,-0.34l0.19,-0.03l0.2,-0.4l0.11,-0.03l0.05,0.06l-0.09,0.25l0.2,0.23l-0.05,0.22L561.83,812.98zM656.56,813.26l0.34,0.75l0.02,0.26l-0.32,0.09l-0.25,-0.04l-0.13,-0.09l-0.03,-0.12l0.08,-0.38l-0.17,-0.22l-0.19,-0.08l-0.17,0.13l-0.01,-0.38l0.13,-0.27l-0.07,-0.37l0,-0.28l0.04,-0.09l0.18,0.01l0.36,0.29L656.56,813.26zM563.02,812.85l-0.02,0.46l-0.05,0.07l-0.09,-0.12l-0.19,0.14l-0.1,-0.1l0.04,-0.16l-0.01,-0.13l0.14,-0.01l0.03,-0.23l-0.02,-0.1l0.07,-0.21l0.1,-0.05L563.02,812.85zM563.52,813.88l-0.11,0.03l-0.09,-0.06l-0.12,-0.33l-0.01,-0.14l0.24,0.1l0.09,0.24L563.52,813.88zM549.87,813.84l0.32,0.95l0.14,0.19l0.21,0.1l0.29,0.1l0.17,0.14l0.15,0.21l0.02,0.1l-0.91,-0.38l-0.57,0.56l-0.17,0.07l-1.63,0.03l-0.32,0.1l-0.21,0.18l-0.37,0.51l-0.19,0.2l-0.2,0.12l-0.42,0.13l-0.51,-0.02l-0.26,-0.06l-0.14,-0.24l-0.12,-0.48l0,-0.13l0.05,-0.23l0.45,-0.31l0.15,-0.17l0.59,-1.08l0.17,-0.15l0.18,-0.04l0.5,0.08l0.43,-0.32l0.92,-0.48l0.2,-0.06l0.66,-0.01l0.18,0.08l0.14,0.14L549.87,813.84zM553.78,814.61l-0.08,0.03l-0.23,-0.18l-0.08,-0.13l-0.06,-0.21l0.47,-0.3l0.1,0l0.09,0.17l0.02,0.13l-0.13,0.37L553.78,814.61zM552.93,817.16l-0.29,0.12l-0.31,-0.13l-0.26,-0.24l-0.03,-0.29l0.58,0.19l0.13,0.09L552.93,817.16zM542.94,818.66l-0.14,0.04l-0.04,-0.06l-0.02,-0.25l-0.11,-0.4l0.21,-0.14l0.13,-0.03l0.06,0.06l0.15,0.29l0.15,0.08l0.11,0.06l-0.2,0.09L542.94,818.66zM542.01,819.03l-0.12,0.1l-0.1,0.02l-0.08,-0.06l-0.34,0.07l-0.07,-0.04l-0.15,-0.34l-0.01,-0.17l0.06,-0.14l0.15,-0.12l0.25,-0.11l0.24,0.02l0.43,0.31l0.2,0.18l0.04,0.11l-0.15,0.11L542.01,819.03zM539.44,819.99l0.14,0.27l0.25,-0.17l0.18,-0.23l0.14,-0.3l0.09,-0.12l0.12,0.16l0.35,0.22l-0.29,0.33l-0.56,0.5l-0.19,0.33l-0.01,0.14l0.55,-0.11l0.15,0.02l0.1,0.11l-0.15,0.13l-0.3,0.12l-0.26,0.24l-0.6,0.41l-0.23,0.34l-0.27,0.13l-0.36,0.03l-0.64,0.22l-0.39,0.21l-0.1,0.11l-0.12,0.05l-0.15,-0.01l-0.16,0.09l-0.17,0.19l-0.14,0.09l-0.23,0.02l-0.12,0.07l-0.14,0l-0.37,-0.22l-0.09,-0.13l0.33,-0.26l0.24,-0.09l0.36,-0.04l0.35,-0.24l0.73,-0.32l0.23,-0.17l0.15,-0.61l0.17,-0.1l0.09,-0.24l0.4,0.01l0.19,0.27l0.07,0.04l0.03,-0.03l0.02,-0.22l0.21,-0.15l-0.12,-0.11l-0.37,-0.14l-0.28,-0.07l-0.18,0.01l-0.15,-0.08l-0.11,-0.17l-0.05,-0.17l0.01,-0.17l0.09,-0.19l0.17,-0.21l0.2,-0.12l0.43,-0.08l0.38,-0.14l0.2,-0.02l0.15,0.06L539.44,819.99zM540.79,820.98l-0.05,0.02l-0.08,-0.14l0,-0.13l0.06,-0.09l0.16,-0.21l0.11,-0.08l0.14,-0.04l0.04,0.06l-0.12,0.26l-0.15,0.17L540.79,820.98zM534.97,823.09l-1.02,0.59l-0.33,0.43l-0.25,0.42l-0.2,0.23l-0.14,0.04l-0.16,0.11l-0.34,0.29l-0.14,0.04l-1.08,0.68l-0.08,0.01l0.05,-0.18l0.33,-0.25l0.22,-0.23l0.24,-0.38l0.13,-0.14l0.04,-0.19l0.02,-0.38l0.06,-0.14l0.23,-0.29l0.17,-0.16l0.22,-0.05l0.45,0.05l0.19,-0.15l0.06,-0.11l-0.11,-0.1l-0.03,-0.18l0.03,-0.31l0.13,-0.27l0.23,-0.24l0.31,-0.18l0.4,-0.13l0.29,-0.01l0.52,0.28l0.08,0.13l-0.13,0.28l-0.07,0.26L534.97,823.09zM529.23,825.84l-0.05,0.22l-0.05,0.08l-0.51,-0.12l-0.34,0.04l-0.04,-0.13l0.03,-0.12l0.54,-0.18l0.22,0l0.15,0.09L529.23,825.84zM525.77,827.29l-0.21,0.17l-0.06,-0.06l-0.04,-0.21l0.12,-0.17l0.36,-0.36l0.25,0.07l0.08,0.1l-0.01,0.14l-0.09,0.18l-0.12,0.09l-0.14,0L525.77,827.29zM512.68,830.25l-1.78,0.22l-0.27,-0.15l0.27,-0.09l0.32,-0.05l0.67,-0.25l0.82,-0.22l0.64,-0.26l0.56,-0.17l0.16,-0.29l-0.49,-0.15l-0.1,-0.11l0.23,-0.13l0.2,-0.19l0.46,-0.23l0.41,0.29l0.09,0.19l-0.04,0.23l-0.08,0.24l-0.36,0.12l-0.05,0.13l0.2,0.35l-0.74,0.31L512.68,830.25zM520.02,828.97l-0.25,0.08l-0.27,-0.08l0.13,-0.29l0.13,-0.15l0.24,-0.19l0.29,0.08l0.23,0.24L520.02,828.97zM516.41,829.7l0.65,0.22l0.81,-0.02l0.3,0.05l0,0.06l-0.52,0.09l-0.18,-0.03l-0.45,0.12l-0.31,0.02l-0.7,-0.11l-0.54,0.08l-0.14,-0.03l-0.17,-0.1l-0.2,-0.17l-0.01,-0.11l0.18,-0.04l0.48,0.14l0.05,-0.07l0.41,-0.14L516.41,829.7zM508.22,830.43l-0.08,0.16l-0.32,-0.17l-0.11,-0.14l-0.02,-0.14l0.1,-0.23l0.26,0l0.15,0.1l0.14,0.18l0.04,0.11L508.22,830.43zM506.32,831.15l0.02,0.18l0.38,-0.02l0.12,0.09l0,0.35l-0.05,0.1l-0.06,0.02l-0.14,-0.08l-0.15,0.18l-0.71,0.44l-0.22,-0.24l-0.41,0.39l-0.06,-0.07l0.35,-0.92l0.34,-0.15l0.12,-0.11l-0.03,-0.29l0.16,-0.49l0.34,0.02l0.16,0.2l0,0.13L506.32,831.15zM504.48,831.96l-0.1,0.07l-0.17,0.06l-0.51,-0.06l-0.31,0.02l-0.34,0.04l-0.26,0.1l-0.05,-0.13l0.01,-0.11l1.11,-0.29l0.26,-0.15l0.16,-0.19l0.14,-0.36l0.12,-0.11l0.07,0.01l0.16,0.14l-0.05,0.19l-0.14,0.17l-0.04,0.15L504.48,831.96zM502.05,832.31l-0.07,0.18l-0.08,0l-0.44,-0.29l-0.06,-0.1l0.26,-0.14l0.08,-0.11l-0.03,-0.14l-0.19,-0.2l-0.36,-0.25l-0.14,-0.18l0.09,-0.11l0.17,-0.07l0.54,-0.01l0.29,0.31l0.22,0.11l0.52,0.07l-0.27,0.13l-0.15,0.13l-0.19,0.49L502.05,832.31zM508.26,831.44l-0.28,0.12l-0.37,-0.24l0.04,-0.28l0.41,0.23L508.26,831.44zM507.34,831.55l-0.21,0.31l-0.15,-0.14l-0.06,-0.43l0.12,-0.11l0.33,0.31L507.34,831.55z" data-jurisdiction="AK" id="AK" title="Alaska"></path>
<path class="land" d="M871.42,622.65l0.25,1.46l0.25,1.46l0.25,1.46l0.25,1.45l0.25,1.45l0.25,1.45l0.25,1.45l0.25,1.45l0.25,1.44l0.25,1.44l0.25,1.44l0.25,1.44l0.25,1.43l0.25,1.43l0.25,1.43l0.25,1.43l0.23,0.65l0.19,1.05l1.33,3.1l0.39,1.3l-0.11,0.54l0.17,0.46l0.44,0.38l-0.08,0.44l-0.6,0.5l-0.39,0.6l-0.28,1.07l0,0.01l-0.56,1.88l-0.01,1.14l0.54,1.56l0,0l0.11,0.69l-0.35,3.04l0.24,1.95l0.57,1.27l-3.04,0.01l-3.04,0l-3.04,0h-3.04l-3.04,0h-3.04l-3.04,0h-3.04l-0.13,0.78l0.06,0.75l0.33,0.71l1.36,1.35l0.13,0.33l-0.24,1.04l0.04,0.74l-0.15,0.38l-0.33,0.34l-0.09,0.37l-0.22,0.1l-1.03,1.12l-3.61,0.37l0.2,-0.25l0.76,-0.05l1.07,-0.35l-0.22,-0.6l-0.41,-0.66l-0.38,-0.07l-0.25,-0.39l0.01,-1.22l-0.24,-0.71l-0.59,-0.73l-0.2,0.14l-0.43,1.25l-0.36,1.64l-0.18,0.53l-1.07,0.04l-0.95,-0.11l-0.47,0.03l-0.12,-2.24l-0.1,-2.04l-0.1,-2.05l-0.1,-2.05l-0.1,-2.06l-0.1,-2.06l-0.1,-2.06l-0.1,-2.07l0.23,-2.04l0.23,-2.04l0.23,-2.05l0.23,-2.05l0.23,-2.06l0.23,-2.06l0.23,-2.07l0.23,-2.07l0.23,-2.07l0.23,-2.08l0.23,-2.08l0.23,-2.09l0.23,-2.09l0.23,-2.1l0.23,-2.1l0.23,-2.11l0.06,-0.53l0.01,-0.18l0.03,-0.27l-0.83,-0.75l-0.16,-0.15l-0.12,-0.14l0.12,-0.01l1.51,0.02l1.51,0.02l1.51,0.02l1.51,0.02l1.51,0.02l1.51,0.02l1.51,0.02l1.51,0.02l1.51,0.02l1.51,0.02l1.51,0.02l1.51,0.02l1.51,0.02l1.51,0.02l1.51,0.02L871.42,622.65zM848.38,675.5l-0.83,0.23l-1.23,-0.02l-0.25,-0.08l0.49,-0.15l1.46,-0.21L848.38,675.5z" data-jurisdiction="AL" id="AL" title="Alabama"></path>
<path class="land" d="M833,611.13L832.96,611.34L833.15,611.8L833.15,612.06L833.01,612.22L832.69,612.32L832.45,612.43L832.4,612.63L832.39,612.72L832.41,612.94L832.45,613.14L832.3,613.39L831.22,614.03L830.75,614.85L830.91,615.86L830.53,616.88L829.6,617.91L829.21,619.05L829.35,620.32L828.88,621.35L827.81,622.13L827.46,622.61L827.46,622.64L827.46,623L827.57,623.28L827.21,623.81L826.31,624.35L825.82,624.88L825.75,625.4L825.54,625.65L825.15,625.76L824.92,626.52L824.73,628.32L824.24,629.34L823.46,629.59L823.05,629.99L822.99,630.54L822.53,631.17L821.66,631.89L821.37,632.57L821.67,633.22L821.61,633.48L821.35,633.69L820.4,634L820.24,634.15L820.15,634.32L820.34,634.65L820.45,635.14L820.31,635.97L820.08,636.32L819.86,636.65L819.08,637.24L818.86,637.69L819.21,638L819.18,638.35L818.79,638.73L818.9,639.13L818.99,639.41L819.36,639.66L819.48,640.35L819.22,641.24L819.27,641.97L819.71,642.57L819.8,642.83L819.37,644.81L819.4,645.09L817.55,645.09L815.86,645.1L814.17,645.1L812.48,645.1L810.78,645.1L809.09,645.11L807.4,645.11L805.71,645.11L804.02,645.11L802.33,645.12L800.64,645.12L798.94,645.12L797.25,645.12L795.56,645.13L793.87,645.13L792.18,645.13L792.17,643.61L792.15,642.1L792.14,640.57L792.12,639.05L791.64,638.79L790.77,638.66L790.32,638.75L789.79,638.68L789.44,638.93L789.2,638.98L789.01,638.92L788.9,638.7L788.5,638.54L788.01,637.99L788.04,636.77L788.06,635.54L788.09,634.32L788.12,633.09L788.14,631.86L788.17,630.63L788.2,629.39L788.22,628.16L788.25,626.92L788.28,625.68L788.3,624.44L788.33,623.2L788.36,621.96L788.38,620.71L788.41,619.46L788.44,618.22L788.22,616.61L788.01,615.01L787.8,613.4L787.59,611.79L787.38,610.18L787.17,608.56L786.96,606.95L786.75,605.32L789.37,605.32L791.99,605.32L794.61,605.32L797.23,605.32L799.86,605.32L802.48,605.32L805.1,605.32L807.72,605.32L810.34,605.32L812.97,605.32L815.59,605.32L818.21,605.32L820.83,605.32L823.45,605.32L826.07,605.32L828.7,605.32L829.11,606.24L829.52,606.83L829.59,607.26L829.51,607.7L828.82,608.64L828.19,609.08L827.85,609.55L827.37,609.99L826.64,611.23L828.18,611.2L829.73,611.18L831.28,611.15z" data-jurisdiction="AR" id="AR" title="Arkansas"></path>
<path class="land" d="M650.93,599.48L650.93,603.63L650.92,607.76L650.92,611.87L650.92,615.97L650.92,620.04L650.92,624.1L650.92,628.14L650.92,632.16L650.92,636.17L650.92,640.16L650.92,644.13L650.92,648.09L650.92,652.03L650.92,655.96L650.92,659.87L650.92,663.77L648.78,663.77L645.45,663.78L642.12,663.79L638.8,663.8L635.47,663.8L632.14,663.81L627.68,662.19L623.21,660.56L618.75,658.93L614.29,657.3L609.82,655.66L605.36,654.02L600.89,652.38L596.43,650.74L596.88,650.11L597.48,648.44L597.51,648.34L597.51,648.34L598.82,648.22L599.44,647.8L599.8,647.03L599.88,646.24L599.68,645.45L599.12,644.85L598.2,644.46L597.67,643.37L597.53,641.56L597.69,640.59L598.17,640.44L598.63,640L599.06,639.26L599.39,638.45L599.6,637.57L599.64,636.46L599.51,635.11L600.36,633.45L601.2,632.42L602.76,631.16L603.12,630.78L603.12,630.47L603.12,630.44L602.8,630L601.4,629.12L600.8,628.49L600.75,627.91L600.73,627.9L600.55,627.34L599.05,625L598.55,623.72L598.55,622.76L598.55,622.68L598.73,618.61L598.19,617.2L598.07,616.4L598.22,615.42L598.18,614.8L597.92,614.27L597.86,613.3L597.83,612.1L597.4,611.33L597.32,610.99L597.56,610.16L598,609.73L598.72,609.43L599.54,609.33L600.48,609.42L601.18,609.8L601.65,610.45L602.11,610.78L602.57,610.79L603.17,610.26L603.72,609.11L603.89,609.04L603.91,604.02L603.92,599.44L606.86,599.44L609.79,599.44L612.73,599.44L615.67,599.45L618.61,599.45L621.55,599.45L624.48,599.45L627.42,599.46L630.36,599.46L633.3,599.46L636.24,599.46L639.17,599.47L642.11,599.47L645.05,599.47L647.99,599.47z" data-jurisdiction="AZ" id="AZ" title="Arizona"></path>
<path class="land" d="M547.81,538.68l0,2.36l0,2.36l0,2.35l0,2.34v2.34l0,2.33l0,2.32l0,2.32l0,2.31l0,2.3l0,2.3l0,2.29l0,2.28l0,2.28l0,2.27v2.27l2.21,1.97l2.21,1.97l2.21,1.96l2.21,1.96l2.21,1.95l2.21,1.95l2.21,1.94l2.21,1.94l1.73,1.63l1.73,1.63l1.73,1.63l1.73,1.62l1.73,1.62l1.73,1.62l1.73,1.61l1.73,1.61l2.39,2.31l2.39,2.3l2.39,2.3l2.39,2.29l2.39,2.29l2.39,2.28l2.39,2.28l2.56,2.42l0,0.96l0.5,1.29l1.5,2.34l0.18,0.56l0.02,0.01l0.06,0.58l0.59,0.63l1.41,0.88l0.32,0.43l0,0.04l0,0.31l-0.36,0.38l-1.56,1.26l-0.84,1.03l-0.85,1.66l0.13,1.35l-0.04,1.11l-0.21,0.88l-0.32,0.81L598.63,640l-0.46,0.44l-0.48,0.14l-0.17,0.98l0.14,1.81l0.53,1.1l0.92,0.39l0.56,0.59l0.21,0.8l-0.08,0.78l-0.37,0.77l-0.62,0.42l-1.31,0.11h0l-0.04,0.1l-1.08,0.12l-2.69,0.24l-2.69,0.24l-2.69,0.24l-2.69,0.24l-2.69,0.24l-2.69,0.24l-2.69,0.24l-2.69,0.24l-0.02,-0.07l-0.06,-1.22l-0.44,-0.43l-0.56,0.27l-0.26,-1.58l0.14,-0.75l-0.07,-0.73l-0.53,-1.8l-1.4,-2.19l-3.02,-2.73l-1.54,-0.91l-1.21,-1.15l-0.77,-0.32l-0.96,-0.09l-0.28,0.52l-1.09,-0.36l0.17,-1.29l-1.07,-1.8l-0.87,-0.2l-2.19,0.12l-2.93,-0.99l-0.87,-0.59l-0.3,-1.06l-1.37,-0.92l-1.81,-0.9l-1.01,0.21l-1.32,-0.14l-1.88,-0.65l-1.1,-0.08l-2.14,0.19l-0.8,-0.14l-0.74,-0.82l-0.8,-0.41l0.17,-1.01l-0.1,-0.92l0.12,-0.71l-0.36,-1.57l0.28,-1.45l-0.24,-0.53l-0.45,-0.4l-1.42,-0.6l-0.26,-0.75l0.23,-1.04l-0.37,-0.69l-1.16,-0.64l-1.08,-1.45l-1.37,-0.8l-0.56,-1.34l-0.85,-0.83l-0.29,-0.73l-1.88,-2.63l-2.01,-2.06l-0.31,-1.19l-0.08,-1.62l0.79,-0.99l0.43,-0.87l-0.04,-0.8l-0.12,-0.59l-0.69,-1.03l-2.67,-0.61l-2.17,-2.54l-0.13,-1.95l-0.85,-2l-0.01,-1.3l-0.13,-1.41l0.65,-0.31l0.58,0.11l-0.06,0.56l0.19,1.01l0.68,0.76l0.65,0.33l0.59,0.74l0.44,0.22l0.46,0.05l-0.24,-0.47l-0.26,-0.3l-0.32,-0.98l-0.6,-1.25l-0.69,-0.69l-0.35,-1.26l-0.3,-0.29l-0.19,-0.47l0.67,-0.56l0.92,-0.4l1.23,-0.11l3.48,0.19l0.74,-0.32l0.61,0.11l0.45,-0.04l-0.94,-0.33l-0.53,0.11l-0.62,-0.07l-1.24,0.07l-0.5,-0.14l-0.56,-0.4l-0.36,-0.04l-1.15,0.69l-0.51,-0.08l-1.21,-0.75l-0.53,-0.1l-0.85,0.43l-0.1,1.85l0.26,1.37l-0.51,0.14l-0.59,-0.56l-0.91,-0.34l-0.75,-0.51l-1.06,-0.96l-0.56,-0.35l-0.63,0.8l-0.02,-0.36l0.31,-0.92l-0.09,-1.55l0.95,1.24l-0.29,-0.87l-0.74,-0.96l-0.56,-0.33l-0.71,-1.72l-1.59,-1.04l-1.27,-1.68l-2.6,-2.79l-0.17,-2.46l-0.95,-3.12l0.4,-1.78l-0.05,-1.26l-0.46,-1.91l-0.48,-1.04l-2.11,-2.86l-2.03,-1.93l-0.31,-1.46l-0.14,-1.48l0.44,-1.32l0.38,-1.39l0.28,-0.37l0.11,0.15l-0.08,0.3l0.29,0.09l0.11,-0.61l0.17,-0.32l-0.3,-0.04l0.03,-0.19l0.18,-0.39l0.63,-1.83l-0.06,-2.31l0.67,-2.85l-0.03,-0.94l-0.43,-2.03l-0.43,-1.22l-0.77,-0.87l0.34,-1.27l-0.03,-1.21l-0.16,-0.2l2.57,0h2.48h2.48h2.48h2.48h2.48h2.48h2.48h2.48h2.48h2.48h2.48h2.48h2.48h2.48H547.81zM548.92,633.13l1.92,0.58l1.03,-0.28l0.19,0.28l-0.12,0.24l-2.33,0.44l-0.71,-0.31l-0.06,-0.42l-0.24,-0.4L548.92,633.13zM544.93,633.75l-0.5,0.03l-0.77,-0.12l0.27,-0.26l0.43,-0.19l0.14,0.14L544.93,633.75zM547.41,634.94l-0.66,0.16l-0.5,-0.15l-0.8,-1.08l1.7,-0.14l0.73,0.47l0.1,0.13L547.41,634.94zM563.37,640.94l0.48,0.83l-0.68,-0.1l-0.72,0.05l-0.22,-0.45l-0.21,-0.62l-0.14,-0.16l-0.49,-0.06l-0.04,-0.06l-0.06,-0.3l0.14,-0.15l1.54,0.7L563.37,640.94zM553.11,642.83l-0.42,0.02l-0.58,-0.1l-0.3,-0.6l0.47,-0.04l0.44,0.08l0.35,0.47L553.11,642.83zM563.35,647.19l-0.55,0.1l-0.61,-0.23l-0.52,-1.08l-0.58,-0.84l0.31,-0.24l0.47,0.81l1.17,1.23L563.35,647.19z" data-jurisdiction="CA" id="CA" title="California"></path>
<path class="land" d="M717.03,563.52L717.04,565.82L717.04,568.1L717.05,570.38L717.06,572.66L717.06,574.92L717.07,577.18L717.08,579.44L717.08,581.69L717.09,583.93L717.1,586.17L717.11,588.4L717.11,590.63L717.12,592.85L717.13,595.06L717.13,597.27L717.14,599.48L714.81,599.48L712.49,599.48L710.16,599.48L707.84,599.48L704.28,599.48L700.73,599.48L697.17,599.48L693.61,599.48L690.05,599.48L686.5,599.48L682.94,599.48L679.38,599.48L675.83,599.48L672.27,599.48L668.71,599.48L665.15,599.48L661.6,599.48L658.04,599.48L654.48,599.48L650.93,599.48L650.93,596.54L650.93,593.59L650.93,590.63L650.93,587.66L650.93,584.68L650.93,581.69L650.93,578.69L650.93,575.68L650.93,572.66L650.93,569.63L650.93,566.58L650.93,563.53L650.93,560.46L650.93,557.39L650.93,554.3L650.93,551.2L653.89,551.2L656.84,551.2L659.8,551.2L662.75,551.2L665.71,551.2L668.67,551.2L671.62,551.2L674.58,551.2L677.54,551.2L680.49,551.2L683.45,551.2L686.4,551.2L689.36,551.2L692.32,551.2L695.27,551.2L698.23,551.2L700.58,551.2L702.93,551.2L705.28,551.2L707.63,551.2L709.98,551.2L712.33,551.2L714.68,551.2L717.02,551.2L717.03,552.75L717.03,554.3L717.03,555.84L717.03,557.39L717.03,558.92L717.03,560.46L717.03,561.99z" data-jurisdiction="CO" id="CO" title="Colorado"></path>
<path class="land" d="M1001.54,538.53L1001.55,539.21L1001.55,540.16L1001.56,540.85L1001.57,541.79L1001.57,542.87L1001.58,543.86L1001.59,544.72L1001.56,545.23L1001.51,546.01L1001.27,546.31L1001.15,547.03L1000.33,546.96L998.97,547.15L997.17,547.57L996.17,547.32L995.15,547.77L991.69,547.9L990.96,547.66L990.03,548.51L988.54,549.02L984.77,550.93L984.32,551.31L983.83,550.53L983.45,549.91L984.21,549.42L984.8,549.05L985.34,548.71L985.7,548.48L985.41,548L985.13,547.52L985.2,546.34L985.28,545.15L985.35,543.96L985.43,542.77L985.5,541.57L985.58,540.38L985.65,539.18L985.73,537.98L986.52,538.02L987.31,538.05L988.1,538.09L988.9,538.12L989.69,538.15L990.48,538.19L991.27,538.22L992.06,538.26L992.07,538.58L992.48,538.54L992.53,538.26L993.66,538.27L994.78,538.29L995.91,538.31L997.03,538.33L998.16,538.35L999.28,538.36L1000.41,538.38L1001.53,538.4z" data-jurisdiction="CT" id="CT" title="Connecticut"></path>
<path class="land" d="M952.31,577.02L952.1,576.71L951.64,576.46L951.45,576.37L952.2,575.55L952.7,576.27L953.25,577.04L952.41,578.02z" data-jurisdiction="DC" id="DC" title="Washington x2C  DC"></path>
<path class="land" d="M967.46,565.79L967.05,566.22L966.7,566.99L965.89,567.92L965.95,568.55L966.09,568.99L966.02,569.92L966.53,570.82L967.54,572.29L967.73,574.57L968.5,576.09L969.68,577.87L970.59,578.37L970.64,579.03L970.22,580.11L969.66,580.61L970.38,580.51L970.74,580.76L971.09,581.66L971.07,582.23L970.06,582.24L967.98,582.24L965.89,582.24L964.94,582.24L964.92,582.24L964.9,582.24L964.88,582.24L964.86,582.24L964.84,582.24L964.81,582.24L964.79,582.24L964.77,582.24L964.68,580.34L964.59,578.44L964.5,576.53L964.4,574.62L964.31,572.7L964.22,570.78L964.13,568.86L964.04,566.93L964.75,565.95L965.05,565.65L965.45,565.5L966.62,565.45z" data-jurisdiction="DE" id="DE" title="Delaware"></path>
<path class="land" d="M910.2,670.29l0.44,0.99l0.67,4.03l0.46,1.4l0.83,3.76l1.36,3.63l1.93,4.37l3.16,5.27l0.38,0.75l-0.41,0.64l-0.13,0.66l-0.04,0.99l0.11,0.96l0.37,1.18l0.72,1.8l-0.4,-0.36l-1.04,-2.58l-0.12,-1.52l0.15,-2.16l-0.24,0.05l-0.2,0.7l-0.11,0.82l-0.26,0.32l-0.36,-1.26l0.03,-0.57l0.38,-0.66l-0.11,-0.24l-0.62,-0.34l-0.13,-0.53l0.08,-0.53l-0.35,-0.28l-0.28,0.01l0.19,1.3l0.29,0.8l0.36,1.91l0.59,1.16l0.34,0.97l3.99,10.3l0.94,1.31l0.35,0.94l0.36,1.96l0.08,2.51l-0.65,4.57l-0.15,3.1l-0.09,-0.09l-0.06,-0.33l-0.15,-0.04l-0.56,1.42l-0.77,1.28l-0.25,1.99l-0.37,0.99l-1.11,1.05l-0.69,-0.03l-1.68,0.79l-1.18,-0.2l-1.41,0.44l-0.93,-0.05l-0.54,-0.94l0.08,-0.42l0.21,-0.42l0.36,-0.1l1.25,0.98l0.23,-0.41l-0.38,-0.49l-0.72,-0.27l-0.53,-0.3l-1.07,-2.24l-1.11,-1.54l-0.19,-1.03l-1.91,-0.63l-1.39,-0.95l-0.9,-1.7l-0.52,-3.02l-0.61,-0.34l-0.26,-0.23l0.6,-1.12l0.63,-0.94l-0.5,0.23l-0.37,0.35l-0.47,0.83l-0.34,0.13l-0.31,-0.13l-0.36,-1.59l0.1,-1.96l0.51,-0.73l-0.78,-0.02l-0.8,0.28l0.12,0.66l-0.11,0.36l-0.59,-0.09l-0.44,-0.23l-0.6,-0.68l-0.82,-1.3l-1.69,-3.59l-0.33,-0.51l-0.56,-0.53l0.26,-0.16l0.48,-0.1l1.08,-1.62l0.85,-0.98l0.28,-0.68l-0.05,-0.29l-0.38,-0.42l-0.49,0.37l-0.21,-0.1l-0.56,-0.85l-0.53,-0.24l-0.37,0.19l0.39,0.7l0.35,0.26l-0.14,1.02l-0.14,0.33l-0.33,0.29l-0.51,-0.15l-0.26,0.25l-0.31,-0.26l-0.3,-0.45l-0.34,-0.73l0.9,-4.15l0.83,-2.65l0.1,-3.03l0.06,-0.45l-0.07,-0.81l-1.11,-1.76l-4.9,-4.3l-3.8,-5.11l-3.29,-1.92l-2.5,0.42l-0.43,0.39l-0.19,0.51l0.16,0.57l-0.23,0.24l-0.67,-0.03l-0.9,0.13l-2.36,1.35l-0.83,-0.05l-0.76,0.35l-0.56,0.26l-1.48,0.14l-1.25,0.3l-0.54,-0.16l-0.35,-0.78v-0.81l0.29,0.62l0.44,0.48l0.2,-0.19l0.08,-0.43l-0.44,-0.84l-1.42,-1.08l-1.61,-1.58l0.49,0.05l0.12,-0.34l-0.5,-0.44l0.21,-0.51l0.35,-0.54l-0.68,0.08l-0.61,0.38l-0.02,0.47l-0.12,0.37l-0.33,-0.05l-0.61,-0.46l-3.01,-1.28l-2.63,-0.72l2.02,-0.32l1.1,0.25l-0.13,-0.39l-0.26,-0.25l-0.86,-0.31l-1.1,0.12l-0.69,-0.15l-0.71,0.31l-0.78,0.46l-0.69,0.24l-2.71,0.33l-2.2,0.36l0.35,-0.38l0.38,-0.24l1.3,-0.37l0.19,-0.77l-0.31,-0.74l-0.34,0.18l-0.36,0.58l-0.44,-0.42l-0.49,0l-0.13,0.93l-0.62,0.62l-0.28,0.62l-1.83,0.49l-0.23,-0.16l0.54,-0.59l-0.04,-0.33l-0.39,0.18l0.09,-0.37l0.33,-0.34l0.15,-0.38l-0.04,-0.74l0.24,-1.04l-0.12,-0.33l-1.36,-1.35l-0.33,-0.71l-0.06,-0.75l0.13,-0.78h3.05l3.04,0h3.04l3.04,0h3.04l3.05,0l3.04,0l3.04,-0.01l0.39,0.86l0.75,1.78l0.03,0.42l0.88,0.06l1.5,0.1l1.5,0.1l1.5,0.1l1.5,0.1l1.5,0.1l1.5,0.1l1.5,0.1l1.5,0.1l1.5,0.1l1.5,0.1l1.5,0.1l1.5,0.1l1.5,0.1l1.5,0.1l1.5,0.1l1.5,0.1l0.01,0.36l0.25,0.56l0.06,0.64l0.11,0.31l0.3,0.19l0.47,0.05l0.48,-0.36l0.3,-0.79l0.08,-0.89l-0.18,-1.02l0.03,-0.86l0.24,-0.5l0.28,-0.12l0.24,-0.27l0.2,-0.06l0.52,0.14l1.95,0.72L910.2,670.29zM878.16,682.09l-0.94,0.39l-1.02,-0.28l0.64,-0.05l0.46,0.11l1.16,-0.56l0.61,-0.42l0.71,-0.16L878.16,682.09zM922.6,707.27l0.15,0.78l-0.87,-1.8l-1.07,-2.83l-0.57,-2.19l0.39,0.59l0.38,1.23L922.6,707.27zM904.74,714.9l-0.01,0.61l-0.47,-1.03l-0.31,-1.14l0.45,0.37L904.74,714.9zM905.18,715.93l-0.34,0.27l-0.68,-0.2l-0.37,-0.36l-0.16,-0.7l0.59,0.74l0.21,0.17L905.18,715.93zM920.76,729.57l-1.87,1.94l0.21,-0.49l0.73,-1.04l0.24,-0.49l0.49,-0.31l0.46,-0.56l0.03,-0.65l0.67,-0.46l0.22,-0.06L920.76,729.57zM918.35,732.04l-0.25,0.05l0.37,-0.44l0.1,0.03L918.35,732.04zM916.55,733.07h-0.18l0.09,-0.15l0.37,-0.29l0.14,0.11l-0.02,0.15L916.55,733.07zM914.53,733.96l-0.43,0.24l-0.44,-0.18l0.49,-0.24l1.46,-0.26l-0.55,0.33L914.53,733.96zM911.79,734.65l-0.28,0.21l-0.13,-0.06v-0.31l-0.4,-0.68l0.02,-0.18l0.92,0.67l0.02,0.18L911.79,734.65zM909.61,735.17L909,735.27l0.49,-0.4l0.16,-0.61l0.29,0.48l-0.01,0.29L909.61,735.17zM907.57,735.74l-0.24,0.02l-0.02,-0.16l0.41,-0.19l0.27,0.01l-0.01,0.22L907.57,735.74z" data-jurisdiction="FL" id="FL" title="Florida"></path>
<path class="land" d="M916.15,656.05l-0.48,0.94l-1.15,0.58l-0.35,-0.02l-0.29,0.17l0.17,0.42l0.29,0.3l-0.01,0.28l-0.3,0.38l-0.6,0.11l-0.34,0.44l0.11,0.41l0.2,0.23l-0.04,0.4l-0.68,0.4l-0.16,0.39l0.34,0.11l0.26,-0.11l0.19,0.08l-0.41,0.65l-0.37,0.4l-0.35,0.71l-0.81,0.2l0.03,0.23l0.46,0.2l0.38,0.55l-0.72,1.01l-0.45,-0.08l-0.27,-0.22l-0.17,0.8l0.07,0.42l-0.17,0.87l-0.28,1.04l-0.19,0.43l0.04,0.8l0.12,0.77l-1.59,-0.1l-1.95,-0.72l-0.52,-0.14l-0.2,0.06l-0.24,0.27l-0.28,0.12l-0.24,0.5l-0.03,0.86l0.18,1.02l-0.07,0.89l-0.3,0.8l-0.48,0.36L904,674.16l-0.3,-0.19l-0.11,-0.31l-0.06,-0.64l-0.25,-0.56l-0.01,-0.36l-1.5,-0.1l-1.5,-0.1l-1.5,-0.1l-1.5,-0.1l-1.5,-0.1l-1.5,-0.1l-1.5,-0.1l-1.5,-0.1l-1.5,-0.1l-1.5,-0.1l-1.5,-0.1l-1.5,-0.1l-1.5,-0.1l-1.5,-0.1l-1.5,-0.1l-1.5,-0.1l-0.88,-0.06l-0.03,-0.42l-0.75,-1.78l-0.39,-0.86l-0.57,-1.27l-0.24,-1.95l0.36,-3.04l-0.11,-0.69l0,0l-0.54,-1.56l0.01,-1.14l0.56,-1.88l0,0l0.28,-1.06l0.39,-0.6l0.6,-0.5l0.08,-0.44l-0.44,-0.38l-0.16,-0.46l0.11,-0.54l-0.39,-1.3l-1.33,-3.09l-0.19,-1.05l-0.23,-0.65l-0.25,-1.43l-0.25,-1.43l-0.25,-1.43l-0.25,-1.43l-0.25,-1.44l-0.25,-1.44l-0.25,-1.44l-0.25,-1.44l-0.25,-1.44l-0.25,-1.45l-0.25,-1.45l-0.25,-1.45l-0.25,-1.45l-0.25,-1.46l-0.25,-1.46l-0.25,-1.46l3.06,0.04l3.06,0.04l3.06,0.04l3.06,0.04l2.85,-0.04l2.85,-0.04l2.85,-0.04l2.85,-0.04l-0.06,0.01l-0.46,0.77l-1.38,1.45l-0.37,1.11l1.78,1.24l0.01,0.01l1.06,1l0.73,0.39l0.74,0.12l0.46,0.33l0.27,0.81l0,0l2.16,3.95l0,0l2.24,2.03l0.9,1l0.45,0.97l1.91,1.58l0.65,0.85l0.03,0.65l0.23,0.46l0.42,0.27l0.4,0.58l0.39,0.88l0.76,0.77l1.14,0.65l0.83,1.49l0.53,2.31l0.54,1.34l0.82,0.56l1.12,1.97l0.36,1.17l-0.02,1.03l0.57,0.8L916.15,656.05zM911,667.67l-0.42,2.66l-0.18,-0.94l-0.02,-0.91l0.32,-0.54L911,667.67z" data-jurisdiction="GA" id="GA" title="Georgia"></path>
<path class="land" d="M676.23,732.13l-1.04,0.71l-0.6,-0.31l-1.15,-0.11l-0.44,-0.54l-1.2,-0.48l-0.49,-0.66l0.74,-1.25l1.74,-1.05l2.69,0.05l0.56,0.83l0.05,0.62l-0.35,0.69l-0.16,0.98L676.23,732.13zM666.69,733.29l-0.24,0.56l-0.41,-0.09l-0.1,-0.5l0.27,-0.69l0.67,-0.59l0.75,-0.9l0.61,0.14l-0.33,0.59l-0.04,0.64l-0.87,0.36L666.69,733.29zM694.83,738.15l0.41,0.07l0.52,-0.09l0.18,1.01l0.61,0.56l0.22,0.33l-0.66,0.35l-1.27,0.14l-0.6,-0.28l-0.62,-0.63l-0.67,0.17l-0.12,-0.5l-0.12,-0.15l-0.46,0.14l0.43,0.65l-1.16,0.05l-0.37,-0.08l-0.32,-0.74l-1.2,-1.42l0.01,-0.55l-0.41,-0.66l1.77,-0.19l1.21,-1.16l0.69,-0.12l1.31,1.87l-0.03,0.52l0.29,0.51L694.83,738.15zM701.75,741.19l2.5,0.35l0.59,-0.15l0.41,0.28l2.07,0.17l0.36,0.11l-0.42,0.65l-1.32,0.6l-1.9,-0.52l-3.18,-0.19l0.13,-0.5l0.3,-0.35l0.05,-0.62L701.75,741.19zM710.34,744.75l0.31,0.23l1.26,-0.34l0.91,-0.12l1.53,0.83l0.53,0.57l1,0.61l0.34,0.44l-0.28,0.53l-1.11,0.88l-1.51,0.2l-0.89,0.37l-1.17,-0.08l-0.35,-0.16l-0.13,-1.11l-0.37,-1.19l-0.75,0.14l-0.85,-0.4l-0.88,-1l-0.09,-0.6l0.48,-0.95l0.84,-0.12l0.63,0.52L710.34,744.75zM706.05,746.76l-0.7,0.35l-0.76,-0.16l-0.18,-0.86l-0.73,-1.09l1.29,-0.22l0.72,0.32l0.38,0.34l0.46,0.59L706.05,746.76zM721.04,768.76l-0.52,0.6l-0.65,-0.05l-2.37,-1.28l-0.29,-0.69l0.18,-3.19l-0.89,-2.6l-0.98,-1.98l0.71,-1.02l0.94,-0.79l1.05,-1.49l-0.86,-1.92l0.22,-1.16l0.5,-0.2l2.48,1.41l5,2.11l1.33,1.48l0.24,1.59l0.91,0.2l0.43,1.09l1.31,0.95l0.44,0.55l-0.55,0.88l-2.4,1.68l-3.03,0.74l-2.66,1.88L721.04,768.76z" data-jurisdiction="HI" id="HI" title="Hawaii"></path>
<path class="land" d="M824.1,532.18L824.67,533.05L825.66,533.83L826.22,534.56L826.36,535.24L826.96,535.97L828.03,536.74L828.65,537.42L828.82,538.01L828.79,538.92L828.56,540.15L828.17,541.04L827.62,541.58L827.22,542.34L826.95,543.32L826.11,544.21L824.7,545.04L823.12,545.6L821.39,545.9L820.36,546.61L820.04,547.72L820.18,548.65L820.8,549.39L821.15,550.18L821.24,551.01L820.81,552.39L819.85,554.31L818.78,555.55L817.62,556.11L817.1,556.94L817.23,558.04L817.13,558.66L816.65,558.88L815.82,558.23L815.67,557.77L815,557.31L814.9,557.02L814.39,556.76L813.92,555.86L811.55,555.88L809.17,555.89L806.8,555.91L804.42,555.93L802.05,555.95L799.68,555.97L797.3,555.98L794.93,556L792.55,556.02L790.18,556.04L787.8,556.05L785.43,556.07L783.05,556.09L780.68,556.11L778.3,556.13L775.95,556.14L775.38,555.22L775.07,554.37L775.27,553.96L775.3,552.58L775.19,550.21L774.96,548.87L774.62,548.57L774.58,548.15L774.84,547.63L774.76,547.27L774.34,547.08L774.22,546.63L774.37,545.9L774.27,545.46L773.91,545.3L773.77,545.05L773.83,544.71L773.63,544.5L773.19,544.4L773.01,543.58L773.09,542.03L772.93,540.94L772.51,540.29L772.29,539.69L772.29,539.12L771.85,538.23L770.96,537.01L770.39,535.4L770.13,533.4L769.5,532.27L769.21,532.21L768.98,531.16L768.72,530.69L768.67,530.33L767.89,529.42L767.84,529.07L767.94,528.63L768.45,527.77L768.91,526.36L769.02,525.41L769.39,524.69L769.4,524.3L769.33,523.78L769.13,523.32L768.51,522.99L768.44,522.84L768.38,522.32L768.63,521.99L768.71,521.62L768.64,521.16L768.27,520.37L768.11,519.56L769.47,519.51L772.53,519.51L775.59,519.51L778.66,519.51L781.72,519.51L784.78,519.51L787.84,519.51L790.9,519.5L793.96,519.5L797.02,519.5L800.09,519.5L803.15,519.5L806.21,519.5L809.27,519.5L812.33,519.5L815.39,519.5L818.5,519.49L818.57,520.3L818.75,520.88L819.13,521.35L819.71,521.7L819.8,522.39L819.42,523.4L819.29,524.65L819.41,526.14L819.7,527.48L820.15,528.67L821.19,529.54L822.8,530.1L823.75,530.94L824.03,532.09z" data-jurisdiction="IA" id="IA" title="Iowa"></path>
<path class="land" d="M632.05,506.5L632.05,508.55L632.06,510.59L632.06,512.63L632.06,514.67L632.06,516.7L632.06,518.72L632.06,520.74L632.06,522.75L632.06,524.76L632.06,526.76L632.06,528.76L632.06,530.75L632.06,532.74L632.06,534.72L632.06,536.7L632.06,538.67L630.3,538.67L628.54,538.67L626.78,538.67L625.02,538.67L623.26,538.67L621.5,538.67L619.74,538.67L617.98,538.67L616.22,538.67L614.46,538.67L612.7,538.67L610.94,538.67L609.18,538.67L607.42,538.67L605.66,538.67L603.9,538.67L600.4,538.67L596.9,538.67L593.4,538.67L589.9,538.67L586.4,538.67L582.9,538.68L579.4,538.68L575.9,538.68L575.9,535.86L575.89,533.02L575.89,530.18L575.88,527.33L575.88,524.47L575.88,521.59L575.87,518.71L575.87,515.53L575.86,515.46L576.46,513.5L576.58,512.54L576.43,512L576.53,511.48L576.89,510.98L576.88,510.43L576.5,509.83L575.78,509.43L574.74,509.24L574.2,508.53L574.16,507.32L574.94,505.45L576.54,502.92L577.41,501.13L577.57,500.07L578.53,497.63L580.3,493.79L580.98,491.32L580.57,490.24L579.66,489.2L578.27,488.21L577.29,487.05L577.03,486.46L576.71,485.73L576.55,484.81L576.79,484.28L576.59,483.35L575.96,482.02L575.69,481.12L575.75,480.8L575.82,480.67L575.81,478.49L575.81,476.29L575.8,474.1L575.79,471.89L575.78,469.68L575.77,467.46L575.77,465.23L575.76,463L575.75,460.76L575.74,458.52L575.74,456.26L575.73,454L575.72,451.73L575.71,449.46L575.71,447.18L575.69,444.9L578.72,444.9L582.73,444.9L585.01,444.9L585.02,448.42L585.01,451.93L585.01,455.42L585.01,458.9L586.02,460.31L586.77,461.17L587.25,462.1L587.98,463.07L588.12,463.42L588.38,464.46L588.19,465.22L588.58,465.98L588.51,466.35L588.22,466.55L588.16,466.61L588.17,466.69L588.27,466.81L589.3,467.54L590.31,468.56L591.59,469.26L592,469.67L593.69,471.69L594.57,472.98L595.49,473.92L595.95,474.99L596.9,475.92L597.14,476.4L597.2,476.5L597.33,476.52L597.92,476.29L598.07,476.35L598.36,476.72L598.42,477.28L598.64,477.52L599,477.65L599.42,477.69L600.71,477.42L600.99,477.42L601.13,477.53L601.19,477.83L601.17,478.32L601.04,479.02L600.65,479.71L600.72,480.35L600.41,481.84L600.12,482.83L600.09,483.79L599.73,484.35L599.93,485.01L599.79,486.01L599.92,486.27L600.38,486.73L600.56,487.96L600.48,488.19L599.66,488.67L599.38,488.98L599.27,489.43L599.63,490.72L599.28,491.43L599.24,492.04L599.32,492.2L600.08,492.53L601,493.25L601.29,493.41L601.5,493.38L601.89,493.14L602.32,492.65L603.2,492.15L604.24,491.09L604.29,490.79L604.37,490.63L604.51,490.64L604.84,490.78L605.49,491.42L606.06,491.78L606.16,491.86L606.21,492.04L606.18,492.68L606.5,493.18L606.59,494.01L606.92,494.83L607.15,495.82L608,497.1L608.46,498.01L608.97,498.43L609.28,498.91L609.5,499.49L609.59,499.96L609.29,500.81L609.37,501.16L609.64,501.55L610.52,502.42L610.7,502.49L611.51,502.4L611.95,502.55L612.39,502.98L612.83,503.65L613.12,504.31L613.2,505.1L613.65,505.97L613.71,506.74L613.99,507.08L614.55,507.54L615.09,507.82L615.3,507.84L615.45,507.72L615.5,507.3L615.72,506.97L616.39,506.51L617.02,506.52L619.43,506.9L619.59,506.88L619.7,506.75L620.11,506.05L620.44,505.77L620.95,505.68L622.43,505.86L624.14,505.76L625.03,505.96L626.33,505.7L627.83,505.89L628.03,505.78L628.07,505.63L627.94,505.37L627.92,504.85L628.22,504.23L628.32,503.7L628.63,503.4L629.03,503.24L629.36,503.26L629.68,503.54L630.04,504.01L630.68,505.29L631.02,505.75L631.43,506.15z" data-jurisdiction="ID" id="ID" title="Idaho"></path>
<path class="land" d="M850.82,532.39L850.81,534.37L850.96,536.01L851.24,536.74L851.57,537.28L851.92,537.62L852.33,538.68L852.8,540.46L853.22,541.63L853.56,542.11L853.54,545.46L853.53,549.2L853.52,552.93L853.5,556.64L853.49,560.33L853.48,564L853.46,567.66L853.45,571.1L853.45,571.16L853.01,571.53L852.71,572.17L852.79,572.86L852.67,573.35L852.37,573.65L852.52,574.4L853.11,575.6L853.47,576.79L853.59,577.96L853.48,578.79L852.97,579.55L852.48,581.19L852.06,581.85L851.54,582.06L851.08,582.67L850.68,583.67L850.25,584.15L849.79,584.12L849.45,584.31L849.23,584.7L849.26,585.11L849.53,585.55L849.44,585.95L848.99,586.32L849,586.5L849.14,586.61L849.09,586.78L848.8,586.96L848.63,587.51L848.65,588.42L848.49,588.88L848.19,588.9L848.15,589.15L848.65,590.18L848.36,590.39L847.84,591.24L847.73,592.17L848.04,593.19L847.26,594.02L845.39,594.65L844.39,595.2L844.28,595.68L844.41,596.41L844.78,597.39L844.85,598.07L844.61,598.45L843.27,598.19L840.84,597.3L839.2,597.34L838.37,598.28L838.08,599L838.18,599.58L837.52,598.87L837.07,598.55L836.99,598.57L836.89,598.66L836.85,598.88L836.88,599.04L836.94,599.22L836.91,599.34L836.8,599.34L836.32,599.07L835.74,598.28L835.05,596.98L834.9,595.95L835.29,595.18L835.29,594.38L834.9,593.53L834.71,592.7L834.71,591.89L833.77,590.67L831.89,589.05L830.51,588.04L829.62,587.66L828.59,586.85L827.41,585.6L826.78,584.64L826.7,583.98L827.24,582.21L828.8,578.33L828.98,577.88L829.03,577.71L828.96,577.54L828.81,577.38L828.15,576.92L826.89,576.53L825.72,576.32L824.79,576.78L823.98,575.84L823.28,573.49L821.57,571.01L818.83,568.39L817.24,566.6L816.8,565.66L816.41,564.24L816.09,562.34L816.1,560.77L816.65,558.88L817.13,558.66L817.23,558.04L817.1,556.94L817.62,556.11L818.78,555.55L819.85,554.31L820.81,552.39L821.24,551.01L821.15,550.18L820.8,549.39L820.18,548.65L820.04,547.72L820.36,546.61L821.39,545.9L823.12,545.6L824.7,545.04L826.11,544.21L826.95,543.32L827.22,542.34L827.62,541.58L828.17,541.04L828.56,540.15L828.79,538.92L828.82,538.01L828.65,537.42L828.03,536.74L826.96,535.97L826.36,535.24L826.22,534.56L825.66,533.83L824.67,533.05L824.1,532.18L828.42,532.22L832.66,532.25L836.9,532.28L841.14,532.31L845.38,532.35L849.62,532.38z" data-jurisdiction="IL" id="IL" title="Illinois"></path>
<path class="land" d="M879.21,542.44L879.18,546.52L879.15,550.58L879.11,554.61L879.08,558.63L879.05,562.63L879.02,566.6L878.98,570.56L878.97,574.58L878.82,574.69L878.6,575.21L878.84,575.74L878.83,576.17L878.57,576.5L878.66,576.74L879.1,576.9L879.27,577.28L879.17,577.87L878.22,578.47L876.41,579.14L876.02,579.33L875.69,579.42L875.54,579.38L875.54,579.38L875.3,579.25L874.97,578.98L874.4,578.85L873.47,578.94L873.1,579.5L873.29,580.54L872.97,581.34L872.15,581.89L871.56,582.62L871.21,583.53L870.64,584.08L869.87,584.27L869.24,585.11L868.77,586.59L868.24,587.5L867.68,587.86L866.9,587.77L865.92,587.23L865.36,586.69L865.21,586.12L864.92,585.72L864.65,585.54L864.47,585.54L864.46,585.62L864.54,585.78L864.44,585.95L863.83,586.01L863.57,586.24L863.66,586.65L863.52,586.93L863.17,587.1L862.98,587.49L862.96,588.1L862.71,588.66L862.24,589.16L861.54,588.99L860.63,588.15L859.7,587.95L858.75,588.41L858.05,589.02L857.58,589.79L857.14,589.98L856.49,589.4L854.96,588.58L854.16,588.41L853.58,588.6L853.18,588.51L853.04,588.29L852.93,588.2L852.82,588.31L852.81,589.02L852.67,589.47L852.41,589.65L852.21,589.51L852.07,589.02L851.74,588.86L851.22,589.03L850.69,588.96L850.23,588.67L850.06,588.7L849.94,588.84L849.97,589.39L849.87,589.84L849.63,590.12L849.29,590.19L848.85,590.04L848.65,590.18L848.15,589.15L848.19,588.9L848.49,588.88L848.65,588.42L848.63,587.51L848.8,586.96L849.09,586.78L849.14,586.61L849,586.5L848.99,586.32L849.44,585.95L849.53,585.55L849.26,585.11L849.23,584.7L849.45,584.31L849.79,584.12L850.25,584.15L850.68,583.67L851.08,582.67L851.54,582.06L852.06,581.85L852.48,581.19L852.97,579.55L853.48,578.79L853.59,577.96L853.47,576.79L853.11,575.6L852.52,574.4L852.37,573.65L852.67,573.35L852.79,572.86L852.71,572.17L853.01,571.53L853.45,571.16L853.45,571.1L853.46,567.66L853.48,564L853.49,560.33L853.5,556.64L853.52,552.93L853.53,549.2L853.54,545.46L853.56,542.11L853.62,542.2L853.97,542.52L854.26,542.7L854.46,542.73L854.58,543.01L855.11,543.17L856.08,543.24L856.97,543.14L857.78,542.85L859.76,541.7L862.09,541.7L864.94,541.7L867.79,541.71L870.65,541.71L873.5,541.71L876.35,541.71L879.21,541.71z" data-jurisdiction="IN" id="IN" title="Indiana"></path>
<path class="land" d="M786.75,599.48L784.57,599.48L782.4,599.48L780.23,599.48L778.05,599.48L775.87,599.48L773.7,599.48L771.52,599.48L769.35,599.48L767.17,599.48L765,599.48L762.82,599.48L760.65,599.48L758.47,599.48L756.3,599.48L754.12,599.48L751.95,599.48L749.77,599.48L747.6,599.48L745.42,599.48L743.24,599.48L741.07,599.48L738.89,599.48L736.72,599.48L734.54,599.48L732.37,599.48L730.19,599.48L728.02,599.48L725.84,599.48L723.67,599.48L721.49,599.48L719.31,599.48L717.14,599.48L717.13,597.27L717.13,595.06L717.12,592.85L717.11,590.63L717.11,588.4L717.1,586.17L717.09,583.93L717.08,581.69L717.08,579.44L717.07,577.18L717.06,574.92L717.06,572.66L717.05,570.38L717.04,568.1L717.04,565.82L717.03,563.52L719,563.52L720.98,563.52L722.95,563.52L724.92,563.52L726.9,563.52L728.87,563.52L730.84,563.52L732.81,563.52L734.79,563.52L736.76,563.52L738.73,563.52L740.71,563.52L742.68,563.52L744.65,563.52L746.63,563.52L748.6,563.52L750.57,563.52L752.55,563.52L754.52,563.52L756.49,563.52L758.46,563.52L760.44,563.52L762.41,563.52L764.38,563.52L766.36,563.52L768.33,563.52L770.3,563.52L772.28,563.52L774.25,563.52L776.22,563.52L778.19,563.52L779.89,563.52L782.06,565.1L782.63,565.12L783.31,564.87L783.81,565.23L784.16,566.21L784.11,566.7L783.67,566.72L783.11,567.31L782.45,568.45L782.61,569.53L783.6,570.53L784.26,571.54L784.59,572.56L785.25,573.35L786.71,574.19L786.69,574.65L786.69,576.22L786.7,577.79L786.7,579.36L786.7,580.92L786.71,582.49L786.71,584.04L786.72,585.6L786.72,587.15L786.72,588.7L786.73,590.25L786.73,591.79L786.74,593.34L786.74,594.87L786.74,596.41L786.75,597.94z" data-jurisdiction="KS" id="KS" title="Kansas"></path>
<path class="land" d="M899.76,582.32l0.22,0.33l0.1,1.77l-0.06,0.35l-0.32,0.73l0.02,0.38l0.27,0.6l1,1.38l0.1,0.54l0.4,0.53l0.34,0.78l1.07,1.67l1.66,1.38l1.3,0.37l-3.56,2.87l-1.63,1.04l-1.55,0.83l-0.12,0.14l-0.35,0.92l-0.94,0.81l-0.59,0.85l-1.4,0.71l-1,0.97l-2.51,0.95l-1.4,0.33l-0.95,0.56l-0.07,0.03l-0.07,0.03l-0.07,0.03l-0.07,0.03l-0.07,0.03l-0.07,0.03l-0.07,0.03l-0.07,0.03l-3.27,-0.11l-3.27,-0.11l-3.27,-0.11l-3.27,-0.11l-3.27,-0.11l-3.27,-0.11l-3.27,-0.11l-3.27,-0.11l-3.13,0.06l-3.13,0.06l-3.13,0.06l-3.13,0.06l-0.28,-0.36l-0.82,-0.08l-1.27,-0.13l-0.05,0l0.37,1.2l0.01,1.04l-0.03,0.02l-1.47,0h-1.63l-1.62,0h-1.63l-1.63,0h-1.63h-1.63l-1.87,0l0.5,-1.02l0.44,-0.27l0.2,-0.05l0.48,0.19l0.23,0.07l0.5,-0.36l0.44,-1.05l0.25,-1.12l0.07,-1.18l-0.3,-0.94l-0.1,-0.58l0.29,-0.72l0.83,-0.95l1.63,-0.03l2.44,0.89l1.34,0.26l0.24,-0.38l-0.07,-0.68l-0.37,-0.98l-0.13,-0.73l0.11,-0.48l0.99,-0.56l1.87,-0.63l0.78,-0.82l-0.31,-1.02l0.11,-0.93l0.52,-0.85l0.29,-0.21l0.19,-0.14l0.44,0.15l0.34,-0.07l0.24,-0.28l0.1,-0.44l-0.04,-0.56l0.13,-0.13l0.17,-0.03l0.46,0.29l0.52,0.07l0.52,-0.17l0.33,0.16l0.14,0.49l0.2,0.15l0.26,-0.19l0.14,-0.45l0.01,-0.71l0.11,-0.11l0.11,0.09l0.14,0.22l0.4,0.09l0.58,-0.2l0.8,0.17l1.54,0.82l0.64,0.59l0.45,-0.19l0.46,-0.77l0.71,-0.61l0.94,-0.45l0.93,0.19l0.92,0.84l0.7,0.17l0.48,-0.5l0.25,-0.56l0.02,-0.61l0.19,-0.39l0.35,-0.17l0.13,-0.29l-0.08,-0.41l0.26,-0.23l0.61,-0.06l0.1,-0.17l-0.07,-0.16l0.01,-0.08l0.18,0l0.27,0.18l0.29,0.4l0.15,0.56l0.56,0.55l0.98,0.53l0.77,0.09l0.57,-0.35l0.52,-0.92l0.48,-1.48l0.63,-0.84l0.77,-0.19l0.56,-0.55l0.35,-0.9l0.59,-0.73l0.83,-0.55l0.32,-0.8l-0.19,-1.04l0.37,-0.56l0.93,-0.09l0.57,0.12l0.33,0.28l0.24,0.13h0l0.15,0.04l0.32,-0.08l0.39,-0.19l1.81,-0.67l0.95,-0.6l0.1,-0.59l-0.17,-0.37l-0.44,-0.16l-0.09,-0.24l0.26,-0.33l0.01,-0.43l-0.24,-0.53l0.22,-0.52l0.15,-0.11l0.53,-0.4l0.56,-0.05l0.44,0.42l0.62,0.1l0.81,-0.21l0.74,0.14l0.68,0.5l0.64,0.91l0.6,1.32l1.07,0.81l1.55,0.29l1.13,0.52l0.71,0.74l0.59,0.24l0.69,-0.4l0.73,-0.2l0.73,0.25l0.98,0.63l1.45,-0.14l1.91,-0.9l1.13,0.05l0.34,0.99l0.81,1.04l1.29,1.08L899.76,582.32zM835.05,605.3l-0.66,0.02l-0.02,-0.14l0.04,-0.32l0.06,-0.14l0.13,-0.02l0.15,0.01l0.21,0.3L835.05,605.3z" data-jurisdiction="KY" id="KY" title="Kentucky"></path>
<path class="land" d="M834.73,676.15l-0.64,0.29l-3.44,-1.11l-0.86,-0.9l-0.76,-0.19l-0.93,-0.11l-1,1.1l-0.76,1.49l1.21,0.81l1.03,0.39l1.71,-0.33l0.94,-0.72l0.77,0.02l0.37,-0.15l0.34,-0.38l0.66,0.3l0.02,0.3l-0.47,0.42l-0.59,0.35l-0.36,0.42l0.67,0.84l1.06,0.28l0.4,-0.12l0.25,-0.94l0.65,-0.61l0.88,0.13l-0.12,0.38l0.12,0.36l0.41,0.61l-0.05,0.88l0.08,0.21l-0.95,0.39l-0.71,0.13l-0.57,0.51l0.3,0.29l-0.58,0.26l-0.39,-0.1l-0.2,0.1l-0.06,0.31l-0.3,0.29l0.43,0.87l0.89,0.57l0.63,0.71l2.52,0.93l0.61,-0.03l0.6,0.94l0.48,0.32l0.47,0.16l-0.05,0.65l-0.83,0.47l-0.22,0.56l-0.21,0.32l-0.37,-0.4l-0.38,-0.29l-0.89,0.88l-0.43,0.19l0.21,-0.95l-0.34,-0.37l-0.51,-0.96l-0.74,-0.59l-0.52,-0.19l-0.41,-0.37l-0.49,-0.15l-0.42,0.04l-0.71,-0.22l-0.05,-0.51l-0.2,-0.38l-0.56,-0.45l-2.65,-0.85l-0.02,0.35l0.18,0.27l0.38,0.18l0.46,0.34l0,1.02l-0.2,0.43l-0.08,0.61l-0.17,0.62l-0.32,0.49l-0.72,0.33l-0.32,-0.28l-0.52,-1.34l-0.73,-0.42l-1.16,-0.05l-0.79,0.3l-0.86,1.3l-0.69,0.21l-2.37,-0.67l-2.7,-1.02l0.07,-0.34l0.43,-0.11l0.82,0.14l-0.04,-0.35l-0.83,-1.15l-0.15,-0.52l0.11,-0.63l-0.27,0.01l-0.5,0.53l-1.72,-0.45l-0.48,-0.54l-1.01,-1.52l-1.43,-0.05l-0.65,-0.92l-1.17,0.39l-0.59,0.43l-0.52,0.66l0.2,0.34l0.52,0.54l-0.24,0.26l-1.66,0.39l-3.86,-0.43l-1.13,-0.4l-1.52,-0.86l-2.1,-0.7l-1.01,-0.11l-0.99,0.14l-2.88,0.07l-0.67,0.19l-0.57,0.3l-0.37,-0.33l-0.17,-0.59l0.34,-0.1l0.37,-0.34l0.34,-0.68l0.04,-0.41l-0.23,-0.27l0.63,-1.08l0.15,-0.39l-0.1,-1.84l-0.28,-0.67l0.04,-0.39l0.3,-1.01l-0.05,-0.92l0.52,-1.11l0.38,-0.58l0.43,-1.19l0.1,-0.77l0.18,-0.58l-0.13,-0.62l0.3,-0.45l-0.2,-0.63l-0.06,-0.83l-0.37,-0.32l-0.65,-1.24l0.02,-0.55l-0.68,-1.16l-0.01,-0.4l-0.65,-0.6l-0.13,-0.39l-0.06,-1.61l-0.18,-0.47l-0.56,-0.93l-1.3,-1.35l0,-1.4l0,-1.4l0,-1.4l0,-1.4l0,-1.41l0,-1.41l0,-1.41l0,-1.41l1.69,0l1.69,0l1.69,0l1.69,0l1.69,0l1.69,0l1.69,0l1.69,0l1.69,0l1.69,0l1.69,0l1.69,0l1.69,0l1.69,0l1.69,0l1.85,-0.01l0.05,0.55l0.45,0.33l0.03,0.59l-0.4,0.85l0,0.59l0.41,0.33l-0.02,0.35l-0.45,0.37l-0.07,0.4l0.32,0.43l0.14,0.5l-0.03,0.56l0.42,0.74l0.65,0.48l0.43,0.56l0.04,0.31l0.03,0.28l-0.09,0.41l-0.53,0.6l-0.41,0.44l-0.25,0.16l-0.13,0.3l-0.04,0.65l-0.6,0.83l-1.22,0.96l-0.81,1.22l-0.4,1.47l-0.42,0.94l-0.44,0.4l-0.22,0.77v1.14l-0.28,0.63l-0.56,0.12l-0.12,0.65l0.32,1.18l-0.14,0.49l-0.39,0.39l-0.04,0.3l2.25,0.01h2.26h2.26h2.26h2.26l2.26,0h2.26h2.26l-0.28,1.26l-0.66,1.69l-0.03,0.44l0.17,0.55l0,0.31l0.25,0.46l0.54,0.46l0.48,0.69l0.42,1.24l0.11,0.57l0.35,0.79l0.18,0.15l0.26,0.09L834.73,676.15zM837.53,677.32l0.03,0.5l-0.46,-0.25l-0.68,-0.02l0.3,-0.17l0.21,-0.17l0.11,-0.18l0.86,-0.63l-0.24,0.46L837.53,677.32zM841.26,680.31l-0.26,0.34l0.26,-1.65l-0.37,-1.39l0.39,0.61l0.13,0.72L841.26,680.31zM840.68,681.33l-0.51,0.56l0.02,-0.21l0.38,-0.56l0.27,-0.22L840.68,681.33zM813.34,683.62l-0.35,0.15l-1.56,-0.93l-0.1,-0.4l0.77,-0.36l0.47,0.03l0.74,0.47l0.27,0.13l0.13,0.19l-0.07,0.3L813.34,683.62z" data-jurisdiction="LA" id="LA" title="Louisiana"></path>
<path class="land" d="M1010.9,527.54l-0.22,0.66l0.27,0.66l0.18,0.68l0.43,0.66l0.37,0.06l0.4,-0.12l0.29,0.03l0.19,0.28l-0.08,0.34l-0.46,0.09l-0.85,0.59l-0.75,0.23l-0.37,0.71l-0.56,0.82l-1.09,1.28l0.47,0.4l1.68,0.44l0.75,0.46l1.14,2.38l-0.26,0.24l-0.1,0.44l1.01,0.61l0.32,1.7l0.83,0.58l1.24,0.36l1.51,-0.51l1.26,-0.71l-0.04,-0.58l-0.79,-1.35l-0.19,-0.64l-0.59,-0.41l-0.22,0.35l-0.38,-0.45l-0.04,-0.26l0.35,-0.12l0.41,0.05l0.48,0.24l1.23,1.48l0.34,1.93l0.07,1.23l-0.14,0.42l-0.36,-0.09l-0.69,0.08l-3.25,0.63l-0.72,0.56l-1.65,0.6l-0.1,-0.3l0.12,-0.62l-0.1,-1.28l-0.33,-0.06l-2.57,2.09l-0.99,0.13l-0.83,0.61l-0.19,-0.34l-0.15,-1.56l0.52,-1.31l-0.28,0.02l-0.52,0.47l-0.32,-0.56l-0.35,-0.3l-0.34,-0.29l0.01,-0.47l0.02,-0.71l-0.39,-0.14l-0.04,-0.87l-0.03,-0.57l-0.71,0.01l-0.58,0.01l-0.93,0.02l-0.97,0.02l-0.71,0.01l-0.01,-0.14l-1.12,-0.02l-1.12,-0.02l-1.12,-0.02l-1.12,-0.02l-1.12,-0.02l-1.12,-0.02l-1.12,-0.02l-1.12,-0.02l-0.05,0.29l-0.41,0.04l-0.01,-0.33l-0.79,-0.03l-0.79,-0.03l-0.79,-0.03l-0.79,-0.03l-0.79,-0.03l-0.79,-0.03l-0.79,-0.03l-0.79,-0.03l-0.25,-0.31l0.3,-1.06l0.3,-1.06l0.3,-1.06l0.3,-1.07l0.3,-1.07l0.3,-1.07l0.3,-1.07l0.3,-1.07l0.93,0.04l0.93,0.04l0.93,0.04l0.93,0.04l0.93,0.04l0.93,0.03l0.93,0.04l0.93,0.04l1.34,0.04l1.34,0.05l1.34,0.04l1.34,0.05l1.34,0.04l1.34,0.05l1.34,0.04l1.34,0.05l0.82,-0.35l0.97,-1l0.59,-0.22l0.96,-0.6l0.48,-0.13L1010.9,527.54zM1013.69,546.52l-2.59,0.61l-0.41,-0.39l0.65,-0.18l0.82,-0.94l0.54,-0.11l0.85,0.53L1013.69,546.52zM1018.7,547.9l-0.73,0.2l-1.68,-0.46l1.38,-0.39l0.23,-0.14l0.18,-0.57l0.02,-0.29l0.52,1.23L1018.7,547.9z" data-jurisdiction="MA" id="MA" title="Massachusetts"></path>
<path class="land" d="M964.04,566.93l0.09,1.93l0.09,1.92l0.09,1.92l0.09,1.92l0.09,1.91l0.09,1.91l0.09,1.9l0.09,1.9h0.02l0.02,0h0.02h0.02h0.02h0.02h0.02h0.02h0.95l2.09,0l2.09,0l1.01,-0.01l-0.01,0.35l-0.12,0.52l-0.22,0.21l0.01,-0.53l-0.15,-0.18l-0.25,0.23l-0.16,0.26l-0.07,1.03l-0.17,0.52l-0.61,0.15l-0.62,1.35l-0.58,0.77l-0.21,0.48l-0.88,0.12l-1.42,0.19l-0.37,0.54l-0.71,-0.23l-1.09,0.03l0.21,-0.73l0.32,-0.64l-0.57,-0.64l-0.34,-0.08l-0.35,-0.26l0.41,-0.53l0.2,-0.56l-0.12,-0.69l0.17,-0.52l-0.28,0.08l-0.46,0.55l-0.28,0.22l-0.17,-0.48l-0.2,0.11l-0.13,0.33l-0.29,0.18l-0.61,-0.45l-0.9,-0.52l-0.5,-0.9l-0.28,-0.7l0.29,-1.26l0.62,-0.22l0.8,0.21l1.06,0l-0.15,-0.28l-0.38,0.05l-1.11,-1.03l-0.36,-0.62l-0.61,-0.17l-0.28,0.6l-0.31,0.16l0.39,-1.31l0.5,-0.05l0.74,-0.36l-0.22,-0.76l-0.47,-0.33l-0.85,0.42l0.01,-0.53l0.16,-0.68l0.64,0l0.56,0.22l0.48,-1.1l0.02,-0.49l-0.79,0.72l-0.18,-1.55l0.78,-1.49l0.74,-0.65l0.93,0.02l0.94,-0.11l-0.59,-0.27l-0.61,-0.15l0.46,-0.59l0.39,-0.11l0.38,-0.52l-0.92,0.08l0.11,-0.98l-0.45,0.2l-0.53,0.09l-0.21,0.42l0.04,0.69l-0.15,0.45l-0.41,0.36l-0.7,0.28l-0.07,-0.49l-0.23,-0.22l-0.09,1.05l-0.18,0.36l-0.51,-0.98l-0.15,0.2l0.02,0.28l-0.13,0.48l-0.44,0.25l0.03,0.62l-0.17,0.34l-1.41,-0.54l-0.03,0.18l0.8,1.16l0.58,0.4l0.07,0.63l-0.5,0.52l-0.69,-0.45l-0.12,0.03l0.37,0.77l0.24,0.68l-0.24,0.56l0.04,0.69l-0.05,0.63l-0.15,0.55l0.34,2.53l0.4,0.69l0.4,0.66l0.21,0.61l-0.42,0.09l-0.67,-0.5l-0.59,-0.38l-0.7,-1.23l-0.11,-0.49l-0.17,-0.39l0.08,0.89l0.25,1l2.19,2.23l0.41,0.85l0.31,0.67l-0.08,0.64l-0.57,-0.45l-0.49,-0.58l-1.31,-0.65l-1.65,-0.41l-0.93,-1.52l0,0.64l-0.21,0.54l-0.57,-0.66l-0.36,-0.56l-0.12,-0.61l-0.71,0.04l-0.74,0.53l-0.72,-0.13l-0.08,-1.04l0.19,-0.55l0.81,-1.31l0.76,-0.67l0.34,-0.86l-0.11,-1.34l0.1,1l0.83,-0.98l-0.54,-0.77l-0.5,-0.72l-0.75,0.82l-0.64,-0.31l-1.04,-1.02l-1.69,-0.72l-0.24,-0.36l0.03,-0.4l0.23,-0.55l-0.52,-0.54l-1.27,-0.53l-0.55,-0.45l-0.12,-0.1l-0.05,-0.56l-0.16,-0.35l-0.28,-0.15l-0.05,-0.24l0.17,-0.33l-0.17,-0.35l-0.52,-0.38l-0.18,-0.33l0.16,-0.29l-0.26,-0.13l-0.68,0.02l-0.67,-0.27l-0.66,-0.57l-0.78,-0.1l-1.36,0.57l-0.77,0.14l-0.34,0.32l-0.17,0.55l-0.33,0.28l-0.75,0.01l-0.12,-0.02l-0.85,-0.18l-0.6,-0.34l-0.11,-0.14l0.07,-0.29l-0.11,-0.13l-0.18,-0.02l-0.17,0.17l-0.18,0.52l-1.47,1.42l-0.71,-0.28l-0.27,0.01l-2.06,2l-0.62,0.32l-1.21,0.9l0.02,-1.55l0.02,-1.55l0.03,-1.56l0.02,-1.56h2.17l2.17,0h2.17h2.17h2.17l2.17,0h2.17h2.17l2.17,0h2.17h2.17l2.17,0h2.17h2.17l2.17,0H964.04zM969.3,587.19l-0.25,0.03l0.25,-0.41l0.83,-2l0.37,-0.69l-0.36,1.4l-0.63,1.29L969.3,587.19z" data-jurisdiction="MD" id="MD" title="Maryland"></path>
<path class="land" d="M1027.4,468.79l0.05,0.29l0.43,0.52l0.62,0.35l0.47,0.12l0.55,-0.01l1.51,-0.69l1.77,-0.45l0.98,-0.42l0.18,-0.39l0.44,-0.14l0.71,0.12l1.31,0.98l1.52,1.48l1.21,1.17l0.04,2.02l0.02,2.14l0.03,2.25l0.02,1.6l0.03,2.19l0.02,1.74l0.03,2.26l0.02,1.21l0.17,0.35l-0.1,0.48l-0.04,0.24l0.01,0.19l0.07,0.24l-0.01,0.33l-0.15,0.3l-0.08,0.35l-0.02,0.57l0.17,0.35l0.28,0.21h0.23l0.3,0.21l0.39,0.36l0.59,0.31l0.61,0.11l0.42,-0.08l0.51,0.21l0.18,0.5l-0.1,0.47l-0.29,0.22l-0.31,0.17l-0.05,0.36l0.15,0.38l0.22,0.33l0.24,0.58l-0.1,0.5l-0.22,0.42l-0.1,0.44l0.19,0.38l0.5,0.5l0.31,0.48l0.49,0.27l0.23,-0.19l0.19,-0.25l0.2,-0.19l0.34,0.11l0.4,0.14l0.44,0.17l-0.05,0.41l0.27,0.68l0.21,1.31l-0.31,0.59l0.07,0.79l0.87,0.23l0.21,0.24l0.04,0.29l-1.92,2.01l-1.63,-0.28l-0.88,0.53l-0.92,0.16l-0.4,0.9l-0.51,0.19l-0.69,-0.05l-0.6,-0.25l-0.46,0.12l-0.64,1.61l-0.52,-0.14l-0.21,0.58l-0.27,0.25l-0.4,0.22l-0.35,-0.72l-0.22,-0.68l-0.33,-0.15l-0.43,-0.17l-0.45,0.01l-0.3,0.1l-0.37,0.44l-0.54,0.38l-0.4,-0.31l-0.32,-0.51l-0.27,0.81l-0.39,0.86l0.07,1l-0.17,0.59l-0.37,-0.16l-0.37,-0.52l-1.05,-0.42l-0.83,0.04l0.17,-0.56l0.79,-0.8l-0.24,-0.16l-0.39,0.11l-0.17,-0.11l0.28,-0.73l0.03,-0.8l-0.35,0.28l-0.44,0.85l-1.07,0.67l0.05,1.13l-1.01,2.3l-0.05,0.98l-0.65,0.78l-0.84,0.67l-1.11,-0.19l-0.85,0.58l-0.43,0.67l-0.37,0.1l-0.2,-0.85l-0.14,-0.26l-0.31,1.25l-0.32,0.08l-0.12,-0.89l-0.15,-0.59l-0.44,0.51l-0.29,1.34l-0.3,-0.11l-0.1,-0.5l-0.22,-0.15l-0.07,0.57l0.11,0.8l-0.16,0.43l-0.3,-0.23l-0.3,-0.38l-0.5,0.29l-0.46,0.12l0,-0.39l0.09,-0.48l-0.91,0.27l-1.1,0.89l-0.85,1.23l0.3,0.2l0.33,0.39l-1.48,1.89l-1.52,1.7l-1.15,2.76l-0.46,0.32l-0.4,0.51l-0.75,-1.2l-0.15,-0.97l-0.85,-1.15l-0.34,-0.79l-0.11,-0.89l0.05,-0.96l-0.07,-1.44l-0.07,-1.44l-0.07,-1.44l-0.07,-1.44l-0.07,-1.45l-0.07,-1.45l-0.07,-1.45l-0.07,-1.45l-0.07,-1.46l-0.07,-1.46l-0.07,-1.46l-0.07,-1.47l-0.07,-1.47l-0.07,-1.47l-0.07,-1.47l-0.07,-1.32l0.23,-0.2l0.57,-0.37l0.37,0.06l0.32,0.57l0.27,0.38l0.31,-0.11l0.27,-0.53l-0.01,-0.74l0.36,-0.52l0.43,-0.08l0.4,0.02l0.2,-0.25l-0.02,-0.36l-0.14,-0.58l0.05,-0.7l1,-1.24l1.22,-0.84l0.43,-0.42l0.12,-0.86l0.7,-0.89l0.35,-0.51l0.09,-0.45l-0.18,-0.55l0.02,-1.05l0.24,-1.25l0.29,-1.37l0.65,-1.23l1.06,-1.35l0.27,-1.78l0.29,-1.88l1.28,-1.84l1.45,-2.09l0.83,-1.19l1.49,-2.17l1.06,-1.55l0.53,-0.71l0.56,-0.85l0.91,0.25l0.9,0.25l-0.13,1.23L1027.4,468.79zM1035.56,508.68l-0.55,0.26l-0.6,-0.11l0.01,0.69l-0.07,0.25l-0.66,-0.35l-0.24,-0.23l0.02,-0.92l0.59,-0.87l0.45,-0.34l0.58,0.24l0.44,0.97L1035.56,508.68zM1031.45,510.47l-0.36,0.26l-0.38,-0.08l-0.01,-0.65l0.12,-0.22l0.13,-0.1l0.2,0.18L1031.45,510.47z" data-jurisdiction="ME" id="ME" title="Maine"></path>
<path class="land" d="M840.06,460l-0.05,0.23l0.34,0.07l-0.06,0.12l-0.37,0.21l-1.05,0.43l-0.71,0.14l-0.36,-0.15l-0.04,-0.29l0.29,-0.42l0,-0.21h-0.29l0.07,-0.17l0.43,-0.33l3.68,-2.12l1.57,-0.77l0.84,-0.24l0.14,0.12l-0.91,0.8l-0.15,0.33l0.04,0.22l-0.3,0.42l-2.69,1.48L840.06,460zM846.96,469.95l-0.17,0.45l0.03,0.27l-1.14,1.18l-0.41,0.75l-0.35,0.12l-0.28,-0.51l0,-0.41l0.28,-0.31l0.28,-0.44l0.04,-0.61l-0.11,-0.22l-0.35,0.55l0.19,0.12l0.06,0.09l-0.07,0.2l-1.31,-0.29l-0.4,-0.43l0.06,-0.59l0.44,-0.76l1.58,-1.61l0.7,-0.45l1.98,-0.71l1.09,-0.16l1.1,0l0.79,0.23l0.49,0.47l-0.47,0.31l-2.17,0.26l-0.06,0.09l0.41,0.26l0.08,0.18l-0.38,0.47L846.96,469.95zM883.33,479.64l0.29,0.18l0.2,0.3l0.49,0.84l0.24,0.57l0.15,0.84l0.1,0.28l-0.01,0.49l-0.33,0.33l-0.09,0.26l0.2,0.26l1.11,0.07l0.51,0.26l0.19,0.29l-0.13,0.32l0.07,0.34l0.27,0.36l0.89,0.55l0.22,0.26l-0.06,0.28l-0.27,0.18l-0.47,0.08l-3.41,-0.52l-1,-0.08l-0.15,0.19l-0.1,0.03l-0.16,-0.05l-0.29,-0.01l-0.15,-0.12l-0.12,-0.34l-0.3,-0.22l-0.47,-0.1l-0.41,0.26l-0.47,1.02l0.07,0.19l-0.08,0.66l0.12,0.18l-0.01,0.15l-0.13,0.12l-0.28,-0.02l-0.42,-0.16l-1.6,-1.55l-1.21,-0.77l-1.5,-0.57l-1.19,-0.28l-0.87,0.02l-0.72,0.4l-0.56,0.78l-0.88,0.44l-1.19,0.11l-0.65,0.21l-0.1,0.31l-0.43,0.01l-0.76,-0.3l-0.78,-0.08l-0.81,0.13l-0.59,0.31l-0.62,0.96l-0.12,0.47l-0.45,0.41l-1.2,0.64l-0.06,0.24l-0.63,0.73l-0.2,0.4l0,0.39l-0.21,-0.02l-0.43,-0.44l-0.02,-0.59l0.39,-0.74l0.35,-0.36l0.31,0.02l0.19,-0.33l0.07,-0.68l-0.11,-0.34l-0.6,0.14l-0.31,0.27l-0.4,0.06l-0.48,-0.15l-0.42,0.37l-0.37,0.9l-0.44,0.59l-0.51,0.28l-0.34,-0.31l-0.17,-0.89l0,-0.7l0.21,-0.85l-0.11,-0.17l-0.21,0.27l-0.32,0.71l-0.43,1.55l-0.28,0.5l-0.37,0.21l-0.59,0.93l-0.81,1.65l-0.91,1.6l-1.01,1.55l-0.61,0.83l-0.2,0.12l-0.09,0.28l-0.03,0.65l-0.45,-0.18l-0.38,-0.52l-0.23,-0.53l-0.02,-0.55l0.55,-1.37l0.05,-0.22l-0.06,-0.13l-0.3,-0.15l-0.68,0.25l-0.69,0.05l-0.22,-0.09l-0.09,-0.23l0.01,-0.37l0.14,-0.44l0.41,-0.81l0.01,-0.77l0.19,-0.44l-0.18,-0.82l0.05,-0.39l-0.29,-0.43l-0.78,-0.56l-1.82,-0.75l0.19,-0.84l-0.07,-0.36l-0.44,-0.54l-1.91,-0.63l-1.3,-0.29l-1.28,-0.01l-0.92,-0.23l-1.04,-0.07l-0.66,-0.38l-0.66,-0.38l-0.66,-0.38l-0.66,-0.38l-1.18,-0.33l-1.18,-0.33l-1.18,-0.33l-1.18,-0.33l-1.18,-0.33l-1.18,-0.33l-1.18,-0.33l-1.18,-0.33l-0.26,-0.57l-0.26,-0.57l-0.26,-0.57l-0.26,-0.57l-0.54,-0.24l-0.29,-0.13l-0.21,-0.3l-0.48,0.13l-0.19,-0.49l0.05,-0.1l0.62,-0.13l1.77,-0.71l1.51,-0.87l1.25,-1.02l1.56,-0.63l1.87,-0.23l1.34,-0.36l0.81,-0.5l1.08,-0.97l0.61,-0.28l0.76,-0.09l0.57,-0.37l0.39,-0.66l0.73,-0.75l1.07,-0.85l0.61,-0.34l0.15,0.16l0.06,0.3l-0.04,0.44l0.27,0.35l0.57,0.27l0.26,0.36l-0.05,0.45l0.16,0.38l0.36,0.31l0.1,0.68l-0.17,1.05l-0.02,0.68l0.13,0.31l0.13,0.17l0.21,-0.17l0.26,-0.37l0.1,-0.23l0.07,-0.23l1.57,-1.06l0.31,-0.05l0.51,0.27l2.37,0.38l0.94,0.27l0.99,0.61l0.33,0.23l1.21,1.96l0.55,0.77l0.34,0.21l0.19,0.3l0.16,0.69l0.19,0.21l1.77,0.15l0.8,-0.12l0.49,-0.28l0.54,0.18l0.6,0.64l0.59,0.18l0.57,-0.28l0.54,0.01l0.51,0.3l0.24,0.22l0.15,-0.01l1,-0.97l1.21,-0.86l1.61,-0.94l0.94,-0.42l0.26,0.1l1.49,-0.31l1.34,-0.03l1.77,0.19l1.64,-0.22l1.51,-0.63l1.34,-0.35l1.17,-0.07l0.44,0.18l-0.28,0.43l-0.15,0.73l-0.02,1.03l-0.1,0.65l-0.18,0.27l-0.02,0.26l0.14,0.25l1.13,0.16l0.6,0.33l0.68,0.02l0.77,-0.3l0.59,0.11l0.41,0.53l0.6,0.1l0.57,-0.38l0.41,-0.36l0.35,-0.16L883.33,479.64zM885.45,481.58l0,0.29l-0.29,-0.07l-0.24,-0.2l-0.19,-0.33l-0.24,-0.82l-0.37,-0.58l0.55,-0.66l0.33,-0.08l0.36,0.15l0.05,0.39l-0.26,0.62l0.02,0.64L885.45,481.58zM885.57,483.16l-0.13,0.08l-0.47,-0.53l-0.1,-0.32l0.07,-0.27l0.18,-0.01l0.3,0.25l0.17,0.29l0.04,0.33L885.57,483.16zM891.38,486.31l0.09,0.3l-0.23,0.44l-0.66,0.23l-1.34,-0.02l-0.87,-0.17l-0.4,-0.32l-0.09,-0.16l0.04,-0.35l0.19,-0.02l0.29,0.19l0.43,-0.08l0.57,-0.36l0.3,-0.27l0.03,-0.18l-0.18,-0.34l0.15,-0.14l0.71,0.13l0.27,0.22l0.48,0.76L891.38,486.31zM881.46,488.91l1.21,0.19l0.12,-0.1l0.34,0.36l0.05,0.3l-0.14,0.25l-0.21,0.14l-0.27,0.02l-0.43,-0.26l-0.71,-0.68L881.46,488.91zM879.53,489.29l0.67,0.25l1.21,0.83l1.15,0.48l1.08,0.14l0.79,0.29l0.5,0.45l0.36,0.5l0.22,0.55l0.52,0.31l0.81,0.07l0.64,0.23l0.47,0.4l2.59,1.03l1.08,0.54l0.6,0.53l0.17,0.34l-0.05,0.34l0.06,0.36l0.44,0.7l0.17,0.06l0.1,0.34l0.04,0.61l0.13,0.41l0.22,0.21l-0.13,0.09l-0.8,-0.35l-0.45,0.11l-0.21,0.46l-0.03,0.43l0.15,0.41l1.02,1.22l0.27,1.11l0.05,1.35l-0.13,0.52l-0.11,1.15l-0.08,1.78l-0.02,0.61l-0.34,0.59l-0.91,0.85l-0.01,-0.16l-0.22,-0.04l-0.24,0.13l-0.33,0.73l-0.28,1.33l-0.34,0.72l-0.4,0.11l-0.24,0.19l-0.08,0.27l-0.43,0.18l-0.79,0.09l-0.54,0.4l-0.4,1.13l0.02,0.54l-0.19,0.68l0.01,0.58l0.21,0.48l0.64,0.48l1.06,0.48l0.63,0.07l0.44,-0.2l0.46,-0.79l0.44,-0.31l0.54,-0.13l0.2,-0.36l0.89,-1.57l0,-0.35l-0.32,-0.13l0.05,-0.1l0.42,-0.06l0.36,-0.21l0.31,-0.36l0.54,-0.27l1.32,-0.41l0.71,-0.47l0.45,-0.08l0.65,0.25l0.85,0.58l0.67,0.84l0.5,1.1l0.63,2.85l0.76,4.59l0.52,2.56l0.28,0.55l0.14,0.27l-0.67,3.56l-0.54,1.47l-0.94,0.85l-0.93,0.82l-1.16,1.38l-1.28,0.68l-0.65,0.4l-0.14,0.26l-0.16,-0.08l-0.35,0.75l-0.31,1.03l-0.12,0.8l0.11,0.44l-0.27,0.28l-0.48,0.52l-0.09,0.19l0.03,0.31l-0.1,0.15l-0.23,-0.01l-0.18,0.15l-0.43,0.55l-0.74,1.43l-0.12,0.26l-0.09,0.08l-3.13,0.12l-3.13,0.12l-3.13,0.12l-3.13,0.12l0,-0.73l-2.85,0l-2.85,0l-2.85,0l-2.85,0l-2.85,0l-2.85,0l-2.33,0l0.61,-0.35l1,-0.81l0.56,-0.73l0.54,-0.96l0.52,-1.19l1.06,-1.79l0.52,-1.08l0.5,-1.37l0.38,-1.44l0.25,-1.51l0.12,-1.57l-0.01,-1.63l-0.25,-1.64l-0.49,-1.66l-0.27,-0.85l-0.1,-0.23l-0.89,-2.13l-1.01,-2.98l0.02,-0.25l0.94,-1.78l0.02,-0.24l-0.1,-1.45l-0.2,-0.73l-0.48,-0.98l0.02,-0.25l0.98,-1.25l0.59,-0.95l0.53,-1.16l0.35,-1.35l0.16,-1.55l0,-1.03l-0.17,-0.52l0.02,-0.4l0.21,-0.28l1.05,-0.36l0.35,-0.61l0.08,-1.08l0.22,-0.54l0.35,0.01l0.33,-0.22l0.3,-0.45l0.4,-0.13l0.5,0.2l0.69,-0.67l0.89,-1.54l0.69,-0.86l0.48,-0.18l0.09,0.14l-0.3,0.46l-0.09,0.51l0.12,0.55l-0.1,0.53l-0.22,0.73l0.14,0.23l-0.38,1.17l-0.02,0.58l0.23,0.44l0.28,-0.15l0.32,-0.75l0.1,-0.4l-0.13,-0.05l0.05,-0.32l0.23,-0.59l0.2,-0.28l0.17,0.03l0.05,0.32l-0.08,0.61l-0.51,1.45l-0.1,0.44l0.11,0.12l0.61,-0.9l0.51,-1.44l0.39,-1.11l0.07,-0.6l-0.12,-1.56l0.02,-0.64l0.15,-0.44l0.53,-0.5l0.91,-0.56l0.9,-0.3l0.89,-0.04l0.62,-0.15l0.35,-0.27l-0.12,-0.21l-0.6,-0.16l-0.45,-0.35l-0.31,-0.54l-0.1,-0.62l0.1,-0.7l0.38,-0.69l0.66,-0.67l0.21,-0.49l-0.24,-0.32l0.28,-0.11l0.81,0.09l0.56,-0.09l0.32,-0.27L879.53,489.29zM872.1,491.84l-0.32,0.07l-0.25,-0.16l0.04,-0.63l0.33,-1.1l0.32,-0.5l0.44,0.2l-0.09,0.13l0.09,1.17l-0.16,0.52L872.1,491.84zM868.1,498.52l-0.11,0.19l-0.26,-0.02l-0.21,-0.18l-0.2,-0.58l0.07,-0.13l0.51,0.08l0.18,0.25L868.1,498.52z" data-jurisdiction="MI" id="MI" title="Michigan"></path>
<path class="land" d="M798.43,450.27l1.13,-0.17l0.97,0.05l0.98,0.08l0.52,0.12l1.5,0.62l0.98,0.51l1.41,0.95l0.78,0.42l0.37,0.98l0.44,1.26h0.62l0.47,-0.74l1.19,-0.13l1.57,0.52l1.38,1.47l1.99,1.31l1.21,0.65l1.23,0l1.57,-0.65l1.67,-1.25l1.2,-0.22l0.71,0.12l0.4,0.98l0.5,0.37l1.29,-0.11l2.7,0.19l2.15,-0.27l0.49,0.56l0.44,0.88l0.87,0.28l1.18,-0.28l1.86,0.19l-0.26,0.14l-0.27,-0.03l-0.36,0.21l-0.45,0.45l-1.03,0.64l-1.61,0.84l-1.86,0.77l-3.77,1.38l-2.35,1.43l-1.04,0.86l-4.04,4.28l-2.44,2.27l-3.95,3.18l-0.37,0.4l-0.02,0.37l-0.17,-0.01l-0.65,0.77l-0.28,0.49l-0.64,0.14l0,1.97l0,1.96l0,1.96l0,1.95l-0.31,0.2l-0.39,0.46l-0.54,0.11l-2.53,1.6l-0.42,0.46l-0.45,1.07l-0.83,1.2l-0.2,0.64l0.04,0.86l1.27,0.69l0.48,0.66l0.23,0.81l-0.03,0.7l-0.64,1.37l-0.11,0.55l0.07,1.68l-0.32,0.52l0.26,1.35l0.02,0.47l-0.2,1.48l-0.14,0.43l0.25,0.77l0.03,0.08l1.19,1.06l1,0.59l0.9,0.19l0.7,0.45l0.51,0.72l0.69,0.47l0.86,0.22l0.88,0.6l1.35,1.46l0.67,1.24l1.17,0.89l1.9,0.94l1.24,0.83l0.59,0.71l0.39,1.81l0.31,3.82l-3.11,0.01h-3.06l-3.06,0l-3.06,0h-3.06l-3.06,0l-3.06,0h-3.06l-3.06,0l-3.06,0h-3.06l-3.06,0l-3.06,0l-3.06,0h-3.06l-3.06,0V516.6v-2.92v-2.93v-2.94v-2.95v-2.96v-2.98v-2.99l-0.72,-0.99l-1.56,-0.8l-0.39,-0.48l-0.73,-1.2l-0.29,-0.51l-0.05,-0.4l0.35,-0.44l1.42,-1.3l0.45,-0.6l0.22,-0.58l0.33,-1.34l-0.13,-1.03l0.09,-1.61l-0.29,-1.21l-0.06,-0.6l-0.18,-0.75l-1.07,-1.98l-0.26,-1.6l-0.27,-0.79l-0.09,-2.04l0.03,-0.57l0.21,-1.11l-0.45,-0.75l-0.07,-0.61l-0.21,-4.9l-0.14,-0.7l0.04,-2.28l-0.82,-2.41l-0.39,-0.82l-0.2,-1l0.02,-0.48l-0.67,-1.65l-0.45,-1.83l0.04,-1.59l-0.14,-1.2l0.06,-0.94l-0.12,-1.41l0.14,-0.8l0.01,-1.25l-0.92,-4.45h1.15h4.01h4.01h4.01h4.01l2.22,0.02l0.04,-3.03l0.03,-2.4l2.03,0.29l0.61,0.44l0.19,0.21l-0.06,0.66l0.17,2l0.37,1.67l0.85,1.99l0,0.01l0.07,0.78l0.28,0.49l0.51,0.45l1.95,0.55l3.38,0.64l1.92,0.73l0.45,0.83l0.9,0.33l1.35,-0.16l0.95,-0.35L798.43,450.27zM798.43,450.27l-0.04,0.01l0.05,-0.01L798.43,450.27z" data-jurisdiction="MN" id="MN" title="Minnesota"></path>
<path class="land" d="M816.65,558.88L816.1,560.77L816.09,562.34L816.41,564.24L816.8,565.66L817.24,566.6L818.83,568.39L821.57,571.01L823.28,573.49L823.98,575.84L824.79,576.78L825.72,576.32L826.89,576.53L828.15,576.92L828.81,577.38L828.96,577.54L829.03,577.71L828.98,577.88L828.8,578.33L827.24,582.21L826.7,583.98L826.78,584.64L827.41,585.6L828.59,586.85L829.62,587.66L830.51,588.04L831.89,589.05L833.77,590.67L834.71,591.89L834.71,592.7L834.9,593.53L835.29,594.38L835.29,595.18L834.9,595.95L835.05,596.98L835.74,598.28L836.32,599.07L836.8,599.34L836.91,599.34L836.94,599.22L836.88,599.04L836.85,598.88L836.89,598.66L836.99,598.57L837.07,598.55L837.52,598.87L838.18,599.58L838.48,600.52L838.42,601.7L838.16,602.82L837.73,603.87L837.23,604.23L837,604.17L836.52,603.98L836.33,604.04L835.9,604.31L835.4,605.33L835.38,605.36L835.2,605.46L835.07,605.36L835.05,605.3L834.96,605L834.75,604.69L834.59,604.69L834.46,604.72L834.41,604.86L834.36,605.18L834.39,605.32L834.55,606.19L834.41,606.81L833.95,607.06L833.88,607.41L834.14,607.81L834.14,607.99L834.04,608.14L833.73,608.18L833.48,608.27L833.29,608.59L833.67,609.2L833.59,609.93L833.07,610.79L833,611.13L831.28,611.15L829.73,611.18L828.18,611.2L826.64,611.23L827.37,609.99L827.85,609.55L828.19,609.08L828.82,608.64L829.51,607.7L829.59,607.26L829.52,606.83L829.11,606.24L828.7,605.32L826.07,605.32L823.45,605.32L820.83,605.32L818.21,605.32L815.59,605.32L812.97,605.32L810.34,605.32L807.72,605.32L805.1,605.32L802.48,605.32L799.86,605.32L797.23,605.32L794.61,605.32L791.99,605.32L789.37,605.32L786.75,605.32L786.75,603.87L786.75,602.4L786.75,600.94L786.75,599.48L786.75,597.94L786.74,596.41L786.74,594.87L786.74,593.34L786.73,591.79L786.73,590.25L786.72,588.7L786.72,587.15L786.72,585.6L786.71,584.04L786.71,582.49L786.7,580.92L786.7,579.36L786.7,577.79L786.69,576.22L786.69,574.65L786.71,574.19L785.25,573.35L784.59,572.56L784.26,571.54L783.6,570.53L782.61,569.53L782.45,568.45L783.11,567.31L783.67,566.72L784.11,566.7L784.16,566.21L783.81,565.23L783.31,564.87L782.63,565.12L782.06,565.1L779.89,563.52L779.74,563.41L779.07,562.36L778.79,561.11L778.25,560.29L777.44,559.91L776.93,559.09L776.71,557.81L776.19,556.52L775.95,556.14L778.3,556.13L780.68,556.11L783.05,556.09L785.43,556.07L787.8,556.05L790.18,556.04L792.55,556.02L794.93,556L797.3,555.98L799.68,555.97L802.05,555.95L804.42,555.93L806.8,555.91L809.17,555.89L811.55,555.88L813.92,555.86L814.39,556.76L814.9,557.02L815,557.31L815.67,557.77L815.82,558.23z" data-jurisdiction="MO" id="MO" title="Missouri"></path>
<path class="land" d="M847.42,622.67l0.83,0.75l-0.03,0.27l-0.01,0.18l-0.06,0.54l-0.23,2.11l-0.23,2.1l-0.23,2.1l-0.23,2.09L847,634.9l-0.23,2.08l-0.23,2.08l-0.23,2.07l-0.23,2.07l-0.23,2.07l-0.23,2.06l-0.23,2.06l-0.23,2.05l-0.23,2.05l-0.23,2.05l-0.23,2.04l0.1,2.07l0.1,2.07l0.1,2.06l0.1,2.06l0.1,2.05l0.1,2.05l0.1,2.04l0.12,2.24l-2.75,0.17l-1.2,-0.56l-0.5,-0.11l-0.3,0.01l-1.4,0.51l-1.6,0.39l-0.37,-0.12l-0.54,-0.02l-1.16,1.33l-0.73,0.33l-0.23,-0.09l-0.26,-0.09l-0.18,-0.15l-0.35,-0.79l-0.11,-0.57l-0.42,-1.24l-0.48,-0.69l-0.54,-0.46l-0.24,-0.46l0,-0.31l-0.17,-0.55l0.03,-0.44l0.66,-1.69l0.28,-1.26h-2.26h-2.26l-2.26,0h-2.26h-2.26h-2.26h-2.26l-2.25,-0.01l0.04,-0.3l0.39,-0.39l0.14,-0.49l-0.32,-1.18l0.12,-0.65l0.56,-0.12l0.28,-0.63v-1.14l0.22,-0.77l0.44,-0.4l0.42,-0.93l0.4,-1.47l0.81,-1.22l1.22,-0.96l0.6,-0.83l0.04,-0.64l0.13,-0.3l0.25,-0.16l0.41,-0.44l0.54,-0.6l0.1,-0.41l-0.03,-0.28l-0.04,-0.31l-0.43,-0.56l-0.65,-0.47l-0.42,-0.74l0.03,-0.56l-0.14,-0.5l-0.31,-0.43l0.07,-0.4l0.45,-0.37l0.02,-0.35l-0.41,-0.33l0,-0.59l0.4,-0.85l-0.02,-0.59l-0.45,-0.33l-0.05,-0.55l-0.03,-0.28l0.43,-1.98l-0.1,-0.26l-0.43,-0.6l-0.05,-0.73l0.26,-0.89l-0.12,-0.69l-0.36,-0.25l-0.09,-0.28l-0.11,-0.41l0.39,-0.37l0.02,-0.35l-0.35,-0.32l0.22,-0.45l0.79,-0.58l0.22,-0.33l0.23,-0.35l0.14,-0.83l-0.11,-0.49l-0.19,-0.33l0.09,-0.17l0.16,-0.15l0.94,-0.3l0.27,-0.21l0.06,-0.26l-0.3,-0.64l0.29,-0.68l0.87,-0.72l0.46,-0.63l0.06,-0.55l0.42,-0.4l0.78,-0.25l0.48,-1.02l0.19,-1.79l0.23,-0.76l0.4,-0.11l0.21,-0.25l0.07,-0.52l0.49,-0.53l0.9,-0.54l0.36,-0.53l-0.11,-0.28l0,-0.35l2.4,0l2.5,0l2.5,0l2.5,0l2.5,0l2.5,0l2.5,0L847.42,622.67zM843.8,675.89l-0.12,0.12l-0.83,-0.23l-0.51,-0.21l-0.09,-0.21l1.4,0.38L843.8,675.89z" data-jurisdiction="MS" id="MS" title="Mississippi"></path>
<path class="land" d="M698.33,487.26L698.34,490.39L698.36,493.51L698.37,496.61L698.39,499.7L698.39,499.74L698.39,499.78L698.38,499.82L698.38,499.86L698.31,499.86L698.23,499.86L698.16,499.86L698.08,499.86L696.02,499.86L693.96,499.86L691.89,499.86L689.83,499.86L687.77,499.86L685.7,499.86L683.64,499.86L681.58,499.86L679.51,499.86L677.45,499.86L675.39,499.86L673.32,499.86L671.26,499.86L669.2,499.86L667.13,499.86L665.07,499.86L663.01,499.86L660.94,499.86L658.88,499.86L656.82,499.86L654.76,499.86L652.69,499.86L650.63,499.86L648.57,499.86L646.5,499.86L644.44,499.86L642.38,499.86L640.31,499.86L638.25,499.86L636.19,499.86L634.12,499.86L632.06,499.86L632.06,501.53L632.06,503.19L632.06,504.84L632.05,506.5L631.43,506.15L631.02,505.75L630.68,505.29L630.04,504.01L629.68,503.54L629.36,503.26L629.03,503.24L628.63,503.4L628.32,503.7L628.22,504.23L627.92,504.85L627.94,505.37L628.07,505.63L628.03,505.78L627.83,505.89L626.33,505.7L625.03,505.96L624.14,505.76L622.43,505.86L620.95,505.68L620.44,505.77L620.11,506.05L619.7,506.75L619.59,506.88L619.43,506.9L617.02,506.52L616.39,506.51L615.72,506.97L615.5,507.3L615.45,507.72L615.3,507.84L615.09,507.82L614.55,507.54L613.99,507.08L613.71,506.74L613.65,505.97L613.2,505.1L613.12,504.31L612.83,503.65L612.39,502.98L611.95,502.55L611.51,502.4L610.7,502.49L610.52,502.42L609.64,501.55L609.37,501.16L609.29,500.81L609.59,499.96L609.5,499.49L609.28,498.91L608.97,498.43L608.46,498.01L608,497.1L607.15,495.82L606.92,494.83L606.59,494.01L606.5,493.18L606.18,492.68L606.21,492.04L606.16,491.86L606.06,491.78L605.49,491.42L604.84,490.78L604.51,490.64L604.37,490.63L604.29,490.79L604.24,491.09L603.2,492.15L602.32,492.65L601.89,493.14L601.5,493.38L601.29,493.41L601,493.25L600.08,492.53L599.32,492.2L599.24,492.04L599.28,491.43L599.63,490.72L599.27,489.43L599.38,488.98L599.66,488.67L600.48,488.19L600.56,487.96L600.38,486.73L599.92,486.27L599.79,486.01L599.93,485.01L599.73,484.35L600.09,483.79L600.12,482.83L600.41,481.84L600.72,480.35L600.65,479.71L601.04,479.02L601.17,478.32L601.19,477.83L601.13,477.53L600.99,477.42L600.71,477.42L599.42,477.69L599,477.65L598.64,477.52L598.42,477.28L598.36,476.72L598.07,476.35L597.92,476.29L597.33,476.52L597.2,476.5L597.14,476.4L596.9,475.92L595.95,474.99L595.49,473.92L594.57,472.98L593.69,471.69L592,469.67L591.59,469.26L590.31,468.56L589.3,467.54L588.27,466.81L588.17,466.69L588.16,466.61L588.22,466.55L588.51,466.35L588.58,465.98L588.19,465.22L588.38,464.46L588.12,463.42L587.98,463.07L587.25,462.1L586.77,461.17L586.02,460.31L585.01,458.9L585.01,455.42L585.01,451.93L585.02,448.42L585.01,444.9L586.75,444.9L590.76,444.9L594.78,444.9L598.79,444.9L602.8,444.9L603.71,444.9L606.82,444.9L610.83,444.9L614.85,444.9L618.86,444.9L622.87,444.9L626.89,444.9L630.9,444.9L634.91,444.9L638.93,444.9L641.96,444.9L642.94,444.9L646.96,444.9L650.97,444.9L654.98,444.9L659,444.9L663.01,444.9L667.02,444.9L671.04,444.9L675.05,444.9L679.06,444.9L683.08,444.9L687.09,444.9L691.11,444.9L695.12,444.9L698.11,444.9L698.13,447.61L698.15,450.32L698.16,453.02L698.17,455.72L698.19,458.4L698.2,461.07L698.21,463.73L698.22,466.38L698.24,469.03L698.25,471.66L698.26,474.28L698.28,476.9L698.29,479.5L698.3,482.1L698.32,484.68z" data-jurisdiction="MT" id="MT" title="Montana"></path>
<path class="land" d="M962.33,604.73l-0.25,0.91l0.14,0.52l0.5,0.54l0.55,1.34l0.44,1.8l-0.59,-0.73l-0.63,-0.39l-0.98,-0.3l-0.88,-0.52l0.06,0.75l-0.08,0.81l-0.67,-0.25l-0.46,-0.27l0.41,0.86l-0.88,-0.26l-0.59,0.05l-0.38,0.76l-0.51,0.46l-0.76,0.15l-1.12,-0.69l-0.36,-0.84l-0.15,-0.94l-0.06,1.11l0.2,1.16l-0.07,0.88l1.08,0.16l1.01,-0.14l1.37,0.04l0.89,-0.16l0.54,-0.28l1.29,0.24l0.09,1.06l-0.15,1.05l-0.07,1.12l0.36,-0.01l0.42,-0.36l0.21,-2.01l1.18,-0.74l0.39,0.05l0.38,0.65l0.13,0.66l0.13,0.9l-0.28,1.37l-1.81,1.6l-1.29,1.47l-0.66,0.3l-0.95,-0.17l-1.08,-0.37l-0.53,-0.07l-0.4,0.12l-0.25,-0.45l-0.16,-0.83l-0.42,-0.28l-0.32,0.03l-0.22,0.88l-1.01,0.25l-1.37,-0.36l-1.44,-0.74l0.62,0.79l3.57,1.48l0.4,0.28l0.38,0.4l-0.5,0.63l-0.39,0.71l-0.06,0.56l-0.14,0.35l-1.42,0.95l-0.77,-0.17l-1.97,-1.71l0.9,1.48l0.72,0.63l1.45,0.34l2.71,-0.55l0.89,0.6l-0.73,1.07l-0.73,0.75l-0.95,0.08l-0.84,0.2l-0.24,0.52l-0.6,0.03l-0.93,0.03l-1.44,0.05l-0.79,-0.12l-1.11,1.05l-0.42,0.14l-0.58,-0.2l-0.24,-0.84l-0.26,-0.41l-0.01,1.58l0.1,0.43l0.21,0.32l-1.3,0.86l-1.24,1.07l-0.44,0.29l-0.51,0.53l-1.04,1.54l-0.26,1.12l-0.37,1.25l-0.05,-0.56l0.06,-0.95l-0.26,-1.08l-0.16,1.99l-0.4,0.92l-3.69,-0.06l-1.49,0.46l-1.35,-1.37l-1.27,-1.29l-1.27,-1.29l-1.27,-1.29l-1.27,-1.3l-1.27,-1.3l-1.27,-1.3l-1.27,-1.3l-1.33,-0.05l-1.33,-0.04l-1.33,-0.05l-1.33,-0.04l-1.33,-0.05l-1.33,-0.04l-1.33,-0.05l-1.33,-0.04l-0.05,-0.9l-0.04,-0.64l-0.83,-1.09l-0.49,-0.64l-1.05,0.55l-0.06,-0.27l0.04,-0.48l-0.09,-0.17l-0.29,-0.12l-1.49,-0.07l-1.49,-0.06l-1.49,-0.07l-1.49,-0.06l-1.49,-0.06l-1.49,-0.07l-1.49,-0.06l-1.49,-0.06l-0.34,-0.11l-0.67,0.38l-1.77,0.57l-0.87,0.5l-0.32,-0.03l-1.5,0.49l-1.5,0.49l-0.17,0l-2.85,0.04l-2.85,0.04l-2.85,0.04l-2.85,0.04l0.35,-2.44l0.24,-0.56l0.27,-0.13l0.98,-0.01l0.62,-0.28l0.55,-1.47l1.25,-1.16l0.56,-0.29l0.84,-0.23l1.99,-0.28l2.14,-1.13l1.54,-1.07l1.23,-0.3l0.38,-0.39l0.28,-0.51l0.17,-0.7l0.13,-0.15l0.71,0.05l0.54,-0.61l0.52,-0.35l0.52,-0.2l0.32,-0.01l0.12,0.18l0.09,0.52l0.11,0.17l0.22,0.02l0.3,-0.12l0.4,-0.33l1.04,-1.04l0.69,-0.4l1.06,-0.23l0.77,0.55l0.46,-0.19l1.35,-2.13l0.54,-0.39l0.4,-0.15l0.7,-0.03l0.01,-0.59l0.24,-0.89l0.03,-0.61l0.43,-0.89l0.16,0.18l3.41,0.03l3.41,0.03l3.41,0.03l3.41,0.03l3.41,0.03l3.41,0.03l3.41,0.03l3.41,0.03l3.41,0.03l3.41,0.03l3.41,0.03l3.41,0.03l3.41,0.03l3.41,0.03l3.41,0.03L962.33,604.73zM963.06,604.75l0.3,0l0.94,3.74l1.88,4.06l0.23,0.7l-0.44,-0.61l-1.39,-2.68l-0.77,-1.94L963.06,604.75zM965.44,612.81l-0.14,0.24l-0.62,-1.28l0.64,0.41l0.11,0.34L965.44,612.81zM966.3,619.91l-1.26,0.31l-0.11,-0.1l1.45,-0.65l0.46,-2.31l0.06,-1.07l-0.22,-1.88l0.01,-0.39l0.24,0.61l0.21,1.76l-0.08,1.33l-0.42,1.94L966.3,619.91zM964.06,620.48l-1.71,0.82l-0.19,-0.05l1.12,-0.59L964.06,620.48zM957.27,626.73l-0.23,0.13l0.86,-1.42l1.7,-1.81l0.46,-0.28l-1.41,1.55L957.27,626.73zM956.87,626.6l-0.21,0.03l-0.37,-0.13l-0.51,-0.24l-0.11,-0.18l0.49,0.06L956.87,626.6z" data-jurisdiction="NC" id="NC" title="North Carolina"></path>
<path class="land" d="M768.5,487.26L766.31,487.26L764.12,487.26L761.93,487.26L759.73,487.26L757.54,487.26L755.35,487.26L753.15,487.26L750.96,487.26L748.77,487.26L746.57,487.26L744.38,487.26L742.19,487.26L740,487.26L737.8,487.26L735.61,487.26L733.42,487.26L731.22,487.26L729.03,487.26L726.84,487.26L724.64,487.26L722.45,487.26L720.26,487.26L718.07,487.26L715.87,487.26L713.68,487.26L711.49,487.26L709.29,487.26L707.1,487.26L704.91,487.26L702.72,487.26L700.52,487.26L698.33,487.26L698.32,484.68L698.3,482.1L698.29,479.5L698.28,476.9L698.26,474.28L698.25,471.66L698.24,469.03L698.22,466.38L698.21,463.73L698.2,461.07L698.19,458.4L698.17,455.72L698.16,453.02L698.15,450.32L698.13,447.61L698.11,444.9L699.13,444.9L703.15,444.9L707.16,444.9L711.18,444.9L715.19,444.9L719.2,444.9L723.22,444.9L727.23,444.9L731.24,444.9L735.26,444.9L739.27,444.9L743.29,444.9L747.3,444.9L751.31,444.9L755.33,444.9L759.34,444.9L762.2,444.9L763.12,449.35L763.11,450.6L762.97,451.4L763.1,452.81L763.04,453.74L763.18,454.94L763.14,456.53L763.59,458.36L764.26,460.01L764.24,460.49L764.44,461.48L764.83,462.3L765.66,464.72L765.62,467L765.76,467.7L765.97,472.6L766.04,473.21L766.49,473.96L766.28,475.07L766.25,475.65L766.34,477.68L766.6,478.47L766.86,480.08L767.93,482.06L768.11,482.81L768.17,483.41L768.46,484.62L768.37,486.23z" data-jurisdiction="ND" id="ND" title="North Dakota"></path>
<path class="land" d="M769.21,532.21L769.5,532.27L770.13,533.4L770.39,535.4L770.96,537.01L771.85,538.23L772.29,539.12L772.29,539.69L772.51,540.29L772.93,540.94L773.09,542.03L773.01,543.58L773.19,544.4L773.63,544.5L773.83,544.71L773.77,545.05L773.91,545.3L774.27,545.46L774.37,545.9L774.22,546.63L774.34,547.08L774.76,547.27L774.84,547.63L774.58,548.15L774.62,548.57L774.96,548.87L775.19,550.21L775.3,552.58L775.27,553.96L775.07,554.37L775.38,555.22L775.95,556.14L776.19,556.52L776.71,557.81L776.93,559.09L777.44,559.91L778.25,560.29L778.79,561.11L779.07,562.36L779.74,563.41L779.89,563.52L778.19,563.52L776.22,563.52L774.25,563.52L772.28,563.52L770.3,563.52L768.33,563.52L766.36,563.52L764.38,563.52L762.41,563.52L760.44,563.52L758.46,563.52L756.49,563.52L754.52,563.52L752.55,563.52L750.57,563.52L748.6,563.52L746.63,563.52L744.65,563.52L742.68,563.52L740.71,563.52L738.73,563.52L736.76,563.52L734.79,563.52L732.81,563.52L730.84,563.52L728.87,563.52L726.9,563.52L724.92,563.52L722.95,563.52L720.98,563.52L719,563.52L717.03,563.52L717.03,561.99L717.03,560.46L717.03,558.92L717.03,557.39L717.03,555.84L717.03,554.3L717.03,552.75L717.02,551.2L714.68,551.2L712.33,551.2L709.98,551.2L707.63,551.2L705.28,551.2L702.93,551.2L700.58,551.2L698.23,551.2L698.22,548.08L698.21,544.96L698.2,541.82L698.2,538.67L698.19,535.51L698.18,532.33L698.17,529.15L698.16,525.95L701.42,525.95L704.68,525.95L707.94,525.95L711.19,525.95L714.45,525.95L717.71,525.95L720.97,525.95L724.23,525.95L727.48,525.95L730.74,525.95L734,525.95L737.26,525.95L740.52,525.95L743.78,525.95L747.03,525.95L750.76,525.95L753.57,527.86L755.24,528.45L756.04,527.89L757.76,527.57L760.41,527.49L762.08,527.75L762.78,528.35L764.14,529.03L766.17,529.78L767.38,530.6L767.78,531.48L768.49,532.03z" data-jurisdiction="NE" id="NE" title="Nebraska"></path>
<path class="land" d="M1011.59,525.06L1011.17,526.73L1010.9,527.54L1009.8,527.48L1009.32,527.61L1008.36,528.2L1007.77,528.42L1006.8,529.42L1005.98,529.77L1004.64,529.73L1003.3,529.68L1001.96,529.64L1000.62,529.59L999.29,529.55L997.95,529.5L996.61,529.46L995.27,529.41L995.11,528.96L994.59,528.15L994.46,527.8L994.49,527.42L994.78,526.39L994.99,526.07L995.21,525.47L995.54,523.08L995.83,521.69L996.04,519.15L996.26,518.4L996.49,517.94L996.87,516.74L997.57,515.75L998.03,514.54L998.58,513.48L998.67,512.86L999.08,511.51L999.37,509.1L999.65,508.72L1000.91,508.39L1001.31,508.14L1002.65,507.14L1003.07,506.72L1003.34,506.3L1003.55,505.62L1003.7,505.44L1003.73,505.07L1003.26,503.48L1003.24,502.9L1004.28,501.09L1004.06,500.04L1004.21,499.78L1005.14,497.22L1006,496.02L1007.18,496.42L1007.81,496.38L1008.28,495.97L1008.35,497.29L1008.42,498.76L1008.5,500.23L1008.57,501.7L1008.64,503.17L1008.71,504.63L1008.78,506.09L1008.86,507.55L1008.93,509L1009,510.45L1009.07,511.9L1009.15,513.35L1009.22,514.79L1009.29,516.23L1009.36,517.67L1009.43,519.11L1009.39,520.06L1009.5,520.95L1009.84,521.74L1010.69,522.89L1010.84,523.86z" data-jurisdiction="NH" id="NH" title="New Hampshire"></path>
<path class="land" d="M981.69,551.3l-0.16,0.97l-0.93,1.96l-0.39,0.45l-0.46,0.4l-0.35,0.17l-0.32,0.31l-0.37,0.49l-0.35,0.98l0.21,0.89l1.81,0.33l0.48,-0.28l0.25,0.64l0.14,0.89l-0.14,0.96l-0.3,0.97l-0.23,1.21l-0.19,1.84l-0.29,1.65l-0.04,-0.5l0.18,-2l-0.29,0.21l-0.2,0.46l-0.55,2.58l-0.76,1.37l-0.7,0.95l-0.72,-0.16l0.16,0.75l-0.2,0.39l-0.17,0.82l-0.43,0.54l-0.4,-0.05l-0.58,0.37l-0.23,0.28l-0.02,0.55l-0.39,0.48l-1.4,2.49l-1.21,0.73l-0.29,-0.11l0.32,-1.17l0.22,-1.19l-0.74,-0.52l-0.7,-0.27l-0.81,0.04l-0.89,-0.92l-1.15,-0.67l-1.61,-1.82l0.05,-0.51l-0.04,-0.85l0.49,-1.35l0.47,-0.94l0.65,-0.49l1.88,-0.5l0.47,-0.75l0.28,-0.63l0.48,-0.42l1.08,-0.76l1.64,-0.92l-2.27,-3.09l-0.54,-0.18l-0.6,-1.51l-0.69,-0.41l-0.17,-0.23l-0.03,-1.16l0.06,-0.67l0.1,-0.39l0.59,-0.33l0.34,-0.67l0.01,-0.35l-0.45,-1.08l0,-0.34l0.86,-0.66l1.12,-1.29l0.67,-1.41l0.27,-0.41l0.33,-0.29l0.74,-0.4l0.93,0.57l0.93,0.57l0.93,0.57l0.93,0.57l0.93,0.57l0.93,0.57l0.93,0.57L981.69,551.3zM979.59,567.44l-1.1,1.84l-0.02,-0.35l1.38,-2.29L979.59,567.44z" data-jurisdiction="NJ" id="NJ" title="New Jersey"></path>
<path class="land" d="M707.84,605.32L707.45,605.33L707.44,608.6L707.42,611.86L707.41,615.11L707.4,618.34L707.38,621.57L707.37,624.78L707.35,627.99L707.34,631.18L707.33,634.36L707.31,637.53L707.3,640.69L707.28,643.84L707.27,646.98L707.26,650.11L707.24,653.23L707.23,656.34L705.11,656.34L703,656.34L700.88,656.35L698.77,656.35L696.65,656.35L694.53,656.35L692.42,656.35L690.3,656.35L688.19,656.35L686.07,656.35L683.95,656.35L681.84,656.35L679.72,656.36L677.6,656.36L675.49,656.36L673.37,656.36L673.32,656.36L674.28,658.36L674.27,658.36L675.41,658.93L675.34,658.91L673.27,658.9L671.2,658.88L669.13,658.87L667.06,658.86L664.99,658.85L662.92,658.83L660.85,658.82L658.78,658.81L658.78,660.05L658.77,661.28L658.77,662.52L658.76,663.75L655.43,663.76L652.11,663.77L650.92,663.77L650.92,659.87L650.92,655.96L650.92,652.03L650.92,648.09L650.92,644.13L650.92,640.16L650.92,636.17L650.92,632.16L650.92,628.14L650.92,624.1L650.92,620.04L650.92,615.97L650.92,611.87L650.92,607.76L650.93,603.63L650.93,599.48L654.48,599.48L658.04,599.48L661.6,599.48L665.15,599.48L668.71,599.48L672.27,599.48L675.83,599.48L679.38,599.48L682.94,599.48L686.5,599.48L690.05,599.48L693.61,599.48L697.17,599.48L700.73,599.48L704.28,599.48L707.84,599.48L707.84,600.94L707.84,602.4L707.84,603.86z" data-jurisdiction="NM" id="NM" title="New Mexico"></path>
<path class="land" d="M603.92,599.44L603.91,604.02L603.89,609.04L603.72,609.11L603.17,610.26L602.57,610.79L602.11,610.78L601.65,610.45L601.18,609.8L600.48,609.42L599.54,609.33L598.72,609.43L598,609.73L597.56,610.16L597.32,610.99L597.4,611.33L597.83,612.1L597.86,613.3L597.92,614.27L598.18,614.8L598.22,615.42L598.07,616.4L598.19,617.2L598.73,618.61L598.55,622.68L598.55,622.76L595.99,620.33L593.6,618.06L591.21,615.78L588.82,613.49L586.43,611.2L584.04,608.9L581.65,606.6L579.26,604.28L577.54,602.67L575.81,601.06L574.08,599.45L572.36,597.83L570.63,596.21L568.91,594.58L567.18,592.95L565.46,591.32L563.25,589.38L561.04,587.44L558.84,585.49L556.64,583.54L554.43,581.58L552.23,579.62L550.02,577.66L547.82,575.69L547.82,573.42L547.82,571.15L547.81,568.87L547.81,566.59L547.81,564.3L547.81,562L547.81,559.7L547.81,557.39L547.81,555.07L547.81,552.75L547.81,550.42L547.81,548.09L547.81,545.75L547.81,543.4L547.81,541.04L547.81,538.68L551.32,538.68L554.83,538.68L558.34,538.68L561.85,538.68L565.37,538.68L568.88,538.68L572.39,538.68L575.9,538.68L579.4,538.68L582.9,538.68L586.4,538.67L589.9,538.67L593.4,538.67L596.9,538.67L600.4,538.67L603.9,538.67L603.9,540.64L603.9,542.6L603.9,544.56L603.9,546.52L603.9,548.47L603.9,550.41L603.9,552.35L603.9,554.28L603.9,556.22L603.9,558.14L603.9,560.06L603.91,561.98L603.91,563.89L603.91,565.8L603.91,567.71L603.91,569.6L603.91,571.5L603.91,573.39L603.91,575.28L603.91,577.16L603.91,579.04L603.91,580.91L603.91,582.78L603.91,584.65L603.91,586.51L603.91,588.37L603.92,590.22L603.92,592.07L603.92,593.92L603.92,595.76L603.92,597.6z" data-jurisdiction="NV" id="NV" title="Nevada"></path>
<path class="land" d="M987.87,529.13l-0.3,1.07l-0.3,1.07l-0.3,1.07l-0.3,1.07l-0.3,1.07l-0.3,1.07l-0.3,1.06l-0.3,1.06l0.25,0.31l-0.07,1.2l-0.08,1.2l-0.07,1.2l-0.07,1.19l-0.07,1.19l-0.08,1.19l-0.07,1.19l-0.07,1.19l0.28,0.48l0.28,0.48l-0.35,0.23l-0.55,0.35l-0.58,0.37l-0.76,0.48l0.39,0.62l0.49,0.78l-0.39,0.32l-1.01,1.09l-0.68,0.58l-0.56,0.19l-0.34,0.49l-0.37,0.32l0.36,-1.08l0.39,-0.91l0.33,-1.77l-0.1,-1.44l-0.4,-0.59l-0.42,-0.4l0.49,1.42l0.08,1.74l-0.01,0.05l-0.9,-0.56l-0.93,-0.57l-0.93,-0.57l-0.93,-0.57l-0.93,-0.57l-0.93,-0.57l-0.93,-0.57l-0.93,-0.57l-0.2,-0.47l-0.34,-0.36l-1.68,-0.63l-0.43,-0.42l-0.39,-0.57l-0.27,-0.69l-0.14,-0.73l-0.01,-0.58l0.12,-0.65l-0.39,-0.43l-0.01,-0.4l-0.25,-0.27l-1.1,-0.49l-0.33,-0.69l-0.73,-0.65l-1.3,0l-1.3,0l-1.3,0l-1.3,0l-1.3,0l-1.3,0l-1.3,0l-1.3,0l-1.3,0l-1.3,0l-1.3,0l-1.3,0l-1.3,0l-1.3,0l-1.3,0l-1.3,0l-1.3,0l-1.3,0l-1.3,0l-1.3,0l-1.3,0l-1.3,0l-1.3,0l-1.3,0l-1.3,0l-1.3,0l-1.3,0l-1.3,0l-1.3,0l-1.3,0l-1.3,0l-1.3,0v-1.7v-1.7v-0.07l0.56,-0.31l1.81,-1.15l0.9,-0.84l0.95,-0.7l1,-0.56l0.79,-0.71l0.59,-0.87l0.65,-0.65l0.71,-0.43l0.38,-0.45l0.05,-0.47l-0.13,-0.64l-0.31,-0.8l-0.04,-0.63l0.23,-0.46l0.05,-0.31l-0.13,-0.16l-1.49,-0.46l0.06,-2.21l-0.02,-0.06l0.08,-0.03l3.42,-0.98l2.18,-0.34l2.66,-0.09l3.17,0.48l1.23,0.44l0.78,0.56l0.9,0.15l1.02,-0.26l1.41,-0.09l1.81,0.09l0.97,0.13l0.13,0.18l0.12,-0.05l0.12,-0.28l0.48,-0.31l1.35,-0.47l0.18,0.1l0.28,-0.24l0.38,-0.57l0.69,-0.63l1.01,-0.69l0.91,-0.36l0.81,-0.03l0.54,-0.17l0.27,-0.31l0.09,-0.28l-0.1,-0.24l0.05,-0.26l0.05,-0.13l-0.04,-0.11l-0.1,-0.22l-0.08,-1.14l-0.16,-0.53l-0.22,-0.39l-0.28,-0.25l0.03,-0.27l0.49,-0.33l-0.04,0.31l0.13,0.09l0.23,-0.14l0.52,-0.68l0.06,-0.26l0.36,-0.27l0.26,-0.41l-0.29,-0.06l-0.69,0.12l-0.16,-0.12l0.36,-0.55l-0.07,-0.31l-0.11,-0.13l-0.23,-0.05l-0.78,0.48l-0.24,0.04l-0.03,-0.25l-0.4,-0.56l1.08,-1.01l3.82,-2.81l0.39,-0.43l0.14,-0.38l-0.1,-0.33l-0.11,-0.08l0.06,-0.08l3.68,-3.63l2.09,-1.68l1.73,-0.94l1.31,-0.45l0.89,0.06l0.51,-0.06l0.43,0l2.19,0l3.92,-0.01l3.92,-0.01l2.32,0l0.07,0.88l-0.19,1.04l0.16,1.13l-0.22,2.35l0.59,1.81l-0.14,1.21l0.04,1.3l-0.1,0.32l-0.46,0.75l-0.27,0.73l-0.15,0.74l0.01,0.48l0.4,2.12l0.08,0.93l-0.01,0.55l-0.35,1.74l-0.02,0.49l0.1,0.14l0.13,0l0.4,-0.54l0.18,-0.08l0.23,0.14l0.56,0.82l-0.03,1.47l-0.02,1.06l-0.02,1.18l-0.04,1.77l-0.03,1.29l-0.02,1.18l-0.02,0.9l-0.13,0.66L987.87,529.13zM960.97,509.41l-0.3,0.11l-0.07,-0.15l0.05,-0.15l0.25,-0.18l0.41,0l-0.05,0.14L960.97,509.41zM959.55,513.16l-0.14,0.04l0.02,-0.28l0.14,-0.18l0.28,-0.08l-0.01,0.14L959.55,513.16zM934.43,525.67l-0.29,0.44l-0.28,-0.04l-0.2,-0.14l-0.07,-0.28l0.05,-0.35l0.25,-0.15l0.68,0.13l0.02,0.14L934.43,525.67zM994.87,551.38l-0.67,0.8l0.6,0.08l0.52,-0.23l0.49,-0.48l1.15,-0.65l0.98,-0.28l0.31,-0.06l0.47,0.45l0.92,-0.36l0.95,-0.2l-4.1,2.07l-0.84,0.23l-1.2,0.61l-1.13,0.44l-0.82,0.16l-4.06,1.53l-0.32,0.03l-0.35,-0.15l-3.35,0.79l-1.37,0.09l-1.25,0.27l0.93,-0.63l0.02,-0.24l-0.22,-0.19l-0.49,0.05l-0.51,0.65l-0.81,0.22l-0.16,-0.71l0.27,-0.55l0.37,-0.52l0.8,-0.82l1.15,-0.52l0.58,-0.45l0.4,0.4l0.09,-0.54l0.31,-0.31l0.34,-0.17l0.81,0l0.44,-0.08l0.32,-0.18l0.33,-0.03l0.89,0.24l0.87,-0.07l0.7,-0.34l0.73,-0.11l1.93,-0.07l1.92,-0.25l0.77,-0.44l1.61,-1.23l0.93,-0.34l-1.44,1.43L994.87,551.38zM979.07,557.11l-0.45,0.05l0.45,-1.18l0.83,-0.54l0.3,0.11l0.01,0.42l-0.11,0.36l-0.55,0.55L979.07,557.11z" data-jurisdiction="NY" id="NY" title="New York"></path>
<path class="land" d="M919.47,555.58L918.36,556.12L918.15,556.62L918.49,557.25L918.67,558.07L918.69,559.07L918.07,561.27L916.79,564.65L916.15,566.77L916.13,567.64L915.29,568.77L913.64,570.17L912.47,571.01L911.81,571.3L911.25,571.28L910.81,570.94L910.31,571.17L909.75,571.97L909.24,572.38L908.76,572.4L908.35,572.92L908.01,573.92L907.69,574.5L907.39,574.65L907.37,575.16L907.62,576.02L907.6,576.33L907.46,576.34L907.33,576.29L907,576.48L906.64,576.97L906.5,576.97L906.4,576.89L906.3,576.27L906,575.82L905.52,575.56L904.85,576.14L903.99,577.56L903.62,578.48L903.77,579.12L903.84,580.05L903.62,580.43L903.16,580.57L902.79,581.08L902.54,581.94L901.89,582.49L900.85,582.72L899.76,582.32L899.68,582.29L898.39,581.21L897.58,580.17L897.24,579.18L896.12,579.13L894.2,580.04L892.76,580.17L891.78,579.55L891.05,579.3L890.32,579.51L889.62,579.91L889.04,579.67L888.32,578.93L887.19,578.41L885.64,578.12L884.56,577.31L883.97,576L883.33,575.09L882.66,574.59L881.91,574.45L881.11,574.65L880.49,574.55L880.05,574.13L879.49,574.18L878.97,574.58L878.98,570.56L879.02,566.6L879.05,562.63L879.08,558.63L879.11,554.61L879.15,550.58L879.18,546.52L879.21,542.44L882.34,542.32L885.48,542.21L888.61,542.09L891.75,541.97L891.84,541.89L891.82,541.93L891.95,542.15L892.8,542.29L893.38,542.55L893.83,542.94L895.47,543.71L895.97,544.18L896.46,544.44L896.96,544.49L897.3,544.34L897.48,544L897.71,543.97L897.99,544.27L898.91,544.6L898.94,544.7L896.39,545.27L895.86,545.54L896.5,545.73L897.14,545.68L897.79,545.41L898.54,545.42L899.19,545.55L899.4,545.44L899.48,545.39L900.6,546.13L901.01,546.25L901.44,546.16L901.89,545.88L902.87,545.51L904.39,545.06L905.85,544.87L907.25,544.96L908.14,544.83L908.95,544.36L910.74,542.82L912.79,541.58L916.18,540.03L919.46,538.82L919.46,539.87L919.46,541.19L919.46,542.51L919.46,543.82L919.46,545.14L919.46,546.45L919.46,547.76L919.46,549.07L919.46,550.37L919.46,551.67L919.46,552.98L919.46,554.27z" data-jurisdiction="OH" id="OH" title="Ohio"></path>
<path class="land" d="M786.75,605.32L786.96,606.95L787.17,608.56L787.38,610.18L787.59,611.79L787.8,613.4L788.01,615.01L788.22,616.61L788.44,618.22L788.41,619.46L788.38,620.71L788.36,621.96L788.33,623.2L788.3,624.44L788.28,625.68L788.25,626.92L788.22,628.16L788.2,629.39L788.17,630.63L788.14,631.86L788.12,633.09L788.09,634.32L788.06,635.54L788.04,636.77L788.01,637.99L785.89,637.42L785.36,637.06L784.39,636.64L783.51,635.8L781.78,634.74L781.12,634.49L780.91,634.52L780.56,635.04L779.64,635.45L779.13,635.46L778.23,635.31L778.05,635.18L777.92,634.86L777.56,634.65L777.29,634.82L775.97,635.25L775.78,635.56L775.03,635.57L774.29,635.35L772.43,636.04L771.79,636.58L771.12,636.76L770.78,637.29L770.57,637.21L769.87,636.56L769.16,636.37L768.17,635.73L768.14,635.16L768.03,635.09L767.86,635.03L767.64,635.09L767.21,635.57L766.96,635.69L766.72,635.67L765.76,635.35L765.36,634.77L765.17,634.59L764.95,634.55L764.54,634.73L764.31,635.36L764.12,635.54L763.73,635.65L763.75,635.96L763.4,636.84L763.21,637.02L762.96,636.99L762.71,636.77L762.52,636.46L762.44,636.19L762.58,635.5L762.49,635.26L762.31,635.19L761.84,635.52L761.43,635.5L760.9,635.83L760.58,635.93L760.28,635.85L759.79,635.32L758.95,634.98L758.62,634.35L758.48,634.17L758.29,634.12L758.11,634.14L757.81,634.34L756.84,635.17L756.4,635.43L756.02,635.48L755.65,635.4L755.42,635.19L755.38,634.35L755.16,634.1L754.26,633.57L754.07,633.08L753.99,632.39L752.9,632.5L751.56,632.43L750.96,633.03L750.64,633.14L750.27,633.02L749.19,632.2L748.04,632.37L747.39,632.28L745.79,631.67L744.54,631.61L744.02,631.5L743.74,631.36L743.62,630.42L743.12,629.63L742.96,629.41L742.11,628.86L741.97,628.84L741.88,628.96L741.69,629.59L741.43,629.62L740.45,629.44L739.55,629.63L739.05,629.32L737.34,627.87L736.65,627.49L736.09,627.37L736.09,626.01L736.09,624.65L736.09,623.28L736.09,621.91L736.08,620.54L736.08,619.17L736.08,617.79L736.08,616.41L736.08,615.04L736.08,613.65L736.07,612.27L736.07,610.89L736.07,609.5L736.07,608.11L736.07,606.72L736.06,605.32L734.3,605.32L732.54,605.32L730.77,605.32L729.01,605.32L727.25,605.32L725.48,605.32L723.72,605.32L721.95,605.32L720.19,605.32L718.43,605.32L716.66,605.32L714.9,605.32L713.14,605.32L711.37,605.32L709.61,605.32L707.84,605.32L707.84,603.86L707.84,602.4L707.84,600.94L707.84,599.48L710.16,599.48L712.49,599.48L714.81,599.48L717.14,599.48L719.31,599.48L721.49,599.48L723.67,599.48L725.84,599.48L728.02,599.48L730.19,599.48L732.37,599.48L734.54,599.48L736.72,599.48L738.89,599.48L741.07,599.48L743.24,599.48L745.42,599.48L747.6,599.48L749.77,599.48L751.95,599.48L754.12,599.48L756.3,599.48L758.47,599.48L760.65,599.48L762.82,599.48L765,599.48L767.17,599.48L769.35,599.48L771.52,599.48L773.7,599.48L775.87,599.48L778.05,599.48L780.23,599.48L782.4,599.48L784.57,599.48L786.75,599.48L786.75,600.94L786.75,602.4L786.75,603.87z" data-jurisdiction="OK" id="OK" title="Oklahoma"></path>
<path class="land" d="M517.5,484.41L518.44,484.07L519.18,484.33L520.12,484.94L521.05,486.79L521.96,489.86L522.16,490.89L522.87,491.51L523.71,491.54L527.08,491.99L527.58,491.96L527.58,491.96L528.19,491.84L530.1,490.67L532.17,490.29L534.62,490.37L536.12,490.71L536.67,491.29L537.98,491.35L541.08,490.67L544.51,490.19L546.35,489.7L548.43,488.68L553.19,487.38L555.56,487.23L556.76,486.74L557.04,486.49L557.21,486.48L559.71,486.48L562.21,486.48L564.7,486.47L567.2,486.47L569.7,486.47L572.2,486.46L574.7,486.46L577.03,486.46L577.29,487.05L578.27,488.21L579.66,489.2L580.57,490.24L580.98,491.32L580.3,493.79L578.53,497.63L577.57,500.07L577.41,501.13L576.54,502.92L574.94,505.45L574.16,507.32L574.2,508.53L574.74,509.24L575.78,509.43L576.5,509.83L576.88,510.43L576.89,510.98L576.53,511.48L576.43,512L576.58,512.54L576.46,513.5L575.86,515.46L575.87,515.53L575.87,518.71L575.88,521.59L575.88,524.47L575.88,527.33L575.89,530.18L575.89,533.02L575.9,535.86L575.9,538.68L572.39,538.68L568.88,538.68L565.37,538.68L561.85,538.68L558.34,538.68L554.83,538.68L551.32,538.68L547.81,538.68L545.33,538.68L542.85,538.68L540.36,538.68L537.88,538.68L535.4,538.68L532.92,538.68L530.44,538.68L527.95,538.68L525.47,538.68L522.99,538.68L520.51,538.68L518.03,538.68L515.54,538.68L513.06,538.68L510.58,538.68L508.01,538.67L506.82,537.13L506.3,534.84L506.2,533.86L506.34,531.28L505.98,530.18L505.08,528.36L505.47,526.77L505.88,525.8L506.9,521.57L507.14,521.23L507.57,521.24L508.31,520.52L507.97,520.35L507.45,520.69L507.91,519.01L508.43,517.56L508.76,517.04L508.93,512.3L509.23,508.67L509.72,507.46L509.55,506.22L509.74,504.53L509.61,502.82L510.65,494.54L510.51,493.53L510.83,492.18L510.53,488.61L510.66,484.59L510.4,484.08L510.26,483.52L510.51,483.44L510.99,484.03L513.23,484.02L514.67,483.48L515.19,483.66L515.79,484.4L516.55,484.54z" data-jurisdiction="OR" id="OR" title="Oregon"></path>
<path class="land" d="M974.26,546.76L973.52,547.16L973.19,547.45L972.92,547.86L972.25,549.28L971.13,550.56L970.27,551.22L970.27,551.56L970.72,552.64L970.71,552.99L970.37,553.66L969.78,553.99L969.68,554.38L969.62,555.05L969.65,556.21L969.82,556.45L970.51,556.86L971.1,558.38L971.65,558.56L973.92,561.65L972.28,562.56L971.2,563.33L970.73,563.74L969.8,564.83L968.41,565.19L967.65,565.6L967.46,565.79L966.62,565.45L965.45,565.5L965.05,565.65L964.75,565.95L964.04,566.93L961.87,566.93L959.69,566.93L957.52,566.93L955.35,566.93L953.18,566.93L951,566.93L948.83,566.93L946.66,566.93L944.49,566.93L942.31,566.93L940.14,566.93L937.97,566.93L935.8,566.93L933.62,566.93L931.45,566.92L929.28,566.92L928.05,566.93L926.82,566.93L925.6,566.93L924.37,566.93L923.15,566.93L921.92,566.93L920.69,566.93L919.47,566.93L919.47,565.52L919.47,564.1L919.47,562.69L919.46,561.27L919.46,559.85L919.46,558.42L919.46,557L919.47,555.58L919.46,554.27L919.46,552.98L919.46,551.67L919.46,550.37L919.46,549.07L919.46,547.76L919.46,546.45L919.46,545.14L919.46,543.82L919.46,542.51L919.46,541.19L919.46,539.87L919.46,538.82L921.21,538.17L921.99,537.73L922.77,537.31L923.18,537.06L923.64,536.84L926.59,535.2L926.59,535.27L926.59,536.97L926.59,538.67L927.89,538.67L929.19,538.68L930.48,538.68L931.78,538.68L933.08,538.68L934.38,538.68L935.67,538.68L936.97,538.68L938.27,538.68L939.57,538.68L940.87,538.68L942.16,538.69L943.46,538.69L944.76,538.69L946.06,538.69L947.35,538.69L948.65,538.69L949.95,538.69L951.25,538.69L952.55,538.69L953.84,538.69L955.14,538.7L956.44,538.7L957.74,538.7L959.03,538.7L960.33,538.7L961.63,538.7L962.93,538.7L964.23,538.7L965.52,538.7L966.82,538.7L968.12,538.71L968.85,539.36L969.18,540.04L970.28,540.53L970.53,540.81L970.53,541.21L970.92,541.65L970.8,542.3L970.8,542.88L970.94,543.61L971.21,544.31L971.6,544.87L972.03,545.29L973.72,545.92L974.06,546.29z" data-jurisdiction="PA" id="PA" title="Pennsylvania"></path>
<path class="land" d="M1006.88,542.38l-0.35,0.32l-0.37,-0.48l-0.19,-0.53l-0.27,-0.3l-0.29,-0.11l0.25,1.16l-0.59,0.87l-0.16,2.25l-0.74,0.94l-2.32,0.6l-0.69,-0.06l0.12,-0.72l0.24,-0.3l0.05,-0.78l0.03,-0.51l-0.01,-0.86l-0.01,-0.99l-0.01,-1.07l-0.01,-0.95l-0.01,-0.69l-0.01,-0.95l0,-0.68l0.71,-0.01l0.97,-0.01l0.93,-0.02l0.58,-0.01l0.71,-0.01l0.03,0.57l0.05,0.87l0.39,0.14l-0.02,0.71l-0.01,0.47l0.34,0.29l0.35,0.3L1006.88,542.38zM1006.81,545.07l-0.47,0.34l-0.52,-0.06l0.27,-0.46l0.1,-0.68l0.26,-0.75l0.15,-0.23l0.31,-0.2L1006.81,545.07zM1005.64,545.15l-0.26,0.23l-0.1,-0.6l0.18,-0.69l0.19,-0.02l0.09,0.37L1005.64,545.15z" data-jurisdiction="RI" id="RI" title="Rhode Island"></path>
<path class="land" d="M937.87,635.42L937.75,635.46L935.26,637.14L934.52,637.88L932.47,640.72L931.95,642.53L931.53,641.77L931.63,641.2L931.64,640.73L931.12,641.73L931.61,643.19L931.17,643.75L929.82,644.79L929.08,644.96L928.24,645.25L927.98,646.28L926.85,647.22L926.19,647.64L924.99,647.38L925.36,648.29L924.92,648.98L924.15,649.5L923.2,649.84L922.66,649.8L922.2,649.98L921.83,650.42L920.94,650.83L920.02,650.6L918.97,650.46L918.39,650.7L919.37,651.11L919.89,651.69L919.79,652.48L919.52,652.78L918.9,653.19L918.63,653.13L918.47,652.76L918.27,651.99L917.98,652.15L917.93,652.51L917.68,652.64L916.8,651.41L916.85,652.35L917.15,653.07L917.45,653.44L917.75,653.65L917.82,653.99L917.22,654.8L916.91,654.98L916.36,655.11L916.06,655.61L916.15,656.05L914.24,655.16L913.67,654.36L913.69,653.33L913.33,652.16L912.21,650.2L911.4,649.64L910.86,648.3L910.33,645.98L909.5,644.5L908.36,643.85L907.6,643.08L907.21,642.2L906.81,641.62L906.39,641.35L906.16,640.9L906.13,640.25L905.48,639.4L903.57,637.82L903.12,636.86L902.22,635.86L899.98,633.83L899.98,633.83L897.83,629.88L897.82,629.88L897.55,629.08L897.09,628.75L896.35,628.63L895.62,628.24L894.56,627.24L894.55,627.23L892.77,625.99L893.14,624.88L894.51,623.42L894.98,622.65L895.04,622.64L895.21,622.64L896.71,622.15L898.21,621.67L898.53,621.69L899.4,621.19L901.16,620.62L901.84,620.24L902.18,620.35L903.67,620.41L905.17,620.48L906.66,620.54L908.15,620.61L909.64,620.68L911.14,620.74L912.63,620.81L914.12,620.87L914.41,620.99L914.5,621.16L914.46,621.64L914.52,621.91L915.57,621.36L916.06,621.99L916.89,623.08L916.93,623.72L916.98,624.62L918.31,624.66L919.64,624.71L920.97,624.75L922.3,624.8L923.63,624.84L924.96,624.89L926.29,624.93L927.62,624.98L928.89,626.28L930.16,627.58L931.43,628.88L932.7,630.17L933.98,631.47L935.25,632.76L936.52,634.05z" data-jurisdiction="SC" id="SC" title="South Carolina"></path>
<path class="land" d="M768.5,487.26L768.18,488.6L767.96,489.19L767.5,489.78L766.08,491.08L765.73,491.53L765.78,491.93L766.07,492.44L766.8,493.65L767.19,494.13L768.75,494.93L769.47,495.92L769.47,498.91L769.47,501.89L769.47,504.85L769.47,507.81L769.47,510.75L769.47,513.68L769.47,516.6L769.47,519.51L768.11,519.56L768.27,520.37L768.64,521.16L768.71,521.62L768.63,521.99L768.38,522.32L768.44,522.84L768.51,522.99L769.13,523.32L769.33,523.78L769.4,524.3L769.39,524.69L769.02,525.41L768.91,526.36L768.45,527.77L767.94,528.63L767.84,529.07L767.89,529.42L768.67,530.33L768.72,530.69L768.98,531.16L769.21,532.21L768.49,532.03L767.78,531.48L767.38,530.6L766.17,529.78L764.14,529.03L762.78,528.35L762.08,527.75L760.41,527.49L757.76,527.57L756.04,527.89L755.24,528.45L753.57,527.86L750.76,525.95L747.03,525.95L743.78,525.95L740.52,525.95L737.26,525.95L734,525.95L730.74,525.95L727.48,525.95L724.23,525.95L720.97,525.95L717.71,525.95L714.45,525.95L711.19,525.95L707.94,525.95L704.68,525.95L701.42,525.95L698.16,525.95L698.15,522.73L698.14,519.51L698.13,516.27L698.12,513.02L698.11,509.75L698.1,506.47L698.09,503.17L698.08,499.86L698.16,499.86L698.23,499.86L698.31,499.86L698.38,499.86L698.38,499.82L698.39,499.78L698.39,499.74L698.39,499.7L698.37,496.61L698.36,493.51L698.34,490.39L698.33,487.26L700.52,487.26L702.72,487.26L704.91,487.26L707.1,487.26L709.29,487.26L711.49,487.26L713.68,487.26L715.87,487.26L718.07,487.26L720.26,487.26L722.45,487.26L724.64,487.26L726.84,487.26L729.03,487.26L731.22,487.26L733.42,487.26L735.61,487.26L737.8,487.26L740,487.26L742.19,487.26L744.38,487.26L746.57,487.26L748.77,487.26L750.96,487.26L753.15,487.26L755.35,487.26L757.54,487.26L759.73,487.26L761.93,487.26L764.12,487.26L766.31,487.26z" data-jurisdiction="SD" id="SD" title="South Dakota"></path>
<path class="land" d="M889.83,604.11L891.97,604.12L896.53,604.14L899.77,604.16L902.43,604.17L904,604.18L905.98,604.19L906.42,603.95L907.41,603.99L908.74,604.04L908.31,604.94L908.28,605.54L908.04,606.43L908.03,607.02L907.34,607.05L906.93,607.2L906.4,607.59L905.05,609.72L904.58,609.91L903.81,609.36L902.75,609.59L902.06,609.99L901.03,611.03L900.63,611.36L900.32,611.48L900.1,611.47L899.99,611.3L899.9,610.78L899.78,610.6L899.46,610.6L898.94,610.8L898.42,611.15L897.88,611.75L897.17,611.7L897.04,611.85L896.87,612.55L896.59,613.06L896.21,613.45L894.98,613.75L893.44,614.82L891.31,615.95L889.31,616.23L888.48,616.46L887.92,616.75L886.67,617.91L886.12,619.38L885.49,619.66L884.52,619.67L884.25,619.8L884,620.36L883.65,622.79L880.59,622.76L877.53,622.72L874.48,622.68L871.42,622.65L869.91,622.63L868.4,622.61L866.89,622.6L865.38,622.58L863.87,622.56L862.36,622.54L860.85,622.53L859.34,622.51L857.83,622.49L856.32,622.48L854.81,622.46L853.3,622.44L851.79,622.42L850.28,622.41L848.77,622.39L847.26,622.37L847.14,622.38L847.25,622.52L847.42,622.67L844.86,622.67L842.36,622.66L839.86,622.66L837.36,622.66L834.86,622.65L832.36,622.65L829.86,622.65L827.46,622.64L827.46,622.61L827.81,622.13L828.88,621.35L829.35,620.32L829.21,619.05L829.6,617.91L830.53,616.88L830.91,615.86L830.75,614.85L831.22,614.03L832.3,613.39L832.45,613.14L832.41,612.94L832.39,612.72L832.4,612.63L832.45,612.43L832.69,612.32L833.01,612.22L833.15,612.06L833.15,611.8L832.96,611.34L833,611.13L833.07,610.79L833.59,609.93L833.67,609.2L833.29,608.59L833.48,608.27L833.73,608.18L834.04,608.14L834.14,607.99L834.14,607.81L833.88,607.41L833.95,607.06L834.41,606.81L834.55,606.19L834.39,605.32L835.05,605.3L835.07,605.36L835.2,605.46L835.38,605.36L835.4,605.33L837.27,605.34L838.89,605.34L840.52,605.34L842.14,605.34L843.77,605.34L845.4,605.34L847.02,605.34L848.49,605.34L848.52,605.32L848.52,604.28L848.14,603.08L848.19,603.08L849.46,603.21L850.29,603.29L850.56,603.65L853.7,603.59L856.83,603.53L859.97,603.47L863.1,603.41L866.37,603.52L869.63,603.64L872.9,603.75L876.17,603.87L879.44,603.98L882.71,604.09L885.97,604.21L889.24,604.32L889.32,604.29L889.39,604.27L889.46,604.24L889.54,604.22L889.61,604.19L889.69,604.16L889.76,604.14z" data-jurisdiction="TN" id="TN" title="Tennessee"></path>
<path class="land" d="M788.01,637.99l0.49,0.55l0.39,0.16l0.12,0.22l0.19,0.06l0.24,-0.05l0.36,-0.25l0.53,0.07l0.44,-0.09l0.87,0.13l0.48,0.26l0.01,1.52l0.02,1.52l0.01,1.52l0.02,1.52l0,1.41l0,1.41l0,1.41l0,1.41l0,1.41l0,1.4l0,1.4l0,1.4l1.3,1.35l0.56,0.93l0.18,0.47l0.06,1.61l0.13,0.39l0.65,0.6l0.02,0.4l0.68,1.16l-0.02,0.55l0.65,1.24l0.37,0.32l0.06,0.84l0.2,0.63l-0.3,0.45l0.13,0.63l-0.18,0.58l-0.1,0.77l-0.43,1.19l-0.38,0.58l-0.52,1.12l0.05,0.93l-0.3,1.01l-0.04,0.39l0.28,0.67l0.1,1.84l-0.15,0.39l-0.63,1.08l-0.45,-0.03l-0.99,1.78l0.56,1l-0.04,0.36l-1.97,0.2l-4.47,2l-1.74,1.08l0.09,-0.36l2.11,-1.4l-0.74,-0.21l-1.2,0.35l-0.43,-0.13l0.51,-1.16l-0.16,-1.02l-0.85,-0.03l-0.54,0.82l-0.38,-0.04l-0.49,-0.35l-0.38,0.11l0.28,1.85l0.54,0.76l0.45,0.97l-1.22,1.19l-1.14,0.98l-0.12,0.95l-1.14,1.24l-1.07,0.7l-2.52,1.65l-0.72,0.35l-1.14,0.76l-1.57,0.57l-1.51,0.91l-0.51,0.14l0.96,-0.77l1.14,-0.76l-0.98,0.1l-1.51,-0.35l-0.92,-0.02l-0.01,0.28l-0.7,0.39l-0.73,-0.57l-0.32,-0.39l-0.15,-0.33l-0.31,-0.08l-0.3,0.16l1.09,2.35l0.46,0.1l0.51,0.23l-0.64,0.55l-0.69,0.41l-1.08,0.28l-0.91,-0.85l-0.2,1.07l-0.12,1.07l-0.31,0.27l-0.49,0.39l-0.27,-0.29l-0.13,-0.41l-0.31,0.37l-0.46,0.28l-0.76,0.06l-0.57,0.15l0.01,0.44l0.13,0.44l1.01,-0.35l-0.36,1.14l-0.93,1.13l-0.75,0.27l-1.15,-0.16l-0.28,0.11l-0.25,0.23l1.34,1.76l-0.86,2.65l-0.55,0.96l-0.38,0.12l-0.41,0.03l-1.49,-0.85l-0.81,-0.66l0.72,1.8l1.95,0.52l0.1,0.68l-0.01,0.58l-0.38,0.68l-0.36,0.9l0.27,0.63l0.31,1.55l0.26,0.71l0.29,2.16l0.31,0.93l1.77,3.43l0.6,0.03l0.1,0.37l-0.06,0.71l-1.28,0.21l-0.53,0.32l-0.1,0.27l-0.08,0.15l-0.16,-0.01l-0.61,-0.2l-1.38,-0.97l-2.02,-0.6l-2.65,-0.23l-1.81,-0.49l-0.97,-0.74l-1.01,-0.44l-1.06,-0.14l-0.88,-0.4l-0.69,-0.67l-1.02,-0.43l-1.34,-0.19l-0.87,-0.5l-0.6,-1.23l0,-0.02l-0.54,-2.05l-0.68,-1.29l-1.33,-1.6l-0.12,-0.21v0l-0.01,-0.26l0.17,-0.93l-0.14,-0.67l-0.42,-0.55l-0.1,-0.58l0.23,-0.61l0.02,-0.73l-0.2,-0.85l-0.85,-0.92l-1.5,-0.99l-1.27,-1.45l-1.05,-1.91l-1.04,-1.33l-1.03,-0.74l-0.7,-0.9l-0.38,-1.07l-0.11,-0.62l0.15,-0.17l-0.63,-1.19l-1.42,-2.21l-0.81,-1.62l-0.21,-1.02l-0.9,-1.22l-1.6,-1.42l-0.87,-0.92l-0.21,-0.64l0,0l-2.49,-1.87l-0.72,-1.17l-0.56,-0.37l-0.65,0.04l-0.33,-0.11l-0.02,-0.26l-0.21,-0.01l-0.4,0.24l-1.32,0.05l-2.25,-0.14l-1.62,-0.32l-1,-0.49l-0.7,0.07l-0.4,0.63l-0.85,0.41l-1.31,0.18l-1.12,1.17l-0.94,2.15l-0.41,1.38l0.12,0.62l-0.25,0.45l-0.61,0.28l-0.62,0.62l-0.63,0.97l-0.74,0.47l-0.84,-0.03l-1.56,-0.74l-2.27,-1.46l-1.78,-0.9l-1.29,-0.34l-1.14,-0.68l-0.99,-1.01l-0.91,-0.67l-0.83,-0.34l-0.97,-1.12l-1.11,-1.91l-0.56,-1.47v-1.56l-1.45,-3.4l-0.77,-1.48l-0.57,-0.68l-1.12,-0.81l-1.67,-0.94l-2.24,-1.89l-2.81,-2.85l-1.99,-1.72l-1.17,-0.58l-1.01,-1.03l-0.86,-1.48l-0.84,-0.94l-0.09,-0.04l-1.14,-0.56h0l-0.96,-2l0.06,0l2.12,0l2.12,0h2.12l2.12,0l2.12,0l2.12,0l2.12,0l2.12,0l2.12,0l2.12,0l2.12,0l2.12,0l2.12,0l2.12,0l2.12,0l2.12,0l0.01,-3.11l0.01,-3.12l0.01,-3.13l0.01,-3.14l0.02,-3.15l0.01,-3.16l0.01,-3.17l0.01,-3.18l0.02,-3.19l0.01,-3.2l0.01,-3.21l0.01,-3.23l0.01,-3.24l0.01,-3.25l0.01,-3.26l0.01,-3.27l0.4,-0.01h1.76l1.76,0h1.76h1.76h1.76h1.76l1.76,0h1.77h1.76l1.76,0h1.76h1.76l1.76,0h1.76h1.76h1.77l0,1.4l0,1.39l0,1.39l0,1.39l0,1.39l0,1.38l0,1.38l0,1.38l0,1.38l0,1.38l0,1.37l0,1.37l0,1.37l0,1.37l0,1.36l0,1.36l0.55,0.12l0.69,0.38l1.71,1.45l0.5,0.31l0.9,-0.18l0.98,0.18l0.26,-0.03l0.19,-0.62l0.09,-0.13l0.14,0.02l0.85,0.56l0.16,0.22l0.5,0.79l0.13,0.94l0.27,0.14l0.52,0.11l1.26,0.06l1.6,0.61l0.65,0.09l1.15,-0.17l1.08,0.82l0.38,0.12l0.31,-0.11l0.61,-0.6l1.34,0.07l1.09,-0.11l0.09,0.69l0.19,0.5l0.9,0.53l0.22,0.26l0.05,0.84l0.23,0.21l0.36,0.08l0.38,-0.05l0.44,-0.26l0.97,-0.82l0.3,-0.2l0.18,-0.02l0.18,0.05l0.15,0.18l0.33,0.63l0.84,0.34l0.48,0.53l0.3,0.08l0.33,-0.1l0.52,-0.33l0.41,0.02l0.47,-0.33l0.19,0.07l0.08,0.23l-0.14,0.7l0.08,0.27l0.19,0.31l0.26,0.22l0.25,0.03l0.19,-0.18l0.35,-0.88l-0.02,-0.32l0.4,-0.11l0.18,-0.17l0.23,-0.64l0.41,-0.17l0.22,0.03l0.2,0.18l0.4,0.58l0.95,0.33l0.25,0.02l0.25,-0.12l0.43,-0.48l0.22,-0.06l0.18,0.07l0.1,0.07l0.04,0.56l0.98,0.64l0.72,0.19l0.7,0.65l0.2,0.07l0.34,-0.52l0.67,-0.19l0.64,-0.54l1.86,-0.69l0.74,0.22l0.75,-0.01l0.2,-0.3l1.32,-0.44l0.27,-0.17l0.37,0.22l0.13,0.32l0.17,0.13l0.91,0.16l0.5,-0.02l0.92,-0.41l0.36,-0.52l0.21,-0.03l0.66,0.25l1.73,1.05l0.88,0.85l0.98,0.41l0.53,0.36L788.01,637.99zM782.78,687.43l-0.47,0.1l2.05,-1.65l0.43,-0.55l0.55,0.02l-0.92,0.93L782.78,687.43zM766.55,698.03l-0.35,0.04l0.43,-0.57l0.7,-0.29l1.53,-1.1l0.62,-0.08l0.33,-0.38l0.14,-0.06l-0.09,0.47l-1.23,0.66L766.55,698.03zM764.19,700.69l-0.2,0.03l0.46,-0.87l0.08,-0.35l0.75,-1.1l0.4,-0.16l0.17,0.47l-0.77,0.77L764.19,700.69zM761,707.05l-0.29,0.61l0.08,-0.9l0.77,-2.06l1.55,-2.71l0.65,-0.45l-1.79,2.97L761,707.05zM762.72,719.01l-0.13,0.48l-0.78,-2.26l-1.27,-5.14l-0.05,-2.94l0.2,-1.01l0.33,4.15l1.4,5.25L762.72,719.01z" data-jurisdiction="TX" id="TX" title="Texas"></path>
<path class="land" d="M632.06,538.67L632.07,540.25L632.07,541.82L632.07,543.39L632.07,544.96L632.07,546.52L632.07,548.08L632.07,549.64L632.07,551.2L634.42,551.2L636.78,551.2L639.14,551.2L641.5,551.2L643.86,551.2L646.21,551.2L648.57,551.2L650.93,551.2L650.93,554.3L650.93,557.39L650.93,560.46L650.93,563.53L650.93,566.58L650.93,569.63L650.93,572.66L650.93,575.68L650.93,578.69L650.93,581.69L650.93,584.68L650.93,587.66L650.93,590.63L650.93,593.59L650.93,596.54L650.93,599.48L647.99,599.47L645.05,599.47L642.11,599.47L639.17,599.47L636.24,599.46L633.3,599.46L630.36,599.46L627.42,599.46L624.48,599.45L621.55,599.45L618.61,599.45L615.67,599.45L612.73,599.44L609.79,599.44L606.86,599.44L603.92,599.44L603.92,597.6L603.92,595.76L603.92,593.92L603.92,592.07L603.92,590.22L603.91,588.37L603.91,586.51L603.91,584.65L603.91,582.78L603.91,580.91L603.91,579.04L603.91,577.16L603.91,575.28L603.91,573.39L603.91,571.5L603.91,569.6L603.91,567.71L603.91,565.8L603.91,563.89L603.91,561.98L603.9,560.06L603.9,558.14L603.9,556.22L603.9,554.28L603.9,552.35L603.9,550.41L603.9,548.47L603.9,546.52L603.9,544.56L603.9,542.6L603.9,540.64L603.9,538.67L605.66,538.67L607.42,538.67L609.18,538.67L610.94,538.67L612.7,538.67L614.46,538.67L616.22,538.67L617.98,538.67L619.74,538.67L621.5,538.67L623.26,538.67L625.02,538.67L626.78,538.67L628.54,538.67L630.3,538.67z" data-jurisdiction="UT" id="UT" title="Utah"></path>
<path class="land" d="M945.76,571.5l0.55,0.45l1.27,0.53l0.52,0.54l-0.23,0.55l-0.03,0.4l0.24,0.36l1.69,0.72l1.04,1.02l0.64,0.31l0.19,0.09l0.46,0.25l0.21,0.31l-0.14,1.37l-0.44,0.68l-0.69,0.52l-0.9,0.92l-0.22,0.85l-0.28,1.59l0.38,0.54l0.39,0.14l1.15,-0.36l0.6,0.16l1.32,1.91l2.46,0.75l0.9,0.47l0.73,0.99l1.1,0.57l0.85,0.83l0.02,0.54l-0.3,0.64l-0.12,0.86l-0.36,0.54l-0.87,0.06l-0.52,-0.14l-2.83,-3.03l-0.34,-0.28l-1.05,-1.59l-1.23,-0.85l-0.38,0.02l1.75,1.58l0.72,1.1l1.26,1.55l0.9,0.65l0.66,1.02l0.62,0.48l1.68,0.68l-0.58,0.49l0.93,0.42l0.13,0.76l-0.09,0.87l-1.29,-0.34l-0.04,0.64l0.12,0.38l-0.57,0.31l-0.79,-0.42l-2.06,-2.31l0.02,0.31l0.17,0.36l1.2,1.49l1.07,0.89l0.91,0.4l0.7,0.75l0.25,0.45l0.16,0.68l-0.52,0.47l-0.59,0.26l-0.57,-0.46l-0.42,-0.49l-0.9,-0.83l-0.27,-0.93l-0.68,0.05l-2.86,-1.18l-2.3,-0.14l0.23,0.24l0.29,0.16l1.83,0.29l0.72,0.54l1.5,0.48l0.88,0.13l0.36,1.48l1.22,1.01l0.16,0.75l0.83,0.08l1.46,-0.73l0.94,0.26l1.36,0.21l0.31,0.59l0.23,1.13l0.48,1.27l0.31,1.24l-0.3,0l-0.73,-0.01l-2.34,-0.02l-3.4,-0.03l-3.41,-0.03l-3.4,-0.03l-3.4,-0.03l-3.41,-0.03l-3.4,-0.03l-3.41,-0.03l-3.4,-0.03l-3.41,-0.03l-3.4,-0.03l-3.4,-0.03l-3.41,-0.03l-3.4,-0.03l-3.41,-0.03l-3.4,-0.03l-0.16,-0.18l-1.34,-0.05l-0.98,-0.04l-0.44,0.24l-1.97,-0.01l-1.57,-0.01l-2.66,-0.01l-3.24,-0.02l-4.57,-0.02l-2.13,-0.01l0.95,-0.56l1.41,-0.33l2.51,-0.95l1,-0.97l1.41,-0.71l0.59,-0.85l0.94,-0.81l0.35,-0.92l0.13,-0.14l1.56,-0.83l1.63,-1.04l3.56,-2.86l0.07,0.38l-0.13,0.41l0.3,0.48l0.25,0.75l0.35,0.46l0.44,0.37l0.73,0.33l0.86,0.58l0.68,0.16l0.23,-0.02l0.75,-0.56l0.62,-0.3l0.65,-0.61l1.16,0.83l0.46,0l1.14,-0.36l1.07,-0.1l0.27,-0.11l0.4,-0.34l0.01,-0.69l0.09,-0.18l0.18,-0.08l0.21,-0.02l0.48,0.25l0.47,0.01l2,-0.8l0.15,0.06l0.25,0.37l0.88,-0.47l0.52,-0.44l0.23,-0.66l0.44,-0.65l-0.09,-0.29l-0.28,-0.38l0.37,-0.88l0.54,-0.87l2.04,-2.64l0.65,-1.6l0.85,-1.03l0.28,-0.82l0.64,-0.81l0.44,-1.68l0.27,-0.34l0.4,-0.06l0.4,0.21l0.29,0.31l0.19,0.5l1.02,0.44l0.86,0.06l0.6,-0.32l0.35,-0.59l0.48,-1.11l0.45,-0.66l0.29,-0.83l0.3,-0.57l0.46,-0.36l1.16,0.02l0.6,-0.51l0.46,-0.58l0.28,-0.19l0.33,0.03l1.05,-0.93l1.38,-1.95l0.3,-1.23l0.36,-0.89l0.14,-0.91l0.27,-0.5l1.22,0.99l0.7,0.57l1.6,1.3l1.06,0.86l0.42,-0.98L945.76,571.5zM969.05,587.22l0.25,-0.03v0l-1.01,1.81l-0.43,0.19L969.05,587.22zM965.22,588.22l0.37,-0.54l1.42,-0.19l0.88,-0.12l-2.08,4.67l0.09,0.86l-0.42,0.28l-0.63,0.22l-0.64,0.51l-0.42,0.56l-0.39,1.52l-0.76,1.7l-0.47,-0.71l-0.12,-0.61l0.21,-1.59l0.82,-2.61l0.9,-1.63l0.69,-0.77L965.22,588.22z" data-jurisdiction="VA" id="VA" title="Virginia"></path>
<path class="land" d="M995.27,529.41L994.35,529.38L993.42,529.34L992.5,529.31L991.57,529.27L990.65,529.24L989.72,529.2L988.79,529.17L987.87,529.13L987.62,528.36L987.74,527.7L987.76,526.79L987.79,525.62L987.81,524.32L987.85,522.55L987.87,521.37L987.9,520.3L987.93,518.84L987.37,518.02L987.14,517.88L986.97,517.97L986.57,518.51L986.44,518.5L986.34,518.36L986.36,517.87L986.72,516.13L986.72,515.58L986.65,514.65L986.25,512.53L986.24,512.05L986.4,511.32L986.67,510.58L987.13,509.84L987.23,509.52L987.2,508.22L987.34,507.01L986.75,505.2L986.97,502.85L986.81,501.73L987,500.69L986.94,499.81L988.54,499.8L992.46,499.8L996.37,499.79L1000.29,499.78L1004.21,499.78L1004.06,500.04L1004.28,501.09L1003.24,502.9L1003.26,503.48L1003.73,505.07L1003.7,505.44L1003.55,505.62L1003.34,506.3L1003.07,506.72L1002.65,507.14L1001.31,508.14L1000.91,508.39L999.65,508.72L999.37,509.1L999.08,511.51L998.67,512.86L998.58,513.48L998.03,514.54L997.57,515.75L996.87,516.74L996.49,517.94L996.26,518.4L996.04,519.15L995.83,521.69L995.54,523.08L995.21,525.47L994.99,526.07L994.78,526.39L994.49,527.42L994.46,527.8L994.59,528.15L995.11,528.96z" data-jurisdiction="VT" id="VT" title="Vermont"></path>
<path class="land" d="M577.03,486.46l-2.33,0l-2.5,0l-2.5,0l-2.5,0l-2.5,0l-2.5,0l-2.5,0l-2.5,0l-0.16,0l-0.28,0.25l-1.2,0.49l-2.37,0.15l-4.75,1.3l-2.09,1.02l-1.84,0.5l-3.43,0.48l-3.1,0.68l-1.31,-0.06l-0.55,-0.58l-1.5,-0.33l-2.45,-0.08l-2.07,0.39l-1.91,1.17l-0.61,0.12l0,0l-0.49,0.04l-3.37,-0.46l-0.84,-0.03l-0.72,-0.62l-0.19,-1.02l-0.91,-3.08l-0.93,-1.85l-0.94,-0.61l-0.74,-0.25l-0.94,0.34l-0.29,-0.19l-0.45,-0.05l-1,-0.68l-0.57,-0.68l-1.75,0.05l-0.36,-0.44l-1.95,0.44l-0.6,-0.45l-1.06,0.29l0.26,-1.27l-0.05,-1.6l0.06,-1.56l0.26,1.14l0.66,1.21l0.32,-1.37l0.22,-1.73l-0.65,-0.67l-1.07,-0.49l-0.38,-1.62l2.54,-1.38l-1.35,-0.29l-0.53,-0.62l-0.65,-0.07l-0.05,0.48l-0.21,0.63l-0.23,-0.83l-0.06,-0.98l-0.27,-1.68l-1.04,-2.71l-0.63,-3.53l-0.79,-1.75l-1.52,-1.68l-0.4,-0.98l-0.36,-2.49l0.2,-1.89l-0.28,-1.33l0.73,0.08l1.92,1.05l2.39,0.82l0.72,0.6l1.16,0.44l6.41,0.69l0.42,-0.06l0.83,-0.43l0.35,0.05l0.94,0.98l0.47,0.12l0.61,-0.05l0.45,-0.19l0.77,-0.67l0.1,0.25l-0.01,0.62l0.28,0.88l0.57,1.14l0.22,0.71l-1.15,1.99l-0.22,0.04l-0.03,-0.67l-0.15,-0.13l-2.16,3.36l-0.76,1.59l-0.08,0.72l0.03,0.42l0.3,0.1l0.69,-0.16l1.02,-0.66l0.05,-0.14l-0.95,0.23l-0.46,0.02l0.06,-0.75l0.11,-0.36l0.62,-1.11l0.66,-0.67l0.93,-0.71l0.54,-0.59l0.37,-0.86l1.03,-1.02l0.19,-0.29l-0.04,-0.85l0.07,-0.16l0.5,0.11l0.21,1.45l-0.12,0.65l-0.89,0.79l-0.11,0.28l0.16,1.08l-0.14,0.1l-0.34,-0.13l-0.1,0.07l0.84,1.17l0.27,0.91l0.04,0.81l-0.23,1.55l-0.24,0.26l-0.42,-0.09l-0.56,-0.48l-0.12,0.16l-0.44,1.2l-0.15,-0.1l-0.28,-1.42l-0.15,-0.11l-0.86,0.65l-0.34,0.62l-0.3,0.99l-0.38,0.47l1.07,0.1l0.96,-0.2l0.77,0.47l0.26,0.01l0.71,-0.46l0.22,-0.31l0.58,-1.5l0.29,-0.27l0.44,-0.01l0.42,-0.23l0.63,-0.82l0.03,-0.33l-0.23,-1.85l0.07,-1.05l-0.12,-0.33l-0.28,-0.35l0.04,-0.34l0.22,-0.55l0.02,-0.5l-0.19,-0.44l0.08,-0.51l0.59,-1.09l0.11,-0.48l0.72,-1.09l-0.18,-0.44L526,457.84l-0.33,-0.47l-0.34,-0.74l-0.25,-0.25l-0.08,0.11l0.36,1.21l-0.08,0.08l-0.93,-0.65l-0.22,-0.41l-0.11,-0.56l0.08,-0.42l0.5,-0.41l0.6,-0.15l-0.05,-0.35l-0.75,-1.13l-0.5,-0.52l-0.38,-0.25l-0.52,-0.06l-0.23,-0.19l-0.06,-0.27l0.11,-0.35l0.28,-0.11l0.8,0.14l0.43,-0.25l-0.04,-0.45l-0.13,-0.25l0.02,-1.62l-0.3,-1.32l-0.16,-0.22l-0.17,-0.02l-0.18,0.18l-0.5,0.05l-0.31,-0.43l-0.34,-0.84l-0.62,-2h0.96h4.01h4.01h4.01h4.01h4.01h4.01h4.01l4.01,0h4.01h4.01h4.01h4.01h4.01h0.98l0.02,2.28l0.01,2.28l0.01,2.28l0.01,2.27l0.01,2.26l0.01,2.25l0.01,2.25l0.01,2.24l0.01,2.23l0.01,2.23l0.01,2.22l0.01,2.21l0.01,2.21l0.01,2.2l0.01,2.19l0.01,2.19l-0.07,0.13l-0.06,0.32l0.27,0.91l0.64,1.32l0.2,0.93l-0.24,0.53l0.17,0.93L577.03,486.46zM521.63,449.47l0.13,0.31l-0.38,0.3l-0.27,0.05l-0.43,-0.48l-0.19,-0.06l0.15,0.74l-0.05,0.25l-0.88,-0.46l-0.16,-0.36l0.25,-0.38l0.55,-0.4l0.19,-0.05L521.63,449.47zM519.45,451.91l0.25,0.47l-1.01,-0.3l-0.43,-0.27l-0.13,-0.26l-0.15,-0.86l0.07,-0.28l0.45,-0.1l0.85,1.06L519.45,451.91zM521.26,452.89l-0.15,0.14l-0.5,-0.19l-0.3,-0.31l-0.1,-0.39l0.19,-0.75l0.25,-0.19l0.16,0.04l0.07,0.66l0.45,0.7L521.26,452.89zM523.6,456.77l0.46,1.84l0.2,-0.77l1.28,1.33l0,0.65l-0.16,0.22l-0.27,0.08l-0.25,-0.19l-0.23,-0.46l-0.29,-0.24l-0.61,-0.16l-0.32,-0.52l-0.11,-0.36l-0.03,-1.03l-0.15,-0.32l-0.33,-0.07l-0.31,-0.24l-0.48,-0.72l-0.07,-0.19l0.23,-0.59l0.52,-0.99l0.38,-0.47l0.24,0.05l0.29,0.3l0.35,0.54l-0.06,0.38l-1.41,0.75l-0.05,0.18l0.68,0.21l0.25,0.19L523.6,456.77zM524.31,464.63l-0.05,0.27l-0.52,-0.32l-0.17,-0.29l0.02,-0.66l0.13,-0.43l0.1,-0.09l0.31,0.19l0.09,0.11L524.31,464.63zM525.28,467.4l-0.04,0.32l-0.36,0.25l-0.19,-0.06l-0.01,-0.37l-0.1,-0.06l-0.39,0.45l0.03,-0.88l0.19,-0.93l0.17,-0.02l0.25,0.61L525.28,467.4zM520.96,470.04l-0.09,0.27l-0.13,-0.01l-0.29,-0.55l-0.04,-0.39l0.25,-0.28l0.34,0.81L520.96,470.04z" data-jurisdiction="WA" id="WA" title="Washington"></path>
<path class="land" d="M826.21,472.5l-0.31,0.22l-0.12,-0.1l0.07,-0.42l0.16,-0.25l0.24,-0.07l0.12,0.1l0,0.27L826.21,472.5zM823.56,473.86l-0.14,0.1l-0.36,-0.23l-0.05,-0.19l0.1,-0.19l0.17,0.04l0.24,0.28L823.56,473.86zM826.39,478.44l-0.05,0.11l0.19,0.5l0.48,-0.13l0.21,0.3l0.29,0.13l0.54,0.24l0.26,0.57l0.26,0.57l0.26,0.57l0.26,0.57l1.18,0.33l1.18,0.33l1.18,0.33l1.18,0.33l1.18,0.33l1.18,0.33l1.18,0.33l1.18,0.33l0.66,0.38l0.66,0.38l0.66,0.38l0.66,0.38l1.04,0.07l0.92,0.23l1.29,0.01l1.3,0.29l1.91,0.63l0.45,0.54l0.08,0.36l-0.19,0.84l1.82,0.75l0.78,0.56l0.29,0.43l-0.05,0.39l0.18,0.82l-0.19,0.44l0,0.77l-0.41,0.81l-0.14,0.44l-0.01,0.37l0.09,0.24l0.22,0.09l0.69,-0.05l0.68,-0.25l0.3,0.15l0.06,0.13l-0.05,0.22l-0.55,1.37l0.02,0.55l0.23,0.54l0.38,0.52l0.45,0.18l-0.02,0.35l-0.18,0.67l-0.53,0.53l-1.38,0.67l-0.22,0.45l-0.03,0.37l-0.89,1.54l-0.44,0.94l-0.29,0.98l0.09,0.62l0.47,0.25l0.38,-0.1l0.29,-0.45l0.44,-0.4l0.6,-0.36l0.44,-0.53l0.61,-1.3l0.68,-0.75l0.36,-0.04l0.1,0.02l0.71,-0.34l0.57,0.11l0.34,0.51l0.35,0.35l0.08,0.33l-0.18,0.73l-0.32,0.77l-0.47,0.81l-0.43,1.21l-0.38,1.62l-0.08,1.22l0.22,0.82l-0.21,0.73l-0.64,0.65l-0.52,0.86l-0.39,1.08l-0.22,0.9l-0.05,0.73l0.06,0.55l0.24,0.74l-0.02,0.37l-0.7,1.62l-0.25,0.79l-0.04,0.62l-0.17,0.61l-0.53,1.24l-0.17,0.69l-0.03,0.63l0.12,1.03l-0.07,0.35l0.03,0.26l0.13,0.18l0,0.32l-0.14,0.47l0.05,0.37l0.24,0.26l0.16,0.5l0.07,0.74l0.18,0.61l0.3,0.49l0.05,0.71l-0.19,0.93l-0.1,1.75l0,0.58l-1.2,-0.01l-4.24,-0.03l-4.24,-0.03l-4.24,-0.03l-4.24,-0.03l-4.24,-0.03l-4.33,-0.03l-0.06,-0.1l-0.29,-1.14l-0.95,-0.85l-1.61,-0.56l-1.03,-0.87l-0.45,-1.19l-0.29,-1.34l-0.12,-1.49l0.13,-1.25l0.38,-1.01l-0.1,-0.68l-0.57,-0.36l-0.38,-0.47l-0.18,-0.58l-0.06,-0.8l-0.31,-3.82l-0.39,-1.81l-0.59,-0.71l-1.24,-0.83l-1.9,-0.94l-1.17,-0.88l-0.67,-1.24l-1.34,-1.45l-0.88,-0.6l-0.86,-0.22l-0.68,-0.47l-0.51,-0.72l-0.7,-0.45l-0.9,-0.19l-1,-0.59l-1.19,-1.06l-0.03,-0.08l-0.25,-0.77l0.14,-0.43l0.2,-1.48l-0.02,-0.47l-0.26,-1.35l0.32,-0.52l-0.07,-1.67l0.11,-0.55l0.64,-1.37l0.03,-0.7l-0.23,-0.81l-0.47,-0.66l-1.27,-0.69l-0.04,-0.86l0.21,-0.64l0.83,-1.2l0.46,-1.07l0.42,-0.46l2.54,-1.6l0.54,-0.11l0.39,-0.45l0.31,-0.2l0,-1.95l0,-1.96l0,-1.96l0,-1.97l0.64,-0.14l0.28,-0.49l0.65,-0.77l0.17,0.01l0,0.01l0.32,0.35l0.81,0.51l0.63,0.06l0.8,-0.1l3.17,-0.88l1.34,-0.61l1.31,-1.03l0.14,-0.03l0.55,0.19l0.17,0.09l1.71,-1.18l0.56,-0.15l0.44,0.03l0.55,0.46l0.13,0.28l-0.18,0.54l-0.49,0.8l-0.24,0.68l0.01,0.55l-0.21,0.59l-0.54,0.8l0.19,0.22l1.44,-0.58l0.21,-0.22l0.02,-0.13l-0.09,-0.16l0.17,-0.07l1.13,0.79l0.76,0.44l0.63,0.21L826.39,478.44zM825.08,473.97l-0.31,0.08l-0.68,-0.12l0.01,-0.2l0.7,-0.28l0.31,-0.08l0.07,0.12L825.08,473.97zM823.53,475.83l-0.54,0.19l-0.22,-0.04l0.09,-0.26l0.28,-0.31l1.25,-0.77l0.22,0.02l0.07,0.19l-0.61,0.38l-0.23,0.2l-0.03,0.21L823.53,475.83zM859.76,495.19l-0.28,0.13l-0.52,-0.05l-0.19,-0.3l0.27,-0.77l0.11,0.14l0.45,0.01l0.16,0.08l0.05,0.19L859.76,495.19zM858.54,496.67l-0.17,0.17l-0.29,-0.11l-0.11,0.25l0.06,0.61l-0.1,0.28l-0.26,-0.05l-0.01,0.11l0.23,0.27l0.02,0.3l-0.18,0.32l-0.17,0.15l-0.17,-0.02l-0.26,0.37l-0.35,0.76l-0.12,0.44l0.11,0.12l-0.08,0.25l-0.87,1.15l-0.33,0.11l-0.36,-0.16l-0.26,-0.34l-0.15,-0.51l-0.04,-0.4l0.06,-0.28l0.76,-1.02l0.34,-0.67l0.19,-0.75l0.35,-0.48l0.52,-0.21l0.42,-0.47l0.32,-0.73l0.37,-0.32l0.42,0.1l0.18,0.28L858.54,496.67z" data-jurisdiction="WI" id="WI" title="Wisconsin"></path>
<path class="land" d="M929.28,566.92L929.25,568.48L929.23,570.04L929.2,571.59L929.18,573.14L930.39,572.24L931.01,571.92L933.06,569.93L933.33,569.92L934.04,570.2L935.52,568.78L935.69,568.27L935.86,568.1L936.05,568.12L936.16,568.25L936.09,568.55L936.2,568.69L936.81,569.03L937.65,569.22L937.77,569.24L938.52,569.23L938.85,568.95L939.02,568.4L939.36,568.08L940.12,567.94L941.48,567.38L942.27,567.47L942.93,568.04L943.6,568.31L944.28,568.29L944.55,568.42L944.39,568.72L944.57,569.05L945.09,569.43L945.26,569.78L945.09,570.1L945.15,570.34L945.42,570.5L945.59,570.85L945.64,571.4L945.76,571.5L945.15,572.95L944.73,573.94L943.67,573.08L942.07,571.78L941.37,571.21L940.15,570.22L939.88,570.72L939.74,571.63L939.39,572.52L939.09,573.75L937.71,575.7L936.66,576.64L936.34,576.61L936.06,576.8L935.6,577.38L935.01,577.88L933.85,577.86L933.38,578.22L933.08,578.8L932.79,579.63L932.34,580.28L931.86,581.39L931.51,581.98L930.91,582.3L930.05,582.25L929.02,581.8L928.83,581.3L928.54,580.99L928.15,580.78L927.75,580.83L927.48,581.17L927.04,582.85L926.4,583.66L926.12,584.49L925.27,585.52L924.62,587.12L922.59,589.76L922.04,590.63L921.67,591.5L921.95,591.88L922.04,592.17L921.61,592.82L921.38,593.48L920.86,593.92L919.99,594.39L919.73,594.02L919.58,593.96L917.58,594.77L917.11,594.76L916.63,594.51L916.42,594.52L916.24,594.61L916.15,594.78L916.14,595.48L915.74,595.82L915.48,595.93L914.4,596.03L913.27,596.39L912.81,596.39L911.65,595.56L911,596.17L910.37,596.46L909.63,597.02L909.4,597.04L908.72,596.88L907.86,596.3L907.14,595.97L906.7,595.61L906.35,595.14L906.1,594.39L905.8,593.92L905.93,593.51L905.86,593.13L904.56,592.76L902.89,591.38L901.82,589.71L901.48,588.93L901.09,588.4L900.99,587.87L899.99,586.48L899.72,585.89L899.7,585.5L900.02,584.78L900.09,584.43L899.98,582.65L899.76,582.32L900.85,582.72L901.89,582.49L902.54,581.94L902.79,581.08L903.16,580.57L903.62,580.43L903.84,580.05L903.77,579.12L903.62,578.48L903.99,577.56L904.85,576.14L905.52,575.56L906,575.82L906.3,576.27L906.4,576.89L906.5,576.97L906.64,576.97L907,576.48L907.33,576.29L907.46,576.34L907.6,576.33L907.62,576.02L907.37,575.16L907.39,574.65L907.69,574.5L908.01,573.92L908.35,572.92L908.76,572.4L909.24,572.38L909.75,571.97L910.31,571.17L910.81,570.94L911.25,571.28L911.81,571.3L912.47,571.01L913.64,570.17L915.29,568.77L916.13,567.64L916.15,566.77L916.79,564.65L918.07,561.27L918.69,559.07L918.67,558.07L918.49,557.25L918.15,556.62L918.36,556.12L919.47,555.58L919.46,557L919.46,558.42L919.46,559.85L919.46,561.27L919.47,562.69L919.47,564.1L919.47,565.52L919.47,566.93L920.69,566.93L921.92,566.93L923.15,566.93L924.37,566.93L925.6,566.93L926.82,566.93L928.05,566.93z" data-jurisdiction="WV" id="WV" title="West Virginia"></path>
<path class="land" d="M698.16,525.95L698.17,529.15L698.18,532.33L698.19,535.51L698.2,538.67L698.2,541.82L698.21,544.96L698.22,548.08L698.23,551.2L695.27,551.2L692.32,551.2L689.36,551.2L686.4,551.2L683.45,551.2L680.49,551.2L677.54,551.2L674.58,551.2L671.62,551.2L668.67,551.2L665.71,551.2L662.75,551.2L659.8,551.2L656.84,551.2L653.89,551.2L650.93,551.2L648.57,551.2L646.21,551.2L643.86,551.2L641.5,551.2L639.14,551.2L636.78,551.2L634.42,551.2L632.07,551.2L632.07,549.64L632.07,548.08L632.07,546.52L632.07,544.96L632.07,543.39L632.07,541.82L632.07,540.25L632.06,538.67L632.06,536.7L632.06,534.72L632.06,532.74L632.06,530.75L632.06,528.76L632.06,526.76L632.06,524.76L632.06,522.75L632.06,520.74L632.06,518.72L632.06,516.7L632.06,514.67L632.06,512.63L632.06,510.59L632.05,508.55L632.05,506.5L632.06,504.84L632.06,503.19L632.06,501.53L632.06,499.86L634.12,499.86L636.19,499.86L638.25,499.86L640.31,499.86L642.38,499.86L644.44,499.86L646.5,499.86L648.57,499.86L650.63,499.86L652.69,499.86L654.76,499.86L656.82,499.86L658.88,499.86L660.94,499.86L663.01,499.86L665.07,499.86L667.13,499.86L669.2,499.86L671.26,499.86L673.32,499.86L675.39,499.86L677.45,499.86L679.51,499.86L681.58,499.86L683.64,499.86L685.7,499.86L687.77,499.86L689.83,499.86L691.89,499.86L693.96,499.86L696.02,499.86L698.08,499.86L698.09,503.17L698.1,506.47L698.11,509.75L698.12,513.02L698.13,516.27L698.14,519.51L698.15,522.73z" data-jurisdiction="WY" id="WY" title="Wyoming"></path>
</g>
<g aria-label="Territories" class="e9-territories" id="e9Territories">
<rect data-jurisdiction="PR" height="20" id="PR" rx="3" ry="3" width="32" x="30" y="530"></rect>
<text font-family="Arial" font-size="10" text-anchor="middle" x="46" y="544">PR</text>
<rect data-jurisdiction="VI" height="20" id="VI" rx="3" ry="3" width="32" x="70" y="530"></rect>
<text font-family="Arial" font-size="10" text-anchor="middle" x="86" y="544">VI</text>
</g>
</svg>
</div>
<aside aria-label="USA map legend" class="e9map-legend">
<div class="e9map-legend-title">Legend</div>
<div class="e9map-legend-body" id="e9MapLegend">
          Legend will be generated in later deliverables (bins + labels).
        </div>
<div class="e9map-legend-footnote">
          Map colors reflect the selected layer’s bins per StateMapMetricsV1 rules.
        </div>
</aside>
</div>
<!-- Hover tooltip -->
<div aria-hidden="true" id="enh9MapTooltip" role="tooltip"></div>
<!-- Click toast -->
<div aria-hidden="true" aria-live="polite" id="enh9MapToast">
<div class="e9map-toast-header">
<div class="e9map-toast-title" id="e9MapToastTitle">State Details</div>
<button class="e9map-toast-close" id="e9MapToastCloseBtn" title="Close" type="button">×</button>
</div>
<div class="e9map-toast-body" id="e9MapToastBody">
        Click a state to load its structured details (templates and severity rules implemented in later deliverables).
      </div>
</div>
<div style="font-size:12px; color:#64748b; margin-top:10px;">
      Note: Amount details will display only if present in the local offline dataset for this build.
    </div>
</div>
</div><div class="vnext-card" id="enh9D5ExplainabilityContinuityCard" style="margin-top:12px;display:none;">
<div class="section-title-row">
<h2 class="history-table-title">Enhancement #9 — Explainability Continuity (D5)</h2>
<label class="section-toggle"><input checked="" id="toggleEnh9D5" type="checkbox"/> Visible</label>
</div>
<div id="enh9D5Content">
<div style="font-size:12px; color:#334155; line-height:1.45; margin-bottom:10px;">
      vE9 does not generate new explainability narratives. It binds to, references, and reuses the locked vE3.5.10 explainability artifacts and augments them only with transparent score math and bounded CXT disclosure (non-causal).
    </div>
<div style="display:flex; gap:12px; flex-wrap:wrap;">
<div style="flex:1 1 320px; min-width:280px; border:1px solid rgba(0,0,0,.08); border-radius:12px; padding:10px; background:rgba(248,250,252,.9);">
<div style="font-weight:800; font-size:13px; margin-bottom:6px;">Explainability Reference Model (EXREF)</div>
<div style="font-size:12px; color:#475569; line-height:1.4;">
          Canonical pointer format:
          <code style="background:rgba(15,23,42,.06); padding:2px 6px; border-radius:8px;">EXREF::&lt;artifactType&gt;::&lt;artifactId&gt;::&lt;sectionId&gt;</code>
<div style="margin-top:6px;">
            Examples:
            <ul style="margin:6px 0 0 18px; padding:0;">
<li><code>EXREF::CLUSTER::DOMINANT_MONTHS::SUMMARY</code></li>
<li><code>EXREF::OUTLIER::RARE_CONDITIONS::DETAILS</code></li>
<li><code>EXREF::STATE::REPRESENTATION::OVER_UNDER_SUMMARY</code></li>
<li><code>EXREF::OVERLAY::MACRO_POLICY::NARRATIVE</code></li>
</ul>
</div>
</div>
</div>
<div style="flex:1 1 360px; min-width:300px; border:1px solid rgba(0,0,0,.08); border-radius:12px; padding:10px; background:rgba(248,250,252,.9);">
<div style="font-weight:800; font-size:13px; margin-bottom:6px;">Validity Checklist (Fail-Closed)</div>
<div style="font-size:12px; color:#475569; line-height:1.45;">
          A vE9 prediction is invalid unless all are satisfied:
          <ul style="margin:6px 0 0 18px; padding:0;">
<li>At least one EXREF exists for each enabled scoring module</li>
<li>No EXREF references a disabled module</li>
<li>CXT disclosure is present only if CXT applied</li>
<li>EXREFs map to actual locked vE3.5.10 explainability sections</li>
<li>Audit ledger stores the EXREF list verbatim</li>
</ul>
<div style="margin-top:8px; font-size:12px; color:#334155;">
            If any check fails, the prediction is excluded from the output panel.
          </div>
</div>
</div>
</div>
<div style="margin-top:10px; font-size:12px; color:#334155; line-height:1.45;">
      Decomposition path: Prediction (UI) → auditRef → Audit Ledger Entry → Module Scores → Explainability Refs (EXREF) → Locked vE3.5.10 sections.
    </div>
<div class="explain-clickhint" style="margin-top:10px;">
      “Why?” drill-down resolves strictly via the audit ledger and surfaces EXREF pointers and locked explainability references without rewording any vE3.5.10 text.
    </div>
</div>
</div><div class="vnext-card" id="enh9D6EthicalStatisticalCard" style="margin-top:12px;display:none;">
<div class="section-title-row">
<h2 class="history-table-title">Enhancement #9 — Ethical &amp; Statistical Framing (D6)</h2>
<label class="section-toggle"><input checked="" id="toggleEnh9D6" type="checkbox"/> Visible</label>
</div>
<div id="enh9D6Content">
<div style="font-size:12px; color:#334155; line-height:1.45; margin-bottom:10px;">
      This section documents what vE9 outputs mean, what they do not claim, and how to interpret them responsibly.
      It is informational only and does not alter the scoring contract or locked explainability narratives.
    </div>
<div style="display:flex; gap:12px; flex-wrap:wrap;">
<div style="flex:1 1 320px; min-width:280px; border:1px solid rgba(148,163,184,.55); border-radius:12px; padding:10px; background:rgba(248,250,252,.9);">
<div style="font-weight:800; font-size:13px; color:#0f172a;">What vE9 does</div>
<ul style="margin:6px 0 0 18px; padding:0; font-size:12px; color:#334155; line-height:1.45;">
<li>Ranks candidate sets deterministically using the locked scoring contract (Deliverable #3) and the audit ledger.</li>
<li>Assigns a <b>confidence tier</b> using <b>percentile banding only</b> (A/B/C/D), relative to the candidate set for that run.</li>
<li>Provides a short rationale using fixed phrase mappings based on the largest absolute module contributions (drivers).</li>
<li>Passes through locked explainability references (vE3.5.10) unchanged, enabling “Why?” drill-down via the audit ledger.</li>
</ul>
</div>
<div style="flex:1 1 320px; min-width:280px; border:1px solid rgba(148,163,184,.55); border-radius:12px; padding:10px; background:rgba(248,250,252,.9);">
<div style="font-weight:800; font-size:13px; color:#0f172a;">What vE9 does not claim</div>
<ul style="margin:6px 0 0 18px; padding:0; font-size:12px; color:#334155; line-height:1.45;">
<li>No claim of improved lottery odds, win guarantees, or causal inference about outcomes.</li>
<li>No claim that tiers represent absolute probabilities; tiers are <b>relative ranks</b> within the evaluated candidate pool.</li>
<li>No claim that contextual indicators (CXT) cause or predict draws; CXT is disclosed as <b>non-causal</b> and isolated.</li>
<li>No claim of state-specific, political, or demographic targeting; the model does not encode such causal assertions.</li>
</ul>
</div>
<div style="flex:1 1 320px; min-width:280px; border:1px solid rgba(148,163,184,.55); border-radius:12px; padding:10px; background:rgba(248,250,252,.9);">
<div style="font-weight:800; font-size:13px; color:#0f172a;">How to interpret the output</div>
<ul style="margin:6px 0 0 18px; padding:0; font-size:12px; color:#334155; line-height:1.45;">
<li>Use tiers as an ordering heuristic, not as a forecast of real-world outcomes.</li>
<li>If scores are tightly clustered, treat differences between nearby ranks as practically insignificant.</li>
<li>Only trust “Why?” explanations that resolve to the audit ledger and locked vE3.5.10 sections.</li>
<li>When required ledger paths are missing or validation fails, vE9 fails closed and excludes outputs.</li>
</ul>
<div style="margin-top:8px; font-size:12px; color:#334155;">
<b>Disclaimer:</b> vE9 confidence tiers are <b>relative ranking bands</b> derived from candidate percentiles for a single run, not absolute winning probabilities.
        </div>
</div>
</div>
<div style="margin-top:10px; font-size:12px; color:#334155; line-height:1.45;">
      Implementation note: This panel is informational. It must not mutate scoring inputs, module weights, explainability text, or historical data state.
    </div>
</div>
</div><div class="vnext-card" id="enh9D7GovernanceCard" style="margin-top:12px;display:none;">
<div class="section-title-row">
<h2 class="history-table-title">Enhancement #9 — Governance Pack (D7)</h2>
<label class="section-toggle"><input checked="" id="toggleEnh9D7" type="checkbox"/> Visible</label>
</div>
<div id="enh9D7Content">
<div style="font-size:12px; color:#334155; line-height:1.45; margin-bottom:10px;">
      Versioned governance constants and schema guards. This section is informational and enforces fail-closed validation for vE9 run artifacts.
    </div>
<div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:10px;">
<button class="btn-purple" id="e9ShowConfigBtn" type="button">Show vE9 Config</button>
<button class="btn-purple" id="e9ExportConfigBtn" type="button">Export Config JSON</button>
<button class="btn-purple" id="e9RunSchemaSelfTestBtn" type="button">Run Schema Self-Test</button>
<div id="e9SchemaSelfTestMsg" style="font-size:12px; color:#0f172a; opacity:.9;"></div>
</div>
<div style="border:1px solid rgba(148,163,184,.55); border-radius:12px; padding:10px; background:rgba(248,250,252,.9);">
<div style="font-weight:800; font-size:13px; color:#0f172a; margin-bottom:6px;">PB_E9_CONFIG_V1 (runtime view)</div>
<pre id="e9ConfigView" style="margin:0; white-space:pre-wrap; font-size:11.5px; line-height:1.35; color:#0f172a; max-height:220px; overflow:auto;">(click “Show vE9 Config”)</pre>
</div>
</div>
</div>
<script>
/* =========================================================
   Enhancement #3 — vE3.1/vE3.2 dataset + vE3.3 analytics
========================================================= */
(function(){
  "use strict";
  const ENH3_HITS_LS_KEY = "pb_vnext_jackpot_hits_vE3_2";
  const ENH3_CLEARED_FLAG = "pb_vnext_jackpot_hits_user_cleared";
  const ENH3_SCHEMA_VERSION = "pb_jackpot_hits_vE3_2";
  const ENH3_VALIDATION_LS_KEY = "pb_vnext_jackpot_validations_vE3_3";
  // Window selector (years) — analysis-view only (does not mutate stored dataset)
  const ENH3_YEARS_WINDOW_LS_KEY = "pb_vnext_enh3_years_window";
  const ENH3_YEARS_MAX_CAP = 20;
  function enh3GetSelectedYears(){
    const v = parseInt(localStorage.getItem(ENH3_YEARS_WINDOW_LS_KEY) || "10", 10);
    return (Number.isFinite(v) && v>=1) ? v : 10;
  }
  function enh3SetSelectedYears(v){
    const n = Math.max(1, Math.min(ENH3_YEARS_MAX_CAP, parseInt(v,10)||10));
    localStorage.setItem(ENH3_YEARS_WINDOW_LS_KEY, String(n));
    return n;
  }
  function enh3ComputeAvailableYears(ds){
    try{
      const hits = (ds && Array.isArray(ds.hits)) ? ds.hits : [];
      const dates = hits.map(h=>String(h.drawDate||"").trim()).filter(d=>/^\d{4}-\d{2}-\d{2}$/.test(d)).sort();
      if (!dates.length) return 10; // default UI until dataset exists
      const min = parseISODate(dates[0]);
      const max = parseISODate(dates[dates.length-1]);
      if (!min || !max) return 10;
      const spanYears = Math.max(1, (max.getFullYear() - min.getFullYear() + 1));
      return Math.max(1, Math.min(ENH3_YEARS_MAX_CAP, spanYears));
    } catch(e){
      return 10;
    }
  }
  function enh3WindowFilterHits(ds, years){
    const hits = (ds && Array.isArray(ds.hits)) ? ds.hits : [];
    const ys = Math.max(1, parseInt(years,10)||10);
    // Use latest drawDate in dataset as anchor; fall back to "today"
    const dates = hits.map(h=>String(h.drawDate||"").trim()).filter(d=>/^\d{4}-\d{2}-\d{2}$/.test(d)).sort();
    const anchor = dates.length ? parseISODate(dates[dates.length-1]) : new Date();
    if (!anchor) return hits.slice();
    const cutoff = new Date(anchor.getTime());
    cutoff.setFullYear(cutoff.getFullYear() - ys);
    // Include anchor-year as full window: cutoff is (anchor - ys years), we include >= cutoff
    return hits.filter(h=>{
      const d = parseISODate(h.drawDate);
      return d && d.getTime() >= cutoff.getTime();
    });
  }
  function enh3SyncYearsUI(ds){
    const sel = document.getElementById("enh3YearsSelect");
    const btn = document.getElementById("enh3SeedBaselineBtn");
    const inline = document.getElementById("enh3InlineMsg");
    if (!sel) return;
    const avail = enh3ComputeAvailableYears(ds);
    const curRaw = enh3GetSelectedYears();
    const cur = Math.min(curRaw, avail);
    if (cur !== curRaw && inline){
      inline.textContent = `Years clamped to ${avail} based on available dataset span.`;
    } else if (inline){
      // do not clear messages from other actions unless it's specifically about clamping
      if ((inline.textContent||"").startsWith("Years clamped")) inline.textContent = "";
    }
    // rebuild options only when necessary
    const desiredOpts = [];
    for (let i=1;i<=avail;i++) desiredOpts.push(String(i));
    const existingVals = Array.from(sel.options).map(o=>o.value);
    const same = existingVals.length===desiredOpts.length && existingVals.every((v, i)=>v===desiredOpts[i]);
    if (!same){
      sel.innerHTML = "";
      desiredOpts.forEach(v=>{
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        sel.appendChild(opt);
      });
    }
    sel.value = String(cur);
    enh3SetSelectedYears(cur);
    if (btn){
      btn.textContent = `Seed Baseline (10Y)`; // baseline is currently 10Y seed
      btn.title = "Seeds the curated 10-year baseline dataset included in this build.";
    }
  }
  function enh3ApplyWindowAndRender(ds){
    const years = enh3GetSelectedYears();
    const windowed = Object.assign({}, ds || datasetShell([]));
    windowed.hits = enh3WindowFilterHits(ds, years);
    // Render the windowed view, but keep storage intact
    renderHits(windowed, ds);
    // State rates view depends on what is rendered
    try { if (typeof renderStateRates === "function") renderStateRates(windowed); } catch(e){}
    try { if (typeof renderPatternAnalytics === "function") renderPatternAnalytics(windowed); } catch(e){}
  }
  const DEFAULT_SEED_TICKETS_10Y = [{"drawDate": "2025-12-24", "state": "AR", "jackpotAdvertised": 1816800000, "cashValue": 834900000}, {"drawDate": "2025-09-06", "state": "MO", "jackpotAdvertised": 1787400000, "cashValue": 820600000}, {"drawDate": "2025-09-06", "state": "TX", "jackpotAdvertised": 1787400000, "cashValue": 820600000}, {"drawDate": "2025-06-18", "state": "CA", "jackpotAdvertised": 204000000, "cashValue": 92000000}, {"drawDate": "2025-04-26", "state": "KY", "jackpotAdvertised": 167300000, "cashValue": 77000000}, {"drawDate": "2025-04-19", "state": "OR", "jackpotAdvertised": 146400000, "cashValue": 67500000}, {"drawDate": "2025-02-12", "state": "NY", "jackpotAdvertised": 526500000, "cashValue": 255000000}, {"drawDate": "2025-01-18", "state": "OR", "jackpotAdvertised": 328500000, "cashValue": 146400000}, {"drawDate": "2025-01-15", "state": "OR", "jackpotAdvertised": 231000000, "cashValue": 104800000}, {"drawDate": "2024-10-21", "state": "GA", "jackpotAdvertised": 478200000, "cashValue": 222600000}, {"drawDate": "2024-09-09", "state": "TX", "jackpotAdvertised": 810000000, "cashValue": 408000000}, {"drawDate": "2024-03-06", "state": "PA", "jackpotAdvertised": 687800000, "cashValue": 342300000}, {"drawDate": "2024-01-01", "state": "MI", "jackpotAdvertised": 842400000, "cashValue": 425200000}, {"drawDate": "2023-10-11", "state": "CA", "jackpotAdvertised": 1765000000, "cashValue": 774100000}, {"drawDate": "2023-07-19", "state": "CA", "jackpotAdvertised": 1080000000, "cashValue": 558100000}, {"drawDate": "2023-04-19", "state": "OH", "jackpotAdvertised": 252600000, "cashValue": 134000000}, {"drawDate": "2023-02-06", "state": "WA", "jackpotAdvertised": 754600000, "cashValue": 407200000}, {"drawDate": "2023-02-06", "state": "OR", "jackpotAdvertised": 754600000, "cashValue": 407200000}, {"drawDate": "2023-01-23", "state": "MA", "jackpotAdvertised": 473100000, "cashValue": 253700000}, {"drawDate": "2022-11-07", "state": "CA", "jackpotAdvertised": 2040000000, "cashValue": 997600000}, {"drawDate": "2022-08-03", "state": "PA", "jackpotAdvertised": 206900000, "cashValue": 116000000}, {"drawDate": "2022-07-13", "state": "IL", "jackpotAdvertised": 1000000000, "cashValue": 498000000}, {"drawDate": "2022-04-27", "state": "AZ", "jackpotAdvertised": 473100000, "cashValue": 283300000}, {"drawDate": "2022-04-27", "state": "MO", "jackpotAdvertised": 473100000, "cashValue": 283300000}, {"drawDate": "2022-01-05", "state": "CA", "jackpotAdvertised": 632600000, "cashValue": 450200000}, {"drawDate": "2021-10-04", "state": "CA", "jackpotAdvertised": 699800000, "cashValue": 496000000}, {"drawDate": "2021-06-05", "state": "PA", "jackpotAdvertised": 155400000, "cashValue": 79000000}, {"drawDate": "2021-03-27", "state": "MD", "jackpotAdvertised": 730000000, "cashValue": 546000000}, {"drawDate": "2021-01-30", "state": "MI", "jackpotAdvertised": 337000000, "cashValue": 256700000}, {"drawDate": "2021-01-23", "state": "MD", "jackpotAdvertised": 731100000, "cashValue": 546800000}, {"drawDate": "2021-01-20", "state": "MD", "jackpotAdvertised": 731100000, "cashValue": 546800000}, {"drawDate": "2020-11-04", "state": "PA", "jackpotAdvertised": 140000000, "cashValue": 89700000}, {"drawDate": "2020-10-03", "state": "NJ", "jackpotAdvertised": 120600000, "cashValue": 72700000}, {"drawDate": "2020-10-03", "state": "MI", "jackpotAdvertised": 120600000, "cashValue": 72700000}, {"drawDate": "2020-09-16", "state": "FL", "jackpotAdvertised": 133700000, "cashValue": 79500000}, {"drawDate": "2020-05-27", "state": "NJ", "jackpotAdvertised": 349300000, "cashValue": 263500000}, {"drawDate": "2020-03-07", "state": "WI", "jackpotAdvertised": 156200000, "cashValue": 113100000}, {"drawDate": "2019-12-18", "state": "MI", "jackpotAdvertised": 50000000, "cashValue": 32100000}, {"drawDate": "2019-10-26", "state": "MD", "jackpotAdvertised": 150000000, "cashValue": 105200000}, {"drawDate": "2019-08-17", "state": "NY", "jackpotAdvertised": 319600000, "cashValue": 196700000}, {"drawDate": "2019-06-10", "state": "CA", "jackpotAdvertised": 447800000, "cashValue": 279100000}, {"drawDate": "2019-03-27", "state": "WI", "jackpotAdvertised": 768400000, "cashValue": 477000000}, {"drawDate": "2019-03-09", "state": "PA", "jackpotAdvertised": 687800000, "cashValue": 462000000}, {"drawDate": "2019-01-23", "state": "NY", "jackpotAdvertised": 234900000, "cashValue": 140700000}, {"drawDate": "2018-10-27", "state": "IA", "jackpotAdvertised": 687800000, "cashValue": 396200000}, {"drawDate": "2018-08-11", "state": "NY", "jackpotAdvertised": 153000000, "cashValue": 87800000}, {"drawDate": "2018-05-19", "state": "PA", "jackpotAdvertised": 456700000, "cashValue": 269800000}, {"drawDate": "2018-02-14", "state": "PA", "jackpotAdvertised": 559700000, "cashValue": 336400000}, {"drawDate": "2018-01-06", "state": "NH", "jackpotAdvertised": 559700000, "cashValue": 349300000}, {"drawDate": "2017-10-25", "state": "MA", "jackpotAdvertised": 758700000, "cashValue": 480500936}, {"drawDate": "2017-09-16", "state": "MA", "jackpotAdvertised": 133700000, "cashValue": 79600000}, {"drawDate": "2017-08-23", "state": "MA", "jackpotAdvertised": 758700000, "cashValue": 480500000}, {"drawDate": "2017-06-10", "state": "CA", "jackpotAdvertised": 447800000, "cashValue": 279100000}, {"drawDate": "2017-04-01", "state": "MA", "jackpotAdvertised": 435300000, "cashValue": 261500000}, {"drawDate": "2017-03-22", "state": "IN", "jackpotAdvertised": 435300000, "cashValue": 263300000}, {"drawDate": "2017-02-22", "state": "VA", "jackpotAdvertised": 435300000, "cashValue": 191100000}, {"drawDate": "2016-12-17", "state": "TN", "jackpotAdvertised": 420900000, "cashValue": 251800000}, {"drawDate": "2016-08-24", "state": "TN", "jackpotAdvertised": 420900000, "cashValue": 264000000}, {"drawDate": "2016-07-09", "state": "IN", "jackpotAdvertised": 435300000, "cashValue": 191100000}, {"drawDate": "2016-01-13", "state": "CA", "jackpotAdvertised": 1500000000, "cashValue": 930900000}, {"drawDate": "2016-01-13", "state": "FL", "jackpotAdvertised": 1500000000, "cashValue": 930900000}, {"drawDate": "2016-01-13", "state": "TN", "jackpotAdvertised": 1500000000, "cashValue": 930900000}];
  const STATE_POP_2026 = {"CA": 39896400, "TX": 32416700, "FL": 24306900, "NY": 20127000, "PA": 13200800, "OH": 12001800, "GA": 11413800, "NC": 11375700, "MI": 10254700, "NJ": 9743270, "VA": 8964220, "WA": 8159900, "AZ": 7801100, "TN": 7386640, "MA": 7275380, "IN": 7012560, "MD": 6355540, "MO": 6320320, "CO": 6069800, "WI": 6022120, "KY": 4663930, "LA": 4617080, "OR": 4309810, "CT": 3739160, "IA": 3287640, "AR": 3126140, "KS": 3008820, "WV": 1768950, "NH": 1422700, "DE": 1082900, "IL": 12846000};
  function toast(msg, level){
    try{
      if (typeof window.showToast === "function") return window.showToast(msg, level || "info");
    }catch(_){}
    const el = document.getElementById("enh3InlineMsg");
    if (el) { el.textContent = msg; setTimeout(()=>{ if(el.textContent===msg) el.textContent=""; }, 4500); }
  }
  
  // Compatibility shim: some modules call showInfoPopup()/showSuccessPopup().
  // Provide safe fallbacks to avoid ReferenceError and preserve UI messaging.
  window.showInfoPopup = window.showInfoPopup || function(message){
    try{ return toast(String(message||''), "info"); }catch(e){}
    try{ if (typeof showErrorToast === "function") return showErrorToast(String(message||'')); }catch(e){}
    try{ alert(String(message||'')); }catch(e){}
  };
  window.showSuccessPopup = window.showSuccessPopup || function(message){
    try{ return toast(String(message||''), "success"); }catch(e){}
    try{ if (typeof showErrorToast === "function") return showErrorToast(String(message||'')); }catch(e){}
  };

function isoNow(){ return new Date().toISOString(); }
  function parseISODate(d){
    const dt = new Date(String(d).trim()+"T00:00:00");
    return isNaN(dt.getTime()) ? null : dt;
  }
  function dayOfWeekShort(dt){
    return ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][dt.getDay()] || "";
  }
  function jackpotBucket(annuity){
    const v = Number(annuity)||0;
    if (v >= 1000000000) return "1B+";
    if (v >= 700000000) return "700M-999M";
    if (v >= 400000000) return "400M-699M";
    if (v >= 200000000) return "200M-399M";
    if (v >= 100000000) return "100M-199M";
    if (v >= 50000000) return "50M-99M";
    if (v > 0) return "<50M";
    return "";
  }
  // Count draw-days (Mon/Wed/Sat) between two dates (exclusive of start, inclusive of end)
  function countDrawDaysBetween(prevDt, currDt){
    if (!prevDt || !currDt) return null;
    if (currDt <= prevDt) return 0;
    let count = 0;
    const d = new Date(prevDt.getTime());
    d.setDate(d.getDate()+1);
    while (d <= currDt){
      const dow = d.getDay();
      if (dow===1 || dow===3 || dow===6) count++;
      d.setDate(d.getDate()+1);
    }
    return count;
  }
  function currency(n){
    const v = Number(n);
    if (!isFinite(v)) return "";
    try{
      return v.toLocaleString(undefined, { style:"currency", currency:"USD", maximumFractionDigits:0 });
    }catch(_){
      return "$" + Math.round(v).toLocaleString();
    }
  }
  function safeJsonParse(s){
    try{ return JSON.parse(s); } catch(_){ return null; }
  }
  function buildHitsFromTickets(tickets){
    // tickets: [{drawDate, state, jackpotAdvertised, cashValue}]
    const map = new Map();
    for (const t of (tickets||[])){
      const dd = String(t.drawDate||"").trim();
      if (!dd) continue;
      const key = dd;
      if (!map.has(key)){
        map.set(key, {
          hitId: "JH-"+dd.replaceAll("-","")+"-001",
          drawDate: dd,
          jackpotAdvertised: Number(t.jackpotAdvertised)||0,
          cashValue: (t.cashValue===null||t.cashValue===undefined) ? null : Number(t.cashValue)||0,
          winnerCount: null,
          winnerStates: [],
          retailerCity: null,
          retailerCounty: null,
          numbers: null,
          notes: "",
          source: { method:"seed", refs:[] },
          enriched: null,
          __tickets: []
        });
      }
      const rec = map.get(key);
      const st = String(t.state||"").trim();
      if (st && !rec.winnerStates.includes(st)) rec.winnerStates.push(st);
      rec.__tickets.push(st || null);
      // prefer max jackpot/cash if inconsistent
      rec.jackpotAdvertised = Math.max(rec.jackpotAdvertised||0, Number(t.jackpotAdvertised)||0);
      if (t.cashValue!==null && t.cashValue!==undefined){
        rec.cashValue = Math.max(Number(rec.cashValue)||0, Number(t.cashValue)||0);
      }
    }
    // sort by date desc
    const hits = Array.from(map.values()).sort((a,b)=> (b.drawDate||"").localeCompare(a.drawDate||""));
    return hits;
  }
  function enrichHits(hits){
    // Compute buckets, seasonality, rollDrawsToHit, growthPerDraw
    const sortedAsc = (hits||[]).slice().sort((a,b)=> (a.drawDate||"").localeCompare(b.drawDate||""));
    let prevDt = null;
    for (const h of sortedAsc){
      const dt = parseISODate(h.drawDate);
      const rollDraws = (prevDt && dt) ? countDrawDaysBetween(prevDt, dt) : null;
      const growth = (rollDraws && rollDraws>0) ? ((Number(h.jackpotAdvertised)||0)/rollDraws) : null;
      h.enriched = Object.assign({}, h.enriched||{}, {
        enrichmentVersion: "vE3_2",
        epochMs: dt ? dt.getTime() : null,
        year: dt ? dt.getFullYear() : null,
        month: dt ? (dt.getMonth()+1) : null,
        dow: dt ? dayOfWeekShort(dt) : null,
        jackpotBucket: jackpotBucket(h.jackpotAdvertised),
        rollDrawsToHit: rollDraws,
        growthPerDraw: growth
      });
      prevDt = dt || prevDt;
    }
    return hits;
  }
  function datasetShell(hits){
    return { schemaVersion: ENH3_SCHEMA_VERSION, updatedAt: isoNow(), hits: hits||[] };
  }
  function loadDataset(){
    const raw = localStorage.getItem(ENH3_HITS_LS_KEY);
    if (!raw) return null;
    const obj = safeJsonParse(raw);
    if (!obj || !Array.isArray(obj.hits)) return null;
    return obj;
  }
  function saveDataset(ds){
    ds.updatedAt = isoNow();
    localStorage.setItem(ENH3_HITS_LS_KEY, JSON.stringify(ds));
    return ds;
  }
  function setClearedFlag(v){
    if (v) localStorage.setItem(ENH3_CLEARED_FLAG, "1");
    else localStorage.removeItem(ENH3_CLEARED_FLAG);
  }
  function isCleared(){
    return localStorage.getItem(ENH3_CLEARED_FLAG)==="1";
  }
  function renderHits(dsView, dsFull){
    const tbody = document.getElementById("enh3HitsTbody");
    const status = document.getElementById("enh3DatasetStatus");
    const countEl = document.getElementById("enh3HitCount");
    if (!tbody || !status || !countEl) return;
    const fullHits = (dsFull && Array.isArray(dsFull.hits)) ? dsFull.hits : null;
    const hits = (dsView && Array.isArray(dsView.hits)) ? dsView.hits : [];
    // "Total Hits" reflects the currently applied window (analysis view)
    countEl.textContent = String(hits.length||0);
    if (!dsView) {
      status.textContent = "Not loaded";
    } else if (!hits.length) {
      status.textContent = "Empty (Seed or Import)";
    } else {
      const years = enh3GetSelectedYears();
      const total = Array.isArray(fullHits) ? fullHits.length : hits.length;
      status.textContent = (Array.isArray(fullHits) && total !== hits.length)
        ? `Loaded (${years}Y window; showing ${hits.length} of ${total})`
        : `Loaded (${years}Y window; ${hits.length})`;
    }
    tbody.innerHTML = "";
    if (!hits.length){
      const tr = document.createElement("tr");
      tr.innerHTML = '<td colspan="9" style="text-align:center; padding:14px; color:#666;">No jackpot hit records loaded.</td>';
      tbody.appendChild(tr);
      return;
    }
    for (const h of hits){
      const tr = document.createElement("tr");
      const states = (h.winnerStates||[]).join(", ");
      const nums = h.numbers && h.numbers.main ? (h.numbers.main.join("-")+" PB "+h.numbers.powerball) : "";
      tr.innerHTML = `
        <td>${h.drawDate||""}</td>
        <td>${currency(h.jackpotAdvertised)}</td>
        <td>${h.cashValue===null || h.cashValue===undefined ? "" : currency(h.cashValue)}</td>
        <td>${h.winnerCount===null || h.winnerCount===undefined ? "" : h.winnerCount}</td>
        <td>${states}</td>
        <td>${h.retailerCity||""}</td>
        <td>${h.retailerCounty||""}</td>
        <td>${nums}</td>
        <td>${h.notes||""}</td>
      `;
      tbody.appendChild(tr);
    }
  }
  function seedBaseline(force){
    const dsExisting = loadDataset();
    if (!force && dsExisting && Array.isArray(dsExisting.hits) && dsExisting.hits.length){
      toast("Dataset already populated. Use Clear first or Import a replacement.", "info");
      return dsExisting;
    }
    const hits = enrichHits(buildHitsFromTickets(DEFAULT_SEED_TICKETS_10Y));
    const ds = datasetShell(hits);
    saveDataset(ds);
    setClearedFlag(false);
    enh3SyncYearsUI(ds);
    enh3ApplyWindowAndRender(ds);
    toast("Seeded baseline jackpot hit dataset (10Y).", "success");
    return ds;
  }
  function maybeAutoSeed(){
    // Auto-seed if missing OR empty, but never after an explicit user clear.
    if (isCleared()) return;
    const ds = loadDataset();
    if (!ds || !Array.isArray(ds.hits) || ds.hits.length===0){
      seedBaseline(true);
    } else {
      enh3SyncYearsUI(ds);
      enh3ApplyWindowAndRender(ds);
    }
  }
  function exportDataset(){
    const ds = loadDataset() || datasetShell([]);
    const blob = new Blob([JSON.stringify(ds, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "pb_jackpot_hits_vE3_2_"+(new Date().toISOString().slice(0,10))+".json";
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
    toast("Exported jackpot hit dataset.", "success");
  }
  function validateRecord(rec){
    const errs=[];
    if (!rec || typeof rec!=="object") { errs.push("Record is not an object"); return errs; }
    if (!rec.drawDate || !/^\d{4}-\d{2}-\d{2}$/.test(rec.drawDate)) errs.push("drawDate must be YYYY-MM-DD");
    if (!Number.isFinite(Number(rec.jackpotAdvertised||0)) || Number(rec.jackpotAdvertised)<0) errs.push("jackpotAdvertised must be >=0");
    if (rec.cashValue!==null && rec.cashValue!==undefined){
      if (!Number.isFinite(Number(rec.cashValue)) || Number(rec.cashValue)<0) errs.push("cashValue must be null or >=0");
    }
    if (rec.winnerCount!==null && rec.winnerCount!==undefined){
      if (!Number.isInteger(Number(rec.winnerCount)) || Number(rec.winnerCount)<1) errs.push("winnerCount must be integer >=1 or null");
    }
    if (rec.winnerStates!==null && rec.winnerStates!==undefined){
      if (!Array.isArray(rec.winnerStates)) errs.push("winnerStates must be array");
    }
    if (rec.numbers!==null && rec.numbers!==undefined){
      const n=rec.numbers;
      if (typeof n!=="object") errs.push("numbers must be object");
      else{
        if (!Array.isArray(n.main) || n.main.length!==5) errs.push("numbers.main must be array length 5");
        if (Array.isArray(n.main)){
          const uniq = new Set(n.main);
          if (uniq.size!==n.main.length) errs.push("numbers.main must be unique");
        }
        if (n.powerball===null || n.powerball===undefined || !Number.isInteger(Number(n.powerball))) errs.push("numbers.powerball must be integer");
      }
    }
    return errs;
  }
  function importDatasetFromFile(file){
    return file.text().then(txt=>{
      const obj = safeJsonParse(txt);
      if (!obj || typeof obj!=="object") throw new Error("Invalid JSON");
      if (!Array.isArray(obj.hits)) throw new Error("JSON must contain hits[]");
      // normalize schema
      const hits = obj.hits.map(h=>Object.assign({}, h));
      // validate
      const allErrs=[];
      for (let i=0;i<hits.length;i++){
        const errs = validateRecord(hits[i]);
        if (errs.length) allErrs.push("Row "+(i+1)+": "+errs.join("; "));
      }
      if (allErrs.length) throw new Error(allErrs.slice(0,8).join(" | "));
      enrichHits(hits);
      const ds = datasetShell(hits);
      saveDataset(ds);
      setClearedFlag(false);
      enh3SyncYearsUI(ds);
      enh3ApplyWindowAndRender(ds);
      toast("Imported jackpot hit dataset.", "success");
      return ds;
    });
  }
  function clearDataset(){
    localStorage.removeItem(ENH3_HITS_LS_KEY);
    setClearedFlag(true);
    renderHits(null, null);
    enh3SyncYearsUI(null);
    const sr = document.getElementById("enh3StateRatesWrap");
    if (sr) sr.style.display="none";
    toast("Cleared jackpot hit dataset.", "info");
  }
  function computeStateRates(ds){
    const hits = (ds && ds.hits) ? ds.hits : [];
    // build ticket counts from winnerStates
    const ticketCounts = {};
    let minY=9999, maxY=0;
    for (const h of hits){
      const y = Number(String(h.drawDate||"").slice(0,4))||0;
      if (y){ minY=Math.min(minY,y); maxY=Math.max(maxY,y); }
      const states = h.winnerStates||[];
      for (const st of states){
        ticketCounts[st] = (ticketCounts[st]||0) + 1;
      }
    }
    const spanYears = (minY<=maxY && maxY>0) ? Math.max(1, (maxY - minY + 1)) : 1;
    const rows = Object.keys(ticketCounts).map(st=>{
      const pop = STATE_POP_2026[st] || null;
      const hitsN = ticketCounts[st]||0;
      const perMPerYr = (pop && pop>0) ? (hitsN / (pop/1_000_000) / spanYears) : null;
      return { st, hitsN, pop, spanYears, perMPerYr };
    }).sort((a,b)=> (b.perMPerYr||0)-(a.perMPerYr||0));
    return { rows, spanYears };
  }
  function renderStateRates(ds){
    const wrap = document.getElementById("enh3StateRatesWrap");
    const tbody = document.getElementById("enh3StateRatesTbody");
    if (!wrap || !tbody) return;
    const { rows, spanYears } = computeStateRates(ds);
    tbody.innerHTML = "";
    for (const r of rows){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.st}</td>
        <td>${r.hitsN}</td>
        <td>${r.pop ? r.pop.toLocaleString() : ""}</td>
        <td>${spanYears}</td>
        <td>${(r.perMPerYr===null || r.perMPerYr===undefined) ? "" : r.perMPerYr.toFixed(3)}</td>
      `;
      tbody.appendChild(tr);
    }
    wrap.style.display = wrap.style.display==="none" ? "block" : "none";
  }
  // ---------- Analytics (vE3.3) ----------
  function mean(arr){ return arr.reduce((a,b)=>a+b,0)/Math.max(1,arr.length); }
  function std(arr){
    const m=mean(arr); const v=mean(arr.map(x=>(x-m)*(x-m))); return Math.sqrt(v||0);
  }
  function zscores(arr){
    const m=mean(arr); const s=std(arr)||1;
    return arr.map(x=>(x-m)/s);
  }
  const MONTH_ABBR = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  function monthAbbrev(m){
    const i = Number(m)||0;
    return MONTH_ABBR[i-1] || String(i||"").padStart(2,"0");
  }
function cosine(a,b){
    let dot=0,na=0,nb=0;
    for (let i=0;i<a.length;i++){ dot+=a[i]*b[i]; na+=a[i]*a[i]; nb+=b[i]*b[i]; }
    return dot/(Math.sqrt(na)*Math.sqrt(nb) || 1);
  }
  function buildFeatureMatrix(hits){
    // features: logJackpot, rollDrawsToHit, month, winnerCount
    const X=[];
    const meta=[];
    for (const h of hits){
      const j = Math.log(Math.max(1, Number(h.jackpotAdvertised)||0));
      const roll = (h.enriched && Number.isFinite(Number(h.enriched.rollDrawsToHit))) ? Number(h.enriched.rollDrawsToHit) : 0;
      const mo = (h.enriched && Number.isFinite(Number(h.enriched.month))) ? Number(h.enriched.month) : 0;
      const wc = (h.winnerCount===null || h.winnerCount===undefined) ? 0 : Number(h.winnerCount)||0;
      X.push([j, roll, mo, wc]);
      meta.push(h);
    }
    // normalize columns to z
    const cols = X[0] ? X[0].length : 0;
    const colVals = Array.from({length: cols}, (_,c)=>X.map(r=>r[c]));
    const colZ = colVals.map(v=>zscores(v));
    const Xn = X.map((_,i)=>colZ.map(col=>col[i]));
    return { Xn, meta };
  }
  function kmeans(X, k, iters=20){
    if (!X.length) return { labels:[], centroids:[] };
    // init: first k points
    let centroids = X.slice(0,k).map(v=>v.slice());
    let labels = new Array(X.length).fill(0);
    for (let it=0; it<iters; it++){
      // assign
      for (let i=0;i<X.length;i++){
        let best=0, bestSim=-Infinity;
        for (let c=0;c<k;c++){
          const sim = cosine(X[i], centroids[c]);
          if (sim>bestSim){ bestSim=sim; best=c; }
        }
        labels[i]=best;
      }
      // recompute
      const sums = Array.from({length:k}, ()=>new Array(X[0].length).fill(0));
      const counts = new Array(k).fill(0);
      for (let i=0;i<X.length;i++){
        const c=labels[i];
        counts[c]+=1;
        for (let j=0;j<X[0].length;j++) sums[c][j]+=X[i][j];
      }
      for (let c=0;c<k;c++){
        if (counts[c]===0) continue;
        centroids[c] = sums[c].map(v=>v/counts[c]);
      }
    }
    return { labels, centroids };
  }
  function runAnalytics(){
    const ds = loadDataset();
    const hits = (ds && ds.hits) ? ds.hits : [];
    if (!hits.length){
      toast("No jackpot hits loaded. Seed or Import first.", "warning");
      return;
    }
    const status = document.getElementById("enh3AnalyticsStatus");
    if (status) status.textContent = "Running...";
    const k = Number(document.getElementById("enh3ClusterK")?.value||3);
    const zThr = Number(document.getElementById("enh3OutlierZ")?.value||2.5);
    // Ensure enrichment present
    enrichHits(hits);
    const { Xn, meta } = buildFeatureMatrix(hits);
    const km = kmeans(Xn, Math.max(2, Math.min(5,k)));
    // vE3.4.2 (display-only): publish cluster assignments for overlay-by-cluster summaries
    try { window.__E3_LAST_CLUSTER = { k: k, labels: (km && km.labels) ? km.labels.slice() : [], meta: (meta||[]).slice() }; } catch(e) {}
// cluster table
    const clTbody = document.getElementById("enh3ClustersTbody");
    if (clTbody){
      const buckets = Array.from({length:k}, ()=>[]);
      for (let i=0;i<meta.length;i++){
        const c = km.labels[i]||0;
        if (!buckets[c]) buckets[c]=[];
        buckets[c].push(meta[i]);
      }
      clTbody.innerHTML="";
      const clusterRows = [];
      for (let c=0;c<buckets.length;c++){
        const arr=buckets[c]||[];
        if (!arr.length) continue;
        const avgJ = mean(arr.map(x=>Number(x.jackpotAdvertised)||0));
        const avgC = mean(arr.map(x=>Number(x.cashValue)||0));
        const avgR = mean(arr.map(x=>(x.enriched&&x.enriched.rollDrawsToHit)||0));
        const avgW = mean(arr.map(x=>Number(x.winnerCount)||0));
        const months = {};
        for (const h of arr){
          const m = (h.enriched&&h.enriched.month)||0;
          if (m) months[m]=(months[m]||0)+1;
        }
        const domMonths = Object.entries(months)
          .sort((a,b)=>b[1]-a[1])
          .slice(0,3)
          .map(([m,n])=>monthAbbrev(m)+" ("+n+")")
          .join(", ");
        clusterRows.push({ c, count: arr.length, avgJ, avgC, avgR, avgW, domMonths });
      }
      // Sort clusters by Avg Jackpot (desc)
      clusterRows.sort((a,b)=> (b.avgJ||0) - (a.avgJ||0));
      for (const row of clusterRows){
        const tr=document.createElement("tr");
        tr.innerHTML = `<td>${row.c+1}</td><td>${row.count}</td><td>${currency(row.avgJ)}</td><td>${currency(row.avgC)}</td><td>${row.avgR.toFixed(2)}</td><td>${row.avgW.toFixed(2)}</td><td>${row.domMonths}</td>`;
        clTbody.appendChild(tr);
      }
      if (!clTbody.children.length){
        clTbody.innerHTML='<tr><td colspan="7" style="text-align:center; padding:12px; color:#666;">No clusters produced.</td></tr>';
      }
    }
    // outliers
    const outTbody = document.getElementById("enh3OutliersTbody");
    if (outTbody){
      const logJ = hits.map(h=>Math.log(Math.max(1, Number(h.jackpotAdvertised)||0)));
      const gpd = hits.map(h=> (h.enriched && Number.isFinite(Number(h.enriched.growthPerDraw))) ? Number(h.enriched.growthPerDraw) : 0);
      const zLog = zscores(logJ);
      const zG = zscores(gpd);
      outTbody.innerHTML="";
      const outRows = [];
      for (let i=0;i<hits.length;i++){
        const absZ = Math.max(Math.abs(zLog[i]||0), Math.abs(zG[i]||0));
        const isOut = absZ>=zThr;
        if (!isOut) continue;
        const h=hits[i];
        outRows.push({ h, zLog: zLog[i]||0, zG: zG[i]||0, absZ });
      }
      // Sort by absolute z-score (desc)
      outRows.sort((a,b)=> (b.absZ||0)-(a.absZ||0));
      // vE3.4 (display-only): publish last computed arrays for overlay coverage/annotation
      window.__E3_LAST_HITS = hits;
      window.__E3_LAST_OUTROWS = outRows;
let outCount=0;
      for (const o of outRows){
        outCount++;
        const h=o.h;
        const tr=document.createElement("tr");
        tr.innerHTML = `<td>${h.drawDate}</td><td>${currency(h.jackpotAdvertised)}</td><td>${currency(h.cashValue)}</td><td>${(h.winnerStates||[]).join(", ")}</td><td>${(h.enriched&&h.enriched.rollDrawsToHit)||""}</td><td>${o.zLog.toFixed(2)}</td><td>${o.zG.toFixed(2)}</td><td></td>`;
        outTbody.appendChild(tr);
      }
if (!outCount){
        outTbody.innerHTML='<tr><td colspan="8" style="text-align:center; padding:12px; color:#666;">No outliers at this sensitivity.</td></tr>';
      }
    }
    // state share vs expected
    const stTbody = document.getElementById("enh3StateShareTbody");
    if (stTbody){
      const obs = {};
      let totalObs = 0;
      for (const h of hits){
        for (const st of (h.winnerStates||[])){
          obs[st]=(obs[st]||0)+1;
          totalObs++;
        }
      }
      const totalPop = Object.values(STATE_POP_2026).reduce((a,b)=>a+b,0);
      const rows = Object.keys(obs).map(st=>{
        const o = obs[st]||0;
        const pop = STATE_POP_2026[st]||0;
        const share = totalPop? (pop/totalPop) : 0;
        const exp = share*totalObs;
        const ratio = exp? (o/exp) : 0;
        const chi = exp? ((o-exp)*(o-exp)/exp) : 0;
        return { st, o, exp, ratio, pop, share, chi };
      }).sort((a,b)=>b.ratio-a.ratio);
      stTbody.innerHTML="";
      for (const r of rows){
        const tr=document.createElement("tr");
        tr.innerHTML = `<td>${r.st}</td><td>${r.o}</td><td>${r.exp.toFixed(2)}</td><td>${r.ratio.toFixed(2)}</td><td>${r.pop? r.pop.toLocaleString():""}</td><td>${(r.share*100).toFixed(2)}%</td><td>${r.chi.toFixed(2)}</td>`;
        stTbody.appendChild(tr);
      }
      if (!rows.length){
        stTbody.innerHTML='<tr><td colspan="7" style="text-align:center; padding:12px; color:#666;">No state data available.</td></tr>';
      }
    }
    if (status) status.textContent = "Done.";
  }
  // ---------- Validation Mode ----------
  function loadValidations(){
    const raw = localStorage.getItem(ENH3_VALIDATION_LS_KEY);
    const obj = raw ? safeJsonParse(raw) : null;
    if (!obj || !Array.isArray(obj.rows)) return { rows: [] };
    return obj;
  }
  function saveValidations(v){
    v.updatedAt = isoNow();
    localStorage.setItem(ENH3_VALIDATION_LS_KEY, JSON.stringify(v));
  }
  function renderValidations(){
    const tbody = document.getElementById("enh3ValidationTbody");
    if (!tbody) return;
    const v = loadValidations();
    tbody.innerHTML="";
    if (!v.rows.length){
      tbody.innerHTML='<tr><td colspan="3" style="text-align:center; padding:12px; color:#666;">No validations yet.</td></tr>';
      return;
    }
    for (const r of v.rows.slice().reverse().slice(0,20)){
      const tr=document.createElement("tr");
      tr.innerHTML = `<td>${r.drawDate||""}</td><td>${r.status||""}</td><td style="font-size:12px;">${(r.mismatches||[]).join("; ")}</td>`;
      tbody.appendChild(tr);
    }
  }
  function parseValidationPaste(txt){
    const t = String(txt||"");
    // naive extraction
    const dateMatch = t.match(/\b(20\d{2}-\d{2}-\d{2})\b/);
    const drawDate = dateMatch ? dateMatch[1] : null;
    const jackpotMatch = t.match(/\$\s?([0-9][0-9,]*)\s*(billion|million)?/i);
    let jackpot = null;
    if (jackpotMatch){
      const base = Number(jackpotMatch[1].replaceAll(",",""));
      const unit = (jackpotMatch[2]||"").toLowerCase();
      jackpot = unit==="billion" ? base*1_000_000_000 : unit==="million" ? base*1_000_000 : base;
    }
    // states: two-letter tokens (very permissive)
    const states = Array.from(new Set((t.match(/\b[A-Z]{2}\b/g)||[]))).filter(s=>STATE_POP_2026[s]);
    return { drawDate, jackpotAdvertised: jackpot, winnerStates: states };
  }
  function validatePaste(){
    const paste = document.getElementById("enh3ValidationPaste")?.value || "";
    const msg = document.getElementById("enh3ValidationMsg");
    const parsed = parseValidationPaste(paste);
    if (!parsed.drawDate){
      if (msg) msg.textContent = "Could not detect a drawDate (YYYY-MM-DD).";
      return;
    }
    const ds = loadDataset();
    const hit = ds && ds.hits ? ds.hits.find(h=>h.drawDate===parsed.drawDate) : null;
    const mismatches=[];
    if (!hit) mismatches.push("No hit record found for "+parsed.drawDate);
    else{
      if (parsed.jackpotAdvertised && Math.abs((Number(hit.jackpotAdvertised)||0) - parsed.jackpotAdvertised) > 5_000_000){
        mismatches.push("jackpot mismatch");
      }
      if (parsed.winnerStates && parsed.winnerStates.length){
        const a = new Set(hit.winnerStates||[]);
        for (const st of parsed.winnerStates){
          if (!a.has(st)) mismatches.push("missing state "+st);
        }
      }
    }
    const status = mismatches.length ? "FAIL" : "PASS";
    const v = loadValidations();
    v.rows = v.rows || [];
    v.rows.push({ drawDate: parsed.drawDate, status, mismatches, createdAt: isoNow() });
    saveValidations(v);
    renderValidations();
    if (msg) msg.textContent = "Validation saved: "+status;
  }
  // ---------- Wiring ----------
  function wire(){
    const btnSeed = document.getElementById("enh3SeedBaselineBtn");
    const btnExport = document.getElementById("enh3ExportHitsBtn");
    const btnImport = document.getElementById("enh3ImportHitsBtn");
    const btnClear = document.getElementById("enh3ClearHitsBtn");
    const fileInput = document.getElementById("enh3HitsFileInput");
    const btnEnrich = document.getElementById("enh3RecomputeEnrichBtn");
    const btnStateRates = document.getElementById("enh3ShowStateRatesBtn");
    const btnRun = document.getElementById("enh3RunAnalyticsBtn");
    const btnValidate = document.getElementById("enh3ValidateBtn");
    const btnClearVal = document.getElementById("enh3ClearValidationBtn");
    const btnViewVal = document.getElementById("enh3ViewValidationsBtn");
    if (btnSeed) btnSeed.addEventListener("click", ()=>seedBaseline(true));
    if (btnExport) btnExport.addEventListener("click", exportDataset);
    if (btnImport) btnImport.addEventListener("click", ()=>fileInput && fileInput.click());
    if (fileInput) fileInput.addEventListener("change", (e)=>{
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      importDatasetFromFile(f).catch(err=>toast("Import failed: "+err.message, "error"));
      fileInput.value="";
    });
    if (btnClear) btnClear.addEventListener("click", ()=>{
      if (confirm("Clear the jackpot hit dataset? This will not affect historical draw data.")) clearDataset();
    });
    if (btnEnrich) btnEnrich.addEventListener("click", ()=>{
      const ds = loadDataset();
      if (!ds || !ds.hits || !ds.hits.length){ toast("No dataset loaded.", "warning"); return; }
      enrichHits(ds.hits);
      saveDataset(ds);
      enh3SyncYearsUI(ds);
      enh3ApplyWindowAndRender(ds);
      toast("Enrichment recomputed.", "success");
    });
    if (btnStateRates) btnStateRates.addEventListener("click", ()=>{
      const ds = loadDataset();
      if (!ds || !ds.hits || !ds.hits.length){ toast("No dataset loaded.", "warning"); return; }
      const years = enh3GetSelectedYears();
      const view = Object.assign({}, ds, { hits: enh3WindowFilterHits(ds, years) });
      renderStateRates(view);
    });
    if (btnRun) btnRun.addEventListener("click", runAnalytics);
    if (btnValidate) btnValidate.addEventListener("click", validatePaste);
    if (btnClearVal) btnClearVal.addEventListener("click", ()=>{
      const ta = document.getElementById("enh3ValidationPaste");
      const msg = document.getElementById("enh3ValidationMsg");
      if (ta) ta.value = "";
      if (msg) msg.textContent = "";
    });
    if (btnViewVal) btnViewVal.addEventListener("click", renderValidations);
    const yearsSel = document.getElementById("enh3YearsSelect");
    if (yearsSel) yearsSel.addEventListener("change", ()=>{
      const ds = loadDataset();
      const desired = enh3SetSelectedYears(yearsSel.value);
      if (ds){
        enh3SyncYearsUI(ds);
        enh3ApplyWindowAndRender(ds);
      } else {
        // keep UI consistent even if dataset isn't loaded yet
        yearsSel.value = String(desired);
      }
    });
    maybeAutoSeed();
    renderValidations();
  }
  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", wire);
  else wire();
})();
</script>
<!-- =========================================================
     Enhancement #9 — Deliverable #5: Explainability Continuity (vE9.x)
     Additive-only. Display + traceability helpers. Does NOT modify vE3.5.x narratives.
========================================================= -->
<!-- =========================================================
     Enhancement #9 — Deliverable #6: Ethical & Statistical Framing (vE9.x)
     Additive-only. Documentation + user-facing guardrails. No changes to scoring or explainability text.
========================================================= -->
<!-- Enhancement #9 — USA Mapping (Deliverable 1, Stage 1 scaffold) -->
<!-- Enhancement vE3.5: Explainability & Audit (display-only) -->
</div>
<!-- /Analysis wrapper -->
<!-- /Enhancement #9 — USA Mapping scaffold -->
<div id="manualEntryModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 0 20px rgba(000,0,0.2); z-index: 1000;">
<h3 style="margin-top: 0;">Enter Winning Numbers</h3>
<div id="numberEntry" style="display: flex; gap: 15px; margin: 20px 0; justify-content: center;">
<!-- 5 regular balls and 1 Powerball textboxes will be inserted here by JavaScript -->
</div>
<div id="manualEntryInlineMsg" style="min-height:18px; margin: 6px 0 0; font-size: 13px; color:#c0392b; text-align:center;"></div>
<div style="text-align: center; margin-top: 20px;">
<button disabled="" id="submitNumbersBtn" onclick="submitManualEntry()" style="margin-right: 10px;">Submit Winning Numbers</button>
<button onclick="hideManualEntryForm()">Cancel</button>
</div>
</div>
</div>
<!-- tfjs is loaded on-demand for performance -->
<script src="script.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
<script>
let model = null;
// === Methodology Lock: Main vs Powerball weighting ===
// These weights are used consistently wherever mains + Powerball are combined.
// They are *relative within-run* weights (not absolute odds).
const MAIN_WEIGHT = 0.85;
const POWERBALL_WEIGHT = 0.15;
/* ===========================
   v31 Performance: Web Worker
   Offloads non-LSTM prediction generation to a Worker to keep UI responsive.
   LSTM remains on main thread (TFJS + WebGL).
   =========================== */
let __predictionWorker = null;
let __predictionWorkerBusy = false;
function __ensurePredictionWorker() {
  if (__predictionWorker) return __predictionWorker;
  const workerCode = `
    "use strict";
    // Minimal DOM shim (some legacy predictors probe progressBar)
    const document = { getElementById: () => null };
    let historicalData = [];
    function normalizeDate(d) {
      try { return new Date(d); } catch(e) { return new Date(String(d)); }
    }
    ${extract_func2("predictNumbersFrequency")}
    ${extract_func2("predictNumbersExponential")}
    ${extract_func2("predictNumbersMonteCarlo")}
    ${extract_func2("predictNumbersMarkov")}    async function predictOne(method, drawDate, drawIndex) {
      switch(method) {
        case "exponential": {
          const r = predictNumbersExponential(drawDate, drawIndex);
          return { ...r, method: "Exponential" };
        }
        case "frequency": {
          const r = predictNumbersFrequency(drawDate, drawIndex);
          return { ...r, method: "Frequency" };
        }
        case "monteCarlo": {
          const r = await predictNumbersMonteCarlo(drawDate, drawIndex);
          return { ...r, method: "Monte Carlo" };
        }
        case "markov": {
          const r = predictNumbersMarkov(drawDate, drawIndex);
          return { ...r, method: "Markov" };
        }
;
        }
        default: {
          const r = predictNumbersFrequency(drawDate, drawIndex);
          return { ...r, method: "Frequency" };
        }
      }
    }
    self.onmessage = async (e) => {
      const msg = e.data || {};
      if (msg.type !== "PREDICT_BATCH") return;
      try {
        historicalData = Array.isArray(msg.historicalData) ? msg.historicalData : [];
        const method = msg.method || "frequency";
        const dates = Array.isArray(msg.dates) ? msg.dates : [];
        const out = [];
        for (let i = 0; i < dates.length; i++) {
          const drawDate = normalizeDate(dates[i]);
          const drawIndex = msg.startIndex + i;
          const r = await predictOne(method, drawDate, drawIndex);
          out.push(r);
          // progress ping (5..95)
          const pct = Math.round(5 + (i + 1) / Math.max(1, dates.length) * 90);
          self.postMessage({ type: "PROGRESS", pct });
        }
        self.postMessage({ type: "DONE", results: out });
      } catch (err) {
        self.postMessage({ type: "ERROR", message: (err && err.message) ? err.message : String(err) });
      }
    };
  `;
  const blob = new Blob([workerCode], { type: "application/javascript" });
  const url = URL.createObjectURL(blob);
  __predictionWorker = new Worker(url);
  return __predictionWorker;
}
function __runPredictionWorkerBatch({ method, dates, startIndex = 0 }) {
  return new Promise((resolve, reject) => {
    const w = __ensurePredictionWorker();
    if (__predictionWorkerBusy) {
      // Simple single-flight guard: queueing is overkill for now; fail fast
      reject(new Error("Prediction worker is busy. Please try again."));
      return;
    }
    __predictionWorkerBusy = true;
    const onMsg = (e) => {
      const msg = e.data || {};
      if (msg.type === "PROGRESS") {
        try {
          const pct = Math.max(0, Math.min(100, msg.pct || 0));
          const fill = document.getElementById('progressFill');
          const txt  = document.getElementById('progressText');
          if (fill) fill.style.width = pct + '%';
          if (txt)  txt.textContent  = pct + '%';
        } catch (_) {}
      } else if (msg.type === "DONE") {
        cleanup();
        resolve(msg.results || []);
      } else if (msg.type === "ERROR") {
        cleanup();
        reject(new Error(msg.message || "Worker prediction failed"));
      }
    };
    const cleanup = () => {
      __predictionWorkerBusy = false;
      try { w.removeEventListener("message", onMsg); } catch (_) {}
    };
    w.addEventListener("message", onMsg);
    // Send data
    w.postMessage({
      type: "PREDICT_BATCH",
      method,
      dates,
      startIndex,
      historicalData: Array.isArray(window.historicalData) ? window.historicalData : []
    });
  });
}
// LSTM sequence length (must match training and inference)
const LSTM_SEQUENCE_LEN = 10;
let automationActive = false;
// ===== Hardening / Debug Helpers (v22) =====
window.__pbvNext = window.__pbvNext || {};
window.__pbvNext.DEBUG = window.__pbvNext.DEBUG || false;
function assertState(label, detail = {}) {
  if (!window.__pbvNext.DEBUG) return;
  try {
    console.groupCollapsed(`[STATE] ${label}`);
    console.log(detail);
    console.groupEnd();
  } catch (e) {}
}
let completedDraws = 0;
let totalAutomatedDraws = 0;
function getNextDrawingDate(date = new Date()) {
  const drawingDays = [1, 3, 6];
  let nextDate = new Date(date);
  nextDate.setHours(0, 0, 0, 0);
  while (!drawingDays.includes(nextDate.getDay())) {
    nextDate.setDate(nextDate.getDate() + 1);
  }
  return nextDate;
}
function getNextBlankDrawingDateFrom(historyDateSet, fromDate) {
  // Returns the next scheduled draw date (Mon/Wed/Sat) on or after fromDate that is NOT in historyDateSet.
  // historyDateSet should contain YYYY-MM-DD strings.
  let d = getNextDrawingDate(fromDate);
  // Safety guard
  for (let i = 0; i < 400; i++) {
    const ds = d.toISOString().split('T')[0];
    if (!historyDateSet || !historyDateSet.has(ds)) return d;
    d.setDate(d.getDate() + 1);
    d = getNextDrawingDate(d);
  }
  return getNextDrawingDate(fromDate);
}
function computeNextBlankDrawDateISO(fromDate = new Date(), pastOnly = true) {
  // Find the next scheduled draw date that isn't already in historicalData.
  // For winning-number entry, we must be PAST-ONLY: strictly before today (local).
  const historySet = new Set(
    Array.isArray(window.historicalData)
      ? window.historicalData
          .map(r => r?.date)
          .filter(Boolean)
      : []
  );
  // Determine local end-of-range for past-only (yesterday at midday to avoid DST edges)
  const now = new Date();
  const todayMid = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 12, 0, 0, 0);
  const end = new Date(todayMid);
  end.setDate(end.getDate() - 1); // yesterday (past-only)
  // Base the search off the most recent historical date when possible,
  // otherwise fall back to the provided date/today.
  let base = (fromDate instanceof Date && !isNaN(fromDate)) ? fromDate : new Date();
  if (historySet.size > 0) {
    const latest = Array.from(historySet).sort().pop();
    if (latest) base = new Date(latest + 'T12:00:00');
  }
  // Clamp base to end if it's already at/after today (prevents future dates from entering the selector)
  if (pastOnly && base.getTime() > end.getTime()) base = new Date(end);
  // Helper: next blank draw date, capped to 'end' when pastOnly is true
  function getNextBlankCapped(historyDateSet, fromDt, endDt) {
    let d = getNextDrawingDate(fromDt);
    // Normalize to midday to avoid DST edge cases
    d.setHours(12,0,0,0);
    for (let i = 0; i < 400; i++) {
      if (pastOnly && d.getTime() > endDt.getTime()) return null;
      const ds = d.toISOString().split('T')[0];
      if (!historyDateSet || !historyDateSet.has(ds)) return d;
      d.setDate(d.getDate() + 1);
      d = getNextDrawingDate(d);
      d.setHours(12,0,0,0);
    }
    return null;
  }
  const nextBlank = getNextBlankCapped(historySet, base, end);
  return nextBlank ? nextBlank.toISOString().split('T')[0] : '';
}
function updateWinningDateSelectorToNextBlank() {
  const dateInput = document.getElementById('drawDate');
  if (!dateInput) return;
  const nextBlank = computeNextBlankDrawDateISO(new Date(), true);
  if (nextBlank) {
    const label = formatDate(nextBlank);
    let opt = Array.from(dateInput.options).find(o => o.value === nextBlank);
    if (!opt) {
      opt = new Option(label, nextBlank);
      dateInput.appendChild(opt);
    } else {
      opt.textContent = label;
    }
    const idx = Array.from(dateInput.options).findIndex(o => o.value === nextBlank);
    dateInput.selectedIndex = idx >= 0 ? idx : 0;
    dateInput.value = nextBlank;
  } else if (dateInput.options.length > 0) {
    dateInput.selectedIndex = 0;
    dateInput.value = dateInput.options[0].value;
  } else {
    const meBtn = document.getElementById('manualEntryBtn');
    if (meBtn) {
      meBtn.disabled = true;
      meBtn.setAttribute('disabled', '');
      meBtn.style.opacity = '0.5';
    }
  }
}
function updateLoadButtonWithLastDate(dateStr) {
  if (!dateStr) return;
  const loadDataBtn = document.getElementById('loadDataBtn');
  const lastDrawDateText = document.getElementById('lastDrawDateText');
  const formatted = new Date(dateStr).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
  if (loadDataBtn) {
    loadDataBtn.innerHTML = `Load Historical Data<br><small style="font-size:12px;font-weight:bold;color:green;">Last Historical Draw Date: ${formatted}</small>`;
  }
  if (lastDrawDateText) {
    lastDrawDateText.textContent = `Last Historical Draw Date: ${formatted}`;
  }
}
function updateLoadButtonWithLastDrawDate() {
  if (!Array.isArray(window.historicalData) || window.historicalData.length === 0) return;
  const sorted = window.historicalData.slice().sort((a, b) => new Date(b.date) - new Date(a.date));
  const last = sorted[0];
  if (last?.date) updateLoadButtonWithLastDate(last.date);
}
function isDrawingDay(date) {
  const day = date.getDay();
  return day === 1 || day === 3 || day === 6;
}
function getNextValidDrawDate(startDate, drawIndex) {
  let date = new Date(startDate);
  let drawsFound = 0;
  while (drawsFound < drawIndex) {
    date.setDate(date.getDate() + 1);
    if (isDrawingDay(date)) {
      drawsFound++;
    }
  }
  return date;
}
// =========================
// RNG Routing + Run Fingerprint (v52)
// =========================
(function(){
  window.__pbvNext = window.__pbvNext || {};
  const RNG = {
    mode: (window.crypto && typeof window.crypto.getRandomValues === 'function') ? 'crypto' : 'math',
    nextFloat: function(){
      try{
        if (this.mode === 'crypto') {
          const a = new Uint32Array(1);
          window.crypto.getRandomValues(a);
          // 0 <= x < 1
          return a[0] / 4294967296;
        }
      } catch(e){}
      return pbRng();
    }
  };
  window.__pbvNext.RNG = RNG;
  window.pbRng = function(){ return RNG.nextFloat(); };
  // FNV-1a 32-bit hash, returns base36 for compactness
  function fnv1a32(str){
    let h = 0x811c9dc5;
    for (let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = (h + ((h<<1) + (h<<4) + (h<<7) + (h<<8) + (h<<24))) >>> 0;
    }
    return h >>> 0;
  }
  function safeStr(v){
    if (v === null || v === undefined) return '';
    if (typeof v === 'string') return v;
    try { return JSON.stringify(v); } catch(e){ return String(v); }
  }
  function buildHistorySignature(){
    const hd = Array.isArray(window.historicalData) ? window.historicalData : [];
    if (!hd.length) return 'no-history';
    // Use the last 260 draws (Frozen Reference Window) for the signature
    const slice = hd.slice(-260);
    const compact = slice.map(r => {
      const d = r.date || '';
      const nums = Array.isArray(r.numbers) ? r.numbers.join('-') : '';
      const pb = (r.powerball ?? r.pb ?? '');
      return d + ':' + nums + ':' + pb;
    }).join('|');
    return String(fnv1a32(compact)).padStart(10,'0');
  }
  function buildInputSignature(){
    const drawDate = document.getElementById('drawDate')?.value || '';
    const draws = document.getElementById('numDraws')?.value || '';
    const model = document.getElementById('modelSelect')?.value || document.getElementById('model')?.value || '';
    const topK = document.getElementById('topKPool')?.value || '';
    return safeStr({drawDate, draws, model, topK});
  }
  window.__pbvNext.computeRunFingerprint = function(){
    const historySig = buildHistorySignature();
    const inputSig = buildInputSignature();
    const raw = 'pbvNext|v52|' + historySig + '|' + inputSig;
    const h = fnv1a32(raw);
    const fp = 'PB-' + h.toString(36).toUpperCase().padStart(7,'0');
    return { fingerprint: fp, historySig, rngMode: RNG.mode };
  };
  window.__pbvNext.updateReproMeta = function(){
    const elFp = document.getElementById('runFingerprint');
    const elRng = document.getElementById('rngSource');
    const elW = document.getElementById('rlWeights');
    const info = window.__pbvNext.computeRunFingerprint();
    if (elFp) elFp.textContent = info.fingerprint + '  (H:' + info.historySig + ')';
    if (elRng) elRng.textContent = (info.rngMode === 'crypto') ? 'Crypto (secure)' : 'Math.random';
    if (elW) elW.textContent = `Main ${Math.round(MAIN_WEIGHT*100)}% / Powerball ${Math.round(POWERBALL_WEIGHT*100)}%`;
  };
  // -------------------------
  // Stability Index (v55) — lightweight sensitivity diagnostics
  // -------------------------
  function _ticketKeyFromEntry(e){
    const nums = Array.isArray(e?.numbers) ? e.numbers.slice().sort((a,b)=>a-b).join('-') : '';
    const pb = (e?.powerball ?? '');
    return nums + '|' + pb;
  }
  function _topKeysForDate(drawDateISO, n=10){
    const group = (Array.isArray(window.drawingHistory) ? window.drawingHistory : []).filter(e => e.drawDate === drawDateISO);
    const sorted = group.slice().sort((a,b) => (Number(b.globalRelativeLikelihoodPct ?? b.probability ?? 0) - Number(a.globalRelativeLikelihoodPct ?? a.probability ?? 0)));
    const k = Math.min(n, sorted.length);
    const keys = [];
    for (let i=0;i<k;i++) keys.push(_ticketKeyFromEntry(sorted[i]));
    return keys;
  }
  function _overlapRatio(aKeys, bKeys){
    const a = new Set(aKeys);
    const b = new Set(bKeys);
    const denom = Math.max(Math.min(a.size, b.size), 1);
    let inter = 0;
    a.forEach(k => { if (b.has(k)) inter++; });
    return inter / denom;
  }
  function _computeWindowStability(drawDateISO){
    // Use history entries for the selected draw date and rescore them under two frozen windows
    const group = (Array.isArray(window.drawingHistory) ? window.drawingHistory : []).filter(e => e.drawDate === drawDateISO);
    if (group.length < 2) return null;
    function _cloneWithScore(e){
      const nums = Array.isArray(e.numbers) ? e.numbers.slice().sort((a,b)=>a-b) : [];
      const pb = Number(e.powerball);
      const method = (e.method || 'Unknown');
      let meta = null;
      try { meta = computeScoreComponents(nums, pb, method); } catch(_){}
      const score = Number(meta?.rawPct ?? e.score ?? 0);
      return {
        method,
        numbers: nums,
        powerball: pb,
        score,
        scoreWeights: meta?.weights || e.scoreWeights || null,
        scoreComponents: meta?.components || e.scoreComponents || null
      };
    }
    const run260 = group.map(_cloneWithScore);
    const run200 = group.map(_cloneWithScore);
    // Build frozen stats for each window using current eligible history (already leakage-gated during generate)
    const hd = Array.isArray(window.historicalData) ? window.historicalData : [];
    const stats260 = buildFrozenReferenceStats(hd, 260, 'Frequency');
    const stats200 = buildFrozenReferenceStats(hd, 200, 'Frequency');
    // Normalize scores under each window
    applyNormalizedScoringToRun(run260, stats260);
    applyNormalizedScoringToRun(run200, stats200);
    // Assign RL% within each run
    assignRelativeLikelihoodPercent(run260, 'score', { outKey: '__rl', setProbability: false });
    assignRelativeLikelihoodPercent(run200, 'score', { outKey: '__rl', setProbability: false });
    const topN = Math.min(10, group.length);
    const top260 = run260.slice().sort((a,b)=>Number(b.__rl||0)-Number(a.__rl||0)).slice(0, topN).map(_ticketKeyFromEntry);
    const top200 = run200.slice().sort((a,b)=>Number(b.__rl||0)-Number(a.__rl||0)).slice(0, topN).map(_ticketKeyFromEntry);
    return _overlapRatio(top260, top200);
  }
  window.__pbvNext.computeStabilityIndexForDate = function(drawDateISO){
    if (!drawDateISO) return null;
    const group = (Array.isArray(window.drawingHistory) ? window.drawingHistory : []).filter(e => e.drawDate === drawDateISO);
    if (!group.length) return null;
    const topN = Math.min(10, group.length);
    // 1) Top-K sensitivity (K=50 vs K=75) via RL recompute pools
    let kStab = null;
    try{
      recomputeHistoryRLForDate(drawDateISO, 50);
      const a = _topKeysForDate(drawDateISO, topN);
      recomputeHistoryRLForDate(drawDateISO, 75);
      const b = _topKeysForDate(drawDateISO, topN);
      kStab = _overlapRatio(a, b);
    } catch(e){
      kStab = null;
    } finally {
      // restore default topK reconciliation for UI consistency
      try { recomputeHistoryRLForDate(drawDateISO, 50); } catch(_){}
    }
    // 2) Frozen window sensitivity (260 vs 200) using normalized scoring only
    let wStab = null;
    try{
      wStab = _computeWindowStability(drawDateISO);
    } catch(e){
      wStab = null;
    }
    // Combine (average of available measures)
    const parts = [];
    if (typeof kStab === 'number' && isFinite(kStab)) parts.push(kStab);
    if (typeof wStab === 'number' && isFinite(wStab)) parts.push(wStab);
    if (!parts.length) return null;
    const avg = parts.reduce((s,x)=>s+x,0) / parts.length;
    return { stability: avg, kStability: kStab, windowStability: wStab, topN };
  };
  window.__pbvNext.updateStabilityMeta = function(drawDateISO){
    const el = document.getElementById('stabilityIndex');
    const bandEl = document.getElementById('stabilityBand');
    if (!el) return;
    const info = window.__pbvNext.computeStabilityIndexForDate(drawDateISO);
    if (!info) {
      el.textContent = '—';
      if (bandEl){ bandEl.textContent = '—'; bandEl.className = 'mr-meta-band'; }
      return;
    }
    const pct = Math.round(info.stability * 1000) / 10; // one decimal
    el.textContent = pct.toFixed(1) + '%';
    // Interpretation thresholds (locked)
    // ≥70% = Stable, 50–69.9% = Moderate, <50% = Volatile (sensitive/brittle)
    let band = 'Volatile';
    let cls = 'volatile';
    if (pct >= 70){ band = 'Stable'; cls = 'stable'; }
    else if (pct >= 50){ band = 'Moderate'; cls = 'moderate'; }
    if (bandEl){
      bandEl.textContent = band;
      bandEl.className = 'mr-meta-band ' + cls;
      bandEl.title = 'Interpretation: ' + band + ' (≥70 stable, 50–69.9 moderate, <50 volatile).';
    }
    el.title = 'Top-' + info.topN + ' overlap: K(50↔75)=' + (info.kStability==null?'n/a':(Math.round(info.kStability*1000)/10).toFixed(1)+'%') +
               ', Window(260↔200)=' + (info.windowStability==null?'n/a':(Math.round(info.windowStability*1000)/10).toFixed(1)+'%') +
               '. Interpretation: ' + band + '.';
    window.__pbvNext.lastStability = info;
  };
  // MASTER SPEC export (Methodology Rationale v1.0)
  window.__pbvNext.METHODOLOGY_RATIONALE_VERSION = '1.0.0';
  window.__pbvNext.exportMethodologyMasterSpec = function(){
    const nowISO = new Date().toISOString();
    const root = document.getElementById('explainabilityContent');
    const blocks = Array.from(root ? root.querySelectorAll('details.mr-block') : []);
    const sections = blocks.map(d => {
      const summaryEl = d.querySelector('summary');
      const title = summaryEl ? summaryEl.textContent.trim() : (d.getAttribute('data-mr-key') || 'section');
      const txt = (d.innerText || '').replace(/\s+\n/g, '\n').trim();
      return { key: d.getAttribute('data-mr-key') || null, title, text: txt };
    });
    const spec = {
      project: 'Powerball vNext',
      artifact: 'Methodology Rationale (MASTER SPEC Snippet)',
      methodologyRationaleVersion: window.__pbvNext.METHODOLOGY_RATIONALE_VERSION,
      exportedAtISO: nowISO,
      lockedConstants: {
        frozenReferenceWindowDraws: 260,
        topKPool: 50,
        mainVsPowerballWeight: { main: 0.85, powerball: 0.15 },
        powerballRange: [1, 26],
        mainRange: [1, 69]
      },
      semantics: {
        runLikelihood: 'Normalized within the candidate pool for this run/date; not absolute jackpot odds.'
      },
      runFingerprint: (document.getElementById('runFingerprint') || {}).textContent || null,
      stabilityIndex: (document.getElementById('stabilityIndex') || {}).textContent || null,
      stabilityBand: (document.getElementById('stabilityBand') || {}).textContent || null,
      sections
    };
    return JSON.stringify(spec, null, 2);
  };
  function _pbCopyText(text){
    if (!text) return false;
    if (navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(text).then(()=>{
        _flash('Copied MASTER SPEC snippet to clipboard.', 'success');
      }).catch(()=>{
        _pbFallbackCopy(text);
      });
      return true;
    }
    return _pbFallbackCopy(text);
  }
  function _pbFallbackCopy(text){
    try{
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.setAttribute('readonly','');
      ta.style.position='fixed';
      ta.style.left='-9999px';
      ta.style.top='-9999px';
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      _flash('Copied MASTER SPEC snippet to clipboard.', 'success');
      return true;
    }catch(e){
      try{
        showErrorToast('Copy failed. Clipboard access was denied by the browser.');
        return true;
      }catch(_){
        return false;
      }
    }
  }
  // Update on key input changes
  document.addEventListener('input', function(e){
    const id = e?.target?.id || '';
    if (id === 'drawDate' || id === 'numDraws' || id === 'modelSelect' || id === 'model' || id === 'topKPool'){
      try{ window.__pbvNext.updateReproMeta(); } catch(_){}
      try{ if (window.__pbvNext && typeof window.__pbvNext.updateStabilityMeta==='function') window.__pbvNext.updateStabilityMeta((document.getElementById('drawDate')?.value || '')); } catch(_){}
    }
  });
  // Initial paint after DOM load
  document.addEventListener('DOMContentLoaded', function(){
    try{ window.__pbvNext.updateReproMeta(); } catch(_){}
    try{ if (window.__pbvNext && typeof window.__pbvNext.updateStabilityMeta==='function') window.__pbvNext.updateStabilityMeta((document.getElementById('drawDate')?.value || '')); } catch(_){}
  });
})();
function seededRandom(seed, offset = 0) {
  if (isNaN(seed)) {
    return pbRng();
  }
  const x = Math.sin(seed + offset) * 10000;
  return Math.abs(x - Math.floor(x));
}
function normalizeMap(map) {
  const total = Array.from(map.values()).reduce((sum, value) => sum + value, 0);
  if (total === 0) return;
  map.forEach((value, key) => map.set(key, value / total));
}
function adjustPredictionWithPreviousResults(predicted) {
  let {
    numbers,
    powerball
  } = predicted;
  previousPredictions.forEach(previous => {
    const commonNumbers = numbers.filter(num => previous.numbers.includes(num));
    const mismatchNumbers = numbers.filter(num => !previous.numbers.includes(num));
    if (commonNumbers.length >= 3 && mismatchNumbers.length > 0) {
      numbers = numbers.map(num => {
        return commonNumbers.includes(num) ? num : mismatchNumbers[0];
      });
    }
  });
  const powerballFrequencyMap = new Map();
  historicalData.forEach((draw, idx) => {
    const weight = Math.exp(-0.01 * (historicalData.length - idx));
    powerballFrequencyMap.set((draw.powerball ?? draw.pb ?? draw.special), (powerballFrequencyMap.get((draw.powerball ?? draw.pb ?? draw.special)) || 0) + weight);
  });
  normalizeMap(powerballFrequencyMap);
  const randomValue = seededRandom(new Date().getTime(), predicted.powerball);
  let cumulativeWeight = 0;
  for (const [num, weight] of powerballFrequencyMap.entries()) {
    cumulativeWeight += weight;
    if (randomValue <= cumulativeWeight) {
      powerball = num;
      break;
    }
  }
  return {
    numbers,
    powerball
  };
}
function predictNumbersExponential(date, drawIndex = 0) {
  try {
    const alpha = 0.5;
    const beta = 0.3;
    let level = 0;
    let trend = 0;
    historicalData.forEach(draw => {
      const drawAvg = draw.numbers.reduce((sum, num) => sum + num, 0) / draw.numbers.length;
      const newLevel = alpha * drawAvg + (1 - alpha) * (level + trend);
      trend = beta * (newLevel - level) + (1 - beta) * trend;
      level = newLevel;
    });
    const predictedNumbers = new Set();
    while (predictedNumbers.size < 5) {
      const prediction = Math.round(level + trend + pbRng() * 10 * (drawIndex + 1));
      if (prediction >= 1 && prediction <= 69) {
        predictedNumbers.add(prediction);
      }
    }
    const powerball = (Math.ceil(pbRng() * 26) + drawIndex) % 26 + 1;
    const predictions = {
      numbers: Array.from(predictedNumbers).sort((a, b) => a - b),
      powerball,
      method: "Exponential"
    };
    predictions.probability = calculateProbability(predictions.numbers, predictions.powerball, "Exponential");
    return predictions;
  } catch (error) {
    console.error("Exponential prediction error:", error);
    return null;
  }
}
function predictNumbersFrequency(date, drawIndex = 0) {
  try {
    const frequencyMap = new Map();
    const powerballMap = new Map();
    const decayFactor = 0.95; // Exponential decay for weighting
    historicalData.forEach((draw, index) => {
      const ageWeight = Math.pow(decayFactor, historicalData.length - index - 1);
      draw.numbers.forEach(num => {
        frequencyMap.set(num, (frequencyMap.get(num) || 0) + ageWeight);
      });
      powerballMap.set((draw.powerball ?? draw.pb ?? draw.special), (powerballMap.get((draw.powerball ?? draw.pb ?? draw.special)) || 0) + ageWeight);
    });
    const selectNumbers = (map, count) => {
      const entries = Array.from(map.entries());
      let candidates = new Set();
      let attempt = 0;
      while(candidates.size < count && attempt < 100) {
        const remainingWeight = entries.reduce((sum, [num, weight]) =>
          candidates.has(num) ? sum : sum + weight, 0);
        if(remainingWeight <= 0) break; // Prevent infinite loop
        const rand = pbRng() * remainingWeight;
        let cumulative = 0;
        for(const [num, weight] of entries) {
          if(candidates.has(num)) continue;
          cumulative += weight;
          if(rand <= cumulative) {
            candidates.add(num);
            break;
          }
        }
        attempt++;
      }
      return Array.from(candidates).slice(0, count);
    };
    let selectedNumbers = [];
    for(let i=0; i<1000 && selectedNumbers.length<5; i++) {
      selectedNumbers = Array.from(new Set([
        ...selectedNumbers,
        ...selectNumbers(frequencyMap, 5 - selectedNumbers.length)
      ]));
    }
    if(selectedNumbers.length < 5) {
      const remaining = Array.from(frequencyMap.keys())
        .filter(n => !selectedNumbers.includes(n))
        .sort(() => pbRng() - 0.5)
        .slice(0, 5 - selectedNumbers.length);
      selectedNumbers = [...selectedNumbers, ...remaining];
    }
    const pbEntries = Array.from(powerballMap.entries());
    const pbTotal = pbEntries.reduce((sum, [_, w]) => sum + w, 0);
    const pbRand = pbRng() * pbTotal;
    let pbCumulative = 0;
    let powerball = 1;
    for(const [num, weight] of pbEntries) {
      pbCumulative += weight;
      if(pbRand <= pbCumulative) {
        powerball = num;
        break;
      }
    }
    powerball = Math.min(Math.max(powerball, 1), 26);
    // Explainability payload (decayed frequency weights)
    const mainSorted = Array.from(frequencyMap.entries()).sort((a,b)=>b[1]-a[1]);
    const pbSorted = Array.from(powerballMap.entries()).sort((a,b)=>b[1]-a[1]);
    const chosenMain = selectedNumbers.map(n => ({
      n,
      score: frequencyMap.get(n) || 0,
      rank: mainSorted.findIndex(e => e[0] === n) + 1
    })).sort((a,b)=>a.n-b.n);
    const chosenPB = {
      n: powerball,
      score: powerballMap.get(powerball) || 0,
      rank: pbSorted.findIndex(e => e[0] === powerball) + 1
    };
    const explain = {
      type: "frequency",
      decayFactor,
      chosenMain,
      chosenPB,
      topMain: mainSorted.slice(0,10).map(([n,score],i)=>({n,score,rank:i+1})),
      topPB: pbSorted.slice(0,10).map(([n,score],i)=>({n,score,rank:i+1})),
      note: "Frequency uses exponentially decayed historical counts (newer draws weighted more)."
    };
    return {
      explain,
      numbers: selectedNumbers
        .map(n => Math.min(Math.max(n, 1), 69))
        .sort((a, b) => a - b),
      powerball,
      method: "Frequency"
    };
  } catch (error) {
    console.error("Frequency prediction error:", error);
    return {
      numbers: Array.from({length:5}, ()=> Math.floor(pbRng()*69)+1).filter((v,i,a)=>a.indexOf(v)===i).slice(0,5).sort((a,b)=>a-b),
      powerball: Math.floor(pbRng()*26)+1,
      method: "Frequency (Error Fallback)"
    };
  }
}
async function predictNumbersMonteCarlo(date, drawIndex) {
  try {
    const simulations = 500;
    const frequencyMap = new Map();
    const powerballMap = new Map();
    const progressBar = document.getElementById("progressBar");
    if (progressBar) progressBar.style.display = "block";
    for (let i = 0; i < simulations; i++) {
      const numbers = new Set();
      while (numbers.size < 5) {
        numbers.add(Math.ceil(pbRng() * 69));
      }
      const powerball = Math.ceil(pbRng() * 26);
      numbers.forEach(num => frequencyMap.set(num, (frequencyMap.get(num) || 0) + 1));
      powerballMap.set(powerball, (powerballMap.get(powerball) || 0) + 1);
      if (progressBar) {
        progressBar.value = (i + 1) / simulations * 100;
      }
    }
    if (progressBar) progressBar.style.display = "none";
    const selectTop = (map, count) => Array.from(map.entries()).sort((a, b) => b[1] - a[1]).slice(0, count).map(entry => entry[0]);
    const selectedNumbers = selectTop(frequencyMap, 5);
    const powerball = selectTop(powerballMap, 1)[0];
    return {
      numbers: selectedNumbers.sort((a, b) => a - b),
      powerball,
      method: "Monte Carlo"
    };
  } catch (error) {
    console.error("Monte Carlo prediction error:", error);
    return null;
  }
}
async function predictNumbersEverything(date, drawIndex) {
  try {
    const progressBar = document.getElementById("progressBar");
    if (progressBar) {
      progressBar.style.display = "block";
      progressBar.value = 0;
    } else {
      console.warn("Progress bar element not found. Skipping progress updates.");
    }
    const results = await Promise.allSettled([(async () => {
      if (progressBar) progressBar.value = 25;
      return predictNumbersExponential(date, drawIndex);
    })(), (async () => {
      if (progressBar) progressBar.value = 50;
      return predictNumbersFrequency(date, drawIndex);
    })(), (async () => {
      if (progressBar) progressBar.value = 75;
      return predictNumbersMonteCarlo(date, drawIndex);
    })()]);
    const [exponential, frequency, monteCarlo] = results.map(result => {
      if (result.status === "fulfilled" && result.value) {
        return result.value;
      } else {
        console.error(`Error in model: ${result.reason}`);
        showErrorToast(`Fallback to Frequency: Error in ${result.reason ? result.reason : "Unknown Error"}`);
        return null;
      }
    });
    if (!exponential || !monteCarlo) {
      console.warn("Falling back to Frequency model due to errors in other models.");
      if (progressBar) progressBar.style.display = "none";
      return frequency;
    }
    const numberSets = [{
      numbers: exponential.numbers,
      weight: 1.2
    }, {
      numbers: frequency.numbers,
      weight: 1.0
    }, {
      numbers: monteCarlo.numbers,
      weight: 1.1
    }];
    const weightedNumbers = new Map();
    numberSets.forEach(({
      numbers,
      weight
    }) => {
      numbers.forEach(num => {
        weightedNumbers.set(num, (weightedNumbers.get(num) || 0) + weight);
      });
    });
    const allNumbers = Array.from(weightedNumbers.entries()).sort((a, b) => b[1] - a[1]).slice(0, 5).map(entry => entry[0]);
    const powerballCandidates = [exponential.powerball, frequency.powerball, monteCarlo.powerball];
    const powerball = Math.round(powerballCandidates.reduce((a, b) => a + b, 0) / powerballCandidates.length);
    if (progressBar) progressBar.style.display = "none";
    return {
      numbers: allNumbers.sort((a, b) => a - b),
      powerball,
      method: "Everything"
    };
  } catch (error) {
    console.error("Everything prediction error:", error);
    showErrorToast("Critical error in Everything prediction: " + error.message);
    const progressBar = document.getElementById("progressBar");
    if (progressBar) progressBar.style.display = "none";
    return null;
  }
}
async function predictNumbersLSTM(sequence, drawIndex) {
  try {
    if (!model || !model.isTrained) {
      model = await trainModel(historicalData);
    }
    // Validate / normalize sequence shape to avoid ragged tensors / offset errors
    if (!Array.isArray(sequence)) sequence = [];
    // Normalize to exactly LSTM_SEQUENCE_LEN (pad left with earliest valid draw; truncate to last L)
    const L = LSTM_SEQUENCE_LEN;
    const clean = sequence.filter(d => {
      if (!d) return false;
      if (!Array.isArray(d.numbers) || d.numbers.length !== 5) return false;
      const pb = (d.powerball ?? d.pb ?? d.special);
      return Number.isFinite(pb);
    });
    if (clean.length === 0) {
      throw new Error("Insufficient valid history for LSTM");
    }
    if (clean.length >= L) {
      sequence = clean.slice(-L);
    } else {
      const pad = [];
      while (pad.length + clean.length < L) pad.push(clean[0]);
      sequence = pad.concat(clean);
    }
    const formattedSequence = sequence.map(draw => [...draw.numbers, (draw.powerball ?? draw.pb ?? draw.special)]);
    const input = tf.tensor3d([formattedSequence]);
    const prediction = await model.predict(input).array();
    const predictedValues = prediction[0];
    const uniqueNumbers = new Set();
    const numberProbabilities = new Map();
    for (let i = 1; i <= 69; i++) {
      const randomFactor = pbRng() * 0.2 - 0.1;
      numberProbabilities.set(i, predictedValues[i % 5] + randomFactor);
    }
    const sortedNumbers = Array.from(numberProbabilities.entries()).sort((a, b) => b[1] - a[1]).map(entry => entry[0]);
    let index = 0;
    while (uniqueNumbers.size < 5 && index < sortedNumbers.length) {
      const num = sortedNumbers[index];
      if (drawIndex === 0) {
        uniqueNumbers.add(num);
      } else {
        const isRecentlyUsed = document.querySelectorAll('.draw-container').length > 0 && Array.from(document.querySelectorAll('.ball:not(.powerball)')).some(ball => parseInt(ball.textContent) === num);
        if (!isRecentlyUsed) {
          uniqueNumbers.add(num);
        }
      }
      index++;
      if (index >= sortedNumbers.length && uniqueNumbers.size < 5) {
        index = 0;
        numberProbabilities.clear();
        for (let i = 1; i <= 69; i++) {
          const randomFactor = pbRng() * 0.2 - 0.1;
          numberProbabilities.set(i, predictedValues[i % 5] + randomFactor);
        }
        sortedNumbers.length = 0;
        sortedNumbers.push(...Array.from(numberProbabilities.entries()).sort((a, b) => b[1] - a[1]).map(entry => entry[0]));
      }
    }
    const powerballProb = new Map();
    for (let i = 1; i <= 26; i++) {
      const randomFactor = pbRng() * 0.2 - 0.1;
      powerballProb.set(i, predictedValues[5] + randomFactor);
    }
    const sortedPowerballs = Array.from(powerballProb.entries()).sort((a, b) => b[1] - a[1]).map(entry => entry[0]);
    let powerball = sortedPowerballs[0];
    if (drawIndex > 0) {
      const usedPowerballs = Array.from(document.querySelectorAll('.ball.powerball')).map(ball => parseInt(ball.textContent));
      powerball = sortedPowerballs.find(num => !usedPowerballs.includes(num)) || powerball;
    }
    // Explainability payload (model scores are relative; shown as ranked signals)
    const mainTop = Array.from(numberProbabilities.entries())
      .sort((a,b)=>b[1]-a[1])
      .slice(0,10)
      .map(([n,score],i)=>({n,score,rank:i+1}));
    const pbTop = Array.from(powerballProb.entries())
      .sort((a,b)=>b[1]-a[1])
      .slice(0,10)
      .map(([n,score],i)=>({n,score,rank:i+1}));
    const mainSortedAll = Array.from(numberProbabilities.entries()).sort((a,b)=>b[1]-a[1]);
    const pbSortedAll = Array.from(powerballProb.entries()).sort((a,b)=>b[1]-a[1]);
    const chosenMain = Array.from(uniqueNumbers).map(n => ({
      n,
      score: numberProbabilities.get(n),
      rank: mainSortedAll.findIndex(e=>e[0]===n)+1
    })).sort((a,b)=>a.n-b.n);
    const chosenPB = {
      n: powerball,
      score: powerballProb.get(powerball),
      rank: pbSortedAll.findIndex(e=>e[0]===powerball)+1
    };
    const explain = {
      type: "lstm",
      chosenMain,
      chosenPB,
      topMain: mainTop,
      topPB: pbTop,
      note: "LSTM signal ranks are derived from the model output (relative scores, not calibrated probabilities)."
    };
    return {
      explain,
      numbers: Array.from(uniqueNumbers).sort((a, b) => a - b),
      powerball,
      method: "LSTM"
    };
  } catch (error) {
    console.error('LSTM prediction error:', error);
    throw error;
  }
}
function calculateScoreMeta(numbers, powerball, method) {
  // Returns raw component scores + weights + raw total (0..1-ish).
  // This is used for ranking; user-facing % is Relative Likelihood % (percentile rank).
  const weights = {
    historicalFrequency: 0.23,
    recentPatterns: 0.18,
    robustOverlap: 0.23,   // Top-K average overlap vs historical draws (K=20)
    methodAccuracy: 0.14,
    numberDistribution: 0.09,
    correlationFactor: 0.05,
    methodAgreement: 0.08  // Cross-method agreement (0..1)
  };
  const __parts = {
    historicalFrequency: (typeof calculateHistoricalFrequencyScoreParts === 'function')
      ? calculateHistoricalFrequencyScoreParts(numbers, powerball)
      : { main: calculateHistoricalFrequencyScore(numbers, powerball), pb: 0, combined: calculateHistoricalFrequencyScore(numbers, powerball) },
    recentPatterns: (typeof calculateRecentPatternsScoreParts === 'function')
      ? calculateRecentPatternsScoreParts(numbers, powerball)
      : { main: calculateRecentPatternsScore(numbers, powerball), pb: 0, combined: calculateRecentPatternsScore(numbers, powerball) },
    robustOverlap: (typeof calculateRobustOverlapScoreParts === 'function')
      ? calculateRobustOverlapScoreParts(numbers, powerball, 20)
      : { main: calculateRobustOverlapScore(numbers, powerball, 20), pb: 0, combined: calculateRobustOverlapScore(numbers, powerball, 20) },
    methodAgreement: (typeof calculateMethodAgreementScoreParts === 'function')
      ? calculateMethodAgreementScoreParts(numbers, powerball)
      : { main: ((typeof calculateMethodAgreementScore === 'function') ? calculateMethodAgreementScore(numbers, powerball) : 0), pb: 0, combined: ((typeof calculateMethodAgreementScore === 'function') ? calculateMethodAgreementScore(numbers, powerball) : 0) }
  };
  const components = {
    historicalFrequency: __parts.historicalFrequency.combined,
    recentPatterns: __parts.recentPatterns.combined,
    robustOverlap: __parts.robustOverlap.combined,
    methodAccuracy: calculateMethodAccuracyScore(method),
    numberDistribution: calculateNumberDistributionScore(numbers),
    correlationFactor: calculateCorrelationScore(numbers),
    methodAgreement: __parts.methodAgreement.combined
  };
  const mainComponents = {
    historicalFrequency: __parts.historicalFrequency.main,
    recentPatterns: __parts.recentPatterns.main,
    robustOverlap: __parts.robustOverlap.main,
    methodAccuracy: components.methodAccuracy,
    numberDistribution: components.numberDistribution,
    correlationFactor: components.correlationFactor,
    methodAgreement: __parts.methodAgreement.main
  };
  const pbComponents = {
    historicalFrequency: __parts.historicalFrequency.pb,
    recentPatterns: __parts.recentPatterns.pb,
    robustOverlap: __parts.robustOverlap.pb,
    methodAccuracy: 0,
    numberDistribution: 0,
    correlationFactor: 0,
    methodAgreement: __parts.methodAgreement.pb
  };
  const rawTotal =
    (components.historicalFrequency * weights.historicalFrequency) +
    (components.recentPatterns * weights.recentPatterns) +
    (components.robustOverlap * weights.robustOverlap) +
    (components.methodAccuracy * weights.methodAccuracy) +
    (components.numberDistribution * weights.numberDistribution) +
    (components.correlationFactor * weights.correlationFactor) +
    (components.methodAgreement * weights.methodAgreement);
  // Keep a legacy "pct" for any older callers (0..100, clipped)
  const rawPct = Math.min(Math.max(rawTotal * 100, 0), 100);
  const rawTotalMain =
    (mainComponents.historicalFrequency * weights.historicalFrequency) +
    (mainComponents.recentPatterns * weights.recentPatterns) +
    (mainComponents.robustOverlap * weights.robustOverlap) +
    (mainComponents.methodAccuracy * weights.methodAccuracy) +
    (mainComponents.numberDistribution * weights.numberDistribution) +
    (mainComponents.correlationFactor * weights.correlationFactor) +
    (mainComponents.methodAgreement * weights.methodAgreement);
  const rawTotalPB =
    (pbComponents.historicalFrequency * weights.historicalFrequency) +
    (pbComponents.recentPatterns * weights.recentPatterns) +
    (pbComponents.robustOverlap * weights.robustOverlap) +
    (pbComponents.methodAgreement * weights.methodAgreement);
  return { weights, components, mainComponents, pbComponents, rawTotal, rawTotalMain, rawTotalPB, rawPct };
}
function calculateProbability(numbers, powerball, method) {
  try {
    // LEGACY: This returns a % string and is kept only for backward compatibility.
    // Ranking should use score meta + normalization.
    const meta = calculateScoreMeta(numbers, powerball, method);
    return meta.rawPct.toFixed(2);
  } catch (error) {
    console.error('Error calculating probability/score:', error);
    return "50.00";
  }
}
// === Scoring Components + Normalization (v42) ===
// We compute raw component scores per ticket, then optionally normalize components using z-scores across the run.
// This stabilizes scoring so weights remain meaningful and no single component dominates due to scale.
//
// Output:
// - components: raw component values (typically 0..1)
// - rawTotal: weighted sum of raw components (0..1-ish)
// - rawPct: rawTotal * 100 (0..100, clamped)
// === Method Agreement Index ===
// Computes a 0..1 agreement score for a ticket based on cross-method Top-K pools.
// It uses the most recently computed support map stored in window.__currentAgreementSupport.
// Support map format:
//   { methodsCount: n, mainSupport: {num:0..1}, pbSupport:{num:0..1} }
function calculateMethodAgreementScoreParts(numbers, powerball) {
  try {
    const sup = window.__currentAgreementSupport;
    if (!sup || !sup.methodsCount || sup.methodsCount < 2) return { main: 0, pb: 0, combined: 0 };
    const mainSupport = sup.mainSupport || {};
    const pbSupport = sup.pbSupport || {};
    const mains = Array.isArray(numbers) ? numbers : [];
    if (mains.length !== 5) return { main: 0, pb: 0, combined: 0 };
    const mainAvg = mains.reduce((acc, n) => acc + (Number(mainSupport[n]) || 0), 0) / 5;
    const pbVal = Number(pbSupport[Number(powerball)]) || 0;
    const combined = (MAIN_WEIGHT * mainAvg) + (POWERBALL_WEIGHT * pbVal);
    return { main: mainAvg, pb: pbVal, combined };
  } catch (e) {
    return { main: 0, pb: 0, combined: 0 };
  }
}
function calculateMethodAgreementScore(numbers, powerball) {
  return calculateMethodAgreementScoreParts(numbers, powerball).combined;
}
function computeScoreComponents(numbers, powerball, method) {
  // Unified scoring meta used by normalization + auditing.
  // Delegates to calculateScoreMeta so weights/components stay consistent.
  return calculateScoreMeta(numbers, powerball, method);
}
function _mean(arr) {
  if (!arr.length) return 0;
  return arr.reduce((a, b) => a + b, 0) / arr.length;
}
function _std(arr, mu) {
  if (arr.length < 2) return 0;
  const v = arr.reduce((acc, x) => acc + (x - mu) * (x - mu), 0) / (arr.length - 1);
  return Math.sqrt(v);
}
// v46: Frozen reference window stats for normalization (computed from last N historical draws)
function buildFrozenReferenceStats(historicalDraws, windowSize, methodForStats) {
  try {
    const hist = Array.isArray(historicalDraws) ? historicalDraws : [];
    if (!hist.length) return null;
    const sorted = [...hist].sort((a, b) => new Date((a.date || a.drawDate || a.drawingDate || a.Date || 0)) - new Date((b.date || b.drawDate || b.drawingDate || b.Date || 0)));
    const window = sorted.slice(-Math.max(1, windowSize || FROZEN_REFERENCE_DRAWS));
    const keys = [
      'historicalFrequency',
      'recentPatterns',
      'robustOverlap',
      'methodAccuracy',
      'numberDistribution',
      'correlationFactor',
      'methodAgreement'
    ];
    const dist = {};
    keys.forEach(k => dist[k] = []);
    const methodName = methodForStats || 'Frequency';
    window.forEach(d => {
      const nums = (Array.isArray(d.numbers) ? d.numbers : String(d.numbers || '').split(','))
        .map(x => parseInt(String(x).trim(), 10))
        .filter(n => Number.isFinite(n));
      const pb = parseInt(String(d.powerball ?? d.pb ?? d.Powerball ?? '').trim(), 10);
      if (nums.length === 5 && Number.isFinite(pb)) {
        const meta = calculateScoreMeta(nums, pb, methodName);
        keys.forEach(k => dist[k].push(Number(meta.components?.[k] ?? 0)));
      }
    });
    const stats = {};
    keys.forEach(k => {
      const mu = _mean(dist[k]);
      const sd = _std(dist[k], mu);
      stats[k] = { mu, sd: (sd && isFinite(sd) ? sd : 0) };
    });
    return { keysVersion: 'v46', windowSize: window.length, stats };
  } catch (e) {
    console.warn('Frozen reference stats build failed:', e);
    return null;
  }
}
// Apply z-score normalization to component values across this run, then recompute score.
// - Stores: scoreRawPct, scoreRawTotal, scoreNormalized, scoreZ, scoreContrib
// - Overwrites: score (used for ranking + RL%)
function applyNormalizedScoringToRun(generatedGames, referenceStats) {
  if (!generatedGames || generatedGames.length < 2) return;
  const keys = [
    'historicalFrequency',
    'recentPatterns',
    'robustOverlap',
    'methodAccuracy',
    'numberDistribution',
    'correlationFactor'
  ,
    'methodAgreement'
  ];
  // Build distributions per component (fallback) and stats
  let stats = null;
  if (USE_FROZEN_REFERENCE_WINDOW && referenceStats && referenceStats.keysVersion === 'v46' && referenceStats.stats) {
    stats = referenceStats.stats;
  } else {
    const dist = {};
    keys.forEach(k => dist[k] = generatedGames.map(g => Number(g.scoreComponents?.[k] ?? 0)));
    stats = {};
    keys.forEach(k => {
      const mu = _mean(dist[k]);
      const sd = _std(dist[k], mu);
      stats[k] = { mu, sd: (sd && isFinite(sd) ? sd : 0) };
    });
  }
  // Normalize each ticket
  generatedGames.forEach(g => {
    const weights = g.scoreWeights || {
      historicalFrequency: 0.23,
      recentPatterns: 0.18,
      robustOverlap: 0.23,
      methodAccuracy: 0.14,
      numberDistribution: 0.09,
      correlationFactor: 0.05,
      methodAgreement: 0.08
    };
    const z = {};
    keys.forEach(k => {
      const x = Number(g.scoreComponents?.[k] ?? 0);
      const { mu, sd } = stats[k];
      // If sd is 0 (constant feature), treat z=0 so it doesn't distort.
      z[k] = (sd && sd > 1e-9) ? (x - mu) / sd : 0;
    });
    const normalized =
      (z.historicalFrequency * weights.historicalFrequency) +
      (z.recentPatterns * weights.recentPatterns) +
      (z.robustOverlap * weights.robustOverlap) +
      (z.methodAccuracy * weights.methodAccuracy) +
      (z.numberDistribution * weights.numberDistribution) +
      (z.correlationFactor * weights.correlationFactor) +
      (z.methodAgreement * weights.methodAgreement);
    // Persist audit fields
    g.scoreZ = z;
    g.scoreNormalized = normalized;
    g.scoreContrib = {
      historicalFrequency: z.historicalFrequency * weights.historicalFrequency,
      recentPatterns: z.recentPatterns * weights.recentPatterns,
      robustOverlap: z.robustOverlap * weights.robustOverlap,
      methodAccuracy: z.methodAccuracy * weights.methodAccuracy,
      numberDistribution: z.numberDistribution * weights.numberDistribution,
      correlationFactor: z.correlationFactor * weights.correlationFactor,
      methodAgreement: z.methodAgreement * weights.methodAgreement
    };
    // Overwrite score used for RL% ranking
    g.score = normalized;
  });
}
// === Relative Likelihood % (Percentile Rank) ===
// RL% is a percentile rank among the generated candidates for the current run.
// 100% = best score, 0% = worst score. Tie-aware via average rank.
// NOTE: We keep writing RL% into `entry.probability` for backward compatibility
// with existing UI, history, sorting, and exports (the label is updated to RL%).
function assignRelativeLikelihoodPercent(candidates, scoreKey = 'score', options = {}) {
  // options:
  // - outKey: field name to store RL% into (default 'relativeLikelihoodPct')
  // - setProbability: if true, also writes into `probability` for backward compatibility (default true)
  const { outKey = 'relativeLikelihoodPct', setProbability = true } = options || {};
  const N = candidates.length;
  if (N === 0) return candidates;
  if (N === 1) {
    candidates[0][outKey] = 100;
    candidates[0].rank = 1;
    if (setProbability) candidates[0].probability = 100;
    return candidates;
  }
  // Sort descending by score
  candidates.sort((a, b) => (Number(b?.[scoreKey]) || -Infinity) - (Number(a?.[scoreKey]) || -Infinity));
  let i = 0;
  while (i < N) {
    const score = Number(candidates[i]?.[scoreKey]) || 0;
    let j = i + 1;
    while (j < N && (Number(candidates[j]?.[scoreKey]) || 0) === score) j++;
    // ranks are 1-based, tie-aware via average rank
    const rMin = i + 1;
    const rMax = j; // inclusive
    const rAvg = (rMin + rMax) / 2;
    const rl = 100 * ((N - rAvg) / (N - 1));
    const rlFixed = Number.isFinite(rl) ? +rl.toFixed(2) : 0;
    for (let k = i; k < j; k++) {
      candidates[k].rank = rAvg; // stored for explainability/debug
      candidates[k][outKey] = rlFixed;
      if (setProbability) candidates[k].probability = rlFixed;
    }
    i = j;
  }
  return candidates;
}
function calculateHistoricalFrequencyScoreParts(numbers, powerball) {
  const decayFactor = 0.95;
  const frequencyMap = new Map();
  historicalData.forEach((draw, index) => {
    const weight = Math.pow(decayFactor, historicalData.length - index - 1);
    draw.numbers.forEach(num => {
      frequencyMap.set(num, (frequencyMap.get(num) || 0) + weight);
    });
    frequencyMap.set(`pb_${(draw.powerball ?? draw.pb ?? draw.special)}`, (frequencyMap.get(`pb_${(draw.powerball ?? draw.pb ?? draw.special)}`) || 0) + weight);
  });
  const mains = Array.isArray(numbers) ? numbers : [];
  const mainScore = mains.length
    ? (mains.reduce((acc, num) => {
        const freq = frequencyMap.get(num) || 0;
        const prior = freq / Math.max(1, historicalData.length);
        const likelihood = 1 / 69;
        const posterior = prior * likelihood / (prior * likelihood + (1 - prior) * (1 - likelihood));
        return acc + posterior;
      }, 0) / mains.length)
    : 0;
  const pbFreq = frequencyMap.get(`pb_${powerball}`) || 0;
  const pbPrior = pbFreq / Math.max(1, historicalData.length);
  const pbLikelihood = 1 / 26;
  const pbPosterior = pbPrior * pbLikelihood / (pbPrior * pbLikelihood + (1 - pbPrior) * (1 - pbLikelihood));
  // Alignment: mains dominate, PB contributes but does not override mains
  const combined = (MAIN_WEIGHT * mainScore) + (POWERBALL_WEIGHT * pbPosterior);
  return { main: mainScore, pb: pbPosterior, combined };
}
function calculateHistoricalFrequencyScore(numbers, powerball) {
  // Backward-compatible wrapper returning the aligned combined score.
  return calculateHistoricalFrequencyScoreParts(numbers, powerball).combined;
}
function calculateRecentPatternsScoreParts(numbers, powerball) {
  const windowSize = 10;
  const recentDraws = historicalData.slice(-windowSize);
  let mainAcc = 0;
  let pbAcc = 0;
  recentDraws.forEach((draw, index) => {
    const recency = (index + 1) / windowSize;
    const mainMatches = numbers.filter(num => draw.numbers.includes(num)).length; // 0..5
    const pbMatch = ((draw.powerball ?? draw.pb ?? draw.special) === powerball) ? 1 : 0;
    // main: normalized 0..1, pb: 0 or 1
    mainAcc += (mainMatches / 5) * recency;
    pbAcc += pbMatch * recency;
  });
  const main = mainAcc / windowSize;        // 0..~1
  const pb = pbAcc / windowSize;            // 0..~1
  const combined = (MAIN_WEIGHT * main) + (POWERBALL_WEIGHT * pb);
  return { main, pb, combined };
}
function calculateRecentPatternsScore(numbers, powerball) {
  return calculateRecentPatternsScoreParts(numbers, powerball).combined;
}
function calculateRobustOverlapScoreParts(numbers, powerball, topK = 20) {
  if (!Array.isArray(historicalData) || historicalData.length === 0) return { main: 0, pb: 0, combined: 0 };
  // Main overlap against every historical draw (0..1)
  const overlaps = historicalData.map(draw => {
    const matchCount = numbers.filter(num => draw.numbers.includes(num)).length; // 0..5
    return matchCount / 5; // 0..1
  });
  overlaps.sort((a, b) => b - a);
  const k = Math.max(1, Math.min(topK, overlaps.length));
  const main = overlaps.slice(0, k).reduce((acc, x) => acc + x, 0) / k;
  // PB overlap: how often this PB appears in the last k draws (0..1)
  const tail = historicalData.slice(-k);
  const pbHits = tail.reduce((acc, d) => acc + ((Number(d.special) === Number(powerball)) ? 1 : 0), 0);
  const pb = pbHits / k;
  const combined = (0.90 * main) + (0.10 * pb);
  return { main, pb, combined };
}
function calculateRobustOverlapScore(numbers, powerball, topK = 20) {
  return calculateRobustOverlapScoreParts(numbers, powerball, topK).combined;
}
function calculateMethodAccuracyScore(method) {
  const methodAccuracy = {
    'Exponential': 0.85,
    'Frequency': 0.80,
    'LSTM': 0.90,
    'Monte Carlo': 0.82,
    'Markov': 0.83,  };
  return methodAccuracy[method] || 0.80;
}
function calculateNumberDistributionScore(numbers) {
  const mean = 35;
  const stdDev = 20;
  const distributionScore = numbers.reduce((score, num) => {
    const zScore = Math.abs(num - mean) / stdDev;
    return score + 1 / (1 + Math.exp(zScore - 2));
  }, 0) / numbers.length;
  return distributionScore;
}
function calculateCorrelationScore(numbers) {
  let correlationScore = 0;
  const ranges = [numbers.filter(n => n <= 23).length, numbers.filter(n => n > 23 && n <= 46).length, numbers.filter(n => n > 46).length];
  const rangeBalance = 1 - Math.max(...ranges) / 5;
  let consecutiveCount = 0;
  for (let i = 1; i < numbers.length; i++) {
    if (numbers[i] - numbers[i - 1] === 1) consecutiveCount++;
  }
  const consecutiveBalance = 1 - consecutiveCount / 4;
  correlationScore = (rangeBalance + consecutiveBalance) / 2;
  return correlationScore;
}
async function generateDraws() {
    // Double-run guard for Generate (v22)
    window.__pbvNext = window.__pbvNext || {};
    if (window.__pbvNext.generating) return;
    window.__pbvNext.generating = true;
    assertState('Generate:start');
    const elements = {
        container: document.getElementById('drawsContainer'),
        progress: {
            container: document.getElementById('progressContainer'),
            fill: document.getElementById('progressFill'),
            text: document.getElementById('progressText')
        },
        training: {
            wrapper: document.getElementById('trainingProgressWrapper'),
            bar: document.getElementById('trainingProgress'),
            label: document.getElementById('trainingProgressLabel')
        },
        exportButtons: document.querySelectorAll('.export-btn'),
        generateBtn: document.getElementById('generateNumbersBtn')
    };
    const nextFrame = () => new Promise(r => requestAnimationFrame(() => r()));
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    // Reset UI
    elements.container.innerHTML = '';
    elements.progress.fill.style.width = '0%';
    elements.progress.text.textContent = '';
    elements.progress.container.style.display = 'none';
    elements.exportButtons.forEach(btn => btn.disabled = true);
    // Lock generate button while running
    if (elements.generateBtn) elements.generateBtn.disabled = true;
    const selectedMethod = document.querySelector('input[name="predictionMethod"]:checked')?.value || 'frequency';
    const selectedDateElement = document.getElementById('startDate');
    const drawCountElement = document.getElementById('drawCount');
    const selectedDate = new Date(selectedDateElement.value);
    const __rawDrawCount = parseInt(drawCountElement?.value, 10);
    const drawCount = Math.max(1, Math.min(100, (isNaN(__rawDrawCount) ? 1 : __rawDrawCount)));
    // Leakage Guardrails: enforce cutoff (history must be strictly BEFORE selected prediction date)
    const __cutoffISO = selectedDateElement?.value;
    const __origHistorical = Array.isArray(historicalData) ? historicalData : [];
    const __eligibleHistorical = filterHistoricalBeforeDate(__origHistorical, __cutoffISO);
    window.__pbvNext = window.__pbvNext || {};
    window.__pbvNext.runCutoffISO = __cutoffISO || '';
    if (!__eligibleHistorical.length) {
      showWarn('No eligible historical draws exist before the selected date. Please choose a later draw date or load valid history.');
      if (elements.generateBtn) elements.generateBtn.disabled = true;
      window.__pbvNext.generating = false;
      return;
    }
    // Swap in eligible history for this run (restored in finally)
    historicalData = __eligibleHistorical;
    if (isNaN(drawCount) || drawCount <= 0 || isNaN(selectedDate.getTime())) {
        showErrorToast("Please enter valid date and draw count values.");
        if (elements.generateBtn) elements.generateBtn.disabled = false;
        return;
    }
    let completedDraws = 0;
    let startDrawDate = getNextDrawingDate(selectedDate);
    let generatedGames = [];
    // ---------------------------
    // STAGE 1 — LSTM TRAINING (separate, completes BEFORE draws)
    // ---------------------------
    try {
        const bypass = document.getElementById("bypassHistoricalData")?.checked;
        if (!bypass && selectedMethod === 'lstm') {
            // Ensure TFJS + model are ready BEFORE any draws start
            elements.training.wrapper.style.display = 'flex';
            elements.training.bar.value = 0;
            elements.training.label.textContent = 'Training Model...0%';
            // Let the browser paint the training UI before heavy work
            await nextFrame();
            // Load TFJS on-demand (already implemented in vNext patch)
            await ensureTFJSLoaded();
            await nextFrame();
            // Train (guarded so it only happens once)
            await trainModel(window.historicalData);
            // trainModel hides the wrapper in finally; ensure it's hidden even if it didn't
            elements.training.wrapper.style.display = 'none';
            // User awareness (success) — non-blocking
            showSuccessPopup('LSTM Model is Ready');
            await sleep(200); // small yield so the toast paints before the next stage
        }
        // ---------------------------
        // STAGE 2 — DRAWS + ANIMATION (only begins AFTER training completes)
        // ---------------------------
        elements.progress.container.style.display = 'block';
        // v31: Use a Web Worker for non-LSTM prediction generation to keep the UI responsive
        // (selectedMethod is defined once at the top of generateNumbers; do not redeclare here to avoid TDZ errors)
        const bypassed = !!document.getElementById("bypassHistoricalData")?.checked;
// Pre-compute draw dates once (also used by worker batching)
        const __drawDates = Array.from({ length: drawCount }, (_, idx) => getNextValidDrawDate(startDrawDate, idx));
        let __workerResults = null;
        const __canWorker = (!bypassed) && (selectedMethod !== 'lstm') && (typeof Worker !== "undefined");
        if (__canWorker) {
          try {
            elements.progress.text.textContent = 'Preparing predictions...';
            const dateISOs = __drawDates.map(d => (d instanceof Date ? d.toISOString() : new Date(d).toISOString()));
            __workerResults = await __runPredictionWorkerBatch({ method: selectedMethod, dates: dateISOs, startIndex: 0 });
          } catch (werr) {
            console.warn("Worker prediction failed; falling back to main thread:", werr);
            __workerResults = null;
          }
        }
        const __drawEls = [];
        const __drawDatesLocal = [];
        for (let i = 0; i < drawCount; i++) {
            const drawDate = __drawDates[i];
            let result;
            if (document.getElementById("bypassHistoricalData").checked) {
                // Random numbers (no history)
                const randomNumbers = [];
                for (let j = 0; j < 5; j++) randomNumbers.push(Math.floor(pbRng() * 69) + 1);
                const randomPowerball = Math.floor(pbRng() * 26) + 1;
                result = { numbers: randomNumbers, powerball: randomPowerball, method: "Random (No Historical Data)" };
            } else {
                result = (__workerResults && __workerResults[i]) ? __workerResults[i] : await hybridPrediction(drawDate, i);
            }
            if (!result || !result.numbers || !Array.isArray(result.numbers)) {
                console.error("Invalid prediction result:", result);
                throw new Error("Failed to generate valid prediction (Numbers missing or incorrect format)");
            }
            const { numbers, powerball, method } = result;
            const sortedNumbers = [...numbers].sort((a, b) => a - b);
            // Use the existing probability math as the *score* for ranking;
            // we will replace the displayed % with Relative Likelihood % (percentile rank) after all games are generated.
            const scoreMeta = computeScoreComponents(sortedNumbers, powerball, method);
            const score = Number(scoreMeta.rawPct); // initial raw score (0..100); may be overwritten by normalization
            // Store result with score + audit components (RL% assigned later)
            result = { ...result, numbers: sortedNumbers, powerball, method, score,
                       scoreWeights: scoreMeta.weights,
                       scoreComponents: scoreMeta.components,
                       scoreRawTotal: scoreMeta.rawTotal,
                       scoreMainRawTotal: scoreMeta.rawTotalMain,
                       scorePBRawTotal: scoreMeta.rawTotalPB,
                       scoreMainComponents: scoreMeta.mainComponents,
                       scorePBComponents: scoreMeta.pbComponents,
                       scoreRawPct: scoreMeta.rawPct };
            generatedGames.push(result);
            __drawDatesLocal.push(drawDate);
            // Auto-populate explainability with the first game generated
            if (i === 0) { try { renderExplainability(result, drawDate); } catch(e) {} }
            const drawDiv = document.createElement('div');
            drawDiv.className = 'draw-container';
            drawDiv.innerHTML = `
                <div class="draw-date">${formatDate(drawDate)}</div>
                <div class="ball-container">
                    ${sortedNumbers.map(num => `<div class="ball">${num}</div>`).join('')}
                    <div class="ball powerball">${powerball}</div>
                </div>
                <div class="probability">
                    <span class="rlPrimary" title="Run Likelihood is normalized within this run’s candidate pool (not jackpot odds).">
                        Aligned Run Likelihood: <span class="rlAligned">…</span>%
                    </span>
                    <span class="rlHidden" style="display:none">
                        <span class="rlGlobal">…</span>
                        <span class="rlModel">…</span>
                        <span class="rlMain">…</span>
                        <span class="rlPB">…</span>
                    </span>
                </div>
                <div class="prediction-method">Method: ${method}</div>
            `;
            // Explainability: click a generated game to see why these numbers were selected (v30)
            try {
              drawDiv.style.cursor = "pointer";
              drawDiv.title = "Click to view explainability";
              drawDiv.addEventListener("click", () => renderExplainability(result, drawDate));
            } catch(e) {}
            elements.container.appendChild(drawDiv);
            __drawEls.push(drawDiv);
            animateBalls(drawDiv);
            // Defer adding to Drawing History until RL% is assigned (percentile rank)
            completedDraws++;
            const progress = (completedDraws / drawCount) * 100;
            elements.progress.fill.style.width = `${progress}%`;
            elements.progress.text.textContent = `Generated Draw ${completedDraws} of ${drawCount}`;
            // yield so UI stays responsive
            await sleep(300);
            await nextFrame();
        }
        // Assign Relative Likelihood % (percentile rank) across this run's generated games
        // Global Run Likelihood % across all generated games in this run
        // v42: Normalize component scales (z-score) so weights remain stable across runs
        if (USE_NORMALIZED_SCORING) {
          // v46: Use frozen reference window stats (last N draws) for normalization
          window.__pbvNext = window.__pbvNext || {};
          if (USE_FROZEN_REFERENCE_WINDOW && !window.__pbvNext.frozenRefStats && Array.isArray(window.historicalData) && window.historicalData.length) {
            window.__pbvNext.frozenRefStats = buildFrozenReferenceStats(window.historicalData, FROZEN_REFERENCE_DRAWS, 'Frequency');
          }
          applyNormalizedScoringToRun(generatedGames, (USE_FROZEN_REFERENCE_WINDOW ? window.__pbvNext.frozenRefStats : null));
        }
        assignRelativeLikelihoodPercent(generatedGames, 'score', { outKey: 'globalRelativeLikelihoodPct', setProbability: true });
        // For compatibility, keep `relativeLikelihoodPct` mirroring global RL%
        generatedGames.forEach(g => { g.relativeLikelihoodPct = g.globalRelativeLikelihoodPct; });
        // Special Ball Alignment: compute separate Run Likelihood % for mains vs Powerball (scoped to this run pool)
        try {
          assignRelativeLikelihoodPercent(generatedGames.slice(), 'scoreMainRawTotal', { outKey: 'mainRelativeLikelihoodPct', setProbability: false });
          assignRelativeLikelihoodPercent(generatedGames.slice(), 'scorePBRawTotal', { outKey: 'powerballRelativeLikelihoodPct', setProbability: false });
          // Aligned RL%: explicit weighting between mains and Powerball (special)
          generatedGames.forEach(g => {
            const m = (g.mainRelativeLikelihoodPct !== undefined && g.mainRelativeLikelihoodPct !== null) ? Number(g.mainRelativeLikelihoodPct) : null;
            const pb = (g.powerballRelativeLikelihoodPct !== undefined && g.powerballRelativeLikelihoodPct !== null) ? Number(g.powerballRelativeLikelihoodPct) : null;
            if (m === null || pb === null || !isFinite(m) || !isFinite(pb)) {
              g.alignedRelativeLikelihoodPct = null;
              return;
            }
            const wMain = MAIN_WEIGHT;
            const wPB = POWERBALL_WEIGHT;
            const sum = (wMain + wPB);
            const wwMain = sum ? (wMain / sum) : MAIN_WEIGHT;
            const wwPB = sum ? (wPB / sum) : POWERBALL_WEIGHT;
            const val = (m * wwMain) + (pb * wwPB);
            g.alignedRelativeLikelihoodPct = Math.round(val * 10) / 10; // 1-decimal
          });
        } catch (e) { /* non-blocking */ }
        // Model Run Likelihood % within each method group
        const __byMethod = new Map();
        generatedGames.forEach(g => {
          const key = (g.method || 'Unknown').toString();
          if (!__byMethod.has(key)) __byMethod.set(key, []);
          __byMethod.get(key).push(g);
        });
        __byMethod.forEach(group => {
          assignRelativeLikelihoodPercent(group, 'score', { outKey: 'modelRelativeLikelihoodPct', setProbability: false });
        });
        // Update UI labels and persist to Drawing History
        for (let idx = 0; idx < generatedGames.length; idx++) {
            const entry = generatedGames[idx];
            const el = __drawEls[idx];
            if (el) {
                const spanG = el.querySelector('.rlGlobal');
                const spanM = el.querySelector('.rlModel');
                const spanMain = el.querySelector('.rlMain');
                const spanPB = el.querySelector('.rlPB');
                const spanAligned = el.querySelector('.rlAligned');
if (spanG) spanG.textContent = String(entry.globalRelativeLikelihoodPct ?? entry.relativeLikelihoodPct ?? entry.probability ?? '…');
                if (spanM) spanM.textContent = String(entry.modelRelativeLikelihoodPct ?? '…');
                const hasMain = (entry.mainRelativeLikelihoodPct !== undefined && entry.mainRelativeLikelihoodPct !== null);
                const hasPB = (entry.powerballRelativeLikelihoodPct !== undefined && entry.powerballRelativeLikelihoodPct !== null);
                if (spanMain) spanMain.textContent = hasMain ? String(entry.mainRelativeLikelihoodPct) : '…';
                if (spanPB) spanPB.textContent = hasPB ? String(entry.powerballRelativeLikelihoodPct) : '…';
                const hasAligned = (entry.alignedRelativeLikelihoodPct !== undefined && entry.alignedRelativeLikelihoodPct !== null);
                if (spanAligned) spanAligned.textContent = hasAligned ? String(entry.alignedRelativeLikelihoodPct) : '…';
                // Update tooltip on the visible label with the latest breakdown values (if available)
                const primary = el.querySelector('.rlPrimary');
                if (primary) {
                    const g = spanG ? spanG.textContent : '…';
                    const mm = spanM ? spanM.textContent : '…';
                    const main = spanMain ? spanMain.textContent : '…';
                    const pb = spanPB ? spanPB.textContent : '…';
                    const aligned = spanAligned ? spanAligned.textContent : '…';
                    const mw = (typeof MAIN_WEIGHT !== 'undefined') ? Math.round(MAIN_WEIGHT * 100) : 85;
                    const pw = (typeof POWERBALL_WEIGHT !== 'undefined') ? Math.round(POWERBALL_WEIGHT * 100) : 15;
                    primary.title =
                        `Aligned Run Likelihood is normalized within this run’s candidate pool (not jackpot odds).\n` +
                        `Aligned: ${aligned}% (Main ${mw}% / Powerball ${pw}%)\n` +
                        `Main RL: ${main}%\n` +
                        `Powerball RL: ${pb}%\n` +
                        `Global RL: ${g}%\n` +
                        `Model RL: ${mm}%`;
                }
}
            // Persist this draw to Drawing History with RL% already assigned
            try {
                addToDrawingHistory(entry, __drawDatesLocal[idx]);
            } catch (e) {
                console.warn('Failed to add to drawing history:', e);
            }
        }
        // Ensure explainability panel (if present) is refreshed using the finalized RL%
        try {
            if (generatedGames[0] && __drawDatesLocal[0]) {
                renderExplainability(generatedGames[0], __drawDatesLocal[0]);
            }
        } catch (e) {}
        // Stability Index: compute for this draw date using the reconciled Drawing History pool
        try {
            const __d0 = (__drawDatesLocal && __drawDatesLocal[0]) ? __drawDatesLocal[0].toISOString() : null;
            if (__d0 && window.__pbvNext && typeof window.__pbvNext.updateStabilityMeta === 'function') {
                window.__pbvNext.updateStabilityMeta(__d0);
            }
        } catch (_) {}
        const editFormButton = document.createElement("button");
        editFormButton.textContent = "Edit All Games in Form";
        editFormButton.classList.add("export-btn");
        editFormButton.onclick = () => sendNumbersToForm(generatedGames);
        elements.container.appendChild(editFormButton);
    } catch (error) {
        showErrorToast(`Error generating predictions: ${error.message}`);
        console.error("Generation error:", error);
    } finally {
        elements.progress.container.style.display = 'none';
        elements.training.wrapper.style.display = 'none';
        // Leakage Guardrails: restore full historical data after run
        try { historicalData = __origHistorical; } catch(e) {}
        try { if (window.__pbvNext) window.__pbvNext.runCutoffISO = ''; } catch(e) {}
        // Re-enable exports (if any)
        elements.exportButtons.forEach(btn => {
            btn.disabled = false;
            btn.style.opacity = '1';
        });
        // Unlock generate button + release guard (v22)
        try { window.__pbvNext && (window.__pbvNext.generating = false); } catch (e) {}
        if (elements.generateBtn) elements.generateBtn.disabled = false;
        assertState('Generate:end');
        setTimeout(() => {
            updateHistoryTable();
            checkAndNotifyForDrawing();
        }, 2000);
    }
}
function sendNumbersToForm(games) {
    const params = new URLSearchParams();
    games.forEach((game, index) => {
        params.append(`game${index + 1}_numbers`, game.numbers.join(","));
        params.append(`game${index + 1}_powerball`, game.powerball);
    });
    window.open(`Powerball_Form_Edit_1.html?${params.toString()}`, "_blank");
}
function checkAndNotifyForDrawing() {
    window.__pbvNext = window.__pbvNext || {};
    if (window.__pbvNext.__nextDrawNoticeShown) return;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const nextDrawDate = getNextDrawingDate();
    nextDrawDate.setHours(0, 0, 0, 0);
    if (today.getTime() === nextDrawDate.getTime()) {
        const historyTableBody = document.getElementById('historyTableBody');
        const checkCompletion = setInterval(() => {
            const rows = Array.from(historyTableBody.querySelectorAll('tr'));
            if (rows.length > 0) {
                const drawingData = rows.map(row => ({
                    numbers: row.cells[2]?.textContent.split(',').map(num => parseInt(num.trim(), 10)),
                    powerball: parseInt(row.cells[3]?.textContent.trim(), 10),
                    probability: parseFloat(row.cells[4]?.textContent.trim().replace('%', ''))
                }));
                const highestProbabilityEntry = drawingData.reduce((max, entry) =>
                    (entry.probability > (max?.probability || 0) ? entry : max), null);
                if (highestProbabilityEntry) {
                    const formattedNumbers = highestProbabilityEntry.numbers.map(n => n.toString().padStart(2, '0')).join(', ');
                    const formattedPowerball = highestProbabilityEntry.powerball.toString().padStart(2, '0');
                    window.__pbvNext.__nextDrawNoticeShown = true;
                    showErrorToast(`The next Powerball drawing is today! Go immediately to purchase your tickets.\n\n` +
                          `Numbers with the greatest probability: [${formattedNumbers}] | Powerball: ${formattedPowerball}`);
                    clearInterval(checkCompletion);
                }
            }
        }, 500);
    }
}
function formatDate(date) {
  // Treat YYYY-MM-DD as a local date (midday) to avoid timezone weekday drift.
  const d = (typeof date === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(date))
    ? new Date(date + 'T12:00:00')
    : new Date(date);
  return d.toLocaleDateString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}
function animateBalls(container) {
  const balls = container.querySelectorAll('.ball');
  balls.forEach((ball, index) => {
    setTimeout(() => {
      ball.style.animation = 'dropAndBounce 1s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards';
    }, index * 200);
  });
}
function loadScript(src) {
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = src;
    script.onload = resolve;
    script.onerror = reject;
    document.head.appendChild(script);
  });
}
function buildDrawingHistoryReportHTML() {
  if (!Array.isArray(drawingHistory) || drawingHistory.length === 0) return '';
  let tableHTML = `
        <html>
        <head>
            <title>Texas Powerball Drawing History</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    padding: 20px;
                    -webkit-print-color-adjust: exact !important;
                    print-color-adjust: exact !important;
                }
                table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                th, td { border: 1px solid #ddd; padding: 12px 8px; text-align: center; }
                th { background-color: #f5f5f5; font-weight: bold; }
                .powerball-number { color: #ff0000 !important; font-weight: bold; }
                .duplicate-number { color: #008000 !important; font-weight: bold; }
                .highest-probability { background-color: rgba(255, 255, 0, 0.2) !important; }
                .all-numbers-match { background-color: rgba(0, 0, 255, 0.1) !important; }
                footer { text-align: center; margin-top: 30px; font-size: 14px; color: #666; }
                @media print {
                    thead { display: table-header-group; }
                    .powerball-number { color: #ff0000 !important; font-weight: bold !important; }
                    .duplicate-number { color: #008000 !important; font-weight: bold !important; }
                    .highest-probability { background-color: rgba(255, 255, 0, 0.2) !important; }
                    .all-numbers-match { background-color: rgba(0, 0, 255, 0.1) !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
                }
            </style>
        </head>
        <body>
            <h1>Texas Powerball Drawing History</h1>
            <table>
                <thead>
                    <tr>
                        <th>Model Type</th>
                        <th>Draw Date</th>
                        <th>Numbers</th>
                        <th>Powerball</th>
                        <th title="Run Likelihood % normalized within this method pool.">Model Run Likelihood (%)</th><th title="Run Likelihood % normalized across methods for this draw date.">Global Run Likelihood (%)</th>
                    </tr>
                </thead>
                <tbody>`;
  const sortedHistory = [...drawingHistory].sort((a, b) => new Date(a.drawDate) - new Date(b.drawDate));
  const numberFrequency = new Map();
  sortedHistory.forEach(entry => {
    entry.numbers.forEach(num => {
      numberFrequency.set(num, (numberFrequency.get(num) || 0) + 1);
    });
  });
  sortedHistory.forEach(entry => {
    const row = document.createElement('tr');
    const formattedNumbers = entry.numbers.map(num => {
      const isDup = numberFrequency.get(num) > 1;
      const cls = isDup ? 'duplicate-number' : '';
      return `<span class="${cls}">${num.toString().padStart(2, ' ')}</span>`;
    }).join(', ');
    row.innerHTML = `
        <td>${entry.method || entry.modelType || ''}</td>
        <td>${entry.drawDate}</td>
        <td>${formattedNumbers}</td>
        <td class="powerball-number">${entry.powerball.toString().padStart(2, ' ')}</td>
        <td>${Number(entry.modelRelativeLikelihoodPct ?? 0).toFixed(2)}%</td><td>${Number(entry.globalRelativeLikelihoodPct ?? entry.probability ?? 0).toFixed(2)}%</td>
    `;
    const duplicatesInRow = entry.numbers.filter(num => numberFrequency.get(num) > 1).length;
    if (duplicatesInRow === 5) row.classList.add('all-numbers-match');
    tableHTML += row.outerHTML;
  });
  tableHTML += `
              </tbody>
          </table>
          <footer>
              Generated by Powerball vNext
          </footer>
<!-- Enhancement #7 — Stage B: Reload Historical Data (Destructive) Modal -->
<div id="pbReloadModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:99999; align-items:center; justify-content:center;">
  <div style="width:min(860px, 92vw); background:#fff; border-radius:22px; padding:26px 28px 22px; box-shadow:0 18px 50px rgba(0,0,0,0.35);">
    <div style="font-size:30px; font-weight:900; margin-bottom:8px;">Reload Historical Data (Destructive)</div>
    <div style="font-size:15px; line-height:1.5; color:#333; margin-bottom:14px;">
      This will overwrite the current <b>Historical Data JSON</b> by re-importing from the backup text file. Any historical data currently stored in JSON will be replaced.
      <div style="margin-top:10px; font-weight:800;">Notes:</div>
      <ul style="margin:8px 0 0 18px; padding:0; color:#333;">
        <li>The backup text file is not modified by this program; it is a read-only backup input.</li>
        <li>Previous Predictions JSON is not deleted.</li>
      </ul>
    </div>
    <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:18px;">
      <button id="pbReloadCancel" style="background:#6b7280; color:#fff; border:none; border-radius:16px; padding:12px 18px; font-weight:800; cursor:pointer;">Cancel</button>
      <button id="pbReloadConfirm" style="background:#b91c1c; color:#fff; border:none; border-radius:16px; padding:12px 18px; font-weight:900; cursor:pointer;">Yes — Reload from Text</button>
    </div>
  </div>
</div>
<style id="enh9-d4-map-ui-override">
/* Enhancement #9 — D4 UI overrides (safe) */
#e9MapCanvas.e9map-canvas{
  display:flex !important;
  align-items:center !important;
  justify-content:center !important;
  padding:10px 10px 14px 10px !important;
}
/* Scale up the embedded USA SVG to better fill the canvas while remaining centered */
#e9MapCanvas.e9map-canvas > svg.e9usa-svg{
  width: 128% !important;
  height: 128% !important;
  max-width:none !important;
  max-height:none !important;
  transform-origin: 50% 50% !important;
}
/* On smaller screens, reduce the scale to avoid clipping */
@media (max-width: 980px){
  #e9MapCanvas.e9map-canvas > svg.e9usa-svg{
    width: 112% !important;
    height: 112% !important;
  }
}
</style>
</body>
      </html>`;
  return tableHTML;
}
function buildDrawingHistoryReportText() {
  if (!Array.isArray(drawingHistory) || drawingHistory.length === 0) return '';
  const sortedHistory = [...drawingHistory].sort((a, b) => new Date(a.drawDate) - new Date(b.drawDate));
  const lines = [];
  lines.push('Texas Powerball Drawing History');
  lines.push('');
  lines.push(['Model Type','Draw Date','Numbers','Powerball','Model RL (%)','Global RL (%)'].join(' | '));
  lines.push('-'.repeat(80));
  sortedHistory.forEach(entry => {
    const nums = (entry.numbers || []).map(n => n.toString().padStart(2,'0')).join(', ');
    const pb = (entry.powerball ?? '').toString().padStart(2,'0');
    const mrl = (entry.modelRelativeLikelihoodPct ?? '').toString();
    const grl = (entry.globalRelativeLikelihoodPct ?? entry.probability ?? '').toString();
    lines.push([entry.modelType || entry.method || '', entry.drawDate || '', nums, pb, mrl, grl].join(' | '));
  });
  return lines.join('\n');
}
function printDrawingHistory() {
  if (!Array.isArray(drawingHistory) || drawingHistory.length === 0) {
    showErrorToast("No drawing history available to print.");
    return;
  }
  const html = buildDrawingHistoryReportHTML();
  const printWindow = window.open('', '_blank');
  printWindow.document.write(html);
  printWindow.document.close();
  printWindow.onload = function () {
    printWindow.print();
    printWindow.close();
  };
}
function printResults() {
  const drawContainers = document.querySelectorAll('.draw-container');
  if (drawContainers.length === 0) {
    showErrorToast("No predictions available to print.");
    return;
  }
  const method = drawContainers[0]?.querySelector('.prediction-method')?.textContent.replace('Method: ', '') || 'Unknown';
  if (drawContainers.length <= 5) {
    document.body.classList.add('print-condensed');
    window.print();
    document.body.classList.remove('print-condensed');
  } else {
    const printWindow = window.open('', '_blank');
    let tableHTML = `
            <html>
            <head>
                <title>Texas Powerball Predictions using ${method}</title>
                <style>
                    body { font-family: Arial, sans-serif; }
                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
                    th { background-color: #f2f2f2; }
                    h1 { text-align: center; }
                    footer { text-align: center; margin-top: 20px; font-size: 14px; color: #555; }
                    @media print {
                        thead { display: table-header-group; }
                    }
                </style>
            </head>
            <body>
                <h1>Texas Powerball Predictions using ${method}</h1>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Numbers</th>
                            <th>Powerball</th>
                            <th>Method</th>
                        </tr>
                    </thead>
                    <tbody>`;
    drawContainers.forEach(container => {
      const date = container.querySelector('.draw-date').textContent;
      const balls = Array.from(container.querySelectorAll('.ball'));
      const numbers = balls.slice(0, -1).map(ball => {
        const num = parseInt(ball.textContent);
        return num < 10 ? num : ball.textContent;
      }).join(', ');
      const powerball = parseInt(balls[balls.length - 1].textContent) < 10 ? parseInt(balls[balls.length - 1].textContent) : balls[balls.length - 1].textContent;
      tableHTML += `
              <tr>
                  <td>${date}</td>
                  <td>${numbers}</td>
                  <td>${powerball}</td>
                  <td>${method}</td>
              </tr>`;
    });
    tableHTML += `
                    </tbody>
                </table>
                <footer>Created by Stephen King</footer>
            </body>
            </html>`;
    printWindow.document.write(tableHTML);
    printWindow.document.close();
    printWindow.onload = function () {
      printWindow.print();
      printWindow.close();
    };
  }
}
async function exportToEmail() {
  if (!Array.isArray(drawingHistory) || drawingHistory.length === 0) {
    showErrorToast("No drawing history to export.");
    return;
  }
  const subject = encodeURIComponent('Texas Powerball Drawing History');
  const body = encodeURIComponent(buildDrawingHistoryReportText());
  const mailto = `mailto:?subject=${subject}&body=${body}`;
  window.location.href = mailto;
}
function initHistoryDuplicatesVisibility(){
  const dhToggle = document.getElementById('toggleDrawingHistory');
  const tdToggle = document.getElementById('toggleTopDuplicates');
  const dhContent = document.getElementById('drawingHistoryContent');
  const tdContent = document.getElementById('topDuplicatesContent');
  const hdToggle = document.getElementById('toggleHistoricalData');
  const hdContent = document.getElementById('historicalDataContent');
  // Do not fail-open: if a toggle pair is missing, simply skip it.
  const apply = () => {
    if (dhToggle && dhContent) dhContent.style.display = dhToggle.checked ? '' : 'none';
    if (tdToggle && tdContent) tdContent.style.display = tdToggle.checked ? '' : 'none';
    if (hdToggle && hdContent) hdContent.style.display = hdToggle.checked ? '' : 'none';
  };
  if (dhToggle) dhToggle.addEventListener('change', apply);
  if (tdToggle) tdToggle.addEventListener('change', apply);
  if (hdToggle) hdToggle.addEventListener('change', apply);
  // Initial state
  apply();
  // If sections are empty, hide them by default
  try{
    const historyRows = (document.getElementById('historyTableBody')?.children?.length) || 0;
    const dupRows = (document.getElementById('duplicatesTableBody')?.children?.length) || 0;
    if(historyRows === 0){
      dhToggle.checked = false;
    }
    if(dupRows === 0){
      tdToggle.checked = false;
    }
    apply();
  }catch(e){
    // ignore
  }
}
function initExplainabilityVisibility(){
  const exToggle = document.getElementById('toggleExplainability');
  const exContent = document.getElementById('explainabilityContent');
  if(!exToggle || !exContent) return;
  const apply = () => {
    // Keep Run Breakdown visible even when the section is "hidden"
    exContent.style.display = '';
    if(exToggle.checked){
      exContent.classList.remove('explainability-collapsed');
    }else{
      exContent.classList.add('explainability-collapsed');
    }
  };
  exToggle.addEventListener('change', apply);
  apply();
}
function initEnh9D5Visibility(){
  const t = document.getElementById('toggleEnh9D5');
  const c = document.getElementById('enh9D5Content');
  if(!t || !c) return;
  const apply = () => { c.style.display = t.checked ? '' : 'none'; };
  t.addEventListener('change', apply);
  apply();
}
function initEnh9D6Visibility(){
  const t = document.getElementById('toggleEnh9D6');
  const c = document.getElementById('enh9D6Content');
  if(!t || !c) return;
  const apply = () => { c.style.display = t.checked ? '' : 'none'; };
  t.addEventListener('change', apply);
  apply();
}
function initEnh9D7Visibility(){
  const t = document.getElementById('toggleEnh9D7');
  const c = document.getElementById('enh9D7Content');
  if(!t || !c) return;
  const apply = () => { c.style.display = t.checked ? '' : 'none'; };
  t.addEventListener('change', apply);
  apply();
}
function initEnh9D7GovernanceUI(){
  const btnShow = document.getElementById('e9ShowConfigBtn');
  const btnExport = document.getElementById('e9ExportConfigBtn');
  const btnSelf = document.getElementById('e9RunSchemaSelfTestBtn');
  const view = document.getElementById('e9ConfigView');
  const msg = document.getElementById('e9SchemaSelfTestMsg');
  const MOD = (window.__pbvNext && window.__pbvNext.e9) ? window.__pbvNext.e9 : null;
  const cfg = MOD ? MOD.config : null;
  function renderCfg(){
    if(!view) return;
    if(!cfg){ view.textContent = "Config unavailable (vE9 module not initialized)."; return; }
    view.textContent = JSON.stringify(cfg, null, 2);
  }
  function exportCfg(){
    if(!cfg) return;
    try{
      const blob = new Blob([JSON.stringify(cfg, null, 2)], { type:"application/json" });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = "PB_E9_CONFIG_V1.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 500);
    } catch(e){
      if(msg) msg.textContent = "Export failed: " + (e && e.message ? e.message : String(e));
    }
  }
  function selfTest(){
    if(!MOD || !MOD.validators){
      if(msg) msg.textContent = "Self-test unavailable (validators not loaded).";
      return;
    }
    const errs = [];
    // Manifest + ledger + output use last run objects when available.
    if(MOD.lastRunManifest){
      const r = MOD.validators.validatePB_E9_RUN_MANIFEST_V1(MOD.lastRunManifest);
      if(!r.ok) errs.push("Manifest: " + r.errs.join("; "));
    } else {
      errs.push("Manifest: (no last run)");
    }
    if(MOD.lastAuditLedger){
      const r = MOD.validators.validatePB_E9_AUDIT_LEDGER_V1(MOD.lastAuditLedger);
      if(!r.ok) errs.push("Ledger: " + r.errs.join("; "));
    } else {
      errs.push("Ledger: (no last run)");
    }
    if(MOD.lastPredictionOutput){
      const r = MOD.validators.validatePB_E9_PREDICTION_OUTPUT_V1(MOD.lastPredictionOutput);
      if(!r.ok) errs.push("Output: " + r.errs.join("; "));
    } else {
      errs.push("Output: (no last run)");
    }
    if(msg){
      msg.textContent = errs.length ? ("Schema Self-Test: FAIL — " + errs.join(" | ")) : "Schema Self-Test: PASS";
    }
  }
  if(btnShow) btnShow.addEventListener('click', renderCfg);
  if(btnExport) btnExport.addEventListener('click', exportCfg);
  if(btnSelf) btnSelf.addEventListener('click', selfTest);
  // initial render is intentionally not automatic
}
document.addEventListener("DOMContentLoaded", async function () {
  const startDateInput = document.getElementById("startDate");
  // v75 hardening: do not let missing/changed button markup break draw-date initialization
  const generateButton = document.getElementById("generateNumbersBtn") || document.querySelector('button[onclick="generateDraws()"]');
  if (generateButton) {
    generateButton.disabled = true;
    generateButton.title = "Please load historical data first";
  }
  // Init section visibility toggles (Drawing History / Top Duplicates)
  initHistoryDuplicatesVisibility();
  initExplainabilityVisibility();
  initEnh9D5Visibility();
  initEnh9D6Visibility();
  initEnh9D7Visibility();
  initEnh9D7GovernanceUI();
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  const todayFormatted = `${yyyy}-${mm}-${dd}`;
  startDateInput.min = todayFormatted;
  // Default to TODAY if today is a valid draw day (Mon/Wed/Sat); otherwise default to the next draw day.
  const isTodayDrawDay = [1, 3, 6].includes(today.getDay());
  const nextDrawing = isTodayDrawDay ? today : getNextDrawingDate(today);
  startDateInput.value = nextDrawing.toISOString().split('T')[0];
  startDateInput.addEventListener("input", function () {
    const selectedDate = new Date(startDateInput.value);
    // Allow today if it is a valid draw day; otherwise enforce a future valid draw day.
    if (selectedDate < today || ![1, 3, 6].includes(selectedDate.getDay())) {
      showErrorToast("Please select a Monday, Wednesday, or Saturday on or after today's date.");
      startDateInput.value = nextDrawing.toISOString().split('T')[0];
    }
  });
  if (generateButton) {
    generateButton.disabled = true;
    generateButton.title = 'Please load historical data first';
  }
  // --- FIX: Enable Enter Recent Powerball Numbers immediately after successful historical load ---
  const loadBtn = document.getElementById("loadDataBtn");
  const manualBtn = document.getElementById("manualEntryBtn");
  const forceEnableManualBtnIfReady = () => {
    const ready = !!(window.__pbvNext && window.__pbvNext.historicalDataLoaded);
    if (!manualBtn) return;
    if (ready) {
      manualBtn.disabled = false;
      manualBtn.removeAttribute("disabled");
      manualBtn.style.pointerEvents = "auto";
      manualBtn.style.opacity = "1";
      manualBtn.title = "";
    } else {
      manualBtn.disabled = true;
      manualBtn.setAttribute("disabled", "");
      manualBtn.style.pointerEvents = "none";
      manualBtn.style.opacity = "0.5";
      manualBtn.title = "Please load historical data first";
    }
  };
  // initial state
  forceEnableManualBtnIfReady();
  if (loadBtn) {
    loadBtn.addEventListener("click", async (e) => {
      try {
        await loadDataFromFile();
      } finally {
        // After load completes, force-enable based on actual data readiness.
        forceEnableManualBtnIfReady();
      }
    });
  }
});
function normalizeHistoricalData(draws) {
  if (!Array.isArray(draws)) return [];
  const normDate = (d) => {
    if (!d) return null;
    // accept YYYY-MM-DD or MM/DD/YYYY or Date
    if (typeof d === 'string') {
      const s = d.trim();
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
      const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (m) {
        const mm = String(m[1]).padStart(2,'0');
        const dd = String(m[2]).padStart(2,'0');
        return `${m[3]}-${mm}-${dd}`;
      }
    }
    try {
      const dt = new Date(d);
      if (!isNaN(dt.getTime())) return dt.toISOString().slice(0,10);
    } catch {}
    return null;
  };
  const out = [];
  for (const raw of draws) {
    if (!raw) continue;
    const date = normDate(raw.date ?? raw.Date ?? raw.drawDate);
    let nums = raw.numbers ?? raw.Numbers ?? raw.main ?? raw.mainNumbers;
    if (typeof nums === 'string') {
      nums = nums.split(/[^0-9]+/).filter(Boolean).map(n=>parseInt(n,10));
    }
    if (!Array.isArray(nums)) continue;
    nums = nums.map(n=>parseInt(n,10)).filter(n=>Number.isFinite(n));
    if (nums.length !== 5) continue;
    nums = nums.map(n=>Math.min(Math.max(n,1),69));
    const specialRaw = raw.special ?? raw.powerball ?? raw.Powerball ?? raw.pb ?? raw.PB;
    const special = Math.min(Math.max(parseInt(specialRaw,10),1),26);
    if (!Number.isFinite(special)) continue;
    if (!date) continue;
    out.push({ date, numbers: nums, special });
  }
  // de-dupe by date (keep first)
  const seen = new Set();
  const dedup = [];
  for (const d of out.sort((a,b)=>a.date.localeCompare(b.date))) {
    if (seen.has(d.date)) continue;
    seen.add(d.date);
    dedup.push(d);
  }
  return dedup;
}
/* ---------------------------
   Leakage Guardrails (v53)
   - Ensures historical windows use only draws strictly BEFORE the selected prediction date.
   - Adds basic history integrity audit (date parse, duplicates, sort order).
---------------------------- */
function validateAndSortHistoricalData(draws) {
  const report = { total: 0, kept: 0, droppedInvalidDate: 0, droppedInvalidShape: 0, duplicateDates: 0, wasOutOfOrder: false };
  if (!Array.isArray(draws)) return { clean: [], report };
  report.total = draws.length;
  const parsed = [];
  const seenDates = new Set();
  let lastTs = -Infinity;
  draws.forEach(d => {
    const iso = (d && (d.date || d.drawDate || d.drawingDate || d.Date)) ? String(d.date || d.drawDate || d.drawingDate || d.Date).trim() : '';
    const dt = new Date(iso);
    if (!iso || isNaN(dt.getTime())) { report.droppedInvalidDate++; return; }
    const nums = Array.isArray(d.numbers) ? d.numbers : (Array.isArray(d.nums) ? d.nums : null);
    const pb = (Number.isFinite(d.powerball) ? d.powerball : (Number.isFinite(d.pb) ? d.pb : (Number.isFinite(d.special) ? d.special : null)));
    if (!Array.isArray(nums) || nums.length !== 5 || pb === null || !Number.isFinite(pb)) { report.droppedInvalidShape++; return; }
    // Track out-of-order in original sequence (best-effort)
    const ts = dt.getTime();
    if (ts < lastTs) report.wasOutOfOrder = true;
    lastTs = ts;
    const keyDate = dt.toISOString().slice(0,10);
    if (seenDates.has(keyDate)) { report.duplicateDates++; return; }
    seenDates.add(keyDate);
    parsed.push({
      date: keyDate,
      numbers: nums.map(n => Number(n)).filter(Number.isFinite).slice(0,5),
      powerball: Number(pb)
    });
  });
  // Sort ascending by date for deterministic windowing
  parsed.sort((a,b) => new Date(a.date) - new Date(b.date));
  report.kept = parsed.length;
  return { clean: parsed, report };
}
function filterHistoricalBeforeDate(draws, cutoffISO) {
  const cutoff = cutoffISO ? new Date(String(cutoffISO).trim()) : null;
  if (!Array.isArray(draws) || !cutoff || isNaN(cutoff.getTime())) return Array.isArray(draws) ? draws.slice() : [];
  return draws.filter(d => {
    const dt = new Date(d.date || d.drawDate || d.drawingDate || d.Date || 0);
    return !isNaN(dt.getTime()) && dt.getTime() < cutoff.getTime();
  });
}
function showWarn(msg) {
  try {
    if (typeof showSuccessPopup === 'function') showSuccessPopup('⚠️ ' + msg);
    else showErrorToast('Warning: ' + msg);
  } catch(e) { try { showErrorToast('Warning: ' + msg); } catch(_){} }
}
async function loadDataFromFile() {
  // Attempts to connect to a real file for read/write (best) using File System Access API.
  // Falls back to classic <input type="file"> read-only mode.
  const generateBtnById = document.getElementById('generateNumbersBtn');
  const generateBtnAttr = document.querySelector('button[onclick="generateDraws()"]');
  const manualEntryBtn  = document.getElementById('manualEntryBtn');
  const loadDataBtn     = document.getElementById('loadDataBtn');
  const lastDrawDateText= document.getElementById('lastDrawDateText');
  const controlsContainer = document.getElementById('controls-container');
  const loadFileBtn       = document.getElementById('load-file-btn');
  const setButtonsEnabled = (enabled) => {
    if (generateBtnById) {
      generateBtnById.disabled = !enabled;
      generateBtnById.style.opacity = enabled ? '1' : '0.5';
      generateBtnById.title = enabled ? '' : 'Please load historical data first';
    }
    if (generateBtnAttr) {
      generateBtnAttr.disabled = !enabled;
      generateBtnAttr.style.opacity = enabled ? '1' : '0.5';
      generateBtnAttr.title = enabled ? '' : 'Please load historical data first';
    }
    {
      const meBtn = document.getElementById('manualEntryBtn');
      if (meBtn) {
        meBtn.disabled = !enabled;
        meBtn.style.opacity = enabled ? '1' : '0.5';
        meBtn.title = enabled ? '' : 'Please load historical data first';
        if (enabled) meBtn.removeAttribute('disabled'); else meBtn.setAttribute('disabled','');
      }
    }
  };
  const parseHistoryFile = (content) => {
    const histMatch = content.match(/\[historicalData\](.*?)\[previousPredictions\]/s);
    const prevMatch = content.match(/\[previousPredictions\]([\s\S]*)$/);
    if (!histMatch || !prevMatch) {
      throw new Error('Invalid file format. Missing [historicalData] or [previousPredictions] sections.');
    }
    const histRaw = (histMatch[1] || '').trim();
    const prevRaw = (prevMatch[1] || '').trim();
    // ---- Parse historicalData ----
    // File format: objects separated by commas, no surrounding [ ].
    let histJson = [];
    if (histRaw) {
      if (histRaw.startsWith('[')) {
        histJson = JSON.parse(histRaw);
      } else {
        // Remove a trailing comma (common when appending)
        const cleaned = histRaw.replace(/,\s*$/,'').trim();
        histJson = JSON.parse('[' + cleaned + ']');
      }
    }
    // ---- Parse previousPredictions ----
    // Accept:
    // 1) JSON array
    // 2) NDJSON (one JSON object per line)  <-- your current standard
    // 3) legacy comma-separated objects without [ ]
    let prevJson = [];
    if (prevRaw) {
      if (prevRaw.startsWith('[')) {
        prevJson = JSON.parse(prevRaw);
      } else if (/\n\s*\{/.test(prevRaw)) {
        // NDJSON
        prevJson = prevRaw
          .split(/\r?\n/)
          .map(l => l.trim())
          .filter(l => l && l.startsWith('{') && l.endsWith('}'))
          .map(l => JSON.parse(l));
      } else {
        // Try wrap-as-array for single-object or comma-separated objects
        const cleanedPrev = prevRaw.replace(/,\s*$/,'').trim();
        try {
          prevJson = JSON.parse('[' + cleanedPrev + ']');
        } catch (e) {
          // Last resort: if it looks like `}{` without commas, split and parse
          const parts = cleanedPrev.split(/}\s*{/).map((p,i,arr)=>{
            if (i===0) return p.endsWith('}')?p:p+'}';
            if (i===arr.length-1) return p.startsWith('{')?p:'{'+p;
            return '{'+p+'}';
          });
          prevJson = parts.map(p => JSON.parse(p));
        }
      }
    }
    historicalData = normalizeHistoricalData(histJson);
    window.historicalData = historicalData;
    // Leakage Guardrails: audit + enforce clean, sorted history
    try {
      const audit = validateAndSortHistoricalData(historicalData);
      historicalData = audit.clean;
      window.historicalData = historicalData;
      window.__pbvNext = window.__pbvNext || {};
      window.__pbvNext.historyAudit = audit.report;
      if (audit.report.droppedInvalidDate || audit.report.droppedInvalidShape || audit.report.duplicateDates) {
        showWarn(`Historical data cleaned: kept ${audit.report.kept}/${audit.report.total} (dropped invalidDate=${audit.report.droppedInvalidDate}, invalidShape=${audit.report.droppedInvalidShape}, dupDates=${audit.report.duplicateDates}).`);
      } else if (audit.report.wasOutOfOrder) {
        showWarn('Historical data was out of chronological order. It has been sorted for stable windowing.');
      }
    } catch(e) {}
    // JSON is authoritative once initialized. Only accept previousPredictions from legacy text sections if JSON has never been created.
    const __jsonPrimed = !!(window.__pbvNext && window.__pbvNext.predictionsJsonPrimed);
    const __jsonKeyExists = (()=>{ try { return localStorage.getItem('pb_previousPredictions') != null; } catch(e){ return false; } })();
    if (!__jsonPrimed && !__jsonKeyExists) {
      window.previousPredictions = prevJson;
    }
    try { _ppWireToggleOnce(); } catch(e) {}
    try { _ppEnsureRanksAndTop5PerDate(); } catch(e) {}
    try { _ppRecomputeAllMatches(); } catch(e) {}
      try { _ppEnsureIds(); } catch(e) {}
try { renderPreviousPredictionsHistoryTable(); } catch(e) {}
    window.__pbvNext = window.__pbvNext || {};
    window.__pbvNext.historicalDataLoaded = true;
          // Unlock downstream UI (same behavior as successful text-load)
          try {
            // enable core buttons
            if (typeof setButtonsEnabled === 'function') setButtonsEnabled(true);
          } catch(e) {}
          try {
            const genBtn = document.getElementById('generateNumbersBtn') || document.getElementById('generateBtn');
            if (genBtn) { genBtn.disabled = false; genBtn.removeAttribute('disabled'); genBtn.style.opacity = '1'; genBtn.style.cursor = 'pointer'; genBtn.title=''; }
          } catch(e) {}
          try {
            const meBtn = document.getElementById('manualEntryBtn');
            if (meBtn) { meBtn.disabled = false; meBtn.removeAttribute('disabled'); meBtn.style.pointerEvents='auto'; meBtn.style.opacity='1'; meBtn.title=''; }
          } catch(e) {}
          try {
            const cc = document.getElementById('controls-container');
            if (cc) cc.style.display = 'block';
          } catch(e) {}
          // Ensure core actions un-gate immediately when history is present
          try {
            if (window.__pbvNext && typeof window.__pbvNext.updateGenerateButtonState === 'function') {
              window.__pbvNext.updateGenerateButtonState();
            }
          } catch(e) {}
    // Update reproducibility metadata after load
    try { if (window.__pbvNext && typeof window.__pbvNext.updateReproMeta === 'function') window.__pbvNext.updateReproMeta(); } catch(e) {}
    // Disable bypass once real historical data is loaded (prevents accidental bypass state)
    try {
      const bypassCb = document.getElementById('bypassHistoricalData');
      if (bypassCb) {
        bypassCb.checked = false;
        bypassCb.disabled = true;
        bypassCb.title = 'Historical data loaded — bypass is no longer needed.';
      }
    } catch (e) {}
    // Recompute Generate button gating now that history is available
    try {
      if (window.__pbvNext && typeof window.__pbvNext.updateGenerateButtonState === 'function') {
        window.__pbvNext.updateGenerateButtonState();
    // v47 Validation Hooks: evaluate prior predictions for this draw date
    try { runValidationHooksForWinningNumbers(formattedDate, numbers, powerball); } catch(e){ console.warn('Validation hook call failed', e); }
      }
    } catch (e) {}
// Immediately enable Manual Entry after successful historical data load
    try {
      const meBtn = document.getElementById('manualEntryBtn');
      if (meBtn) {
        meBtn.disabled = false;
        meBtn.removeAttribute('disabled');
        meBtn.style.opacity = '1';
        meBtn.style.pointerEvents = 'auto';
        meBtn.title = '';
      }
    } catch (e) {}
    // Update the Load button subtitle (last historical date) if UI exists
    try {
      if (histJson && histJson.length) {
        const last = histJson[histJson.length - 1];
        if (last && last.date) {
          updateLoadButtonWithLastDate(last.date);
        }
      }
    } catch (e) {}
    // Set the main Draw Date picker default to the next scheduled drawing date after *today* (Mon/Wed/Sat)
// (Do NOT anchor this to the historical file's latest date.)
    try {
      const startDateInput = document.getElementById('startDate');
      if (startDateInput) {
        const now = new Date();
        const isTodayDrawDay = [1, 3, 6].includes(now.getDay());
        const next = isTodayDrawDay ? now : getNextDrawingDate(now);
        if (next && !isNaN(next)) startDateInput.value = next.toISOString().split('T')[0];
      }
    } catch (e) {}
  };
  const updateLastDrawUI = () => {
    if (!Array.isArray(window.historicalData) || window.historicalData.length === 0) return;
    const sorted = window.historicalData.slice().sort((a, b) => new Date(b.date) - new Date(a.date));
    const mostRecent = new Date(sorted[0].date);
    mostRecent.setMinutes(mostRecent.getMinutes() + mostRecent.getTimezoneOffset());
    const formatted = mostRecent.toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' });
    if (loadDataBtn) {
      loadDataBtn.innerHTML = `Load Historical Data<br><small style="font-size:12px;font-weight:bold;color:green;">Last Historical Draw Date: ${formatted}</small>`;
    }
    if (lastDrawDateText) lastDrawDateText.textContent = `Last Historical Draw Date: ${formatted}`;
  };
  try {
    setButtonsEnabled(false);
    window.__pbvNext = window.__pbvNext || {};
    window.__pbvNext.loadedFileName = window.__pbvNext.loadedFileName || "Powerball_Numbers_History.txt";
    let fileContent = '';
    let connectedRW = false;
    // Prefer File System Access API for true auto-save
    if (window.showOpenFilePicker) {
      const [handle] = await window.showOpenFilePicker({
        multiple: false,
        types: [{
          description: 'Powerball History',
          accept: { 'text/plain': ['.txt'] }
        }]
      });
      if (!handle) throw new Error('No file selected');
      const file = await handle.getFile();
      fileContent = await file.text();
      window.__pbvNext.fileHandle = handle;
      window.__pbvNext.loadedFileName = file.name || window.__pbvNext.loadedFileName;
      // v25.1: Do NOT request readwrite permission on load (it triggers a browser "Save changes" prompt).
      // Only check current permission quietly (no prompt). We'll request permission later only when the user saves/appends.
      try {
        if (handle.queryPermission) {
          const perm = await handle.queryPermission({ mode: 'readwrite' });
          connectedRW = (perm === 'granted');
        } else {
          connectedRW = false;
        }
        window.__pbvNext.autoSaveSupported = true;
      } catch (e) {
        connectedRW = false;
        window.__pbvNext.autoSaveSupported = true;
      }
    } else {
      // Fallback: classic file input (read-only)
      window.__pbvNext.autoSaveSupported = false;
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = '.txt';
      fileInput.style.display = 'none';
      document.body.appendChild(fileInput);
      const file = await new Promise((resolve) => {
        fileInput.onchange = () => resolve(fileInput.files[0]);
        fileInput.click();
      });
      document.body.removeChild(fileInput);
      if (!file) throw new Error('No file selected');
      window.__pbvNext.loadedFileName = file.name || window.__pbvNext.loadedFileName;
      fileContent = await file.text();
      window.__pbvNext.fileHandle = null;
      connectedRW = false;
    }
    parseHistoryFile(fileContent);
    // Enable downstream controls
    setButtonsEnabled(true);
    // Ensure 'Enter Recent Powerball Numbers' is enabled immediately after successful load
    (function enableManualEntryNow(){
      const meBtn = document.getElementById('manualEntryBtn');
      if (!meBtn) return;
      meBtn.disabled = false;
      meBtn.removeAttribute('disabled');
      meBtn.style.pointerEvents = 'auto';
      meBtn.style.opacity = '1';
      meBtn.title = '';
    })();
// Show slip controls
    if (controlsContainer) controlsContainer.style.display = 'block';
    if (loadFileBtn) {
      loadFileBtn.disabled = false;
      loadFileBtn.style.cursor = 'pointer';
      loadFileBtn.style.background = 'linear-gradient(145deg, #007bff, #005bb5)';
    }
    updateLastDrawUI();
    persistToLocalStorage();
    // Enhancement #7 (Stage A): After first successful text load, write authoritative Historical JSON and stop updating the text file going forward.
    try {
      if (Array.isArray(window.historicalData) && window.historicalData.length) {
        localStorage.setItem('pb_historicalDataJSON', JSON.stringify(window.historicalData));
        try { localStorage.setItem('pb_historicalData', JSON.stringify(window.historicalData)); } catch(e) {}
        try { if (typeof showToast === 'function') showToast(`Created Historical Data JSON (${window.historicalData.length} draws).`, 'success'); } catch(e) {}
        try {
          const loadBtn = document.getElementById('loadDataBtn');
          if (loadBtn) { loadBtn.disabled = true; loadBtn.style.display = 'none'; }
        } catch(e) {}
      }
    } catch(e) {}
    // v25: flash notification instead of blocking dialogs
    try { if (typeof showSuccessPopup === 'function') showSuccessPopup('✅ Historical data loaded.'); } catch (e) {}
    // Update auto-save light
    updateAutoSaveLight(connectedRW);
    // Guard: enough data for LSTM?
    if (!Array.isArray(window.historicalData) || window.historicalData.length < 10) {
      showErrorToast('Historical data is missing or too small. LSTM cannot train.');
    }
    return true;
  } catch (error) {
    console.error('Error loading data:', error);
    showErrorToast(`Error loading data: ${error.message}`);
    updateAutoSaveLight(false);
    return false;
  }
}
function predictNumbersMarkov(date, drawIndex) {
  try {
    const mainTransitionMatrix = buildTransitionMatrix(historicalData.map(d => d.numbers));
    const powerballTransitionMatrix = buildTransitionMatrix(historicalData.map(d => [d.special]));
    const lastDraw = historicalData[historicalData.length - 1].numbers;
    const predictedNumbers = new Set();
    const usedStates = new Set();
    while (predictedNumbers.size < 5) {
      const currentState = lastDraw[predictedNumbers.size] || Array.from(predictedNumbers).slice(-1)[0] || Math.floor(pbRng() * 69) + 1;
      const transitions = mainTransitionMatrix.get(currentState) || new Map();
      let nextNumber = weightedRandomSelection(transitions);
      while (predictedNumbers.has(nextNumber) || usedStates.has(nextNumber)) {
        nextNumber = weightedRandomSelection(transitions);
      }
      predictedNumbers.add(nextNumber);
      usedStates.add(nextNumber);
    }
    const lastPowerball = historicalData[historicalData.length - 1].special;
    const powerballTransitions = powerballTransitionMatrix.get(lastPowerball) || new Map();
    const powerball = weightedRandomSelection(powerballTransitions) || Math.floor(pbRng() * 26) + 1;
    return {
      numbers: Array.from(predictedNumbers).sort((a, b) => a - b),
      powerball,
      method: "Markov"
    };
  } catch (error) {
    console.error('Markov prediction error:', error);
    throw error;
  }
}
function buildTransitionMatrix(sequences) {
  const matrix = new Map();
  const decayFactor = 0.95;
  sequences.forEach((sequence, seqIndex) => {
    const weight = Math.pow(decayFactor, sequences.length - seqIndex - 1);
    for (let i = 0; i < sequence.length - 1; i++) {
      const current = sequence[i];
      const next = sequence[i + 1];
      if (!matrix.has(current)) {
        matrix.set(current, new Map());
      }
      const transitions = matrix.get(current);
      transitions.set(next, (transitions.get(next) || 0) + weight);
    }
  });
  matrix.forEach(transitions => {
    const total = Array.from(transitions.values()).reduce((a, b) => a + b, 0);
    transitions.forEach((value, key) => {
      transitions.set(key, value / total);
    });
  });
  return matrix;
}
function weightedRandomSelection(transitions) {
  if (!transitions || transitions.size === 0) return null;
  const rand = pbRng();
  let cumulativeProb = 0;
  for (const [number, probability] of transitions.entries()) {
    cumulativeProb += probability;
    if (rand <= cumulativeProb) {
      return number;
    }
  }
  return Array.from(transitions.keys())[0];
}
function getMethodWeight(method) {
  const methodWeights = {
    'Exponential': 1.2,
    'Frequency': 1.0,
    'LSTM': 1.3,
    'Monte Carlo': 1.1,    'Markov': 1.2
  };
  return methodWeights[method] || 1.0;
}
const USE_NORMALIZED_SCORING = true;
// v46: Frozen reference window for normalization
const USE_FROZEN_REFERENCE_WINDOW = true;
const FROZEN_REFERENCE_DRAWS = 260;
 // v42 Methodology: normalize scoring components via z-score
let drawingHistory = [];
// ===========================
// v47 Validation Hooks
// When winning numbers are entered, evaluate prior predictions for that draw date,
// record metrics, and persist a validation log in localStorage for export/charting.
// ===========================
const VALIDATION_LOG_STORAGE_KEY = "pb_vnext_validation_log_v1";
function __safeJsonParse(str, fallback) {
  try { return JSON.parse(str); } catch (e) { return fallback; }
}
function loadValidationLog() {
  const raw = localStorage.getItem(VALIDATION_LOG_STORAGE_KEY);
  return Array.isArray(__safeJsonParse(raw, [])) ? __safeJsonParse(raw, []) : [];
}
function saveValidationLog(log) {
  try { localStorage.setItem(VALIDATION_LOG_STORAGE_KEY, JSON.stringify(log || [])); } catch (e) { console.warn("Failed to save validation log", e); }
}
function __dateKeyFromIso(isoStr) {
  if (!isoStr) return null;
  return String(isoStr).split("T")[0];
}
function __countMainMatches(predNums, winNumsSet) {
  let c = 0;
  for (const n of predNums) if (winNumsSet.has(n)) c++;
  return c;
}
function __evaluatePredictionsForDate(dateKey, winningMainArr, winningPb) {
  const winSet = new Set((winningMainArr || []).map(n => Number(n)));
  const winPb = Number(winningPb);
  const rows = (Array.isArray(drawingHistory) ? drawingHistory : [])
    .filter(r => __dateKeyFromIso(r.drawDate) === dateKey);
  // Sort best-to-worst by normalized score (fallback to global RL, then model RL)
  const ranked = rows.slice().sort((a,b) => {
    const sa = (a.score != null ? Number(a.score) : (a.globalRelativeLikelihoodPct != null ? Number(a.globalRelativeLikelihoodPct) : -Infinity));
    const sb = (b.score != null ? Number(b.score) : (b.globalRelativeLikelihoodPct != null ? Number(b.globalRelativeLikelihoodPct) : -Infinity));
    return sb - sa;
  });
  const perMethod = {};
  let bestMain = -1, bestTotal = -1, bestPb = false, bestRow = null;
  ranked.forEach(r => {
    const predMain = (r.numbers || []).map(Number);
    const mainMatches = __countMainMatches(predMain, winSet);
    const pbMatch = (Number(r.powerball) === winPb);
    const total = mainMatches + (pbMatch ? 1 : 0);
    // global best
    if (total > bestTotal || (total === bestTotal && mainMatches > bestMain)) {
      bestTotal = total;
      bestMain = mainMatches;
      bestPb = pbMatch;
      bestRow = r;
    }
    // per-method aggregation
    const m = r.method || "unknown";
    perMethod[m] = perMethod[m] || { count: 0, bestMain: -1, bestTotal: -1, bestPb: false, avgMain: 0, avgTotal: 0 };
    perMethod[m].count += 1;
    perMethod[m].avgMain += mainMatches;
    perMethod[m].avgTotal += total;
    if (total > perMethod[m].bestTotal || (total === perMethod[m].bestTotal && mainMatches > perMethod[m].bestMain)) {
      perMethod[m].bestTotal = total;
      perMethod[m].bestMain = mainMatches;
      perMethod[m].bestPb = pbMatch;
    }
  });
  Object.keys(perMethod).forEach(m => {
    const obj = perMethod[m];
    if (obj.count > 0) {
      obj.avgMain = Number((obj.avgMain / obj.count).toFixed(3));
      obj.avgTotal = Number((obj.avgTotal / obj.count).toFixed(3));
    }
  });
  return {
    date: dateKey,
    evaluatedCount: ranked.length,
    winning: { main: (winningMainArr || []).map(Number).sort((a,b)=>a-b), powerball: winPb },
    best: bestRow ? {
      method: bestRow.method,
      numbers: (bestRow.numbers || []).map(Number).sort((a,b)=>a-b),
      powerball: Number(bestRow.powerball),
      mainMatches: bestMain,
      pbMatch: bestPb,
      totalMatches: bestTotal,
      score: (bestRow.score != null ? Number(bestRow.score) : null),
      globalRL: (bestRow.globalRelativeLikelihoodPct != null ? Number(bestRow.globalRelativeLikelihoodPct) : null),
      modelRL: (bestRow.modelRelativeLikelihoodPct != null ? Number(bestRow.modelRelativeLikelihoodPct) : null)
    } : null,
    perMethod
  };
}
// ===========================
// Enhancement #2: Play Slip -> Previous Predictions + Auto-Compare to Actuals
// - We treat each Slip Game as a "previousPredictions" record so legacy logic still works.
// - We also evaluate Slip records when winning numbers are entered (in Validation Hooks).
// ===========================
function __evaluateSlipPredictionsForDate(dateKey, winningMainArr, winningPb) {
  const winSet = new Set((winningMainArr || []).map(n => Number(n)));
  const winPb  = Number(winningPb);
  const rows = (Array.isArray(window.previousPredictions) ? window.previousPredictions : [])
    .filter(r => {
      const d = __dateKeyFromIso(r?.drawDate || r?.date);
      if (d !== dateKey) return false;
      const nums = r?.numbers;
      const pb   = (r?.powerball ?? r?.pb ?? r?.special);
      return Array.isArray(nums) && nums.length === 5 && nums.every(x => Number.isFinite(Number(x))) && Number.isFinite(Number(pb));
    });
  // Rank by any available score/probability as a weak heuristic; fallback to insertion order.
  const ranked = rows.slice().sort((a,b) => {
    const sa = (a.score != null ? Number(a.score) : (a.probability != null ? Number(a.probability) : -Infinity));
    const sb = (b.score != null ? Number(b.score) : (b.probability != null ? Number(b.probability) : -Infinity));
    return sb - sa;
  });
  let bestMain = -1, bestTotal = -1, bestPb = false, bestRow = null;
  ranked.forEach(r => {
    const predMain = (r.numbers || []).map(Number);
    const mainMatches = __countMainMatches(predMain, winSet);
    const pbMatch = (Number((r.powerball ?? r.pb ?? r.special)) === winPb);
    const total = mainMatches + (pbMatch ? 1 : 0);
    if (total > bestTotal || (total === bestTotal && mainMatches > bestMain)) {
      bestTotal = total;
      bestMain = mainMatches;
      bestPb = pbMatch;
      bestRow = r;
    }
  });
  return {
    date: dateKey,
    evaluatedCount: ranked.length,
    best: bestRow ? {
      source: bestRow.source || bestRow.type || "Play Slip",
      slipId: bestRow.slipId || null,
      gameIndex: (bestRow.gameIndex != null ? Number(bestRow.gameIndex) : null),
      numbers: (bestRow.numbers || []).map(Number).sort((a,b)=>a-b),
      powerball: Number(bestRow.powerball),
      mainMatches: bestMain,
      pbMatch: bestPb,
      totalMatches: bestTotal,
      matchCategory: (typeof _ppClassifyMatch === "function" ? _ppClassifyMatch(bestMain, bestPb) : null)
    } : null
  };
}
function runValidationHooksForWinningNumbers(dateKey, winningMainArr, winningPb) {
  try {
    const record = __evaluatePredictionsForDate(dateKey, winningMainArr, winningPb);
    // Enhancement #2: also evaluate Play Slip (previousPredictions) for this date
    const slipEval = __evaluateSlipPredictionsForDate(dateKey, winningMainArr, winningPb);
    record.slip = slipEval;
    // Always persist, even if there are no predictions yet (useful audit trail)
    const log = loadValidationLog();
    // De-dup by date (replace existing record for that date)
    const idx = log.findIndex(r => r && r.date === dateKey);
    if (idx >= 0) log[idx] = record;
    else log.unshift(record);
    saveValidationLog(log);
    // Update Previous Predictions matches now that actuals exist
    try { _ppRecomputeAllMatches(); } catch(e) {}
    try { renderPreviousPredictionsHistoryTable(); } catch(e) {}
    try { if (typeof renderPreviousPredictionsMiniTable === 'function') renderPreviousPredictionsMiniTable(dateKey); } catch(e) {}
    // User feedback (non-blocking)
    if (!record.evaluatedCount) {
      showSuccessPopup(`✅ Winning numbers saved. Validation: no predictions found for ${dateKey}.${(slipEval?.evaluatedCount ? ` Slip best = ${slipEval.best?.mainMatches ?? 0} main${slipEval.best?.pbMatch ? ' + PB' : ''}.` : '')}`);
    } else if (record.best) {
      showSuccessPopup(`✅ Validation (${dateKey}): Best hit = ${record.best.mainMatches} main${record.best.pbMatch ? ' + PB' : ''} (Method: ${record.best.method}).${(slipEval?.evaluatedCount ? ` Slip best = ${slipEval.best?.mainMatches ?? 0} main${slipEval.best?.pbMatch ? ' + PB' : ''}.` : '')}`);
    } else {
      showSuccessPopup(`✅ Validation (${dateKey}): completed.${(slipEval?.evaluatedCount ? ` Slip best = ${slipEval.best?.mainMatches ?? 0} main${slipEval.best?.pbMatch ? ' + PB' : ''}.` : '')}`);
    }
    return record;
  } catch (e) {
    console.warn("Validation hooks failed", e);
    return null;
  }
}
// ---------- Explainability (v30) ----------
function buildDecayedFrequencyMaps(decayFactor = 0.95) {
  const main = new Map();
  const pb = new Map();
  if (!Array.isArray(historicalData) || !historicalData.length) return { main, pb, decayFactor };
  historicalData.forEach((draw, index) => {
    const ageWeight = Math.pow(decayFactor, historicalData.length - index - 1);
    (draw.numbers || []).forEach(n => main.set(n, (main.get(n) || 0) + ageWeight));
    if (Number.isFinite((draw.powerball ?? draw.pb ?? draw.special))) pb.set((draw.powerball ?? draw.pb ?? draw.special), (pb.get((draw.powerball ?? draw.pb ?? draw.special)) || 0) + ageWeight);
  });
  return { main, pb, decayFactor };
}
function rankFromSorted(sortedEntries, n) {
  const idx = sortedEntries.findIndex(e => e[0] === n);
  return idx >= 0 ? idx + 1 : null;
}
function formatScore(x) {
  if (!Number.isFinite(x)) return "—";
  const abs = Math.abs(x);
  if (abs >= 1000) return x.toFixed(0);
  if (abs >= 100) return x.toFixed(1);
  return x.toFixed(3);
}
function renderExplainability(entry, drawDate) {
  const panel = document.getElementById('explainabilityDynamic');
  if (!panel) return;
  const dateStr = drawDate ? formatDate(drawDate) : (entry?.drawDate ? formatDate(new Date(entry.drawDate)) : "");
  const method = entry?.method || "—";
  // Prefer method-provided explain data; otherwise compute a useful fallback from decayed frequencies
  let explain = entry?.explain || null;
  if (!explain) {
    const maps = buildDecayedFrequencyMaps(0.95);
    const mainSorted = Array.from(maps.main.entries()).sort((a,b)=>b[1]-a[1]);
    const pbSorted = Array.from(maps.pb.entries()).sort((a,b)=>b[1]-a[1]);
    const chosenMain = (entry?.numbers || []).map(n => ({
      n,
      score: maps.main.get(n) || 0,
      rank: rankFromSorted(mainSorted, n),
      driver: "Decayed frequency (fallback)"
    })).sort((a,b)=>a.n-b.n);
    const chosenPB = entry?.powerball ? {
      n: entry.powerball,
      score: maps.pb.get(entry.powerball) || 0,
      rank: rankFromSorted(pbSorted, entry.powerball),
      driver: "Decayed frequency (fallback)"
    } : null;
    explain = {
      chosenMain,
      chosenPB,
      topMain: mainSorted.slice(0, 10).map(([n,score],i)=>({ n, score, rank:i+1 })),
      topPB: pbSorted.slice(0, 10).map(([n,score],i)=>({ n, score, rank:i+1 })),
      note: "Tip: Click a generated game or a Drawing History row to refresh this breakdown."
    };
  }
  const chosenMain = explain.chosenMain || [];
  const chosenPB = explain.chosenPB || null;
  const topMain = explain.topMain || [];
  const topPB = explain.topPB || [];
  const note = explain.note || "";
  // Confidence badge based on probability, if present
  let prob = null;
  if (entry?.probability != null && entry?.probability !== "") {
    const p = parseFloat(entry.probability);
    prob = isFinite(p) ? p : null;
  }
  const confClass = prob == null ? "badge-note" : (prob >= 60 ? "badge-ok" : (prob >= 35 ? "badge-mid" : "badge-low"));
  const confLabel = prob == null ? "Confidence" : (prob >= 60 ? "High Confidence" : (prob >= 35 ? "Moderate Confidence" : "Low Confidence"));
  const maxScore = Math.max(
    0.000001,
    ...chosenMain.map(x => (x.score ?? x.weight ?? 0)),
    (chosenPB ? (chosenPB.score ?? chosenPB.weight ?? 0) : 0)
  );
  const barPct = (v) => {
    const n = (v ?? 0);
    const pct = Math.max(0, Math.min(100, (n / maxScore) * 100));
    return pct.toFixed(1);
  };
  const chosenMainHtml = chosenMain.length
    ? `<ul class="explain-list">
        ${chosenMain.map(x => `
          <li>
            <div class="explain-item">
              <div class="ex-num" title="Number">${x.n}</div>
              <div class="ex-meta">
                <div><b>Rank:</b> ${x.rank ?? "—"} <span class="explain-muted" title="Primary signal / rationale">• ${x.driver || "Signal"}</span></div>
              </div>
              <div class="ex-score" title="Score/weight used by the engine">${formatScore(x.score ?? x.weight)}</div>
              <div class="ex-bar" title="Relative score strength for this selection"><div style="width:${barPct(x.score ?? x.weight)}%"></div></div>
            </div>
          </li>
        `).join('')}
      </ul>`
    : `<div class="explain-muted">No main-number details available.</div>`;
  const chosenPbHtml = (chosenPB && chosenPB.n)
    ? `<div class="explain-item" style="margin-top:6px;">
        <div class="ex-num" title="Powerball">${chosenPB.n}</div>
        <div class="ex-meta">
          <div><b>Rank:</b> ${chosenPB.rank ?? "—"} <span class="explain-muted" title="Primary signal / rationale">• ${chosenPB.driver || "Signal"}</span></div>
        </div>
        <div class="ex-score" title="Score/weight used by the engine">${formatScore(chosenPB.score ?? chosenPB.weight)}</div>
        <div class="ex-bar" title="Relative score strength for this selection"><div style="width:${barPct(chosenPB.score ?? chosenPB.weight)}%"></div></div>
      </div>`
    : `<div class="explain-muted">No powerball details available.</div>`;
  const topMainHtml = topMain.length
    ? topMain.slice(0, 10).map(x => `<span class="explain-pill" title="Rank ${x.rank} • score ${formatScore(x.score ?? x.weight)}">#${x.n} (r${x.rank})</span>`).join('')
    : `<span class="explain-muted">—</span>`;
  const topPbHtml = topPB.length
    ? topPB.slice(0, 10).map(x => `<span class="explain-pill" title="Rank ${x.rank} • score ${formatScore(x.score ?? x.weight)}">#${x.n} (r${x.rank})</span>`).join('')
    : `<span class="explain-muted">—</span>`;
  panel.innerHTML = `
    <div class="explain-wrap">
      <div class="explain-card card-accent-green">
        <div class="card-h">
          <span>Top Drivers</span>
          <span class="badge badge-note" title="Click any generated game or Drawing History row to switch context">Interactive</span>
        </div>
        <div class="card-b">
          ${chosenMainHtml}
          <div style="margin-top:10px;">
            <div class="explain-muted" style="font-weight:800; color:#111827; margin-bottom:6px;">Powerball</div>
            ${chosenPbHtml}
          </div>
        </div>
      </div>
      <div style="display:grid; gap:12px;">
        <div class="explain-card card-accent-blue">
          <div class="card-h">
            <span>Prediction Summary</span>
            <span class="badge badge-method" title="Prediction engine used">Engine: <small>${method}</small></span>
          </div>
          <div class="card-b">
            <div class="badge-row">
              <span class="badge ${confClass}" title="Score + Run Likelihood % are normalized within this run’s candidate pool; they are not absolute lottery odds.">${confLabel}${prob == null ? "" : ` • ${prob.toFixed(2)}%`}</span>
              ${dateStr ? `<span class="badge" title="Selected draw date">Draw Date: <small>${dateStr}</small></span>` : ``}
            </div>
            <div style="margin-top:10px;">
              <div class="explain-kv" title="This value is the ticket probability output from the scoring layer (not jackpot odds)">
                <div class="k">Relative Likelihood</div>
                <div class="v">${prob == null ? "—" : `<b>${prob.toFixed(2)}%</b>`}</div>
              </div>
              <div class="explain-kv" title="How the engine ranked and weighted candidates">
                <div class="k">Scoring Basis</div>
                <div class="v">${(explain?.basis || explain?.noteBasis || "").toString().slice(0, 32) || "Ranks + weights"}</div>
              </div>
            </div>
          </div>
        </div>
        <div class="explain-card card-accent-amber">
          <div class="card-h">
            <span>Historical Signals</span>
            <span class="badge" title="Most influential numbers according to historical weighting">Top 10</span>
          </div>
          <div class="card-b">
            <div class="explain-muted" style="font-weight:800; color:#111827; margin-bottom:6px;" title="Top 10 main numbers by the engine's weighting">Main Numbers</div>
            <div>${topMainHtml}</div>
            <div class="explain-muted" style="font-weight:800; color:#111827; margin:10px 0 6px 0;" title="Top 10 powerballs by the engine's weighting">Powerball</div>
            <div>${topPbHtml}</div>
          </div>
        </div>
        ${note ? `
          <div class="explain-card card-accent-purple">
            <div class="card-h">
              <span>Notes</span>
              <span class="badge badge-note" title="Helpful context">Tip</span>
            </div>
            <div class="card-b">
              <div class="explain-clickhint">${note}</div>
            </div>
          </div>` : ``}
      </div>
    </div>
  `;
}
// ------------------------------------------
function addToDrawingHistory(prediction, drawDate) {
  const validNumbers = prediction.numbers.every(n => n >= 1 && n <= 69);
  const validPowerball = prediction.powerball >= 1 && prediction.powerball <= 26;
  const uniqueNumbers = new Set(prediction.numbers).size === 5;
  if (!validNumbers || !validPowerball || !uniqueNumbers) {
    console.error('Invalid prediction numbers detected');
    return;
  }
  const dupIndex = drawingHistory.findIndex(entry =>
    entry.drawDate === drawDate.toISOString() && entry.method === prediction.method
  );
  if (dupIndex !== -1) {
    // Overwrite behavior: last run wins for same draw date + method.
    drawingHistory.splice(dupIndex, 1);
  }
  drawingHistory.unshift({
    method: prediction.method,
    drawDate: drawDate.toISOString(),
    numbers: [...prediction.numbers].sort((a, b) => a - b),
    powerball: prediction.powerball,
    score: (prediction.score != null ? Number(prediction.score) : Number(calculateProbability(prediction.numbers, prediction.powerball, prediction.method))),
    // Dual RL% (Percentile Rank):
    // - modelRelativeLikelihoodPct: within the model/method group
    // - globalRelativeLikelihoodPct: across all generated games in that run
    modelRelativeLikelihoodPct: (prediction.modelRelativeLikelihoodPct != null ? Number(prediction.modelRelativeLikelihoodPct) : null),
    globalRelativeLikelihoodPct: (prediction.globalRelativeLikelihoodPct != null ? Number(prediction.globalRelativeLikelihoodPct) : (prediction.relativeLikelihoodPct != null ? Number(prediction.relativeLikelihoodPct) : null)),
    // Backward-compat column used in several UI/export paths; keep as GLOBAL RUN LIKELIHOOD %
    probability: (prediction.globalRelativeLikelihoodPct != null ? Number(prediction.globalRelativeLikelihoodPct) : (prediction.probability != null ? Number(prediction.probability) : Number(calculateProbability(prediction.numbers, prediction.powerball, prediction.method)))),
    explain: prediction.explain || null
  });
  // Recompute Dual RL% for this draw date so Global Run Likelihood % is consistent across runs
  recomputeHistoryRLForDate(drawDate.toISOString());
}
/* --- Dual RL% reconciliation for Drawing History (cross-run) ---
   When you generate predictions in separate runs (e.g., click Generate under Frequency, then under Exponential),
   each run computes Global Run Likelihood % within its own mini-pool. This function recomputes:
   - Global Run Likelihood % across ALL history entries for the SAME draw date
   - Model Run Likelihood % within each method for that draw date
   so you never see multiple 100% Global Run Likelihood % for the same draw date unless scores truly tie.
*/
function recomputeHistoryRLForDate(drawDateISO, topK = 50) {
  try {
    if (!drawDateISO) return;
    const group = drawingHistory.filter(e => e.drawDate === drawDateISO);
    if (!group.length) return;
    const drawDateObj = new Date(drawDateISO);
    // --- Helper: stable numeric score (higher is better) ---
    function _scoreOf(numbers, powerball, method) {
      // calculateProbability returns a "pct string" (0..100). Use it as the comparable score.
      const s = Number(calculateProbability(numbers, powerball, method));
      if (Number.isFinite(s)) return s;
      try {
        const comp = computeScoreComponents(numbers, powerball, method);
        return Number(comp.rawPct) || 0;
      } catch (_) {
        return 0;
      }
    }
    // --- Helper: generate a candidate for a given method ---
    function _genOne(methodName) {
      const m = (methodName || '').toString().toLowerCase();
      try {
        if (m.includes('frequency')) return predictNumbersFrequency(drawDateObj, 0);
        if (m.includes('exponential')) return predictNumbersExponential(drawDateObj, 0);
        if (m.includes('monte')) return predictNumbersMonteCarlo(drawDateObj, 0);
        if (m.includes('markov')) return predictNumbersMarkov(drawDateObj, 0);
// LSTM is async/heavy; skip pool generation and rely on history-only if used
        if (m.includes('lstm')) return null;
      } catch (e) {}
      return null;
    }
    // Cache pools per draw-date + method to avoid regenerating repeatedly
    window.__rlScorePools = window.__rlScorePools || {};
    function _poolKey(methodName) {
      return `${drawDateISO}||${methodName}||${topK}`;
    }
    function _getOrBuildPoolScores(methodName) {
      const key = _poolKey(methodName);
      if (Array.isArray(window.__rlScorePools[key]) && window.__rlScorePools[key].length) {
        return window.__rlScorePools[key];
      }
      const scores = [];
      for (let i = 0; i < topK; i++) {
        const pred = _genOne(methodName);
        if (!pred || !Array.isArray(pred.numbers) || pred.numbers.length !== 5) continue;
        const pb = Number(pred.powerball);
        scores.push(_scoreOf(pred.numbers, pb, methodName));
      }
      // Fallback: at minimum include existing history scores for that method
      if (!scores.length) {
        group.filter(e => (e.method || '') === methodName).forEach(e => {
          scores.push(_scoreOf(e.numbers, e.powerball, methodName));
        });
      }
      window.__rlScorePools[key] = scores;
      return scores;
    }
    // Ensure each history entry has numeric score
    group.forEach(e => {
      e.score = _scoreOf(e.numbers, e.powerball, e.method);
    });
    // -------------------------
    // GLOBAL RUN LIKELIHOOD % (draw-date scope) vs Top-K pool per method
    // -------------------------
    const methods = Array.from(new Set(group.map(e => (e.method || 'Unknown').toString())));
    // -------------------------
    // METHOD AGREEMENT SUPPORT (cross-method) based on Top-K ticket pools
    // -------------------------
    window.__rlTicketPools = window.__rlTicketPools || {};
    function _getOrBuildPoolTickets(methodName) {
      const key = `${drawDateISO}::${methodName}`;
      if (window.__rlTicketPools[key]) return window.__rlTicketPools[key];
      const tickets = [];
      for (let i = 0; i < topK; i++) {
        const pred = _genOne(methodName);
        if (!pred || !Array.isArray(pred.numbers) || pred.numbers.length !== 5) continue;
        const pb = Number(pred.powerball);
        tickets.push({ numbers: pred.numbers.slice(), powerball: pb });
      }
      // Fallback: include existing history entries for that method
      if (!tickets.length) {
        group.filter(e => (e.method || '') === methodName).forEach(e => {
          tickets.push({ numbers: (e.numbers || []).slice(), powerball: Number(e.powerball) });
        });
      }
      window.__rlTicketPools[key] = tickets;
      return tickets;
    }
    // Build cross-method support: average per-method frequency in its pool (0..1)
    const __mainSupport = {};
    const __pbSupport = {};
    methods.forEach(mName => {
      const pool = _getOrBuildPoolTickets(mName);
      const denom = Math.max(pool.length, 1);
      const countsMain = {};
      const countsPB = {};
      pool.forEach(t => {
        (t.numbers || []).forEach(n => { countsMain[n] = (countsMain[n] || 0) + 1; });
        const pb = Number(t.powerball);
        if (Number.isFinite(pb)) countsPB[pb] = (countsPB[pb] || 0) + 1;
      });
      // Convert to per-method support probability and accumulate
      for (let n = 1; n <= 69; n++) {
        const p = (countsMain[n] || 0) / denom; // 0..1 within this method pool
        __mainSupport[n] = (__mainSupport[n] || 0) + p;
      }
      for (let pb = 1; pb <= 26; pb++) {
        const p = (countsPB[pb] || 0) / denom;
        __pbSupport[pb] = (__pbSupport[pb] || 0) + p;
      }
    });
    const __methodsCount = methods.length;
    if (__methodsCount >= 2) {
      for (let n = 1; n <= 69; n++) __mainSupport[n] = (__mainSupport[n] || 0) / __methodsCount;
      for (let pb = 1; pb <= 26; pb++) __pbSupport[pb] = (__pbSupport[pb] || 0) / __methodsCount;
      window.__currentAgreementSupport = { methodsCount: __methodsCount, mainSupport: __mainSupport, pbSupport: __pbSupport, drawDateISO };
    } else {
      window.__currentAgreementSupport = null;
    }
    const globalObjs = [];
    // Add pool samples
    methods.forEach(methodName => {
      const poolScores = _getOrBuildPoolScores(methodName);
      poolScores.forEach(s => globalObjs.push({ score: Number(s) || 0, __pool: true }));
    });
    // Add the actual history entries (so they are ranked against the pool)
    group.forEach(e => {
      globalObjs.push({ score: Number(e.score) || 0, __entry: e });
    });
    assignRelativeLikelihoodPercent(globalObjs, 'score', { outKey: '__rl', setProbability: false });
    globalObjs.forEach(o => {
      if (o.__entry) {
        o.__entry.globalRelativeLikelihoodPct = Number(o.__rl ?? 0);
        o.__entry.probability = Number(o.__entry.globalRelativeLikelihoodPct ?? 0);
      }
    });
    // -------------------------
    // MODEL RL% (within-method) vs that method's Top-K pool
    // -------------------------
    methods.forEach(methodName => {
      const poolScores = _getOrBuildPoolScores(methodName);
      const methodObjs = [];
      poolScores.forEach(s => methodObjs.push({ score: Number(s) || 0, __pool: true }));
      const entries = group.filter(e => (e.method || 'Unknown').toString() === methodName);
      entries.forEach(e => methodObjs.push({ score: Number(e.score) || 0, __entry: e }));
      assignRelativeLikelihoodPercent(methodObjs, 'score', { outKey: '__mrl', setProbability: false });
      methodObjs.forEach(o => {
        if (o.__entry) o.__entry.modelRelativeLikelihoodPct = Number(o.__mrl ?? 0);
      });
    });
    // Update Stability Index display (if present)
    try { if (window.__pbvNext && typeof window.__pbvNext.updateStabilityMeta === 'function') window.__pbvNext.updateStabilityMeta(drawDateISO); } catch(_){ }
  } catch (err) {
    console.warn('recomputeHistoryRLForDate failed:', err);
  }
}
document.addEventListener('DOMContentLoaded', function () {
  const table = document.querySelector('.drawing-history');
  if (!table) return;
  const headers = table.querySelectorAll('th[data-sort]');
  headers.forEach(header => {
    header.addEventListener('click', () => {
      const sortKey = header.dataset.sort;
      const isAscending = header.classList.contains('sort-asc');
      headers.forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
      header.classList.add(isAscending ? 'sort-desc' : 'sort-asc');
      sortHistory(sortKey, !isAscending);
    });
  });
});
function sortHistory(key, ascending) {
  drawingHistory.sort((a, b) => {
    let compareA = a[key];
    let compareB = b[key];
    if (key === 'date') {
      compareA = new Date(a.drawDate);
      compareB = new Date(b.drawDate);
    } else if (key === 'numbers') {
      compareA = a.numbers.join('');
      compareB = b.numbers.join('');
    } else if (key === 'modelRL') {
      compareA = Number(a.modelRelativeLikelihoodPct ?? 0);
      compareB = Number(b.modelRelativeLikelihoodPct ?? 0);
    } else if (key === 'globalRL') {
      compareA = Number(a.globalRelativeLikelihoodPct ?? a.probability ?? 0);
      compareB = Number(b.globalRelativeLikelihoodPct ?? b.probability ?? 0);
    } else if (key === 'probability') {
      compareA = Number(a.globalRelativeLikelihoodPct ?? a.probability ?? 0);
      compareB = Number(b.globalRelativeLikelihoodPct ?? b.probability ?? 0);
    }
    if (compareA < compareB) return ascending ? -1 : 1;
    if (compareA > compareB) return ascending ? 1 : -1;
    return 0;
  });
  updateHistoryTable();
}
function updateHistoryTable() {
    const tbody = document.getElementById('historyTableBody');
    if (!tbody) return;
    tbody.innerHTML = '';
    drawingHistory.sort((a, b) => new Date(a.drawDate) - new Date(b.drawDate));
    const maxProbability = Math.max(...drawingHistory.map(entry => parseFloat(entry.globalRelativeLikelihoodPct ?? entry.probability ?? 0)));
    // Global TOP-5 by Global Run Likelihood (%) (fallback to probability)
    const _top5Sorted = drawingHistory
        .slice()
        .sort((a, b) => (parseFloat(b.globalRelativeLikelihoodPct ?? b.probability ?? 0) - parseFloat(a.globalRelativeLikelihoodPct ?? a.probability ?? 0)))
        .slice(0, 5);
    const _top5Rank = new Map();
    _top5Sorted.forEach((e, idx) => _top5Rank.set(e, idx + 1));
    let highestProbabilityEntry = null;
    const numberFrequency = new Map();
    const powerballFrequency = new Map();
    drawingHistory.forEach(entry => {
        entry.numbers.forEach(num => {
            numberFrequency.set(num, (numberFrequency.get(num) || 0) + 1);
        });
        powerballFrequency.set(entry.powerball, (powerballFrequency.get(entry.powerball) || 0) + 1);
        if (parseFloat(entry.globalRelativeLikelihoodPct ?? entry.probability ?? 0) === maxProbability) {
            highestProbabilityEntry = entry;
        }
    });
    const uniqueMethods = new Set();
    drawingHistory.forEach(entry => {
        const row = document.createElement('tr');
        const tooltipText = `5 Numbers: ${entry.numbers.join(', ')} | Powerball: ${entry.powerball}`;
        row.setAttribute('data-tooltip', tooltipText);
        if (parseFloat(entry.globalRelativeLikelihoodPct ?? entry.probability ?? 0) === maxProbability) {
            row.classList.add('highest-probability');
        }
        const formattedDate = new Date(entry.drawDate).toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
        });
        const formattedNumbers = entry.numbers.map((num, index) => {
            const isDuplicate = numberFrequency.get(num) > 1;
            return `<span class="number-cell${isDuplicate ? ' duplicate-number' : ''}">${num}${index < entry.numbers.length - 1 ? ', ' : ''}</span>`;
        }).join('');
        const isPowerballDuplicate = powerballFrequency.get(entry.powerball) > 1;
        const powerballClass = isPowerballDuplicate ? 'duplicate-number' : 'powerball-number';
        const _rank = _top5Rank.get(entry) || null;
        if (_rank) {
            row.classList.add('top5-row');
            row.classList.add('top-rank-' + _rank);
        }
        const _badge = _rank ? `<span class="top-badge">TOP ${_rank}</span>` : '';
        row.innerHTML = `
            <td>${_badge} ${entry.method}</td>
            <td>${formattedDate}</td>
            <td>${formattedNumbers}</td>
            <td class="${powerballClass}">${entry.powerball}</td>
            <td>${Number(entry.modelRelativeLikelihoodPct ?? 0).toFixed(2)}%</td>
            <td>${Number(entry.globalRelativeLikelihoodPct ?? entry.probability ?? 0).toFixed(2)}%</td>
        `;
        row.style.cursor = "pointer";
        row.title = "Click to view explainability";
        row.addEventListener("click", () => { try { renderExplainability(entry, new Date(entry.drawDate)); } catch(e){} });
        uniqueMethods.add(entry.method);
        tbody.appendChild(row);
    });
    updateDuplicatesTable();
    // Ensure "Family Numbers" rows are visible in Drawing History whenever the table re-renders.
    // (Direct DOM insertion can be overwritten by updateHistoryTable; this call re-applies it safely.)
    try { if (window.__pbvNext && typeof window.__pbvNext.ensureFamilyRows === 'function') window.__pbvNext.ensureFamilyRows(); } catch(e) {}
    try { ensureSlipButtonsEnabled(); } catch(e) {}
}
function updateDuplicatesTable() {
    const minGames = 3;
    const duplicatesContainer = document.querySelector('.duplicates-table-container');
    const tbody = document.getElementById('duplicatesTableBody');
    if (!tbody) return;
    const numberFrequency = new Map();
    const powerballMap = new Map();
    drawingHistory.forEach(({ numbers, powerball }) => {
        numbers.forEach(num => {
            numberFrequency.set(num, (numberFrequency.get(num) || 0) + 1);
        });
        powerballMap.set(powerball, (powerballMap.get(powerball) || 0) + 1);
    });
    duplicatesContainer.style.display = drawingHistory.length >= minGames ? 'block' : 'none';
    tbody.innerHTML = '';
    const topNumbers = Array.from(numberFrequency.entries())
        .sort((a, b) => b[1] - a[1] || a[0] - b[0])
        .slice(0, 5)
        .sort((a, b) => a[0] - b[0]);
    const topPowerballs = Array.from(powerballMap.entries()).sort((a, b) => {
        if (b[1] === a[1]) {
            const aDraw = drawingHistory.find(d => d.powerball === a[0]);
            const bDraw = drawingHistory.find(d => d.powerball === b[0]);
            return (bDraw?.probability || 0) - (aDraw?.probability || 0);
        }
        return b[1] - a[1];
    });
    const [pbNumber, pbCount] = topPowerballs[0] || [0, 0];
    const topNumbersFormatted = topNumbers.map(([num, count]) => num);
    const duplicateProbability = calculateProbability(topNumbersFormatted, pbNumber, 'Top Duplicates');
    const row = document.createElement('tr');
    const numbersFormatted = topNumbers.map(([num, count]) =>
        `<span class="duplicate-number">${num}</span> (${count})`
    ).join(', ');
    row.innerHTML = `
        <td>${numbersFormatted}</td>
        <td><span class="powerball-highlight">${pbNumber}</span> (${pbCount})</td>
        <td>${duplicateProbability}%</td>
        <td>${topNumbers.reduce((sum, [, count]) => sum + count, 0)}</td>
    `;
    tbody.appendChild(row);
}
async function hybridPrediction(drawDate, drawIndex) {
  const predictionMethods = {
    'exponential': () => ({
      ...predictNumbersExponential(drawDate, drawIndex),
      method: "Exponential"
    }),
    'frequency': () => ({
      ...predictNumbersFrequency(drawDate, drawIndex),
      method: "Frequency"
    }),
    'lstm': async () => {
      // Safety: ensure TFJS is present and model is trained (training is staged before draws)
      if (!window.tf) await ensureTFJSLoaded();
      if (!model?.isTrained) await trainModel(historicalData);
      const sequence = getHistoricalSequence(drawDate, drawIndex);
      return {
        ...(await predictNumbersLSTM(sequence, drawIndex)),
        method: "LSTM"
      };
    },
    'monteCarlo': async () => ({
      ...(await predictNumbersMonteCarlo(drawDate, drawIndex)),
      method: "Monte Carlo"
    }),
    'markov': () => ({
      ...predictNumbersMarkov(drawDate, drawIndex),
      method: "Markov"
    })};
  const selectedMethod = document.querySelector('input[name="predictionMethod"]:checked').value;
  try {
    return await (predictionMethods[selectedMethod] || predictionMethods.frequency)();
  } catch (error) {
    console.error(`${selectedMethod} prediction error:`, error);
    // IMPORTANT: do NOT silently fallback when LSTM is selected (this was previously fixed in v29).
    // If LSTM fails, bubble the error so the UI can report it clearly.
    if (selectedMethod === "lstm") {
      throw error;
    }
    // For non-LSTM methods, keep a safe fallback to Frequency.
    return {
      ...predictNumbersFrequency(drawDate, drawIndex),
      method: "Frequency (Fallback)"
    };
  }
}
async function trainModel(historicalData) {
  // Guard: never train twice at the same time
  window.__pbvNext = window.__pbvNext || {};
  if (window.__pbvNext.lstmTrainingPromise) return window.__pbvNext.lstmTrainingPromise;
  if (model?.isTrained) return model;
  const trainingProgressWrapper = document.getElementById('trainingProgressWrapper');
  const trainingProgress = document.getElementById('trainingProgress');
  const trainingProgressLabel = document.getElementById('trainingProgressLabel');
  const nextFrame = () => new Promise(r => requestAnimationFrame(() => r()));
  window.__pbvNext.lstmTrainingPromise = (async () => {
    trainingProgressWrapper.style.display = 'flex';
    trainingProgress.value = 0;
    trainingProgressLabel.textContent = `Training Model...0%`;
    await nextFrame();
    try {
      const sequences = [];
      const labels = [];
      const sequenceLength = LSTM_SEQUENCE_LEN;
      // Build training tensors (yield periodically so UI does not freeze)
      for (let i = 0; i < historicalData.length - sequenceLength; i++) {
        const sequence = [];
        for (let j = 0; j < sequenceLength; j++) {
          const draw = historicalData[i + j];
          if (!Array.isArray(draw?.numbers) || draw.numbers.length !== 5 || !Number.isFinite((draw.powerball ?? draw.pb ?? draw.special))) { sequence.length = 0; break; }
          sequence.push([ ...draw.numbers, (draw.powerball ?? draw.pb ?? draw.special) ]);
        }
        if (sequence.length !== sequenceLength) continue;
        const nextDraw = historicalData[i + sequenceLength];
        if (!Array.isArray(nextDraw?.numbers) || nextDraw.numbers.length !== 5 || !Number.isFinite((nextDraw.powerball ?? nextDraw.pb ?? nextDraw.special))) continue;
        const label = [ ...nextDraw.numbers, (nextDraw.powerball ?? nextDraw.pb ?? nextDraw.special) ];
        sequences.push(sequence);
        labels.push(label);
        if (i % 25 === 0) await nextFrame();
      }
            if (!sequences.length) {
        throw new Error('No valid training sequences after validation');
      }
const xs = tf.tensor3d(sequences);
      const ys = tf.tensor2d(labels);
      model = tf.sequential();
      model.add(tf.layers.lstm({
        units: 128,
        inputShape: [sequenceLength, 6],
        returnSequences: false
      }));
      model.add(tf.layers.dense({ units: 64, activation: 'relu' }));
      model.add(tf.layers.dropout(0.2));
      model.add(tf.layers.dense({ units: 6 }));
      model.compile({ optimizer: 'adam', loss: 'meanSquaredError' });
      const totalEpochs = 50;
      for (let epoch = 0; epoch < totalEpochs; epoch++) {
        const progress = (epoch + 1) / totalEpochs * 100;
        trainingProgress.value = progress;
        trainingProgressLabel.textContent = `Training Model...${Math.round(progress)}%`;
        // Train a single epoch to keep UI responsive
        await model.fit(xs, ys, { epochs: 1, batchSize: 32, shuffle: true });
        // yield to allow repaint (critical)
        await nextFrame();
      }
      model.isTrained = true;
      return model;
    } catch (error) {
      console.error('Error training model:', error);
      throw error;
    } finally {
      trainingProgressWrapper.style.display = 'none';
      window.__pbvNext.lstmTrainingPromise = null;
    }
  })();
  return window.__pbvNext.lstmTrainingPromise;
}
function getHistoricalSequence(date, drawIndex) {
  const L = LSTM_SEQUENCE_LEN;
  const src = Array.isArray(historicalData) ? historicalData : [];
  const valid = src.filter(d => {
    if (!d) return false;
    if (!Array.isArray(d.numbers) || d.numbers.length !== 5) return false;
    const pb = (d.powerball ?? d.pb ?? d.special);
    return Number.isFinite(pb);
  });
  if (valid.length === 0) return [];
  if (valid.length >= L) return valid.slice(-L);
  // Pad (left) with earliest valid draw to reach required length
  const pad = [];
  while (pad.length + valid.length < L) pad.push(valid[0]);
  return pad.concat(valid);
}
window.addEventListener("message", function (event) {
    if (!event.data) return;
    const params = new URLSearchParams(event.data);
    let editedGames = [];
    for (let i = 1; i <= 5; i++) {
        let numbers = params.get(`editedGame${i}_numbers`) ? params.get(`editedGame${i}_numbers`).split(",").map(Number) : [];
        let powerball = params.get(`editedGame${i}_powerball`) ? Number(params.get(`editedGame${i}_powerball`)) : null;
        if (numbers.length === 5 && powerball) {
            editedGames.push({ numbers, powerball });
        }
    }
    if (editedGames.length > 0) {
        updateDrawDisplay(editedGames);
    }
});
function updateDrawDisplay(games) {
    const drawContainers = document.querySelectorAll("#drawsContainer .draw-container");
    games.forEach((game, index) => {
        if (drawContainers[index]) {
            drawContainers[index].querySelector(".ball-container").innerHTML =
                game.numbers.map(num => `<div class="ball">${num}</div>`).join('') +
                `<div class="ball powerball">${game.powerball}</div>`;
        }
    });
    showErrorToast("Edited numbers updated successfully!");
}
document.addEventListener('DOMContentLoaded', () => {
  // ── Grab your controls ──
  const controlsContainer    = document.getElementById('controls-container');
  const loadFileBtn          = document.getElementById('load-file-btn');
  const fileInput            = document.getElementById('pdf-upload');
  const generateSlipButton   = document.getElementById('generate-slip');
// v80 hardening: ensure slip buttons stay enabled even after table re-renders
function ensureSlipButtonsEnabled() {
  const lb = document.getElementById('load-file-btn');
  const gb = document.getElementById('generate-slip');
  if (lb) {
    lb.disabled = false;
    lb.removeAttribute('disabled');
    lb.style.pointerEvents = 'auto';
    lb.style.opacity = '1';
    lb.style.cursor = 'pointer';
  }
  if (gb) {
    gb.disabled = false;
    gb.removeAttribute('disabled');
    gb.style.pointerEvents = 'auto';
    gb.style.opacity = '1';
    gb.style.cursor = 'pointer';
    // keep the intended visual affordance
    if (!gb.style.backgroundColor) gb.style.backgroundColor = 'green';
  }
}
  // v71 hardening: keep buttons clickable; gate actions in handlers
  if (loadFileBtn) {
    loadFileBtn.disabled = false;
    loadFileBtn.removeAttribute('disabled');
    loadFileBtn.style.cursor = 'pointer';
  }
  if (generateSlipButton) {
    generateSlipButton.disabled = false;
    generateSlipButton.removeAttribute('disabled');
    generateSlipButton.style.cursor = 'pointer';
    generateSlipButton.title = 'Load a PDF template first, then generate the slip.';
  }
  const historyTbody         = document.getElementById('historyTableBody');
  const numGamesSelector     = document.getElementById('num-games');
  const numDrawCount	     = document.getElementById('drawCount');
  const quickPickGame4       = document.getElementById('quick-pick-game-4');
  const quickPickGame5       = document.getElementById('quick-pick-game-5');
  const duplicatesCheckbox   = document.getElementById('use-duplicates-game5');
  const useFamilyCheckbox    = document.getElementById('use-family-numbers');
  const powerPlayCheckbox    = document.getElementById('powerplay-checkbox');
  const payment30Year        = document.getElementById('payment-30year');
  const paymentCashValue     = document.getElementById('payment-cashvalue');
  let pdfFileLoaded   = false;
  let uploadedPdfBytes;
  try { updateTemplateLoadLight(false); } catch(e) {}
  // ─────────────────────────────────────────────────────────────
  // Quick Pick availability rules (per user):
  // - If Number of Games == 4: disable Quick Pick for Game 4 and clear it
  // - If Number of Games == 5: disable Quick Pick for Game 5 and clear it
  // - Re-enable when Number of Games changes away from those values
  // Note: Family numbers already constrains games and also disables Game 4 QP.
  // ============================================================
// v89: Deterministic Slot Allocation Engine (Capacity Model)
// ============================================================
function __pbToast(message, kind) {
  try {
    if (kind === 'error') {
      if (typeof showErrorToast === 'function') return showErrorToast(message);
      if (typeof showErrorPopup === 'function') return showErrorPopup(message);
    }
    if (typeof showInfoPopup === 'function') return showInfoPopup(message);
    if (typeof showSuccessPopup === 'function') return showSuccessPopup(message);
  } catch(e) {}
  try { console.warn(message); } catch(e) {}
}
function syncSlipOptions() {
  const n = parseInt(numGamesSelector && numGamesSelector.value, 10) || 0;
  const famWarnEl = document.getElementById('familyCapacityWarning');
  const showFamWarn = (msg) => {
    if (!famWarnEl) return;
    famWarnEl.textContent = msg || 'Family disabled: insufficient capacity.';
    famWarnEl.style.display = 'inline';
  };
  const hideFamWarn = () => { if (famWarnEl) famWarnEl.style.display = 'none'; };
  // Read current states
  let qp4 = !!(quickPickGame4 && quickPickGame4.checked);
  let qp5 = !!(quickPickGame5 && quickPickGame5.checked);
  let dup5 = !!(duplicatesCheckbox && duplicatesCheckbox.checked);
  let fam  = !!(useFamilyCheckbox && useFamilyCheckbox.checked);
  // ----------------------------
  // Canonical UI constraints
  // ----------------------------
  // N < 4: QP4 must be disabled + cleared (slot 4 not in capacity)
  // N >= 4: QP4 may be enabled and, if selected, reserves Game 4
  if (quickPickGame4) {
    if (n < 4) {
      if (quickPickGame4.checked) {
        quickPickGame4.checked = false;
        qp4 = false;
      }
      quickPickGame4.disabled = true;
    } else {
      quickPickGame4.disabled = false;
    }
  }
  // N < 5: QP5 and DUP5 must be disabled + cleared (slot 5 not in capacity)
  // N == 5: QP5 or DUP5 may be enabled (mutually exclusive), reserving Game 5
  if (quickPickGame5) {
    if (n !== 5) {
      if (quickPickGame5.checked) {
        quickPickGame5.checked = false;
        qp5 = false;
      }
      quickPickGame5.disabled = true;
    } else {
      quickPickGame5.disabled = false;
    }
  }
  if (duplicatesCheckbox) {
    if (n !== 5) {
      if (duplicatesCheckbox.checked) {
        duplicatesCheckbox.checked = false;
        dup5 = false;
      }
      duplicatesCheckbox.disabled = true;
    } else {
      duplicatesCheckbox.disabled = false;
    }
  }
// Mutual exclusion (QP5 ↔ DUP5) at all times
  if (qp5 && dup5) {
    // Deterministic priority: keep QP5, clear DUP5
    if (duplicatesCheckbox) duplicatesCheckbox.checked = false;
    dup5 = false;
    __pbToast('Conflicting options: QP5 and Duplicates 5 cannot both be enabled. Duplicates 5 was cleared.', 'error');
  }
  // When N==5 (slot 5 is in capacity), disable the opposite toggle when one is selected.
  // When N!=5, both are force-disabled/cleared above.
  if (n === 5 && quickPickGame5 && duplicatesCheckbox) {
    if (qp5) {
      duplicatesCheckbox.disabled = true;
      quickPickGame5.disabled = false;
    } else if (dup5) {
      quickPickGame5.disabled = true;
      duplicatesCheckbox.disabled = false;
    } else {
      quickPickGame5.disabled = false;
      duplicatesCheckbox.disabled = false;
    }
  }
// Refresh local values after any disabling/clearing
  qp4 = !!(quickPickGame4 && quickPickGame4.checked);
  qp5 = !!(quickPickGame5 && quickPickGame5.checked);
  dup5 = !!(duplicatesCheckbox && duplicatesCheckbox.checked);
  fam  = !!(useFamilyCheckbox && useFamilyCheckbox.checked);
  // ----------------------------
  // Capacity feasibility enforcement
  // ----------------------------
  const reservedLocked = (qp4 ? 1 : 0) + ((qp5 || dup5) ? 1 : 0);
  // If reservedLocked exceeds N, deterministically clear in this order:
  // 1) clear QP4 (Game4), 2) clear DUP5, 3) clear QP5
  if (reservedLocked > n) {
    if (quickPickGame4 && quickPickGame4.checked) {
      quickPickGame4.checked = false;
      qp4 = false;
      __pbToast('Selected options exceed available game capacity (N). QP4 was cleared to resolve the conflict.', 'error');
    } else if (duplicatesCheckbox && duplicatesCheckbox.checked) {
      duplicatesCheckbox.checked = false;
      dup5 = false;
      __pbToast('Selected options exceed available game capacity (N). Duplicates 5 was cleared to resolve the conflict.', 'error');
    } else if (quickPickGame5 && quickPickGame5.checked) {
      quickPickGame5.checked = false;
      qp5 = false;
      __pbToast('Selected options exceed available game capacity (N). QP5 was cleared to resolve the conflict.', 'error');
    }
  }
  // Family consumes exactly 2 capacity units; if insufficient, auto-disable Family with inline warning
  const reservedLocked2 = (qp4 ? 1 : 0) + ((qp5 || dup5) ? 1 : 0);
  const familyWouldFit = fam ? (reservedLocked2 + 2 <= n) : true;
  if (useFamilyCheckbox) {
    if (fam && !familyWouldFit) {
      useFamilyCheckbox.checked = false;
      fam = false;
      showFamWarn('Family disabled: insufficient capacity for 2 slots.');
      __pbToast('Family numbers require 2 game slots. Family was disabled due to insufficient capacity.', 'error');
    } else if (!fam) {
      hideFamWarn();
    }
  }
  // Note: buildSlipPlan() is deterministic and is the single source of truth for marked slots.
}
function buildSlipPlan() {
  const n = parseInt(numGamesSelector && numGamesSelector.value, 10) || 0;
  const qp4 = !!(quickPickGame4 && quickPickGame4.checked);
  const qp5 = !!(quickPickGame5 && quickPickGame5.checked);
  const dup5 = !!(duplicatesCheckbox && duplicatesCheckbox.checked);
  const fam = !!(useFamilyCheckbox && useFamilyCheckbox.checked);
  const plan = (typeof window.__createEmptySlipPlanSchema === 'function')
    ? window.__createEmptySlipPlanSchema()
    : { version: 1, n: 0, slots: {"1":null,"2":null,"3":null,"4":null,"5":null}, meta: { lockedSlots: [], notes: [] } };
  plan.version = 1;
  plan.n = n;
  plan.meta = plan.meta || { lockedSlots: [], notes: [] };
  plan.meta.lockedSlots = [];
  plan.meta.notes = plan.meta.notes || [];
  // ------------------------------------------------------------
  // Canonical Capacity Model:
  // - N is total capacity (marked games)
  // - Physical slots are always Game 1–Game 5
  // - Locked slots reserve fixed positions (QP4 -> slot 4, QP5/DUP5 -> slot 5)
  // - Family consumes exactly 2 capacity units; relocatable to first two available non-locked slots
  // - Remaining capacity filled with TOP1, TOP2, TOP3... in physical slot order
  // ------------------------------------------------------------
  // Allocate locked slots first (fixed physical slots)
  if (qp4) {
    plan.slots["4"] = { kind: 'LOCKED', option: 'QP4', label: 'QP (Game 4)' };
    plan.meta.lockedSlots.push(4);
  }
  if (qp5) {
    plan.slots["5"] = { kind: 'LOCKED', option: 'QP5', label: 'QP (Game 5)' };
    plan.meta.lockedSlots.push(5);
  } else if (dup5) {
    plan.slots["5"] = { kind: 'LOCKED', option: 'DUP5', label: 'Duplicates (Game 5)' };
    plan.meta.lockedSlots.push(5);
  }
  // Count reserved locked capacity
  const reservedLocked = (qp4 ? 1 : 0) + ((qp5 || dup5) ? 1 : 0);
  // Allocate Family (2 capacity units) if enabled and feasible
  let marked = reservedLocked;
  if (fam) {
    if (reservedLocked + 2 <= n) {
      const available = [];
      for (let s = 1; s <= 5; s++) {
        const key = String(s);
        const cell = plan.slots[key];
        if (cell && cell.kind === 'LOCKED') continue;
        if (!cell) available.push(s);
      }
      if (available.length >= 2) {
        const s1 = String(available[0]);
        const s2 = String(available[1]);
        plan.slots[s1] = { kind: 'FAMILY', index: 1, label: 'Family #1' };
        plan.slots[s2] = { kind: 'FAMILY', index: 2, label: 'Family #2' };
        marked += 2;
      } else {
        // Should not occur with feasibility check, but keep deterministic safety
        plan.meta.notes.push('Family requested but not enough non-locked slots were available.');
      }
    } else {
      plan.meta.notes.push('Family requested but disabled due to insufficient capacity (requires 2).');
    }
  }
  // Fill remaining capacity with TOP picks in strict order (TOP1 → TOP2 → ...)
  let topIdx = 1;
  for (let s = 1; s <= 5 && marked < n; s++) {
    const key = String(s);
    if (plan.slots[key]) continue; // skip locked/family/filled
    plan.slots[key] = { kind: 'TOP', topIndex: topIdx, label: 'TOP' + topIdx };
    topIdx++;
    marked++;
  }
  // Final deterministic safeguard: never exceed N (remove from bottom-most non-locked slots)
  if (marked > n) {
    for (let s = 5; s >= 1 && marked > n; s--) {
      const key = String(s);
      const cell = plan.slots[key];
      if (!cell) continue;
      if (cell.kind === 'LOCKED') continue;
      plan.slots[key] = null;
      marked--;
    }
  }
  return plan;
}
function recomputeSlip() {
  // Adapter only: compute & store plan, but do not alter existing slip rendering yet
  syncSlipOptions();
  const plan = buildSlipPlan();
  try {
    if (typeof window.__setLastComputedSlipPlan === 'function') {
      window.__setLastComputedSlipPlan(plan);
    }
  } catch(e) {}
  return plan;
}
// Backward-compat shim: existing code calls this name
function syncQuickPickAvailability() {
    // v89: No N-based disabling. These options are capacity-managed by the slot plan.
    try {
      // Mutual exclusion UI assist (in addition to deterministic auto-clear in syncSlipOptions)
      if (quickPickGame5 && duplicatesCheckbox) {
        if (quickPickGame5.checked) {
          duplicatesCheckbox.disabled = true;
        } else if (duplicatesCheckbox.checked) {
          quickPickGame5.disabled = true;
        } else {
          quickPickGame5.disabled = false;
          duplicatesCheckbox.disabled = false;
        }
      }
      // QP4 always available (slot 4 lock handled by plan)
      if (quickPickGame4) quickPickGame4.disabled = false;
      // Ensure Family toggle does not hard-disable options in v89 model
    } catch(e) {}
    // Always recompute plan for debug + downstream use
    try { recomputeSlip(); } catch(e) {}
  }    function _pbEnsureFamilyRows() {
  try { window.__pbvNext = window.__pbvNext || {}; } catch(e) { return; }
  const historyTbody = document.getElementById('historyTableBody');
  const useFamilyCheckbox = document.getElementById('use-family-numbers');
  if (!historyTbody || !useFamilyCheckbox) return;
  // Remove existing family rows first
  historyTbody.querySelectorAll('tr.pb-family-row').forEach(tr => tr.remove());
  if (!useFamilyCheckbox.checked) return;
  // Determine the target draw date (use the currently selected draw date if available, else fall back to top row's date)
  let drawDateText = '';
  try {
    if (typeof getSelectedDrawDateISO === 'function') {
      const iso = getSelectedDrawDateISO();
      if (iso) {
        // Convert ISO YYYY-MM-DD to the same long-date text used in the table (to match UI)
        // We don't strictly need exact matching text for insertion; this is for display only.
        const d = new Date(iso + 'T00:00:00');
        drawDateText = d.toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
      }
    }
  } catch(e) {}
  if (!drawDateText) {
    const firstRow = historyTbody.querySelector('tr');
    if (firstRow && firstRow.cells && firstRow.cells[1]) drawDateText = String(firstRow.cells[1].textContent || '').trim();
  }
  const familyPicks = [
    { numbers: [12, 19, 24, 48, 67], powerball: 3 },
    { numbers: [1,  3,  10, 16, 26], powerball: 7 }
  ];
  // Insert family rows at the very top of the body so they can be treated as TOP candidates when extracting.
  familyPicks.forEach((pick, idx) => {
    const tr = document.createElement('tr');
    tr.className = 'pb-family-row';
    const prob = (typeof calculateProbability === 'function')
      ? calculateProbability(pick.numbers, pick.powerball, 'Family Numbers')
      : 0;
    const cells = [
      'Family Numbers',
      drawDateText || '',
      pick.numbers.join(', '),
      String(pick.powerball),
      '0.00%',
      `${Number(prob || 0).toFixed(2)}%`
    ];
    cells.forEach((val, colIdx) => {
      const td = document.createElement('td');
      td.textContent = val;
      if (colIdx === 3) td.className = 'powerball-number';
      tr.appendChild(td);
    });
    historyTbody.insertBefore(tr, historyTbody.children[idx] || null);
  });
  // Quality check: if rows didn't land, surface a toast (non-blocking)
  try {
    const landed = historyTbody.querySelectorAll('tr.pb-family-row').length;
    if (landed < 2 && typeof showSuccessPopup === 'function') {
      showSuccessPopup('Family #s enabled, but could not render Family rows in Drawing History.');
    }
  } catch(e) {}
}
// Expose for updateHistoryTable and other flows
try {
  window.__pbvNext = window.__pbvNext || {};
  window.__pbvNext.ensureFamilyRows = _pbEnsureFamilyRows;
} catch(e) {}
  // ── When Family#s toggles ──
  useFamilyCheckbox.addEventListener('change', () => {
    // Do NOT alter the draw date selector or force Num Games here.
    // Family numbers affect slip slot allocation only.
    try { if (window.__pbvNext && window.__pbvNext.ensureFamilyRows) window.__pbvNext.ensureFamilyRows(); } catch(e) {}
    syncQuickPickAvailability();
    // Re-render Saved Slip table for the currently selected draw date
    try {
      const dd = (typeof getSelectedDrawDateISO === 'function') ? getSelectedDrawDateISO() : '';
      if (dd) renderPreviousPredictionsMiniTable(dd);
    } catch(e) {}
  });
  // ── When Number of Games changes ──
  numGamesSelector.addEventListener('change', () => {
    syncQuickPickAvailability();
  });
// ── When Slip Options change (QP/Duplicates/Family) ──
if (quickPickGame4) quickPickGame4.addEventListener('change', () => { syncQuickPickAvailability(); });
if (quickPickGame5) quickPickGame5.addEventListener('change', () => { syncQuickPickAvailability(); });
if (duplicatesCheckbox) duplicatesCheckbox.addEventListener('change', () => { syncQuickPickAvailability(); });
  // Initial gating on page load
  syncQuickPickAvailability();
  // ── Load the PDF template ──
  loadFileBtn.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', async () => {
    const f = fileInput.files[0];
    if (!f) { try { showToast('Please select a Powerball template PDF.', 'error'); } catch(e) {} return; }
    uploadedPdfBytes = await f.arrayBuffer();
    pdfFileLoaded     = true;
    generateSlipButton.disabled = false;
    generateSlipButton.style.cursor = 'pointer';
    generateSlipButton.style.backgroundColor = 'green';
    try { updateTemplateLoadLight(true); } catch(e) {}
    try { showToast('Powerball template PDF loaded.', 'success'); } catch(e) {}
    try { ensureSlipButtonsEnabled(); } catch(e) {}
  });
document.addEventListener('click', async (e) => {
  const btn = e.target && e.target.closest ? e.target.closest('#generate-slip') : null;
  if (!btn) return;
  // If the direct handler is bound, it will also run; this is a safety net.
});
  // v72: derive base method label from currently selected prediction method (do NOT rely on table text)
  function getSelectedPredictionMethodLabel() {
    const v = (document.querySelector('input[name="predictionMethod"]:checked')?.value || 'frequency').toLowerCase();
    const map = {
      'lstm': 'LSTM',
      'frequency': 'Frequency',
      'exponential': 'Exponential',
      'montecarlo': 'Monte Carlo',
      'monte_carlo': 'Monte Carlo',
      'markov': 'Markov'
    };
    return map[v] || (v.charAt(0).toUpperCase() + v.slice(1));
  }
function __pbSlipFamilyInjectionQC(planObj, drawingData){
  try{
    const famToggle = document.getElementById('use-family-numbers');
    const famOn = !!(famToggle && famToggle.checked);
    if (!famOn) return true;
    const slots = (planObj && planObj.slots) ? planObj.slots : {};
    const famSlots = Object.values(slots).filter(v => v && v.kind === 'FAMILY').length;
    if (famSlots !== 2){
      try { showInfoPopup('Family #s enabled, but slip plan does not contain 2 Family slots.'); } catch(e) {}
      return false;
    }
    const famRows = Array.isArray(drawingData) ? drawingData.filter(d => (d.method||'').toLowerCase().includes('family')) : [];
    if (famRows.length < 2){
      try { showInfoPopup('Family #s enabled, but Drawing History does not contain 2 Family rows.'); } catch(e) {}
      return false;
    }
    return true;
  } catch(e){
    return true; // non-blocking
  }
}
async function handleGenerateSlipClick(e){
  if (!pdfFileLoaded) {
    try { showToast('Please load the Powerball Template PDF before generating the play slip.', 'error'); } catch(e) {}
    try { updateTemplateLoadLight(false); } catch(e) {}
    return;
  }
  // 1) Make sure any “Family” rows are present
  try { if (window.__pbvNext && window.__pbvNext.ensureFamilyRows) window.__pbvNext.ensureFamilyRows(); } catch(e) {}
  try {
    // 2) Pull & limit the data
    const drawingData = extractDrawingHistoryData();
    const numGamesEl = document.getElementById('num-games');
    const totalGames = Math.min(5, Math.max(1, parseInt(numGamesEl ? numGamesEl.value : '5', 10) || 5));
    // Build authoritative slip plan (v90 uses plan TOP slots to determine required candidates)
const planObj = (typeof recomputeSlip === 'function') ? recomputeSlip() : null;
// Build a 5-slot plan aligned to Game 1..5 (index 0..4). Slots not marked by the plan remain null.
const slipPlan = new Array(5).fill(null);
// Current draw date key from the main draw-date selector (fallback to first drawing row date)
const drawDateKey = (typeof getSelectedDrawDateISO === 'function' ? getSelectedDrawDateISO() : (drawingData[0]?.date || '')) || (drawingData[0]?.date || '');
// Identify active (marked) physical slots from the plan (exactly N marks across slots 1..5)
const activeSlots = [];
if (planObj && planObj.slots) {
  for (let s = 1; s <= 5; s++) {
    if (planObj.slots[String(s)]) activeSlots.push(s);
  }
}
// Defensive fallback: if plan missing, treat first N slots as active (preserves legacy behavior)
if (!activeSlots.length) {
  for (let s = 1; s <= totalGames; s++) activeSlots.push(s);
}
// v91: Family Injection QC (adapter-only; do not alter slot allocation)
if (typeof __pbSlipFamilyInjectionQC === 'function') {
  const ok = __pbSlipFamilyInjectionQC(planObj, drawingData);
  if (!ok) return;
}
// Translate plan slots into slipPlan skeleton (LOCKED/FAMILY/TOP placeholders)
const familyPicks = [
  { numbers: [12, 19, 24, 48, 67], powerball: 3 },
  { numbers: [1,  3,  10, 16, 26], powerball: 7 }
];
for (let s = 1; s <= 5; s++) {
  const cell = (planObj && planObj.slots) ? planObj.slots[String(s)] : null;
  if (!cell) continue;
  // LOCKED (QP/DUP)
  if (cell.kind === 'LOCKED') {
    if (cell.option === 'DUP5') {
      slipPlan[s - 1] = { method: 'Duplicates', date: drawDateKey };
    } else {
      slipPlan[s - 1] = { method: 'Quick Pick', date: drawDateKey };
    }
    continue;
  }
  // FAMILY (2 marks)
  if (cell.kind === 'FAMILY') {
    const idx = (cell.index === 2 ? 1 : 0);
    const pick = familyPicks[idx];
    slipPlan[s - 1] = { method: 'Family Numbers', date: drawDateKey, numbers: pick.numbers.slice(), powerball: pick.powerball };
    continue;
  }
  // TOP placeholder (filled later)
  if (cell.kind === 'TOP') {
    slipPlan[s - 1] = { method: '__TOP__', date: drawDateKey, __topIndex: Number(cell.topIndex || 0) };
  }
}
// Candidate pool from Drawing History (normalize types; require 5 mains + PB)
const candidates = (drawingData || []).map(d => {
  const nums = Array.isArray(d.numbers) ? d.numbers.map(n => Number(n)).filter(n => Number.isFinite(n)) : [];
  const pb = Number(d.powerball);
  return {
    ...d,
    numbers: nums,
    powerball: pb,
    modelRL: Number(d.modelRL),
    globalRL: Number(d.globalRL)
  };
}).filter(d => d.numbers.length === 5 && Number.isFinite(d.powerball));
// Sort by Global RL (fallback Model RL), descending
const ranked = candidates.slice().sort((a,b)=>(((b.globalRL || 0) - (a.globalRL || 0)) || ((b.modelRL || 0) - (a.modelRL || 0))));
// v90: required TOP count is derived from the plan (only validate the required number of candidates)
const requiredTop = activeSlots.reduce((acc, s) => {
  const cell = (planObj && planObj.slots) ? planObj.slots[String(s)] : null;
  return acc + (cell && cell.kind === 'TOP' ? 1 : 0);
}, 0);
if (ranked.length < requiredTop) {
  showInfoPopup(`Need at least ${requiredTop} valid predictions in Drawing History (TOP slots). Found ${ranked.length}.`);
  return;
}
// Assign TOP1..TOPk deterministically to TOP slots (in ascending physical slot order)
let ri = 0;
for (let s = 1; s <= 5; s++) {
  if (!activeSlots.includes(s)) continue;
  const cell = (planObj && planObj.slots) ? planObj.slots[String(s)] : null;
  if (!cell || cell.kind !== 'TOP') continue;
  const pick = ranked[ri++];
  slipPlan[s - 1] = { ...pick, date: pick.date || drawDateKey };
}
// Sanity: ensure exactly N marked slots are populated across physical slots
const filledCount = slipPlan.filter(Boolean).length;
if (filledCount < totalGames) {
  showInfoPopup(`Slip plan could not be completed. Required ${totalGames} marked games but only built ${filledCount}.`);
  return;
}
    // This variable name is used by the downstream PDF-stamping logic
    const sortedDrawingData = slipPlan;
// 5) Load the PDF
    const pdfDoc   = await PDFLib.PDFDocument.load(uploadedPdfBytes);
    const boldFont = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);
    const form     = pdfDoc.getForm();
    pdfDoc.getPages()[0].setSize(8.5 * 72, 3.5 * 72);
    // 6) Safe setter to avoid undefined fields
    function safeSetField(name, value) {
      const f = form.getTextField(name);
      if (!f) return console.warn(`Missing PDF field: ${name}`);
      f.setText(value);
      f.updateAppearances(boldFont);
    }
   // 7) Plan-aware PDF stamping: iterate active slots only (v91)
    {
const plan = window.__lastComputedSlipPlan;
const activeSlotEntries = (plan && plan.slots)
  ? Object.entries(plan.slots)
      .filter(([slotId, entry]) => !!entry)
      .sort((a, b) => Number(a[0]) - Number(b[0]))
  : [];
// Adapter-only method resolution for PDF labels (v90b)
function resolvePdfMethod(entry, slipEntry, slotId) {
  if (!entry) return 'Unknown';
  // FAMILY and LOCKED are plan-driven.
  if (entry.kind === 'FAMILY') return 'Family Numbers';
  if (entry.kind === 'LOCKED') {
    if (entry.option === 'QP5') return 'Quick Pick';
    if (entry.option === 'DUP5') return 'Duplicates';
  }
  // TOP is data-driven: we want the real model name (e.g., "Exponential"),
  // not plan labels like "TOP1/TOP2" and not the generic fallback.
  if (entry.kind === 'TOP') {
    // 1) Prefer explicit model/method present on the slip entry (if available).
    const direct =
      (slipEntry && (
        slipEntry.methodLabel ||
        slipEntry.method ||
        slipEntry.model ||
        slipEntry.modelName ||
        slipEntry.name
      )) || '';
    const directClean = String(direct).trim();
    if (directClean && !/^TOP\d+\b/i.test(directClean) && directClean.toLowerCase() !== 'top prediction') {
      return directClean;
    }
    // 2) Fallback: resolve by matching the slip numbers in the Drawing History table.
    // This is adapter-only: we do not change plan schema or generation logic.
    try {
      const table = document.querySelector('table.drawing-history.vnext-table');
      const tbody = table ? table.querySelector('tbody') : null;
      if (tbody && slipEntry) {
        const wantNums = Array.isArray(slipEntry.numbers) ? slipEntry.numbers.join(' ') : String(slipEntry.numbers || '').trim();
        const wantPB = String(slipEntry.powerball ?? slipEntry.pb ?? '').trim();
        // Draw date match is best-effort; numbers+PB match is the primary key.
        const wantDate =
          String(slipEntry.drawDate || slipEntry.date || (window.__selectedDrawDate || '')).trim();
        const rows = Array.from(tbody.querySelectorAll('tr'));
        for (const tr of rows) {
          const tds = tr.querySelectorAll('td');
          if (!tds || tds.length < 4) continue;
          const modelText = (tds[0].innerText || '').trim();
          const rowDate = (tds[1].innerText || '').trim();
          const rowNums = (tds[2].innerText || '').trim();
          const rowPB = (tds[3].innerText || '').trim();
          if (wantPB && rowPB && rowPB !== wantPB) continue;
          if (wantNums && rowNums && rowNums !== wantNums) continue;
          // If we have a date, require it; otherwise skip date filter.
          if (wantDate && rowDate && rowDate !== wantDate) continue;
          // Strip TOP rank prefixes (TOP1, TOP2, etc.) if present.
          const cleaned = modelText.replace(/^TOP\s*\d+\s*[:\-]?\s*/i, '').trim();
          if (cleaned && cleaned.toLowerCase() !== 'top prediction') return cleaned;
          // If the table stores the model name directly, use it even if it's not prefixed.
          if (modelText && modelText.toLowerCase() !== 'top prediction') return modelText;
        }
      }
    } catch (e) {
      // swallow adapter-only lookup failures
    }
    // 3) Last resort.
    return 'Top Prediction';
  }
  return 'Unknown';
}
// Use slipPlan picks for numbers/powerball; filter nulls to align to activeSlots order
const activeDrawingData = (sortedDrawingData || []).filter(Boolean);
// 8) Stamp Draw Date
const drawDate = activeDrawingData[0]?.date || 'Unknown Date';
safeSetField('DrawDate', `Draw Date: ${drawDate}`);
// 9) Stamp each active Game’s Model, Numbers & Powerball
for (let idx = 0; idx < activeSlotEntries.length; idx++) {
  const slotId = Number(activeSlotEntries[idx][0]);
  const game = slotId;
  const planEntry = activeSlotEntries[idx][1];
  const slipEntry = (Array.isArray(activeDrawingData) ? (activeDrawingData[slotId - 1] ?? activeDrawingData[idx]) : null) || null;
let modelLabel = resolvePdfMethod(planEntry, slipEntry, game);
  // UI override assists (retain existing behavior)
  if (game === 4 && quickPickGame4 && quickPickGame4.checked) {
    modelLabel = 'Quick Pick';
  }
  if (game === 5) {
    if (duplicatesCheckbox && duplicatesCheckbox.checked) {
      modelLabel = 'Duplicates';
    } else if (quickPickGame5 && quickPickGame5.checked) {
      modelLabel = 'Quick Pick';
    }
  }
  safeSetField(`Model${game}`, modelLabel);
  // Only stamp numbers if we actually have them for this slot
  if (slipEntry && Array.isArray(slipEntry.numbers)) {
    slipEntry.numbers.forEach(n => safeSetField(`Num${game}_${n}`, 'w'));
    if (Number.isFinite(Number(slipEntry.powerball))) {
      safeSetField(`Powerball${game}_${Number(slipEntry.powerball)}`, 'w');
    }
  }
}
    // 10) Quick‐Pick boxes (just the W’s in the checkboxes)
    if (quickPickGame4.checked) {
      safeSetField('Quick4_1', 'w');
      safeSetField('Quick4_2', 'w');
    }
    if (quickPickGame5.checked) {
      safeSetField('Quick5_1', 'w');
      safeSetField('Quick5_2', 'w');
    }
    // 11) PowerPlay & Payment options
    safeSetField('PowerPlay', powerPlayCheckbox.checked ? 'w' : '');
    safeSetField('Cash_2',    payment30Year.checked   ? 'w' : '');
    safeSetField('Cash_1',      paymentCashValue.checked? 'w' : '');
    // 12) Multi‐box logic
    const multiOptions = [2,3,4,5,6,7,8,9,10,12,15];
    multiOptions.forEach(n => safeSetField(`Multi_${n}`, ''));
    const sel = parseInt(numDrawCount.value, 10);
    if (multiOptions.includes(sel)) {
      safeSetField(`Multi_${sel}`, 'w');
    }
    }
    // 13) Save & download
    const pdfBytes = await pdfDoc.save();
    const blob     = new Blob([pdfBytes], { type: 'application/pdf' });
    const link     = document.createElement('a');
    link.href      = URL.createObjectURL(blob);
    const __ddEl = document.getElementById('startDate') || document.getElementById('drawDate');
    // IMPORTANT: do NOT use new Date('YYYY-MM-DD') (it is parsed as UTC and can shift to prior day in local time).
    let __ddKey = '';
    if (__ddEl && __ddEl.value && /^\d{4}-\d{2}-\d{2}$/.test(__ddEl.value)) {
      __ddKey = __ddEl.value; // already the correct local draw-date key
    } else {
      const _d = new Date();
      const _y = _d.getFullYear();
      const _m = String(_d.getMonth()+1).padStart(2,'0');
      const _day = String(_d.getDate()).padStart(2,'0');
      __ddKey = `${_y}-${_m}-${_day}`;
    }
    link.download  = `powerballslip_${__ddKey}.pdf`;
    link.click();
    // Enhancement #2: Save generated slip selections as Previous Predictions (for auto-compare to actuals)
    try {
      const drawDateInput = document.getElementById('startDate') || document.getElementById('drawDate');
      let drawDateKey = '';
      if (drawDateInput && drawDateInput.value && /^\d{4}-\d{2}-\d{2}$/.test(drawDateInput.value)) {
        drawDateKey = drawDateInput.value;
      } else {
        const _d2 = new Date();
        const _y2 = _d2.getFullYear();
        const _m2 = String(_d2.getMonth()+1).padStart(2,'0');
        const _day2 = String(_d2.getDate()).padStart(2,'0');
        drawDateKey = `${_y2}-${_m2}-${_day2}`;
      }
      // Group by method to enforce overwrite rules per (date + method)
      const runId = `SLIP_${drawDateKey}_${Date.now()}`;
      const createdAt = new Date().toISOString();
      const grouped = {}; // method -> records[]
      // Determine how many games were actually placed on the slip.
      // Do NOT rely on outer-scope variables (they have repeatedly caused runtime failures).
      const _numGamesEl = document.getElementById('num-games');
      const _requestedGames = Math.min(5, Math.max(1, parseInt(_numGamesEl ? _numGamesEl.value : '5', 10) || 5));
      const _actualGames = Array.isArray(sortedDrawingData) ? sortedDrawingData.length : 0;
      const numGamesToSave = Math.min(_requestedGames, _actualGames || _requestedGames);
      for (let i = 0; i < numGamesToSave; i++) {
        const game = i + 1;
        const entry = sortedDrawingData[i] || {};
        // Mirror the same label precedence used on the PDF
        // v72: use selected prediction method as the base label (slip content source), not the History table label
        // v75: save under the actual game source method when available
        let methodLabel = (entry && entry.method) ? entry.method : getSelectedPredictionMethodLabel();
const qp4 = (game === 4 && quickPickGame4 && quickPickGame4.checked);
        if (qp4) methodLabel = 'Quick Pick';
        const dup5 = (game === 5 && duplicatesCheckbox && duplicatesCheckbox.checked);
        const qp5  = (game === 5 && quickPickGame5 && quickPickGame5.checked);
        if (game === 5) {
          if (dup5) methodLabel = 'Duplicates';
          else if (qp5) methodLabel = 'Quick Pick';
        }
        methodLabel = _ppNormMethod(methodLabel || entry.method);
        const rec = {
          id: `PP_${runId}_G${game}`,
          type: 'Prediction',
          source: 'Play Slip',
          runId,
          slipId: runId,
          gameIndex: game,
          createdAt,
          drawDate: drawDateKey,
          method: methodLabel,
          numbers: Array.isArray(entry.numbers) ? entry.numbers.slice(0,5) : null,
          powerball: Number.isFinite(entry.powerball) ? entry.powerball : (Number.isFinite(entry.pb) ? entry.pb : (Number.isFinite(entry.special) ? entry.special : null)),
          quickPick: (game === 4 && qp4) || (game === 5 && qp5) ? true : false,
          duplicatesMode: (game === 5 && dup5) ? true : false,
          powerPlay: (powerPlayCheckbox && powerPlayCheckbox.checked) ? true : false,
          paymentOption: (payment30Year && payment30Year.checked) ? '30_year' : ((paymentCashValue && paymentCashValue.checked) ? 'cash' : null),
          multiplier: (numDrawCount && numDrawCount.value ? Number(numDrawCount.value) : null),
          status: 'PENDING'
        };
        if (!grouped[methodLabel]) grouped[methodLabel] = [];
        grouped[methodLabel].push(rec);
      }
      // Apply overwrite rules and persist
      const methods = Object.keys(grouped);
      for (const m of methods) {
        upsertPreviousPredictionsRun(drawDateKey, m, runId, grouped[m]);
      }
      setSlipSaveStatusLine(`Saved Play Slip to Previous Predictions: ${methods.length} method(s), up to 5 games each, for ${drawDateKey}. Run: ${runId}`);
      renderPreviousPredictionsMiniTable(drawDateKey);
      try { _ppWireToggleOnce(); } catch(e) {}
      try { renderPreviousPredictionsHistoryTable(); } catch(e) {}
      try { showToast('Auto-saved Previous Predictions to JSON.', 'success'); } catch(e) {}
    } catch (e) {
      console.warn('Failed to save Play Slip to Previous Predictions', e);
      setSlipSaveStatusLine(`Save failed: ${e && e.message ? e.message : 'Unknown error'}`, true);
    }
    showSuccessPopup(`PDF generated: ${link.download}`);
  } catch (err) {
    console.error(err);
    showErrorToast(`Error generating PDF: ${err.message}`);
  }
}
// Re-bind slip generation even if DOM nodes are replaced during table redraws
document.addEventListener('click', async (ev)=>{
  const b = ev.target && ev.target.closest ? ev.target.closest('#generate-slip') : null;
  if(!b) return;
  ev.preventDefault();
  ev.stopPropagation();
  try{ await handleGenerateSlipClick(ev); }catch(err){ console.error(err); showErrorToast('Error generating play slip. See console for details.'); }
});
if (typeof generateSlipButton !== 'undefined' && generateSlipButton) {
  generateSlipButton.addEventListener('click', async (ev)=>{ ev.preventDefault(); ev.stopPropagation(); await handleGenerateSlipClick(ev); });
}
    function extractDrawingHistoryData() {
        // Extract from the rendered Drawing History table, but normalize:
        // - strip TOP badges from the method cell
        // - parse Model RL and Global RL from their respective columns
        return [...document.querySelectorAll('#historyTableBody tr')].map(row => {
            const rawMethod = row.cells[0]?.textContent || '';
            const method = rawMethod.replace(/\bTOP\s*\d+\b/gi, '').replace(/\s+/g, ' ').trim() || null;
            const date = (row.cells[1]?.textContent || '').trim() || null;
            const numsText = row.cells[2]?.textContent || '';
            const numbers = numsText.split(',').map(s => parseInt(String(s).trim(), 10)).filter(n => Number.isFinite(n));
            const powerball = parseInt((row.cells[3]?.textContent || '').trim(), 10);
            const modelRL = parseFloat(String(row.cells[4]?.textContent || '').replace('%','').trim());
            const globalRL = parseFloat(String(row.cells[5]?.textContent || '').replace('%','').trim());
            return {
                method,
                date,
                numbers,
                powerball: Number.isFinite(powerball) ? powerball : null,
                modelRL: Number.isFinite(modelRL) ? modelRL : null,
                globalRL: Number.isFinite(globalRL) ? globalRL : null
            };
        });
    }
});
document.addEventListener('DOMContentLoaded', function () {
   window.__pbvNext = window.__pbvNext || {};
   window.__pbvNext.historicalDataLoaded = false;
    const generateNumbersBtn = document.getElementById("generateNumbersBtn");
    const manualEntryBtn      = document.getElementById("manualEntryBtn");
    const bypassCheckbox      = document.getElementById("bypassHistoricalData");
    function findMostRecentDrawDate() {
        if (!window.historicalData || window.historicalData.length === 0) return null;
        const sortedData = window.historicalData.sort((a, b) => new Date(b.date) - new Date(a.date));
        return new Date(sortedData[0].date).toLocaleDateString("en-US", {
            year: 'numeric', month: 'long', day: 'numeric'
        });
    }
    function updateGenerateButtonState() {
        const allowActions = bypassCheckbox.checked || window.__pbvNext.historicalDataLoaded;
        // Generate numbers
        generateNumbersBtn.disabled = !allowActions;
        generateNumbersBtn.style.opacity = allowActions ? "1" : "0.5";
        generateNumbersBtn.title = allowActions ? "" : "Please load historical data first";
        // Manual entry (recent winning numbers)
// NOTE: Use actual parsed historical data readiness (not a separate flag) so the button becomes clickable immediately after a successful load.
const histReady = !!(window.__pbvNext && window.__pbvNext.historicalDataLoaded);
manualEntryBtn.disabled = !histReady;
manualEntryBtn.style.opacity = histReady ? "1" : "0.5";
manualEntryBtn.title = histReady ? "" : "Please load historical data first";
        // Ensure the HTML disabled attribute matches state (some browsers/styles rely on it)
        if (manualEntryBtn.disabled) {
            manualEntryBtn.setAttribute("disabled", "");
        } else {
            manualEntryBtn.removeAttribute("disabled");
        }
    }
    // Wire up bypass checkbox and initialize gating
    try {
        // Expose for other parts of the app (e.g., after historical load)
        window.__pbvNext.updateGenerateButtonState = updateGenerateButtonState;
        if (bypassCheckbox) {
            bypassCheckbox.addEventListener('change', () => {
                // If user bypasses, allow Generate immediately
                updateGenerateButtonState();
            });
        }
        // Initialize button states on first paint
        updateGenerateButtonState();
    } catch (e) {
        console.warn('Init gating failed:', e);
    }
});
function rebuildManualEntryBallsOnly() {
    const container = document.getElementById('numberEntry');
    if (!container) return;
    // Preserve any existing layout outside the ball inputs; only rebuild the ball inputs area.
    container.innerHTML = '';
    // Helper to style the ball (matches showManualEntryForm)
    function styleBall(input, bg, textColor, borderColor, glowColor) {
        input.style.width = '78px';
        input.style.height = '78px';
        input.style.borderRadius = '50%';
        input.style.border = `3px solid ${borderColor}`;
        input.style.background = bg;
        input.style.color = textColor;
        input.style.fontSize = '28px';
        input.style.fontWeight = 'bold';
        input.style.textAlign = 'center';
        input.style.outline = 'none';
        input.style.boxShadow = `0 0 15px ${glowColor}`;
        input.style.margin = '10px';
        input.style.transition = 'transform 0.2s';
        // remove spinner buttons consistently (some browsers need this on rebuild)
        input.classList.add('number-input');
        input.addEventListener('focus', () => input.style.transform = 'scale(1.1)');
        input.addEventListener('blur', () => input.style.transform = 'scale(1.0)');
    }
    // Add 5 regular ball inputs
    for (let i = 0; i < 5; i++) {
        const ballInput = document.createElement('input');
        ballInput.type = 'number';
        ballInput.min = 1;
        ballInput.max = 69;
        ballInput.className = 'number-input main-number-input';
        ballInput.placeholder = '';
        ballInput.value = '';
        styleBall(ballInput, '#4facfe', '#ffffff', '#00f2fe', 'rgba(0, 242, 254, 0.5)');
        // Prevent duplicate main numbers at entry time
        // NOTE: We intentionally defer duplicate checks while the user is typing the *first* digit
        // of a potential 2-digit number (e.g., typing "54" should not be blocked just because "5" exists).
        const runDupCheck = (v) => {
            const others = Array.from(container.querySelectorAll('.main-number-input')).filter(el => el !== ballInput);
            const dup = others.some(el => parseInt(el.value, 10) === v);
            if (dup) {
                ballInput.value = '';
                showErrorToast('Duplicate main number not allowed. Please enter a unique number (1–69).');
            }
        };
        const scheduleDupCheck = () => {
            try { clearTimeout(ballInput.__dupTimer); } catch {}
            ballInput.__dupTimer = setTimeout(() => {
                const raw = String(ballInput.value || '').trim();
                if (!raw) return;
                const v = parseInt(raw, 10);
                if (Number.isNaN(v)) return;
                // If user has typed only one digit (1–9), treat it as "in-progress" to allow 2-digit numbers.
                // Final validation will still happen on blur / submit.
                if (raw.length === 1 && v >= 1 && v <= 9) return;
                runDupCheck(v);
            }, 250);
        };
        ballInput.addEventListener('input', () => {
            const raw = String(ballInput.value || '').trim();
            if (!raw) return;
            const v = parseInt(raw, 10);
            if (Number.isNaN(v)) return;
            if (v < 1 || v > 69) { ballInput.value = ''; return; }
            scheduleDupCheck();
        });
        // Always validate duplicates when leaving the field (covers single-digit numbers too).
        ballInput.addEventListener('blur', () => {
            const raw = String(ballInput.value || '').trim();
            if (!raw) return;
            const v = parseInt(raw, 10);
            if (Number.isNaN(v)) return;
            if (v < 1 || v > 69) { ballInput.value = ''; return; }
            runDupCheck(v);
        });
container.appendChild(ballInput);
    }
    // Add Powerball input (1–26, duplicates allowed vs mains)
    const pbInput = document.createElement('input');
    pbInput.type = 'number';
    pbInput.min = 1;
    pbInput.max = 26;
    pbInput.id = 'powerballInput';
    pbInput.className = 'number-input';
    pbInput.placeholder = '';
    pbInput.value = '';
    styleBall(pbInput, '#ff7eb3', '#ffffff', '#ff65a3', 'rgba(255, 126, 179, 0.5)');
    pbInput.addEventListener('input', () => {
        const v = parseInt(pbInput.value, 10);
        if (Number.isNaN(v)) return;
        if (v < 1 || v > 26) {
            pbInput.value = '';
            showErrorToast('PowerBall must be between 1 and 26.');
        }
    });
    container.appendChild(pbInput);
}
// ---------- Manual Winning Numbers Entry: inline validation + submit gating ----------
function getManualEntryEls() {
    const modal = document.getElementById('manualEntryModal');
    return {
        modal,
        submitBtn: document.getElementById('submitNumbersBtn'),
        msgEl: document.getElementById('manualEntryInlineMsg'),
        mainInputs: Array.from(modal ? modal.querySelectorAll('.main-number-input') : []),
        pbInput: modal ? modal.querySelector('#powerballInput') : null
    };
}
function validateManualEntryValues() {
    const { mainInputs, pbInput } = getManualEntryEls();
    const mains = mainInputs
        .map(i => parseInt(i.value, 10))
        .filter(n => Number.isFinite(n));
    // Require all 5 mains
    if (mains.length !== 5) return { ok: false, msg: 'Enter 5 main numbers (1–69).' };
    // Range check
    if (Math.min(...mains) < 1 || Math.max(...mains) > 69) return { ok: false, msg: 'Main numbers must be between 1 and 69.' };
    // Uniqueness check (mains only)
    if (new Set(mains).size !== 5) return { ok: false, msg: 'Main numbers must be unique (no duplicates).' };
    const pb = pbInput ? parseInt(pbInput.value, 10) : NaN;
    if (!Number.isFinite(pb)) return { ok: false, msg: 'Enter a PowerBall number (1–26).' };
    if (pb < 1 || pb > 26) return { ok: false, msg: 'PowerBall must be between 1 and 26.' };
    return { ok: true, msg: '' };
}
function updateManualEntrySubmitState() {
    const { submitBtn, msgEl } = getManualEntryEls();
    if (!submitBtn) return;
    const res = validateManualEntryValues();
    submitBtn.disabled = !res.ok;
    submitBtn.style.opacity = res.ok ? '1' : '0.55';
    submitBtn.style.cursor = res.ok ? 'pointer' : 'not-allowed';
    if (msgEl) msgEl.textContent = res.ok ? '' : res.msg;
}
// -------------------------------------------------------------------------------
function showManualEntryForm() {
    const container = document.getElementById('numberEntry');
    container.innerHTML = '';
    // Check if historical data is loaded
    if (!window.historicalData || window.historicalData.length === 0) {
        showErrorToast("Please load historical data first.");
        return;
    }
    // Build a set of existing draw dates in YYYY-MM-DD
    const historyDateSet = new Set(window.historicalData.map(r => r.date));
    // Find last historical date (most recent)
// IMPORTANT: parse YYYY-MM-DD as a *local* date to avoid timezone shifting (which can change the weekday).
const latestRec = window.historicalData
    .slice()
    .sort((a, b) => new Date(a.date + 'T12:00:00') - new Date(b.date + 'T12:00:00'))
    .pop();
const lastHistoricalDate = new Date((latestRec?.date || '') + 'T12:00:00');
    // Past-only enforcement for manual winning-number entry:
// Only allow draw dates that have strictly PASSED (date < today local).
const todayMidnight = new Date();
todayMidnight.setHours(0,0,0,0);
// Cutoff = yesterday (local). Dates on/after today are disallowed.
const cutoff = new Date(todayMidnight);
cutoff.setDate(cutoff.getDate() - 1);
// Build candidate dates from (lastHistoricalDate + 1 day) up through cutoff (yesterday)
    const options = [];
    let cursor = new Date(lastHistoricalDate);
    cursor.setHours(12,0,0,0); // normalize midday to avoid DST edge cases
    const end = new Date();
    end.setHours(12,0,0,0);
    end.setDate(end.getDate() - 1); // yesterday (past-only)
    // Guardrail: if historical data is accidentally ahead of yesterday, clamp the cursor so the selector remains past-only
    if (isNaN(cursor.getTime()) || cursor.getTime() > end.getTime()) {
        cursor = new Date(end);
        cursor.setDate(cursor.getDate() - 1); // so the first loop increment lands on 'end'
        cursor.setHours(12,0,0,0);
    }
    // Safety cap: don't loop forever
    let guard = 0;
    while (cursor.getTime() < end.getTime() && guard < 400) {
        guard++;
        cursor.setDate(cursor.getDate() + 1);
        const day = cursor.getDay(); // 1=Mon,3=Wed,6=Sat
        if (![1,3,6].includes(day)) continue;
        const dateStr = `${cursor.getFullYear()}-${String(cursor.getMonth()+1).padStart(2,'0')}-${String(cursor.getDate()).padStart(2,'0')}`;
        if (!historyDateSet.has(dateStr)) {
            options.push(new Date(cursor));
        }
    }
    // If there are no missing/blank draw dates up through the next scheduled draw, disable entry
    if (options.length === 0) {
        document.getElementById('manualEntryBtn').disabled = true;
        showErrorToast("All drawings up through the next scheduled draw already have historical data.");
        return;
    }
    // Limit dropdown to the 20 earliest missing/blank draw dates
    const first20 = options.slice(0, 20);
    // Add date selector (default = next blank draw date, which is the first option)
    container.innerHTML += `
        <label for="drawDate">Select Drawing Date:</label>
        <select id="drawDate" required style="margin-bottom: 20px; font-size: 16px; padding: 5px;">
            ${first20.map(date => `
                <option value="${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}">${formatDate(date)}</option>
            `).join('')}
        </select><br><br>
    `;
    const ddSel = document.getElementById('drawDate');
    if (ddSel && ddSel.options.length) { ddSel.selectedIndex = 0; ddSel.value = ddSel.options[0].value; }
    // Create a wrapper for number inputs
    const inputWrapper = document.createElement('div');
    inputWrapper.style.display = 'flex';
    inputWrapper.style.gap = '15px';
    inputWrapper.style.marginBottom = '20px';
    inputWrapper.style.flexWrap = 'wrap';
    inputWrapper.style.justifyContent = 'center';
    // Styling function for spherical inputs
    function styleBall(input, bgColor, textColor, borderColor, shadowColor) {
        input.style.width = '78px';
        input.style.height = '78px';
        input.style.borderRadius = '50%';
        input.style.border = `2px solid ${borderColor}`;
        input.style.background = `radial-gradient(circle at top left, #ffffff, ${bgColor})`;
        input.style.color = textColor;
        input.style.fontSize = '20px';
        input.style.fontWeight = 'bold';
        input.style.textAlign = 'center';
        input.style.boxShadow = `0 4px 10px ${shadowColor}`;
        input.style.outline = 'none';
        input.style.transition = 'transform 0.2s ease';
        input.addEventListener('focus', () => input.style.transform = 'scale(1.1)');
        input.addEventListener('blur', () => input.style.transform = 'scale(1.0)');
    }
    // Add 5 regular ball inputs
    for (let i = 0; i < 5; i++) {
        const ballInput = document.createElement('input');
        ballInput.type = 'number';
        ballInput.min = 1;
        ballInput.max = 69;
        ballInput.className = 'number-input main-number-input';
        ballInput.placeholder = '';
        ballInput.value = '';
        styleBall(ballInput, '#4facfe', '#ffffff', '#00f2fe', 'rgba(0, 242, 254, 0.5)');
        // Prevent duplicate main numbers at entry time
        // NOTE: We intentionally defer duplicate checks while the user is typing the *first* digit
        // of a potential 2-digit number (e.g., typing "54" should not be blocked just because "5" exists).
        const runDupCheck = (v) => {
            const others = Array.from(container.querySelectorAll('.main-number-input')).filter(el => el !== ballInput);
            const dup = others.some(el => parseInt(el.value, 10) === v);
            if (dup) {
                ballInput.value = '';
                showErrorToast('Duplicate main number not allowed. Please enter a unique number (1–69).');
            }
        };
        const scheduleDupCheck = () => {
            try { clearTimeout(ballInput.__dupTimer); } catch {}
            ballInput.__dupTimer = setTimeout(() => {
                const raw = String(ballInput.value || '').trim();
                if (!raw) return;
                const v = parseInt(raw, 10);
                if (Number.isNaN(v)) return;
                // If user has typed only one digit (1–9), treat it as "in-progress" to allow 2-digit numbers.
                // Final validation will still happen on blur / submit.
                if (raw.length === 1 && v >= 1 && v <= 9) return;
                runDupCheck(v);
            }, 250);
        };
        ballInput.addEventListener('input', () => {
            const raw = String(ballInput.value || '').trim();
            if (!raw) return;
            const v = parseInt(raw, 10);
            if (Number.isNaN(v)) return;
            if (v < 1 || v > 69) { ballInput.value = ''; return; }
            scheduleDupCheck();
        });
        // Always validate duplicates when leaving the field (covers single-digit numbers too).
        ballInput.addEventListener('blur', () => {
            const raw = String(ballInput.value || '').trim();
            if (!raw) return;
            const v = parseInt(raw, 10);
            if (Number.isNaN(v)) return;
            if (v < 1 || v > 69) { ballInput.value = ''; return; }
            runDupCheck(v);
        });
inputWrapper.appendChild(ballInput);
    }
    // Add Powerball input
    const powerballInput = document.createElement('input');
    powerballInput.type = 'number';
    powerballInput.min = 1;
    powerballInput.max = 26;
    // Use number-input too so it inherits the same spinner-removal + base styling rules
    powerballInput.className = 'number-input powerball-input';
    powerballInput.id = 'powerballInput';
    // PB ball same size as other balls
    powerballInput.style.width = '78px';
    powerballInput.style.height = '78px';
    powerballInput.placeholder = '';
    powerballInput.value = '';
    powerballInput.addEventListener('input', () => {
        const v = parseInt(powerballInput.value, 10);
        if (isNaN(v)) return;
        if (v < 1 || v > 26) {
            powerballInput.value = '';
            if (typeof showPopup === 'function') showSuccessPopup('PowerBall must be between 1 and 26.');
            else showErrorToast('PowerBall must be between 1 and 26.');
        }
    });
    styleBall(powerballInput, '#ff416c', '#ffffff', '#ff7c9e', '#ff416c');
    inputWrapper.appendChild(powerballInput);
    // Auto-advance focus when 2 digits entered
    const allInputs = Array.from(inputWrapper.querySelectorAll('input'));
    allInputs.forEach((inp, idx) => {
        inp.setAttribute('inputmode', 'numeric');
        inp.addEventListener('input', () => {
            const v = String(inp.value || '');
            // if user typed 2 digits (or hit max length), move to next input
            if (v.length >= 2 && idx < allInputs.length - 1) {
                allInputs[idx + 1].focus();
                allInputs[idx + 1].select?.();
            }
        });
    });
container.appendChild(inputWrapper);
    // Submit gating + inline validation
    try {
        const modal = document.getElementById('manualEntryModal');
        if (modal) {
            modal.querySelectorAll('input, select').forEach(el => {
                el.addEventListener('input', updateManualEntrySubmitState);
                el.addEventListener('change', updateManualEntrySubmitState);
            });
        }
    } catch (e) {}
    updateManualEntrySubmitState();
    document.getElementById('manualEntryModal').style.display = 'block';
}
function hideManualEntryForm() {
    const modal = document.getElementById('manualEntryModal');
    if (modal) modal.style.display = 'none';
    // Note: We do NOT reload the historical text file. Historical state is persisted to JSON only.
}
async function submitManualEntry() {
    const numberInputs = Array.from(document.querySelectorAll('.main-number-input'));
    const powerballInput = document.getElementById('powerballInput');
    const dateSelect = document.getElementById('drawDate');
    const submitBtn = document.getElementById('submitNumbersBtn');
    // Double-submit guard
    window.__pbvNext = window.__pbvNext || {};
    if (window.__pbvNext.manualEntrySubmitting) return;
    window.__pbvNext.manualEntrySubmitting = true;
    try {
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.setAttribute('aria-busy', 'true');
            submitBtn.textContent = 'Saving...';
        }
        // Basic validation
        if (!dateSelect || !dateSelect.value) {
            showErrorToast('Please select the draw date.');
            return;
        }
        // Enforce: selected date must be STRICTLY before today (local)
        const selDate = new Date(dateSelect.value + 'T00:00:00');
        const today = new Date();
        const todayMidnight = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        if (!(selDate < todayMidnight)) {
            showErrorToast('Winning numbers can only be entered for draw dates strictly before today.');
            return;
        }
        const numbers = numberInputs.map(input => parseInt((input.value || '').trim(), 10));
        const powerball = parseInt((powerballInput?.value || '').trim(), 10);
        if (numbers.some(n => Number.isNaN(n)) || Number.isNaN(powerball)) {
            showErrorToast('Please enter all 5 main numbers and the Powerball.');
            return;
        }
        // Range + uniqueness
        if (numbers.some(n => n < 1 || n > 69)) {
            showErrorToast('Main numbers must be between 1 and 69.');
            return;
        }
        if (powerball < 1 || powerball > 26) {
            showErrorToast('Powerball must be between 1 and 26.');
            return;
        }
        const uniqueMain = new Set(numbers);
        if (uniqueMain.size !== numbers.length) {
            showErrorToast('Main numbers must be unique.');
            return;
        }
        // Normalize date to UTC midnight ISO string used throughout the app
        const dateObj = new Date(dateSelect.value + 'T00:00:00');
        const utcDate = new Date(dateObj.getTime() - dateObj.getTimezoneOffset() * 60000);
        const formattedDate = utcDate.toISOString().split('T')[0];
        // Upsert into historicalData as canonical schema: numbers = int[], powerball = int
        window.historicalData = Array.isArray(window.historicalData) ? window.historicalData : [];
        const idx = window.historicalData.findIndex(d => d && d.date === formattedDate);
        const entry = { date: formattedDate, numbers: numbers.slice().sort((a,b)=>a-b), powerball: Number(powerball) };
        if (idx >= 0) {
            window.historicalData[idx] = entry;
        } else {
            window.historicalData.push(entry);
        }
        window.historicalData.sort((a,b) => new Date(a.date) - new Date(b.date));
        // Persist ONLY to JSON (localStorage). Do NOT modify the backup text file.
        try {
            localStorage.setItem('pb_historicalDataJSON', JSON.stringify(window.historicalData));
            try { localStorage.setItem('pb_historicalData', JSON.stringify(window.historicalData)); } catch(e) {}
        } catch (e) {
            console.warn('Failed to persist historical JSON:', e);
            showErrorToast('Failed to save historical data to local JSON storage.');
            return;
        }
        // Ensure UI reflects loaded/ready state
        try { updateHistoricalLoadLight(true, 'JSON'); } catch(e) {}
        try { updateAutoSaveLight(true); } catch(e) {}
        // Success toast
        try { if (typeof showToast === 'function') showToast('Winning numbers saved to Historical Data JSON.', 'success'); } catch(e) {}
        // Remove current option and advance to next eligible past date (if any)
        try {
            const currentVal = dateSelect.value;
            const opt = dateSelect.querySelector(`option[value="${CSS && CSS.escape ? CSS.escape(currentVal) : currentVal}"]`);
            if (opt) opt.remove();
            // Clear balls for next entry
            try { hardClearManualEntryBalls(); } catch(e) {}
            try { (powerballInput && (powerballInput.value = '')); } catch(e) {}
            if (dateSelect.options.length > 0) {
                // Pick first remaining option (options are already restricted to eligible dates)
                dateSelect.selectedIndex = 0;
            } else {
                // No remaining eligible dates
                hideManualEntryForm();
            }
        } catch (e) {
            console.warn('Post-submit advance failed:', e);
            // At minimum, clear balls
            try { hardClearManualEntryBalls(); } catch(e) {}
        }
    } finally {
        // Release double-submit lock + restore button
        try { window.__pbvNext.manualEntrySubmitting = false; } catch(e) {}
        if (submitBtn) {
            submitBtn.removeAttribute('aria-busy');
            submitBtn.textContent = 'Submit Winning Numbers';
            try { updateManualEntrySubmitState(); } catch(e) {}
        }
    }
}
function triggerReloadUpdatedFile() {
    const reloadInput = document.createElement('input');
    reloadInput.type = 'file';
    reloadInput.accept = '.txt';
    reloadInput.style.display = 'none';
    reloadInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            loadManualDataDirectly(text);
            showSuccessPopup('Updated file reloaded successfully!');
        };
        reader.readAsText(file);
    });
    document.body.appendChild(reloadInput);
    reloadInput.click();
}
function loadManualDataDirectly(fileText) {
    try {
        const historicalDataSection = fileText.match(/\[historicalData\](.*?)\[previousPredictions\]/s);
        const previousPredictionsSection = fileText.match(/\[previousPredictions\](.*)$/s);
        if (!historicalDataSection || !previousPredictionsSection) {
            console.error('Invalid file format.');
            return;
        }
        window.historicalData = JSON.parse(`[${historicalDataSection[1].trim()}]`);
        // JSON is authoritative once initialized. Do NOT overwrite predictions from the legacy text file unless JSON has never been created.
        const __jsonPrimed = !!(window.__pbvNext && window.__pbvNext.predictionsJsonPrimed);
        const __jsonKeyExists = (()=>{ try { return localStorage.getItem('pb_previousPredictions') != null; } catch(e){ return false; } })();
        if (!__jsonPrimed && !__jsonKeyExists) {
          window.previousPredictions = JSON.parse(`[${previousPredictionsSection[1].trim()}]`);
        }
        console.log('Reloaded historical data:', window.historicalData.length, 'draws.');
    } catch (error) {
        console.error('Error parsing updated file:', error);
    }
}
function showSuccessPopup(message) {
    const popup = document.createElement('div');
    popup.textContent = message;
    popup.style.position = 'fixed';
    popup.style.top = '50%';
    popup.style.left = '50%';
    popup.style.transform = 'translate(-50%, -50%)';
    popup.style.background = 'linear-gradient(145deg, #2ecc71, #27ae60)';
    popup.style.color = 'white';
    popup.style.padding = '20px 40px';
    popup.style.fontSize = '20px';
    popup.style.borderRadius = '15px';
    popup.style.boxShadow = '0 5px 15px rgba(0,0,0,0.3)';
    popup.style.opacity = '0';
    popup.style.zIndex = '10000';
    popup.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
    document.body.appendChild(popup);
    setTimeout(() => {
        popup.style.opacity = '1';
        popup.style.transform = 'translate(-50%, -50%) scale(1.05)';
    }, 10);
    setTimeout(() => {
        popup.style.opacity = '0';
        popup.style.transform = 'translate(-50%, -50%) scale(0.95)';
    }, 2500);
    setTimeout(() => {
        document.body.removeChild(popup);
    }, 3000);
}
// v87: non-blocking centered error toast (no alert/confirm)
function showErrorToast(message) {
    try {
        const popup = document.createElement('div');
        popup.textContent = message;
        popup.style.position = 'fixed';
        popup.style.top = '50%';
        popup.style.left = '50%';
        popup.style.transform = 'translate(-50%, -50%)';
        popup.style.background = 'linear-gradient(145deg, #dc3545, #b02a37)';
        popup.style.color = 'white';
        popup.style.padding = '20px 40px';
        popup.style.fontSize = '18px';
        popup.style.borderRadius = '15px';
        popup.style.boxShadow = '0 5px 15px rgba(0,0,0,0.35)';
        popup.style.opacity = '0';
        popup.style.zIndex = '20000';
        popup.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
        document.body.appendChild(popup);
        setTimeout(() => {
            popup.style.opacity = '1';
            popup.style.transform = 'translate(-50%, -50%) scale(1.02)';
        }, 10);
        setTimeout(() => {
            popup.style.opacity = '0';
            popup.style.transform = 'translate(-50%, -50%) scale(0.98)';
        }, 2600);
        setTimeout(() => {
            try { document.body.removeChild(popup); } catch {}
        }, 3200);
    } catch (e) {
        // last resort; do not block with alert
        console.error('showErrorToast failed', e);
    }
}
function showAckPopup(message, opts = {}) {
    const title = opts.title || '';
    const buttonText = opts.buttonText || 'OK';
    return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.right = '0';
        overlay.style.bottom = '0';
        overlay.style.background = 'rgba(0,0,0,0.55)';
        overlay.style.zIndex = '20000';
        overlay.style.display = 'flex';
        overlay.style.alignItems = 'center';
        overlay.style.justifyContent = 'center';
        overlay.style.padding = '20px';
        const box = document.createElement('div');
        box.style.background = '#111';
        box.style.color = '#fff';
        box.style.maxWidth = '520px';
        box.style.width = '100%';
        box.style.borderRadius = '16px';
        box.style.boxShadow = '0 10px 30px rgba(0,0,0,0.35)';
        box.style.padding = '18px 18px 14px 18px';
        box.style.fontFamily = 'system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif';
        if (title) {
            const h = document.createElement('div');
            h.textContent = title;
            h.style.fontSize = '18px';
            h.style.fontWeight = '700';
            h.style.marginBottom = '10px';
            box.appendChild(h);
        }
        const body = document.createElement('div');
        body.textContent = message;
        body.style.fontSize = '15px';
        body.style.lineHeight = '1.35';
        body.style.marginBottom = '14px';
        box.appendChild(body);
        const btnRow = document.createElement('div');
        btnRow.style.display = 'flex';
        btnRow.style.justifyContent = 'flex-end';
        btnRow.style.gap = '10px';
        const ok = document.createElement('button');
        ok.textContent = buttonText;
        ok.style.background = 'linear-gradient(145deg, #2ecc71, #27ae60)';
        ok.style.color = '#fff';
        ok.style.border = 'none';
        ok.style.borderRadius = '999px';
        ok.style.padding = '10px 18px';
        ok.style.cursor = 'pointer';
        ok.style.fontSize = '14px';
        ok.style.fontWeight = '700';
        ok.addEventListener('click', () => {
            try { document.body.removeChild(overlay); } catch {}
            resolve(true);
        });
        btnRow.appendChild(ok);
        box.appendChild(btnRow);
        overlay.appendChild(box);
        document.body.appendChild(overlay);
        ok.focus();
    });
}
async function reloadHistoricalDataAndRefresh() {
    try {
        // Prefer re-reading the same file handle if available
        const handle = window.__pbvNext && window.__pbvNext.fileHandle;
        if (handle) {
            const file = await handle.getFile();
            const text = await file.text();
            if (typeof parseHistoryFile === 'function') {
                parseHistoryFile(text);
            } else if (typeof loadManualDataDirectly === 'function') {
                loadManualDataDirectly(text);
            }
            if (typeof persistToLocalStorage === 'function') persistToLocalStorage();
            location.reload();
            return;
        }
    } catch (e) {
        console.warn('Reload from file handle failed:', e);
    }
    // Fallback: prompt user to select the updated file, then refresh
    if (typeof triggerReloadUpdatedFile === 'function') {
        const original = window.showSuccessPopup;
        // triggerReloadUpdatedFile already shows success popup; we refresh after a short delay
        triggerReloadUpdatedFile();
        setTimeout(() => { try { location.reload(); } catch {} }, 800);
        return;
    }
}
/* ===== vNext Final Integration Patch (2025-12-24) =====
   - Fix manual entry (in-memory + localStorage + downloadable file)
   - Add missing exportToFile()
   - Lazy-load TensorFlow.js only when LSTM is used
*/
window.__pbvNext = window.__pbvNext || {};
window.__pbvNext.loadedFileName = window.__pbvNext.loadedFileName || "Powerball Numbers (updated).txt";
function ensureTFJSLoaded() {
  return new Promise((resolve, reject) => {
    if (window.tf) return resolve();
    const existing = document.querySelector('script[data-tfjs="1"]');
    if (existing) { existing.addEventListener('load', resolve); existing.addEventListener('error', reject); return; }
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/@tensorflow/tfjs';
    s.defer = true;
    s.dataset.tfjs = "1";
    s.onload = () => resolve();
    s.onerror = () => reject(new Error('Failed to load TensorFlow.js'));
    document.head.appendChild(s);
  });
}
function buildHistoryTxt() {
  const hist = Array.isArray(window.historicalData) ? window.historicalData : [];
  const prev = Array.isArray(window.previousPredictions) ? window.previousPredictions : [];
  const histJson = JSON.stringify(hist, null, 2);
  const prevLines = prev.map(r => JSON.stringify(r)).join("\n");
  return `[historicalData]\n\n${histJson.slice(1, -1)}\n\n[previousPredictions]\n${prevLines}\n`;
}
function downloadTextFile(filename, content) {
  const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(() => { URL.revokeObjectURL(url); document.body.removeChild(a); }, 0);
}
function persistToLocalStorage() {
  try {
    localStorage.setItem('pb_historicalData', JSON.stringify(window.historicalData || []));
    localStorage.setItem('pb_previousPredictions', JSON.stringify(window.previousPredictions || []));
    localStorage.setItem('pb_loadedFileName', window.__pbvNext.loadedFileName || "Powerball Numbers (updated).txt");
  } catch (e) {}
}
// ===== v94: Previous Predictions JSON Persistence Controls =====
function downloadJSONFile(filename, obj) {
  try {
    const content = JSON.stringify(obj, null, 2);
    const blob = new Blob([content], { type: 'application/json;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => { URL.revokeObjectURL(url); document.body.removeChild(a); }, 0);
  } catch (e) {
    console.warn('downloadJSONFile failed', e);
  }
}
function getPredictionsJsonFilename() {
  const d = document.getElementById('startDate') || document.getElementById('drawDate');
  const dateKey = (d && d.value ? new Date(d.value) : new Date()).toISOString().split('T')[0];
  return `powerball_previous_predictions_${dateKey}.json`;
}
function exportPreviousPredictionsJSON(isAutoBackup) {
  window.previousPredictions = Array.isArray(window.previousPredictions) ? window.previousPredictions : [];
  try { _ppEnsureRanksAndTop5PerDate(); } catch(e) {}
  const payload = {
    schema: "pb.previousPredictions.v1",
    exportedAt: new Date().toISOString(),
    count: window.previousPredictions.length,
    previousPredictions: window.previousPredictions
  };
  const fname = isAutoBackup ? getPredictionsJsonBackupFilename() : getPredictionsJsonFilename();
  downloadJSONFile(fname, payload);
  try {
    if (!isAutoBackup) showToast('Predictions exported as JSON.', 'success');
  } catch(e) {}
}
function importPreviousPredictionsJSONFromObject(obj) {
  if (!obj) throw new Error('Empty JSON payload');
  const arr = Array.isArray(obj.previousPredictions) ? obj.previousPredictions : (Array.isArray(obj) ? obj : null);
  if (!arr) throw new Error('JSON does not contain previousPredictions array.');
  window.previousPredictions = arr;
  try { _ppEnsureRanksAndTop5PerDate(); } catch(e) {}
  try { _ppRecomputeAllMatches(); } catch(e) {}
  try { persistToLocalStorage(); } catch(e) {}
  try { window.__pbvNext = window.__pbvNext || {}; window.__pbvNext.predictionsJsonPrimed = true; } catch(e) {}
try { renderPreviousPredictionsHistoryTable(); } catch(e) {}
  try {
    const d = document.getElementById('startDate') || document.getElementById('drawDate');
    const key = (d && d.value ? new Date(d.value) : new Date()).toISOString().split('T')[0];
    renderPreviousPredictionsMiniTable(key);
    try { _ppWireToggleOnce(); } catch(e) {}
    try { wirePreviousPredictionsJsonControlsOnce(); } catch(e) {}
    try { renderPreviousPredictionsHistoryTable(); } catch(e) {}
  } catch(e) {}
}
function importPreviousPredictionsJSONFile(file) {
  return new Promise((resolve, reject) => {
    try {
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const raw = reader.result || '';
          const obj = JSON.parse(raw);
          importPreviousPredictionsJSONFromObject(obj);
          try { showToast('Predictions imported from JSON.', 'success'); } catch(e) {}
          resolve(true);
        } catch (e) { reject(e); }
      };
      reader.onerror = () => reject(new Error('Failed to read JSON file.'));
      reader.readAsText(file);
    } catch (e) { reject(e); }
  });
}
function clearAllPreviousPredictions() {
  window.previousPredictions = [];
  try { persistToLocalStorage(); } catch(e) {}
  try { window.__pbvNext = window.__pbvNext || {}; window.__pbvNext.predictionsJsonPrimed = true; } catch(e) {}
try { renderPreviousPredictionsHistoryTable(); } catch(e) {}
  try {
    const d = document.getElementById('startDate') || document.getElementById('drawDate');
    const key = (d && d.value ? new Date(d.value) : new Date()).toISOString().split('T')[0];
    renderPreviousPredictionsMiniTable(key);
  } catch(e) {}
  try { showToast('All previous predictions cleared. You are starting fresh.', 'success'); } catch(e) {}
}
function wirePreviousPredictionsJsonControlsOnce() {
  const exportBtn = document.getElementById('ppExportJsonBtn');
  const importBtn = document.getElementById('ppImportJsonBtn');
  const deleteSelBtn = document.getElementById('ppDeleteSelectedBtn');
  const deleteAllBtn = document.getElementById('ppDeleteAllBtn');
  const input = document.getElementById('ppImportJsonInput');
  if (exportBtn && !exportBtn.__wired) {
    exportBtn.__wired = true;
    exportBtn.addEventListener('click', () => exportPreviousPredictionsJSON());
  }
  if (importBtn && !importBtn.__wired) {
    importBtn.__wired = true;
    importBtn.addEventListener('click', () => { if (input) input.click(); });
  }
  if (input && !input.__wired) {
    input.__wired = true;
    input.addEventListener('change', async (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      try {
        await importPreviousPredictionsJSONFile(f);
      } catch (err) {
        console.warn('Import Predictions JSON failed', err);
        try { showToast('Import failed: ' + (err && err.message ? err.message : 'Unknown error'), 'error'); } catch(e) {}
      } finally {
        try { input.value = ''; } catch(e) {}
      }
    });
  }
  if (deleteSelBtn && !deleteSelBtn.__wired) {
    deleteSelBtn.__wired = true;
    deleteSelBtn.addEventListener('click', () => {
      const visibleIds = (window.__pbvNext && window.__pbvNext.ppVisibleIds) ? window.__pbvNext.ppVisibleIds : [];
      deleteSelectedPreviousPredictions(visibleIds);
    });
  }
  if (deleteAllBtn && !deleteAllBtn.__wired) {
    deleteAllBtn.__wired = true;
    deleteAllBtn.addEventListener('click', () => {
      deleteAllPreviousPredictions();
    });
  }
  try { _ppWireSectionVisibleToggleOnce(); } catch(e) {}
}
// =========================
// Enhancement #2 Helpers: Previous Predictions overwrite rules + mini table rendering
// Rules:
// - Overwrites are allowed for the SAME drawDate + SAME method only (last run wins)
// - No more than 5 games per method per date (extra games are discarded)
// =========================
function _ppNormMethod(method) {
  const m = (method || '').toString().trim();
  return m.length ? m : 'Unknown';
}
function upsertPreviousPredictionsRun(drawDateKey, method, runId, records) {
  window.previousPredictions = Array.isArray(window.previousPredictions) ? window.previousPredictions : [];
  const m = _ppNormMethod(method);
  // Keep at most 5 per method per date per RUN (runId). History should retain older runs.
  const limited = Array.isArray(records) ? records.slice(0, 5) : [];
  // Enforce ranks (Top 1..Top 5) within this run
  for (let i = 0; i < limited.length; i++) {
    try { limited[i].rank = i + 1; } catch(e) {}
    try { limited[i].runId = (limited[i].runId || runId); } catch(e) {}
    try { limited[i].slipId = (limited[i].slipId || runId); } catch(e) {}
    try { limited[i].method = _ppNormMethod(limited[i].method || m); } catch(e) {}
    try { limited[i].drawDate = drawDateKey; } catch(e) {}
  }
  // Remove any existing records for the SAME drawDate+method+runId (idempotent overwrite of that run only)
  window.previousPredictions = window.previousPredictions.filter(r => {
    if (!r) return false;
    const rk = _ppDateKey(r.drawDate || r.date);
    const rm = _ppNormMethod(r.method);
    const rr = (r.slipId || r.runId || null);
    return !(rk === drawDateKey && rm === m && rr === runId);
  });
  // Add newest first
  for (let i = limited.length - 1; i >= 0; i--) {
    window.previousPredictions.unshift(limited[i]);
  }
  // Global safety cap (prevent unbounded growth)
  const MAX_TOTAL = 5000;
  if (window.previousPredictions.length > MAX_TOTAL) {
    window.previousPredictions = window.previousPredictions.slice(0, MAX_TOTAL);
  }
  try { persistToLocalStorage(); } catch(e) {}
  try { window.__pbvNext = window.__pbvNext || {}; window.__pbvNext.predictionsJsonPrimed = true; } catch(e) {}
}
function renderPreviousPredictionsMiniTable(drawDateKey) {
  const wrap = document.getElementById('slipSavedMiniWrap');
  const tbody = document.getElementById('slipSavedMiniTbody');
  if (!wrap || !tbody) return;
  const all = Array.isArray(window.previousPredictions) ? window.previousPredictions : [];
  try { _ppEnsureRanksAndTop5PerDate(); } catch(e) {}
  try { _ppRecomputeAllMatches(); } catch(e) {}
  const rows = all.filter(r => r && r.drawDate === drawDateKey);
  if (!rows.length) {
    tbody.innerHTML = '<tr><td colspan="6" style="padding:10px 8px; color:#666;">No saved predictions found for this draw date.</td></tr>';
    wrap.style.display = 'block';
    return;
  }
  // Determine latest run (per method) based on createdAt
  const latestRunByMethod = {};
  for (const r of rows) {
    const m = _ppNormMethod(r.method);
    const ts = Date.parse(r.createdAt || '') || 0;
    const prev = latestRunByMethod[m];
    if (!prev || ts > prev.ts) {
      latestRunByMethod[m] = { ts, runId: (r.slipId || r.runId || null) };
    }
  }
  // Collect only rows from the latest run for each method
  const latestRows = rows.filter(r => {
    const m = _ppNormMethod(r.method);
    const runId = (r.slipId || r.runId || null);
    return latestRunByMethod[m] && latestRunByMethod[m].runId === runId;
  });
  // Sort for readability
  latestRows.sort((a,b) => {
    const am = _ppNormMethod(a.method);
    const bm = _ppNormMethod(b.method);
    if (am < bm) return -1;
    if (am > bm) return 1;
    return (Number(a.gameIndex)||0) - (Number(b.gameIndex)||0);
  });
  const escapeHtml = (s) => String(s ?? '').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));
  tbody.innerHTML = latestRows.map(r => {
    const nums = Array.isArray(r.numbers) ? r.numbers.join(', ') : '';
    const pb = Number.isFinite(r.powerball) ? r.powerball : '';
    const histReady = !!(window.__pbvNext && window.__pbvNext.historicalDataLoaded);
    const dk = _ppDateKey(r.drawDate || r.date) || drawDateKey;
    const actual = _ppGetActualByDateKey(dk);
    const status = r.status || (actual ? 'RESOLVED' : (histReady ? 'PENDING' : 'SAVED'));
    const matches = (r.matchCategory ? r.matchCategory : ((r.matchMain != null || r.matchPB != null) ? String((r.matchMain||0)) + (r.matchPB ? ' + PB' : '') : ''));
    return `<tr>
      <td style="padding:6px 8px; border-bottom:1px solid #eee;">${escapeHtml(_ppNormMethod(r.method))}</td>
      <td style="padding:6px 8px; border-bottom:1px solid #eee;">${escapeHtml(r.gameIndex ?? '')}</td>
      <td style="padding:6px 8px; border-bottom:1px solid #eee;">${escapeHtml(nums)}</td>
      <td style="padding:6px 8px; border-bottom:1px solid #eee;">${escapeHtml(pb)}</td>
      <td style="padding:6px 8px; border-bottom:1px solid #eee;">${escapeHtml(status)}</td>
      <td style="padding:6px 8px; border-bottom:1px solid #eee;">${escapeHtml(matches)}</td>
    </tr>`;
  }).join('');
  wrap.style.display = 'block';
}
// ===== Previous Predictions v93: Top-5 per Draw Date + Pending/Full Toggle + Match Categories =====
function _ppDateKey(d) {
  try {
    if (!d) return null;
    const s = String(d).trim();
    if (!s) return null;
    // If already ISO date key
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    const dt = new Date(s);
    if (isNaN(dt.getTime())) return null;
    return dt.toISOString().split('T')[0];
  } catch (e) { return null; }
}
function _ppGetActualByDateKey(dateKey) {
  const dk = _ppDateKey(dateKey);
  const hist = Array.isArray(window.historicalData) ? window.historicalData : [];
  if (!dk || !hist.length) return null;
  // historicalData is sorted ascending, but scan linearly (dataset is small)
  for (let i = 0; i < hist.length; i++) {
    const h = hist[i];
    const hd = _ppDateKey(h.date || h.drawDate || h.drawingDate || h.Date);
    if (hd === dk) {
      return {
        drawDate: dk,
        numbers: Array.isArray(h.numbers) ? h.numbers.map(Number) : [],
        powerball: Number(h.powerball != null ? h.powerball : (h.pb != null ? h.pb : h.special))
      };
    }
  }
  return null;
}
function _ppIsPendingDrawDate(dateKey) {
  return !_ppGetActualByDateKey(dateKey);
}
function _ppClassifyMatch(mainMatches, pbMatch) {
  const m = Number(mainMatches) || 0;
  const pb = !!pbMatch;
  // Precedence is required to keep categories mutually exclusive.
  if (m === 5 && pb) return 'Jackpot';
  if (m >= 3 && pb) return 'Paid Match: 3+ Main + Powerball';
  if (m >= 2 && pb) return 'Paid Match: 2+ Main + Powerball';
  if (m >= 3 && !pb) return 'Paid Match: 3+ Main (No Powerball)';
  if (m === 0 && pb) return 'Paid Match: Powerball Only';
  if (m > 0 && !pb) return 'No Prize (Main Only)';
  return 'No Match';
}
function _ppCountMainMatches(predMain, actualSet) {
  let c = 0;
  for (let i = 0; i < predMain.length; i++) {
    const n = Number(predMain[i]);
    if (actualSet.has(n)) c++;
  }
  return c;
}
function _ppRecomputeOneMatch(rec) {
  const dk = _ppDateKey(rec.drawDate || rec.date);
  const actual = _ppGetActualByDateKey(dk);
  if (!actual) {
    rec.status = ((window.__pbvNext && window.__pbvNext.historicalDataLoaded) ? 'PENDING' : 'SAVED');
    rec.matchMain = null;
    rec.matchPB = null;
    rec.matchCategory = '';
    return rec;
  }
  const winSet = new Set((actual.numbers || []).map(Number));
  const predMain = Array.isArray(rec.numbers) ? rec.numbers.map(Number) : [];
  const mainMatches = _ppCountMainMatches(predMain, winSet);
  const pbMatch = (Number(rec.powerball) === Number(actual.powerball));
  rec.status = 'RESOLVED';
  rec.matchMain = mainMatches;
  rec.matchPB = pbMatch;
  rec.matchCategory = _ppClassifyMatch(mainMatches, pbMatch);
  rec.actualPowerball = Number(actual.powerball);
  rec.actualNumbers = (actual.numbers || []).map(Number);
  return rec;
}
function _ppRecomputeAllMatches() {
  window.previousPredictions = Array.isArray(window.previousPredictions) ? window.previousPredictions : [];
  for (let i = 0; i < window.previousPredictions.length; i++) {
    const r = window.previousPredictions[i];
    if (!r) continue;
    _ppRecomputeOneMatch(r);
  }
}
function _ppEnsureRanksAndTop5PerDate() {
  // Enforce: each drawDate + method + runId contains at most 5 rows, with rank 1..5.
  // NOTE: We intentionally do NOT collapse older runs; History should retain prior slips.
  const all = Array.isArray(window.previousPredictions) ? window.previousPredictions : [];
  const groups = {};
  for (const r of all) {
    if (!r) continue;
    const dk = _ppDateKey(r.drawDate || r.date);
    const m = _ppNormMethod(r.method);
    const run = (r.slipId || r.runId || r.id || 'run');
    if (!dk) continue;
    const key = dk + '||' + m + '||' + run;
    if (!groups[key]) groups[key] = [];
    groups[key].push(r);
  }
  const keep = [];
  Object.keys(groups).forEach(key => {
    const arr = groups[key] || [];
    // Prefer explicit rank, else gameIndex, else createdAt recency
    arr.sort((a,b)=>{
      const ra = (a.rank != null ? Number(a.rank) : (a.gameIndex != null ? Number(a.gameIndex) : 999));
      const rb = (b.rank != null ? Number(b.rank) : (b.gameIndex != null ? Number(b.gameIndex) : 999));
      if (ra !== rb) return ra - rb;
      const ta = Date.parse(a.createdAt || '') || 0;
      const tb = Date.parse(b.createdAt || '') || 0;
      return tb - ta;
    });
    const limited = arr.slice(0,5);
    for (let i = 0; i < limited.length; i++) {
      try { limited[i].rank = i + 1; } catch(e) {}
    }
    keep.push(...limited);
  });
  // Preserve overall recency ordering (newest first) while keeping only the normalized "keep" set.
  // Since keep is reconstructed, we rebuild window.previousPredictions in recency order.
  keep.sort((a,b)=>{
    const ta = Date.parse(a.createdAt || '') || 0;
    const tb = Date.parse(b.createdAt || '') || 0;
    return tb - ta;
  });
  window.previousPredictions = keep;
}
// ===== v94b: Previous Predictions row selection + delete controls =====
function _ppEnsureIds() {
  window.previousPredictions = Array.isArray(window.previousPredictions) ? window.previousPredictions : [];
  for (const r of window.previousPredictions) {
    if (!r) continue;
    if (r._ppid) continue;
    const dk = _ppDateKey(r.drawDate || r.date) || '';
    const m = _ppNormMethod(r.method);
    const rank = (r.rank != null ? Number(r.rank) : (r.gameIndex != null ? Number(r.gameIndex) : ''));
    const nums = Array.isArray(r.numbers) ? r.numbers.map(Number).join('-') : '';
    const __pbv = (r.powerball != null ? r.powerball : (r.special != null ? r.special : null));
    const pb = (__pbv != null && isFinite(Number(__pbv))) ? Number(__pbv) : '';
    const ca = (r.createdAt || r.runId || '').toString();
    r._ppid = [dk, m, rank, nums, pb, ca].join('|');
  }
}
function _ppGetSelectionMap() {
  window.__pbvNext = window.__pbvNext || {};
  window.__pbvNext.ppSelected = window.__pbvNext.ppSelected || {};
  return window.__pbvNext.ppSelected;
}
function _ppSetSelected(id, on) {
  if (!id) return;
  const sel = _ppGetSelectionMap();
  if (on) sel[id] = true; else delete sel[id];
}
function _ppClearVisibleSelection(visibleIds) {
  const sel = _ppGetSelectionMap();
  (visibleIds || []).forEach(id => { try { delete sel[id]; } catch(e) {} });
}
function deleteSelectedPreviousPredictions(visibleIds) {
  const sel = _ppGetSelectionMap();
  const ids = Object.keys(sel || {});
  if (!ids.length) {
    try { showToast('No rows selected.', 'info'); } catch(e) {}
    return;
  }
  window.previousPredictions = (Array.isArray(window.previousPredictions) ? window.previousPredictions : []).filter(r => {
    if (!r) return false;
    return !sel[r._ppid];
  });
  // Clear selection for visible set (and any that no longer exist)
  try { _ppClearVisibleSelection(visibleIds); } catch(e) {}
  try { persistToLocalStorage(); } catch(e) {}
  try { window.__pbvNext = window.__pbvNext || {}; window.__pbvNext.predictionsJsonPrimed = true; } catch(e) {}
try { renderPreviousPredictionsHistoryTable(); } catch(e) {}
  try {
    const d = document.getElementById('startDate') || document.getElementById('drawDate');
    const key = (d && d.value ? new Date(d.value) : new Date()).toISOString().split('T')[0];
    renderPreviousPredictionsMiniTable(key);
  } catch(e) {}
  try { showToast('Selected previous predictions deleted.', 'success'); } catch(e) {}
}
function deleteAllPreviousPredictions() {
  window.previousPredictions = [];
  try {
    const sel = _ppGetSelectionMap();
    Object.keys(sel).forEach(k => delete sel[k]);
  } catch(e) {}
  try { persistToLocalStorage(); } catch(e) {}
  try { window.__pbvNext = window.__pbvNext || {}; window.__pbvNext.predictionsJsonPrimed = true; } catch(e) {}
try { exportPreviousPredictionsJSON(true); } catch(e) {}
  try { renderPreviousPredictionsHistoryTable(); } catch(e) {}
  try {
    const d = document.getElementById('startDate') || document.getElementById('drawDate');
    const key = (d && d.value ? new Date(d.value) : new Date()).toISOString().split('T')[0];
    renderPreviousPredictionsMiniTable(key);
  } catch(e) {}
  try { showToast('All previous predictions deleted. You are starting fresh.', 'success'); } catch(e) {}
}
function _ppWireSectionVisibleToggleOnce() {
  const cb = document.getElementById('ppSectionVisibleToggle');
  const wrap = document.getElementById('ppHistoryWrap');
  const mini = document.getElementById('slipSavedMiniTable');
  const ctrl = document.getElementById('ppJsonControlsRow');
  const summaryRow = document.getElementById('ppSummaryPill') ? document.getElementById('ppSummaryPill').parentElement : null;
  if (!cb || cb.__wired) return;
  cb.__wired = true;
  const apply = () => {
    const on = !!cb.checked;
    if (wrap) wrap.style.display = on ? 'block' : 'none';
    if (mini) mini.parentElement.style.display = on ? 'block' : 'none';
    if (ctrl) ctrl.style.display = on ? 'flex' : 'none';
    if (summaryRow) summaryRow.style.display = on ? 'flex' : 'none';
  };
  cb.addEventListener('change', apply);
  apply();
}
function renderPreviousPredictionsHistoryTable() {
  const wrap = document.getElementById('ppHistoryWrap');
  const tbody = document.getElementById('ppHistoryTbody');
  const toggle = document.getElementById('ppShowAllToggle');
  const pill = document.getElementById('ppSummaryPill');
  if (!wrap || !tbody) return;
  const showAll = !!(toggle && toggle.checked);
  window.__pbvNext = window.__pbvNext || {};
  window.__pbvNext.ppShowAll = showAll;
  const all = Array.isArray(window.previousPredictions) ? window.previousPredictions : [];
  try { _ppEnsureRanksAndTop5PerDate(); } catch(e) {}
  try { _ppRecomputeAllMatches(); } catch(e) {}
  const filtered = showAll ? all : all.filter(r => _ppIsPendingDrawDate(_ppDateKey(r.drawDate || r.date)));
  const histReadyCount = !!(window.__pbvNext && window.__pbvNext.historicalDataLoaded);
  // Banner: warn when historical results are not loaded (statuses shown as SAVED)
  try {
    const banner = document.getElementById('ppHistBanner');
    if (banner) {
      banner.style.display = histReadyCount ? 'none' : 'block';
    }
  } catch(e) {}
  const total = all.length;
  const pending = histReadyCount ? all.filter(r => _ppIsPendingDrawDate(_ppDateKey(r.drawDate || r.date))).length : 0;
  const resolved = histReadyCount ? (total - pending) : 0;
  const savedOnly = histReadyCount ? 0 : total;
  if (pill) pill.textContent = histReadyCount ? ('Rows: ' + filtered.length + ' (Pending: ' + pending + ', Resolved: ' + resolved + ', Total: ' + total + ')') : ('Rows: ' + filtered.length + ' (Saved: ' + savedOnly + ', Total: ' + total + ')');
  if (!filtered.length) {
    tbody.innerHTML = '<tr><td colspan="8" style="padding:10px 8px; color:#666;">' + (showAll ? 'No previous predictions found.' : 'No pending previous predictions found.') + '</td></tr>';
    wrap.style.display = 'block';
    return;
  }
  const esc = (s) => String(s == null ? '' : s).replace(/[&<>"']/g, function(ch){
    return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]);
  });
  const rows = filtered.slice().sort((a,b)=>{
    const da = _ppDateKey(a.drawDate || a.date) || '';
    const db = _ppDateKey(b.drawDate || b.date) || '';
    if (da !== db) return da < db ? 1 : -1;
    const am = _ppNormMethod(a.method);
    const bm = _ppNormMethod(b.method);
    if (am !== bm) return am < bm ? -1 : 1;
    return (Number(a.rank)||0) - (Number(b.rank)||0);
  });
  tbody.innerHTML = rows.map(r => {
    const dk = _ppDateKey(r.drawDate || r.date) || '';
    const nums = Array.isArray(r.numbers) ? r.numbers.join(', ') : '';
    const __pbv = (r.powerball != null ? r.powerball : (r.special != null ? r.special : null));
    const pb = (__pbv != null && isFinite(Number(__pbv))) ? Number(__pbv) : '';
    const histReady = !!(window.__pbvNext && window.__pbvNext.historicalDataLoaded);
    const actual = _ppGetActualByDateKey(dk);
    const status = r.status || (actual ? 'RESOLVED' : (histReady ? 'PENDING' : 'SAVED'));
    const cat = r.matchCategory || '';
    const rank = (r.rank != null ? Number(r.rank) : (r.gameIndex != null ? Number(r.gameIndex) : ''));
    // Ensure every row has a stable id for selection/checkbox logic (new JSON slip records use `id`, legacy uses `_ppid`)
    const _rid = (r._ppid || r.id || `${dk}|${_ppNormMethod(r.method)}|${rank}|${nums}|${pb}`);
    if (!r._ppid) r._ppid = _rid;
    return '<tr>' +
      '<td style="padding:6px 8px; border-bottom:1px solid #eee; text-align:center;">' +'<input class="ppRowSel" type="checkbox" data-ppid="' + esc(r._ppid||'') + '" ' +( (_ppGetSelectionMap()[r._ppid]) ? 'checked' : '' ) +' style="transform:scale(1.05);" />' +'</td>' +
      '<td style="padding:6px 8px; border-bottom:1px solid #eee; white-space:nowrap;">' + esc(dk) + '</td>' +
      '<td style="padding:6px 8px; border-bottom:1px solid #eee;">' + esc(_ppNormMethod(r.method)) + '</td>' +
      '<td style="padding:6px 8px; border-bottom:1px solid #eee;">' + esc(rank) + '</td>' +
      '<td style="padding:6px 8px; border-bottom:1px solid #eee;">' + esc(nums) + '</td>' +
      '<td style="padding:6px 8px; border-bottom:1px solid #eee;">' + esc(pb) + '</td>' +
      '<td style="padding:6px 8px; border-bottom:1px solid #eee;">' + esc(status) + '</td>' +
      '<td style="padding:6px 8px; border-bottom:1px solid #eee;">' + esc(cat) + '</td>' +
    '</tr>';
  }).join('');
  // Wire row selection
  const visibleIds = rows.map(r => r._ppid).filter(Boolean);
  window.__pbvNext = window.__pbvNext || {};
  window.__pbvNext.ppVisibleIds = visibleIds;
  const selAll = document.getElementById('ppSelectAll');
  if (selAll) {
    const sel = _ppGetSelectionMap();
    const allOn = visibleIds.length && visibleIds.every(id => !!sel[id]);
    selAll.checked = !!allOn;
    selAll.indeterminate = !!(visibleIds.length && !allOn && visibleIds.some(id => !!sel[id]));
    if (!selAll.__wired) {
      selAll.__wired = true;
      selAll.addEventListener('change', function() {
        const on = !!selAll.checked;
        visibleIds.forEach(id => _ppSetSelected(id, on));
        try { renderPreviousPredictionsHistoryTable(); } catch(e) {}
      });
    }
  }
  Array.from(tbody.querySelectorAll('input.ppRowSel')).forEach(cb => {
    if (cb.__wired) return;
    cb.__wired = true;
    cb.addEventListener('change', function() {
      const id = cb.getAttribute('data-ppid');
      _ppSetSelected(id, !!cb.checked);
      // Update header checkbox state without full rerender
      try {
        const sel = _ppGetSelectionMap();
        const allOnNow = visibleIds.length && visibleIds.every(x => !!sel[x]);
        if (selAll) {
          selAll.checked = !!allOnNow;
          selAll.indeterminate = !!(visibleIds.length && !allOnNow && visibleIds.some(x => !!sel[x]));
        }
      } catch(e) {}
    });
  });
  wrap.style.display = 'block';
}
function _ppWireToggleOnce() {
  const toggle = document.getElementById('ppShowAllToggle');
  if (!toggle || toggle.__wired) return;
  toggle.__wired = true;
  // restore prior state (localStorage -> window.__pbvNext -> default)
  try {
    const pref = localStorage.getItem('pb_ppShowAll');
    if (pref != null) {
      toggle.checked = (pref === '1');
    } else if (window.__pbvNext && window.__pbvNext.ppShowAll != null) {
      toggle.checked = !!window.__pbvNext.ppShowAll;
    }
  } catch(e) {}
  toggle.addEventListener('change', function(){
    try {
      localStorage.setItem('pb_ppShowAll', toggle.checked ? '1' : '0');
    } catch(e) {}
    try { renderPreviousPredictionsHistoryTable(); } catch(e) {}
  });
}
function setSlipSaveStatusLine(msg, isError=false) {
  const el = document.getElementById('slipSaveStatus');
  if (!el) return;
  el.style.display = 'block';
  el.style.color = isError ? '#b00020' : '#0b6623';
  el.textContent = msg;
}
function updateAutoSaveLight(isConnectedReadWrite) {
  const light = document.getElementById('autoSaveLight');
  if (!light) return;
  // states:
  // - green: connected read/write and auto-save will work
  // - yellow: File System Access API exists but not granted read/write
  // - red: classic file upload (read-only) or not connected
  const apiAvailable = !!window.showOpenFilePicker;
  let color = '#cc0000';
  let title = 'Auto-save not connected (read-only)';
  if (apiAvailable && window.__pbvNext && window.__pbvNext.fileHandle) {
    if (isConnectedReadWrite) {
      color = '#2ecc71';
      title = 'Auto-save connected (read/write)';
    } else {
      color = '#f1c40f';
      title = 'Auto-save available but permission not granted (read-only)';
    }
  } else if (!apiAvailable) {
    color = '#cc0000';
    title = 'Auto-save not supported by this browser (read-only)';
  }
  light.style.background = color;
  light.title = title;
}
function updateTemplateLoadLight(isLoaded) {
  const light = document.getElementById('templateLoadLight');
  if (!light) return;
  if (isLoaded) {
    light.style.background = '#2ecc71';
    light.title = 'Template PDF loaded';
  } else {
    light.style.background = '#cc0000';
    light.title = 'Template PDF not loaded';
  }
}
// Historical Data Load Indicator (reuses the small status light near controls)
function updateHistoricalLoadLight(isLoaded, sourceLabel) {
  const light = document.getElementById('autoSaveLight');
  if (!light) return;
  if (isLoaded) {
    light.style.background = '#2ecc71';
    light.title = `Historical data loaded${sourceLabel ? ' (' + sourceLabel + ')' : ''}`;
  } else {
    light.style.background = '#cc0000';
    light.title = 'Historical data not loaded';
  }
}
function hydrateFromLocalStorage() {
  try {
    const h = localStorage.getItem('pb_historicalData');
    const p = localStorage.getItem('pb_previousPredictions');
    const n = localStorage.getItem('pb_loadedFileName');
    // Enhancement #7 (Stage A): JSON-first Historical Data autoload (Text→JSON bootstrap happens via Load button)
    const hj = localStorage.getItem('pb_historicalDataJSON');
    if (hj) {
      try {
        const parsed = JSON.parse(hj);
        if (Array.isArray(parsed) && parsed.length) {
          window.historicalData = parsed;
          // Back-compat: keep legacy key in sync for any older routines that still read it.
          try { localStorage.setItem('pb_historicalData', JSON.stringify(parsed)); } catch(e) {}
          window.__pbvNext = window.__pbvNext || {};
          window.__pbvNext.historicalDataLoaded = true;
          // UI: hide load button once JSON controls history (text becomes backup-only)
          try {
            const loadBtn = document.getElementById('loadDataBtn');
            if (loadBtn) {
              loadBtn.disabled = true;
              loadBtn.style.display = 'none';
            }
          } catch(e) {}
          // UI: show green status (JSON authoritative)
          try { if (typeof updateHistoricalLoadLight === 'function') updateHistoricalLoadLight(true, 'JSON'); } catch(e) {}
          // Enhancement #7 Stage A: JSON autoload must trigger the same UI unlocks as a successful text-file load.
          try {
            const controlsContainer = document.getElementById('controls-container');
            if (controlsContainer) controlsContainer.style.display = 'block';
          } catch(e) {}
          // Ensure Play Slip / Previous Predictions areas are not blocked by legacy "must load history" gating.
          try {
            const genBtn = document.getElementById('generateNumbersBtn') || document.getElementById('generateBtn');
            if (genBtn) { genBtn.disabled = false; genBtn.removeAttribute('disabled'); genBtn.style.opacity='1'; genBtn.style.cursor='pointer'; genBtn.title=''; }
          } catch(e) {}
          try {
            const meBtn = document.getElementById('manualEntryBtn');
            if (meBtn) { meBtn.disabled = false; meBtn.removeAttribute('disabled'); meBtn.style.pointerEvents='auto'; meBtn.style.opacity='1'; meBtn.title=''; }
          } catch(e) {}
          // If previous predictions exist, ensure the mini-table wrapper is visible (requires the controls container to be visible too).
          try {
            const cnt = Array.isArray(window.previousPredictions) ? window.previousPredictions.length : 0;
            if (cnt > 0) {
              const wrap = document.getElementById('slipSavedMiniWrap');
              if (wrap) wrap.style.display = 'block';
            }
          } catch(e) {}
          // Status light must reflect JSON history being loaded.
          try { if (typeof updateHistoricalLoadLight === 'function') updateHistoricalLoadLight(true, 'JSON'); } catch(e) {}
// Recompute gating + enable manual entry / generate immediately
          // Ensure Previous Predictions tables render (visible immediately when saved data exists)
          try { if (typeof renderPreviousPredictionsHistoryTable === 'function') renderPreviousPredictionsHistoryTable(); } catch(e) {}
          try {
            const d = document.getElementById('startDate') || document.getElementById('drawDate');
            const key = (d && d.value ? new Date(d.value) : new Date()).toISOString().split('T')[0];
            if (typeof renderPreviousPredictionsMiniTable === 'function') renderPreviousPredictionsMiniTable(key);
          } catch(e) {}
          try {
            if (window.__pbvNext && typeof window.__pbvNext.updateGenerateButtonState === 'function') {
              window.__pbvNext.updateGenerateButtonState();
            }
          } catch(e) {}
          // Toast: confirm JSON autoload
          try {
            if (typeof showToast === 'function') showToast(`Historical data loaded from JSON (${parsed.length} draw${parsed.length===1?'':'s'}).`, 'success');
            else if (typeof showSuccessPopup === 'function') showSuccessPopup(`Historical data loaded from JSON (${parsed.length}).`);
          } catch(e) {}
        }
      } catch(e) {
        // If JSON is corrupt, ignore and allow user to load the backup text file.
        try { if (typeof showErrorToast === 'function') showErrorToast('Historical Data JSON found but could not be parsed. Please use Load Historical Data to re-import the backup text file.'); } catch(_) {}
      }
    } else {
      // No JSON present yet: keep Load button available for one-time Text→JSON bootstrap.
      try { if (typeof updateHistoricalLoadLight === 'function') updateHistoricalLoadLight(false); } catch(e) {}
      try {
        if (typeof showToast === 'function') {
          showToast('Historical data JSON not found. Click “Load Historical Data” once to import the backup text file.', 'info');
        }
      } catch(e) {}
    }
    if (h) {
      try { window.historicalData = JSON.parse(h); } catch(e) { /* ignore */ }
    }
    // JSON-first: load purely from predictions JSON when it exists
    if (p) {
      try { window.previousPredictions = JSON.parse(p); } catch(e) { window.previousPredictions = []; }
      // If predictions exist, show the Previous Predictions section immediately on page load
      try {
        const cnt = Array.isArray(window.previousPredictions) ? window.previousPredictions.length : 0;
        if (cnt > 0) {
          const wrap = document.getElementById('slipSavedMiniWrap');
          if (wrap) wrap.style.display = 'block';
        }
      } catch(e) {}
      window.__pbvNext = window.__pbvNext || {};
      window.__pbvNext.predictionsJsonPrimed = true;
      try {
        const cnt = Array.isArray(window.previousPredictions) ? window.previousPredictions.length : 0;
        showToast(`Loaded Previous Predictions JSON (${cnt} row${cnt===1?'':'s'}).`, 'success');
      } catch(e) {}
    } else {
      // First-run bootstrap: if no JSON exists but we have legacy in-memory predictions,
      // persist them immediately as the default JSON so future loads are JSON-only.
      const legacy = Array.isArray(window.previousPredictions) ? window.previousPredictions : [];
      if (legacy.length > 0) {
        try {
          localStorage.setItem('pb_previousPredictions', JSON.stringify(legacy));
          window.__pbvNext = window.__pbvNext || {};
          window.__pbvNext.predictionsJsonPrimed = true;
          try { showToast(`Created Predictions JSON (${legacy.length} row${legacy.length===1?'':'s'}).`, 'success'); } catch(e) {}
        } catch(e) {}
      }
    }
    if (n && window.__pbvNext) window.__pbvNext.loadedFileName = n;
    // Restore UI preference for pending/full toggle
    try {
      const pref = localStorage.getItem('pb_ppShowAll');
      if (pref != null) {
        window.__pbvNext = window.__pbvNext || {};
        window.__pbvNext.ppShowAll = (pref === '1');
      }
    } catch(e) {}
  } catch (e) {}
}
document.addEventListener('DOMContentLoaded', () => {
  try { hydrateFromLocalStorage(); } catch(e) {}
  try { initPreviousPredictionsSection(); } catch(e) {}
  try { _ppWireToggleOnce(); } catch(e) {}
  try { _ppWireSectionVisibleToggleOnce(); } catch(e) {}
  try { wirePreviousPredictionsJsonControlsOnce(); } catch(e) {}
  try { renderPreviousPredictionsHistoryTable(); } catch(e) {}
});
window.exportToFile = function exportToFile() {
  if (!Array.isArray(drawingHistory) || drawingHistory.length === 0) {
    showErrorToast('No drawing history available yet.');
    return;
  }
  const content = buildDrawingHistoryReportHTML();
  const stamp = new Date().toISOString().slice(0,10).replaceAll('-','');
  const filename = `Texas_Powerball_Drawing_History_${stamp}.html`;
  downloadTextFile(filename, content);
  try { showSuccessPopup('Saved Drawing History report.'); } catch {}
};
// Bind manual-entry submit to the primary async implementation
window.submitManualEntry = submitManualEntry;
// If user selects LSTM, do NOT preload TFJS or train here (performance).
// We only load/train on-demand when the user clicks Generate with LSTM selected.
document.addEventListener('change', (e) => {
  const t = e.target;
  if (t && t.name === 'predictionMethod' && t.value === 'lstm' && t.checked) {
    window.__pbvNext = window.__pbvNext || {};
    window.__pbvNext.lstmSelected = true;
    // Optional lightweight notice (no heavy work)
    try { showSuccessPopup('LSTM will train on first Generate.'); } catch {}
  }
});
/* ===== End Patch ===== */
function styleManualBall(input, bgColor, textColor, borderColor, shadowColor) {
    input.style.width = '78px';
    input.style.height = '78px';
    input.style.borderRadius = '50%';
    input.style.border = `2px solid ${borderColor}`;
    input.style.background = `radial-gradient(circle at top left, #ffffff, ${bgColor})`;
    input.style.color = textColor;
    input.style.fontSize = '20px';
    input.style.fontWeight = 'bold';
    input.style.textAlign = 'center';
    input.style.boxShadow = `0 4px 10px ${shadowColor}`;
    input.style.outline = 'none';
    input.style.transition = 'transform 0.2s ease';
    input.addEventListener('focus', () => input.style.transform = 'scale(1.1)');
    input.addEventListener('blur', () => input.style.transform = 'scale(1.0)');
}
function buildManualEntryInputWrapper(modal) {
    const inputWrapper = document.createElement('div');
    inputWrapper.id = 'manualEntryInputWrapper';
    inputWrapper.style.display = 'flex';
    inputWrapper.style.gap = '15px';
    inputWrapper.style.marginBottom = '20px';
    inputWrapper.style.flexWrap = 'wrap';
    inputWrapper.style.justifyContent = 'center';
    // Add 5 regular ball inputs (unique required)
    for (let i = 0; i < 5; i++) {
        const ballInput = document.createElement('input');
        ballInput.type = 'number';
        ballInput.min = 1;
        ballInput.max = 69;
        ballInput.className = 'number-input main-number-input';
        ballInput.placeholder = '';
        styleManualBall(ballInput, '#4facfe', '#ffffff', '#00f2fe', 'rgba(0, 242, 254, 0.5)');
        ballInput.addEventListener('input', () => {
            const v = parseInt(ballInput.value, 10);
            if (Number.isNaN(v)) return;
            if (v < 1 || v > 69) { ballInput.value = ''; return; }
            const mains = Array.from(modal.querySelectorAll('.main-number-input'))
                .map(el => parseInt(el.value, 10))
                .filter(n => !Number.isNaN(n));
            const seen = new Set();
            let dup = false;
            for (const n of mains) { if (seen.has(n)) { dup = true; break; } seen.add(n); }
            if (dup) {
                ballInput.value = '';
                // Use existing popup mechanism
                if (typeof showSuccessPopup === 'function') showSuccessPopup('⚠️ Duplicate main number not allowed. Please choose a different number.');
                else showErrorToast('Duplicate main number not allowed. Please choose a different number.');
            }
        });
        inputWrapper.appendChild(ballInput);
    }
    // Add Powerball input (duplicates allowed, range 1-26)
    const powerballInput = document.createElement('input');
    powerballInput.type = 'number';
    powerballInput.min = 1;
    powerballInput.max = 26;
    powerballInput.className = 'number-input powerball-input';
    powerballInput.id = 'powerballInput';
    powerballInput.placeholder = '';
    styleManualBall(powerballInput, '#ff416c', '#ffffff', '#ff7c9e', '#ff416c');
    powerballInput.addEventListener('input', () => {
        const v = parseInt(powerballInput.value, 10);
        if (Number.isNaN(v)) return;
        if (v < 1 || v > 26) {
            powerballInput.value = '';
            if (typeof showSuccessPopup === 'function') showSuccessPopup('PowerBall must be between 1 and 26.');
            else showErrorToast('PowerBall must be between 1 and 26.');
        }
    });
    inputWrapper.appendChild(powerballInput);
    // Auto-advance focus when 2 digits entered
    const allInputs = Array.from(inputWrapper.querySelectorAll('input'));
    allInputs.forEach((inp, idx) => {
        inp.setAttribute('inputmode', 'numeric');
        inp.addEventListener('input', () => {
            const v = String(inp.value || '');
            if (v.length >= 2 && idx < allInputs.length - 1) {
                allInputs[idx + 1].focus();
                allInputs[idx + 1].select?.();
            }
        });
    });
    return inputWrapper;
}
function rebuildManualEntryAfterSave() {
    // Some browsers / DOM states keep painted values even after .value=''.
    // Rebuild the ball inputs fresh (keeping the date selector and its current value/options).
    try {
        const modal = document.getElementById('manualEntryModal');
        const container = document.getElementById('numberEntry');
        if (!modal || !container) return;
        // Remove existing wrapper if present
        const existing = container.querySelector('#manualEntryInputWrapper');
        if (existing) existing.remove();
        // Also remove any stray inputs that might have been appended earlier (safety)
        container.querySelectorAll('.main-number-input, #powerballInput').forEach(el => el.remove());
        const wrapper = buildManualEntryInputWrapper(modal);
        container.appendChild(wrapper);
        // Focus first main ball
        const first = wrapper.querySelector('.main-number-input');
        if (first) { first.focus(); first.select?.(); }
    } catch (e) {
        console.warn('rebuildManualEntryAfterSave failed', e);
        // Fallback: attempt simple clear
        clearManualEntryBalls();
    }
}
function hardClearManualEntryBalls() {
    // Hard UI reset for the styled number "ball" inputs.
    // Some browsers keep the last painted value for <input type="number"> until blur/reflow.
    try {
        const modal = document.getElementById('manualEntryModal') || document;
        const inputs = Array.from(modal.querySelectorAll('input.number-input'));
        inputs.forEach(inp => {
            try { inp.blur(); } catch(e) {}
            inp.value = '';
            inp.defaultValue = '';
            inp.setAttribute('value', '');
            // also clear any dataset/state that might be used by CSS/JS
            if (inp.dataset) {
                delete inp.dataset.value;
                delete inp.dataset.filled;
            }
        });
        // Force a repaint/reflow, then clear again (guards against painted value persistence)
        void (modal.offsetHeight);
        inputs.forEach(inp => {
            inp.value = '';
            inp.defaultValue = '';
            inp.setAttribute('value', '');
        });
        // Focus first main ball
        const first = modal.querySelector('.main-number-input');
        if (first) { first.focus(); first.select?.(); }
    } catch (e) {
        console.warn('hardClearManualEntryBalls failed', e);
    }
}
function clearManualEntryBalls() {
    // Simple clear fallback (kept for safety)
    try {
        const modal = document.getElementById('manualEntryModal') || document;
        modal.querySelectorAll('.main-number-input').forEach(i => {
            i.value = '';
            i.dispatchEvent(new Event('input', { bubbles: true }));
        });
        const pb = modal.querySelector('#powerballInput') || document.getElementById('powerballInput');
        if (pb) {
            pb.value = '';
            pb.dispatchEvent(new Event('input', { bubbles: true }));
        }
        const first = modal.querySelector('.main-number-input');
        if (first) { first.focus(); first.select?.(); }
    } catch (e) {
        console.warn('clearManualEntryBalls failed', e);
    }
}
/* =========================
   Methodology Rationale: Expand/Collapse + State Persistence
   ========================= */
(function(){
  const LS_KEY = 'pb_methodology_rationale_state_v1';
  function getRationaleDetails(){
    const root = document.querySelector('#explainabilityPanel .mr-static');
    if(!root) return [];
    return Array.from(root.querySelectorAll('details.mr-block'));
  }
  function loadState(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      return raw ? JSON.parse(raw) : null;
    }catch(e){
      return null;
    }
  }
  function saveState(){
    try{
      const details = getRationaleDetails();
      const state = {
        open: {},
        visible: null
      };
      details.forEach(d=>{
        const k = d.getAttribute('data-mr-key') || d.querySelector('summary')?.textContent?.trim() || '';
        if(k) state.open[k] = !!d.open;
      });
      const vis = document.getElementById('toggleExplainability');
      if(vis) state.visible = !!vis.checked;
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }catch(e){
      // no-op
    }
  }
  function applyState(){
    const state = loadState();
    if(!state) return;
    const details = getRationaleDetails();
    if(state.open && details.length){
      details.forEach(d=>{
        const k = d.getAttribute('data-mr-key') || d.querySelector('summary')?.textContent?.trim() || '';
        if(k in state.open){
          d.open = !!state.open[k];
        }
      });
    }
    if(typeof state.visible === 'boolean'){
      const vis = document.getElementById('toggleExplainability');
      if(vis){
        vis.checked = state.visible;
        // trigger existing toggle handler (if any) by dispatching change
        vis.dispatchEvent(new Event('change', { bubbles: true }));
      }
    }
  }
  function setAll(open){
    const details = getRationaleDetails();
    details.forEach(d=>{ d.open = !!open; });
    saveState();
  }
  function wire(){
    const expandBtn = document.getElementById('mrExpandAll');
    const collapseBtn = document.getElementById('mrCollapseAll');
    if(expandBtn) expandBtn.addEventListener('click', ()=>setAll(true));
    if(collapseBtn) collapseBtn.addEventListener('click', ()=>setAll(false));
    getRationaleDetails().forEach(d=>{
      d.addEventListener('toggle', saveState);
    });
    const vis = document.getElementById('toggleExplainability');
    if(vis) vis.addEventListener('change', saveState);
  }
  document.addEventListener('DOMContentLoaded', ()=>{
    applyState();
    wire();
  });
})();
// Mini-table auto-refresh on draw date change / page load
document.addEventListener('DOMContentLoaded', () => {
  try {
    const d = document.getElementById('startDate') || document.getElementById('drawDate');
    if (!d) return;
    const key = (d.value ? new Date(d.value) : new Date()).toISOString().split('T')[0];
    renderPreviousPredictionsMiniTable(key);
    d.addEventListener('change', () => {
      const k = (d.value ? new Date(d.value) : new Date()).toISOString().split('T')[0];
      renderPreviousPredictionsMiniTable(k);
      try { renderPreviousPredictionsHistoryTable(); } catch(e) {}
    });
  } catch(e) {}
});
</script>
<!-- v101: Post-DOM bootstrap for Previous Predictions (fix JSON button wiring + ensure latest loads) -->
<script>
(function(){
  function bootstrap(){
    try { if (typeof hydrateFromLocalStorage==='function') hydrateFromLocalStorage(); } catch(e) { console.warn(e); }
    try { if (typeof wirePreviousPredictionsJsonControlsOnce==='function') wirePreviousPredictionsJsonControlsOnce(); } catch(e) { console.warn(e); }
    try { if (typeof _ppWireToggleOnce==='function') _ppWireToggleOnce(); } catch(e) { console.warn(e); }
    try { if (typeof renderPreviousPredictionsHistoryTable==='function') renderPreviousPredictionsHistoryTable(); } catch(e) { console.warn(e); }
    try {
      const d = document.getElementById('startDate') || document.getElementById('drawDate');
      const key = (d && d.value ? new Date(d.value) : new Date()).toISOString().split('T')[0];
      if (typeof renderPreviousPredictionsMiniTable==='function') renderPreviousPredictionsMiniTable(key);
    } catch(e) { console.warn(e); }
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bootstrap);
  else bootstrap();
})();
/* === v110a Hotfix: restore slip-plan bridge used by PDF stamping (from v106) === */
window.__lastComputedSlipPlan = window.__lastComputedSlipPlan || null;
window.__setLastComputedSlipPlan = window.__setLastComputedSlipPlan || function(planObj){
  window.__lastComputedSlipPlan = planObj || null;
};
/* === end hotfix === */
/* =========================================================
   Enhancement #7 — Stage B
   Reload Historical Data (Destructive) + Warning + Hardening
   (Built on locked Stage A behavior; does not touch v107 baseline
    beyond UI parity already established in Stage A.)
========================================================= */
(function(){
  function _qs(id){ return document.getElementById(id); }
  function showReloadModal(){
    const m = _qs('pbReloadModal');
    if (!m) return;
    m.style.display = 'flex';
  }
  function hideReloadModal(){
    const m = _qs('pbReloadModal');
    if (!m) return;
    m.style.display = 'none';
  }
  function updateReloadButtonVisibility(){
    try {
      const reloadBtn = _qs('reloadDataBtn');
      const loadBtn = _qs('loadDataBtn');
      const hj = localStorage.getItem('pb_historicalDataJSON');
      const hasJson = !!(hj && hj.length > 10);
      if (reloadBtn) reloadBtn.style.display = hasJson ? 'inline-block' : 'none';
      // Load button is controlled by Stage A, but enforce here too.
      if (loadBtn) loadBtn.style.display = hasJson ? 'none' : 'inline-block';
    } catch(e) {}
  }
  async function doDestructiveReload(){
    // Clear JSON (authoritative) and revert UI to "needs import"
    try { localStorage.removeItem('pb_historicalDataJSON'); } catch(e) {}
    // Keep legacy text-store as backup but not authoritative; leaving it is fine.
    try {
      if (window.__pbvNext) window.__pbvNext.historicalDataLoaded = false;
      if (typeof updateGenerateButtonState === 'function') updateGenerateButtonState();
    } catch(e) {}
    try { if (typeof updateAutoSaveLight === 'function') updateAutoSaveLight(false); } catch(e) {}
    try { if (typeof showToast === 'function') showToast('Historical Data JSON cleared. Select the backup text file to rebuild JSON.', 'warning'); } catch(e) {}
    // Ensure Load button is visible so user can re-import
    try {
      const loadBtn = _qs('loadDataBtn');
      if (loadBtn) { loadBtn.disabled = false; loadBtn.style.display = 'inline-block'; }
    } catch(e) {}
    // Open file picker (user gesture already happened on confirm click)
    const ok = await (typeof loadDataFromFile === 'function' ? loadDataFromFile() : false);
    // loadDataFromFile (Stage A) already re-writes pb_historicalDataJSON on success.
    if (ok) {
      try { if (typeof showToast === 'function') showToast('Historical Data reloaded and JSON rebuilt successfully.', 'success'); } catch(e) {}
    } else {
      try { if (typeof showToast === 'function') showToast('Reload canceled or failed. Historical Data JSON remains cleared until you import again.', 'error'); } catch(e) {}
    }
    updateReloadButtonVisibility();
  }
  function wireOnce(){
    const reloadBtn  = _qs('reloadDataBtn');
    const loadBtn    = _qs('loadDataBtn');
    const cancelBtn  = _qs('pbReloadCancel');
    const confirmBtn = _qs('pbReloadConfirm');
    const modal      = _qs('pbReloadModal');
    // Reload (destructive) modal
    if (reloadBtn && !reloadBtn.__wired){
      reloadBtn.__wired = true;
      reloadBtn.addEventListener('click', (e) => {
        try { e.preventDefault(); } catch(_) {}
        showReloadModal();
      });
    }
    if (cancelBtn && !cancelBtn.__wired){
      cancelBtn.__wired = true;
      cancelBtn.addEventListener('click', (e) => {
        try { e.preventDefault(); } catch(_) {}
        hideReloadModal();
      });
    }
    if (confirmBtn && !confirmBtn.__wired){
      confirmBtn.__wired = true;
      confirmBtn.addEventListener('click', async (e) => {
        try { e.preventDefault(); } catch(_) {}
        hideReloadModal();
        await doDestructiveReload();
      });
    }
    // Click outside closes modal
    if (modal && !modal.__wired){
      modal.__wired = true;
      modal.addEventListener('click', (e) => {
        if (e.target === modal) hideReloadModal();
      });
    }
    // Load Historical Data (first-time import) button
    if (loadBtn && !loadBtn.__wired){
      loadBtn.__wired = true;
      loadBtn.addEventListener('click', async (e) => {
        try { e.preventDefault(); } catch(_) {}
        try {
          if (typeof loadDataFromFile === 'function') {
            await loadDataFromFile();
          } else if (typeof showErrorToast === 'function') {
            showErrorToast('Load function is not available.');
          }
        } catch (err) {
          console.error('Load Historical Data click failed', err);
          try { if (typeof showErrorToast === 'function') showErrorToast('Error loading historical data. See console.'); } catch(_){}
        }
        try { updateReloadButtonVisibility(); } catch(_) {}
      });
    }
  }
  document.addEventListener('DOMContentLoaded', () => {
    try { wireOnce(); } catch(e) {}
    try { updateReloadButtonVisibility(); } catch(e) {}
  });
  // Also re-evaluate after any successful file load (text path)
  const _origLoad = window.loadDataFromFile;
  if (typeof _origLoad === 'function' && !_origLoad.__stageBWrapped){
    window.loadDataFromFile = async function(){
      const r = await _origLoad.apply(this, arguments);
      try { updateReloadButtonVisibility(); } catch(e) {}
      return r;
    };
    window.loadDataFromFile.__stageBWrapped = true;
  }
})();
</script>
<script>
/* ===== v126 Hotfix: Restore reliable Load/Reload Historical Data button wiring =====
   - Ensures Load Historical Data opens file picker (FS Access API or fallback)
   - Ensures Reload Historical Data (when visible) opens reload modal or triggers reload flow
   - Defensive binding: works even if earlier scripts failed to attach handlers
*/
(function () {
  function bindOnce(btn, handler) {
    if (!btn) return;
    if (btn.__pb_wired_v126) return;
    btn.__pb_wired_v126 = true;
    // Add both property handler and event listener to survive other scripts overwriting one of them
    btn.onclick = function (e) {
      try { if (e) { e.preventDefault(); e.stopPropagation(); } } catch (_) {}
      return handler(e);
    };
    btn.addEventListener('click', function (e) {
      try { e.preventDefault(); e.stopPropagation(); } catch (_) {}
      return handler(e);
    }, true); // capture to bypass accidental stopPropagation in bubbling phase
  }
  function bind() {
    var loadBtn = document.getElementById('loadDataBtn');
    var reloadBtn = document.getElementById('reloadDataBtn');
    bindOnce(loadBtn, function () {
      // Primary expected entrypoint in v124+
      if (typeof window.loadDataFromFile === 'function') return window.loadDataFromFile();
      // Fallbacks for older variants
      if (typeof window.loadHistoricalData === 'function') return window.loadHistoricalData();
      if (typeof window.loadHistoricalDataFile === 'function') return window.loadHistoricalDataFile();
      if (typeof window.triggerLoadFile === 'function') return window.triggerLoadFile();
      console.warn('Load Historical Data: no loader function found.');
    });
    bindOnce(reloadBtn, function () {
      // Prefer the reload modal if present
      if (typeof window.showReloadModal === 'function') return window.showReloadModal();
      // Else, attempt reload using the available helper
      if (typeof window.reloadHistoricalDataAndRefresh === 'function') return window.reloadHistoricalDataAndRefresh();
      if (typeof window.triggerReloadUpdatedFile === 'function') return window.triggerReloadUpdatedFile();
      console.warn('Reload Historical Data: no reload function found.');
    });
    // Keep reload visibility in sync with localStorage state (if helper exists)
    try {
      if (typeof window.updateReloadButtonVisibility === 'function') window.updateReloadButtonVisibility();
    } catch (_) {}
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', bind);
  } else {
    bind();
  }
})();
/* =========================================================
   Enhancement vE3.4 — Overlays (display-only)
   - Separate storage
   - Annotates E3 dataset + outlier rows via coverage table
   - Does not modify dataset logic or analytics math
   ========================================================= */
(function(){
  const OVERLAY_LS_KEY = "pb_vnext_overlays_vE3_4";
  const OVERLAY_SETTINGS_LS_KEY = "pb_vnext_overlays_settings_vE3_4";
  function $(id){ return document.getElementById(id); }
  function safeParse(raw){ try{return JSON.parse(raw);}catch(e){return null;} }
  function iso(d){
    const x = new Date(d);
    if (isNaN(x.getTime())) return null;
    const yyyy=x.getFullYear();
    const mm=String(x.getMonth()+1).padStart(2,"0");
    const dd=String(x.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }
  function inRange(d, start, end){
    return d >= start && d <= end;
  }
  function seedBaselineOverlays(){
    const baseline = {
      version:"E3.4",
      updatedAt:new Date().toISOString(),
      bands:[
        {id:"band_covid", name:"COVID-era disruption", category:"Macro", startDate:"2020-03-01", endDate:"2021-12-31", type:"Band"},
        {id:"band_infl", name:"High inflation period", category:"Macro", startDate:"2021-04-01", endDate:"2023-06-30", type:"Band"}
      ],
      markers:[
        {id:"mk_record", name:"Record jackpot era", category:"Market", date:"2022-11-07", type:"Marker"}
      ]
    };
    localStorage.setItem(OVERLAY_LS_KEY, JSON.stringify(baseline));
    return baseline;
  }
  function loadOverlays(){
    const raw = localStorage.getItem(OVERLAY_LS_KEY);
    const obj = raw ? safeParse(raw) : null;
    if (!obj || (!Array.isArray(obj.bands) && !Array.isArray(obj.markers))) return seedBaselineOverlays();
    obj.bands = Array.isArray(obj.bands) ? obj.bands : [];
    obj.markers = Array.isArray(obj.markers) ? obj.markers : [];
    return obj;
  }
  function loadSettings(){
    const raw = localStorage.getItem(OVERLAY_SETTINGS_LS_KEY);
    const s = raw ? safeParse(raw) : null;
    return Object.assign({enabled:false, cats:{Macro:true,Policy:true,Ops:true,Market:true}}, s||{});
  }
  function saveSettings(s){
    localStorage.setItem(OVERLAY_SETTINGS_LS_KEY, JSON.stringify(s));
  }
  function getSelectedCats(){
    const cats = {Macro:false,Policy:false,Ops:false,Market:false};
    document.querySelectorAll(".enh34Cat").forEach(cb=>{
      cats[cb.value] = !!cb.checked;
    });
    return cats;
  }
  function matchOverlaysForDate(isoDateStr, overlays, cats){
    if (!isoDateStr) return [];
    const d = isoDateStr;
    const hits = [];
    for (const b of overlays.bands){
      if (!cats[b.category]) continue;
      const s = b.startDate, e = b.endDate;
      if (s && e && inRange(d, s, e)) hits.push({name:b.name, category:b.category, type:"Band"});
    }
    for (const m of overlays.markers){
      if (!cats[m.category]) continue;
      if (m.date === d) hits.push({name:m.name, category:m.category, type:"Marker"});
    }
    return hits;
  }
  function renderCoverage(){
    const tbody = $("enh34CoverageTbody");
    if (!tbody) return;
    const settings = loadSettings();
    const overlays = loadOverlays();
    const cats = getSelectedCats();
    if (!settings.enabled){
      tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:10px; color:#666;">Overlays are disabled.</td></tr>`;
      return;
    }
    // Pull hits/outliers from published arrays, fallback to loadDataset()
    const ds = (typeof loadDataset === "function") ? loadDataset() : null;
    const hitsArr = (window.__E3_LAST_HITS && Array.isArray(window.__E3_LAST_HITS)) ? window.__E3_LAST_HITS
                  : (ds && Array.isArray(ds.hits) ? ds.hits : []);
    const outRows = (window.__E3_LAST_OUTROWS && Array.isArray(window.__E3_LAST_OUTROWS)) ? window.__E3_LAST_OUTROWS : [];
    if (!hitsArr.length){
      tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:10px; color:#666;">No jackpot hits loaded. Seed or Import first.</td></tr>`;
      return;
    }
    // Build overlay list filtered by cats
    const all = [];
    overlays.bands.forEach(b=>{ if (cats[b.category]) all.push({name:b.name, category:b.category, type:"Band", start:b.startDate, end:b.endDate}); });
    overlays.markers.forEach(m=>{ if (cats[m.category]) all.push({name:m.name, category:m.category, type:"Marker", date:m.date}); });
    if (!all.length){
      tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:10px; color:#666;">No overlays enabled for selected categories.</td></tr>`;
      return;
    }
    // Precompute record coverage
    const totalRecs = hitsArr.length || 1;
    const totalOuts = outRows.length || 0;
    const rows = all.map(o=>{
      let recCovered=0;
      for (const r of hitsArr){
        const d = r.dateISO || r.drawDateISO || r.drawDate || r.date;
        const isoD = d && /^\d{4}-\d{2}-\d{2}$/.test(d) ? d : iso(d);
        if (!isoD) continue;
        if (o.type==="Band"){
          if (o.start && o.end && inRange(isoD, o.start, o.end)) recCovered++;
        } else {
          if (o.date && isoD===o.date) recCovered++;
        }
      }
      let outCovered=0;
      for (const r of outRows){
        const d = r.drawDateISO || r.dateISO || r.drawDate || r.date;
        const isoD = d && /^\d{4}-\d{2}-\d{2}$/.test(d) ? d : iso(d);
        if (!isoD) continue;
        if (o.type==="Band"){
          if (o.start && o.end && inRange(isoD, o.start, o.end)) outCovered++;
        } else {
          if (o.date && isoD===o.date) outCovered++;
        }
      }
      return {name:o.name, category:o.category, type:o.type, recCovered, outCovered};
    });
    tbody.innerHTML = "";
    for (const r of rows){
      const recTxt = `${r.recCovered} (${((r.recCovered/totalRecs)*100).toFixed(1)}%)`;
      const outTxt = totalOuts ? `${r.outCovered} (${((r.outCovered/totalOuts)*100).toFixed(1)}%)` : `${r.outCovered} (—)`;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.name}</td>
        <td>${r.category}</td>
        <td>${r.type}</td>
        <td style="text-align:center;">${recTxt}</td>
        <td style="text-align:center;">${outTxt}</td>
      `;
      tbody.appendChild(tr);
    }
    // vE3.4.2: cluster overlay coverage (if cluster data available)
    renderClusterCoverage(hitsArr, outRows, overlays, cats, settings);
  }
  function renderClusterCoverage(hitsArr, outRows, overlays, cats, settings){
    const tb = document.getElementById("enh34ClusterCovTbody");
    if (!tb) return;
    if (!settings.enabled){
      tb.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:10px; color:#666;">Overlays are disabled.</td></tr>`;
      return;
    }
    const cl = window.__E3_LAST_CLUSTER;
    if (!cl || !Array.isArray(cl.labels) || !Array.isArray(cl.meta) || !cl.meta.length){
      tb.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:10px; color:#666;">Run Pattern Analytics to populate cluster coverage.</td></tr>`;
      return;
    }
    const k = Math.max(2, Math.min(5, Number(cl.k)||3));
    const buckets = Array.from({length:k}, ()=>({records:[], outliers:0}));
    // Bucket records by cluster label
    for (let i=0;i<cl.meta.length;i++){
      const c = cl.labels[i] || 0;
      if (!buckets[c]) buckets[c] = {records:[], outliers:0};
      buckets[c].records.push(cl.meta[i]);
    }
    // Map record date to cluster for outlier counts
    const dateToCluster = new Map();
    for (let i=0;i<cl.meta.length;i++){
      const r = cl.meta[i] || {};
      const d = r.drawDateISO || r.dateISO || r.drawDate || r.date;
      const isoD = (d && /^\d{4}-\d{2}-\d{2}$/.test(d)) ? d : iso(d);
      if (!isoD) continue;
      dateToCluster.set(isoD, cl.labels[i] || 0);
    }
    // Count outliers by cluster using date mapping
    for (const o of (outRows||[])){
      const d = o.drawDateISO || o.dateISO || o.drawDate || o.date;
      const isoD = (d && /^\d{4}-\d{2}-\d{2}$/.test(d)) ? d : iso(d);
      if (!isoD) continue;
      const c = dateToCluster.get(isoD);
      if (c === undefined) continue;
      if (!buckets[c]) buckets[c] = {records:[], outliers:0};
      buckets[c].outliers += 1;
    }
    // Build overlay list filtered by cats
    const all = [];
    overlays.bands.forEach(b=>{ if (cats[b.category]) all.push({name:b.name, category:b.category, type:"Band", start:b.startDate, end:b.endDate}); });
    overlays.markers.forEach(m=>{ if (cats[m.category]) all.push({name:m.name, category:m.category, type:"Marker", date:m.date}); });
    tb.innerHTML = "";
    for (let c=0;c<k;c++){
      const recs = (buckets[c] && buckets[c].records) ? buckets[c].records : [];
      const recN = recs.length;
      if (!recN){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${c+1}</td><td style="text-align:center;">0</td><td style="color:#666;">—</td><td style="text-align:center;">${(buckets[c] && buckets[c].outliers) ? buckets[c].outliers : 0}</td>`;
        tb.appendChild(tr);
        continue;
      }
      // Overlay coverage within this cluster
      const cov = all.map(ov=>{
        let n=0;
        for (const r of recs){
          const d = r.drawDateISO || r.dateISO || r.drawDate || r.date;
          const isoD = (d && /^\d{4}-\d{2}-\d{2}$/.test(d)) ? d : iso(d);
          if (!isoD) continue;
          if (ov.type==="Band"){
            if (ov.start && ov.end && inRange(isoD, ov.start, ov.end)) n++;
          } else {
            if (ov.date && isoD===ov.date) n++;
          }
        }
        return {name:ov.name, pct:(n/recN), n};
      }).sort((a,b)=>b.pct-a.pct);
      const top = cov.slice(0,3).filter(x=>x.n>0);
      const topTxt = top.length ? top.map(x=>`${x.name} (${(x.pct*100).toFixed(1)}%)`).join("; ") : "None";
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${c+1}</td><td style="text-align:center;">${recN}</td><td>${topTxt}</td><td style="text-align:center;">${buckets[c].outliers||0}</td>`;
      tb.appendChild(tr);
    }
  }
  function wire(){
    const enable = $("enh34Enable");
    if (enable) enable.checked = false;
    const btnExport = $("enh34Export");
    const btnReset = $("enh34Reset");
    const file = $("enh34ImportFile");
    const status = $("enh34Status");
    if (!enable || !btnExport || !btnReset || !file) return;
    const s = loadSettings();
    enable.checked = !!s.enabled;
    // sync category checks from settings (if present)
    if (s.cats){
      document.querySelectorAll(".enh34Cat").forEach(cb=>{
        if (cb.value in s.cats) cb.checked = !!s.cats[cb.value];
      });
    }
    enable.addEventListener("change", ()=>{
      const ss = loadSettings();
      ss.enabled = !!enable.checked;
      ss.cats = getSelectedCats();
      saveSettings(ss);
      status.textContent = "Status: updated.";
      renderCoverage();
    });
    document.querySelectorAll(".enh34Cat").forEach(cb=>{
      cb.addEventListener("change", ()=>{
        const ss = loadSettings();
        ss.cats = getSelectedCats();
        saveSettings(ss);
        status.textContent = "Status: categories updated.";
        renderCoverage();
      });
    });
    btnReset.addEventListener("click", ()=>{
      seedBaselineOverlays();
      status.textContent = "Status: baseline reset.";
      renderCoverage();
    });
    btnExport.addEventListener("click", ()=>{
      const obj = loadOverlays();
      const blob = new Blob([JSON.stringify(obj,null,2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `Powerball_vNext_E3_4_Overlays_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click(); a.remove();
      URL.revokeObjectURL(a.href);
      status.textContent = "Status: exported.";
    });
    file.addEventListener("change", async (e)=>{
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      try{
        const txt = await f.text();
        const obj = JSON.parse(txt);
        if (!obj || (!Array.isArray(obj.bands) && !Array.isArray(obj.markers))) throw new Error("Invalid overlays JSON.");
        obj.bands = Array.isArray(obj.bands) ? obj.bands : [];
        obj.markers = Array.isArray(obj.markers) ? obj.markers : [];
        localStorage.setItem(OVERLAY_LS_KEY, JSON.stringify(obj));
        status.textContent = "Status: imported.";
        renderCoverage();
      }catch(err){
        alert("Overlay import failed: " + err.message);
      }finally{
        e.target.value = "";
      }
    });
    // initial render
    renderCoverage();
  }
  // run after DOM
  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", wire);
  } else {
    wire();
  }
})();
</script>
<script>
/* =========================================================
   Enhancement vE3.5 — Explainability & Audit (display-only)
   Guardrails: does not alter vE3.4.2 dataset logic, seeding, storage keys, analytics math, or outputs.
   New storage key only: PB_E3_AUDIT_LOG_V1
========================================================= */
(function(){
  'use strict';
  const AUDIT_KEY = 'PB_E3_AUDIT_LOG_V1';
  const SEL = {
    state: null,
    cluster: null,
    outlier: null
  };
  function qs(id){ return document.getElementById(id); }
  function nowIso(){
    try { return new Date().toISOString(); } catch(e){ return String(Date.now()); }
  }
  function safeJsonParse(s, fallback){
    try { return JSON.parse(s); } catch(e){ return fallback; }
  }
  function loadAudit(){
    const raw = (function(){ try { return localStorage.getItem(AUDIT_KEY); } catch(e){ return null; } })();
    const arr = raw ? safeJsonParse(raw, []) : [];
    return Array.isArray(arr) ? arr : [];
  }
  function saveAudit(arr){
    try { localStorage.setItem(AUDIT_KEY, JSON.stringify(arr)); } catch(e){}
  }
  function setAuditStatus(){
    const el = qs('enh35AuditStatus');
    if (!el) return;
    const n = loadAudit().length;
    el.textContent = '';
  }
  function explainabilityEnabled(){
    const t = qs('enh35EnableExplainability');
    return !!(t && t.checked);
  }
  function escapeHtml(str){
    return String(str)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }
  function _e35_num(s){
    if (s == null) return null;
    const m = String(s).replace(/,/g,'').match(/-?\d+(?:\.\d+)?/);
    return m ? parseFloat(m[0]) : null;
  }
  function _e35_parenPercent(s){
    if (!s) return null;
    const m = String(s).match(/\(([-+]?\d+(?:\.\d+)?)%\)/);
    return m ? parseFloat(m[1]) : null;
  }
  function _e35_cmpPct(a,b){
    if (a == null || b == null) return null;
    const d = a - b;
    const sign = d>0 ? '+' : '';
    return sign + d.toFixed(1) + ' pts';
  }
  function _e35_overUnderFromRatio(r){
    if (r == null) return '—';
    if (r > 1.05) return 'over-represented';
    if (r < 0.95) return 'under-represented';
    return 'approximately in-line';
  }
  function formatAsEnglish(obj){
    // Fallbacks
    if (obj == null) return '<em>No output.</em>';
    if (typeof obj === 'string') return '<div>' + escapeHtml(obj) + '</div>';
    const ruleId = obj.ruleId || '—';
    const title  = obj.title  || 'Explainability Output';
    const summary= obj.summary|| '';
    const trace  = obj.trace  || {};
    const ts     = (trace && trace.timestamp) ? trace.timestamp : (obj.timestamp || '');
    const num = (v) => {
      if (v == null) return null;
      const s = String(v).trim();
      if (!s) return null;
      // keep leading minus, remove commas and non-numeric (except dot)
      const cleaned = s.replace(/,/g,'').replace(/[^0-9.\-]/g,'');
      const n = Number(cleaned);
      return Number.isFinite(n) ? n : null;
    };
    const pct = (v) => {
      const n = num(v);
      if (n == null) return null;
      return n;
    };
    const fmtPct = (n) => (n == null ? '—' : (Math.round(n*10)/10) + '%');
    const fmtNum = (n) => (n == null ? '—' : String(Math.round(n*1000)/1000));
    let html = '';
    html += '<div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">';
    html +=   '<div><div style="font-weight:700;font-size:15px;margin-bottom:2px">' + escapeHtml(title) + '</div>';
    html +=   '<div style="color:#666;font-size:12px">Rule: <code>' + escapeHtml(ruleId) + '</code>' + (ts ? (' • ' + escapeHtml(ts)) : '') + '</div></div>';
    html += '</div>';
    if (summary){
      html += '<div style="margin-top:6px;color:#444;line-height:1.35">' + escapeHtml(summary) + '</div>';
    }
    // Narrative blocks (plain English)
    try {
      if (String(ruleId).indexOf('E3.5.OVERLAY.COVERAGE') === 0){
        const snap = (trace && trace.snapshot) ? trace.snapshot : {};
        html += '<hr style="border:none;border-top:1px solid #e6e6e6;margin:12px 0" />';
        html += '<div style="font-weight:700;margin-bottom:6px">What this means</div>';
        const enabled = (snap.overlaysEnabled === true) ? 'enabled' : (snap.overlaysEnabled === false ? 'disabled' : 'unknown');
        const catsOn  = (snap.categories||[]).filter(c => c && c.checked).map(c => c.category).filter(Boolean);
        const catsOff = (snap.categories||[]).filter(c => c && !c.checked).map(c => c.category).filter(Boolean);
        html += '<div style="line-height:1.35">';
        html +=   'Overlays are currently <b>' + escapeHtml(enabled) + '</b>.';
        if (catsOn.length || catsOff.length){
          html += ' Enabled categories: <b>' + escapeHtml(catsOn.length ? catsOn.join(', ') : '—') + '</b>.';
          html += ' Disabled categories: <b>' + escapeHtml(catsOff.length ? catsOff.join(', ') : '—') + '</b>.';
        }
        html += '</div>';
        const renderMiniTable = (label, tbl) => {
          if (!tbl || !tbl.available) return '<div style="margin-top:10px;color:#666;font-size:12px">' + escapeHtml(label) + ': not available yet.</div>';
          const rows = tbl.rows || [];
          let s = '<div style="margin-top:10px">';
          s += '<div style="font-weight:600;margin-bottom:6px">' + escapeHtml(label) + '</div>';
          s += '<div style="overflow:auto"><table class="table" style="margin:0">';
          rows.slice(0,8).forEach(r=>{
            s += '<tr>';
            (r||[]).forEach(c=>{
              s += '<td style="padding:6px 8px">' + escapeHtml(c) + '</td>';
            });
            s += '</tr>';
          });
          s += '</table></div>';
          if (rows.length > 8){
            s += '<div style="color:#666;font-size:12px;margin-top:6px">Showing first 8 rows. See exported audit log for full trace.</div>';
          }
          s += '</div>';
          return s;
        };
        html += renderMiniTable('Overall overlay coverage (top rows)', snap.coverageTable);
        html += renderMiniTable('Cluster overlay coverage (top rows)', snap.clusterCoverageTable);
      } else if (String(ruleId).indexOf('E3.5.STATE.EXPLAIN') === 0){
        const sel = (trace && trace.selection) ? trace.selection : {};
        const st  = sel.state || '—';
        const ratio = num(sel.obsExp);
        const popShare = num(sel.popShare);
        const chi = num(sel.chiComponent);
        const overUnder = (ratio == null) ? 'a deviation from expected share' : (ratio >= 1 ? 'over-representation' : 'under-representation');
        const devPct = (ratio == null) ? null : Math.abs((ratio - 1) * 100);
        html += '<hr style="border:none;border-top:1px solid #e6e6e6;margin:12px 0" />';
        html += '<div style="font-weight:700;margin-bottom:6px">Explanation (plain English)</div>';
        html += '<div style="line-height:1.55">';
        html += 'For <b>' + escapeHtml(st) + '</b>, the State Representation table compares how often the state appears in the observed dataset versus the expected baseline used by the existing analytics. ';
        if (ratio == null){
          html += 'The selected row indicates <b>' + escapeHtml(overUnder) + '</b>.';
        } else {
          html += 'The selected row indicates <b>' + escapeHtml(overUnder) + '</b> (Obs/Exp = <b>' + escapeHtml(String(sel.obsExp||"—")) + '</b>).';
          html += ' That corresponds to about <b>' + escapeHtml(String(devPct==null?'—':devPct.toFixed(1) + '%')) + '</b> ' + (ratio>=1?'above':'below') + ' expected.';
        }
        html += '</div>';
        html += '<div style="margin-top:10px;line-height:1.55">';
        html += '<div style="font-weight:700;margin-bottom:6px">What the table is revealing</div>';
        html += '<ul style="margin:0 0 0 18px;padding:0;line-height:1.55">';
        html += '<li><b>Observed vs expected:</b> Observed tickets = <b>' + escapeHtml(String(sel.observedTickets||"—")) + '</b> vs expected tickets = <b>' + escapeHtml(String(sel.expectedTickets||"—")) + '</b>.</li>';
        html += '<li><b>Relative lift:</b> Obs/Exp ratio = <b>' + escapeHtml(String(sel.obsExp||"—")) + '</b> (higher means more representation in the observed dataset; lower means less).</li>';
        html += '<li><b>Baseline context:</b> Population share = <b>' + escapeHtml(String(sel.popShare||"—")) + '</b> (as used by the existing state-share baseline).</li>';
        html += '<li><b>Strength of deviation:</b> Chi-square component = <b>' + escapeHtml(String(sel.chiComponent||"—")) + '</b> (bigger means this state contributes more to the overall deviation between observed and expected distributions).</li>';
        html += '</ul>';
        html += '</div>';
        html += '<div style="margin-top:10px;line-height:1.55">';
        html += '<div style="font-weight:700;margin-bottom:6px">Why it may be happening (interpretation)</div>';
        html += '<div>';
        html += 'This analysis is descriptive. A state can be over- or under-represented due to ticket-sales concentration, player behavior, retailer density, population differences, or simply random clustering in a limited sample. ';
        html += 'Importantly, the lottery draw is independent of where tickets are purchased; the odds do not change by state.';
        html += '</div></div>';
        html += '<div style="margin-top:10px;line-height:1.55">';
        html += '<div style="font-weight:700;margin-bottom:6px">Recommendations (non-predictive)</div>';
        html += '<ul style="margin:0 0 0 18px;padding:0;line-height:1.55">';
        html += '<li><b>Use as an audit focus:</b> If you are reviewing patterns, prioritize deeper review of states with higher chi-square components because they drive more of the observed-vs-expected gap.</li>';
        html += '<li><b>If you want to “mirror” the observed pattern:</b> You may choose to buy tickets in this state when you are physically there (or when compliant with your local purchasing rules). This does not improve odds; it only aligns your behavior with the descriptive pattern.</li>';
        html += '<li><b>Stay responsible:</b> Consider fixed budgets and playing only what you can afford to lose.</li>';
        html += '</ul></div>';
      } else if (String(ruleId).indexOf('E3.5.CLUSTER.EXPLAIN') === 0){
        const sel = (trace && trace.selection) ? trace.selection : {};
        const clusterId = sel.cluster || '—';
        const count = sel.count || '—';
        const domMonths = sel.dominantMonths || '—';
        const avgJackpot = sel.avgJackpot || '—';
        const avgCash = sel.avgCash || '—';
        const avgRoll = sel.avgRollDraws || '—';
        const avgWinners = sel.avgWinners || '—';
        // Extract month names for recommendations (best-effort; display-only)
        const monthNames = String(domMonths||'').split(';')[0].split(',').map(s=>s.trim()).filter(Boolean).map(s=>s.split('(')[0].trim()).filter(Boolean);
        const topMonths = monthNames.slice(0,3);
        html += '<hr style="border:none;border-top:1px solid #e6e6e6;margin:12px 0" />';
        html += '<div style="font-weight:700;margin-bottom:6px">Explanation (plain English)</div>';
        html += '<div style="line-height:1.55">';
        html += 'Cluster <b>' + escapeHtml(String(clusterId)) + '</b> is one of the descriptive groupings produced by the existing K-means clustering logic. ';
        html += 'A cluster is essentially a “bucket” of draws with similar normalized features (as defined by the existing analytics). ';
        html += '</div>';
        html += '<div style="margin-top:10px;line-height:1.55">';
        html += '<div style="font-weight:700;margin-bottom:6px">What the table is revealing</div>';
        html += '<ul style="margin:0 0 0 18px;padding:0;line-height:1.55">';
        html += '<li><b>Cluster size:</b> <b>' + escapeHtml(String(count)) + '</b> draws are assigned to this cluster (larger usually means more common patterns).</li>';
        html += '<li><b>Typical jackpot profile:</b> Avg jackpot = <b>' + escapeHtml(String(avgJackpot)) + '</b>; Avg cash = <b>' + escapeHtml(String(avgCash)) + '</b>.</li>';
        html += '<li><b>Rollover dynamics:</b> Avg roll draws = <b>' + escapeHtml(String(avgRoll)) + '</b>; Avg winners = <b>' + escapeHtml(String(avgWinners)) + '</b>.</li>';
        html += '<li><b>Dominant months:</b> <b>' + escapeHtml(String(domMonths)) + '</b>.</li>';
        html += '</ul></div>';
        html += '<div style="margin-top:10px;line-height:1.55">';
        html += '<div style="font-weight:700;margin-bottom:6px">How to read “Dominant months” (what & why)</div>';
        html += '<div>';
        html += 'Dominant months summarize seasonality within this cluster: they list which months appear most frequently among draws assigned to this cluster (and how many times they occur). ';
        html += 'This can happen because jackpot conditions, rollovers, and player participation vary over time — but it can also reflect randomness in the observed window. ';
        html += 'It does not imply that any specific month is “more likely to win”; it simply describes where this cluster’s historical draw records concentrate.';
        html += '</div></div>';
        html += '<div style="margin-top:10px;line-height:1.55">';
        html += '<div style="font-weight:700;margin-bottom:6px">Recommendations (non-predictive)</div>';
        html += '<ul style="margin:0 0 0 18px;padding:0;line-height:1.55">';
        html += '<li><b>Play-timing alignment:</b> If you want your optional play schedule to align with this cluster’s historical concentration, consider focusing extra plays during: <b>' + escapeHtml(topMonths.length?topMonths.join(', '):'—') + '</b>. This does not change odds; it only mirrors the descriptive pattern.</li>';
        html += '<li><b>Jackpot preference:</b> If this cluster has a higher average jackpot and you prefer “high prize” periods, you can choose to play more often when the public jackpot appears similar (large + multiple rollovers). Odds are still the same per ticket.</li>';
        html += '<li><b>Audit use:</b> Use cluster membership as a labeling mechanism to compare overlays and other descriptive signals; vE3.5 does not alter predictions.</li>';
        html += '</ul></div>';
      } else if (String(ruleId).indexOf('E3.5.OUTLIER.EXPLAIN') === 0){
        const sel = (trace && trace.selection) ? trace.selection : {};
        const dt = sel.drawDate || sel.date || '—';
        const zJ = num(sel.zLogJackpot);
        const zG = num(sel.zGrowthPerDraw);
        const flagJ = (zJ == null) ? false : (Math.abs(zJ) >= 2);
        const flagG = (zG == null) ? false : (Math.abs(zG) >= 2);
        const jackpotDir = (zJ == null) ? 'unknown' : (zJ >= 0 ? 'higher-than-typical' : 'lower-than-typical');
        const growthDir  = (zG == null) ? 'unknown' : (zG >= 0 ? 'faster-than-typical' : 'slower-than-typical');
        html += '<hr style="border:none;border-top:1px solid #e6e6e6;margin:12px 0" />';
        html += '<div style="font-weight:700;margin-bottom:6px">Explanation (plain English)</div>';
        html += '<div style="line-height:1.55">';
        html += 'The Outlier table is descriptive: it highlights draw records whose jackpot behavior looks statistically unusual under the existing z-score logic. ';
        html += 'For <b>' + escapeHtml(String(dt)) + '</b>, the z-scores indicate how many standard deviations the record sits from the baseline distribution used by the existing analytics.';
        html += '</div>';
        html += '<div style="margin-top:10px;line-height:1.55">';
        html += '<div style="font-weight:700;margin-bottom:6px">What the table is revealing</div>';
        html += '<ul style="margin:0 0 0 18px;padding:0;line-height:1.55">';
        html += '<li><b>Jackpot & cash:</b> Jackpot = <b>' + escapeHtml(String(sel.jackpot||"—")) + '</b>; Cash = <b>' + escapeHtml(String(sel.cash||"—")) + '</b>.</li>';
        html += '<li><b>Rollover dynamics:</b> Roll draws = <b>' + escapeHtml(String(sel.rollDraws||"—")) + '</b>; Growth/Draw = <b>' + escapeHtml(String(sel.growthPerDraw||"—")) + '</b>.</li>';
        html += '<li><b>Unusualness score:</b> z(Log Jackpot) = <b>' + escapeHtml(String(sel.zLogJackpot??"—")) + '</b> (' + escapeHtml(jackpotDir) + '); z(Growth/Draw) = <b>' + escapeHtml(String(sel.zGrowthPerDraw??"—")) + '</b> (' + escapeHtml(growthDir) + ').</li>';
        if (sel.notes) html += '<li><b>Notes:</b> ' + escapeHtml(String(sel.notes)) + '</li>';
        html += '</ul></div>';
        html += '<div style="margin-top:10px;line-height:1.55">';
        html += '<div style="font-weight:700;margin-bottom:6px">Why it was flagged (what & why)</div>';
        html += '<div>';
        html += 'A z-score measures distance from the baseline in standard deviations. As a rule of thumb: |z| ≈ 2 is uncommon and |z| ≥ 3 is rare. ';
        html += 'This row was flagged because ' + (flagJ || flagG ? '' : 'its metrics were recorded but did not cross the typical |z|≥2 threshold; ') ;
        html += (flagJ ? 'the jackpot magnitude is unusual (|z(Log Jackpot)| ≥ 2). ' : '');
        html += (flagG ? 'the jackpot growth rate is unusual (|z(Growth/Draw)| ≥ 2). ' : '');
        html += 'This explanation does not recompute or change the outlier logic; it only interprets the metrics already produced.';
        html += '</div></div>';
        html += '<div style="margin-top:10px;line-height:1.55">';
        html += '<div style="font-weight:700;margin-bottom:6px">Recommendations (non-predictive)</div>';
        html += '<ul style="margin:0 0 0 18px;padding:0;line-height:1.55">';
        html += '<li><b>If you prefer large jackpots:</b> Consider playing more when the public jackpot is in an “upper tail” period (large jackpot and/or fast growth). This does not increase odds; it only changes the prize level you are chasing.</li>';
        html += '<li><b>Use as a monitoring trigger:</b> Outliers can flag regime shifts (e.g., unusual rollover streaks). Use them to decide when to review overlays and other descriptive signals.</li>';
        html += '<li><b>Budget discipline:</b> Use preset limits; outliers are still mostly noise.</li>';
        html += '</ul></div>';
      }
    } catch(e){
      // Do not break the page for formatting issues
      html += '<div style="margin-top:10px;color:#b00020">Unable to render the plain-English narrative for this entry. Use the technical trace below.</div>';
    }
    // Optional technical trace (collapsed)
    html += '<details style="margin-top:12px">';
    html += '<summary style="cursor:pointer;font-weight:600">Technical trace (JSON)</summary>';
    html += '<pre style="white-space:pre-wrap;background:#f7f7f7;border:1px solid #e5e5e5;border-radius:8px;padding:10px;margin-top:8px;max-height:280px;overflow:auto">';
    html += escapeHtml(JSON.stringify(obj, null, 2));
    html += '</pre></details>';
    return html;
  }
  function writeOutput(obj){
    const out = qs('enh35Output');
    if (!out) return;
    out.innerHTML = formatAsEnglish(obj);
  }
  function addAuditEntry(entry){
    if (!explainabilityEnabled()) return;
    const arr = loadAudit();
    arr.push(entry);
    saveAudit(arr);
    setAuditStatus();
  }
  function exportAudit(){
    const arr = loadAudit();
    const payload = {
      key: AUDIT_KEY,
      exportedAt: nowIso(),
      count: arr.length,
      entries: arr
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    const stamp = (new Date()).toISOString().replace(/[:.]/g,'-');
    a.href = URL.createObjectURL(blob);
    a.download = 'PB_E3_AUDIT_LOG_V1_' + stamp + '.json';
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ try { URL.revokeObjectURL(a.href); } catch(e){} a.remove(); }, 50);
  }
  function clearAudit(){
    try { localStorage.removeItem(AUDIT_KEY); } catch(e){}
    setAuditStatus();
    writeOutput('Audit log cleared (PB_E3_AUDIT_LOG_V1).');
  }
  function setSelPanel(){
    const s = qs('enh35SelState');
    const c = qs('enh35SelCluster');
    const od = qs('enh35SelOutDate');
    const oz = qs('enh35SelOutZ');
    if (s) s.textContent = SEL.state ? SEL.state.state : '—';
    if (c) c.textContent = SEL.cluster ? SEL.cluster.cluster : '—';
    if (od) od.textContent = SEL.outlier ? SEL.outlier.drawDate : '—';
    if (oz) oz.textContent = SEL.outlier ? (SEL.outlier.zLogJackpot ?? '—') : '—';
  }
  function setBtnStates(){
    const bState = qs('enh35ExplainStateBtn');
    const bClus = qs('enh35ExplainClusterBtn');
    const bOut  = qs('enh35ExplainOutlierBtn');
    const bOv   = qs('enh35ExplainOverlayBtn');
    if (bState) bState.disabled = !SEL.state;
    if (bClus) bClus.disabled = !SEL.cluster;
    if (bOut)  bOut.disabled  = !SEL.outlier;
    // Overlay can always be clickable; when overlays not available, explanation will note it.
    if (bOv) bOv.disabled = false;
    // Visual disabled affordance (inline only; avoid CSS refactors)
    [bState,bClus,bOut].forEach(btn=>{
      if (!btn) return;
      btn.style.opacity = btn.disabled ? '0.45' : '1';
      btn.style.cursor = btn.disabled ? 'not-allowed' : 'pointer';
    });
  }
  function parseRowText(tr){
    // Returns trimmed cell texts (excluding Sel cell if present)
    const cells = Array.from(tr.cells || []);
    const texts = cells.map(td => (td && td.textContent ? td.textContent.trim() : ''));
    return texts;
  }
  function ensureSelCells(tbodyId, tableKey, radioName){
    const tb = qs(tbodyId);
    if (!tb) return;
    const trs = Array.from(tb.querySelectorAll('tr'));
    trs.forEach((tr, idx)=>{
      const tds = Array.from(tr.querySelectorAll('td'));
      if (!tds.length) return;
      // Placeholder row: has a single td with colspan
      if (tds.length === 1 && tds[0].hasAttribute('colspan')) return;
      // Already has sel cell
      const firstTd = tds[0];
      if (firstTd && firstTd.querySelector('input.pbE35SelRadio')) return;
      // Insert sel radio td
      const selTd = document.createElement('td');
      selTd.style.textAlign = 'center';
      selTd.style.verticalAlign = 'middle';
      const r = document.createElement('input');
      r.type = 'radio';
      r.name = radioName;
      r.className = 'pbE35SelRadio';
      r.setAttribute('data-e35-table', tableKey);
      r.setAttribute('data-e35-row', String(idx));
      selTd.appendChild(r);
      tr.insertBefore(selTd, tr.firstChild);
    });
  }
  function attachMutationGuards(){
    const cfg = {childList:true, subtree:false};
    const map = [
      {tbody:'enh3ClustersTbody', key:'cluster', name:'pb_e35_cluster_sel'},
      {tbody:'enh3OutliersTbody', key:'outlier', name:'pb_e35_outlier_sel'},
      {tbody:'enh3StateShareTbody', key:'state', name:'pb_e35_state_sel'},
    ];
    map.forEach(m=>{
      const tb = qs(m.tbody);
      if (!tb) return;
      // Initial pass
      ensureSelCells(m.tbody, m.key, m.name);
      const obs = new MutationObserver(()=>{
        ensureSelCells(m.tbody, m.key, m.name);
      });
      try { obs.observe(tb, cfg); } catch(e){}
    });
  }
  function readClusterFromRow(tr){
    // After Sel insertion: [0]=Sel, [1]=Cluster, [2]=Count, ...
    const cells = Array.from(tr.cells || []);
    const get = (i)=> (cells[i] && cells[i].textContent ? cells[i].textContent.trim() : '');
    return {
      cluster: get(1),
      count: get(2),
      avgJackpot: get(3),
      avgCash: get(4),
      avgRollDraws: get(5),
      avgWinners: get(6),
      dominantMonths: get(7)
    };
  }
  function readOutlierFromRow(tr){
    const cells = Array.from(tr.cells || []);
    const get = (i)=> (cells[i] && cells[i].textContent ? cells[i].textContent.trim() : '');
    return {
      drawDate: get(1),
      jackpot: get(2),
      cash: get(3),
      rollDraws: get(4),
      growthPerDraw: get(5),
      zLogJackpot: get(6),
      zGrowthPerDraw: get(7),
      notes: get(8)
    };
  }
  function readStateFromRow(tr){
    const cells = Array.from(tr.cells || []);
    const get = (i)=> (cells[i] && cells[i].textContent ? cells[i].textContent.trim() : '');
    return {
      state: get(1),
      observedTickets: get(2),
      expectedTickets: get(3),
      obsExp: get(4),
      population: get(5),
      popShare: get(6),
      chiComponent: get(7)
    };
  }
  function handleRadioChange(ev){
    const t = ev.target;
    if (!t || !t.classList || !t.classList.contains('pbE35SelRadio')) return;
    const table = t.getAttribute('data-e35-table');
    const tr = t.closest('tr');
    if (!tr) return;
    if (table === 'cluster') {
      SEL.cluster = readClusterFromRow(tr);
    } else if (table === 'outlier') {
      SEL.outlier = readOutlierFromRow(tr);
    } else if (table === 'state') {
      SEL.state = readStateFromRow(tr);
    }
    setSelPanel();
    setBtnStates();
  }
  function wireRadioDelegation(){
    const tbodies = ['enh3ClustersTbody','enh3OutliersTbody','enh3StateShareTbody'];
    tbodies.forEach(id=>{
      const tb = qs(id);
      if (!tb) return;
      tb.addEventListener('change', handleRadioChange);
    });
  }
  function overlaySnapshot(){
    const enabled = !!(qs('enh34Enable') && qs('enh34Enable').checked);
    const statusText = (qs('enh34Status') && qs('enh34Status').textContent) ? qs('enh34Status').textContent.trim() : '';
    const cats = Array.from(document.querySelectorAll('.enh34Cat')).map(el=>({category: el.value, checked: !!el.checked}));
    function parseTbodyRows(tbodyId){
      const tb = qs(tbodyId);
      if (!tb) return {available:false, rows:[]};
      const rows = [];
      const trs = Array.from(tb.querySelectorAll('tr'));
      trs.forEach(tr=>{
        const tds = Array.from(tr.querySelectorAll('td'));
        if (!tds.length) return;
        if (tds.length===1 && tds[0].hasAttribute('colspan')) return;
        rows.push(tds.map(td => (td.textContent||'').trim()));
      });
      return {available: true, rows};
    }
    const coverage = parseTbodyRows('enh34CoverageTbody');
    const clusterCov = parseTbodyRows('enh34ClusterCovTbody');
    return {
      overlaysEnabled: enabled,
      overlayStatus: statusText || null,
      categories: cats,
      coverageTable: coverage,
      clusterCoverageTable: clusterCov
    };
  }
  function explainSelectedState(){
    if (!SEL.state) return;
    const obj = {
      ruleId: 'E3.5.STATE.EXPLAIN.V1',
      title: 'Explain Selected State Representation',
      summary: 'Explains the selected state’s observed vs expected ticket share and associated components from the descriptive state representation table.',
      trace: {
        timestamp: nowIso(),
        selection: SEL.state,
        references: {
          table: 'State representation vs expected share',
          columns: ['State','Observed Tickets','Expected Tickets','Obs/Exp','Population','Pop Share','Chi Component']
        }
      }
    };
    if (!explainabilityEnabled()) delete obj.trace;
    writeOutput(obj);
    addAuditEntry({event:'explain_state', ...obj});
  }
  function explainSelectedCluster(){
    if (!SEL.cluster) return;
    const obj = {
      ruleId: 'E3.5.CLUSTER.EXPLAIN.V1',
      title: 'Explain Selected Cluster Summary',
      summary: 'Explains the selected clustering row (descriptive only): aggregate metrics and dominant months reported by Pattern Analytics.',
      trace: {
        timestamp: nowIso(),
        selection: SEL.cluster,
        references: {
          table: 'Clustering',
          features: ['log(jackpot)','roll draws to hit','month-of-year','winnerCount'],
          note: 'Cluster labels are display-only; they do not affect predictions/scoring.'
        }
      }
    };
    if (!explainabilityEnabled()) delete obj.trace;
    writeOutput(obj);
    addAuditEntry({event:'explain_cluster', ...obj});
  }
  function explainSelectedOutlier(){
    if (!SEL.outlier) return;
    const zSel = (qs('enh3OutlierZ') && qs('enh3OutlierZ').value) ? String(qs('enh3OutlierZ').value) : null;
    const obj = {
      ruleId: 'E3.5.OUTLIER.EXPLAIN.V1',
      title: 'Explain Selected Outlier',
      summary: 'Explains why the selected record was flagged as an outlier based on z-score thresholds (descriptive only).',
      trace: {
        timestamp: nowIso(),
        selection: SEL.outlier,
        parameters: {
          outlierSensitivityZ: zSel
        },
        references: {
          table: 'Outlier detection',
          zMetrics: ['z(logJackpot)','z(growth/Draw)']
        }
      }
    };
    if (!explainabilityEnabled()) delete obj.trace;
    writeOutput(obj);
    addAuditEntry({event:'explain_outlier', ...obj});
  }
  function explainOverlayCoverage(){
    const snap = overlaySnapshot();
    const obj = {
      ruleId: 'E3.5.OVERLAY.COVERAGE.V1',
      title: 'Explain Overlay Coverage Snapshot',
      summary: snap.coverageTable.available ? 'Captured current overlay enablement state and coverage tables (if populated).' : 'Overlay coverage is not available yet (coverage tables not found).',
      trace: {
        timestamp: nowIso(),
        snapshot: snap
      }
    };
    if (!explainabilityEnabled()) delete obj.trace;
    writeOutput(obj);
    addAuditEntry({event:'explain_overlay_coverage', ...obj});
  }
  function wireButtons(){
    const b1 = qs('enh35ExplainStateBtn');
    const b2 = qs('enh35ExplainClusterBtn');
    const b3 = qs('enh35ExplainOutlierBtn');
    const b4 = qs('enh35ExplainOverlayBtn');
    const b5 = qs('enh35ExportAuditBtn');
    const b6 = qs('enh35ClearAuditBtn');
    const tog = qs('enh35EnableExplainability');
    if (b1) b1.addEventListener('click', ()=>{ if (!SEL.state) return; explainSelectedState(); });
    if (b2) b2.addEventListener('click', ()=>{ if (!SEL.cluster) return; explainSelectedCluster(); });
    if (b3) b3.addEventListener('click', ()=>{ if (!SEL.outlier) return; explainSelectedOutlier(); });
    if (b4) b4.addEventListener('click', ()=>{ explainOverlayCoverage(); });
    if (b5) b5.addEventListener('click', ()=>{ exportAudit(); });
    if (b6) b6.addEventListener('click', ()=>{ clearAudit(); });
    if (tog) tog.addEventListener('change', ()=>{ setAuditStatus(); });
  }
  function init(){
    // Wire after DOM is ready; do not depend on fragile insertion order.
    attachMutationGuards();
    wireRadioDelegation();
    wireButtons();
    setAuditStatus();
    setSelPanel();
    setBtnStates();
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();
})();
// ============================================================================
// Enhancement #9 — Deliverable #1 (vE9 Predictive Architecture Scaffold)
// Additive-only: does NOT mutate locked artifacts. Fail-closed on missing inputs.
// ============================================================================
(function(){
  "use strict";
  const E9 = (window.__pbvNext = window.__pbvNext || {});
  E9.e9 = E9.e9 || {};
  const MOD = E9.e9;
  // ---- Constants (locked by design docs) ----
  const SCHEMA_RUN_MANIFEST = "PB_E9_RUN_MANIFEST_V1";
  const SCHEMA_AUDIT_LEDGER = "PB_E9_AUDIT_LEDGER_V1";
  const LOCKED_HIST_VERSION = "v126";
  const LOCKED_ANALYTICS_TAG = "vE3.5.10";
  // ============================================================================
  // Enhancement #9 — Deliverable #7 (Governance Pack)
  // Stage 7.1: Versioned config constants (immutable)
  // Stage 7.2: Schema validation guards (fail-closed)
  // Stage 7.3: Run manifest + failure modes (already used by runE9Scaffold)
  // ============================================================================
  function deepFreeze(obj){
    if (!obj || typeof obj !== "object") return obj;
    Object.freeze(obj);
    for (const k of Object.keys(obj)){
      const v = obj[k];
      if (v && typeof v === "object" && !Object.isFrozen(v)) deepFreeze(v);
    }
    return obj;
  }
  const PB_E9_MAP_THRESHOLDS_V1 = deepFreeze({
    schemaVersion: "PB_E9_MAP_THRESHOLDS_V1",
    version: "1.0.0",
    // These thresholds are for UI severity badges only. They MUST NOT influence scoring (governance enforced).
    deltaPp: { overHigh: 2.0, overMid: 1.0, underMid: -1.0, underHigh: -2.0 },
    relIndex: { high: 1.35, mid: 1.10, low: 0.90 },
    dataQuality: { minWinsForStable: 3 }
  });
  const PB_E9_CONFIG_V1 = deepFreeze({
    schemaVersion: "PB_E9_CONFIG_V1",
    version: "1.0.0",
    lockedBaselines: deepFreeze({
      historicalData: LOCKED_HIST_VERSION,       // v126 JSON
      explainability: LOCKED_ANALYTICS_TAG       // vE3.5.10 display-only
    }),
    // Risk modes govern weight matrices and dampening (Deliverable #3 contract remains authoritative).
    riskModes: deepFreeze({
      CONSERVATIVE: { id:"CONSERVATIVE", label:"Conservative", gamma: 0.85 },
      BALANCED:     { id:"BALANCED",     label:"Balanced",     gamma: 1.00 },
      AGGRESSIVE:   { id:"AGGRESSIVE",   label:"Aggressive",   gamma: 1.10 }
    }),
    // Hard invariants and veto rules (mirrors Deliverable #3; enforced by runtime assertions).
    invariants: deepFreeze({
      failClosed: true,
      maxWeightCap: 0.55,
      crsCap: 100,
      orasVetoClamp: true,
      cxtMaxAbsPct: 0.03
    }),
    // Signal admissibility: map outputs are DISPLAY_ONLY until explicitly promoted by a future revision.
    admissibility: deepFreeze({
      STATE_MAP_METRICS: "DISPLAY_ONLY",
      STATE_TOAST_PAYLOAD: "DISPLAY_ONLY"
    })
  });
  // ---- Deliverable #12: SRES governance admission via risk-mode (no UI toggle) ----
  // PB_E9_CONFIG_V2 promotes SRES to conditionally admissible and activates it implicitly by risk mode.
  // PB_E9_CONFIG_V1 remains locked and untouched.
  const PB_E9_CONFIG_V2 = deepFreeze({
    schemaVersion: "PB_E9_CONFIG_V2",
    version: "2.0.0",
    lockedBaselines: deepFreeze({
      historicalData: LOCKED_HIST_VERSION,       // v126 JSON
      explainability: LOCKED_ANALYTICS_TAG       // vE3.5.10 display-only
    }),
    riskModes: PB_E9_CONFIG_V1.riskModes,
    invariants: PB_E9_CONFIG_V1.invariants,
    // Module activation is implicit via risk mode (no separate toggles).
    modulesByRiskMode: deepFreeze({
      CONSERVATIVE: deepFreeze({ PAS:true, ORAS:true, ODAS:false, SRES:false, CXT:false }),
      BALANCED:     deepFreeze({ PAS:true, ORAS:true, ODAS:false, SRES:true,  CXT:false }),
      AGGRESSIVE:   deepFreeze({ PAS:true, ORAS:true, ODAS:false, SRES:true,  CXT:false })
    }),
    // Signal admissibility: map outputs remain DISPLAY_ONLY. SRES uses the state-representation table already produced by analytics.
    admissibility: deepFreeze({
      STATE_MAP_METRICS: "DISPLAY_ONLY",
      STATE_TOAST_PAYLOAD: "DISPLAY_ONLY",
      STATE_REPRESENTATION_TABLE: "SCORING_ADMISSIBLE"
    })
  });
  // Active governance config for the current build (vE9.0 + D12).
  function getE9ActiveConfig(){ return PB_E9_CONFIG_V2; }
  // ---- Stage 7.2: schema guards (minimal, strict-enough, fail-closed) ----
  function isPlainObject(x){ return !!x && typeof x === "object" && (x.constructor === Object || Object.getPrototypeOf(x) === null); }
  function validatePB_E9_RUN_MANIFEST_V1(m){
    const errs = [];
    if (!isPlainObject(m)) errs.push("manifest not an object");
    if (String(m?.schemaVersion||"") !== SCHEMA_RUN_MANIFEST) errs.push("schemaVersion mismatch");
    if (!m?.runId) errs.push("runId missing");
    if (!m?.generatedAt) errs.push("generatedAt missing");
    if (!isPlainObject(m?.lockedBaselines)) errs.push("lockedBaselines missing");
    if (String(m?.lockedBaselines?.historicalData||"") !== LOCKED_HIST_VERSION) errs.push("historical baseline mismatch");
    if (String(m?.lockedBaselines?.analyticsTag||"") !== LOCKED_ANALYTICS_TAG) errs.push("analytics baseline mismatch");
    if (!isPlainObject(m?.enabledModules)) errs.push("enabledModules missing");
    return { ok: errs.length === 0, errs };
  }
  function validatePB_E9_AUDIT_LEDGER_V1(l){
    const errs = [];
    if (!isPlainObject(l)) errs.push("ledger not an object");
    if (String(l?.schemaVersion||"") !== SCHEMA_AUDIT_LEDGER) errs.push("schemaVersion mismatch");
    if (!l?.generatedAt) errs.push("generatedAt missing");
    if (!l?.project) errs.push("project missing");
    if (!Array.isArray(l?.events)) errs.push("events must be array");
    // If an OK-like status is present, we require a manifest object reference.
    if (String(l?.status||"").startsWith("OK") && !isPlainObject(l?.runManifest)) errs.push("runManifest missing for OK status");
    return { ok: errs.length === 0, errs };
  }
  function validatePB_E9_PREDICTION_OUTPUT_V1(o){
    const errs = [];
    if (!isPlainObject(o)) errs.push("output not an object");
    if (String(o?.schemaVersion||"") !== SCHEMA_PREDICTION_OUTPUT) errs.push("schemaVersion mismatch");
    if (!o?.generatedAt) errs.push("generatedAt missing");
    if (!o?.runId) errs.push("runId missing");
    if (!o?.project) errs.push("project missing");
    if (!isPlainObject(o?.lockedBaselines)) errs.push("lockedBaselines missing");
    if (String(o?.lockedBaselines?.historicalData||"") !== LOCKED_HIST_VERSION) errs.push("historical baseline mismatch");
    if (String(o?.lockedBaselines?.analyticsTag||"") !== LOCKED_ANALYTICS_TAG) errs.push("analytics baseline mismatch");
    if (!o?.riskMode) errs.push("riskMode missing");
    if (!isPlainObject(o?.confidenceModel)) errs.push("confidenceModel missing");
    if (String(o?.confidenceModel?.method||"") !== "PERCENTILE_BANDING") errs.push("confidenceModel.method mismatch");
    if (!isPlainObject(o?.summary)) errs.push("summary missing");
    if (typeof o?.summary?.candidateUniverseSize !== "number") errs.push("summary.candidateUniverseSize missing");
    if (!Array.isArray(o?.summary?.enabledModules)) errs.push("summary.enabledModules missing");
    if (!Array.isArray(o?.predictions)) errs.push("predictions must be array");
    if (Array.isArray(o?.predictions)){
      o.predictions.forEach((p, i)=>{
        if (typeof p?.rank !== "number") errs.push(`predictions[${i}].rank missing`);
        if (!p?.tier) errs.push(`predictions[${i}].tier missing`);
        if (!isPlainObject(p?.numbers)) errs.push(`predictions[${i}].numbers missing`);
        if (isPlainObject(p?.numbers)){
          if (!Array.isArray(p.numbers.main) || p.numbers.main.length !== 5) errs.push(`predictions[${i}].numbers.main invalid`);
          if (typeof p.numbers.special !== "number") errs.push(`predictions[${i}].numbers.special invalid`);
        }
        if (!isPlainObject(p?.scores)) errs.push(`predictions[${i}].scores missing`);
        if (!isPlainObject(p?.rationale)) errs.push(`predictions[${i}].rationale missing`);
        if (!isPlainObject(p?.auditRef)) errs.push(`predictions[${i}].auditRef missing`);
        if (isPlainObject(p?.auditRef)){
          if (!p.auditRef.candidateId) errs.push(`predictions[${i}].auditRef.candidateId missing`);
          if (!p.auditRef.path) errs.push(`predictions[${i}].auditRef.path missing`);
          if (!p.auditRef.ledgerRunId) errs.push(`predictions[${i}].auditRef.ledgerRunId missing`);
        }
      });
    }
    return { ok: errs.length === 0, errs };
  }
  // Map schemas are validated for structural integrity only (and remain DISPLAY_ONLY).
  function validateStateMapMetricsV1(m){
    const errs = [];
    if (!isPlainObject(m)) errs.push("StateMapMetrics not an object");
    if (!m?.generatedAt) errs.push("generatedAt missing");
    if (!isPlainObject(m?.metricsByJurisdiction)) errs.push("metricsByJurisdiction missing");
    return { ok: errs.length === 0, errs };
  }
  function validateStateToastPayloadV1(p){
    const errs = [];
    if (!isPlainObject(p)) errs.push("StateToastPayload not an object");
    if (!p?.jurisdictionId) errs.push("jurisdictionId missing");
    if (!p?.generatedAt) errs.push("generatedAt missing");
    return { ok: errs.length === 0, errs };
  }
  // Expose governance objects for read-only UI inspection (no mutation).
  MOD.configV1 = PB_E9_CONFIG_V1;
  MOD.configV2 = PB_E9_CONFIG_V2;
  MOD.config = getE9ActiveConfig();
  MOD.mapThresholds = PB_E9_MAP_THRESHOLDS_V1;
  MOD.validators = {
    validatePB_E9_RUN_MANIFEST_V1,
    validatePB_E9_AUDIT_LEDGER_V1,
    validatePB_E9_PREDICTION_OUTPUT_V1,
    validatePB_E9_JEF_OUTPUT_V1,
    validateStateMapMetricsV1,
    validateStateToastPayloadV1
  };
  MOD.jef = {
    buildJefOutputV1,
    validatePB_E9_JEF_OUTPUT_V1
  };
  // ---- Deliverable #2: vE9 Signal Registry (definitive admissible feature list) ----
  // Governing rule: admissible only if candidate-intrinsic or read-only transform of already-computed locked artifacts.
  const PB_E9_SIGNAL_REGISTRY_V1 = {
    schemaVersion: "PB_E9_SIGNAL_REGISTRY_V1",
    version: "1.0.0",
    generatedAt: null, // populated per-run for audit trace
    signals: [
      // Candidate-intrinsic (Hard)
      { id:"CI-01", name:"Main Sum", type:"HARD", sourceClass:"CANDIDATE", scale:"integer", usage:["PAS","ORAS"], admissibility:"OK(candidate-only)", audit:{ functionRef:"sum(main)" } },
      { id:"CI-02", name:"Odd/Even Count", type:"HARD", sourceClass:"CANDIDATE", scale:"object{oddCount,evenCount}", usage:["PAS","ORAS"], admissibility:"OK(candidate-only)", audit:{ ruleRef:"oddEvenCount(main)" } },
      { id:"CI-03", name:"Low/High Count", type:"HARD", sourceClass:"CANDIDATE", scale:"object{lowCount,highCount,threshold}", usage:["PAS","ORAS"], admissibility:"OK(candidate-only)", audit:{ ruleRef:"lowHighCount(main,threshold)" } },
      { id:"CI-04", name:"Decade Histogram", type:"HARD", sourceClass:"CANDIDATE", scale:"vector[7]", usage:["PAS"], admissibility:"OK(candidate-only)", audit:{ bins:"[0-9,10-19,20-29,30-39,40-49,50-59,60-69]" } },
      { id:"CI-05", name:"Gap Pattern", type:"HARD", sourceClass:"CANDIDATE", scale:"vector[4]", usage:["PAS","ORAS"], admissibility:"OK(candidate-only)", audit:{ ruleRef:"sortedGaps(mainSorted)" } },
      { id:"CI-06", name:"Consecutive Run Flags", type:"HARD", sourceClass:"CANDIDATE", scale:"object{hasConsecutive,maxRunLength}", usage:["ORAS"], admissibility:"OK(candidate-only)", audit:{ ruleRef:"consecutiveRuns(mainSorted)" } },
      { id:"CI-07", name:"Special Number Band", type:"HARD", sourceClass:"CANDIDATE", scale:"object{band,thresholds}", usage:["PAS","ORAS"], admissibility:"OK(candidate-only)", audit:{ banding:"LOW 1-9, MID 10-18, HIGH 19-26" } },
      { id:"CI-08", name:"Canonical Candidate ID", type:"HARD", sourceClass:"CANDIDATE", scale:"string", usage:["ALL"], admissibility:"OK(identifier)", audit:{ algo:"canonicalString(mainSorted|PB)" } },
      // Pattern analytics alignment (Hard; derived from locked vE3.5 tables) — computed in later deliverables
      { id:"PA-01", name:"Cluster Fit Score", type:"HARD", sourceClass:"LOCKED_ANALYTICS", scale:"[-1,+1]", usage:["PAS"], admissibility:"OK(if read-only mapping; no recluster)", audit:{ requires:"clusterRowRef + mappingMethodId" } },
      { id:"PA-02", name:"Dominant Month Alignment Score", type:"HARD_OR_DISPLAY", sourceClass:"LOCKED_ANALYTICS", scale:"[-1,+1]", usage:["PAS"], admissibility:"OK(if dominant-months already exist; else display-only)", audit:{ requires:"monthListRef + ruleId" } },
      { id:"PA-03", name:"Jackpot/Roll Regime Alignment Score", type:"HARD_OR_DISABLED", sourceClass:"LOCKED_ANALYTICS", scale:"[-1,+1]", usage:["PAS"], admissibility:"OK only if already emitted as regime outputs", audit:{ requires:"regimeRef + ruleId" } },
      { id:"PA-04", name:"Recency Overlap Score", type:"HARD_OR_DISABLED", sourceClass:"LOCKED_ANALYTICS", scale:"[-1,+1]", usage:["PAS"], admissibility:"OK only if overlap outputs already exist", audit:{ requires:"overlapRef + windowDefRef" } },
      // Outlier regime signals (Hard; derived from locked outlier table) — computed in later deliverables
      { id:"OR-01", name:"Outlier Penalty Score", type:"HARD", sourceClass:"LOCKED_ANALYTICS", scale:"[-1,+1]", usage:["ORAS"], admissibility:"OK(if fixed mapping to existing flags)", audit:{ requires:"outlierRef + matchedFlags + penaltyRuleId" } },
      { id:"OR-02", name:"Rare-Condition Match Count", type:"HARD_SUPPORT", sourceClass:"LOCKED_ANALYTICS", scale:"integer", usage:["ORAS"], admissibility:"OK(derived from OR-01 decomposition)", audit:{ requires:"matchedConditionIds" } },
      { id:"OR-03", name:"Outlier Severity Index", type:"HARD_SUPPORT", sourceClass:"LOCKED_ANALYTICS", scale:"[0..1]|tier", usage:["ORAS"], admissibility:"OK only if deterministic transform of emitted tiers/z-scores", audit:{ transformId:"" } },
      // State representation signals (Hard for map / display-only for prediction unless admissible linkage exists)
      { id:"SR-01", name:"Observed Share %", type:"HARD_MAP", sourceClass:"LOCKED_ANALYTICS", scale:"[0..1]", usage:["MAP","SRES*"], admissibility:"Map OK; scoring only if regime linkage exists", audit:{ requires:"stateRowRef" } },
      { id:"SR-02", name:"Expected Share %", type:"HARD_MAP", sourceClass:"LOCKED_ANALYTICS", scale:"[0..1]", usage:["MAP","SRES*"], admissibility:"Map OK; scoring only if regime linkage exists", audit:{ requires:"baselineRef" } },
      { id:"SR-03", name:"Delta (Obs-Exp)", type:"HARD_MAP", sourceClass:"DERIVED", scale:"[-1,+1]", usage:["MAP","SRES*"], admissibility:"Derived OK; scoring only if linkage exists", audit:{ requires:"deltaRuleId" } },
      { id:"SR-04", name:"Relative Index (Obs/Exp)", type:"HARD_MAP", sourceClass:"DERIVED", scale:"ratio", usage:["MAP","SRES*"], admissibility:"Derived OK; scoring only if linkage exists", audit:{ requires:"ratioRuleId" } },
      { id:"SR-05", name:"Over/Under Classification", type:"DISPLAY_ONLY", sourceClass:"DERIVED", scale:"enum{OVER,UNDER,NEUTRAL}", usage:["MAP","TOAST"], admissibility:"Display-only preferred", audit:{ thresholds:"" } },
      // Overlay signals (Hard if numeric exists; otherwise display-only)
      { id:"OV-01", name:"Overlay Density Score", type:"HARD_OR_DISPLAY", sourceClass:"LOCKED_OVERLAY", scale:"[0..1]", usage:["ODAS"], admissibility:"Only if overlay already emits numeric density", audit:{ requires:"overlayRef" } },
      { id:"OV-02", name:"Overlay Coherence Score", type:"HARD_OR_DISPLAY", sourceClass:"LOCKED_OVERLAY", scale:"[0..1]", usage:["ODAS"], admissibility:"Only if overlay already emits numeric coherence", audit:{ requires:"overlayRef" } },
      { id:"OV-03", name:"Overlay Category Presence Vector", type:"DISPLAY_ONLY", sourceClass:"LOCKED_OVERLAY", scale:"vector[4]", usage:["UI","TOAST"], admissibility:"Display-only by default", audit:{ requires:"categoryFlagsRef" } },
      // Explainability continuity (Display-only references)
      { id:"EX-01", name:"Explainability Trace Reference(s)", type:"DISPLAY_ONLY", sourceClass:"LOCKED_EXPLAINABILITY", scale:"array", usage:["RATIONALE","AUDIT"], admissibility:"Refs only", audit:{ requires:"traceRefIds" } },
      { id:"EX-02", name:"Plain-English Recommendation Snippets", type:"DISPLAY_ONLY", sourceClass:"LOCKED_EXPLAINABILITY", scale:"array", usage:["RATIONALE"], admissibility:"Refs only", audit:{ requires:"snippetRefIds" } },
      // CXT (Soft; bounded; contextual only) — implemented in later deliverables
      { id:"CXT-01", name:"Political Classification (Cook PVI-based)", type:"SOFT", sourceClass:"EXTERNAL_CONTEXT", scale:"enum", usage:["CXT"], admissibility:"Input only", audit:{ requires:"sourceVersion + mappingRule + jurisdictionExclusions" } },
      { id:"CXT-02", name:"Fiscal Stress Score (FSS)", type:"SOFT", sourceClass:"EXTERNAL_CONTEXT", scale:"[0..100]", usage:["CXT"], admissibility:"Input only", audit:{ requires:"sourceVersion + lastUpdated + missingHandling" } },
      { id:"CXT-03", name:"Context Emphasis Factor (CEF)", type:"SOFT", sourceClass:"DERIVED", scale:"[0.97..1.03]", usage:["CXT"], admissibility:"Bounded multiplier only", audit:{ cap:"±3%" } }
    ]
  };
  // ---- Deliverable #3: Scoring Contract v1 (Weights, Caps, Safeguards) ----
  // Governing rule: bounded, auditable scoring; fail-closed on invariant violations.
  const E9_WEIGHTS_BY_MODE_V1 = {
    CONSERVATIVE: { PAS: 0.50, ORAS: 0.25, ODAS: 0.15, SRES: 0.10 },
    AGGRESSIVE:   { PAS: 0.60, ORAS: 0.15, ODAS: 0.15, SRES: 0.10 },
    EXPLORATORY:  { PAS: 0.45, ORAS: 0.20, ODAS: 0.20, SRES: 0.15 }
  };
  const E9_GAMMA_BY_MODE_V1 = {
    CONSERVATIVE: 1.25,
    AGGRESSIVE:   1.10,
    EXPLORATORY:  1.35
  };
  const E9_MODULE_CAPS_V1 = {
    PAS: 0.35,
    ORAS: 0.20,
    ODAS: 0.12,
    SRES: 0.10
  };
  const CRS_CAP_MIN = -0.65;
  const CRS_CAP_MAX = +0.65;
  const CEF_MIN = 0.97;
  const CEF_MAX = 1.03;
  // Optional: Purple dampening. LOCKED for now to Option A (no effect) per D3 recommendation.
  const PURPLE_POLICY = "OPTION_A_POL_0"; // or OPTION_B_POL_0_25 (future; must be explicitly changed and audited)
  function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }
  function sign(x){ return x === 0 ? 0 : (x > 0 ? 1 : -1); }
  function compressScore(mi, gamma){
    const ax = Math.abs(mi);
    return sign(mi) * Math.pow(ax, gamma);
  }
  // Module availability is determined at run-time from already-computed locked artifacts.
  // This is a module-level gate (not candidate-level missing-signal neutralization).
  function determineModuleAvailability(pre){
    // PAS + ORAS are considered "available" if the required locked tables exist (already prechecked).
    // ODAS requires numeric overlay scores (not currently emitted by vE3.5.10).
    // SRES requires an admissible regime-linkage artifact (not currently present).
    return {
      PAS: true,
      ORAS: true,
      ODAS: !!(pre && pre.overlayNumericPresent),
      SRES: !!(pre && pre.stateRegimeLinkagePresent)
    };
  }
    function normalizeWeights(weights, enabledModules){
    // Apply governed envelope:
    // - all weights >= 0
    // - sum(enabled weights) = 1.0
    // - max(wi) <= 0.65 (hard, enforced via cap+redistribution)
    // - min meaningful weight (if enabled) >= 0.05; else disable (and redistribute)
    let w = { ...weights };
    const disabled = {};
    const redistribution = [];
    // sanitize
    Object.keys(w).forEach(k => { if (w[k] < 0) w[k] = 0; });
    // Disable modules that are not enabled at module-level
    Object.entries(enabledModules).forEach(([k, v]) => {
      if (!v) { disabled[k] = "MODULE_DISABLED"; w[k] = 0; }
    });
    // Disable "too small to matter"
    Object.keys(w).forEach(k => {
      if (w[k] > 0 && w[k] < 0.05){
        disabled[k] = "WEIGHT_BELOW_MIN";
        w[k] = 0;
      }
    });
    // Normalize helper
    const renorm = () => {
      const sum = Object.values(w).reduce((a,b)=>a+b,0);
      if (sum <= 0){
        throw new Error("E9_WEIGHT_INVARIANT_FAIL: no enabled modules after gating");
      }
      Object.keys(w).forEach(k => { w[k] = w[k] / sum; });
    };
    renorm();
    // Enforce max single-module weight (hard) by capping + redistributing remainder.
    // This situation can occur when ODAS/SRES are unavailable and weights renormalize upward.
    const MAX_SINGLE = 0.65;
    const EPS = 1e-12;
    // Iterative cap+redistribute (defensive, though typical cases converge in 1 pass)
    for (let pass = 0; pass < 4; pass++){
      let over = [];
      for (const [k, v] of Object.entries(w)){
        if (v > MAX_SINGLE + 1e-9) over.push([k, v]);
      }
      if (over.length === 0) break;
      // Cap all offenders
      for (const [k, v] of over){
        w[k] = MAX_SINGLE;
      }
      // Redistribute leftover across non-capped enabled modules proportionally
      const cappedKeys = new Set(over.map(x => x[0]));
      const enabledKeys = Object.keys(w).filter(k => w[k] > 0 || cappedKeys.has(k));
      const others = enabledKeys.filter(k => !cappedKeys.has(k));
      const sumNow = enabledKeys.reduce((a,k)=>a+w[k],0);
      let remainder = 1 - sumNow;
      // due to numeric drift, remainder can be tiny
      if (Math.abs(remainder) < 1e-10) remainder = 0;
      if (others.length === 0){
        // Only one enabled module remains -> impossible to satisfy MAX_SINGLE while summing to 1.
        throw new Error("E9_WEIGHT_INVARIANT_FAIL: only one enabled module; cannot satisfy max-weight constraint");
      }
      const base = others.reduce((a,k)=>a+w[k],0);
      if (base <= EPS){
        // If all others are zero (shouldn't happen), distribute equally
        const add = remainder / others.length;
        for (const k of others) w[k] = Math.max(0, w[k] + add);
      } else {
        for (const k of others){
          const share = w[k] / base;
          w[k] = Math.max(0, w[k] + remainder * share);
        }
      }
      redistribution.push({
        pass: pass + 1,
        reason: "MAX_WEIGHT_CAP_REDISTRIBUTION",
        capped: over.map(([k,v]) => ({ module:k, prior:v, cappedTo:MAX_SINGLE }))
      });
      // Renormalize lightly to correct drift
      const s = Object.values(w).reduce((a,b)=>a+b,0);
      if (Math.abs(s - 1) > 1e-9) renorm();
    }
    // Final assertions
    const maxW = Math.max(...Object.values(w));
    if (maxW > 0.65 + 1e-9){
      throw new Error(`E9_WEIGHT_INVARIANT_FAIL: max weight ${maxW.toFixed(3)} > 0.65 after redistribution`);
    }
    const sumFinal = Object.values(w).reduce((a,b)=>a+b,0);
    if (Math.abs(sumFinal - 1) > 1e-6){
      throw new Error(`E9_WEIGHT_INVARIANT_FAIL: weights not normalized (sum=${sumFinal.toFixed(6)})`);
    }
    return { weights: w, disabled, redistribution };
  }
  // Candidate-level module scoring placeholders:
  // Deliverable #3 locks the scoring contract, not the analytic mappings (those are introduced in Deliverables #4/#5).
  // Therefore, if a module cannot compute a candidate score due to missing linkage, it must return Mi=0 (neutral) and log missingReason.
  // ---- Deliverable #4: Predictive Output Definition (vE9.x) ----
  // Canonical UI-consumed object derived from (not replacing) the audit ledger.
  const SCHEMA_PREDICTION_OUTPUT = "PB_E9_PREDICTION_OUTPUT_V1";
  const E9_CONF_BANDS_V1 = [
    { tier:"A", pctFrom: 0.00, pctTo: 0.01, label:"Top 1%" },
    { tier:"B", pctFrom: 0.01, pctTo: 0.05, label:"Next 4%" },
    { tier:"C", pctFrom: 0.05, pctTo: 0.20, label:"Next 15%" },
    { tier:"D", pctFrom: 0.20, pctTo: 1.00, label:"Remainder" }
  ];
  // ---- Enhancement #12 (D3): Jackpot Event Forecast (JEF) — Core Generator (Deterministic, Fail-Closed) ----
  // Guardrails:
  //  - No causal claims; CXT is isolated as non-causal observations only.
  //  - No absolute win probability language; confidence is relative bands only.
  //  - Fail-closed if required inputs missing.
  //  - Deterministic given same inputs.

  const SCHEMA_JEF_OUTPUT = "PB_E9_JEF_OUTPUT_V1";

  const JEF_CONF_BANDS_V1 = [
    { band:"Band A", rankFrom:1, rankTo:2, label:"Higher relative signal" },
    { band:"Band B", rankFrom:3, rankTo:6, label:"Moderate relative signal" },
    { band:"Band C", rankFrom:7, rankTo:10, label:"Lower relative signal" }
  ];

  const JEF_REQUIRED_DISCLAIMERS_V1 = [
    "Experimental. Observational patterns only; not causal.",
    "No win odds are implied or stated.",
    "Jurisdiction ranking (if present) reflects allocation/visibility metrics only."
  ];

  // Fixed phrase mapping (no narrative invention). Unknown driver keys fall back to DRV_OTHER.
  const JEF_DRIVER_PHRASES_V1 = Object.freeze({
    DRV_E9_RANK: "vE9 candidate rank signal (observational).",
    DRV_E9_TIER: "vE9 confidence tier band (observational).",
    DRV_E9_OVERLAP: "Historical overlap feature (observational).",
    DRV_E9_FREQ: "Frequency / recency feature (observational).",
    DRV_E9_SEPT: "September alignment feature (observational).",
    DRV_MAP_VIS: "State visibility/allocation metric (non-causal).",
    DRV_LIFECYCLE: "Jackpot lifecycle timing feature (observational).",
    DRV_OTHER: "Observed driver from audit ledger (see refs).",
    CXT_OTHER: "Non-causal observations (context only)."
  });

  function jefBandForRank(rank){
    for (const b of JEF_CONF_BANDS_V1){
      if (rank >= b.rankFrom && rank <= b.rankTo) return b.band;
    }
    return "Band C";
  }

  function isoDate(d){
    const z = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    return z.toISOString().slice(0,10);
  }

  function parseISODate(s){
    // expects YYYY-MM-DD
    if (!s || typeof s !== "string") return null;
    const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(s.trim());
    if (!m) return null;
    const y = +m[1], mo = +m[2]-1, da = +m[3];
    const d = new Date(y, mo, da);
    if (isNaN(d.getTime())) return null;
    // normalize to local date (midnight)
    d.setHours(0,0,0,0);
    return d;
  }

  function clamp01(x){ return Math.max(0, Math.min(1, Number(x)||0)); }

  function safeNum(x, fallback=null){
    const n = Number(x);
    return Number.isFinite(n) ? n : fallback;
  }

  function dateDiffDays(a,b){
    // both Date objects normalized to midnight
    const ms = (b.getTime() - a.getTime());
    return Math.round(ms / 86400000);
  }

  function getNextDrawDates(fromDate, count){
    const allowed = new Set([1,3,6]); // Mon/Wed/Sat (JS getDay: Sun=0)
    const out = [];
    let d = new Date(fromDate.getTime());
    d.setHours(0,0,0,0);
    // Start searching from "fromDate" inclusive
    for (let guard=0; guard<400 && out.length<count; guard++){
      if (allowed.has(d.getDay())) out.push(new Date(d.getTime()));
      d = new Date(d.getTime() + 86400000);
    }
    return out;
  }

  function linearRegressionSlope(xs, ys){
    // returns slope; deterministic; requires same-length arrays >=2
    const n = Math.min(xs.length, ys.length);
    if (n < 2) return null;
    let sumX=0,sumY=0,sumXX=0,sumXY=0;
    for (let i=0;i<n;i++){
      const x = xs[i], y = ys[i];
      sumX += x; sumY += y;
      sumXX += x*x; sumXY += x*y;
    }
    const denom = (n*sumXX - sumX*sumX);
    if (!denom) return null;
    return (n*sumXY - sumX*sumY) / denom;
  }

  function computeDrawHistoryStats(drawHistory){
    // Expected minimal shape:
    // { lastJackpotWinDate: "YYYY-MM-DD", draws: [{date:"YYYY-MM-DD", jackpot:number, jackpotWon:boolean}] }
    // Deterministic, conservative: require enough information to compute lifecycle.
    const errs = [];
    if (!isPlainObject(drawHistory)) errs.push("drawHistory not an object");
    const draws = Array.isArray(drawHistory?.draws) ? drawHistory.draws.slice() : null;
    if (!draws) errs.push("drawHistory.draws missing");
    if (errs.length) return { ok:false, errs };

    // sanitize & sort by date ascending
    const cleaned = [];
    for (const r of draws){
      const d = parseISODate(r?.date);
      const j = safeNum(r?.jackpot, null);
      const won = !!r?.jackpotWon;
      if (!d || j===null) continue;
      cleaned.push({ d, date: isoDate(d), jackpot: j, jackpotWon: won });
    }
    cleaned.sort((a,b)=>a.d-b.d);

    if (cleaned.length < 20) return { ok:false, errs:["drawHistory draws insufficient (<20)"] };

    // last jackpot win date
    let lastWin = parseISODate(drawHistory?.lastJackpotWinDate);
    if (!lastWin){
      // derive from latest jackpotWon
      for (let i=cleaned.length-1;i>=0;i--){
        if (cleaned[i].jackpotWon){ lastWin = cleaned[i].d; break; }
      }
    }
    if (!lastWin) return { ok:false, errs:["lastJackpotWinDate missing and cannot derive"] };

    // build jackpot cycles: consecutive jackpotWon markers
    const winDates = [];
    for (const r of cleaned) if (r.jackpotWon) winDates.push(r.d);
    if (winDates.length < 10) return { ok:false, errs:["insufficient jackpot win history (<10 wins)"] };

    const cycleDays = [];
    const cycleDrawCounts = [];
    for (let i=1;i<winDates.length;i++){
      const a=winDates[i-1], b=winDates[i];
      cycleDays.push(dateDiffDays(a,b));
      // approximate draw count by counting draws between
      let cnt=0;
      for (const r of cleaned){
        if (r.d>a && r.d<=b) cnt++;
      }
      cycleDrawCounts.push(cnt);
    }

    // current rollover streak length: count draws after lastWin until latest draw (exclusive if latest is win)
    const latest = cleaned[cleaned.length-1].d;
    let streak=0;
    for (const r of cleaned){
      if (r.d > lastWin && !r.jackpotWon) streak++;
    }

    // growth rate: slope of log(jackpot) over last M draws
    const M=8;
    const recent = cleaned.slice(Math.max(0, cleaned.length-M));
    if (recent.length < 5) return { ok:false, errs:["insufficient recent jackpot points (<5)"] };
    const xs = recent.map((_,i)=>i);
    const ys = recent.map(r=>Math.log(Math.max(1,r.jackpot)));
    const growth = linearRegressionSlope(xs, ys);

    // dow/month win shares
    const winsByDow = {1:0,3:0,6:0};
    const winsByMonth = Array.from({length:12}, ()=>0);
    let totalWins=0;
    for (const d of winDates){
      const dow = d.getDay();
      if (winsByDow[dow] !== undefined) winsByDow[dow]++;
      winsByMonth[d.getMonth()]++;
      totalWins++;
    }
    const maxDow = Math.max(winsByDow[1], winsByDow[3], winsByDow[6], 1);
    const maxMonth = Math.max(...winsByMonth, 1);

    // percentiles (deterministic): use sorted arrays
    function pct(arr, p){
      const a = arr.slice().sort((x,y)=>x-y);
      if (!a.length) return null;
      const idx = Math.min(a.length-1, Math.max(0, Math.floor(p*(a.length-1))));
      return a[idx];
    }
    const p50_days = pct(cycleDays, 0.50);
    const p90_days = pct(cycleDays, 0.90);
    const p50_streak = pct(cycleDrawCounts, 0.50);
    const p90_streak = pct(cycleDrawCounts, 0.90);

    // growth distribution from rolling windows for stability
    const growthSamples = [];
    for (let i=0;i<=cleaned.length-M;i++){
      const win = cleaned.slice(i, i+M);
      if (win.length<5) continue;
      const xs = win.map((_,k)=>k);
      const ys = win.map(r=>Math.log(Math.max(1,r.jackpot)));
      const s = linearRegressionSlope(xs, ys);
      if (Number.isFinite(s)) growthSamples.push(s);
    }
    const p50_growth = pct(growthSamples, 0.50) ?? 0;
    const p90_growth = pct(growthSamples, 0.90) ?? (p50_growth + 1e-6);

    return {
      ok:true,
      cleaned,
      lastWin,
      latest,
      currentRolloverStreak: streak,
      growth,
      p50_days, p90_days,
      p50_streak, p90_streak,
      p50_growth, p90_growth,
      winsByDow, maxDow,
      winsByMonth, maxMonth,
      yearsCovered: (cleaned[cleaned.length-1].d.getFullYear() - cleaned[0].d.getFullYear() + 1)
    };
  }

  function scoreDateWindowForDate(d, stats){
    // returns {dateScore, components}
    const daysSinceWin = dateDiffDays(stats.lastWin, d);
    // f_time via bounded scaling (fallback if p90==p50)
    const denomDays = Math.max(1, (stats.p90_days - stats.p50_days) || 1);
    const f_time = clamp01((daysSinceWin - stats.p50_days) / denomDays);

    const idxFromNow = 0; // upstream may provide; we keep streak incremental externally
    const streakPred = stats.currentRolloverStreak + idxFromNow; // overwritten by caller if desired
    const denomStreak = Math.max(1, (stats.p90_streak - stats.p50_streak) || 1);
    const f_roll = clamp01((streakPred - stats.p50_streak) / denomStreak);

    const growth = safeNum(stats.growth, stats.p50_growth);
    const denomGrowth = Math.max(1e-9, (stats.p90_growth - stats.p50_growth) || 1e-9);
    const f_growth = clamp01((growth - stats.p50_growth) / denomGrowth);

    const dow = d.getDay();
    const dowWins = stats.winsByDow[dow] || 0;
    const f_dow = clamp01(dowWins / stats.maxDow);

    const hasMonth = stats.yearsCovered >= 5;
    const monthWins = stats.winsByMonth[d.getMonth()] || 0;
    const f_month = hasMonth ? clamp01(monthWins / stats.maxMonth) : null;

    let w_time=0.30, w_roll=0.25, w_growth=0.25, w_dow=0.15, w_month=0.05;
    if (!hasMonth){ w_time += w_month; w_month = 0; }

    const dateScore = clamp01(
      w_time*f_time +
      w_roll*f_roll +
      w_growth*f_growth +
      w_dow*f_dow +
      (hasMonth ? (w_month*(f_month||0)) : 0)
    );

    return { dateScore, components: { f_time, f_roll, f_growth, f_dow, f_month, daysSinceWin } };
  }

  function computeWhereRanking(mapMetrics){
    // Returns { ok, ranked:[{jurisdiction, weight, disclosure}], whereScoreTop } or ok:false if unusable.
    if (!isPlainObject(mapMetrics)) return { ok:false, ranked:[], whereScoreTop:null };
    const nonPB = new Set(["AL","AK","HI","NV","UT"]);
    const entries = [];
    const jurisdictions = mapMetrics?.jurisdictions || mapMetrics?.states || null;
    if (!isPlainObject(jurisdictions)) return { ok:false, ranked:[], whereScoreTop:null };

    for (const [st, v] of Object.entries(jurisdictions)){
      const S = String(st||"").toUpperCase();
      if (!/^[A-Z]{2}$/.test(S)) continue;
      if (nonPB.has(S)) continue;
      const delta = safeNum(v?.deltaPct, null);
      if (delta === null) continue;
      const wRaw = clamp01(0.5 + (delta / 6.0)); // conservative scaling
      entries.push({ jurisdiction:S, wRaw });
    }
    if (!entries.length) return { ok:false, ranked:[], whereScoreTop:null };

    const sum = entries.reduce((a,b)=>a+b.wRaw, 0) || 1;
    const ranked = entries
      .map(e=>({ jurisdiction:e.jurisdiction, weight: e.wRaw/sum }))
      .sort((a,b)=> (b.weight-a.weight) || (a.jurisdiction.localeCompare(b.jurisdiction)))
      .slice(0,5)
      .map(e=>({
        jurisdiction: e.jurisdiction,
        weight: +e.weight.toFixed(6),
        disclosure: "Allocation/visibility only; not a causal predictor."
      }));

    const whereScoreTop = ranked.length ? ranked[0].weight : null;
    return { ok:true, ranked, whereScoreTop };
  }

  function selectPlaySetsFromE9(predOutput, eventRank, k=3){
    const candidates = Array.isArray(predOutput?.candidates) ? predOutput.candidates : [];
    const out = [];
    const offset = (eventRank-1)*k;
    for (let i=0;i<k;i++){
      const c = candidates[offset+i];
      if (!c) continue;
      const cid = String(c?.candidateId||c?.id||"").trim();
      const nums = Array.isArray(c?.numbers) ? c.numbers.slice(0,5) : null;
      const pb = safeNum(c?.powerball ?? c?.pb, null);
      const tier = String(c?.tier||c?.confTier||"").toUpperCase() || null;
      if (!cid || !nums || nums.length!==5 || pb===null) continue;
      out.push({
        vE9CandidateId: cid,
        numbers: nums.map(n=>+n),
        powerball: +pb,
        tier: tier || null
      });
    }
    return out;
  }

  function extractDriversForCandidateIds(auditLedger, candidateIds){
    // Returns { ok, drivers, cxtItems, auditRefs }.
    // Strict: if no linked events found for any candidateId => fail (Why required).
    const events = Array.isArray(auditLedger?.events) ? auditLedger.events : null;
    if (!events) return { ok:false, drivers:[], cxtItems:[], auditRefs:{ledgerEntryIds:[]} };

    const want = new Set(candidateIds.filter(Boolean));
    const linked = [];
    for (const e of events){
      const cid = String(e?.candidateId||"").trim();
      const cids = Array.isArray(e?.candidateIds) ? e.candidateIds.map(x=>String(x||"").trim()).filter(Boolean) : null;
      const hit = (cid && want.has(cid)) || (cids && cids.some(x=>want.has(x)));
      if (!hit) continue;
      linked.push(e);
    }
    if (!linked.length) return { ok:false, drivers:[], cxtItems:[], auditRefs:{ledgerEntryIds:[]} };

    const drivers = [];
    const cxtItems = [];
    const ledgerEntryIds = [];

    // deterministic ordering: by (event.order||event.ts||index) then lexical id
    linked.forEach((e, idx)=>{ e.__jefIdx = idx; });

    linked.sort((a,b)=>{
      const ao = safeNum(a?.order, null);
      const bo = safeNum(b?.order, null);
      if (ao!==null && bo!==null && ao!==bo) return ao-bo;
      const at = String(a?.ts||a?.time||"");
      const bt = String(b?.ts||b?.time||"");
      if (at && bt && at!==bt) return at.localeCompare(bt);
      const aid = String(a?.id||a?.eventId||"");
      const bid = String(b?.id||b?.eventId||"");
      if (aid && bid && aid!==bid) return aid.localeCompare(bid);
      return (a.__jefIdx||0) - (b.__jefIdx||0);
    });

    // map each linked event to a fixed phrase
    for (const e of linked){
      const id = String(e?.id||e?.eventId||"").trim();
      if (id) ledgerEntryIds.push(id);

      const isCxt = String(e?.type||e?.category||"").toUpperCase().includes("CXT") || !!e?.cxt;
      const key = String(e?.phraseId||e?.driverKey||e?.key||"").trim();
      const phraseId = key && (JEF_DRIVER_PHRASES_V1[key] ? key : null);
      const chosenId = phraseId || (isCxt ? "CXT_OTHER" : "DRV_OTHER");
      const phraseText = JEF_DRIVER_PHRASES_V1[chosenId];

      const exrefs = Array.isArray(e?.exrefs) ? e.exrefs.map(x=>String(x||"")).filter(Boolean) : [];

      const item = { phraseId: chosenId, phraseText, exrefs };
      if (isCxt) cxtItems.push(item);
      else drivers.push(item);
    }

    // cap to keep cards readable (deterministic truncation)
    const driversCapped = drivers.slice(0,6);
    const cxtCapped = cxtItems.slice(0,6);

    return { ok:true, drivers: driversCapped, cxtItems: cxtCapped, auditRefs:{ ledgerEntryIds } };
  }

  function buildJefOutputV1({ predOutput, auditLedger, mapMetrics, drawHistory, nowDate=null }){
    // Returns PB_E9_JEF_OUTPUT_V1. Fail-closed: status INSUFFICIENT_DATA and no forecasts.
    const missing = [];
    if (!predOutput) missing.push("vE9Predictions");
    if (!auditLedger) missing.push("auditLedger");
    if (!drawHistory) missing.push("powerballNetData");

    const inputsPresent = {
      vE9Predictions: !!predOutput,
      auditLedger: !!auditLedger,
      mapMetrics: !!mapMetrics,
      powerballNetData: !!drawHistory
    };

    // Normalize nowDate to Date instance (accept Date or ISO string); deterministic default = current time
    try {
      if (nowDate && !(nowDate instanceof Date)) nowDate = new Date(nowDate);
      if (!(nowDate instanceof Date) || isNaN(nowDate.getTime())) nowDate = new Date();
    } catch(e) { nowDate = new Date(); }

    // Validate vE9 prediction output shape (must provide ranked candidates with candidateId + numbers + powerball)
    const ranked = predOutput?.rankedCandidates || predOutput?.ranked || predOutput?.candidates || [];
    if (predOutput && (!Array.isArray(ranked) || ranked.length < 1)) missing.push("vE9Predictions(rankedCandidates)");

    // Validate audit ledger shape (entries array required)
    const ledgerEntries = auditLedger?.entries || auditLedger?.events || auditLedger?.ledger || [];
    if (auditLedger && (!Array.isArray(ledgerEntries) || ledgerEntries.length < 1)) missing.push("auditLedger(entries)");

    // Validate draw history shape (draws array + lastJackpotWinDate or derivable win marker)
    let dhDraws = drawHistory?.draws || drawHistory?.items || drawHistory?.history || null;
    if (drawHistory && !Array.isArray(dhDraws)) missing.push("powerballNetData(draws)");
    if (Array.isArray(dhDraws) && dhDraws.length < 5) missing.push("powerballNetData(draws<5)");

    let lastWin = drawHistory?.lastJackpotWinDate || drawHistory?.lastJackpotWin || null;
    if (!lastWin && Array.isArray(dhDraws)) {
      // Derive from most recent draw where jackpotWon === true
      for (let i = dhDraws.length - 1; i >= 0; i--) {
        const it = dhDraws[i];
        if (it && (it.jackpotWon === true || it.won === true || it.isJackpotWin === true)) { lastWin = it.date || it.drawDate || null; break; }
      }
    }
    if (drawHistory && !lastWin) missing.push("powerballNetData(lastJackpotWinDate)");

    const baseRunId = String(predOutput?.runId||predOutput?.runID||"").trim() || "UNKNOWN";
    const generatedAt = new Date().toISOString();

    const stableInputs = {
      schema: SCHEMA_JEF_OUTPUT,
      runId: baseRunId,
      predHash: predOutput ? fnv1a32(stableStringify(predOutput)).toString(36) : "0",
      ledgerHash: auditLedger ? fnv1a32(stableStringify(auditLedger)).toString(36) : "0",
      mapHash: mapMetrics ? fnv1a32(stableStringify(mapMetrics)).toString(36) : "0",
      drawHash: drawHistory ? fnv1a32(stableStringify(drawHistory)).toString(36) : "0"
    };
    const jefRunId = "JEF-" + fnv1a32(stableStringify(stableInputs)).toString(36);

    const outBase = {
      schemaVersion: SCHEMA_JEF_OUTPUT,
      generatedAt,
      run: {
        runId: baseRunId,
        jefRunId,
        versions: {
          app: String(window?.__pbvNext?.version||""),
          e9PredictionSchema: SCHEMA_PREDICTION_OUTPUT,
          auditLedgerSchema: SCHEMA_AUDIT_LEDGER,
          mapMetricsSchema: "StateMapMetricsV1"
        },
        lockedBaselines: {
          historicalData: LOCKED_HIST_VERSION,
          analyticsTag: LOCKED_ANALYTICS_TAG
        }
      },
      inputsPresent,
      status: "OK",
      missingInputs: [],
      eventForecasts: []
    };

    // fail-closed fast
    if (missing.length){
      outBase.status = "INSUFFICIENT_DATA";
      outBase.missingInputs = missing.slice();
      return outBase;
    }

    // validate required schemas (conservative)
    try{
      const vr1 = validatePB_E9_PREDICTION_OUTPUT_V1(predOutput);
      if (!vr1.ok) missing.push("vE9Predictions(schema)");
    } catch(e){ missing.push("vE9Predictions(schema)"); }

    try{
      const vr2 = validatePB_E9_AUDIT_LEDGER_V1(auditLedger);
      if (!vr2.ok) missing.push("auditLedger(schema)");
    } catch(e){ missing.push("auditLedger(schema)"); }

    const stats = computeDrawHistoryStats(drawHistory);
    if (!stats.ok) missing.push("powerballNetData(insufficient)");

    if (missing.length){
      outBase.status = "INSUFFICIENT_DATA";
      outBase.missingInputs = missing.slice();
      return outBase;
    }

    // compute where ranking once (optional)
    const where = computeWhereRanking(mapMetrics);
    let now;
    try{
      if (nowDate instanceof Date){ now = new Date(nowDate.getTime()); }
      else if (typeof nowDate === "string" && nowDate){ now = new Date(nowDate); }
      else { now = new Date(); }
    } catch(e){ now = new Date(); }
    now.setHours(0,0,0,0);
    const horizon = getNextDrawDates(now, 12);

    // score each horizon date deterministically, incorporating streak index k into f_roll
    const scored = horizon.map((d, k)=>{
      const s = scoreDateWindowForDate(d, stats);
      // apply rollover increment into roll component deterministically
      const streakPred = stats.currentRolloverStreak + k;
      const denomStreak = Math.max(1, (stats.p90_streak - stats.p50_streak) || 1);
      const f_roll = clamp01((streakPred - stats.p50_streak) / denomStreak);

      // rebuild dateScore with adjusted f_roll (preserves other components)
      const c = s.components;
      const hasMonth = (stats.yearsCovered >= 5);
      let w_time=0.30, w_roll=0.25, w_growth=0.25, w_dow=0.15, w_month=0.05;
      if (!hasMonth){ w_time += w_month; w_month = 0; }

      const dateScore = clamp01(
        w_time*c.f_time +
        w_roll*f_roll +
        w_growth*c.f_growth +
        w_dow*c.f_dow +
        (hasMonth ? (w_month*(c.f_month||0)) : 0)
      );

      const whereScore = (where.ok && where.whereScoreTop!==null) ? clamp01(where.whereScoreTop) : 0;
      const eventScore = clamp01(0.70*dateScore + 0.30*whereScore);

      return {
        d,
        k,
        dateScore,
        whereScore: (where.ok ? whereScore : null),
        eventScore
      };
    });

    // deterministic ordering + tie-breakers
    scored.sort((a,b)=>{
      if (b.eventScore !== a.eventScore) return b.eventScore - a.eventScore;
      const ad = isoDate(a.d), bd = isoDate(b.d);
      if (ad !== bd) return ad.localeCompare(bd);
      return a.k - b.k;
    });

    const candidates = Array.isArray(predOutput?.candidates) ? predOutput.candidates : [];
    if (!candidates.length){
      outBase.status = "INSUFFICIENT_DATA";
      outBase.missingInputs = ["vE9Predictions(candidates missing)"];
      return outBase;
    }

    const topEvents = scored.slice(0,10);
    const forecasts = [];

    for (let i=0;i<topEvents.length;i++){
      const rank = i+1;
      const primaryDate = topEvents[i].d;
      const horizonIdx = topEvents[i].k;

      // window: [d-1 draw, d+1 draw] within horizon
      const wStartIdx = Math.max(0, horizonIdx-1);
      const wEndIdx = Math.min(horizon.length-1, horizonIdx+1);

      const playSets = selectPlaySetsFromE9(predOutput, rank, 3);
      const cids = playSets.map(p=>p.vE9CandidateId);

      // Drivers
      const drv = extractDriversForCandidateIds(auditLedger, cids);
      if (!drv.ok){
        // strict fail-closed: Why is required and must be linked
        outBase.status = "INSUFFICIENT_DATA";
        outBase.missingInputs = ["auditLedger(linkage missing for candidateIds)"];
        outBase.eventForecasts = [];
        return outBase;
      }

      const jurisdictions = where.ok ? where.ranked : [];
      const whereBlockOk = where.ok && jurisdictions.length;

      forecasts.push({
        rank,
        confidenceBand: jefBandForRank(rank),
        scores: {
          eventScore: +topEvents[i].eventScore.toFixed(6),
          dateScore: +topEvents[i].dateScore.toFixed(6),
          whereScore: (topEvents[i].whereScore===null ? null : +topEvents[i].whereScore.toFixed(6))
        },
        dateWindow: {
          startDate: isoDate(horizon[wStartIdx]),
          endDate: isoDate(horizon[wEndIdx]),
          preferredDrawDate: isoDate(primaryDate)
        },
        jurisdictions: whereBlockOk ? jurisdictions : [],
        playSets,
        drivers: drv.drivers,
        disclosures: {
          requiredDisclaimers: JEF_REQUIRED_DISCLAIMERS_V1.slice(),
          cxtNonCausalBlock: {
            present: !!drv.cxtItems.length,
            label: "Non-causal observations (context only).",
            items: drv.cxtItems
          }
        },
        auditRefs: {
          ledgerEntryIds: drv.auditRefs.ledgerEntryIds.slice(),
          mapCacheKey: null
        }
      });
    }

    // attach and return
    outBase.eventForecasts = forecasts;
    return outBase;
  }

  // (Optional) validator for JEF output. Used for internal self-tests and export hardening.
  function validatePB_E9_JEF_OUTPUT_V1(o){
    const errs = [];
    if (!isPlainObject(o)) errs.push("jef output not an object");
    if (String(o?.schemaVersion||"") !== SCHEMA_JEF_OUTPUT) errs.push("schemaVersion mismatch");
    if (!o?.generatedAt) errs.push("generatedAt missing");
    if (!isPlainObject(o?.run)) errs.push("run missing");
    if (!isPlainObject(o?.inputsPresent)) errs.push("inputsPresent missing");
    if (!String(o?.status||"")) errs.push("status missing");
    if (String(o?.status) === "INSUFFICIENT_DATA"){
      if (!Array.isArray(o?.missingInputs) || !o.missingInputs.length) errs.push("missingInputs must be non-empty on INSUFFICIENT_DATA");
      if (Array.isArray(o?.eventForecasts) && o.eventForecasts.length) errs.push("eventForecasts must be empty on INSUFFICIENT_DATA");
    }
    if (String(o?.status) === "OK"){
      if (!Array.isArray(o?.eventForecasts)) errs.push("eventForecasts must be array");
      if (Array.isArray(o?.eventForecasts) && o.eventForecasts.length > 10) errs.push("eventForecasts > 10");
    }
    return { ok: errs.length === 0, errs };
  }


  // Fixed phrase mapping only (no invented logic).
  const E9_DRIVER_PHRASES_V1 = {
    PAS_POS: "Strong pattern alignment",
    PAS_NEG: "Pattern misalignment",
    ORAS_POS:"Low outlier exposure",
    ORAS_NEG:"Matches rare-condition flags",
    ODAS_POS:"Strong overlay support",
    ODAS_NEG:"Limited overlay support",
    SRES_POS:"Favorable state representation alignment",
    SRES_NEG:"State representation headwinds",
    CXT_APPLIED:"Contextual emphasis applied (bounded)",
    CXT_NONE:"No contextual emphasis applied."
  };
  const E9_RISK_HINTS_V1 = {
    CONSERVATIVE: "Prioritizes historically stable patterns and avoids rare conditions.",
    AGGRESSIVE: "Leans into dominant patterns with softer penalties.",
    EXPLORATORY: "Encourages diversity while remaining historically grounded."
  };
  function safeNum(x, fallback=0){
    const n = Number(x);
    return Number.isFinite(n) ? n : fallback;
  }
  function quantile(sortedAsc, q){
    if (!sortedAsc || !sortedAsc.length) return null;
    const n = sortedAsc.length;
    const pos = (n - 1) * q;
    const base = Math.floor(pos);
    const rest = pos - base;
    if (sortedAsc[base+1] === undefined) return sortedAsc[base];
    return sortedAsc[base] + rest * (sortedAsc[base+1] - sortedAsc[base]);
  }
  function computeScoreStats(records){
    const vals = records.map(r => safeNum(r.finalScore, 0)).sort((a,b)=>a-b);
    if (!vals.length) return { min: 0, max: 0, p50: 0, p90: 0, p99: 0, dispersionHint: null };
    const min = vals[0];
    const max = vals[vals.length-1];
    const p50 = quantile(vals, 0.50);
    const p90 = quantile(vals, 0.90);
    const p99 = quantile(vals, 0.99);
    let hint = null;
    // Tight dispersion hint allowed (non-probabilistic).
    if ((max - min) <= 0.02 || (p90 - p50) <= 0.01){
      hint = "Scores are tightly clustered; differences are marginal.";
    }
    return { min, max, p50, p90, p99, dispersionHint: hint };
  }
  function tierForRank(rank, universeSize){
    if (universeSize <= 0) return "D";
    // Percentile based on rank position (1-based). Rank 1 is best (0th percentile).
    const pct = (rank - 1) / universeSize;
    for (const t of E9_CONF_BANDS_V1){
      if (pct >= t.pctFrom && pct < t.pctTo) return t.tier;
    }
    return "D";
  }
  function normalizeCandidateId(cid){
    return String(cid || "").trim();
  }
  function extractOrasPenaltyAbs(rec){
    // Deterministic tie-breaker expects "lower absolute ORAS penalty".
    // We use the module score magnitude (mi) as the penalty proxy, as it is the bounded ORAS signal.
    const mi = safeNum(rec?.moduleScores?.ORAS?.mi, 0);
    return Math.abs(mi);
  }
  function deterministicSortRecords(records){
    const EPS = 1e-9;
    return [...records].sort((a,b)=>{
      const fa = safeNum(a.finalScore, 0);
      const fb = safeNum(b.finalScore, 0);
      if (Math.abs(fb - fa) > EPS) return fb - fa;
      const ca = safeNum(a?.coreScore?.crs, 0);
      const cb = safeNum(b?.coreScore?.crs, 0);
      if (Math.abs(cb - ca) > EPS) return cb - ca;
      const pa = extractOrasPenaltyAbs(a);
      const pb = extractOrasPenaltyAbs(b);
      if (Math.abs(pa - pb) > EPS) return pa - pb;
      const ida = normalizeCandidateId(a.candidateId);
      const idb = normalizeCandidateId(b.candidateId);
      return ida.localeCompare(idb);
    });
  }
  function buildExplainabilityRefsV1(rec, enabledModules){
    // Pass-through unchanged when provided; otherwise deterministic, fixed EXREF set.
    const existing = Array.isArray(rec?.explainabilityRefs) ? rec.explainabilityRefs.slice() : null;
    if (existing && existing.length) return existing;
    const refs = [];
    // Bindings per Deliverable #5 (fixed EXREF pointers).
    if (enabledModules.includes("PAS")) refs.push("EXREF::CLUSTER::DOMINANT_MONTHS::SUMMARY");
    if (enabledModules.includes("ORAS")) {
      const orasMi = safeNum(rec?.moduleScores?.ORAS?.mi, 0);
      if (orasMi < 0) refs.push("EXREF::OUTLIER::RARE_CONDITIONS::DETAILS");
      else refs.push("EXREF::OUTLIER::NO_RARE_FLAGS::SUMMARY");
    }
    if (enabledModules.includes("ODAS")) refs.push("EXREF::OVERLAY::MACRO_POLICY::NARRATIVE");
    if (enabledModules.includes("SRES")) refs.push("EXREF::STATE::REPRESENTATION::OVER_UNDER_SUMMARY");
    return refs;
  }
  function computeDriversV1(rec, enabledModules){
    // Drivers selected by absolute module contribution.
    const entries = [];
    for (const m of ["PAS","ORAS","ODAS","SRES"]){
      if (!enabledModules.includes(m)) continue;
      const c = safeNum(rec?.moduleContributions?.[m]?.contribution, 0);
      const abs = Math.abs(c);
      entries.push({ module: m, contribution: c, abs });
    }
    entries.sort((a,b)=>b.abs - a.abs);
    const pos = [];
    const neg = [];
    const pushPhrase = (bucket, phrase) => {
      if (!phrase) return;
      if (!bucket.includes(phrase)) bucket.push(phrase);
    };
    for (const e of entries){
      if (e.contribution >= 0){
        if (e.module === "PAS") pushPhrase(pos, E9_DRIVER_PHRASES_V1.PAS_POS);
        if (e.module === "ORAS") pushPhrase(pos, E9_DRIVER_PHRASES_V1.ORAS_POS);
        if (e.module === "ODAS") pushPhrase(pos, E9_DRIVER_PHRASES_V1.ODAS_POS);
        if (e.module === "SRES") pushPhrase(pos, E9_DRIVER_PHRASES_V1.SRES_POS);
      } else {
        if (e.module === "PAS") pushPhrase(neg, E9_DRIVER_PHRASES_V1.PAS_NEG);
        if (e.module === "ORAS") pushPhrase(neg, E9_DRIVER_PHRASES_V1.ORAS_NEG);
        if (e.module === "ODAS") pushPhrase(neg, E9_DRIVER_PHRASES_V1.ODAS_NEG);
        if (e.module === "SRES") pushPhrase(neg, E9_DRIVER_PHRASES_V1.SRES_NEG);
      }
      if (pos.length >= 3 && neg.length >= 2) break;
    }
    // CXT disclosure is isolated and non-causal.
    const cxtApplied = !!rec?.context?.applied;
    const cxtLine = cxtApplied ? E9_DRIVER_PHRASES_V1.CXT_APPLIED : E9_DRIVER_PHRASES_V1.CXT_NONE;
    return { positive: pos.slice(0,3), negative: neg.slice(0,2), cxtLine, cxtApplied };
  }
  function buildPlainEnglishRationaleV1(drivers){
    // Fixed phrase mapping only; 1–2 sentences max.
    const p = drivers.positive.slice(0,2);
    const n = drivers.negative.slice(0,1);
    let s1 = "";
    if (p.length === 0 && n.length === 0){
      s1 = "This combination is ranked based on the current scoring contract and available modules.";
    } else if (p.length && !n.length){
      s1 = `This combination is ranked highly due to ${p.join(" and ").toLowerCase()}.`;
    } else if (!p.length && n.length){
      s1 = `This combination is ranked lower due to ${n[0].toLowerCase()}.`;
    } else {
      s1 = `This combination balances ${p.join(" and ").toLowerCase()} with ${n[0].toLowerCase()}.`;
    }
    const s2 = drivers.cxtApplied
      ? "Contextual factors were applied as a bounded ranking emphasis only; this does not imply causation or altered odds."
      : "No contextual emphasis was applied.";
    // Ensure max 2 sentences.
    return `${s1} ${s2}`.trim();
  }
  function requirePath(obj, path){
    // path: /a/b/0/c
    const parts = String(path || "").split("/").filter(Boolean);
    let cur = obj;
    for (const p of parts){
      if (cur == null) return false;
      if (Array.isArray(cur)){
        const idx = Number(p);
        if (!Number.isInteger(idx) || idx < 0 || idx >= cur.length) return false;
        cur = cur[idx];
      } else {
        if (!(p in cur)) return false;
        cur = cur[p];
      }
    }
    return true;
  }
  function derivePredictionOutputV1(ledger, manifest, scoring, opts){
    // Fail-closed if required inputs are missing.
    if (!ledger || ledger.schemaVersion !== SCHEMA_AUDIT_LEDGER) throw new Error("Missing or invalid audit ledger.");
    if (!manifest || manifest.schemaVersion !== SCHEMA_RUN_MANIFEST) throw new Error("Missing or invalid run manifest.");
    if (!scoring || !Array.isArray(scoring.records)) throw new Error("Missing scoring records.");
    const topN = Math.max(1, Math.min(safeNum(opts?.topN, 25), scoring.records.length));
    const riskMode = manifest.riskMode || "CONSERVATIVE";
    // Enabled modules in manifest are authoritative.
    const enabledModules = Object.entries(manifest.enabledModules || {}).filter(([,v])=>!!v).map(([k])=>k);
    const scoreStats = computeScoreStats(scoring.records);
    // Build candidateAudit inside ledger (derived, additive)
    if (!Array.isArray(ledger.candidateAudit)){
      ledger.candidateAudit = scoring.records.map((rec, i)=>{
        const drivers = computeDriversV1(rec, enabledModules);
        const exrefs = buildExplainabilityRefsV1(rec, enabledModules);
        return {
          candidateId: rec.candidateId,
          numbers: rec.numbers,
          finalScore: rec.finalScore,
          coreScore: safeNum(rec?.coreScore?.crs, 0),
          moduleScores: rec.moduleScores,
          moduleContributions: rec.moduleContributions,
          explainabilityRefs: exrefs,
          cxt: {
            applied: !!rec?.context?.applied,
            cef: safeNum(rec?.context?.cef, 1.0),
            note: (!!rec?.context?.applied)
              ? "Contextual emphasis applied within ±3% cap; informational only."
              : "No contextual emphasis applied."
          },
          drivers,
          provenance: {
            historicalVersion: LOCKED_HIST_VERSION,
            analyticsVersionTag: LOCKED_ANALYTICS_TAG
          },
          path: `/candidateAudit/${i}`
        };
      });
    }
    // Validate ledger paths exist (required by output contract).
    for (const entry of ledger.candidateAudit){
      if (!entry.path || !requirePath(ledger, entry.path)){
        const err = new Error("Missing ledger paths invalidate output (fail-closed).");
        err.code = "E9_MISSING_LEDGER_PATH";
        throw err;
      }
    }
    // Ranked selection (deterministic).
    const ranked = deterministicSortRecords(scoring.records);
    const selected = ranked.slice(0, topN).map((rec, idx)=>{
      // Find ledger path for this candidateId (deterministic: first match).
      const ledgerIndex = ledger.candidateAudit.findIndex(x => x.candidateId === rec.candidateId);
      const path = ledgerIndex >= 0 ? `/candidateAudit/${ledgerIndex}` : null;
      if (!path || !requirePath(ledger, path)){
        const err = new Error("Missing ledger path for ranked candidate (fail-closed).");
        err.code = "E9_RANKED_CANDIDATE_NO_LEDGER_PATH";
        throw err;
      }
      const drivers = computeDriversV1(rec, enabledModules);
      const exrefs = buildExplainabilityRefsV1(rec, enabledModules);
      const tier = tierForRank(idx+1, scoring.records.length);
      return {
        rank: idx + 1,
        tier,
        numbers: rec.numbers,
        scores: {
          finalScore: safeNum(rec.finalScore, 0),
          coreScore: safeNum(rec?.coreScore?.crs, 0),
          cxtFactor: safeNum(rec?.context?.cef, 1.0)
        },
        drivers: {
          positive: drivers.positive,
          negative: drivers.negative
        },
        rationale: {
          plainEnglish: buildPlainEnglishRationaleV1(drivers),
          explainabilityRefs: exrefs
        },
        auditRef: {
          ledgerRunId: manifest.runId,
          candidateId: rec.candidateId,
          path
        }
      };
    });
    const out = {
      schemaVersion: SCHEMA_PREDICTION_OUTPUT,
      generatedAt: nowIso(),
      runId: manifest.runId,
      project: "Powerball vNext",
      lockedBaselines: {
        historicalData: LOCKED_HIST_VERSION,
        analyticsTag: LOCKED_ANALYTICS_TAG
      },
      riskMode,
      topN,
      confidenceModel: {
        method: "PERCENTILE_BANDING",
        tiers: [
          { tier:"A", range:"Top 1%" },
          { tier:"B", range:"Next 4%" },
          { tier:"C", range:"Next 15%" },
          { tier:"D", range:"Remainder" }
        ],
        disclaimer: "Relative confidence only; not a probability of winning."
      },
      summary: {
        candidateUniverseSize: scoring.records.length,
        scoreStats: {
          min: scoreStats.min,
          max: scoreStats.max,
          p50: scoreStats.p50,
          p90: scoreStats.p90,
          p99: scoreStats.p99
        },
        enabledModules
      },
      predictions: selected
    };
    // Add dispersion hint (UI-only) if applicable.
    out.summary.scoreStats.dispersionHint = scoreStats.dispersionHint;
    return out;
  }
  function renderPredictionOutputV1(output, ledger, opts){
    const container = $("e9PredictionsContainer");
    const meta = $("e9PredictionsMeta");
    const hintEl = $("e9DispersionHint");
    if (!container || !meta) return;
    container.innerHTML = "";
    meta.innerHTML = "";
    if (!output){
      meta.textContent = "No output available. Run vE9 and build output.";
      return;
    }
    const showFinal = !!opts?.showFinalScore;
    const riskHint = E9_RISK_HINTS_V1[output.riskMode] || "";
    meta.innerHTML = `
      <div><span style="font-weight:900; color:#0f172a;">RunId:</span> <span style="font-family:monospace;">${escapeHtml(output.runId)}</span></div>
      <div style="margin-top:4px;"><span style="font-weight:900; color:#0f172a;">Risk Mode:</span> ${escapeHtml(output.riskMode)} <span style="color:#64748b;">— ${escapeHtml(riskHint)}</span></div>
      <div style="margin-top:4px;"><span style="font-weight:900; color:#0f172a;">Enabled Modules:</span> ${escapeHtml((output.summary.enabledModules||[]).join(", ") || "—")}</div>
      <div style="margin-top:4px;"><span style="font-weight:900; color:#0f172a;">Universe:</span> ${escapeHtml(String(output.summary.candidateUniverseSize))} candidates; <span style="font-weight:900; color:#0f172a;">TopN:</span> ${escapeHtml(String(output.topN))}</div>
    `;
    hintEl.textContent = output?.summary?.scoreStats?.dispersionHint ? output.summary.scoreStats.dispersionHint : "";
    const table = document.createElement("div");
    table.style.display = "grid";
    table.style.gap = "10px";
    for (const p of output.predictions){
      const card = document.createElement("div");
      card.style.border = "1px solid #cbd5e1";
      card.style.borderRadius = "14px";
      card.style.padding = "10px";
      card.style.background = "white";
      const nums = p.numbers?.main ? p.numbers.main.map(x=>String(x).padStart(2,"0")).join("-") : "—";
      const pb = p.numbers?.special != null ? String(p.numbers.special).padStart(2,"0") : "—";
      const driverPos = (p.drivers?.positive || []).map(x=>`<li>${escapeHtml(x)}</li>`).join("");
      const driverNeg = (p.drivers?.negative || []).map(x=>`<li>${escapeHtml(x)}</li>`).join("");
      const scoreLine = showFinal ? `<span style="font-weight:900; color:#0f172a;">finalScore:</span> <span style="font-family:monospace;">${safeNum(p?.scores?.finalScore,0).toFixed(6)}</span>` : "";
      card.innerHTML = `
        <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:flex-start;">
          <div>
            <div style="font-weight:900; color:#0f172a; font-size:14px;">#${p.rank} <span style="margin-left:8px; padding:2px 8px; border-radius:999px; border:1px solid #cbd5e1; font-size:12px; font-weight:900;">Tier ${escapeHtml(p.tier)}</span></div>
            <div style="margin-top:4px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:13px;">
              ${escapeHtml(nums)} <span style="font-weight:900; color:#dc2626;">| PB-${escapeHtml(pb)}</span>
            </div>
          </div>
          <div style="text-align:right; font-size:12px; color:#334155;">
            ${scoreLine}
          </div>
        </div>
        <div style="margin-top:8px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
          <div>
            <div style="font-weight:900; color:#0f172a; font-size:12px;">Drivers (Positive)</div>
            <ul style="margin:6px 0 0 16px; padding:0; font-size:12px; color:#334155; line-height:1.35;">
              ${driverPos || "<li>—</li>"}
            </ul>
          </div>
          <div>
            <div style="font-weight:900; color:#0f172a; font-size:12px;">Drivers (Negative)</div>
            <ul style="margin:6px 0 0 16px; padding:0; font-size:12px; color:#334155; line-height:1.35;">
              ${driverNeg || "<li>—</li>"}
            </ul>
          </div>
        </div>
        <div style="margin-top:8px; font-size:12px; color:#0f172a; line-height:1.35;">
          <div style="font-weight:900;">Rationale</div>
          <div style="color:#334155; margin-top:3px;">${escapeHtml(p?.rationale?.plainEnglish || "—")}</div>
        </div>
        <div style="margin-top:8px; font-size:12px; color:#334155; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
          <div><span style="font-weight:900; color:#0f172a;">auditRef:</span> <span style="font-family:monospace;">${escapeHtml(p?.auditRef?.path || "—")}</span></div>
          <button data-e9why="1" data-cid="${escapeHtml(p?.auditRef?.candidateId || "")}" style="padding:6px 10px; border-radius:10px; border:1px solid #cbd5e1; background:#f8fafc; font-weight:900; cursor:pointer;" type="button">Why?</button>
        </div>
        <div data-e9why-panel="1" data-cid="${escapeHtml(p?.auditRef?.candidateId || "")}" style="display:none; margin-top:8px; border-top:1px dashed #cbd5e1; padding-top:8px;">
        </div>
      `;
      table.appendChild(card);
    }
    container.appendChild(table);
    // Wire Why? drill-down strictly via audit ledger.
    container.querySelectorAll("button[data-e9why='1']").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const cid = btn.getAttribute("data-cid") || "";
        const panel = container.querySelector(`div[data-e9why-panel='1'][data-cid='${CSS.escape(cid)}']`);
        if (!panel) return;
        const isOpen = panel.style.display !== "none";
        if (isOpen){
          panel.style.display = "none";
          panel.innerHTML = "";
          return;
        }
        // Resolve via ledger path (strict).
        const entry = (ledger?.candidateAudit || []).find(x => x.candidateId === cid);
        if (!entry || !entry.path || !requirePath(ledger, entry.path)){
          panel.style.display = "block";
          panel.innerHTML = `<div style="color:#b91c1c; font-weight:900;">Fail-closed: audit ledger path missing for this candidate.</div>`;
          return;
        }
        const enabled = output?.summary?.enabledModules || [];
        const mods = [];
        for (const m of ["PAS","ORAS","ODAS","SRES"]){
          if (!enabled.includes(m)) continue;
          const mi = safeNum(entry?.moduleScores?.[m]?.mi, 0);
          const damp = safeNum(entry?.moduleContributions?.[m]?.dampened, 0);
          const w = safeNum(entry?.moduleContributions?.[m]?.weight, 0);
          const contrib = safeNum(entry?.moduleContributions?.[m]?.contribution, 0);
          mods.push({ m, mi, damp, w, contrib });
        }
        const exrefs = Array.isArray(entry.explainabilityRefs) ? entry.explainabilityRefs : [];
        const cxtBlock = `
          <div style="margin-top:8px; padding-top:8px; border-top:1px dashed #cbd5e1;">
            <div style="font-weight:900; color:#0f172a;">Contextual (Non-Causal)</div>
            <div style="font-size:12px; color:#334155; margin-top:3px;">${escapeHtml(entry?.cxt?.note || "—")}</div>
            <div style="font-size:12px; color:#334155; margin-top:3px;"><span style="font-weight:900; color:#0f172a;">CEF:</span> <span style="font-family:monospace;">${safeNum(entry?.cxt?.cef,1).toFixed(3)}</span></div>
          </div>
        `;
        const rows = mods.map(x=>`
          <tr>
            <td style="padding:6px 8px; border-top:1px solid #e2e8f0; font-weight:900; color:#0f172a;">${escapeHtml(x.m)}</td>
            <td style="padding:6px 8px; border-top:1px solid #e2e8f0; font-family:monospace;">${x.mi.toFixed(6)}</td>
            <td style="padding:6px 8px; border-top:1px solid #e2e8f0; font-family:monospace;">${x.damp.toFixed(6)}</td>
            <td style="padding:6px 8px; border-top:1px solid #e2e8f0; font-family:monospace;">${x.w.toFixed(6)}</td>
            <td style="padding:6px 8px; border-top:1px solid #e2e8f0; font-family:monospace;">${x.contrib.toFixed(6)}</td>
          </tr>
        `).join("");
        const exrefList = exrefs.length ? exrefs.map(r=>`<li style="font-family:monospace;">${escapeHtml(r)}</li>`).join("") : "<li>—</li>";
        panel.style.display = "block";
        panel.innerHTML = `
          <div style="font-weight:900; color:#0f172a;">Module Contributions</div>
          <div style="font-size:12px; color:#334155; margin-top:3px;">(mi → dampened → weight → contribution)</div>
          <table style="width:100%; border-collapse:collapse; margin-top:6px; font-size:12px;">
            <thead>
              <tr>
                <th style="text-align:left; padding:6px 8px; border-bottom:1px solid #e2e8f0;">Module</th>
                <th style="text-align:left; padding:6px 8px; border-bottom:1px solid #e2e8f0;">mi</th>
                <th style="text-align:left; padding:6px 8px; border-bottom:1px solid #e2e8f0;">damp</th>
                <th style="text-align:left; padding:6px 8px; border-bottom:1px solid #e2e8f0;">w</th>
                <th style="text-align:left; padding:6px 8px; border-bottom:1px solid #e2e8f0;">contrib</th>
              </tr>
            </thead>
            <tbody>${rows || ""}</tbody>
          </table>
          <div style="margin-top:10px;">
            <div style="font-weight:900; color:#0f172a;">Explainability Refs (pass-through)</div>
            <ul style="margin:6px 0 0 16px; padding:0; font-size:12px; color:#334155; line-height:1.35;">
              ${exrefList}
            </ul>
          </div>
          ${cxtBlock}
        `;
      });
    });
  }
function scoreCandidateModulesV1(featureVector, ctx){
    const out = {
      PAS: { mi: 0, missingReason: "NO_ADMISSIBLE_LINKAGE_YET" },
      ORAS:{ mi: 0, missingReason: "NO_ADMISSIBLE_LINKAGE_YET" },
      ODAS:{ mi: 0, missingReason: "NO_NUMERIC_OVERLAY" },
      SRES:{ mi: 0, missingReason: "NO_STATE_REGIME_LINKAGE" }
    };
    return out;
  }
  function applyScoringContractV1(featureVectors, manifest, pre){
    const riskMode = (manifest && manifest.riskMode) ? manifest.riskMode : "CONSERVATIVE";
    const gamma = E9_GAMMA_BY_MODE_V1[riskMode] ?? 1.25;
    const availability = determineModuleAvailability(pre);
    const baseWeights = E9_WEIGHTS_BY_MODE_V1[riskMode] ?? E9_WEIGHTS_BY_MODE_V1.CONSERVATIVE;
    const { weights, disabled, redistribution } = normalizeWeights(baseWeights, availability);
    const records = [];
    let violated = false;
    const violations = [];
    for (const fv of featureVectors){
      const moduleScores = scoreCandidateModulesV1(fv, { pre, manifest });
      // Dampening
      const damp = {};
      for (const k of ["PAS","ORAS","ODAS","SRES"]){
        const mi = clamp(Number(moduleScores[k]?.mi ?? 0), -1, 1);
        damp[k] = compressScore(mi, gamma);
      }
      // Contributions with caps
      const contrib = {};
      let crsRaw = 0;
      for (const k of ["PAS","ORAS","ODAS","SRES"]){
        const wi = weights[k] ?? 0;
        const cap = E9_MODULE_CAPS_V1[k] ?? 0;
        const raw = wi * (damp[k] ?? 0);
        const capped = clamp(raw, -cap, +cap);
        contrib[k] = { wi, mi: moduleScores[k]?.mi ?? 0, miDamp: damp[k], raw, capped, capApplied: Math.abs(raw - capped) > 1e-12, cap };
        crsRaw += capped;
        if (Math.abs(capped) - cap > 1e-9){
          violated = true;
          violations.push({ type:"CAP_INVARIANT", candidateId: fv.candidateId, module:k, capped, cap });
        }
      }
      // Global CRS cap
      let crs = clamp(crsRaw, CRS_CAP_MIN, CRS_CAP_MAX);
      const crsCapped = Math.abs(crs - crsRaw) > 1e-12;
      // ORAS veto rule
      const orasMi = Number(moduleScores.ORAS?.mi ?? 0);
      let vetoApplied = false;
      if (orasMi <= -0.75){
        const prior = crs;
        crs = Math.min(crs, +0.15);
        vetoApplied = (crs !== prior);
      }
      // CXT placeholder (disabled until Deliverable #5 adds CXT sources)
      const cxt = { applied:false, cef: 1.0, reason: "CXT_NOT_IMPLEMENTED_YET" };
      if (cxt.cef < CEF_MIN - 1e-9 || cxt.cef > CEF_MAX + 1e-9){
        violated = true;
        violations.push({ type:"CEF_INVARIANT", candidateId: fv.candidateId, cef: cxt.cef });
      }
      const finalScore = crs * cxt.cef;
      if (crs < CRS_CAP_MIN - 1e-9 || crs > CRS_CAP_MAX + 1e-9){
        violated = true;
        violations.push({ type:"CRS_INVARIANT", candidateId: fv.candidateId, crs });
      }
      records.push({
        candidateId: fv.candidateId,
        numbers: fv.numbers,
        riskMode,
        gamma,
        moduleAvailability: availability,
        disabledModules: disabled,
        weights,
        moduleScores,
        moduleContributions: contrib,
        coreScore: { crsRaw, crs, crsCapped, vetoApplied, vetoRule: "ORAS<=-0.75 => CRS<=+0.15" },
        context: cxt,
        finalScore
      });
    }
    if (violated){
      const err = new Error("E9_RUNTIME_INVARIANT_VIOLATION");
      err.violations = violations;
      throw err;
    }
    return { records, config: { riskMode, gamma, weights, disabledModules: disabled, redistribution, availability, caps: E9_MODULE_CAPS_V1, crsCap: [CRS_CAP_MIN, CRS_CAP_MAX], cefCap: [CEF_MIN, CEF_MAX], purplePolicy: PURPLE_POLICY } };
  }
  function getSignalRegistryIndex(){
    const idx = {};
    for (const s of PB_E9_SIGNAL_REGISTRY_V1.signals) idx[s.id] = s;
    return idx;
  }
  const REQUIRED_DOM_IDS = [
    { id: "enh3ClustersTbody", label: "Clusters table" },
    { id: "enh3OutliersTbody", label: "Outliers table" },
    { id: "enh3StateShareTbody", label: "State representation table" }
  ];
  // ---- Utilities ----
  const $ = (id) => document.getElementById(id);
  // UI placement: ensure Enhancement #9 panel sits between Explainability and Exports for visual organization.
  function relocateEnh9Panel(){
    try{
      const panel = $("enh9Panel");
      if (!panel) return;
      const exportCard = document.querySelector(".export-card");
      if (!exportCard) return;
      // If already before export card, do nothing.
      const parent = exportCard.parentElement;
      if (!parent) return;
      if (panel.nextSibling === exportCard) return;
      parent.insertBefore(panel, exportCard);
    }catch(e){ /* no-op */ }
  }
  function nowIso(){
    return new Date().toISOString();
  }
  function clamp(x, lo, hi){
    return Math.max(lo, Math.min(hi, x));
  }
  function pad2(n){
    const s = String(n);
    return s.length === 1 ? ("0" + s) : s;
  }
  // Deterministic stringify (stable key ordering)
  function stableStringify(obj){
    const seen = new WeakSet();
    const _stringify = (v) => {
      if (v === null || v === undefined) return JSON.stringify(v);
      if (typeof v !== "object") return JSON.stringify(v);
      if (seen.has(v)) return JSON.stringify("[Circular]");
      seen.add(v);
      if (Array.isArray(v)){
        return "[" + v.map(_stringify).join(",") + "]";
      }
      const keys = Object.keys(v).sort();
      return "{" + keys.map(k => JSON.stringify(k) + ":" + _stringify(v[k])).join(",") + "}";
    };
    return _stringify(obj);
  }
  async function sha256Hex(inputStr){
    if (!window.crypto || !crypto.subtle){
      // Fallback: non-cryptographic deterministic hash (still stable for fingerprinting)
      let h = 2166136261;
      for (let i=0;i<inputStr.length;i++){
        h ^= inputStr.charCodeAt(i);
        h = (h * 16777619) >>> 0;
      }
      return "fnv1a32:" + ("00000000" + h.toString(16)).slice(-8);
    }
    const enc = new TextEncoder().encode(inputStr);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    const arr = Array.from(new Uint8Array(buf));
    return arr.map(b => b.toString(16).padStart(2,"0")).join("");
  }
  function setStatusPill(text, kind){
    const el = $("e9StatusPill");
    if (!el) return;
    el.textContent = text;
    const styles = {
      neutral: { bg:"#e2e8f0", bd:"#cbd5e1", fg:"#0f172a" },
      ok:      { bg:"#dcfce7", bd:"#86efac", fg:"#14532d" },
      warn:    { bg:"#ffedd5", bd:"#fdba74", fg:"#7c2d12" },
      fail:    { bg:"#fee2e2", bd:"#fca5a5", fg:"#7f1d1d" }
    };
    const s = styles[kind] || styles.neutral;
    el.style.background = s.bg;
    el.style.borderColor = s.bd;
    el.style.color = s.fg;
  }
  function logPrecheck(lines){
    const el = $("e9PrecheckLog");
    if (!el) return;
    el.textContent = (lines && lines.length) ? lines.join("\n") : "(precheck log)";
  }
  function getRiskMode(){
    const sel = $("e9RiskMode");
    return (sel && sel.value) ? sel.value : "CONSERVATIVE";
  }
  // ---- Stage 0: Precheck + Run Manifest ----
  async function precheckLockedArtifacts(){
    const log = [];
    const missing = [];
    // Derived capability flags used by module availability
    let overlayNumericPresent = false;
    let stateShareRows = 0;
    // Historical dataset (v126 JSON lifecycle) must be present
    const hd = window.historicalData;
    if (!Array.isArray(hd) || hd.length === 0){
      missing.push("historicalData");
      log.push("FAIL: historicalData missing or empty (v126 required).");
    } else {
      log.push(`OK: historicalData present (records=${hd.length}).`);
    }
    // Analytics tables must be present & populated (computed by vE3.5.x)
    for (const req of REQUIRED_DOM_IDS){
      const tbody = $(req.id);
      if (!tbody){
        missing.push(req.id);
        log.push(`FAIL: ${req.label} missing (DOM id=${req.id}).`);
        continue;
      }
      const rows = tbody.querySelectorAll("tr");
      if (req.id === "enh3StateShareTbody") stateShareRows = (rows && rows.length) ? rows.length : 0;
      if (!rows || rows.length === 0){
        missing.push(req.id + " (empty)");
        log.push(`FAIL: ${req.label} present but empty (run analytics first).`);
      } else {
        log.push(`OK: ${req.label} rows=${rows.length}.`);
      }
    }
    return { ok: missing.length === 0, missing, log, overlayNumericPresent, stateRegimeLinkagePresent: stateShareRows > 0, stateShareRows };
  }
  async function buildRunManifest(precheck){
    const riskMode = getRiskMode();
    const ts = nowIso();
    // Fingerprints (deterministic inputs)
    const hd = Array.isArray(window.historicalData) ? window.historicalData : [];
    const hdStr = stableStringify(hd);
    const hdHash = await sha256Hex(hdStr);
    // Analytics fingerprints: use row counts + visible text to keep deterministic and light
    const analyticsRef = {};
    for (const req of REQUIRED_DOM_IDS){
      const tbody = $(req.id);
      const rows = tbody ? Array.from(tbody.querySelectorAll("tr")) : [];
      const sample = rows.slice(0, 25).map(tr => tr.innerText.trim()).join("||");
      analyticsRef[req.id] = {
        label: req.label,
        rows: rows.length,
        sampleHash: await sha256Hex(sample)
      };
    }
    // Signal registry fingerprint (Deliverable #2)
    const reg = JSON.parse(JSON.stringify(PB_E9_SIGNAL_REGISTRY_V1));
    reg.generatedAt = ts;
    const regHash = await sha256Hex(stableStringify(reg));
    // Module enablement is governed by active config and derived solely from risk mode (Deliverable #12).
    const cfg = getE9ActiveConfig();
    const rm = (riskMode && String(riskMode).toUpperCase()) || "CONSERVATIVE";
    const modMap = (cfg.modulesByRiskMode && cfg.modulesByRiskMode[rm]) ? cfg.modulesByRiskMode[rm] : cfg.modulesByRiskMode.CONSERVATIVE;
    const enabledModules = {
      PAS: !!modMap.PAS,
      ORAS: !!modMap.ORAS,
      ODAS: !!modMap.ODAS,
      SRES: !!modMap.SRES,
      CXT: !!modMap.CXT
    };
    // Signal enablement (per-module) — note: signals may be present but unused until scoring is implemented.
    const enabledSignals = {
      PAS: ["PA-01"],             // PA-02/03/04 are optional and enabled later if artifacts exist
      ORAS: ["OR-01","OR-02","OR-03"],
      ODAS: ["OV-01","OV-02"],
      SRES: ["SR-01","SR-02","SR-03","SR-04","SR-05"],
      CXT: ["CXT-01","CXT-02","CXT-03"],
      INTRINSIC: ["CI-01","CI-02","CI-03","CI-04","CI-05","CI-06","CI-07","CI-08"],
      EXPLAIN: ["EX-01","EX-02"]
    };
    const runIdBase = `${LOCKED_HIST_VERSION}|${LOCKED_ANALYTICS_TAG}|${riskMode}|${hdHash.slice(0,12)}`;
    const runId = "E9-" + (await sha256Hex(runIdBase)).slice(0, 16);
    const manifest = {
      schemaVersion: SCHEMA_RUN_MANIFEST,
      project: "Powerball vNext",
      runId,
      generatedAt: ts,
      lockedBaselines: {
        historicalData: LOCKED_HIST_VERSION,
        analyticsTag: LOCKED_ANALYTICS_TAG
      },
      riskMode,
      enabledModules,
      enabledSignals,
      inputs: {
        historicalData: { present: Array.isArray(window.historicalData), records: hd.length, sha256: hdHash },
        analytics: analyticsRef,
        overlays: { present: true, note: "Overlay scoring is not enabled in Deliverable #1 scaffold." },
        signalRegistry: { schemaVersion: reg.schemaVersion, version: reg.version, sha256: regHash, signalsCount: reg.signals.length }
      },
      precheck: {
        ok: !!precheck?.ok,
        missing: precheck?.missing || []
      }
    };
    // Run fingerprint (single pointer used in UI)
    const fingerprint = await sha256Hex(stableStringify({
      runId: manifest.runId,
      baselines: manifest.lockedBaselines,
      riskMode: manifest.riskMode,
      enabledModules: manifest.enabledModules,
      hdHash: manifest.inputs.historicalData.sha256,
      analytics: Object.fromEntries(Object.entries(manifest.inputs.analytics).map(([k,v]) => [k, {rows:v.rows, sampleHash:v.sampleHash}]))
    }));
    return { manifest, fingerprint };
  }
  // ---- Stage 1: Candidate canonicalization (delegated generation) ----
  function parseCandidateLine(line){
    const s = (line || "").trim();
    if (!s) return null;
    // Accept: "01-12-27-41-63|PB-19" (canonical) or "1,12,27,41,63|19"
    const parts = s.split("|").map(x => x.trim());
    if (parts.length < 2) return null;
    const mainPart = parts[0].replace(/\s+/g, "");
    const pbPart = parts[1].toUpperCase().replace(/\s+/g, "");
    const mainNums = mainPart.includes(",")
      ? mainPart.split(",").map(x => parseInt(x, 10)).filter(n => Number.isFinite(n))
      : mainPart.split("-").map(x => parseInt(x, 10)).filter(n => Number.isFinite(n));
    let pbNum = null;
    const pbMatch = pbPart.match(/PB-?(\d{1,2})/);
    if (pbMatch) pbNum = parseInt(pbMatch[1], 10);
    if (pbNum === null){
      const pbBare = parseInt(pbPart, 10);
      if (Number.isFinite(pbBare)) pbNum = pbBare;
    }
    if (!Array.isArray(mainNums) || mainNums.length !== 5) return null;
    if (!Number.isFinite(pbNum)) return null;
    // Validate ranges (Powerball rules)
    if (mainNums.some(n => n < 1 || n > 69)) return null;
    if (pbNum < 1 || pbNum > 26) return null;
    return { main: mainNums, special: pbNum };
  }
  function canonicalizeCandidate(candidate){
    const mains = Array.from(candidate.main).sort((a,b) => a-b);
    const special = candidate.special;
    const mainStr = mains.map(pad2).join("-");
    const pbStr = pad2(special);
    const candidateId = `${mainStr}|PB-${pbStr}`;
    return { candidateId, mainNumbersSorted: mains, specialNumber: special };
  }
  function readCandidatesFromTextarea(){
    const ta = $("e9CandidatesText");
    const lines = (ta && ta.value) ? ta.value.split(/\r?\n/) : [];
    const parsed = [];
    const rejected = [];
    for (const line of lines){
      const p = parseCandidateLine(line);
      if (p) parsed.push(p);
      else if (line.trim()) rejected.push(line.trim());
    }
    return { parsed, rejected };
  }
  function tryReadCandidatesFromPreviousPredictions(){
    // Best-effort: parse visible rows of ppHistoryTbody if present and non-empty.
    const tbody = $("ppHistoryTbody");
    if (!tbody) return { parsed: [], rejected: ["ppHistoryTbody missing"] };
    const rows = Array.from(tbody.querySelectorAll("tr"));
    if (!rows.length) return { parsed: [], rejected: ["ppHistoryTbody empty (no previous predictions loaded)"] };
    const parsed = [];
    const rejected = [];
    for (const tr of rows){
      const tds = tr.querySelectorAll("td");
      if (!tds || tds.length < 6) continue;
      // Columns: [select], Draw Date, Method, Rank, Numbers, Powerball, ...
      const numsText = (tds[4]?.innerText || "").trim();
      const pbText = (tds[5]?.innerText || "").trim();
      const mains = numsText.split(/[,\s]+/).map(x => parseInt(x, 10)).filter(n => Number.isFinite(n));
      const pb = parseInt(pbText, 10);
      if (mains.length === 5 && Number.isFinite(pb)){
        parsed.push({ main: mains, special: pb });
      } else {
        rejected.push(`${numsText}|${pbText}`);
      }
    }
    return { parsed, rejected };
  }
  // ---- Stage 2: Intrinsic feature extraction (safe transforms) ----
  function extractIntrinsicFeatures(canon){
    const mains = canon.mainNumbersSorted;
    const special = canon.specialNumber;
    // CI-01 (Main Sum) — mains only
    const mainSum = mains.reduce((a,b)=>a+b,0);
    // Retain existing "sum" field for backward compatibility (total including special)
    const sum = mainSum + special;
    const odd = mains.filter(n => n % 2 === 1).length;
    const even = 5 - odd;
    // Low/High split (Powerball common cut at 34/35)
    const low = mains.filter(n => n <= 34).length;
    const high = 5 - low;
    // Gaps between consecutive sorted mains
    const gaps = [];
    for (let i=1;i<mains.length;i++){
      gaps.push(mains[i] - mains[i-1]);
    }
    // Decade histogram for mains: 0-9,10-19,...,60-69
    const bins = Array(7).fill(0);
    mains.forEach(n => {
      const idx = clamp(Math.floor(n/10), 0, 6);
      bins[idx] += 1;
    });
    // CI-06 Consecutive runs (within mains only)
    let hasConsecutive = false;
    let maxRunLength = 1;
    let runLen = 1;
    for (let i=1;i<mains.length;i++){
      if (mains[i] === mains[i-1] + 1){
        hasConsecutive = true;
        runLen += 1;
        maxRunLength = Math.max(maxRunLength, runLen);
      } else {
        runLen = 1;
      }
    }
    // CI-07 Special band
    const band = (special <= 9) ? "LOW" : (special <= 18 ? "MID" : "HIGH");
    const bandThresholds = { lowMax: 9, midMax: 18, highMax: 26 };
    return { mainSum, sum, odd, even, low, high, gaps, decadeHistogram: bins, hasConsecutive, maxRunLength, specialBand: band, specialBandThresholds: bandThresholds };
  }
  // ---- Deliverable #1 scaffold run ----
  async function runE9Scaffold(){
    setStatusPill("Status: Running...", "warn");
    const pre = await precheckLockedArtifacts();
    logPrecheck(pre.log);
    // Build minimal audit ledger immediately (even for failures)
    const ledger = {
      schemaVersion: SCHEMA_AUDIT_LEDGER,
      project: "Powerball vNext",
      generatedAt: nowIso(),
      status: pre.ok ? "OK_SCAFFOLD" : "FAILED_PRECHECK",
      runId: null,
      runManifest: null,
      events: []
    };
    if (!pre.ok){
      ledger.events.push({
        type: "PRECHECK",
        status: "FAILED_PRECHECK",
        missing: pre.missing,
        log: pre.log
      });
      MOD.lastAuditLedger = ledger;
      MOD.lastRunManifest = null;
      MOD.lastPredictionOutput = null;
      $("e9RunId").textContent = "—";
      $("e9Fingerprint").textContent = "—";
      $("e9EnabledModules").textContent = "—";
      $("e9ExportManifestBtn").disabled = true;
      $("e9ExportLedgerBtn").disabled = false;
      setStatusPill("Status: FAILED_PRECHECK (vE9 fail-closed)", "fail");
      return { ok:false, ledger };
    }
    const { manifest, fingerprint } = await buildRunManifest(pre);
    // D7 schema guard: run manifest must validate or fail-closed.
    const _vm = MOD.validators && MOD.validators.validatePB_E9_RUN_MANIFEST_V1 ? MOD.validators.validatePB_E9_RUN_MANIFEST_V1(manifest) : {ok:true, errs:[]};
    if (!_vm.ok){
      ledger.status = "FAILED_PRECHECK";
      ledger.events.push({
        t: nowIso(),
        type: "MANIFEST_SCHEMA_VIOLATION",
        status: "FAILED_PRECHECK",
        errs: Array.isArray(_vm.errs) ? _vm.errs.slice(0, 50) : []
      });
      MOD.lastAuditLedger = ledger;
      MOD.lastRunManifest = null;
      MOD.lastPredictionOutput = null;
      if ($("e9RunId")) $("e9RunId").textContent = "—";
      if ($("e9Fingerprint")) $("e9Fingerprint").textContent = "—";
      if ($("e9EnabledModules")) $("e9EnabledModules").textContent = "—";
      if ($("e9ExportManifestBtn")) $("e9ExportManifestBtn").disabled = true;
      if ($("e9ExportLedgerBtn")) $("e9ExportLedgerBtn").disabled = false;
      const el = $("e9PrecheckLog");
      if (el){
        const msg = "FAIL: Run manifest schema violation: " + (Array.isArray(_vm.errs) ? _vm.errs.join("; ") : "(unknown)");
        el.textContent = (el.textContent ? (el.textContent + "\n") : "") + msg;
      }
      setStatusPill("Status: FAILED_PRECHECK (manifest schema)", "fail");
      return { ok:false, ledger };
    }
    ledger.runId = manifest.runId;
    ledger.runManifest = manifest;
    // Candidate input: textarea first, else previous predictions
    let candidatesRaw = readCandidatesFromTextarea();
    let source = "TEXTAREA";
    if (!candidatesRaw.parsed.length){
      candidatesRaw = tryReadCandidatesFromPreviousPredictions();
      source = "PREVIOUS_PREDICTIONS_TABLE";
    }
    if (!candidatesRaw.parsed.length){
      ledger.status = "FAILED_PRECHECK";
      ledger.events.push({
        type: "CANDIDATES",
        status: "FAILED_PRECHECK",
        sourceTried: source,
        rejected: candidatesRaw.rejected
      });
      MOD.lastAuditLedger = ledger;
      MOD.lastRunManifest = manifest;
      MOD.lastPredictionOutput = null;
      $("e9RunId").textContent = manifest.runId;
      $("e9Fingerprint").textContent = fingerprint.slice(0, 24) + "…";
      $("e9EnabledModules").textContent = Object.entries(manifest.enabledModules).filter(([k,v])=>v).map(([k])=>k).join(", ") || "—";
      $("e9ExportManifestBtn").disabled = false;
      $("e9ExportLedgerBtn").disabled = false;
      setStatusPill("Status: FAILED_PRECHECK (no candidates)", "fail");
      return { ok:false, ledger };
    }
    // Normalize candidates and compute intrinsic features
    const canonical = [];
    const dedup = new Set();
    for (const c of candidatesRaw.parsed){
      const canon = canonicalizeCandidate(c);
      if (dedup.has(canon.candidateId)) continue;
      dedup.add(canon.candidateId);
      canonical.push(canon);
    }
    // Stage 1 event
    ledger.events.push({
      type: "CANDIDATE_CANONICALIZATION",
      status: "OK",
      sourceUsed: source,
      inputCount: candidatesRaw.parsed.length,
      uniqueCount: canonical.length,
      rejectedLines: candidatesRaw.rejected.slice(0, 50)
    });
    // Stage 2 event: intrinsic features only
    const regIndex = getSignalRegistryIndex();
    function makeSignal(signalId, value, sourceRef, transformId, usedByModule){
      const meta = regIndex[signalId];
      if (!meta){
        return { signalId, value, admissible:false, reason:"NOT_IN_REGISTRY", sourceRef, transformId, usedByModule };
      }
      return {
        signalId,
        value,
        type: meta.type,
        sourceClass: meta.sourceClass,
        admissible: true,
        sourceRef,
        transformId: transformId || null,
        usedByModule: usedByModule || null
      };
    }
    const featureVectors = canonical.map(canon => {
      const intrinsic = extractIntrinsicFeatures(canon);
      const signals = [
        makeSignal("CI-01", intrinsic.mainSum, { kind:"CANDIDATE", ref: canon.candidateId }, "sum(main)", "INTRINSIC"),
        makeSignal("CI-02", { oddCount: intrinsic.odd, evenCount: intrinsic.even }, { kind:"CANDIDATE", ref: canon.candidateId }, "oddEvenCount(main)", "INTRINSIC"),
        makeSignal("CI-03", { lowCount: intrinsic.low, highCount: intrinsic.high, threshold: 34 }, { kind:"CANDIDATE", ref: canon.candidateId }, "lowHighCount(main,<=34)", "INTRINSIC"),
        makeSignal("CI-04", { bins: ["0-9","10-19","20-29","30-39","40-49","50-59","60-69"], vector: intrinsic.decadeHistogram }, { kind:"CANDIDATE", ref: canon.candidateId }, "decadeHistogram(main)", "INTRINSIC"),
        makeSignal("CI-05", { gaps: intrinsic.gaps }, { kind:"CANDIDATE", ref: canon.candidateId }, "sortedGaps(mainSorted)", "INTRINSIC"),
        makeSignal("CI-06", { hasConsecutive: intrinsic.hasConsecutive, maxRunLength: intrinsic.maxRunLength }, { kind:"CANDIDATE", ref: canon.candidateId }, "consecutiveRuns(mainSorted)", "INTRINSIC"),
        makeSignal("CI-07", { band: intrinsic.specialBand, thresholds: intrinsic.specialBandThresholds }, { kind:"CANDIDATE", ref: canon.candidateId }, "specialBand(PB)", "INTRINSIC"),
        makeSignal("CI-08", canon.candidateId, { kind:"CANDIDATE", ref: canon.candidateId }, "canonicalString(mainSorted|PB)", "INTRINSIC")
      ];
      return {
        candidateId: canon.candidateId,
        numbers: { main: canon.mainNumbersSorted.slice(), special: canon.specialNumber },
        features: { intrinsic },
        signals,
        provenance: [
          { source: "CANDIDATE_NUMBERS", ref: canon.candidateId }
        ]
      };
    });
    // Deliverable #3: Apply scoring contract (weights/caps/safeguards). Mappings may still be neutral until D4.
    let scoring = null;
    try {
      scoring = applyScoringContractV1(featureVectors, manifest, pre);
      ledger.status = "OK_D3_SCORING_CONTRACT";
      ledger.events.push({
        t: nowIso(),
        type: "E9_SCORING_CONTRACT_APPLIED",
        config: scoring.config,
        note: "Module mappings may be neutral (Mi=0) until Deliverable #4 introduces analytic linkage."
      });
      MOD.lastScoring = scoring;
    } catch (e){
      ledger.status = "FAILED_SCORING_CONTRACT";
      ledger.events.push({ t: nowIso(), type:"E9_SCORING_CONTRACT_FAIL", message: String(e && e.message ? e.message : e), violations: e && e.violations ? e.violations : null });
      setStatusPill("Status: FAILED_SCORING_CONTRACT (vE9 fail-closed)", "fail");
      $("e9ExportManifestBtn").disabled = false;
      $("e9ExportLedgerBtn").disabled = false;
      return { ok:false, manifest, ledger, featureVectors };
    }
    ledger.events.push({
      type: "FEATURE_EXTRACTION",
      status: "OK",
      featureSet: "INTRINSIC_ONLY",
      count: featureVectors.length
    });
    // Placeholder: ranking not implemented in Deliverable #1
    ledger.events.push({
      type: "RANKING",
      status: "SKIPPED",
      reason: "Module scoring + weighting implemented in Deliverables #2–#4."
    });
    // Persist
    MOD.lastRunManifest = manifest;
    MOD.lastAuditLedger = ledger;
    MOD.lastFeatureVectors = featureVectors;
    MOD.lastFingerprint = fingerprint;
    // UI updates
    $("e9RunId").textContent = manifest.runId;
    $("e9Fingerprint").textContent = fingerprint.slice(0, 24) + "…";
    $("e9EnabledModules").textContent = Object.entries(manifest.enabledModules).filter(([k,v])=>v).map(([k])=>k).join(", ") || "—";
    $("e9CandidateCount").textContent = `Candidates: ${canonical.length}`;
    $("e9ExportManifestBtn").disabled = false;
    $("e9ExportLedgerBtn").disabled = false;
    setStatusPill("Status: OK_D3_SCORING_CONTRACT (D3 complete)", "ok");
    // ---- Deliverable #4: Build canonical prediction output derived from audit ledger ----
    try {
      const topN = safeNum($("e9TopN") ? $("e9TopN").value : 25, 25);
      const out = derivePredictionOutputV1(ledger, manifest, scoring, { topN });
      // D7 schema guard: output must validate or fail-closed.
      const _vo = (MOD.validators && MOD.validators.validatePB_E9_PREDICTION_OUTPUT_V1) ? MOD.validators.validatePB_E9_PREDICTION_OUTPUT_V1(out) : {ok:true, errs:[]};
      if (!_vo.ok){ throw Object.assign(new Error('Prediction output schema violation: ' + _vo.errs.join('; ')), { code:'E9_SCHEMA_OUTPUT' }); }
      // D7 schema guard: ledger must validate or fail-closed.
      const _vl = (MOD.validators && MOD.validators.validatePB_E9_AUDIT_LEDGER_V1) ? MOD.validators.validatePB_E9_AUDIT_LEDGER_V1(ledger) : {ok:true, errs:[]};
      if (!_vl.ok){ throw Object.assign(new Error('Audit ledger schema violation: ' + _vl.errs.join('; ')), { code:'E9_SCHEMA_LEDGER' }); }
      MOD.lastPredictionOutput = out;
      // Replace "RANKING: SKIPPED" with actual status if present.
      ledger.events = Array.isArray(ledger.events) ? ledger.events : [];
      ledger.events.push({ t: nowIso(), type:"PREDICTIVE_OUTPUT_BUILT", schemaVersion: SCHEMA_PREDICTION_OUTPUT, topN: out.topN, status:"OK" });
      // Enable export + render immediately (deterministic).
      const showFinal = $("e9ShowFinalScore") ? $("e9ShowFinalScore").checked : false;
      if ($("e9ExportOutputBtn")) $("e9ExportOutputBtn").disabled = false;
      renderPredictionOutputV1(out, ledger, { showFinalScore: showFinal });
    } catch (e){
      ledger.status = "FAILED_PREDICTIVE_OUTPUT";
      ledger.events.push({ t: nowIso(), type:"PREDICTIVE_OUTPUT_FAILED", error: (e && e.message ? e.message : String(e)), code: e && e.code ? e.code : null });
      MOD.lastPredictionOutput = null;
      if ($("e9ExportOutputBtn")) $("e9ExportOutputBtn").disabled = true;
      if ($("e9PredictionsContainer")) $("e9PredictionsContainer").innerHTML = `<div style="color:#b91c1c; font-weight:900;">Fail-closed: ${escapeHtml(e && e.message ? e.message : String(e))}</div>`;
      setStatusPill("Status: FAILED_PREDICTIVE_OUTPUT (vE9 fail-closed)", "fail");
    }
return { ok:true, manifest, ledger, featureVectors };
  }
  // ---- Exports ----
  function downloadJson(filename, obj){
    const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 500);
  }
  // ---- Wire UI (additive; does not touch existing init logic) ----
  // ---- UI: Section toggles + unified widths (post-D3 UI-only change; does not affect logic) ----
  function applyUnifiedSectionWidths(){
    // Use the Methodology Rationale / Explainability panel width as the canonical section width.
    const ref = document.querySelector(".explainability-panel") || document.querySelector("#explainabilityPanel");
    let refMax = null;
    let refPx = null;
    try {
      if (ref) {
        const cs = getComputedStyle(ref);
        refMax = (cs.maxWidth && cs.maxWidth !== "none") ? cs.maxWidth : null;
        try {
          const r = ref.getBoundingClientRect();
          if (r && r.width && r.width > 0) refPx = Math.round(r.width);
        } catch(_){}
      }
    } catch(_){}
    // Ensure the Play Slip section (#controls-container) also receives the unified width treatment.
    document.querySelectorAll(".section-card, .vnext-card, .card, .panel, .controls-container, #controls-container").forEach(el => {
      if (!el || !el.classList) return;
      // Skip if explicitly opted out
      if (el.dataset && el.dataset.noToggle === "true") return;
      if (refMax) {
        el.style.maxWidth = refMax;
      } else if (refPx) {
        el.style.maxWidth = refPx + "px";
      }
      el.style.width = "calc(100% - 24px)";
      el.style.marginLeft = "auto";
      el.style.marginRight = "auto";
      el.style.boxSizing = "border-box";
    });
  }
  function ensureVisibleToggleForCard(card, key){
    if (!card || (card.dataset && card.dataset.noToggle === "true")) return;
    // Do not add a Visible toggle if this card already has one (locked artifacts or prior enhancements)
    // A "Visible" toggle is defined as a label.section-toggle whose text includes "Visible", OR an input id that starts with "toggle" with an adjacent "Visible" label.
    try {
      const existingVisible = card.querySelector("label.section-toggle") &&
        Array.from(card.querySelectorAll("label.section-toggle")).some(l => (l.textContent || "").toLowerCase().includes("visible"));
      if (existingVisible) return;
    } catch(_){}
    // Do not add duplicates from our own injector
    if (card.querySelector && card.querySelector("[data-e9-toggle='visible']")) return;
    // Create a header row (top-right) and a hideable body wrapper
    const body = document.createElement("div");
    body.className = "e9SectionBody";
    // Move existing children into body (preserves existing structure as a subtree)
    const existing = Array.from(card.childNodes);
    existing.forEach(n => body.appendChild(n));
    card.appendChild(body);
    const hdr = document.createElement("div");
    hdr.className = "e9SectionHeader";
    hdr.style.display = "flex";
    hdr.style.justifyContent = "flex-end";
    hdr.style.alignItems = "center";
    hdr.style.gap = "10px";
    hdr.style.marginBottom = "8px";
    const label = document.createElement("label");
    label.className = "section-toggle"; // matches locked UI pill style
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = true;
    cb.setAttribute("data-e9-toggle","visible");
    const storeKey = `PB_E9_SECTION_VISIBLE__${key}`;
    try {
      const saved = localStorage.getItem(storeKey);
      if (saved === "0") cb.checked = false;
    } catch(_){}
    // Text node keeps styling consistent with the locked pill
    label.appendChild(cb);
    label.appendChild(document.createTextNode(" Visible"));
    hdr.appendChild(label);
    // Insert header before body
    card.insertBefore(hdr, body);
    function apply(){
      body.style.display = cb.checked ? "" : "none";
      try { localStorage.setItem(storeKey, cb.checked ? "1" : "0"); } catch(_){}
    }
    cb.addEventListener("change", apply);
    apply();
  }
  function applySectionToggles(){
    // Apply toggles to all major sections except the main control area and play slip area.
    const skipIds = new Set([
      "controlsContainer",
      "controls-container",
      "playSlipSection",
      "generatePlaySlipSection"
    ]);
    const cards = Array.from(document.querySelectorAll(".vnext-card, .section-card, .card, section"));
    let idx = 0;
    for (const c of cards){
      const id = (c.id || "").trim();
      if (id && skipIds.has(id)) continue;
      // Skip main draw controls (per requirement: permanently visible)
      if (c.querySelector && (c.querySelector("#bypassHistoricalData") || c.querySelector("#manualEntryBtn") || c.querySelector("#loadDataBtn") || c.querySelector("#generateNumbersBtn"))) {
        continue;
      }
      // Skip play slip area
      if (c.querySelector && (c.querySelector("#generatePowerballPlaySlipBtn") || c.querySelector("#controls-container") || c.querySelector("#generate-slip"))) {
        continue;
      }
      const key = id || (c.getAttribute && c.getAttribute("data-section-key")) || (`AUTO_${idx++}`);
      ensureVisibleToggleForCard(c, key);
    }
  }
function bindE9Ui(){
    relocateEnh9Panel();
    const initBtn = $("e9InitBtn");
    const runBtn = $("e9RunBtn");
    const expM = $("e9ExportManifestBtn");
    const expL = $("e9ExportLedgerBtn");
    const loadPP = $("e9LoadFromPPBtn");
    if (!initBtn || !runBtn) return;
    initBtn.addEventListener("click", async () => {
      setStatusPill("Status: Initializing...", "warn");
      const pre = await precheckLockedArtifacts();
      logPrecheck(pre.log);
      const ledger = {
        schemaVersion: SCHEMA_AUDIT_LEDGER,
        project: "Powerball vNext",
        generatedAt: nowIso(),
        status: pre.ok ? "OK_MANIFEST_ONLY" : "FAILED_PRECHECK",
        runId: null,
        runManifest: null,
        events: []
      };
      if (!pre.ok){
        ledger.events.push({ type:"PRECHECK", status:"FAILED_PRECHECK", missing: pre.missing, log: pre.log });
        MOD.lastAuditLedger = ledger;
        MOD.lastRunManifest = null;
        $("e9ExportManifestBtn").disabled = true;
        $("e9ExportLedgerBtn").disabled = false;
        setStatusPill("Status: FAILED_PRECHECK (vE9 fail-closed)", "fail");
        return;
      }
      const { manifest, fingerprint } = await buildRunManifest(pre);
      ledger.runId = manifest.runId;
      ledger.runManifest = manifest;
      ledger.events.push({ type:"PRECHECK", status:"OK", log: pre.log });
      ledger.events.push({ type:"MANIFEST", status:"OK" });
      MOD.lastRunManifest = manifest;
      MOD.lastAuditLedger = ledger;
      MOD.lastFingerprint = fingerprint;
      $("e9RunId").textContent = manifest.runId;
      $("e9Fingerprint").textContent = fingerprint.slice(0, 24) + "…";
      $("e9EnabledModules").textContent = Object.entries(manifest.enabledModules).filter(([k,v])=>v).map(([k])=>k).join(", ") || "—";
      $("e9ExportManifestBtn").disabled = false;
      $("e9ExportLedgerBtn").disabled = false;
      setStatusPill("Status: OK_MANIFEST_ONLY", "ok");
    });
    runBtn.addEventListener("click", async () => {
      try {
        await runE9Scaffold();
      } catch (err) {
        // Fail-closed: ensure status transitions out of Running... even on exceptions.
        try {
          const msg = (err && (err.stack || err.message)) ? (err.stack || err.message) : String(err);
          const el = $("e9PrecheckLog");
          if (el){
            el.textContent = (el.textContent ? (el.textContent + "\n") : "") + "E9_RUNTIME_EXCEPTION: " + msg;
          }
          if (window.MOD && MOD.lastAuditLedger && Array.isArray(MOD.lastAuditLedger.events)){
            MOD.lastAuditLedger.events.push({
              t: nowIso(),
              type: "E9_RUNTIME_EXCEPTION",
              message: msg
            });
            MOD.lastAuditLedger.status = "FAILED_RUNTIME";
          }
        } catch (_) {}
        setStatusPill("Status: FAILED_RUNTIME", "fail");
      }
    });
    if (expM){
      expM.addEventListener("click", () => {
        if (!MOD.lastRunManifest) return;
        downloadJson(`PB_vNext_${MOD.lastRunManifest.runId}_RUN_MANIFEST.json`, MOD.lastRunManifest);
      });
    }
    if (expL){
      expL.addEventListener("click", () => {
        if (!MOD.lastAuditLedger) return;
        downloadJson(`PB_vNext_${MOD.lastAuditLedger.runId || "E9"}_AUDIT_LEDGER.json`, MOD.lastAuditLedger);
      });
    }
    if (loadPP){
      loadPP.addEventListener("click", () => {
        const r = tryReadCandidatesFromPreviousPredictions();
        const ta = $("e9CandidatesText");
        if (!ta) return;
        if (!r.parsed.length){
          ta.value = "";
          $("e9CandidateCount").textContent = "Candidates: 0";
          logPrecheck([`No candidates found in Previous Predictions table.`, ...r.rejected.map(x => " - " + x)]);
          setStatusPill("Status: Candidates not found", "warn");
          return;
        }
        const lines = r.parsed.map(c => canonicalizeCandidate(c).candidateId);
        ta.value = lines.join("\n");
        $("e9CandidateCount").textContent = `Candidates: ${lines.length}`;
        setStatusPill("Status: Candidates loaded", "ok");
      });
    }
    // ---- Deliverable #4 UI wiring (additive-only) ----
    const buildOutBtn = $("e9BuildOutputBtn");
    const expOutBtn = $("e9ExportOutputBtn");
    const showFinalChk = $("e9ShowFinalScore");
    const topNInput = $("e9TopN");
    if (buildOutBtn){
      buildOutBtn.addEventListener("click", () => {
        if (!MOD.lastAuditLedger || !MOD.lastRunManifest || !MOD.lastScoring){
          if ($("e9PredictionsMeta")) $("e9PredictionsMeta").textContent = "Run vE9 first (D3 scoring), then build output.";
          return;
        }
        try {
          const topN = safeNum(topNInput ? topNInput.value : 25, 25);
          const out = derivePredictionOutputV1(MOD.lastAuditLedger, MOD.lastRunManifest, MOD.lastScoring, { topN });
          MOD.lastPredictionOutput = out;
          if (expOutBtn) expOutBtn.disabled = false;
          renderPredictionOutputV1(out, MOD.lastAuditLedger, { showFinalScore: showFinalChk ? showFinalChk.checked : false });
        } catch (e){
          MOD.lastPredictionOutput = null;
          if (expOutBtn) expOutBtn.disabled = true;
          if ($("e9PredictionsContainer")) $("e9PredictionsContainer").innerHTML = `<div style="color:#b91c1c; font-weight:900;">Fail-closed: ${escapeHtml(e && e.message ? e.message : String(e))}</div>`;
        }
      });
    }
    if (expOutBtn){
      expOutBtn.addEventListener("click", () => {
        if (!MOD.lastPredictionOutput) return;
        downloadJson(`PB_vNext_${MOD.lastPredictionOutput.runId}_PREDICTION_OUTPUT.json`, MOD.lastPredictionOutput);
      });
    }
    if (showFinalChk){
      showFinalChk.addEventListener("change", () => {
        if (!MOD.lastPredictionOutput || !MOD.lastAuditLedger) return;
        renderPredictionOutputV1(MOD.lastPredictionOutput, MOD.lastAuditLedger, { showFinalScore: showFinalChk.checked });
      });
    }
  }
    // UI-only: unify widths and add Visible toggles (post-D3 requirement)
    try { applyUnifiedSectionWidths(); } catch(_){}
    try { applySectionToggles(); } catch(_){}
  // Bind after DOM is ready (additive; does not alter existing init)
  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", bindE9Ui);
  } else {
    bindE9Ui();
  }
  // Expose minimal API for later deliverables
  MOD.precheckLockedArtifacts = precheckLockedArtifacts;
  MOD.buildRunManifest = buildRunManifest;
  MOD.runE9Scaffold = runE9Scaffold;
  // Expose last-run artifacts for downstream display-only consumers (e.g., USA map toast).
  // Additive-only: does not change scoring logic.
  try {
    Object.defineProperty(window, "PB_E9_LAST_RUN_MANIFEST_V1", { get: function(){ return MOD.lastRunManifest || null; }, configurable: true });
    Object.defineProperty(window, "PB_E9_LAST_AUDIT_LEDGER_V1", { get: function(){ return MOD.lastAuditLedger || null; }, configurable: true });
    Object.defineProperty(window, "PB_E9_LAST_SCORING_V1", { get: function(){ return MOD.lastScoring || null; }, configurable: true });
  } catch(_){ /* ignore */ }
})();
</script>
<script>
(function(){
  "use strict";
  function qs(sel, root){ return (root||document).querySelector(sel); }
  function qsa(sel, root){ return Array.prototype.slice.call((root||document).querySelectorAll(sel)); }
  var mapCanvas = qs('#e9MapCanvas');
  if(!mapCanvas) return;
  var tooltip = qs('#enh9MapTooltip');
  var toast = qs('#enh9MapToast');
  var toastTitle = qs('#e9MapToastTitle');
  var toastBody = qs('#e9MapToastBody');
  var toastClose = qs('#e9MapToastCloseBtn');
  var selDropdown = qs('#e9MapJurisdictionSelect');
  var clearBtn = qs('#e9MapClearSelectionBtn');
  var selectedId = null;
  // Non-participating Powerball states (no state lottery): AL, AK, HI, NV, UT.
  // (PR/VI are represented as boxes on the map and remain selectable.)
  var NON_PB = { AL:true, AK:true, HI:true, NV:true, UT:true };
  function isStateCode(x){ return typeof x === 'string' && /^[A-Z]{2}$/.test(x); }
  function isParticipating(jid){
    if (!isStateCode(jid)) return true;
    if (jid === 'PR' || jid === 'VI') return true;
    return !NON_PB[jid];
  }
  // Simple adjacency pools (deterministic) used for non-participating recommendation.
  var NEIGHBORS = {
    AL: ['GA','TN','MS','FL'],
    NV: ['CA','AZ','UT','ID','OR'],
    UT: ['AZ','CO','ID','WY','NM'],
    AK: [],
    HI: []
  };
  function getLayer(){
    var r = qs('input[name="e9MapLayer"]:checked');
    return r ? String(r.value || 'winnerShare') : 'winnerShare';
  }
  function getMetrics(){
    return (window.PB_E9_STATE_MAP_METRICS_V1 && window.PB_E9_STATE_MAP_METRICS_V1.jurisdictions) ? window.PB_E9_STATE_MAP_METRICS_V1 : null;
  }
  function getRow(jid){
    var m = getMetrics();
    if (!m || !m.jurisdictions) return null;
    return m.jurisdictions[jid] || null;
  }
  function metricValueFor(jid){
    var row = getRow(jid);
    if (!row) return null;
    var layer = getLayer();
    if (layer === 'deltaExpected') return (typeof row.deltaPct === 'number' ? row.deltaPct : null);
    // winnerShare
    return (typeof row.observedPct === 'number' ? row.observedPct : null);
  }
  function bestCandidate(pool){
    var best = null;
    var bestVal = -Infinity;
    for (var i=0;i<pool.length;i++){
      var c = pool[i];
      if (!isParticipating(c)) continue;
      var v = metricValueFor(c);
      if (v == null) continue;
      if (v > bestVal || (v === bestVal && String(c) < String(best))){
        bestVal = v; best = c;
      }
    }
    if (best) return best;
    // fallback: lexicographic among participating
    var filtered = pool.filter(function(x){ return isParticipating(x); }).sort();
    return filtered.length ? filtered[0] : null;
  }
  function recommendForNonParticipating(jid){
    var pool = (NEIGHBORS[jid] || []).slice();
    // Remove non-participating neighbors from pool deterministically
    pool = pool.filter(function(x){ return isParticipating(x); });
    if (pool.length){
      return bestCandidate(pool);
    }
    // AK/HI fallback: choose best overall participating by selected layer.
    var m = getMetrics();
    if (!m || !m.jurisdictions) return null;
    var all = Object.keys(m.jurisdictions).filter(function(x){ return isParticipating(x); });
    return bestCandidate(all);
  }
  function setTooltipVisible(v){
    if(!tooltip) return;
    tooltip.style.display = v ? 'block' : 'none';
    tooltip.setAttribute('aria-hidden', v ? 'false':'true');
  }
  function moveTooltip(evt){
    if(!tooltip) return;
    var pad = 12;
    tooltip.style.left = (evt.clientX + pad) + 'px';
    tooltip.style.top  = (evt.clientY + pad) + 'px';
  }
  function showTooltipFor(jid, evt){
    if(!tooltip) return;
    // Non-participating states: disabled with advisory tooltip.
    if (!isParticipating(jid)){
      var rec = recommendForNonParticipating(jid);
      var msg = '<div style="font-weight:800;margin-bottom:4px;">' + jid + '</div>';
      msg += '<div style="font-size:12px;opacity:.92;">Does not participate in Powerball.</div>';
      if (rec){
        msg += '<div style="font-size:12px;opacity:.92;margin-top:4px;">Suggested nearby jurisdiction to play: <b>' + rec + '</b></div>';
      }
      tooltip.innerHTML = msg;
      moveTooltip(evt);
      setTooltipVisible(true);
      return;
    }
    var row = getRow(jid);
    var layer = getLayer();
    var html = '<div style="font-weight:800;margin-bottom:4px;">' + jid + '</div>';
    if (!row){
      html += '<div style="font-size:12px;opacity:.9;">No metrics available.</div>';
    } else {
      if (layer === 'deltaExpected'){
        html += '<div style="font-size:12px;opacity:.95;">Delta (pp): <b>' + (row.deltaPct==null?'—':row.deltaPct.toFixed(3)) + '</b></div>';
        html += '<div style="font-size:12px;opacity:.95;">Expected: ' + (row.expectedPct==null?'—':row.expectedPct.toFixed(3)+'%') + '</div>';
        html += '<div style="font-size:12px;opacity:.95;">Observed: ' + (row.observedPct==null?'—':row.observedPct.toFixed(3)+'%') + '</div>';
      } else {
        html += '<div style="font-size:12px;opacity:.95;">Observed wins: <b>' + (row.observedWinsCount==null?'—':row.observedWinsCount) + '</b></div>';
        html += '<div style="font-size:12px;opacity:.95;">Observed share: <b>' + (row.observedPct==null?'—':row.observedPct.toFixed(3)+'%') + '</b></div>';
      }
    }
    tooltip.innerHTML = html;
    moveTooltip(evt);
    setTooltipVisible(true);
  }
  function hideTooltip(){
    setTooltipVisible(false);
  }
  function clearSelection(){
    if(selectedId){
      qsa('#e9MapCanvas .e9map-selected').forEach(function(el){ el.classList.remove('e9map-selected'); });
    }
    selectedId = null;
    if(selDropdown) selDropdown.value = '';
    if(clearBtn) { clearBtn.disabled = true; clearBtn.classList.add('is-disabled'); }
    if(toast){
      toast.style.display = 'none';
      toast.setAttribute('aria-hidden','true');
    }
  }
  function selectJurisdiction(jid){
    if(!jid) return;
    if (!isParticipating(jid)){
      // Disabled: keep selection unchanged.
      return;
    }
    clearSelection();
    selectedId = jid;
    // Highlight all shapes with that jurisdiction
    qsa('#e9MapCanvas [data-jurisdiction="'+jid+'"]').forEach(function(el){
      el.classList.add('e9map-selected');
    });
    if(selDropdown) selDropdown.value = jid;
    if(clearBtn) { clearBtn.disabled = false; clearBtn.classList.remove('is-disabled'); }
    // Legacy floating toast is suppressed by CSS in this build; inline panel handles click details.
  }
  function bindEl(el){
    var jid = el.getAttribute('data-jurisdiction') || el.id;
    if(!jid) return;
    // Non-participating: visually disabled and non-interactive (click suppressed).
    if (!isParticipating(jid)){
      el.classList.add('e9map-disabled');
      el.style.pointerEvents = 'auto'; // allow hover tooltips
    }
    el.setAttribute('tabindex','0');
    el.setAttribute('role','button');
    el.addEventListener('mousemove', function(evt){ showTooltipFor(jid, evt); });
    el.addEventListener('mouseleave', function(){ hideTooltip(); });
    el.addEventListener('click', function(evt){
      evt.preventDefault();
      if (!isParticipating(jid)) return;
      selectJurisdiction(jid);
    });
    el.addEventListener('keydown', function(evt){
      if(evt.key === 'Enter' || evt.key === ' '){
        evt.preventDefault();
        selectJurisdiction(jid);
      }
    });
  }
  // Bind all jurisdictions in the map
  qsa('#e9MapCanvas [data-jurisdiction]').forEach(bindEl);
  // Populate dropdown if present
    if(selDropdown){
    var existing = {};
    qsa('#e9MapCanvas [data-jurisdiction]').forEach(function(el){
      var jid = el.getAttribute('data-jurisdiction');
        if(jid && !existing[jid] && isParticipating(jid)) existing[jid] = true;
    });
    var jids = Object.keys(existing).sort();
    // clear options except first
    while(selDropdown.options.length > 1) selDropdown.remove(1);
    jids.forEach(function(jid){
      var opt = document.createElement('option');
      opt.value = jid;
      opt.textContent = jid;
      selDropdown.appendChild(opt);
    });
    selDropdown.addEventListener('change', function(){
      var v = selDropdown.value;
      if(v) selectJurisdiction(v);
    });
  }
  if(clearBtn){
    clearBtn.addEventListener('click', function(){ clearSelection(); });
  }
  if(toastClose){
    toastClose.addEventListener('click', function(){ if(toast){ toast.style.display='none'; toast.setAttribute('aria-hidden','true'); } });
  }
  // CXT Overlay info: show a structured informational tooltip (not just a literal "i").
  try {
    var info = document.querySelector('.e9map-controls .e9info-icon');
    if (info){
      var showInfo = function(evt){
        if (!tooltip) return;
        tooltip.innerHTML =
          '<div style="font-weight:800;margin-bottom:6px;">CXT Overlay (Context)</div>' +
          '<div style="font-size:12px;opacity:.92;line-height:1.35;">' +
          'This layer annotates time periods and records with macro or policy context. It is <b>non-causal</b> and <b>display-only</b> unless explicitly admitted by a scoring deliverable.' +
          '</div>' +
          '<div style="font-size:12px;opacity:.92;margin-top:6px;line-height:1.35;">' +
          'Use it to understand the historical backdrop; do not interpret it as a reason a state won.' +
          '</div>';
        moveTooltip(evt);
        setTooltipVisible(true);
      };
      info.addEventListener('mouseenter', showInfo);
      info.addEventListener('mousemove', showInfo);
      info.addEventListener('mouseleave', hideTooltip);
      info.addEventListener('focus', function(){
        // Synthesize a position near the control on keyboard focus.
        var r = info.getBoundingClientRect();
        showInfo({ clientX: r.left + r.width/2, clientY: r.bottom });
      });
      info.addEventListener('blur', hideTooltip);
    }
  } catch(_){ /* ignore */ }
  // Ensure tooltip hidden
  hideTooltip();
})();
</script>
<!-- Enhancement #9 — USA Mapping (Continuation) | Deliverable 2, Stage 1 (SAFE REBUILD) -->
<style id="enh9-d2s2-ui-fix">
/* Enhancement #9 — D2S2 UI FIX: center + enlarge USA map within canvas; label text handled in HTML */
#e9MapCanvas.e9map-canvas{
  display:flex;
  align-items:center;
  justify-content:center;
}
#e9MapCanvas .e9usa-svg{
  width:160%;
  height:160%;
  max-width:none;
  max-height:none;
}
@media (max-width: 980px){
  #e9MapCanvas .e9usa-svg{ width:130%; height:130%; }
}
</style>
<!-- Enhancement #9 — USA Mapping | Deliverable 2, Stage 2 (SAFE) -->
<!-- Enhancement #9 — USA Mapping | Deliverable 3 (Tooltip + Toast population) -->
<script id="enh9-d3-toast-tooltip" type="text/javascript">
(function(){
  "use strict";
  function $(id){ return document.getElementById(id); }
  function nowIso(){ try { return new Date().toISOString(); } catch(e){ return String(Date.now()); } }
  var TOOLTIP_ID = "enh9MapTooltip";
  var TOAST_ID = "enh9MapToast";
  var TOAST_TITLE_ID = "e9MapToastTitle";
  var TOAST_BODY_ID = "e9MapToastBody";
  var TOAST_CLOSE_ID = "e9MapToastCloseBtn";
  var SELECT_ID = "e9MapJurisdictionSelect";
  var CLEAR_ID = "e9MapClearSelectionBtn";
  function isStateCode(x){ return typeof x === "string" && /^[A-Z]{2}$/.test(x); }
  function fmtPct(x){
    if (x == null || typeof x !== "number" || !isFinite(x)) return "—";
    return (Math.round(x * 1000) / 1000).toFixed(3) + "%";
  }
  function fmtNum(x){
    if (x == null || typeof x !== "number" || !isFinite(x)) return "—";
    return String(Math.round(x));
  }
  function fmtIndex(x){
    if (x == null || typeof x !== "number" || !isFinite(x)) return "—";
    return (Math.round(x * 10000) / 10000).toFixed(4);
  }
  function ensureMetrics(){
    try{
      if (window.PB_E9_STATE_MAP_METRICS_V1 && window.PB_E9_STATE_MAP_METRICS_V1.jurisdictions) return window.PB_E9_STATE_MAP_METRICS_V1;
      if (typeof window.buildStateMapMetricsV1 === "function"){
        var inp = null;
        try { inp = window.PB_E9_STATE_MAP_ADAPTER_INPUT; } catch(e){ inp = null; }
        var m = window.buildStateMapMetricsV1(inp);
        window.PB_E9_STATE_MAP_METRICS_V1 = m;
        return m;
      }
    } catch(e){}
    return null;
  }
  function getRow(stateCode){
    var m = ensureMetrics();
    if (!m || !m.jurisdictions) return null;
    return m.jurisdictions[stateCode] || null;
  }
  function severityFromRow(row){
    if (!row) return { label: "UNKNOWN", tone: "muted" };
    if (row.status === "UNKNOWN") return { label: "UNKNOWN", tone: "muted" };
    // Severity heuristics (display-only): combine status + magnitude band.
    // B3 highest, B2 medium, B1 low, B0 neutral.
    var band = row.deltaMagnitudeBand || "B0";
    if (row.status === "OVER"){
      if (band === "B3") return { label: "OVER (HIGH)", tone: "overHigh" };
      if (band === "B2") return { label: "OVER (MED)", tone: "overMed" };
      if (band === "B1") return { label: "OVER (LOW)", tone: "overLow" };
      return { label: "OVER (NEAR)", tone: "overNear" };
    }
    if (row.status === "UNDER"){
      if (band === "B3") return { label: "UNDER (HIGH)", tone: "underHigh" };
      if (band === "B2") return { label: "UNDER (MED)", tone: "underMed" };
      if (band === "B1") return { label: "UNDER (LOW)", tone: "underLow" };
      return { label: "UNDER (NEAR)", tone: "underNear" };
    }
    return { label: "NEUTRAL", tone: "neutral" };
  }
  function badgeStyle(tone){
    // Inline styles only (avoid CSS churn until D4).
    if (tone === "overHigh") return "background:#0ea5e9;color:#06263a;";
    if (tone === "overMed") return "background:#38bdf8;color:#06263a;";
    if (tone === "overLow") return "background:#7dd3fc;color:#06263a;";
    if (tone === "overNear") return "background:#bae6fd;color:#06263a;";
    if (tone === "underHigh") return "background:#fb7185;color:#3a0610;";
    if (tone === "underMed") return "background:#fda4af;color:#3a0610;";
    if (tone === "underLow") return "background:#fecdd3;color:#3a0610;";
    if (tone === "underNear") return "background:#ffe4e6;color:#3a0610;";
    if (tone === "neutral") return "background:#e2e8f0;color:#0f172a;";
    return "background:#e5e7eb;color:#111827;";
  }
  // D13: Participation + scoring-impact disclosure (deterministic)
  var NON_PARTICIPATING_STATES = { "AL":true, "AK":true, "HI":true, "NV":true, "UT":true };
  function isParticipatingState(code){
    code = (code||"").toUpperCase();
    return !!code && !NON_PARTICIPATING_STATES[code];
  }
  // Deterministic adjacency for non-participating states (limited set)
  var NONPB_ADJ = {
    "AL": ["GA","FL","MS","TN"],
    "NV": ["CA","AZ","OR","ID"],
    "UT": ["ID","WY","CO","AZ","NM"],
    "AK": [],
    "HI": []
  };
  function getCurrentMapLayer(){
    try{
      var checked = document.querySelector('input[name="e9MapLayer"]:checked');
      return checked ? checked.value : "winnerShare";
    } catch(e){ return "winnerShare"; }
  }
  function getLayerScoreForRow(row){
    if (!row) return -Infinity;
    var layer = getCurrentMapLayer();
    if (layer === "deltaExpected"){
      // deltaPct is already in percentage points (e.g., -7.584) or a fraction? In our metrics table it is points.
      return (row.deltaPct != null ? row.deltaPct : -Infinity);
    }
    // winnerShare: use observedPct (fraction 0-1)
    return (row.observedPct != null ? row.observedPct : -Infinity);
  }
  function recommendParticipatingStateFor(nonPbCode){
    nonPbCode = (nonPbCode||"").toUpperCase();
    var cands = (NONPB_ADJ[nonPbCode] || []).slice();
    // Filter to participating only
    cands = cands.filter(function(c){ return isParticipatingState(c); });
    // If none (AK/HI), fall back to best overall participating state by current layer score
    if (!cands.length){
      try{
        var best = null;
        if (window.PB_E9_STATE_MAP_METRICS_V1 && window.PB_E9_STATE_MAP_METRICS_V1.rows){
          window.PB_E9_STATE_MAP_METRICS_V1.rows.forEach(function(r){
            var code = (r && r.state) ? String(r.state).toUpperCase() : "";
            if (!isParticipatingState(code)) return;
            var sc = getLayerScoreForRow(r);
            if (best == null || sc > best.sc || (sc === best.sc && code < best.code)){
              best = { code: code, sc: sc };
            }
          });
        }
        return best ? best.code : "—";
      } catch(e){ return "—"; }
    }
    // Choose best by current layer score; tie-break lexicographic
    var best2 = null;
    for (var i=0;i<cands.length;i++){
      var code2 = cands[i];
      var row2 = getRow(code2);
      var sc2 = getLayerScoreForRow(row2);
      if (best2 == null || sc2 > best2.sc || (sc2 === best2.sc && code2 < best2.code)){
        best2 = { code: code2, sc: sc2 };
      }
    }
    return best2 ? best2.code : cands[0];
  }
  function scoringImpactPrefix(){
    try{
      var man = window.PB_E9_RUN_MANIFEST_V1;
      var enabled = man && Array.isArray(man.enabledModules) ? man.enabledModules : [];
      if (enabled.indexOf("SRES") >= 0){
        return "Scoring-enabled (SRES).";
      }
    } catch(e){}
    return "Display-only. No scoring impact.";
  }
  function renderNonParticipatingTooltipHtml(code){
    var rec = recommendParticipatingStateFor(code);
    var layer = getCurrentMapLayer();
    var metricLabel = (layer === "deltaExpected") ? "Delta vs Expected" : "Winner Share";
    return ""
      + "<div style='font-weight:700;margin-bottom:4px;'>State: " + code + "</div>"
      + "<div style='font-size:12px;opacity:.95;margin-bottom:6px;'>Does not participate in Powerball.</div>"
      + "<div style='font-size:12px;'>Suggested nearby jurisdiction to play (" + metricLabel + "): <b>" + (rec || "—") + "</b></div>";
  }
function renderTooltipHtml(stateCode, row){
    var sev = severityFromRow(row);
    var flags = (row && row.dataQualityFlags && row.dataQualityFlags.length) ? row.dataQualityFlags.join(", ") : "—";
    var html = ""
      + "<div style='font-weight:700;margin-bottom:4px;'>State: " + stateCode + "</div>"
      + "<div style='display:flex;gap:8px;align-items:center;margin-bottom:6px;'>"
      + "<span style='padding:2px 8px;border-radius:999px;font-weight:700;font-size:11px;" + badgeStyle(sev.tone) + "'>" + sev.label + "</span>"
      + "<span style='font-size:11px;color:#cbd5e1;'>Band: " + (row ? (row.deltaMagnitudeBand || "B0") : "—") + "</span>"
      + "</div>"
      + "<div style='font-size:12px;'>"
      + "<div>Observed wins: <b>" + (row ? fmtNum(row.observedWinsCount) : "—") + "</b></div>"
      + "<div>Observed share: <b>" + (row ? fmtPct(row.observedPct) : "—") + "</b></div>"
      + "<div>Expected share: <b>" + (row ? fmtPct(row.expectedPct) : "—") + "</b></div>"
      + "<div>Delta (pp): <b>" + (row && row.deltaPct != null ? (Math.round(row.deltaPct * 1000)/1000).toFixed(3) + " pts" : "—") + "</b></div>"
      + "<div>Relative index: <b>" + (row ? fmtIndex(row.relativeIndex) : "—") + "</b></div>"
      + "<div style='margin-top:6px;color:#cbd5e1;font-size:11px;'>DQ: " + flags + "</div>"
      + "</div>";
    return html;
  }
  function renderToastHtml(stateCode, row){
    var sev = severityFromRow(row);
    var flags = (row && row.dataQualityFlags && row.dataQualityFlags.length) ? row.dataQualityFlags : [];
    var dq = flags.length ? ("<ul style='margin:6px 0 0 18px;padding:0;'>" + flags.map(function(f){ return "<li>" + f + "</li>"; }).join("") + "</ul>") : "<div style='margin-top:6px;color:#475569;'>None</div>";
    var html = ""
      + "<div style='margin-bottom:10px;'>"
      + "<span style='padding:3px 10px;border-radius:999px;font-weight:800;font-size:12px;display:inline-block;" + badgeStyle(sev.tone) + "'>" + sev.label + "</span>"
      + "<span style='margin-left:8px;color:#475569;font-size:12px;'>Band: " + (row ? (row.deltaMagnitudeBand || "B0") : "—") + "</span>"
      + "</div>"
      + "<div style='display:grid;grid-template-columns: 1fr 1fr;gap:10px;'>"
      + "<div style='border:1px solid #e2e8f0;border-radius:12px;padding:10px;'>"
      + "<div style='font-weight:800;margin-bottom:6px;'>Winner Share</div>"
      + "<div style='font-size:13px;'>Observed wins: <b>" + (row ? fmtNum(row.observedWinsCount) : "—") + "</b></div>"
      + "<div style='font-size:13px;'>Observed share: <b>" + (row ? fmtPct(row.observedPct) : "—") + "</b></div>"
      + "</div>"
      + "<div style='border:1px solid #e2e8f0;border-radius:12px;padding:10px;'>"
      + "<div style='font-weight:800;margin-bottom:6px;'>Delta vs Expected</div>"
      + "<div style='font-size:13px;'>Expected share: <b>" + (row ? fmtPct(row.expectedPct) : "—") + "</b></div>"
      + "<div style='font-size:13px;'>Delta (pp): <b>" + (row && row.deltaPct != null ? (Math.round(row.deltaPct * 1000)/1000).toFixed(3) + " pts" : "—") + "</b></div>"
      + "<div style='font-size:13px;'>Relative index: <b>" + (row ? fmtIndex(row.relativeIndex) : "—") + "</b></div>"
      + "</div>"
      + "</div>"
      + "<div style='margin-top:12px;border-top:1px solid #e2e8f0;padding-top:10px;'>"
      + "<div style='font-weight:800;margin-bottom:6px;'>Data Quality Flags</div>"
      + dq
      + "</div>"
      + "<div style='margin-top:10px;color:#64748b;font-size:12px;'>"
      + scoringImpactPrefix() + " Metrics generated at: " + ((window.PB_E9_STATE_MAP_METRICS_V1 && window.PB_E9_STATE_MAP_METRICS_V1.generatedAtISO) ? window.PB_E9_STATE_MAP_METRICS_V1.generatedAtISO : nowIso())
      + "</div>";
    return html;
  }
  function showTooltip(x, y, html){
    var tip = $(TOOLTIP_ID);
    if (!tip) return;
    tip.innerHTML = html;
    tip.style.display = "block";
    tip.setAttribute("aria-hidden","false");
    // keep within viewport
    var pad = 12;
    var w = tip.offsetWidth || 260;
    var h = tip.offsetHeight || 80;
    var left = x + pad;
    var top = y + pad;
    var vw = window.innerWidth || 1200;
    var vh = window.innerHeight || 800;
    if (left + w + pad > vw) left = Math.max(pad, x - w - pad);
    if (top + h + pad > vh) top = Math.max(pad, y - h - pad);
    tip.style.left = left + "px";
    tip.style.top = top + "px";
  }
  function hideTooltip(){
    var tip = $(TOOLTIP_ID);
    if (!tip) return;
    tip.style.display = "none";
    tip.setAttribute("aria-hidden","true");
    tip.innerHTML = "";
  }
  function setToast(stateCode, row){
    var title = $(TOAST_TITLE_ID);
    var body = $(TOAST_BODY_ID);
    if (title) title.textContent = "State: " + stateCode;
    if (body) body.innerHTML = renderToastHtml(stateCode, row);
  }
  function bindStateEl(el, code){
    if (!el) return;
    // Visually mark non-participating states
    try{
      if (!isParticipatingState(code)){
        el.classList.add("e9map-nonparticipant");
      }
    } catch(e){}
    el.addEventListener("mouseenter", function(evt){
      if (!isParticipatingState(code)){
        showTooltip(evt.clientX, evt.clientY, renderNonParticipatingTooltipHtml(code));
        return;
      }
      var row = getRow(code);
      showTooltip(evt.clientX, evt.clientY, renderTooltipHtml(code, row));
    });
    el.addEventListener("mousemove", function(evt){
      if (!isParticipatingState(code)){
        showTooltip(evt.clientX, evt.clientY, renderNonParticipatingTooltipHtml(code));
        return;
      }
      var row = getRow(code);
      showTooltip(evt.clientX, evt.clientY, renderTooltipHtml(code, row));
    });
    el.addEventListener("mouseleave", function(){
      hideTooltip();
    });
    el.addEventListener("click", function(){
      if (!isParticipatingState(code)){
        // Disabled: do not select / open toast for non-participating states
        return;
      }
      var row = getRow(code);
      setToast(code, row);
      // Do not force toast visibility here; existing D1S2 click logic controls open/close.
    });
  });
    el.addEventListener("mousemove", function(evt){
      var row = getRow(code);
      showTooltip(evt.clientX, evt.clientY, renderTooltipHtml(code, row));
    });
    el.addEventListener("mouseleave", function(){
      hideTooltip();
    });
    el.addEventListener("click", function(){
      var row = getRow(code);
      setToast(code, row);
      // Do not force toast visibility here; existing D1S2 click logic controls open/close.
    });
  }
  function bindSelect(){
    var sel = $(SELECT_ID);
    if (!sel) return;
    sel.addEventListener("change", function(){
      var v = (sel.value || "").toUpperCase();
      if (!isStateCode(v)) return;
      var row = getRow(v);
      setToast(v, row);
    });
  }
  function bindClear(){
    var btn = $(CLEAR_ID);
    if (!btn) return;
    btn.addEventListener("click", function(){
      hideTooltip();
      // reset toast copy to default (do not alter open/close behavior)
      var title = $(TOAST_TITLE_ID);
      var body = $(TOAST_BODY_ID);
      if (title) title.textContent = "State Details";
      if (body) body.textContent = "Click a state to load its structured details (templates and severity rules implemented in later deliverables).";
    });
  }
  function bindCloseFallback(){
    var btn = $(TOAST_CLOSE_ID);
    var toast = $(TOAST_ID);
    if (!btn || !toast) return;
    // If baseline already wires it, this is harmless.
    btn.addEventListener("click", function(){
      try{
        toast.style.display = "none";
        toast.setAttribute("aria-hidden","true");
      } catch(e){}
    });
  }
  function init(){
    // Bind all states by DOM id (2-letter uppercase, includes PR/VI if present)
    var svg = document.querySelector("svg");
    var nodes = svg ? svg.querySelectorAll("[id]") : document.querySelectorAll("[id]");
    for (var i=0;i<nodes.length;i++){
      var id = nodes[i].getAttribute("id");
      if (!id) continue;
      if (/^[A-Z]{2}$/.test(id)){
        bindStateEl(nodes[i], id);
      }
    }
    bindSelect();
    bindClear();
    bindCloseFallback();
  }
  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }
})();
</script>
<script id="enh9-d2s2-adapter-wire" type="text/javascript">
(function(){
  "use strict";
  // D2S2 (SAFE): Wire real observed/expected state data into adapter (still no colors).
  // Primary source (preferred): Enhancement #3 State Representation table in DOM (#enh3StateShareTbody)
  // Fallback source: localStorage jackpot hits dataset (best-effort)
  // Display-only. No scoring impact. No mutation of predictions/history data.
  var STATE_TBODY_ID = "enh3StateShareTbody";
  var ENH3_HITS_KEY_CANDIDATES = [
    "pb_vnext_jackpot_hits_vE3_1",
    "pb_vnext_jackpot_hits_vE3.1",
    "pb_vnext_jackpot_hits_vE3_2",
    "pb_vnext_jackpot_hits_vE3_0",
    "pb_vnext_jackpot_hits",
    "PB_JACKPOT_HITS_VE31",
    "PB_JACKPOT_HITS_VE3_1",
    "PB_JACKPOT_HITS",
    "jackpotHits",
    "jackpot_hits"
  ];
  function nowIso(){
    try { return new Date().toISOString(); } catch(e){ return String(Date.now()); }
  }
  function safeJsonParse(s){
    try { return JSON.parse(s); } catch(e){ return null; }
  }
  function isStateCode(x){
    return typeof x === "string" && /^[A-Z]{2}$/.test(x);
  }
  function normalizeState(x){
    if (typeof x !== "string") return null;
    var v = x.trim().toUpperCase();
    if (!v) return null;
    if (/^US\-[A-Z]{2}$/.test(v)) v = v.slice(3);
    if (isStateCode(v)) return v;
    return null;
  }
  function toNum(s){
    if (s == null) return null;
    var v = String(s).replace(/[%,$]/g,"").replace(/,/g,"").trim();
    if (!v) return null;
    var n = Number(v);
    return isFinite(n) ? n : null;
  }
  function getJurisdictionsFromMapDom(){
    var out = [];
    var seen = {};
    var svg = document.querySelector("svg");
    var nodes = svg ? svg.querySelectorAll("[id]") : document.querySelectorAll("[id]");
    for (var i=0;i<nodes.length;i++){
      var id = nodes[i].getAttribute("id");
      if (!id) continue;
      if (/^[A-Z]{2}$/.test(id)){
        if (!seen[id]){ seen[id] = true; out.push(id); }
      }
    }
    out.sort();
    return out;
  }
  // ---------------------------
  // PRIMARY: read Enh#3 State representation table
  // Columns:
  // Sel | State | Observed Tickets | Expected Tickets | Obs/Exp | Population | Pop Share | Chi Component
  // ---------------------------
  function readFromStateShareTable(){
    var tbody = document.getElementById(STATE_TBODY_ID);
    if (!tbody) return { ok: false, reason: "TBODY_NOT_FOUND" };
    var rows = tbody.querySelectorAll("tr");
    if (!rows || !rows.length) return { ok: false, reason: "NO_ROWS" };
    var observed = {};
    var expectedPct = {};
    var found = 0;
    for (var i=0;i<rows.length;i++){
      var tds = rows[i].querySelectorAll("td");
      if (!tds || tds.length < 8) continue;
      var st = normalizeState(tds[1] ? tds[1].textContent : "");
      if (!st) continue;
      // Skip placeholder row (single colspan)
      if (tds.length == 1 && /run analytics/i.test(rows[i].textContent || "")) continue;
      var obs = toNum(tds[2] ? tds[2].textContent : null);
      var popShare = toNum(tds[6] ? tds[6].textContent : null);
      if (obs == null) obs = 0;
      observed[st] = Math.max(0, Math.round(obs));
      if (popShare != null){
        // Pop Share column is typically percent; keep as percent
        expectedPct[st] = popShare;
      }
      found++;
    }
    if (!found) return { ok: false, reason: "NO_STATE_ROWS" };
    // ensure structural completeness with map ids
    var juris = getJurisdictionsFromMapDom();
    for (var j=0;j<juris.length;j++){
      if (!observed.hasOwnProperty(juris[j])) observed[juris[j]] = 0;
      if (!expectedPct.hasOwnProperty(juris[j])) expectedPct[juris[j]] = null;
    }
    return {
      ok: true,
      observed: observed,
      expectedPct: expectedPct,
      meta: {
        method: "DOM_ENH3_STATE_SHARE_TABLE",
        tbodyId: STATE_TBODY_ID,
        rowsParsed: found
      }
    };
  }
  // ---------------------------
  // FALLBACK: localStorage jackpot hits best-effort
  // ---------------------------
  function extractHitsArray(ds){
    if (Array.isArray(ds)) return ds;
    if (!ds || typeof ds !== "object") return null;
    if (Array.isArray(ds.hits)) return ds.hits;
    if (Array.isArray(ds.rows)) return ds.rows;
    if (Array.isArray(ds.data)) return ds.data;
    if (Array.isArray(ds.records)) return ds.records;
    if (Array.isArray(ds.items)) return ds.items;
    if (Array.isArray(ds.tickets)) return ds.tickets;
    if (ds.hitsByDate && typeof ds.hitsByDate === "object"){
      var arr = [];
      for (var k in ds.hitsByDate){
        if (ds.hitsByDate.hasOwnProperty(k)) arr.push(ds.hitsByDate[k]);
      }
      return arr;
    }
    if (ds.payload && typeof ds.payload === "object"){
      if (Array.isArray(ds.payload.hits)) return ds.payload.hits;
      if (Array.isArray(ds.payload.rows)) return ds.payload.rows;
      if (Array.isArray(ds.payload.data)) return ds.payload.data;
      if (Array.isArray(ds.payload.records)) return ds.payload.records;
    }
    return null;
  }
  function splitStatesString(s){
    if (typeof s !== "string") return [];
    var v = s.replace(/STATE\:/gi,"").replace(/US\-/gi,"").trim();
    if (!v) return [];
    var parts = v.split(/[\s,;|\/]+/g);
    var out = [];
    for (var i=0;i<parts.length;i++){
      var st = normalizeState(parts[i]);
      if (st) out.push(st);
    }
    return out;
  }
  function extractTicketStates(hit){
    var out = [];
    if (!hit) return out;
    if (Array.isArray(hit.__tickets)) out = out.concat(hit.__tickets);
    else if (Array.isArray(hit.tickets)) out = out.concat(hit.tickets);
    if (Array.isArray(hit.winnerStates)) out = out.concat(hit.winnerStates);
    else if (Array.isArray(hit.states)) out = out.concat(hit.states);
    if (typeof hit.winnerStates === "string") out = out.concat(splitStatesString(hit.winnerStates));
    if (typeof hit.states === "string") out = out.concat(splitStatesString(hit.states));
    if (typeof hit.state === "string") out.push(hit.state);
    if (typeof hit.jurisdiction === "string") out.push(hit.jurisdiction);
    if (hit.winner && typeof hit.winner === "object"){
      if (typeof hit.winner.state === "string") out.push(hit.winner.state);
      if (Array.isArray(hit.winner.states)) out = out.concat(hit.winner.states);
      if (typeof hit.winner.states === "string") out = out.concat(splitStatesString(hit.winner.states));
    }
    var norm = [];
    for (var i=0;i<out.length;i++){
      var st = normalizeState(String(out[i]));
      if (st) norm.push(st);
    }
    return norm;
  }
  function findLocalStorageDataset(){
    var tried = [];
    for (var i=0;i<ENH3_HITS_KEY_CANDIDATES.length;i++){
      var k = ENH3_HITS_KEY_CANDIDATES[i];
      tried.push(k);
      try{
        var raw = localStorage.getItem(k);
        if (raw) return { found: true, key: k, raw: raw, tried: tried };
      } catch(e){}
    }
    return { found: false, key: null, raw: null, tried: tried };
  }
  function readFromLocalStorage(){
    var pick = findLocalStorageDataset();
    var observed = {};
    var expectedPct = {};
    var juris = getJurisdictionsFromMapDom();
    for (var i=0;i<juris.length;i++){
      observed[juris[i]] = 0;
      expectedPct[juris[i]] = null;
    }
    if (!pick.found){
      return { ok: false, observed: observed, expectedPct: expectedPct, meta: { method: "LOCALSTORAGE", found: false, triedKeys: pick.tried } };
    }
    var ds = safeJsonParse(pick.raw);
    var hits = extractHitsArray(ds);
    if (!hits || !hits.length){
      return { ok: false, observed: observed, expectedPct: expectedPct, meta: { method: "LOCALSTORAGE", found: true, key: pick.key, reason: "NO_HITS_ARRAY" } };
    }
    var ticketCount = 0;
    for (var h=0; h<hits.length; h++){
      var states = extractTicketStates(hits[h]);
      for (var t=0; t<states.length; t++){
        var st = states[t];
        if (!observed.hasOwnProperty(st)) observed[st] = 0;
        observed[st] = (observed[st] || 0) + 1;
        ticketCount++;
      }
    }
    return {
      ok: true,
      observed: observed,
      expectedPct: expectedPct,
      meta: {
        method: "LOCALSTORAGE_JACKPOT_HITS",
        key: pick.key,
        triedKeys: pick.tried,
        recordCount: hits.length,
        ticketCount: ticketCount
      }
    };
  }
  function buildExpectedUniformIfMissing(expectedPct, observed){
    // If expectedPct is all null, default to uniform across jurisdictions.
    var keys = Object.keys(observed || {}).filter(function(k){ return /^[A-Z]{2}$/.test(k); }).sort();
    if (!keys.length) return expectedPct;
    var any = false;
    for (var i=0;i<keys.length;i++){
      if (typeof expectedPct[keys[i]] === "number" && isFinite(expectedPct[keys[i]])) { any = true; break; }
    }
    if (any) return expectedPct;
    var per = 100.0 / keys.length;
    per = Math.round(per * 1000) / 1000;
    for (var j=0;j<keys.length;j++){
      expectedPct[keys[j]] = per;
    }
    return expectedPct;
  }
  function wireAdapter(){
    var pack = readFromStateShareTable();
    if (!pack.ok){
      pack = readFromLocalStorage();
    }
    var observed = pack.observed || {};
    var expectedPct = pack.expectedPct || {};
    expectedPct = buildExpectedUniformIfMissing(expectedPct, observed);
    window.PB_E9_STATE_MAP_ADAPTER_INPUT = {
      schema: "PB_E9_STATE_MAP_ADAPTER_INPUT_V1",
      observedWinsByJurisdiction: observed,
      expectedPctByJurisdiction: expectedPct,
      cxtByJurisdiction: {},
      adapterMeta: {
        stage: "D2S2",
        builtAtISO: nowIso(),
        observedSource: pack.meta || {},
        expectedSource: { method: "POP_SHARE_IF_PRESENT_ELSE_UNIFORM" }
      }
    };
    try{
      if (typeof window.buildStateMapMetricsV1 === "function"){
        window.PB_E9_STATE_MAP_METRICS_V1 = window.buildStateMapMetricsV1(window.PB_E9_STATE_MAP_ADAPTER_INPUT);
      }
    } catch(e){}
    try{
      if (typeof window.PB_E9_APPLY_HEATMAP === "function"){
        window.PB_E9_APPLY_HEATMAP();
      }
    } catch(e2){}
  }
  // Expose explicit refresh hook (called after analytics runs)
  window.PB_E9_REFRESH_STATE_MAP = function(){
    try { wireAdapter(); } catch(e){}
  };
  function init(){
    wireAdapter();
    // periodic refresh to pick up analytics table updates (display-only)
    setInterval(function(){
      try{ wireAdapter(); } catch(e){}
    }, 2000);
  }
  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }
})();
</script>
<script id="enh9-d2s1-safe" type="text/javascript">
(function(){
  "use strict";
  // =========================
  // Enhancement #9 Map Cache v1
  // =========================
  var PB_E9_STATE_MAP_CACHE_KEY_V1 = "PB_E9_STATE_MAP_CACHE_V1";
  var PB_E9_STATE_MAP_CACHE_SCHEMA_V1 = "StateMapCacheEnvelopeV1";
  var PB_E9_STATE_MAP_METRICS_SCHEMA_V1 = "StateMapMetricsV1";
  // Normative thresholds (aligned to existing vE3.5 helper semantics for over/under by ratio).
  // NOTE: These are DISPLAY-ONLY classifications.
  var OVER_INDEX_THRESHOLD = 1.05;
  var UNDER_INDEX_THRESHOLD = 0.95;
  // Delta magnitude band thresholds (percentage points, absolute). Display-only.
  // B0: <0.5 pts, B1: 0.5–1.49 pts, B2: 1.5–2.99 pts, B3: ≥3.0 pts
  var BAND_B0_MAX = 0.5;
  var BAND_B1_MAX = 1.5;
  var BAND_B2_MAX = 3.0;
  function nowIso(){
    try { return new Date().toISOString(); } catch(e){ return String(Date.now()); }
  }
  function safeJsonParse(s, fallback){
    try { return JSON.parse(s); } catch(e){ return fallback; }
  }
  // Stable stringify (sorted keys) for deterministic cache-keying.
  function stableStringify(x){
    if (x === null) return "null";
    var t = typeof x;
    if (t === "number"){
      if (!isFinite(x)) return "null";
      return String(x);
    }
    if (t === "boolean") return x ? "true" : "false";
    if (t === "string") return JSON.stringify(x);
    if (Array.isArray(x)){
      var outA = [];
      for (var i=0;i<x.length;i++) outA.push(stableStringify(x[i]));
      return "[" + outA.join(",") + "]";
    }
    if (t === "object"){
      var keys = Object.keys(x).sort();
      var parts = [];
      for (var k=0;k<keys.length;k++){
        var key = keys[k];
        parts.push(JSON.stringify(key) + ":" + stableStringify(x[key]));
      }
      return "{" + parts.join(",") + "}";
    }
    return "null";
  }
  // Simple deterministic hash (FNV-1a 32-bit) to avoid backticks/template literals.
  function fnv1a32(str){
    var h = 2166136261;
    for (var i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      // h *= 16777619 with 32-bit overflow
      h = (h + ((h<<1) + (h<<4) + (h<<7) + (h<<8) + (h<<24))) >>> 0;
    }
    // unsigned to hex
    var hex = (h >>> 0).toString(16);
    while (hex.length < 8) hex = "0" + hex;
    return hex;
  }
  // =========================
  // Adapter seam (input only)
  // =========================
  function buildPlaceholderAdapterInput(){
    var juris = getJurisdictionsFromMapDom();
    var obs = {};
    for (var i=0;i<juris.length;i++) obs[juris[i]] = 0;
    return {
      schema: "PB_E9_STATE_MAP_ADAPTER_INPUT_V1",
      observedWinsByState: obs,
      expectedPctByState: {},
      cxtByState: {},
      adapterMeta: { placeholder: true, createdAtISO: nowIso() }
    };
  }
  function getAdapterInput(){
    var x = null;
    try { x = window.PB_E9_STATE_MAP_ADAPTER_INPUT; } catch(e){ x = null; }
    if (!x || typeof x !== "object") return buildPlaceholderAdapterInput();
    // Ensure structural completeness (do not mutate input; create shallow safe copy)
    var out = {
      schema: "PB_E9_STATE_MAP_ADAPTER_INPUT_V1",
      observedWinsByState: (x.observedWinsByJurisdiction && typeof x.observedWinsByJurisdiction === "object") ? x.observedWinsByJurisdiction : {},
      expectedPctByState: (x.expectedPctByJurisdiction && typeof x.expectedPctByJurisdiction === "object") ? x.expectedPctByJurisdiction : {},
      cxtByState: (x.cxtByJurisdiction && typeof x.cxtByJurisdiction === "object") ? x.cxtByJurisdiction : {},
      adapterMeta: (x.adapterMeta && typeof x.adapterMeta === "object") ? x.adapterMeta : {}
    };
    return out;
  }
  // =========================
  // Jurisdiction discovery (map DOM only)
  // =========================
  function getJurisdictionsFromMapDom(){
    var out = [];
    var seen = {};
    // Try the known SVG container first (if present)
    var svg = document.querySelector("svg");
    var nodes = svg ? svg.querySelectorAll("[id]") : document.querySelectorAll("[id]");
    for (var i=0;i<nodes.length;i++){
      var id = nodes[i].getAttribute("id");
      if (!id) continue;
      // State/territory abbreviations are 2-letter uppercase in this map pack (per D1S2)
      if (/^[A-Z]{2}$/.test(id)){
        if (!seen[id]){
          seen[id] = true;
          out.push(id);
        }
      }
    }
    out.sort();
    return out;
  }
  // =========================
  // Metrics Generator (StateMapMetricsV1)
  // =========================
  function classifyStatus(relativeIndex){
    if (relativeIndex == null) return "UNKNOWN";
    if (relativeIndex > OVER_INDEX_THRESHOLD) return "OVER";
    if (relativeIndex < UNDER_INDEX_THRESHOLD) return "UNDER";
    return "NEUTRAL";
  }
  function magnitudeBand(deltaPct){
    if (deltaPct == null) return "B0";
    var a = Math.abs(deltaPct);
    if (a < BAND_B0_MAX) return "B0";
    if (a < BAND_B1_MAX) return "B1";
    if (a < BAND_B2_MAX) return "B2";
    return "B3";
  }
  function buildStateMapMetricsV1(input){
    var adapter = input && typeof input === "object" ? input : buildPlaceholderAdapterInput();
    var observedWinsByJurisdiction = adapter.observedWinsByJurisdiction || {};
    var expectedPctByJurisdiction = adapter.expectedPctByJurisdiction || {};
    var cxtByJurisdiction = adapter.cxtByJurisdiction || {};
    // Build canonical jurisdiction set: union(map DOM, observed keys, expected keys)
    var jurisSet = {};
    var juris = getJurisdictionsFromMapDom();
    for (var i=0;i<juris.length;i++) jurisSet[juris[i]] = true;
    Object.keys(observedWinsByJurisdiction).forEach(function(k){ if (/^[A-Z]{2}$/.test(k)) jurisSet[k] = true; });
    Object.keys(expectedPctByJurisdiction).forEach(function(k){ if (/^[A-Z]{2}$/.test(k)) jurisSet[k] = true; });
    var jurisdictions = Object.keys(jurisSet).sort();
    // Total wins across observed
    var totalWins = 0;
    for (var j=0;j<jurisdictions.length;j++){
      var code = jurisdictions[j];
      var v = observedWinsByJurisdiction[code];
      if (typeof v === "number" && isFinite(v) && v > 0) totalWins += v;
    }
    var rows = {};
    var observedPresent = 0;
    var expectedPresent = 0;
    var cxtPresent = 0;
    for (var r=0;r<jurisdictions.length;r++){
      var jur = jurisdictions[r];
      var flags = [];
      var obsCount = observedWinsByJurisdiction.hasOwnProperty(jur) ? observedWinsByJurisdiction[jur] : null;
      if (obsCount == null) flags.push("OBSERVED_MISSING");
      if (typeof obsCount !== "number" || !isFinite(obsCount) || obsCount < 0){
        if (obsCount != null) flags.push("OBSERVED_INVALID");
        obsCount = (typeof obsCount === "number" && isFinite(obsCount) && obsCount >= 0) ? obsCount : 0;
      } else {
        observedPresent += 1;
      }
      var obsPct = null;
      if (totalWins > 0){
        obsPct = (obsCount / totalWins) * 100.0;
      } else {
        flags.push("TOTAL_WINS_ZERO");
        obsPct = 0.0;
      }
      var expPct = expectedPctByJurisdiction.hasOwnProperty(jur) ? expectedPctByJurisdiction[jur] : null;
      if (expPct == null){
        flags.push("EXPECTED_MISSING");
      } else if (typeof expPct !== "number" || !isFinite(expPct) || expPct < 0){
        flags.push("EXPECTED_INVALID");
        expPct = null;
      } else {
        expectedPresent += 1;
      }
      var delta = null;
      var rel = null;
      if (expPct != null){
        delta = obsPct - expPct;
        if (expPct > 0){
          rel = obsPct / expPct;
        } else {
          flags.push("EXPECTED_ZERO");
          rel = null;
        }
      }
      var cxt = cxtByJurisdiction.hasOwnProperty(jur) ? cxtByJurisdiction[jur] : null;
      if (cxt && typeof cxt === "object") cxtPresent += 1;
      // geo
      var svgId = null;
      var el = document.getElementById(jur);
      if (el && el.getAttribute) svgId = jur;
      var st = classifyStatus(rel);
      if (st === "UNKNOWN" && expPct == null) st = "UNKNOWN";
      rows[jur] = {
        jurisdiction: jur,
        observedWinsCount: obsCount,
        observedPct: (obsPct == null ? null : (Math.round(obsPct * 1000) / 1000)), // 0.001 precision
        expectedPct: (expPct == null ? null : (Math.round(expPct * 1000) / 1000)),
        deltaPct: (delta == null ? null : (Math.round(delta * 1000) / 1000)),
        relativeIndex: (rel == null ? null : (Math.round(rel * 10000) / 10000)),
        status: st,
        deltaMagnitudeBand: magnitudeBand(delta),
        geo: { svgId: svgId },
        dataQualityFlags: flags
      };
    }
    // coverage summary
    var jc = jurisdictions.length;
    var covObs = jc ? (observedPresent / jc) : 0;
    var covExp = jc ? (expectedPresent / jc) : 0;
    var covCxt = jc ? (cxtPresent / jc) : 0;
    var out = {
      schema: PB_E9_STATE_MAP_METRICS_SCHEMA_V1,
      generatedAtISO: nowIso(),
      summary: {
        totalWins: totalWins,
        jurisdictionCount: jc,
        coverage: {
          observed: { count: observedPresent, pct: Math.round(covObs * 1000) / 10 },
          expected: { count: expectedPresent, pct: Math.round(covExp * 1000) / 10 },
          cxt: { count: cxtPresent, pct: Math.round(covCxt * 1000) / 10 }
        }
      },
      jurisdictions: rows
    };
    return out;
  }
  // =========================
  // Cache Envelope (Map-only)
  // =========================
  function computeStateMapCacheKeyV1(adapterInput){
    var meta = (adapterInput && adapterInput.adapterMeta) ? adapterInput.adapterMeta : {};
    var base = {
      schema: "PB_E9_STATE_MAP_CACHE_KEY_INPUT_V1",
      expectedKeys: Object.keys((adapterInput && adapterInput.expectedPctByJurisdiction) ? adapterInput.expectedPctByJurisdiction : {}).sort(),
      observedKeys: Object.keys((adapterInput && adapterInput.observedWinsByJurisdiction) ? adapterInput.observedWinsByJurisdiction : {}).sort(),
      meta: meta
    };
    var s = stableStringify(base);
    return "V1_" + fnv1a32(s);
  }
  function loadStateMapCacheV1(){
    var raw = null;
    try { raw = localStorage.getItem(PB_E9_STATE_MAP_CACHE_KEY_V1); } catch(e){ raw = null; }
    if (!raw) return null;
    var obj = safeJsonParse(raw, null);
    if (!obj || typeof obj !== "object") return null;
    if (obj.schema !== PB_E9_STATE_MAP_CACHE_SCHEMA_V1) return null;
    return obj;
  }
  function saveStateMapCacheV1(payload){
    if (!payload || typeof payload !== "object") return false;
    try {
      localStorage.setItem(PB_E9_STATE_MAP_CACHE_KEY_V1, JSON.stringify(payload));
      return true;
    } catch(e){
      return false;
    }
  }
  // =========================
  // D2S1 SAFE bootstrap (display-only)
  // =========================
  function bootstrap(){
    // Adapter input is READ-ONLY; metrics are computed display-only.
    var adapter = getAdapterInput();
    var cacheKey = computeStateMapCacheKeyV1(adapter);
    var cached = loadStateMapCacheV1();
    if (cached && cached.cacheKey === cacheKey && cached.metrics && cached.metrics.schema === PB_E9_STATE_MAP_METRICS_SCHEMA_V1){
      // Expose for later stages (read-only convention)
      window.PB_E9_STATE_MAP_METRICS_V1 = cached.metrics;
      window.PB_E9_STATE_MAP_CACHE_META_V1 = { hit: true, cacheKey: cacheKey, loadedAtISO: nowIso() };
      return;
    }
    var metrics = buildStateMapMetricsV1(adapter);
    var envelope = {
      schema: PB_E9_STATE_MAP_CACHE_SCHEMA_V1,
      savedAtISO: nowIso(),
      cacheKey: cacheKey,
      adapterMeta: adapter.adapterMeta || {},
      metrics: metrics
    };
    saveStateMapCacheV1(envelope);
    // Expose for later stages (read-only convention)
    window.PB_E9_STATE_MAP_METRICS_V1 = metrics;
    window.PB_E9_STATE_MAP_CACHE_META_V1 = { hit: false, cacheKey: cacheKey, savedAtISO: envelope.savedAtISO };
  }
  // Run after DOM is ready so geo.svgId can be derived from actual SVG DOM ids
  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", bootstrap);
  } else {
    bootstrap();
  }
  // Public exports (for later deliverables, read-only use)
  window.buildStateMapMetricsV1 = buildStateMapMetricsV1;
  window.computeStateMapCacheKeyV1 = computeStateMapCacheKeyV1;
  window.loadStateMapCacheV1 = loadStateMapCacheV1;
  window.saveStateMapCacheV1 = saveStateMapCacheV1;
})();
</script>
<!-- Enhancement #9 — USA Mapping | Deliverable 4 (Binning + Coloring + Legend + Counts Labels) [FIXED ORDER] -->
<script id="enh9-d4-heatmap-legend-labels" type="text/javascript">
(function(){
  "use strict";
  function $(id){ return document.getElementById(id); }
  function qsa(sel, root){ return (root || document).querySelectorAll(sel); }
  function isStateCode(x){ return typeof x === "string" && /^[A-Z]{2}$/.test(x); }
  var SVG_ID = "e9UsaSvg";
  var LEGEND_ID = "e9MapLegend";
  var LAYER_RADIO_NAME = "e9MapLayer";
  var CXT_TOGGLE_ID = "e9MapToggleCxt";
  var SELECT_ID = "e9MapJurisdictionSelect";
  var CLEAR_ID = "e9MapClearSelectionBtn";
  // Palette (deterministic)
  var WINNER_SHARE_COLORS = ["#93c5fd","#3b82f6","#22c55e","#f97316","#ef4444"];
  var UNDER_COLORS = ["#fff1f2","#fecdd3","#fda4af","#fb7185","#e11d48"]; // low->high
  var OVER_COLORS  = ["#eff6ff","#bfdbfe","#93c5fd","#60a5fa","#1d4ed8"]; // low->high
  var NEUTRAL_COLOR = "#e2e8f0";
  var UNKNOWN_COLOR = "#f1f5f9";
  // Counts label styling
  var LABEL_FONT_FAMILY = "system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif";
  var LABEL_FILL = "#0f172a";
  var LABEL_STROKE = "#ffffff";
  var LABEL_STROKE_W = "1.2";
  var selectedState = null;
  function ensureMetrics(){
    try{
      if (window.PB_E9_STATE_MAP_METRICS_V1 && window.PB_E9_STATE_MAP_METRICS_V1.jurisdictions) return window.PB_E9_STATE_MAP_METRICS_V1;
      if (typeof window.buildStateMapMetricsV1 === "function"){
        var inp = null;
        try { inp = window.PB_E9_STATE_MAP_ADAPTER_INPUT; } catch(e){ inp = null; }
        var m = window.buildStateMapMetricsV1(inp);
        window.PB_E9_STATE_MAP_METRICS_V1 = m;
        return m;
      }
    } catch(e){}
    return null;
  }
  function getLayer(){
    var radios = qsa('input[type="radio"][name="' + LAYER_RADIO_NAME + '"]');
    for (var i=0;i<radios.length;i++){
      if (radios[i].checked) return String(radios[i].value || "winnerShare");
    }
    return "winnerShare";
  }
  function cxtEnabled(){
    var cb = $(CXT_TOGGLE_ID);
    return !!(cb && cb.checked);
  }
  function getRow(stateCode){
    var m = ensureMetrics();
    if (!m || !m.jurisdictions) return null;
    return m.jurisdictions[stateCode] || null;
  }
  function getAllStateCodes(){
    var svg = $(SVG_ID);
    if (!svg) return [];
    var nodes = qsa("[id]", svg);
    var out = [];
    var seen = {};
    for (var i=0;i<nodes.length;i++){
      var id = nodes[i].getAttribute("id");
      if (id && /^[A-Z]{2}$/.test(id) && !seen[id]){
        seen[id] = true;
        out.push(id);
      }
    }
    out.sort();
    return out;
  }
  // Apply fill robustly (handles <g id="WY"> wrappers)
  function applyFillToState(code, fill){
    var root = $(code);
    if (!root) return;
    try{
      // Force fill with important where possible
      if (root.style && root.style.setProperty){
        root.style.setProperty("fill", fill, "important");
      } else if (root.style){
        root.style.fill = fill;
      } else {
        root.setAttribute("fill", fill);
      }
    } catch(e){}
    // Also apply to common descendants
    var kids = root.querySelectorAll ? root.querySelectorAll("path,polygon,rect,circle,ellipse") : [];
    for (var i=0;i<kids.length;i++){
      try{
        if (kids[i].style && kids[i].style.setProperty){
          kids[i].style.setProperty("fill", fill, "important");
        } else if (kids[i].style){
          kids[i].style.fill = fill;
        } else {
          kids[i].setAttribute("fill", fill);
        }
      } catch(e2){}
    }
  }
  // Quantile binning for Winner Share (observedWinsCount), deterministic.
  function computeQuantileCuts(values, bins){
    var v = values.slice().sort(function(a,b){ return a-b; });
    if (!v.length) return [];
    var cuts = [];
    for (var b=1;b<bins;b++){
      var pos = (v.length - 1) * (b / bins);
      var lo = Math.floor(pos);
      var hi = Math.ceil(pos);
      var w = pos - lo;
      var val = (lo === hi) ? v[lo] : (v[lo] * (1-w) + v[hi] * w);
      cuts.push(val);
    }
    return cuts;
  }
  function pickWinnerShareColor(winsCount, cuts){
    // Fixed bins (triad): 0 -> BLUE, 1-2 -> ORANGE, >2 -> RED. No data -> UNKNOWN.
    if (winsCount == null || typeof winsCount !== "number" || !isFinite(winsCount)) return UNKNOWN_COLOR;
    var n = Math.max(0, Math.round(winsCount));
    if (n === 0) return WINNER_SHARE_COLORS[1];        // blue
    if (n <= 2) return WINNER_SHARE_COLORS[3];         // orange
    return WINNER_SHARE_COLORS[4];                     // red
  }
  function pickDeltaColor(row){
    if (!row) return UNKNOWN_COLOR;
    if (row.status === "UNKNOWN" || row.expectedPct == null) return UNKNOWN_COLOR;
    var band = row.deltaMagnitudeBand || "B0";
    var magIndex = 0; // 0..4
    if (band === "B0") magIndex = 0;
    else if (band === "B1") magIndex = 1;
    else if (band === "B2") magIndex = 2;
    else magIndex = 3;
    if (row.deltaPct != null && typeof row.deltaPct === "number" && isFinite(row.deltaPct)){
      if (Math.abs(row.deltaPct) >= 5.0) magIndex = 4;
    } else {
      magIndex = 0;
    }
    if (row.status === "UNDER") return UNDER_COLORS[magIndex];
    if (row.status === "OVER") return OVER_COLORS[magIndex];
    return NEUTRAL_COLOR;
  }
  function pickCxtColor(stateCode){
    var input = null;
    try { input = window.PB_E9_STATE_MAP_ADAPTER_INPUT; } catch(e){ input = null; }
    var cxt = (input && input.cxtByJurisdiction && input.cxtByJurisdiction[stateCode]) ? input.cxtByJurisdiction[stateCode] : null;
    if (!cxt || typeof cxt !== "object") return UNKNOWN_COLOR;
    var x = null;
    if (typeof cxt.cxtScore === "number" && isFinite(cxt.cxtScore)) x = cxt.cxtScore;
    else if (typeof cxt.needIndex === "number" && isFinite(cxt.needIndex)) x = cxt.needIndex;
    if (x == null) return "#ccfbf1"; // presence-only hint
    var v = x;
    if (v > 1.0) v = v / 100.0;
    if (v < 0) v = 0;
    if (v > 1) v = 1;
    if (v < 0.33) return "#ccfbf1";
    if (v < 0.66) return "#5eead4";
    return "#14b8a6";
  }
  function renderLegend(layer, useCxt, cuts){
    var el = $(LEGEND_ID);
    if (!el) return;
    var html = "";
    var m0 = ensureMetrics();
    var tw0 = (m0 && m0.summary && typeof m0.summary.totalWins === "number") ? m0.summary.totalWins : 0;
    if (useCxt){
      html += "<div style='font-weight:800;margin-bottom:6px;'>CXT Overlay</div>";
      html += "<div style='font-size:12px;color:#475569;margin-bottom:8px;'>CXT colors reflect available contextual signals (D4 provisional).</div>";
      html += "<div style='display:grid;grid-template-columns: 18px 1fr;row-gap:6px;column-gap:8px;align-items:center;'>";
      html += "<div style='width:18px;height:12px;border-radius:4px;background:#ccfbf1;border:1px solid #e2e8f0;'></div><div style='font-size:12px;'>Low / present</div>";
      html += "<div style='width:18px;height:12px;border-radius:4px;background:#5eead4;border:1px solid #e2e8f0;'></div><div style='font-size:12px;'>Medium</div>";
      html += "<div style='width:18px;height:12px;border-radius:4px;background:#14b8a6;border:1px solid #e2e8f0;'></div><div style='font-size:12px;'>High</div>";
      html += "<div style='width:18px;height:12px;border-radius:4px;background:" + UNKNOWN_COLOR + ";border:1px solid #e2e8f0;'></div><div style='font-size:12px;'>No CXT data</div>";
      html += "</div>";
      el.innerHTML = html;
      return;
    }
    if (layer === "deltaExpected"){
      html += "<div style='font-weight:800;margin-bottom:6px;'>Delta vs Expected</div>";
      html += "<div style='font-size:12px;color:#475569;margin-bottom:8px;'>Colors reflect under/over relative to expected share.</div>";
      html += "<div style='display:grid;grid-template-columns: 18px 1fr;row-gap:6px;column-gap:8px;align-items:center;'>";
      html += "<div style='width:18px;height:12px;border-radius:4px;background:" + UNDER_COLORS[4] + ";border:1px solid #e2e8f0;'></div><div style='font-size:12px;'>UNDER (high)</div>";
      html += "<div style='width:18px;height:12px;border-radius:4px;background:" + UNDER_COLORS[2] + ";border:1px solid #e2e8f0;'></div><div style='font-size:12px;'>UNDER (med)</div>";
      html += "<div style='width:18px;height:12px;border-radius:4px;background:" + UNDER_COLORS[0] + ";border:1px solid #e2e8f0;'></div><div style='font-size:12px;'>UNDER (near)</div>";
      html += "<div style='width:18px;height:12px;border-radius:4px;background:" + NEUTRAL_COLOR + ";border:1px solid #e2e8f0;'></div><div style='font-size:12px;'>NEUTRAL</div>";
      html += "<div style='width:18px;height:12px;border-radius:4px;background:" + OVER_COLORS[0] + ";border:1px solid #e2e8f0;'></div><div style='font-size:12px;'>OVER (near)</div>";
      html += "<div style='width:18px;height:12px;border-radius:4px;background:" + OVER_COLORS[2] + ";border:1px solid #e2e8f0;'></div><div style='font-size:12px;'>OVER (med)</div>";
      html += "<div style='width:18px;height:12px;border-radius:4px;background:" + OVER_COLORS[4] + ";border:1px solid #e2e8f0;'></div><div style='font-size:12px;'>OVER (high)</div>";
      html += "<div style='width:18px;height:12px;border-radius:4px;background:" + UNKNOWN_COLOR + ";border:1px solid #e2e8f0;'></div><div style='font-size:12px;'>UNKNOWN / no expected</div>";
      html += "</div>";
      el.innerHTML = html;
      return;
    }
    // Winner Share
    html += "<div style='font-weight:800;margin-bottom:6px;'>Winner Share</div>";
    html += "<div style='font-size:12px;color:#475569;margin-bottom:8px;'>Fixed bins across observed wins (count): 0, 1–2, >2 (D4)." + (tw0===0 ? "<br><b>No observed wins loaded</b> (adapter not finding Enh#3 dataset)." : "") + "</div>";
    html += "<div style='display:grid;grid-template-columns: 18px 1fr;row-gap:6px;column-gap:8px;align-items:center;'>";
        // Fixed bins legend for Winner Share (observed wins count)
    html += "<div style='width:18px;height:12px;border-radius:4px;background:" + WINNER_SHARE_COLORS[1] + ";border:1px solid #e2e8f0;'></div><div style='font-size:12px;'>0</div>";
    html += "<div style='width:18px;height:12px;border-radius:4px;background:" + WINNER_SHARE_COLORS[3] + ";border:1px solid #e2e8f0;'></div><div style='font-size:12px;'>1 – 2</div>";
    html += "<div style='width:18px;height:12px;border-radius:4px;background:" + WINNER_SHARE_COLORS[4] + ";border:1px solid #e2e8f0;'></div><div style='font-size:12px;'>> 2</div>";
    html += "<div style='width:18px;height:12px;border-radius:4px;background:" + UNKNOWN_COLOR + ";border:1px solid #e2e8f0;'></div><div style='font-size:12px;'>No data</div>";
    html += "</div>";
    el.innerHTML = html;
  }
  // Labels layer: print observed wins count in each state centroid (bbox center)
  function renderAbbrevLayer(){
    var svg = $(SVG_ID);
    if (!svg) return;
    var existing = svg.querySelector("#enh9AbbrevLayer");
    if (existing){
      updateAbbrev(existing);
      return;
    }
    var g = document.createElementNS("http://www.w3.org/2000/svg", "g");
    g.setAttribute("id", "enh9AbbrevLayer");
    g.setAttribute("pointer-events", "none");
    svg.appendChild(g);
    updateAbbrev(g);
  }
  function updateAbbrev(g){
    var codes = getAllStateCodes();
    var msum = ensureMetrics();
    var totalWins = (msum && msum.summary && typeof msum.summary.totalWins === "number") ? msum.summary.totalWins : 0;
    var existingById = {};
    var texts = g.querySelectorAll("text[id]");
    for (var i=0;i<texts.length;i++){
      existingById[texts[i].getAttribute("id")] = texts[i];
    }
    if (!useCxt && totalWins === 0){
      // No observed data loaded; keep map in UNKNOWN state to avoid misleading full-blue render.
      for (var z=0; z<codes.length; z++){
        var c0 = codes[z];
        if (selectedState && c0 === selectedState) continue;
        applyFillToState(c0, UNKNOWN_COLOR);
      }
      renderLegend(layer, useCxt, cuts);
      renderAbbrevLayer();
      return;
    }
    for (var j=0;j<codes.length;j++){
      var code = codes[j];
      var row = getRow(code);
      var count = row && typeof row.observedWinsCount === "number" && isFinite(row.observedWinsCount) ? row.observedWinsCount : 0;
      var stateEl = $(code);
      if (!stateEl || !stateEl.getBBox) continue;
      var bbox = null;
      try { bbox = stateEl.getBBox(); } catch(e){ bbox = null; }
      if (!bbox) continue;
      var cx = bbox.x + (bbox.width/2);
      var cy = bbox.y + (bbox.height/2);
      var tid = "enh9Abbrev_" + code;
      var t = existingById[tid];
      if (!t){
        t = document.createElementNS("http://www.w3.org/2000/svg", "text");
        t.setAttribute("id", tid);
        t.setAttribute("text-anchor", "middle");
        t.setAttribute("dominant-baseline", "central");
        t.setAttribute("font-family", LABEL_FONT_FAMILY);
        t.setAttribute("font-weight", "800");
        t.setAttribute("fill", LABEL_FILL);
        t.setAttribute("stroke", LABEL_STROKE);
        t.setAttribute("stroke-width", LABEL_STROKE_W);
        t.setAttribute("paint-order", "stroke");
        t.setAttribute("font-size", "7");
        g.appendChild(t);
        existingById[tid] = t;
      }
      // show abbreviation; if count > 0 show "AK (3)" style for quick feedback
      var textVal = code;
      if (count && count > 0) textVal = code + " (" + String(Math.round(count)) + ")";
      t.setAttribute("x", String(cx));
      t.setAttribute("y", String(cy));
      t.textContent = textVal;
    }
  }
  function applyHeatmap(){
    var svg = $(SVG_ID);
    if (!svg) return;
    var layer = getLayer();
    var useCxt = cxtEnabled();
    var codes = getAllStateCodes();
    var msum = ensureMetrics();
    var totalWins = (msum && msum.summary && typeof msum.summary.totalWins === "number") ? msum.summary.totalWins : 0;
    var cuts = [];
    if (!useCxt && totalWins === 0){
      // No observed data loaded; keep map in UNKNOWN state to avoid misleading full-blue render.
      for (var z=0; z<codes.length; z++){
        var c0 = codes[z];
        if (selectedState && c0 === selectedState) continue;
        applyFillToState(c0, UNKNOWN_COLOR);
      }
      renderLegend(layer, useCxt, cuts);
      renderAbbrevLayer();
      return;
    }
    for (var j=0;j<codes.length;j++){
      var code = codes[j];
      // Preserve baseline selection highlight by not overriding selected state's fill.
      if (selectedState && code === selectedState) continue;
      var row2 = getRow(code);
      var fill = UNKNOWN_COLOR;
      if (useCxt){
        fill = pickCxtColor(code);
      } else if (layer === "deltaExpected"){
        fill = pickDeltaColor(row2);
      } else {
        fill = pickWinnerShareColor(row2 ? row2.observedWinsCount : null, cuts);
      }
      applyFillToState(code, fill);
    }
    renderLegend(layer, useCxt, cuts);
    renderAbbrevLayer();
  }
  function trackSelection(){
    var sel = $(SELECT_ID);
    if (sel){
      sel.addEventListener("change", function(){
        var v = (sel.value || "").toUpperCase();
        if (isStateCode(v)) { selectedState = v; }
      });
    }
    var svg = $(SVG_ID);
    if (svg){
      svg.addEventListener("click", function(evt){
        var t = evt.target;
        var node = t;
        var code = null;
        // Walk up to find state wrapper id (many states are <g id="XX"> with child paths)
        for (var i=0; i<8 && node; i++){
          try{
            var id = node.getAttribute ? node.getAttribute("id") : null;
            if (isStateCode(id)){
              code = id;
              break;
            }
          } catch(e){}
          node = node.parentNode;
        }
        if (code) selectedState = code;
      }, true);
    }
    var clear = $(CLEAR_ID);
    if (clear){
      clear.addEventListener("click", function(){
        selectedState = null;
        applyHeatmap();
      });
    }
  }
  function bindControls(){
    var radios = qsa('input[type="radio"][name="' + LAYER_RADIO_NAME + '"]');
    for (var i=0;i<radios.length;i++){
      radios[i].addEventListener("change", function(){ applyHeatmap(); });
    }
    var cb = $(CXT_TOGGLE_ID);
    if (cb){
      cb.addEventListener("change", function(){ applyHeatmap(); });
    }
  }
  // Wait until D2 adapter + D2 metrics are ready (prevents placeholder-zero bins)
  function waitForReady(attempt){
    var okAdapter = false;
    var okMetrics = false;
    try{
      okAdapter = !!(window.PB_E9_STATE_MAP_ADAPTER_INPUT && window.PB_E9_STATE_MAP_ADAPTER_INPUT.observedWinsByJurisdiction);
    } catch(e){ okAdapter = false; }
    try{
      var m = window.PB_E9_STATE_MAP_METRICS_V1;
      okMetrics = !!(m && m.jurisdictions && m.summary);
    } catch(e2){ okMetrics = false; }
    if (okAdapter && okMetrics){
      applyHeatmap();
      return;
    }
    // If metrics isn't set yet but builder exists and adapter exists, build it now
    try{
      if (okAdapter && typeof window.buildStateMapMetricsV1 === "function"){
        var mm = window.buildStateMapMetricsV1(window.PB_E9_STATE_MAP_ADAPTER_INPUT);
        window.PB_E9_STATE_MAP_METRICS_V1 = mm;
        applyHeatmap();
        return;
      }
    } catch(e3){}
    if (attempt >= 30) {
      // last attempt: still render, but may show placeholder
      applyHeatmap();
      return;
    }
    setTimeout(function(){ waitForReady(attempt + 1); }, 50);
  }
  window.PB_E9_APPLY_HEATMAP = function(){ try{ applyHeatmap(); } catch(e){} };
  function init(){
    bindControls();
    trackSelection();
    waitForReady(0);
  }
  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }
})();
</script>
<!-- Enhancement #9 — USA Mapping | Centering Pass (SAFE) -->
<style id="enh9-map-centering-style">
#e9MapCanvas{
  display:flex;
  align-items:center;
  justify-content:center;
}
#e9MapCanvas svg{
  display:block;
  margin:0 auto;
}
</style>
<script id="enh9-map-centering" type="text/javascript">
(function(){
  "use strict";
  function unionBBox(a, b){
    if (!a) return b;
    if (!b) return a;
    var x1 = Math.min(a.x, b.x);
    var y1 = Math.min(a.y, b.y);
    var x2 = Math.max(a.x + a.width, b.x + b.width);
    var y2 = Math.max(a.y + a.height, b.y + b.height);
    return { x:x1, y:y1, width:(x2 - x1), height:(y2 - y1) };
  }
  function safeGetBBox(el){
    try{ return el.getBBox(); } catch(e){ return null; }
  }
  function apply(){
    try{
      var svg = document.getElementById("e9UsaSvg");
      if (!svg) return;
      // Move PR/VI boxes to Gulf area to avoid skewing apparent centering.
      var terr = svg.querySelector("#e9Territories");
      if (terr){
        var pr = terr.querySelector("rect#PR");
        var vi = terr.querySelector("rect#VI");
        var texts = terr.querySelectorAll("text");
        // Use current viewBox as a stable reference frame.
        var vb = (svg.getAttribute("viewBox") || "").split(" ");
        if (vb.length === 4){
          var vbX = parseFloat(vb[0]) || 0;
          var vbY = parseFloat(vb[1]) || 0;
          var vbW = parseFloat(vb[2]) || 1000;
          var vbH = parseFloat(vb[3]) || 600;
          var baseX = vbX + (vbW * 0.48);
          var baseY = vbY + (vbH * 0.82);
          if (pr){
            pr.setAttribute("x", String(baseX));
            pr.setAttribute("y", String(baseY));
          }
          if (vi){
            vi.setAttribute("x", String(baseX + 44));
            vi.setAttribute("y", String(baseY));
          }
          if (texts && texts.length >= 2){
            if (pr){
              texts[0].setAttribute("x", String(baseX + 16));
              texts[0].setAttribute("y", String(baseY + 14));
            }
            if (vi){
              texts[1].setAttribute("x", String(baseX + 60));
              texts[1].setAttribute("y", String(baseY + 14));
            }
          }
        }
      }
      // Compute tight bounds for all geometry (paths + rects), then set viewBox with padding.
      var nodes = svg.querySelectorAll("path, rect");
      var bbox = null;
      for (var i=0;i<nodes.length;i++){
        var b = safeGetBBox(nodes[i]);
        if (!b) continue;
        if (!isFinite(b.x) || !isFinite(b.y) || !isFinite(b.width) || !isFinite(b.height)) continue;
        if (b.width <= 0 || b.height <= 0) continue;
        bbox = unionBBox(bbox, b);
      }
      if (!bbox) return;
      var pad = Math.max(10, Math.min(30, bbox.width * 0.02));
      var vb2 = (bbox.x - pad) + " " + (bbox.y - pad) + " " + (bbox.width + pad*2) + " " + (bbox.height + pad*2);
      svg.setAttribute("viewBox", vb2);
    } catch(e){}
  }
  function kick(){
    setTimeout(apply, 50);
    setTimeout(apply, 250);
  }
  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", kick);
  } else {
    kick();
  }
})();
</script>
<!-- Enhancement #9 — USA Mapping | Inline State Details (Legend Panel) -->
<style id="enh9-inline-state-details-style">
/* Suppress floating toast; details are rendered inline under the legend. */
#enh9MapToast{ display:none !important; }
/* Inline details panel */
#e9MapInlineDetails{
  margin-top:14px;
  padding:14px 14px 12px 14px;
  border:1px solid rgba(0,0,0,0.08);
  border-radius:14px;
  background:#ffffff;
  box-shadow:0 8px 24px rgba(0,0,0,0.06);
}
#e9MapInlineDetails .hdr{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:10px;
}
#e9MapInlineDetails .ttl{
  font-weight:800;
  font-size:16px;
}
#e9MapInlineDetails .sub{
  font-size:12px;
  opacity:0.7;
}
#e9MapInlineDetails .pill{
  display:inline-block;
  padding:4px 10px;
  border-radius:999px;
  font-weight:800;
  font-size:12px;
  line-height:1;
  border:1px solid rgba(0,0,0,0.08);
}
#e9MapInlineDetails .grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
#e9MapInlineDetails .card{
  border:1px solid rgba(0,0,0,0.08);
  border-radius:12px;
  padding:10px;
  background:#fff;
}
#e9MapInlineDetails .k{
  font-size:12px;
  opacity:0.75;
}
#e9MapInlineDetails .v{
  font-weight:800;
  margin-top:4px;
}
#e9MapInlineDetails .dq{
  margin-top:10px;
  font-size:12px;
  opacity:0.8;
}
#e9MapInlineDetails .dq ul{
  margin:6px 0 0 18px;
  padding:0;
}
</style>
<script id="enh9-inline-state-details" type="text/javascript">
(function(){
  "use strict";
  function $(id){ return document.getElementById(id); }
  function isStateCode(x){ return typeof x === "string" && /^[A-Z]{2}$/.test(x); }
  function nowIso(){ try { return new Date().toISOString(); } catch(e){ return String(Date.now()); } }
  // Non-participating Powerball states (no state lottery): AL, AK, HI, NV, UT.
  var NON_PB = { AL:true, AK:true, HI:true, NV:true, UT:true };
  function isParticipating(code){
    if (!isStateCode(code)) return true;
    if (code === "PR" || code === "VI") return true;
    return !NON_PB[code];
  }
  function ensureMetrics(){
    try{
      if (window.PB_E9_STATE_MAP_METRICS_V1 && window.PB_E9_STATE_MAP_METRICS_V1.jurisdictions){
        return window.PB_E9_STATE_MAP_METRICS_V1;
      }
      if (typeof window.buildStateMapMetricsV1 === "function"){
        var inp = null;
        try { inp = window.PB_E9_STATE_MAP_ADAPTER_INPUT; } catch(e){ inp = null; }
        var m = window.buildStateMapMetricsV1(inp);
        window.PB_E9_STATE_MAP_METRICS_V1 = m;
        return m;
      }
    } catch(e){}
    return null;
  }
  function getRow(code){
    var m = ensureMetrics();
    if (!m || !m.jurisdictions) return null;
    return m.jurisdictions[code] || null;
  }
  function fmtPct(x){
    if (x == null || typeof x !== "number" || !isFinite(x)) return "—";
    return (Math.round(x * 1000) / 1000).toFixed(3) + "%";
  }
  function fmtPP(x){
    if (x == null || typeof x !== "number" || !isFinite(x)) return "—";
    return (Math.round(x * 1000) / 1000).toFixed(3) + " pts";
  }
  function fmtNum(x){
    if (x == null || typeof x !== "number" || !isFinite(x)) return "—";
    return String(Math.round(x));
  }
  function fmtIndex(x){
    if (x == null || typeof x !== "number" || !isFinite(x)) return "—";
    return (Math.round(x * 10000) / 10000).toFixed(4);
  }
  function statusPill(row){
    if (!row || !row.status) return { label:"UNKNOWN", tone:"muted" };
    var s = row.status;
    if (s === "UNKNOWN") return { label:"UNKNOWN", tone:"muted" };
    var band = row.deltaMagnitudeBand || "B0";
    if (s === "OVER"){
      if (band === "B3") return { label:"OVER (HIGH)", tone:"over" };
      if (band === "B2") return { label:"OVER (MED)", tone:"over" };
      if (band === "B1") return { label:"OVER (LOW)", tone:"over" };
      return { label:"OVER (NEAR)", tone:"over" };
    }
    if (s === "UNDER"){
      if (band === "B3") return { label:"UNDER (HIGH)", tone:"under" };
      if (band === "B2") return { label:"UNDER (MED)", tone:"under" };
      if (band === "B1") return { label:"UNDER (LOW)", tone:"under" };
      return { label:"UNDER (NEAR)", tone:"under" };
    }
    return { label:"NEUTRAL", tone:"neutral" };
  }
  function pillStyle(tone){
    if (tone === "over") return "background:rgba(34,197,94,0.15);color:#14532d;border-color:rgba(34,197,94,0.35);";
    if (tone === "under") return "background:rgba(239,68,68,0.14);color:#7f1d1d;border-color:rgba(239,68,68,0.35);";
    if (tone === "neutral") return "background:rgba(59,130,246,0.12);color:#1e3a8a;border-color:rgba(59,130,246,0.30);";
    return "background:rgba(148,163,184,0.20);color:#0f172a;border-color:rgba(148,163,184,0.35);";
  }
  function renderPlaceholder(){
    return "<div class='hdr'><div><div class='ttl'>State Details</div><div class='sub'>Click a state to view details.</div></div></div>";
  }
  function renderRow(code, row){
    var pill = statusPill(row);
    var dq = (row && row.dataQualityFlags && row.dataQualityFlags.length) ? row.dataQualityFlags : [];
    // Scoring impact label (only shown when SRES is enabled for the last run). If no scoring impact, leave blank.
    var impactLine = "";
    try {
      var m = window.PB_E9_LAST_RUN_MANIFEST_V1;
      var mods = m && m.enabledModules ? m.enabledModules : (m && m.modulesEnabled ? m.modulesEnabled : null);
      if (Array.isArray(mods) && mods.indexOf("SRES") !== -1){
        impactLine = "Scoring enabled (SRES).";
      }
    } catch(_){ impactLine = ""; }
    var html = "";
    html += "<div class='hdr'>";
    html += "<div><div class='ttl'>State: " + code + "</div>" + (impactLine ? ("<div class='sub'>" + impactLine + "</div>") : "") + "</div>";
    html += "<div class='pill' style='" + pillStyle(pill.tone) + "'>" + pill.label + "</div>";
    html += "</div>";
    html += "<div class='grid'>";
    html += "<div class='card'><div class='k'>Observed wins</div><div class='v'>" + fmtNum(row ? row.observedWinsCount : null) + "</div>";
    html += "<div class='k' style='margin-top:6px;'>Observed share</div><div class='v'>" + fmtPct(row ? row.observedPct : null) + "</div></div>";
    html += "<div class='card'><div class='k'>Expected share</div><div class='v'>" + fmtPct(row ? row.expectedPct : null) + "</div>";
    html += "<div class='k' style='margin-top:6px;'>Delta (pp)</div><div class='v'>" + fmtPP(row ? row.deltaPct : null) + "</div>";
    html += "<div class='k' style='margin-top:6px;'>Relative index</div><div class='v'>" + fmtIndex(row ? row.relativeIndex : null) + "</div></div>";
    html += "</div>";
    html += "<div class='dq'><b>Data Quality Flags</b>";
    if (!dq.length){
      html += "<div style='margin-top:6px;'>None</div>";
    } else {
      html += "<ul>";
      for (var i=0;i<dq.length;i++){
        html += "<li>" + String(dq[i]) + "</li>";
      }
      html += "</ul>";
    }
    html += "<div class='sub' style='margin-top:10px;'>Metrics generated at: " + nowIso() + "</div>";
    html += "</div>";
    return html;
  }
  function ensurePanel(){
    var legend = document.querySelector(".e9map-legend");
    if (!legend) return null;
    var panel = $("e9MapInlineDetails");
    if (panel) return panel;
    panel = document.createElement("div");
    panel.id = "e9MapInlineDetails";
    panel.innerHTML = renderPlaceholder();
    legend.appendChild(panel);
    return panel;
  }
  function setPanel(code){
    var panel = ensurePanel();
    if (!panel) return;
    if (!isStateCode(code)){
      panel.innerHTML = renderPlaceholder();
      return;
    }
    var row = getRow(code);
    panel.innerHTML = renderRow(code, row);
  }
  function bind(){
    ensurePanel();
    // Participation gate (Powerball states only).
    var NON_PB = { AL:true, AK:true, HI:true, NV:true, UT:true };
    function isStateCode(x){ return typeof x === "string" && /^[A-Z]{2}$/.test(x); }
    function isParticipating(code){
      if (!isStateCode(code)) return true;
      if (code === "PR" || code === "VI") return true;
      return !NON_PB[code];
    }
    // Bind state clicks
    var svg = document.getElementById("e9UsaSvg") || document.querySelector("svg");
    if (svg){
      var nodes = svg.querySelectorAll("[id]");
      for (var i=0;i<nodes.length;i++){
        var id = nodes[i].getAttribute("id");
        if (!isStateCode(id)) continue;
        nodes[i].addEventListener("click", (function(code){
          return function(){
            if (!isParticipating(code)) return; // disabled state
            setPanel(code);
          };
        })(id));
      }
    }
    // Bind dropdown
    var sel = $("e9MapJurisdictionSelect");
    if (sel){
      sel.addEventListener("change", function(){
        var v = sel.value;
        if (isStateCode(v) && isParticipating(v)) setPanel(v);
      });
    }
    // Bind clear
    var clr = $("e9MapClearSelectionBtn");
    if (clr){
      clr.addEventListener("click", function(){ setPanel(null); });
    }
  }
  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", bind);
  } else {
    bind();
  }
})();
</script>
<!-- Enhancement #9 — USA Mapping | State Abbreviation Labels (SAFE) -->
<style id="enh9-state-abbrev-labels-style">
/* SVG state abbreviation labels */
#e9UsaSvg .e9StateLabel{
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  font-weight: 800;
  font-size: 10px;
  fill: rgba(15, 23, 42, 0.85);
  paint-order: stroke;
  stroke: rgba(255, 255, 255, 0.9);
  stroke-width: 2.5px;
  pointer-events: none;
  user-select: none;
}
@media (max-width: 1100px){
  #e9UsaSvg .e9StateLabel{ font-size: 9px; }
}
</style>
<script id="enh9-state-abbrev-labels" type="text/javascript">
(function(){
  "use strict";
  function isStateCode(x){
    return typeof x === "string" && /^[A-Z]{2}$/.test(x) && x !== "PR" && x !== "VI";
  }
  function safeGetBBox(el){
    try { return el.getBBox(); } catch(e){ return null; }
  }
  function ensureLayer(svg){
    var layer = svg.querySelector("#e9StateAbbrevLabels");
    if (layer) return layer;
    layer = document.createElementNS("http://www.w3.org/2000/svg", "g");
    layer.setAttribute("id", "e9StateAbbrevLabels");
    layer.setAttribute("pointer-events", "none");
    // Insert near end so labels sit above fills/borders
    svg.appendChild(layer);
    return layer;
  }
  function clearLayer(layer){
    while (layer.firstChild) layer.removeChild(layer.firstChild);
  }
  function addLabel(layer, code, x, y){
    var t = document.createElementNS("http://www.w3.org/2000/svg", "text");
    t.setAttribute("class", "e9StateLabel");
    t.setAttribute("text-anchor", "middle");
    t.setAttribute("dominant-baseline", "middle");
    t.setAttribute("x", String(x));
    t.setAttribute("y", String(y));
    t.textContent = code;
    layer.appendChild(t);
  }
  function build(){
    try{
      var svg = document.getElementById("e9UsaSvg");
      if (!svg) return;
      var layer = ensureLayer(svg);
      clearLayer(layer);
      // Label the main state paths by id (2-letter codes)
      var nodes = svg.querySelectorAll("path[id], polygon[id], rect[id]");
      for (var i=0;i<nodes.length;i++){
        var el = nodes[i];
        var id = el.getAttribute("id");
        if (!isStateCode(id)) continue;
        var b = safeGetBBox(el);
        if (!b) continue;
        // Skip tiny boxes (very small states) to avoid unreadable clutter
        if (b.width < 14 || b.height < 12) continue;
        var cx = b.x + (b.width / 2);
        var cy = b.y + (b.height / 2);
        // Nudge labels slightly upward for states that sit low (helps TX/LA/FL readability)
        if (b.height > 30) cy = cy - 1.5;
        addLabel(layer, id, cx, cy);
      }
    } catch(e){}
  }
  function kick(){
    // Allow map init + centering/viewBox pass to settle first.
    setTimeout(build, 120);
    setTimeout(build, 350);
    setTimeout(build, 800);
  }
  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", kick);
  } else {
    kick();
  }
})();
</script>
<!-- Enhancement #9 — USA Mapping | Inline Detail Tooltips (SAFE) -->
<style id="enh9-inline-tooltips-style">
/* Tooltip affordance inside the inline details panel */
#e9MapInlineDetails .e9TipLabel{
  cursor: help;
  border-bottom: 1px dotted rgba(15,23,42,0.35);
}
</style>
<script id="enh9-inline-tooltips" type="text/javascript">
(function(){
  "use strict";
  function norm(s){
    return String(s || "").replace(/\s+/g, " ").trim().toLowerCase();
  }
  var tipByKey = {
    "observed wins": "Count of jackpot wins attributed to this state in the currently loaded winner dataset.",
    "observed share": "Observed wins divided by total wins across all jurisdictions (percentage of total).",
    "expected share": "Baseline expected share for the state (if provided by the adapter); used for comparison only.",
    "delta (pp)": "Observed share minus expected share, expressed in percentage points (pp).",
    "relative index": "Observed share divided by expected share (ratio). Values above 1.0 indicate over-representation; below 1.0 indicate under-representation.",
    "data quality flags": "Flags indicating missing or incomplete inputs (e.g., missing observed wins, total wins = 0, or expected share not provided)."
  };
  function applyTips(){
    try{
      var panel = document.getElementById("e9MapInlineDetails");
      if (!panel) return;
      // Apply to label cells (.k) in the metric cards
      var ks = panel.querySelectorAll(".k");
      for (var i=0;i<ks.length;i++){
        var el = ks[i];
        var k = norm(el.textContent);
        if (tipByKey[k]){
          el.setAttribute("title", tipByKey[k]);
          if (el.className.indexOf("e9TipLabel") === -1){
            el.className = (el.className ? (el.className + " ") : "") + "e9TipLabel";
          }
        }
      }
      // Apply to Data Quality Flags header if present
      var b = panel.querySelector(".dq b");
      if (b){
        var kb = norm(b.textContent);
        if (tipByKey[kb]){
          b.setAttribute("title", tipByKey[kb]);
          if (b.className.indexOf("e9TipLabel") === -1){
            b.className = (b.className ? (b.className + " ") : "") + "e9TipLabel";
          }
        }
      }
    } catch(e){}
  }
  function bind(){
    applyTips();
    // Re-apply after any inline details update
    var panel = document.getElementById("e9MapInlineDetails");
    if (!panel) return;
    try{
      var mo = new MutationObserver(function(){ applyTips(); });
      mo.observe(panel, { childList:true, subtree:true, characterData:true });
    } catch(e){}
    // Also re-apply on common interaction events
    var svg = document.getElementById("e9UsaSvg");
    if (svg){
      svg.addEventListener("click", function(){ setTimeout(applyTips, 0); }, true);
    }
    var sel = document.getElementById("e9MapJurisdictionSelect");
    if (sel){
      sel.addEventListener("change", function(){ setTimeout(applyTips, 0); }, true);
    }
    var clr = document.getElementById("e9MapClearSelectionBtn");
    if (clr){
      clr.addEventListener("click", function(){ setTimeout(applyTips, 0); }, true);
    }
  }
  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", bind);
  } else {
    bind();
  }
})();
</script>
<!-- Enhancement #9 — USA Mapping | Status Pill Tooltip (SAFE) -->
<style id="enh9-status-pill-tooltip-style">
#e9MapInlineDetails .pill.e9TipLabel{
  cursor: help;
}
</style>
<script id="enh9-status-pill-tooltip" type="text/javascript">
(function(){
  "use strict";
  function applyStatusTip(){
    try{
      var panel = document.getElementById("e9MapInlineDetails");
      if (!panel) return;
      var pill = panel.querySelector(".pill");
      if (!pill) return;
      // Avoid re-applying
      if (pill.getAttribute("data-tip-applied") === "1") return;
      var txt = (pill.textContent || "").toUpperCase();
      var tip = "Status classification comparing observed vs expected share. ";
      if (txt.indexOf("OVER") !== -1){
        tip += "OVER indicates the state has a higher observed share of wins than expected.";
      } else if (txt.indexOf("UNDER") !== -1){
        tip += "UNDER indicates the state has a lower observed share of wins than expected.";
      } else {
        tip += "NEUTRAL indicates observed share is near the expected baseline.";
      }
      if (txt.indexOf("HIGH") !== -1){
        tip += " HIGH reflects a large deviation magnitude.";
      } else if (txt.indexOf("MED") !== -1){
        tip += " MED reflects a moderate deviation magnitude.";
      } else if (txt.indexOf("LOW") !== -1){
        tip += " LOW reflects a small deviation magnitude.";
      }
      pill.setAttribute("title", tip);
      pill.className = pill.className + " e9TipLabel";
      pill.setAttribute("data-tip-applied", "1");
    } catch(e){}
  }
  function bind(){
    applyStatusTip();
    // Re-apply when panel updates
    var panel = document.getElementById("e9MapInlineDetails");
    if (!panel) return;
    try{
      var mo = new MutationObserver(function(){ applyStatusTip(); });
      mo.observe(panel, { childList:true, subtree:true, characterData:true });
    } catch(e){}
  }
  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", bind);
  } else {
    bind();
  }
})();
</script>

<script>
(function(){
  function placeScoring(){
    var scoring = document.getElementById('enh9Panel');
    var usa = document.getElementById('enh9UsaMapCard');
    var analysis = document.getElementById('analysisSection');
    if(!scoring || !usa || !analysis) return;
    // ensure scoring is inside analysis
    if(scoring.parentElement !== analysis){
      analysis.insertBefore(scoring, usa);
    }
    // ensure scoring is placed after analytics cards (Jackpot Data + Analysis Explanations) and immediately before USA map
    // Place it right before USA map (top of requirement), but after the last analytics card if it exists.
    var after = document.getElementById('enh35ExplainabilityCard') || document.getElementById('enh3JackpotHitsCard');
    if(after && after.parentElement === analysis){
      // If scoring is before analytics, move it after analytics but before USA map.
      if(scoring.compareDocumentPosition(after) & Node.DOCUMENT_POSITION_FOLLOWING){
        analysis.insertBefore(scoring, usa);
      }
      // ensure scoring is after 'after' node
      if(after.nextElementSibling !== scoring){
        // move scoring to immediately after 'after', unless that would put it after usa
        var next = after.nextElementSibling;
        // temporarily remove scoring
        scoring.remove();
        // insert after 'after' (before next) but do not pass usa
        if(next === usa){
          analysis.insertBefore(scoring, usa);
        } else {
          analysis.insertBefore(scoring, next);
          // if we inserted after usa by mistake, correct
          if(scoring.compareDocumentPosition(usa) & Node.DOCUMENT_POSITION_FOLLOWING){
            analysis.insertBefore(scoring, usa);
          }
        }
      }
      // finally, ensure scoring is immediately before usa
      if(scoring.nextElementSibling !== usa){
        scoring.remove();
        analysis.insertBefore(scoring, usa);
      }
    } else {
      // fallback: immediately before usa
      if(scoring.nextElementSibling !== usa){
        scoring.remove();
        analysis.insertBefore(scoring, usa);
      }
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', placeScoring);
  } else {
    placeScoring();
  }
})();
</script>

<script>
(function(){
  'use strict';
  function $(id){ return document.getElementById(id); }
  function getLocalTodayMidnight(){
    var d=new Date();
    return new Date(d.getFullYear(), d.getMonth(), d.getDate());
  }
  function isChecked(id){ var el=$(id); return !!(el && el.checked); }
  function countDrawingHistory(){
    var body=$('historyTableBody');
    if(!body) return {nonFamily:0,family:0};
    var rows=body.querySelectorAll('tr');
    var nonFamily=0, family=0;
    rows.forEach(function(tr){
      var txt=(tr.textContent||'').toLowerCase();
      // Count "family numbers" rows separately; exclude them from non-family pool
      if(txt.indexOf('family numbers')!==-1){ family++; return; }
      // Exclude duplicates rows from candidate pool
      if(txt.indexOf('duplicates')!==-1){ return; }
      // Exclude header/empty rows implicitly
      if(txt.trim().length===0) return;
      nonFamily++;
    });
    return {nonFamily:nonFamily,family:family};
  }

  function ensureSlipGateUI(){
    var gb=$('generate-slip');
    if(!gb) return null;

    var holder = gb.parentElement;
    if(!holder) return null;

    // Ensure stable positioning for blocker overlay (no layout shifts)
    if(holder.style.position !== 'relative') holder.style.position = 'relative';

    // Insert an inline message wrapper directly under the Generate button (before save status)
    var wrap = $('slipGateMsgWrap');
    if(!wrap){
      wrap = document.createElement('div');
      wrap.id = 'slipGateMsgWrap';
      wrap.style.marginTop = '8px';
      wrap.style.display = 'none'; // only shown when gating fails
      wrap.style.maxWidth = '520px';

      // Insert immediately after the button so it never overlaps controls
      var next = gb.nextSibling;
      holder.insertBefore(wrap, next);
    }

    var warn = $('slipGateWarning');
    if(!warn){
      warn = document.createElement('div');
      warn.id='slipGateWarning';
      warn.style.padding='8px 10px';
      warn.style.border='1px solid #fecaca';
      warn.style.borderLeft='4px solid #dc2626';
      warn.style.borderRadius='8px';
      warn.style.background='#fff5f5';
      warn.style.color='#7f1d1d';
      warn.style.fontSize='12px';
      warn.style.fontWeight='700';
      warn.style.lineHeight='1.25';
      warn.style.display='block';
      wrap.appendChild(warn);
    }

    var bd = $('slipGateBreakdown');
    if(!bd){
      bd = document.createElement('div');
      bd.id='slipGateBreakdown';
      bd.style.marginTop='6px';
      bd.style.color='#334155';
      bd.style.fontSize='12px';
      bd.style.fontWeight='600';
      bd.style.lineHeight='1.25';
      bd.style.display='block';
      wrap.appendChild(bd);
    }

    var blocker = $('slipGateBlocker');
    if(!blocker){
      blocker = document.createElement('div');
      blocker.id='slipGateBlocker';
      blocker.style.position='absolute';
      blocker.style.background='transparent';
      blocker.style.display='none';
      blocker.style.zIndex='5';
      blocker.style.cursor='not-allowed';
      blocker.style.borderRadius='6px';
      holder.appendChild(blocker);
    }

    return { wrap: wrap, warn: warn, breakdown: bd, blocker: blocker };
  }


  function addInlineBadge(inputId, text){
    var el=$(inputId);
    if(!el) return;
    var label = (el.closest && el.closest('label')) ? el.closest('label') : el.parentElement;
    if(!label) return;
    if(label.querySelector && label.querySelector('.slip-inline-badge')) return;

    var b=document.createElement('span');
    b.className='slip-inline-badge';
    b.textContent=text;
    b.style.marginLeft='6px';
    b.style.padding='1px 6px';
    b.style.border='1px solid #cbd5e1';
    b.style.borderRadius='999px';
    b.style.fontSize='11px';
    b.style.fontWeight='700';
    b.style.color='#334155';
    b.style.background='#f8fafc';
    b.style.whiteSpace='nowrap';
    label.appendChild(b);
  }

  function ensureSlipGateBadges(){
    addInlineBadge('use-family-numbers','Consumes 2 slots');
    addInlineBadge('use-duplicates-game5','Fills 1 slot');
  }

  function safeSlipGateAudit(payload){
    try{
      if(window.MOD && window.MOD.lastAuditLedger && Array.isArray(window.MOD.lastAuditLedger.events)){
        window.MOD.lastAuditLedger.events.push(payload);
        return;
      }
      if(typeof window.appendAuditEvent === 'function'){
        window.appendAuditEvent(payload);
        return;
      }
      if(typeof window.logAuditEvent === 'function'){
        window.logAuditEvent(payload);
        return;
      }
    }catch(_){}
  }


  function computeAndApplySlipGate(){
    try{
      var gb=$('generate-slip');
      if(!gb) return;
      var ui=ensureSlipGateUI();
      var nSel=$('num-games');
      var N = nSel ? parseInt(nSel.value,10) : NaN;
      if(!Number.isFinite(N) || N<=0) N=0;

      var qp4=isChecked('quick-pick-game-4')?1:0;
      var qp5=isChecked('quick-pick-game-5')?1:0;
      var dup5=isChecked('use-duplicates-game5')?1:0;
      var famOn=isChecked('use-family-numbers');

      var counts=countDrawingHistory();
      var famCap = famOn ? 2 : 0;

      // Must have PDF loaded (uses existing global if present; else allow but keep message)
      var pdfOk = (typeof window.pdfFileLoaded !== 'undefined') ? !!window.pdfFileLoaded : true;

      // If family is selected, require at least 2 family rows available
      var familyOk = !famOn || counts.family >= 2;

      var requiredTop = N - (qp4+qp5) - dup5 - famCap;
      if(requiredTop < 0) requiredTop = 0;

      var topOk = counts.nonFamily >= requiredTop;

      var ok = pdfOk && familyOk && topOk;

      // Apply disabled state but do NOT touch click handlers
      gb.disabled = !ok;

      // Update blocker overlay geometry (enables audit logging even when disabled)
      if(ui && ui.blocker){
        var left = gb.offsetLeft;
        var top = gb.offsetTop;
        var w = gb.offsetWidth;
        var h = gb.offsetHeight;
        ui.blocker.style.left = left + 'px';
        ui.blocker.style.top = top + 'px';
        ui.blocker.style.width = w + 'px';
        ui.blocker.style.height = h + 'px';
      }

      if(gb.disabled){
        gb.style.opacity = '0.55';
        gb.style.cursor = 'not-allowed';

        // Capacity breakdown (user-facing)
        var qpTotal = qp4 + qp5;
        var famShown = (famOn && counts.family >= 2) ? 2 : 0;
        var total = counts.nonFamily + qpTotal + dup5 + famShown;

        if(ui && ui.wrap && ui.warn && ui.breakdown){
          ui.wrap.style.display='block';

          // Short, readable warning
          var msg = '';
          if(!pdfOk){
            msg = 'Load the PDF template to enable Generate.';
          }else if(famOn && !familyOk){
            msg = 'Family requires 2 “Family Numbers” rows in Drawing History.';
          }else if(!topOk){
            msg = 'Add more eligible Drawing History rows to satisfy capacity.';
          }else{
            msg = 'Selection does not satisfy slip requirements.';
          }
          ui.warn.textContent = msg;

          ui.breakdown.textContent =
            'Capacity: History=' + counts.nonFamily +
            ', QP=' + qpTotal +
            ', DUP=' + dup5 +
            ', Family=' + famShown +
            ' → Total=' + total + ' / Required=' + N;
        }

        if(ui && ui.blocker){
          ui.blocker.style.display='block';
        }
      }else{
        gb.style.opacity = '1';
        gb.style.cursor = 'pointer';
        if(ui && ui.wrap){
          ui.wrap.style.display='none';
          if(ui.warn) ui.warn.textContent='';
          if(ui.breakdown) ui.breakdown.textContent='';
        }
        if(ui && ui.blocker){
          ui.blocker.style.display='none';
        }
      }
    }catch(e){
      // fail-closed quietly: do nothing
    }
  }

  function bind(){
    // UI-only: inline cues (badges) in the slip options row
    ensureSlipGateBadges();

    // Ensure gate UI exists and bind the blocker overlay once (supports audit while disabled)
    var ui = ensureSlipGateUI();
    if(ui && ui.blocker && !ui.blocker.__slipGateBound){
      ui.blocker.__slipGateBound = true;
      ui.blocker.addEventListener('pointerdown', function(ev){
        try{
          var gb=$('generate-slip');
          if(!gb || !gb.disabled) return;

          var nSel=$('num-games');
          var N = nSel ? parseInt(nSel.value,10) : NaN;
          if(!Number.isFinite(N) || N<=0) N=0;

          var qp4=isChecked('quick-pick-game-4')?1:0;
          var qp5=isChecked('quick-pick-game-5')?1:0;
          var dup5=isChecked('use-duplicates-game5')?1:0;
          var famOn=isChecked('use-family-numbers');

          var counts=countDrawingHistory();
          var pdfOk = (typeof window.pdfFileLoaded !== 'undefined') ? !!window.pdfFileLoaded : true;

          var qpTotal = qp4 + qp5;
          var famShown = (famOn && counts.family >= 2) ? 2 : 0;
          var total = counts.nonFamily + qpTotal + dup5 + famShown;

          safeSlipGateAudit({
            type: 'SlipGateBlocked',
            required: N,
            total: total,
            history: counts.nonFamily,
            qp: qpTotal,
            dup: dup5,
            family: famShown,
            pdfLoaded: pdfOk
          });

          // Refresh messaging immediately (no waiting for interval)
          computeAndApplySlipGate();

          if(ev && ev.preventDefault) ev.preventDefault();
        }catch(_){}
      }, { passive: false });
    }

    // Recompute on relevant interactions
    ['num-games','quick-pick-game-4','quick-pick-game-5','use-duplicates-game5','use-family-numbers'].forEach(function(id){
      var el=$(id);
      if(el){ el.addEventListener('change', computeAndApplySlipGate); el.addEventListener('click', computeAndApplySlipGate); }
    });

    // Recompute when drawing history changes
    var body=$('historyTableBody');
    if(body && window.MutationObserver){
      var mo=new MutationObserver(function(){ computeAndApplySlipGate(); });
      mo.observe(body,{childList:true,subtree:true});
    }

    // Recompute on resize (keeps blocker overlay aligned)
    window.addEventListener('resize', computeAndApplySlipGate);

    // Recompute periodically to override any legacy force-enable logic
    setInterval(computeAndApplySlipGate, 750);

    // Initial
    computeAndApplySlipGate();
  }

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', bind);
  }else{
    bind();
  }
})();
</script>

<script id="enh12-jef-d4-ui" type="text/javascript">
(function(){
  "use strict";

  function $(id){ try { return document.getElementById(id); } catch(e){ return null; } }
  function isObj(x){ return x && typeof x === "object"; }

  function setPill(pill, text, kind){
    if(!pill) return;
    pill.textContent = text;
    // conservative palette aligned to existing vNext styling (no external CSS)
    if(kind === "ok"){
      pill.style.background = "#dcfce7"; // green-100
      pill.style.borderColor = "#86efac"; // green-300
      pill.style.color = "#14532d"; // green-900
    } else if(kind === "warn"){
      pill.style.background = "#ffedd5"; // orange-100
      pill.style.borderColor = "#fdba74"; // orange-300
      pill.style.color = "#7c2d12"; // orange-900
    } else if(kind === "bad"){
      pill.style.background = "#fee2e2"; // red-100
      pill.style.borderColor = "#fca5a5"; // red-300
      pill.style.color = "#7f1d1d"; // red-900
    } else {
      pill.style.background = "#e2e8f0"; // slate-200
      pill.style.borderColor = "#cbd5e1"; // slate-300
      pill.style.color = "#0f172a"; // slate-900
    }
  }

  function stableISO(d){
    try {
      if (!d) return null;
      if (typeof d === "string") return d;
      if (d instanceof Date) return d.toISOString().slice(0,10);
    } catch(e){}
    return null;
  }

  function resolveDrawHistory(){
    // Prefer explicit globals from the powerball.net enhancement, if present.
    try {
      if (isObj(window.PB_POWERBALL_NET_DRAW_HISTORY_V1)) return window.PB_POWERBALL_NET_DRAW_HISTORY_V1;
      if (isObj(window.PB_E9_DRAW_HISTORY_V1)) return window.PB_E9_DRAW_HISTORY_V1;
      if (isObj(window.PB_DRAW_HISTORY_V1)) return window.PB_DRAW_HISTORY_V1;
      if (isObj(window.__pbvNext) && isObj(window.__pbvNext.drawHistory)) return window.__pbvNext.drawHistory;
      // if an e9 module later stores it
      if (isObj(window.__pbvNext) && isObj(window.__pbvNext.e9) && isObj(window.__pbvNext.e9.drawHistory)) return window.__pbvNext.e9.drawHistory;
    } catch(e){}
    return null;
  }

  function resolveMapMetrics(){
    // Enhancement #9 exposes window.PB_E9_STATE_MAP_METRICS_V1 when cache matches adapter key.
    try {
      if (isObj(window.PB_E9_STATE_MAP_METRICS_V1)) return window.PB_E9_STATE_MAP_METRICS_V1;
    } catch(e){}
    return null;
  }

  function resolveE9Modules(){
    try {
      if (isObj(window.__pbvNext) && isObj(window.__pbvNext.e9)) return window.__pbvNext.e9;
    } catch(e){}
    return null;
  }


  function isStateCode(x){ return typeof x === "string" && /^[A-Z]{2}$/.test(x); }
  function isParticipatingState(code){
    // Match Enhancement #9 participation gate (AL, AK, HI, NV, UT are non-participating).
    if (!isStateCode(code)) return false;
    if (code === "PR" || code === "VI") return true;
    return !({ AL:true, AK:true, HI:true, NV:true, UT:true })[code];
  }

  function clearJefMapAnnotation(){
    try{
      var panel = document.getElementById("e9MapInlineDetails");
      if (!panel) return;
      var blk = panel.querySelector("[data-jef-annotation='1']");
      if (blk) blk.remove();
    } catch(e){}
  }

  function applyJefMapHighlight(out){
    // Fail-closed: only highlight when we have a ranked jurisdiction for Event #1.
    try{
      clearJefMapAnnotation();
      if (!out || out.status !== "OK") return;

      var ev = Array.isArray(out.eventForecasts) ? out.eventForecasts : [];
      if (!ev.length) return;

      var e1 = ev[0];
      var j = (Array.isArray(e1.jurisdictions) && e1.jurisdictions.length) ? e1.jurisdictions[0] : null;
      var code = j && j.jurisdiction ? String(j.jurisdiction).toUpperCase() : "";
      if (!isParticipatingState(code)) return;

      // Attempt to highlight by dispatching a click on the existing map element (uses existing selection + inline details).
      var el = document.querySelector('#e9MapCanvas [data-jurisdiction="'+code+'"]') || document.getElementById(code);
      if (!el) return;

      // Trigger selection (existing map handlers are deterministic).
      try { el.dispatchEvent(new MouseEvent("click", { bubbles:true, cancelable:true, view:window })); } catch(_){}

      // After inline details render, append a JEF annotation block.
      setTimeout(function(){
        try{
          var panel = document.getElementById("e9MapInlineDetails");
          if (!panel) return;

          // Build compact, deterministic annotation.
          var when = e1.dateWindow ? (e1.dateWindow.startDate + " → " + e1.dateWindow.endDate + " (preferred: " + e1.dateWindow.preferredDrawDate + ")") : "—";
          var how = "";
          if (Array.isArray(e1.playSets) && e1.playSets.length){
            how = e1.playSets.map(function(ps){
              var nums = Array.isArray(ps.numbers) ? ps.numbers.join(", ") : "";
              var pb = (ps.powerball!==undefined && ps.powerball!==null) ? String(ps.powerball) : "";
              return nums + " | PB " + pb;
            }).join("   |   ");
          } else {
            how = "—";
          }
          var why = "";
          if (Array.isArray(e1.drivers) && e1.drivers.length){
            why = e1.drivers.map(function(d){ return d.phraseText || d.phraseId || ""; }).filter(Boolean).slice(0,6).join(" • ");
          } else {
            why = "—";
          }

          var blk = document.createElement("div");
          blk.setAttribute("data-jef-annotation","1");
          blk.style.marginTop = "12px";
          blk.style.paddingTop = "12px";
          blk.style.borderTop = "1px dashed rgba(0,0,0,0.15)";
          blk.innerHTML =
            "<div style='font-weight:900;font-size:13px;margin-bottom:6px;'>JEF Event Forecast Annotation (Experimental)</div>" +
            "<div style='font-size:12px;line-height:1.35;color:#334155;'><b>When:</b> " + when + "</div>" +
            "<div style='font-size:12px;line-height:1.35;color:#334155;margin-top:6px;'><b>How (recommended sets):</b> " + how + "</div>" +
            "<div style='font-size:12px;line-height:1.35;color:#334155;margin-top:6px;'><b>Why (observational drivers):</b> " + why + "</div>" +
            "<div style='font-size:11px;line-height:1.35;color:#64748b;margin-top:8px;'><b>Disclosure:</b> Jurisdiction ranking is allocation/visibility only; non-causal and not a predictor of outcomes.</div>";
          panel.appendChild(blk);
        } catch(e){}
      }, 40);
    } catch(e){}
  }

  function formatPlaySet(ps){
    if(!ps) return "";
    var nums = Array.isArray(ps.numbers) ? ps.numbers.join(", ") : "";
    var pb = (ps.powerball!==undefined && ps.powerball!==null) ? String(ps.powerball) : "";
    return nums + "  |  PB " + pb + (ps.tier ? ("  ("+ps.tier+")") : "");
  }

  function renderJefOutput(out){
    var empty = $("jefOutputEmpty");
    var cards = $("jefCards");
    var miss = $("jefMissingMsg");
    var exportBtn = $("jefExportBtn");
    var pill = $("jefStatusPill");

    if (miss) { miss.style.display = "none"; miss.textContent = ""; }
    if (exportBtn) exportBtn.disabled = true;

    if (!out || out.status === "INSUFFICIENT_DATA"){
      if (cards) { cards.style.display = "none"; cards.innerHTML = ""; }
      if (empty) { empty.style.display = "block"; empty.textContent = "INSUFFICIENT DATA — event forecasts not produced."; }
      var missing = Array.isArray(out?.missingInputs) ? out.missingInputs : [];
      if (miss && missing.length){
        miss.style.display = "block";
        miss.textContent = "Missing/insufficient inputs: " + missing.join(", ");
      }
      setPill(pill, "Status: INSUFFICIENT DATA", "bad");
      return;
    }

    var ev = Array.isArray(out.eventForecasts) ? out.eventForecasts : [];
    if (!ev.length){
      if (cards) { cards.style.display = "none"; cards.innerHTML = ""; }
      if (empty) { empty.style.display = "block"; empty.textContent = "No forecasts produced."; }
      setPill(pill, "Status: OK (0 events)", "warn");
      return;
    }

    if (empty) empty.style.display = "none";
    if (cards){
      cards.style.display = "flex";
      cards.innerHTML = "";
      for (var i=0; i<ev.length; i++){
        var e = ev[i];
        var when = e?.dateWindow ? (e.dateWindow.startDate + " → " + e.dateWindow.endDate + " (preferred: " + e.dateWindow.preferredDrawDate + ")") : "—";
        var where = "UNKNOWN (INSUFFICIENT DATA)";
        if (Array.isArray(e?.jurisdictions) && e.jurisdictions.length){
          where = e.jurisdictions.map(function(j){
            return j.jurisdiction + " (" + Math.round((j.weight||0)*100) + "%)";
          }).join(", ");
        }
        var how = "—";
        if (Array.isArray(e?.playSets) && e.playSets.length){
          how = e.playSets.map(formatPlaySet).join("   |   ");
        }
        var why = "—";
        if (Array.isArray(e?.drivers) && e.drivers.length){
          why = e.drivers.map(function(d){ return d.phraseText || d.phraseId || ""; }).filter(Boolean).join(" • ");
        }

        var card = document.createElement("div");
        card.style.border = "1px solid #e2e8f0";
        card.style.borderRadius = "12px";
        card.style.padding = "10px 10px";
        card.style.background = "#ffffff";

        var head = document.createElement("div");
        head.style.display = "flex";
        head.style.alignItems = "center";
        head.style.justifyContent = "space-between";
        head.style.gap = "10px";
        head.style.flexWrap = "wrap";

        var title = document.createElement("div");
        title.style.fontWeight = "900";
        title.style.color = "#0f172a";
        title.textContent = "Event #" + (e.rank || (i+1));

        var band = document.createElement("div");
        band.style.fontSize = "12px";
        band.style.fontWeight = "900";
        band.style.padding = "3px 8px";
        band.style.borderRadius = "999px";
        band.style.border = "1px solid #cbd5e1";
        band.style.background = "#f1f5f9";
        band.style.color = "#0f172a";
        band.textContent = (e.confidenceBand || "Band");

        head.appendChild(title);
        head.appendChild(band);

        var rows = document.createElement("div");
        rows.style.marginTop = "8px";
        rows.style.fontSize = "12px";
        rows.style.color = "#334155";
        rows.style.lineHeight = "1.35";

        rows.innerHTML =
          "<div><b>When:</b> " + when + "</div>" +
          "<div style='margin-top:4px;'><b>Where:</b> " + where + "</div>" +
          "<div style='margin-top:4px;'><b>How:</b> " + how + "</div>" +
          "<div style='margin-top:4px;'><b>Why:</b> " + why + "</div>";

        // Required disclosures (deterministic list)
        var disc = document.createElement("div");
        disc.style.marginTop = "8px";
        disc.style.paddingTop = "8px";
        disc.style.borderTop = "1px dashed #e2e8f0";
        disc.style.fontSize = "11px";
        disc.style.color = "#64748b";
        var dlist = Array.isArray(e?.disclosures?.requiredDisclaimers) ? e.disclosures.requiredDisclaimers : [];
        disc.textContent = dlist.length ? dlist.join(" ") : "Experimental. Observational patterns only; not causal. No win odds are implied or stated.";

        card.appendChild(head);
        card.appendChild(rows);
        card.appendChild(disc);

        cards.appendChild(card);
      }
    }

    if (exportBtn) exportBtn.disabled = false;
    setPill(pill, "Status: OK (" + ev.length + " events)", "ok");
  }

  function exportJefJson(out){
    if (!out || out.status !== "OK") return;
    try {
      var blob = new Blob([JSON.stringify(out, null, 2)], {type:"application/json"});
      var a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      var d = (new Date()).toISOString().slice(0,10);
      a.download = "PB_E9_JEF_OUTPUT_V1_" + d + ".json";
      document.body.appendChild(a);
      a.click();
      setTimeout(function(){
        try { URL.revokeObjectURL(a.href); } catch(e){}
        try { a.remove(); } catch(e){}
      }, 50);
    } catch(e){}
  }

  
// --- D6 Self-Test Harness (deterministic, non-invasive) ---
function _jefD6BackupOnce(){
  try {
    window.__pbvNext = window.__pbvNext || {};
    if (window.__pbvNext._jefD6Backup) return;
    window.__pbvNext._jefD6Backup = {
      drawHistory: window.PB_POWERBALL_NET_DRAW_HISTORY_V1 || null,
      pred: (resolveE9Modules()?.lastPredictionOutput) || null,
      ledger: (resolveE9Modules()?.lastAuditLedger) || null,
      map: resolveMapMetrics() || null
    };
  } catch(e){}
}

function _jefD6RestoreBackup(){
  try {
    if (!window.__pbvNext || !window.__pbvNext._jefD6Backup) return;
    var b = window.__pbvNext._jefD6Backup;

    if (b.drawHistory) window.PB_POWERBALL_NET_DRAW_HISTORY_V1 = b.drawHistory;
    else try { delete window.PB_POWERBALL_NET_DRAW_HISTORY_V1; } catch(e){ window.PB_POWERBALL_NET_DRAW_HISTORY_V1 = null; }

    var E9 = resolveE9Modules();
    if (E9){
      E9.lastPredictionOutput = b.pred;
      E9.lastAuditLedger = b.ledger;
    }
    if (b.map){
      window.PB_E9_STATE_MAP_METRICS_V1 = b.map;
    } else {
      try { delete window.PB_E9_STATE_MAP_METRICS_V1; } catch(e){ window.PB_E9_STATE_MAP_METRICS_V1 = null; }
    }
  } catch(e){}
}

function installJefD6Mocks(){
  _jefD6BackupOnce();
  try {
    // Draw history lifecycle mock (sufficient for DateScore)
    window.PB_POWERBALL_NET_DRAW_HISTORY_V1 = {
      schemaVersion: "PB_POWERBALL_NET_DRAW_HISTORY_V1",
      lastJackpotWinDate: "2025-12-20",
      draws: [
        { date: "2025-12-20", jackpot: 350000000, jackpotWon: true },
        { date: "2025-12-22", jackpot: 20000000,  jackpotWon: false },
        { date: "2025-12-24", jackpot: 40000000,  jackpotWon: false },
        { date: "2025-12-27", jackpot: 60000000,  jackpotWon: false },
        { date: "2025-12-29", jackpot: 80000000,  jackpotWon: false },
        { date: "2025-12-31", jackpot: 100000000, jackpotWon: false },
        { date: "2026-01-03", jackpot: 120000000, jackpotWon: false },
        { date: "2026-01-05", jackpot: 140000000, jackpotWon: false },
        { date: "2026-01-07", jackpot: 160000000, jackpotWon: false },
        { date: "2026-01-10", jackpot: 180000000, jackpotWon: false },
        { date: "2026-01-12", jackpot: 200000000, jackpotWon: false },
        { date: "2026-01-14", jackpot: 220000000, jackpotWon: false },
        { date: "2026-01-17", jackpot: 240000000, jackpotWon: false }
      ]
    };

    var E9 = resolveE9Modules();
    if (E9){
      E9.lastPredictionOutput = {
        schemaVersion: "PB_E9_PREDICTION_OUTPUT_V1",
        runId: "MOCK-RUN-001",
        rankedCandidates: [
          { candidateId: "C001", numbers: [17,26,39,40,59], powerball: 22, tier: "A" },
          { candidateId: "C002", numbers: [12,19,24,48,67], powerball: 3,  tier: "A" },
          { candidateId: "C003", numbers: [39,41,42,44,45], powerball: 5,  tier: "B" },
          { candidateId: "C004", numbers: [3,11,27,33,61],  powerball: 14, tier: "B" },
          { candidateId: "C005", numbers: [8,13,21,47,58],  powerball: 9,  tier: "C" },
          { candidateId: "C006", numbers: [2,18,28,49,62],  powerball: 7,  tier: "C" }
        ]
      };

      E9.lastAuditLedger = {
        schemaVersion: "PB_E9_AUDIT_LEDGER_V1",
        runId: "MOCK-RUN-001",
        entries: [
          { id: "L001", candidateId: "C001", phraseId: "E9_CORE_RANK", phraseText: "Candidate ranked by vE9 composite scoring (observational).", exrefs: ["E9:score:composite"] },
          { id: "L002", candidateId: "C001", phraseId: "E9_FREQ",      phraseText: "Frequency-weighted signal contributed to rank (observational).", exrefs: ["E9:module:freq"] },
          { id: "L003", candidateId: "C002", phraseId: "E9_CORE_RANK", phraseText: "Candidate ranked by vE9 composite scoring (observational).", exrefs: ["E9:score:composite"] },
          { id: "L900", candidateId: "C001", phraseId: "CXT_NOTE",      phraseText: "CXT observation present (context only; non-causal).", exrefs: ["CXT:overlay"], isCxt: true }
        ]
      };
    }

    // Optional map metrics mock (enables D5 highlight)
    window.PB_E9_STATE_MAP_METRICS_V1 = {
      schemaVersion: "StateMapMetricsV1",
      jurisdictions: {
        "TX": { observedPct: 0.10, expectedPct: 0.06, deltaPct: 0.04, relativeIndex: 1.6 },
        "CA": { observedPct: 0.08, expectedPct: 0.08, deltaPct: 0.00, relativeIndex: 1.0 },
        "FL": { observedPct: 0.07, expectedPct: 0.06, deltaPct: 0.01, relativeIndex: 1.2 },
        "NY": { observedPct: 0.06, expectedPct: 0.07, deltaPct: -0.01, relativeIndex: 0.9 }
      }
    };
  } catch(e){}
}

function clearJefD6Mocks(){
  _jefD6RestoreBackup();
  try {
    if (window.__pbvNext && window.__pbvNext._jefD6Backup) delete window.__pbvNext._jefD6Backup;
  } catch(e){}
}

function _renderD6Results(rows){
  var wrap = $("jefD6Results");
  if (!wrap) return;
  if (!rows || !rows.length){
    wrap.innerHTML = '<div style="font-size:12px; color:#64748b;">No test results.</div>';
    return;
  }
  var html = '';
  html += '<div style="overflow:auto; border:1px solid #e2e8f0; border-radius:10px;">';
  html += '<table style="width:100%; border-collapse:collapse; font-size:12px;">';
  html += '<thead><tr style="background:#f8fafc;">' +
          '<th style="text-align:left; padding:8px; border-bottom:1px solid #e2e8f0;">Test</th>' +
          '<th style="text-align:left; padding:8px; border-bottom:1px solid #e2e8f0;">Expected</th>' +
          '<th style="text-align:left; padding:8px; border-bottom:1px solid #e2e8f0;">Actual</th>' +
          '<th style="text-align:left; padding:8px; border-bottom:1px solid #e2e8f0;">Result</th>' +
          '</tr></thead><tbody>';
  rows.forEach(function(r){
    var ok = r.pass === true;
    html += '<tr>' +
      '<td style="padding:8px; border-bottom:1px solid #e2e8f0; font-weight:700;">' + esc(String(r.name||'')) + '</td>' +
      '<td style="padding:8px; border-bottom:1px solid #e2e8f0;">' + esc(String(r.expected||'')) + '</td>' +
      '<td style="padding:8px; border-bottom:1px solid #e2e8f0;">' + esc(String(r.actual||'')) + '</td>' +
      '<td style="padding:8px; border-bottom:1px solid #e2e8f0; font-weight:900; color:' + (ok ? '#15803d' : '#b91c1c') + ';">' + (ok ? 'PASS' : 'FAIL') + '</td>' +
    '</tr>';
  });
  html += '</tbody></table></div>';
  wrap.innerHTML = html;
}

function runJefD6Tests(){
  var rows = [];
  var E9 = resolveE9Modules();
  var build = E9?.jef?.buildJefOutputV1;

  function _callBuild(){
    return build({
      predOutput: E9.lastPredictionOutput || null,
      auditLedger: E9.lastAuditLedger || null,
      mapMetrics: resolveMapMetrics(),
      drawHistory: resolveDrawHistory(),
      nowDate: new Date()
    });
  }

  if (typeof build !== "function"){
    rows.push({ name:"D6 Precheck", expected:"JEF module available", actual:"missing", pass:false });
    _renderD6Results(rows);
    return;
  }

  // Mocks are disabled in vE10 production path. Tests recall real cached/loaded inputs only.

  // Test 1: OK path produces forecasts
  var out1 = _callBuild();
  var pass1 = (out1 && out1.status === "OK" && Array.isArray(out1.eventForecasts) && out1.eventForecasts.length > 0);
  rows.push({
    name: "OK path",
    expected: "status=OK, forecasts>0",
    actual: "status=" + String(out1?.status) + ", forecasts=" + String(out1?.eventForecasts?.length||0),
    pass: pass1
  });

  // Test 2: Determinism (same inputs -> identical output)
  var out2 = _callBuild();
  var s1 = stableStringify(out1||{});
  var s2 = stableStringify(out2||{});
  rows.push({
    name: "Determinism",
    expected: "stableStringify(out1) == stableStringify(out2)",
    actual: (s1 === s2) ? "identical" : "different",
    pass: (s1 === s2)
  });

  // Test 3: Missing draw history -> fail-closed
  var savedDH = window.PB_POWERBALL_NET_DRAW_HISTORY_V1;
  try { delete window.PB_POWERBALL_NET_DRAW_HISTORY_V1; } catch(e){ window.PB_POWERBALL_NET_DRAW_HISTORY_V1 = null; }
  var out3 = _callBuild();
  rows.push({
    name: "Fail-closed: missing draw history",
    expected: "INSUFFICIENT_DATA, forecasts=0",
    actual: "status=" + String(out3?.status) + ", forecasts=" + String(out3?.eventForecasts?.length||0),
    pass: (out3 && out3.status === "INSUFFICIENT_DATA" && (out3.eventForecasts||[]).length === 0)
  });
  if (savedDH) window.PB_POWERBALL_NET_DRAW_HISTORY_V1 = savedDH;

  // Test 4: Missing predictions -> fail-closed
  var savedPred = E9.lastPredictionOutput;
  E9.lastPredictionOutput = null;
  var out4 = _callBuild();
  rows.push({
    name: "Fail-closed: missing vE9 predictions",
    expected: "INSUFFICIENT_DATA, forecasts=0",
    actual: "status=" + String(out4?.status) + ", forecasts=" + String(out4?.eventForecasts?.length||0),
    pass: (out4 && out4.status === "INSUFFICIENT_DATA" && (out4.eventForecasts||[]).length === 0)
  });
  E9.lastPredictionOutput = savedPred;

  // Test 5: Missing audit ledger -> fail-closed
  var savedLedger = E9.lastAuditLedger;
  E9.lastAuditLedger = null;
  var out5 = _callBuild();
  rows.push({
    name: "Fail-closed: missing audit ledger",
    expected: "INSUFFICIENT_DATA, forecasts=0",
    actual: "status=" + String(out5?.status) + ", forecasts=" + String(out5?.eventForecasts?.length||0),
    pass: (out5 && out5.status === "INSUFFICIENT_DATA" && (out5.eventForecasts||[]).length === 0)
  });
  E9.lastAuditLedger = savedLedger;

  // Test 6: Map highlight gating does not throw
  var threw = false;
  try { applyJefMapHighlight(out1); } catch(e) { threw = true; }
  rows.push({
    name: "Map highlight gating",
    expected: "No exception",
    actual: threw ? "exception" : "ok",
    pass: !threw
  });

  _renderD6Results(rows);
}

function wire(){
    var runBtn = $("jefRunBtn");
    var expBtn = $("jefExportBtn");
    var pill = $("jefStatusPill");
    if(!runBtn || !expBtn || !pill) return;

    var lastOut = null;

    runBtn.addEventListener("click", function(){
      var E9 = resolveE9Modules();
      var build = E9?.jef?.buildJefOutputV1;
      if (typeof build !== "function"){
        lastOut = { status:"INSUFFICIENT_DATA", missingInputs:["jefModule(unavailable)"], eventForecasts:[] };
        renderJefOutput(lastOut);
        return;
      }

      // Inputs: strict and read-only
      var predOutput = E9.lastPredictionOutput || null;
      var auditLedger = E9.lastAuditLedger || null;
      var mapMetrics = resolveMapMetrics(); // optional
      var drawHistory = resolveDrawHistory(); // required

      setPill(pill, "Status: Running...", "warn");
      try {
        lastOut = build({
          predOutput: predOutput,
          auditLedger: auditLedger,
          mapMetrics: mapMetrics,
          drawHistory: drawHistory,
          nowDate: new Date()
        });
      } catch(e){
        lastOut = { status:"INSUFFICIENT_DATA", missingInputs:["runtime(exception)"], eventForecasts:[] };
      }

      // Persist for export and later D5 map integration
      try {
        window.__pbvNext = window.__pbvNext || {};
        window.__pbvNext.lastJefOutputV1 = lastOut;
      } catch(e){}

      renderJefOutput(lastOut);
      try { applyJefMapHighlight(lastOut); } catch(e) {}
    });

    expBtn.addEventListener("click", function(){
      var out = null;
      try {
        out = (window.__pbvNext && window.__pbvNext.lastJefOutputV1) ? window.__pbvNext.lastJefOutputV1 : lastOut;
      } catch(e){
        out = lastOut;
      }
      exportJefJson(out);
    });


    // PB10 QA harness (non-destructive). Does not modify history table, slip logic, or cache.
    // NOTE: The global toast() in this build routes to enh3InlineMsg which may be off-screen.
    // Provide a PB10-local output area as the primary feedback channel.
    function PB10_notify(text, level){
      try{
        // Prefer any global toast system if present.
        if (typeof window.showToast === "function") return window.showToast(String(text||""), level||"info");
      }catch(_e){}
      try{
        var outEl = document.getElementById("pb10QaOutput");
        if (outEl){
          outEl.style.display = "block";
          outEl.textContent = String(text||"");
          outEl.setAttribute("data-level", String(level||"info"));
          // keep visible; clear only on next run
          return;
        }
      }catch(_e2){}
      try{ alert(String(text||"")); }catch(_e3){}
    }

    var qaBtn = document.getElementById("pbNetHistoryQABtn");
    if (qaBtn){
      qaBtn.addEventListener("click", function(){
        try {
          var r = PB10_runQAChecks();
          var failCount = r.filter(function(x){return !x.ok;}).length;
          var headline = (failCount===0 ? "QA: PASS" : "QA: FAIL") + " — " + failCount + " issue(s)";
          var lines = r.map(function(x){
            return (x.ok?"PASS":"FAIL") + " — " + x.name + (x.detail?": " + x.detail:"");
          }).slice(0, 20);
          PB10_notify(headline + "\n" + lines.join("\n"), (failCount===0?"success":"warn"));
          try{ console.table(r); }catch(_e){}
        } catch(e){
          console.error(e);
          PB10_notify("QA run failed: " + (e && e.message ? e.message : e), "error");
        }
      });
    }

    function PB10_runQAChecks(){
      var out=[];
      function add(name, ok, detail){ out.push({name:name, ok:!!ok, detail:detail||""}); }

      // DOM anchors
      add("historyTableBody exists", !!document.getElementById("historyTableBody"));
      add("PB10 controls exist", !!document.getElementById("pbNetHistoryLoadBtn") && !!document.getElementById("pbNetHistoryExportBtn") && !!document.getElementById("pbNetHistoryStatusPill"));

      // Mocks disabled by default
      add("Mocks not explicitly enabled", window.__PB_ALLOW_MOCKS !== true, window.__PB_ALLOW_MOCKS===true?"__PB_ALLOW_MOCKS=true":"");

      // Cache readability
      var cacheRaw = null;
      try { cacheRaw = localStorage.getItem(PB10_CACHE_KEY); add("localStorage cache key readable", true); }
      catch(e){ add("localStorage cache key readable", false, String(e&&e.message?e.message:e)); }

      // Published object checks
      var obj = window.PB_POWERBALL_NET_DRAW_HISTORY_V1;
      add("PB_POWERBALL_NET_DRAW_HISTORY_V1 present", !!obj, obj?"published":"missing");
      if (obj){
        add("schemaVersion correct", obj.schemaVersion === "PB_POWERBALL_NET_DRAW_HISTORY_V1", String(obj.schemaVersion||""));
        add("draws is array", Array.isArray(obj.draws), Array.isArray(obj.draws)?("len="+obj.draws.length):typeof obj.draws);

        // Date format sanity (sample up to 25)
        var re = /^\d{4}-\d{2}-\d{2}$/;
        var bad=0;
        (obj.draws||[]).slice(0,25).forEach(function(d){ if(!d || !re.test(String(d.date||""))) bad++; });
        add("draw.date strict ISO (sample)", bad===0, bad?("bad="+bad):"");

        // Ascending ordering check (sample)
        var ascOk=true;
        for (var i=1;i<Math.min((obj.draws||[]).length, 60);i++){
          var a=String(obj.draws[i-1].date||"");
          var b=String(obj.draws[i].date||"");
          if (a && b && a>b){ ascOk=false; break; }
        }
        add("draws sorted ascending (sample)", ascOk);

        // Quality object exists
        add("quality block exists", !!obj.quality);
        if (obj.quality){
          add("quality.drawCount is number", typeof obj.quality.drawCount === "number", String(obj.quality.drawCount));
          add("quality.warnings is array", Array.isArray(obj.quality.warnings), Array.isArray(obj.quality.warnings)?("len="+obj.quality.warnings.length):typeof obj.quality.warnings);
        }

        // JEF-ready heuristic: align with PB10 computed readiness flags (if present)
        var jefReady = !!(obj.quality && obj.quality.hasJackpotSeries && obj.quality.hasWinMarkers && (obj.draws||[]).length>=20);
        add("Lifecycle usable flags (hasJackpotSeries & hasWinMarkers)", jefReady, obj.quality?((obj.quality.hasJackpotSeries?"jackpotSeries":"noJackpotSeries")+","+(obj.quality.hasWinMarkers?"winMarkers":"noWinMarkers")):"no quality");
      }

      // Direct Fetch toggle default off
      var ft = document.getElementById("pbNetHistoryFetchToggle");
      add("Direct Fetch toggle default OFF", !ft || ft.checked !== true, ft?String(ft.checked):"missing toggle");

      return out;
    }


// ------------------------------
// Enhancement #10 (Deliverable 10.2)
// Publisher + Cache Loader (Fail-Closed)
// ------------------------------

var PB10_CACHE_KEY = "PB_POWERBALL_NET_DRAW_HISTORY_V1_CACHE";

function pb10IsoDateOk(s){
  return (typeof s === "string") && /^\d{4}-\d{2}-\d{2}$/.test(s);
}

function pb10ParseMoney(v){
  if (v === null || v === undefined) return null;
  if (typeof v === "number" && isFinite(v)) return Math.trunc(v);
  var s = String(v).trim();
  if (!s) return null;
  s = s.replace(/[$,]/g, "").trim();
  if (!s) return null;
  if (!/^[-]?\d+(?:\.\d+)?$/.test(s)) return null;
  var n = Number(s);
  if (!isFinite(n)) return null;
  return Math.trunc(n);
}

function pb10Clone(o){
  try { return JSON.parse(JSON.stringify(o)); } catch(e){ return null; }
}

function pb10ComputeDerived(dh){
  var warnings = [];
  var draws = Array.isArray(dh.draws) ? dh.draws.slice() : [];

  // Normalize draws
  var norm = [];
  for (var i=0; i<draws.length; i++){
    var r = draws[i] || {};
    var date = r.date;
    if (!pb10IsoDateOk(date)){
      warnings.push("Invalid or missing draw date at index " + i);
      continue;
    }
    var jackpot = (r.jackpot === undefined) ? null : pb10ParseMoney(r.jackpot);
    var cashValue = (r.cashValue === undefined) ? null : pb10ParseMoney(r.cashValue);
    var multiplier = (r.multiplier === undefined || r.multiplier === null || r.multiplier === "") ? null : Number(r.multiplier);
    if (multiplier !== null && !isFinite(multiplier)) multiplier = null;

    var numbers = Array.isArray(r.numbers) ? r.numbers.slice(0,5) : null;
    if (numbers && numbers.length){
      numbers = numbers.map(function(x){ return Number(x); }).filter(function(x){ return isFinite(x); });
      if (numbers.length === 5) numbers.sort(function(a,b){ return a-b; });
      else numbers = null;
    }
    var powerball = (r.powerball === undefined || r.powerball === null || r.powerball === "") ? null : Number(r.powerball);
    if (powerball !== null && !isFinite(powerball)) powerball = null;

    var jackpotWon = (r.jackpotWon === true) ? true : (r.jackpotWon === false ? false : null);

    norm.push({
      date: date,
      numbers: numbers,
      powerball: powerball,
      jackpot: jackpot,
      jackpotWon: jackpotWon,
      cashValue: cashValue,
      multiplier: multiplier
    });
  }

  // Sort ascending by date
  norm.sort(function(a,b){ return a.date.localeCompare(b.date); });

  // Derived fields
  var drawCount = norm.length;
  var mostRecentDrawDate = drawCount ? norm[drawCount-1].date : null;

  var winDates = [];
  for (var j=0; j<norm.length; j++){
    if (norm[j].jackpotWon === true) winDates.push(norm[j].date);
  }
  var lastJackpotWinDate = winDates.length ? winDates[winDates.length-1] : null;

  // Recent jackpot density (for your contract + JEF growth readiness)
  var recent = norm.slice(Math.max(0, norm.length - 12));
  var recentJackpotCount = recent.filter(function(x){ return x.jackpot !== null; }).length;

  var last8 = norm.slice(Math.max(0, norm.length - 8));
  var recentJackpotPoints = last8.filter(function(x){ return x.jackpot !== null; }).length;

  var hasJackpotSeries = (norm.length >= 12) ? (recentJackpotCount >= 8) : false;
  var hasWinMarkers = norm.length ? norm.every(function(x){ return x.jackpotWon === true || x.jackpotWon === false; }) : false;

  // JEF-ready aligns to baseline strict gating: >=20 cleaned jackpot draws, >=10 wins, >=5 recent points
  // "cleaned jackpot draws" approximation here: count draws with jackpot present
  var cleanedJackpotDraws = norm.filter(function(x){ return x.jackpot !== null; });
  var jefReady = (cleanedJackpotDraws.length >= 20) && (winDates.length >= 10) && (recentJackpotPoints >= 5);

  if (drawCount < 20) warnings.push("draws.length < 20 (minimum required for lifecycle scoring)");
  if (!hasJackpotSeries) warnings.push("Insufficient jackpot series: need jackpot for at least 8 of the most recent 12 draws.");
  if (!hasWinMarkers) warnings.push("Insufficient win markers: jackpotWon is missing/unknown for one or more draws.");
  if (winDates.length < 10) warnings.push("Insufficient win markers for JEF (need >=10 jackpot wins in history).");
  if (recentJackpotPoints < 5) warnings.push("Insufficient recent jackpot points for growth computation (need >=5 jackpot values in last 8 draws).");

  return {
    normDraws: norm,
    drawCount: drawCount,
    mostRecentDrawDate: mostRecentDrawDate,
    lastJackpotWinDate: lastJackpotWinDate,
    winMarkerCount: winDates.length,
    hasJackpotSeries: hasJackpotSeries,
    hasWinMarkers: hasWinMarkers,
    recentJackpotPoints: recentJackpotPoints,
    cleanedJackpotDraws: cleanedJackpotDraws.length,
    jefReady: jefReady,
    warnings: warnings
  };
}

function pb10ValidateAndNormalize(obj){
  var raw = pb10Clone(obj);
  if (!raw || typeof raw !== "object") return { ok:false, reason:"cache not an object" };

  var schemaOk = (raw.schemaVersion === "PB_POWERBALL_NET_DRAW_HISTORY_V1");
  if (!schemaOk) return { ok:false, reason:"schemaVersion mismatch" };

  // Ensure required container fields exist (deterministic fill, no timestamps invented)
  if (typeof raw.generatedAt !== "string") raw.generatedAt = "";
  if (!raw.source || typeof raw.source !== "object") raw.source = { provider:"powerball.net", retrievedAt:"", note:"" };
  if (typeof raw.source.provider !== "string" || !raw.source.provider) raw.source.provider = "powerball.net";
  if (typeof raw.source.retrievedAt !== "string") raw.source.retrievedAt = "";
  if (typeof raw.source.note !== "string") raw.source.note = "";

  var derived = pb10ComputeDerived(raw);

  // Publish-normalized
  var out = {
    schemaVersion: "PB_POWERBALL_NET_DRAW_HISTORY_V1",
    generatedAt: raw.generatedAt,
    source: {
      provider: "powerball.net",
      retrievedAt: raw.source.retrievedAt,
      note: raw.source.note || "Parsed from Powerball.net historical results page(s)."
    },
    lastJackpotWinDate: derived.lastJackpotWinDate,
    draws: derived.normDraws,
    quality: {
      drawCount: derived.drawCount,
      hasJackpotSeries: !!derived.hasJackpotSeries,
      hasWinMarkers: !!derived.hasWinMarkers,
      warnings: derived.warnings.slice(0)
    }
  };

  return {
    ok: true,
    normalized: out,
    derived: derived
  };
}


function pb10UiSetBusy(isBusy){
  try {
    var pill = document.getElementById("pbNetHistoryStatusPill");
    if (!pill) return;
    if (isBusy){
      pill.textContent = "LOADING...";
      pill.classList.remove("pbnet-ok","pbnet-bad");
      pill.classList.add("pbnet-pending");
      pill.title = "Enhancement #10: Processing draw-history input...";
    } else {
      // restore pill state from current published object (if any)
      try {
        var dh = window.PB_POWERBALL_NET_DRAW_HISTORY_V1 || null;
        var d2 = (dh && dh.quality) ? {drawCount:dh.quality.drawCount,lastJackpotWinDate:dh.lastJackpotWinDate,mostRecentDrawDate:(dh.draws && dh.draws.length? dh.draws[dh.draws.length-1].date:null),jefReady:false,warnings:(dh.quality.warnings||[])} : {drawCount:0,lastJackpotWinDate:null,mostRecentDrawDate:null,jefReady:false,warnings:[]};
        pb10UiUpdateFrom(dh, d2);
      } catch(_e){}
    }
  } catch(e){}
}

function pb10ShowWarningsToast(warnings){
  try {
    warnings = Array.isArray(warnings) ? warnings : [];
    if (!warnings.length){
      toast("Enhancement #10: No warnings.", "info");
      return;
    }
    // Keep toast short: show up to first 6 warnings
    var max = Math.min(6, warnings.length);
    var msg = "Enhancement #10 warnings ("+warnings.length+"):\n- " + warnings.slice(0,max).join("\n- ");
    if (warnings.length > max) msg += "\n- ...";
    toast(msg, "warning", 6500);
  } catch(e){}
}
function pb10UiUpdateFrom(dh, derived){
  try {
    var pill = document.getElementById("pbNetHistoryStatusPill");
    var details = document.getElementById("pbNetHistoryDetailsLine");
    var expBtn = document.getElementById("pbNetHistoryExportBtn");
    var warnBtn = document.getElementById("pbNetHistoryWarningsBtn");
    if (!pill || !details) return;

    var drawCount = derived ? derived.drawCount : (dh && dh.quality ? dh.quality.drawCount : 0);
    var lastWin = (derived && derived.lastJackpotWinDate) ? derived.lastJackpotWinDate : (dh ? dh.lastJackpotWinDate : null);
    var mostRecent = (derived && derived.mostRecentDrawDate) ? derived.mostRecentDrawDate : null;

    var ok = !!(derived && derived.jefReady);

    pill.textContent = ok ? "OK" : "INSUFFICIENT DATA";
    pill.classList.remove("pbnet-ok","pbnet-bad","pbnet-pending");
    pill.classList.add(ok ? "pbnet-ok" : "pbnet-bad");

    var w = [];
    try { w = (derived && derived.warnings) ? derived.warnings : (dh && dh.quality && Array.isArray(dh.quality.warnings) ? dh.quality.warnings : []); } catch(e){ w = []; }

    pill.title = ok ? "Enhancement #10: Draw history is sufficient for JEF." : "Enhancement #10: Draw history is insufficient for JEF. Load more history.";

    details.textContent = "drawCount: " + String(drawCount||0) +
      " | lastJackpotWinDate: " + String(lastWin || "unknown") +
      " | mostRecent: " + String(mostRecent || "unknown");

    if (warnBtn){
      if (w && w.length){
        warnBtn.style.display = "inline";
        warnBtn.textContent = "Warnings: " + String(w.length);
        warnBtn.onclick = function(){ pb10ShowWarningsToast(w); };
      } else {
        warnBtn.style.display = "none";
        warnBtn.textContent = "Warnings: 0";
        warnBtn.onclick = null;
      }
    }

    // Export enabled only when a published object exists and has at least one draw
    if (expBtn){
      var canExport = false;
      try {
        canExport = !!(window.PB_POWERBALL_NET_DRAW_HISTORY_V1 && Array.isArray(window.PB_POWERBALL_NET_DRAW_HISTORY_V1.draws) && window.PB_POWERBALL_NET_DRAW_HISTORY_V1.draws.length > 0);
      } catch(e){ canExport = false; }
      expBtn.disabled = !canExport;
    }
  } catch(e){}
}

function pb10PublishAndRenderFromCache(){
  var raw = null;
  try {
    var s = localStorage.getItem(PB10_CACHE_KEY);
    if (s) raw = JSON.parse(s);
  } catch(e){
    try{ toast("Enhancement #10: Draw history cache is invalid or unreadable.", "error"); }catch(_e){}
    return;
  }

  if (!raw){
    // No cache present. Fail-closed.
    pb10UiUpdateFrom(null, {drawCount:0,lastJackpotWinDate:null,mostRecentDrawDate:null,jefReady:false});
    return;
  }

  var v = pb10ValidateAndNormalize(raw);
  if (!v.ok){
    try{ toast("Enhancement #10: Cached draw history rejected ("+v.reason+").", "warning"); }catch(e){}
    pb10UiUpdateFrom(null, {drawCount:0,lastJackpotWinDate:null,mostRecentDrawDate:null,jefReady:false});
    return;
  }

  // Publish (even if insufficient) — quality + warnings explain why.
  try { window.PB_POWERBALL_NET_DRAW_HISTORY_V1 = v.normalized; } catch(e){}

  // Update UI status based on derived JEF readiness
  pb10UiUpdateFrom(v.normalized, v.derived);
}


function pb10NowIsoFromMostRecent(derived){
  var d = derived && derived.mostRecentDrawDate ? derived.mostRecentDrawDate : null;
  if (pb10IsoDateOk(d)) return d + "T00:00:00.000Z";
  return "";
}

function pb10DownloadText(filename, text, mime){
  try {
    var blob = new Blob([text], {type: mime || "application/json"});
    var url = URL.createObjectURL(blob);
    var a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(function(){
      try { URL.revokeObjectURL(url); } catch(e){}
      try { a.remove(); } catch(e){}
    }, 0);
  } catch(e){
    try{ toast("Enhancement #10: Export failed.", "error"); }catch(_e){}
  }
}

function pb10ExportDrawHistoryJson(){
  try {
    var dh = window.PB_POWERBALL_NET_DRAW_HISTORY_V1;
    if (!dh || !Array.isArray(dh.draws) || dh.draws.length === 0){
      try{ toast("Enhancement #10: No draw history cache available to export.", "warning"); }catch(_e){}
      return;
    }
    var drawCount = dh.draws.length;
    var mostRecent = dh.draws[dh.draws.length-1].date || "";
    var stamp = (mostRecent || "").replace(/-/g, "");
    var fn = "PB_POWERBALL_NET_DRAW_HISTORY_V1_" + (stamp || "export") + "_" + String(drawCount) + ".json";
    pb10DownloadText(fn, JSON.stringify(dh, null, 2), "application/json");
    try{ toast("Enhancement #10: Exported draw history JSON.", "success"); }catch(_e){}
  } catch(e){
    try{ toast("Enhancement #10: Export failed.", "error"); }catch(_e){}
  }
}

function pb10ReadFileAsText(file){
  return new Promise(function(resolve, reject){
    var r = new FileReader();
    r.onerror = function(){ reject(new Error("read_error")); };
    r.onload = function(){ resolve(String(r.result || "")); };
    r.readAsText(file);
  });
}

function pb10SplitCsvLine(line){
  var out = [];
  var cur = "";
  var inq = false;
  for (var i=0;i<line.length;i++){
    var ch = line[i];
    if (inq){
      if (ch === '"'){
        if (line[i+1] === '"'){ cur += '"'; i++; }
        else { inq = false; }
      } else cur += ch;
    } else {
      if (ch === ','){ out.push(cur); cur = ""; }
      else if (ch === '"'){ inq = true; }
      else cur += ch;
    }
  }
  out.push(cur);
  return out;
}

function pb10MapHeaders(h){
  var map = {};
  for (var i=0;i<h.length;i++){
    var key = String(h[i]||"").trim();
    if (!key) continue;
    var k = key.toLowerCase();
    if (k === "drawdate") map[i] = "date";
    else if (k === "pb") map[i] = "powerball";
    else if (k === "powerplay") map[i] = "multiplier";
    else if (k === "estimatedjackpot") map[i] = "jackpot";
    else if (k === "cash") map[i] = "cashValue";
    else if (k in {"won":1,"jackpot_won":1}) map[i] = "jackpotWon";
    else map[i] = key; // allow canonical names
  }
  return map;
}

function pb10ParseCsvText(text){
  var lines = String(text||"")
    .split(/\r?\n/)
    .filter(function(l){ return String(l||"").trim().length; });
  if (!lines.length) return {rows:[], warnings:["CSV: empty"]};
  var header = pb10SplitCsvLine(lines[0]);
  var idxMap = pb10MapHeaders(header);
  var warnings = [];
  var rows = [];
  for (var i=1;i<lines.length;i++){
    var cols = pb10SplitCsvLine(lines[i]);
    var obj = {};
    for (var c=0;c<cols.length;c++){
      var key = idxMap[c];
      if (!key) continue;
      obj[key] = cols[c];
    }
    var date = (obj.date || obj.drawDate || "").trim();
    if (!pb10IsoDateOk(date)){
      warnings.push("CSV: invalid date at row " + (i+1));
      continue;
    }
    var nums = [];
    if (obj.n1!==undefined) nums = [obj.n1,obj.n2,obj.n3,obj.n4,obj.n5].map(Number).filter(function(x){return isFinite(x);});
    else if (obj.numbers){
      nums = String(obj.numbers).trim().split(/\s+/).map(Number).filter(function(x){return isFinite(x);});
    }
    var pb = (obj.powerball!==undefined) ? Number(obj.powerball) : (obj.pb!==undefined ? Number(obj.pb) : null);
    if (pb !== null && !isFinite(pb)) pb = null;
    if (nums.length === 5) nums.sort(function(a,b){return a-b;});
    else nums = null;

    var jw = null;
    if (obj.jackpotWon !== undefined){
      var t = String(obj.jackpotWon).trim().toLowerCase();
      if (t === "true" || t === "1" || t === "yes") jw = true;
      else if (t === "false" || t === "0" || t === "no") jw = false;
    }

    rows.push({
      date: date,
      numbers: nums,
      powerball: pb,
      jackpot: pb10ParseMoney(obj.jackpot),
      jackpotWon: jw,
      cashValue: pb10ParseMoney(obj.cashValue),
      multiplier: (obj.multiplier!==undefined && obj.multiplier!=="" ? Number(obj.multiplier) : null)
    });
  }
  return {rows:rows, warnings:warnings};
}

function pb10NormalizeRowLike(x){
  var r = x || {};
  var date = (r.date || r.drawDate || "").trim();
  if (!pb10IsoDateOk(date)) return null;
  var nums = null;
  if (Array.isArray(r.numbers)){
    var a = r.numbers.map(Number).filter(function(z){return isFinite(z);});
    if (a.length === 5){ a.sort(function(m,n){return m-n;}); nums = a; }
  }
  var pb = (r.powerball===undefined||r.powerball===null||r.powerball==="") ? null : Number(r.powerball);
  if (pb!==null && !isFinite(pb)) pb = null;
  var jw = (r.jackpotWon===true) ? true : (r.jackpotWon===false ? false : null);
  return {
    date: date,
    numbers: nums,
    powerball: pb,
    jackpot: pb10ParseMoney(r.jackpot),
    jackpotWon: jw,
    cashValue: pb10ParseMoney(r.cashValue),
    multiplier: (r.multiplier===undefined||r.multiplier===null||r.multiplier==="") ? null : Number(r.multiplier)
  };
}

function pb10ParseJsonText(text){
  var warnings = [];
  var obj = null;
  try { obj = JSON.parse(String(text||"")); } catch(e){ return {kind:"json", rows:[], full:null, warnings:["JSON parse error"]}; }

  // Full object
  if (obj && typeof obj === "object" && obj.schemaVersion === "PB_POWERBALL_NET_DRAW_HISTORY_V1"){
    return {kind:"json", rows:[], full:obj, warnings:warnings};
  }

  // Array of rows
  if (Array.isArray(obj)){
    var rows = [];
    for (var i=0;i<obj.length;i++){
      var n = pb10NormalizeRowLike(obj[i]);
      if (n) rows.push(n);
      else warnings.push("JSON: invalid row at index " + i);
    }
    return {kind:"json", rows:rows, full:null, warnings:warnings};
  }

  // Object with draws array
  if (obj && typeof obj === "object" && Array.isArray(obj.draws)){
    var rows2 = [];
    for (var j=0;j<obj.draws.length;j++){
      var n2 = pb10NormalizeRowLike(obj.draws[j]);
      if (n2) rows2.push(n2);
      else warnings.push("JSON: invalid draws row at index " + j);
    }
    return {kind:"json", rows:rows2, full:null, warnings:warnings};
  }

  return {kind:"json", rows:[], full:null, warnings:["JSON: unsupported shape"]};
}

function pb10FindSixNumberWindow(tokens){
  for (var i=0;i<=tokens.length-6;i++){
    var win = tokens.slice(i,i+6);
    if (win.some(function(x){ return !isFinite(x); })) continue;
    var mains = win.slice(0,5);
    var pb = win[5];
    // Heuristic bounds
    var mainsOk = mains.every(function(n){ return n>=1 && n<=69; });
    var pbOk = (pb>=1 && pb<=26);
    if (mainsOk && pbOk){
      return {numbers:mains.sort(function(a,b){return a-b;}), powerball:pb};
    }
  }
  return null;
}


function pb10MonthDayYearToIso(s){
  try {
    var m = String(s||"").trim().match(/^([A-Za-z]+)\s+(\d{1,2}),\s+(\d{4})$/);
    if (!m) return null;
    var mon = m[1].toLowerCase();
    var day = Number(m[2]);
    var year = Number(m[3]);
    var mm = {
      january:1,february:2,march:3,april:4,may:5,june:6,
      july:7,august:8,september:9,october:10,november:11,december:12
    }[mon];
    if (!mm || !year || !day) return null;
    var mo = String(mm).padStart(2,'0');
    var da = String(day).padStart(2,'0');
    var iso = String(year) + '-' + mo + '-' + da;
    return pb10IsoDateOk(iso) ? iso : null;
  } catch(e){ return null; }
}

function pb10ParseHtmlText(text){
  var warnings = [];
  var rows = [];
  var kind = "html";
  try {
    var doc = new DOMParser().parseFromString(String(text||""), "text/html");
    var whole = (doc.documentElement && doc.documentElement.textContent) ? doc.documentElement.textContent : String(text||"");
    var lower = whole.toLowerCase();
    var isWinners = lower.indexOf("/winners") !== -1 || lower.indexOf("jackpot was won") !== -1;
    var isArchive = lower.indexOf("/archive/") !== -1;

    // Extract all /numbers/YYYY-MM-DD links and attempt to parse the containing <tr>
    var links = Array.prototype.slice.call(doc.querySelectorAll('a[href*="/numbers/"]'));
    var seen = {};
    for (var i=0;i<links.length;i++){
      var href = links[i].getAttribute('href') || "";
      var m = href.match(/\/numbers\/(\d{4}-\d{2}-\d{2})/);
      if (!m) continue;
      var date = m[1];
      if (!pb10IsoDateOk(date)) continue;
      if (seen[date]) continue;
      seen[date] = true;

      var tr = links[i].closest ? links[i].closest('tr') : null;
      var rowText = tr ? (tr.textContent || "") : (links[i].textContent || "");
      var tokens = rowText.replace(/[^0-9 ]+/g," ").trim().split(/\s+/).map(Number);
      var np = pb10FindSixNumberWindow(tokens);

      var jackpot = null;
      var cash = null;
      var money = rowText.match(/\$\s*\d[\d,]*/g) || [];
      if (money.length >= 1) jackpot = pb10ParseMoney(money[0]);
      if (money.length >= 2) cash = pb10ParseMoney(money[1]);

      var jw = null;
      if (rowText.toLowerCase().indexOf("rollover") !== -1) jw = false;
      if (rowText.toLowerCase().indexOf("jackpot won") !== -1) jw = true;

      rows.push({
        date: date,
        numbers: np ? np.numbers : null,
        powerball: np ? np.powerball : null,
        jackpot: jackpot,
        jackpotWon: jw,
        cashValue: cash,
        multiplier: null
      });
    }

    if (isWinners){
      kind = "winners";
      var t = whole.match(/most recent jackpot was won on\s+([A-Za-z]+\s+\d{1,2},\s+\d{4})/i);
      if (t && t[1]){
        var iso = pb10MonthDayYearToIso(t[1]);
        if (iso){
          rows.push({date: iso, numbers:null, powerball:null, jackpot:null, jackpotWon:true, cashValue:null, multiplier:null});
        } else {
          warnings.push("Winners: could not parse last jackpot win date.");
        }
      }
    }


  } catch(e){
    warnings.push("HTML parse error");
  }

  return {kind:kind, rows:rows, warnings:warnings};
}

function pb10MergeRows(datasets){
  // datasets: [{rank:number, rows:[...]}]
  var byDate = {};
  function mergeOne(date, incoming){
    var cur = byDate[date];
    if (!cur){ byDate[date] = {rank: incoming.__rank, row: incoming}; return; }
    // If incoming has higher rank (lower number) replace fields deterministically
    if (incoming.__rank < cur.rank){
      // merge field-by-field: incoming non-null wins
      var base = cur.row;
      var out = {
        date: date,
        numbers: incoming.numbers || base.numbers || null,
        powerball: (incoming.powerball!==null && incoming.powerball!==undefined) ? incoming.powerball : (base.powerball!==null && base.powerball!==undefined ? base.powerball : null),
        jackpot: (incoming.jackpot!==null && incoming.jackpot!==undefined) ? incoming.jackpot : (base.jackpot!==null && base.jackpot!==undefined ? base.jackpot : null),
        jackpotWon: (incoming.jackpotWon===true || incoming.jackpotWon===false) ? incoming.jackpotWon : base.jackpotWon,
        cashValue: (incoming.cashValue!==null && incoming.cashValue!==undefined) ? incoming.cashValue : (base.cashValue!==null && base.cashValue!==undefined ? base.cashValue : null),
        multiplier: (incoming.multiplier!==null && incoming.multiplier!==undefined) ? incoming.multiplier : (base.multiplier!==null && base.multiplier!==undefined ? base.multiplier : null)
      };
      byDate[date] = {rank: incoming.__rank, row: out};
    } else {
      // same or lower precedence: fill only missing fields
      var base2 = cur.row;
      var out2 = {
        date: date,
        numbers: base2.numbers || incoming.numbers || null,
        powerball: (base2.powerball!==null && base2.powerball!==undefined) ? base2.powerball : incoming.powerball,
        jackpot: (base2.jackpot!==null && base2.jackpot!==undefined) ? base2.jackpot : incoming.jackpot,
        jackpotWon: (base2.jackpotWon===true || base2.jackpotWon===false) ? base2.jackpotWon : incoming.jackpotWon,
        cashValue: (base2.cashValue!==null && base2.cashValue!==undefined) ? base2.cashValue : incoming.cashValue,
        multiplier: (base2.multiplier!==null && base2.multiplier!==undefined) ? base2.multiplier : incoming.multiplier
      };
      byDate[date] = {rank: cur.rank, row: out2};
    }
  }

  for (var d=0; d<datasets.length; d++){
    var rank = datasets[d].rank;
    var rows = datasets[d].rows || [];
    for (var i=0;i<rows.length;i++){
      var r = rows[i];
      if (!r || !pb10IsoDateOk(r.date)) continue;
      var inc = pb10NormalizeRowLike(r);
      if (!inc) continue;
      inc.__rank = rank;
      mergeOne(inc.date, inc);
    }
  }

  var outRows = Object.keys(byDate).sort().map(function(date){ return byDate[date].row; });
  return outRows;
}

async function pb10HandleImportFiles(fileList){
  var files = Array.prototype.slice.call(fileList || []);
  if (!files.length){
    try{ toast("Enhancement #10: No files selected.", "warning"); }catch(e){}
    return;
  }

  pb10UiSetBusy(true);
  try{ toast("Enhancement #10: Importing draw history...", "info"); }catch(e){}

  var datasets = [];
  var allWarnings = [];

  // ranks: lower is higher precedence
  function rankForFile(f, kind){
    var name = (f && f.name ? f.name.toLowerCase() : "");
    if (kind === "json") return 50;
    if (kind === "csv") return 60;
    if (kind === "winners") return 40;
    if (name.indexOf("archive") !== -1) return 20;
    if (name.indexOf("numbers") !== -1) return 30;
    return 30;
  }

  var fullObj = null;
  for (var i=0;i<files.length;i++){
    var f = files[i];
    var name = (f.name || "").toLowerCase();
    var text = await pb10ReadFileAsText(f);

    if (name.endsWith('.json')){
      var pj = pb10ParseJsonText(text);
      allWarnings = allWarnings.concat(pj.warnings || []);
      if (pj.full && !fullObj) fullObj = pj.full;
      if (pj.rows && pj.rows.length) datasets.push({rank: rankForFile(f, "json"), rows: pj.rows});
      continue;
    }
    if (name.endsWith('.csv')){
      var pc = pb10ParseCsvText(text);
      allWarnings = allWarnings.concat(pc.warnings || []);
      if (pc.rows && pc.rows.length) datasets.push({rank: rankForFile(f, "csv"), rows: pc.rows});
      continue;
    }

    // treat as HTML
    var ph = pb10ParseHtmlText(text);
    allWarnings = allWarnings.concat(ph.warnings || []);
    if (ph.rows && ph.rows.length) datasets.push({rank: rankForFile(f, ph.kind || "html"), rows: ph.rows});
  }

  var rawCandidate = null;
  if (fullObj){
    rawCandidate = fullObj;
  } else {
    var merged = pb10MergeRows(datasets);
    rawCandidate = {
      schemaVersion: "PB_POWERBALL_NET_DRAW_HISTORY_V1",
      generatedAt: "",
      source: {
        provider: "powerball.net",
        retrievedAt: "",
        note: "Parsed from locally imported Powerball.net HTML/CSV/JSON."
      },
      lastJackpotWinDate: null,
      draws: merged,
      quality: {
        drawCount: merged.length,
        hasJackpotSeries: false,
        hasWinMarkers: false,
        warnings: []
      }
    };
  }

  // Validate and normalize
  var v = pb10ValidateAndNormalize(rawCandidate);
  if (!v.ok){
    try{ toast("Enhancement #10: Import rejected (" + v.reason + ").", "error"); }catch(e){}
    return;
  }

  // Deterministic timestamps derived from most recent draw date
  var iso = pb10NowIsoFromMostRecent(v.derived);
  v.normalized.generatedAt = iso;
  v.normalized.source.retrievedAt = iso;
  v.normalized.source.note = "Parsed from locally imported Powerball.net HTML/CSV/JSON. Timestamps derived deterministically from most recent draw date.";

  // Append warnings discovered during import
  try {
    v.normalized.quality.warnings = (v.normalized.quality.warnings || []).concat(allWarnings);
  } catch(e){}

  // Atomic commit to cache (do not wipe on failure)
  try {
    localStorage.setItem(PB10_CACHE_KEY, JSON.stringify(v.normalized));
  } catch(e){
    try{ toast("Enhancement #10: Unable to save cache to localStorage.", "error"); }catch(_e){}
    pb10UiSetBusy(false);
    return;
  }

  // Publish + update UI
  try { window.PB_POWERBALL_NET_DRAW_HISTORY_V1 = v.normalized; } catch(e){}
  pb10UiUpdateFrom(v.normalized, v.derived);
  pb10UiSetBusy(false);

  // Notify based on readiness
  try {
    if (v.derived && v.derived.jefReady) toast("Enhancement #10: Draw history loaded (JEF READY).", "success");
    else toast("Enhancement #10: Draw history loaded (INSUFFICIENT for JEF).", "warning");
  } catch(e){}
}



// Deliverable 10.5 — Direct Fetch ingestion (single-threaded, deterministic, fail-closed)
function pb10Sleep(ms){
  return new Promise(function(resolve){ setTimeout(resolve, ms); });
}

function pb10FetchWithRetry(url, maxAttempts){
  maxAttempts = (typeof maxAttempts === 'number' && maxAttempts>0) ? maxAttempts : 2;
  var attempt = 0;
  function once(){
    attempt++;
    return fetch(url, {method:'GET', mode:'cors', credentials:'omit'}).then(function(resp){
      if (resp && resp.ok) return resp.text();
      var status = resp ? resp.status : 0;
      if (attempt < maxAttempts){
        return pb10Sleep(2000).then(once);
      }
      throw new Error('Fetch failed: ' + url + ' (HTTP ' + status + ')');
    }).catch(function(err){
      if (attempt < maxAttempts){
        return pb10Sleep(2000).then(once);
      }
      throw err;
    });
  }
  return once();
}

function pb10ParseWinnersWinDates(html, warnings){
  warnings = warnings || [];
  var out = {};
  try {
    var doc = new DOMParser().parseFromString(html, 'text/html');
    var text = (doc && doc.body) ? (doc.body.textContent || '') : '';
    // Extract ISO-like dates (YYYY-MM-DD)
    var re = /(20\d{2}|19\d{2})-(\d{2})-(\d{2})/g;
    var m;
    while ((m = re.exec(text))){
      var d = m[0];
      if (pb10IsoDateOk(d)) out[d] = true;
    }
    // Also try Month DD, YYYY patterns and convert
    var re2 = /(January|February|March|April|May|June|July|August|September|October|November|December)\s+(\d{1,2}),\s+(20\d{2}|19\d{2})/g;
    var months = {January:1,February:2,March:3,April:4,May:5,June:6,July:7,August:8,September:9,October:10,November:11,December:12};
    while ((m = re2.exec(text))){
      var mm = months[m[1]];
      var dd = parseInt(m[2],10);
      var yy = parseInt(m[3],10);
      if (mm && dd && yy){
        var iso = yy + '-' + String(mm).padStart(2,'0') + '-' + String(dd).padStart(2,'0');
        if (pb10IsoDateOk(iso)) out[iso] = true;
      }
    }
  } catch(e){
    warnings.push('Unable to parse winners page: ' + (e && e.message ? e.message : 'unknown error'));
  }
  return out;
}

function pb10ParseArchiveDrawRows(html, warnings){
  warnings = warnings || [];
  var rows = [];
  try {
    var doc = new DOMParser().parseFromString(html, 'text/html');
    if (!doc) return rows;
    // heuristic: find links to /numbers/YYYY-MM-DD and treat each as draw row anchor
    var links = Array.prototype.slice.call(doc.querySelectorAll('a[href*="/numbers/"]'));
    var seen = {};
    links.forEach(function(a){
      var href = a.getAttribute('href') || '';
      var m = href.match(/\/numbers\/(\d{4}-\d{2}-\d{2})/);
      if (!m) return;
      var date = m[1];
      if (!pb10IsoDateOk(date) || seen[date]) return;
      seen[date] = true;
      // try to capture the table row text around the link
      var tr = a.closest('tr');
      var t = tr ? (tr.textContent || '') : (a.parentElement ? (a.parentElement.textContent || '') : (a.textContent || ''));
      t = (t || '').replace(/\s+/g,' ').trim();

      // numbers extraction: look for 5 mains + PB after the date
      var nums = [];
      var pb = null;
      // collect all integers 1..69/26 within the row
      var ints = t.match(/\d{1,2}/g) || [];
      var intsN = ints.map(function(x){return parseInt(x,10);}).filter(function(x){return isFinite(x);});
      // A rough heuristic: after removing year/month/day parts from date, remaining small ints likely include numbers
      // We'll attempt to find a 6-number sequence where last <=26 and first five <=69.
      for (var i=0; i+5<intsN.length; i++){
        var cand = intsN.slice(i,i+6);
        if (cand.length!==6) continue;
        var mains = cand.slice(0,5);
        var pbCand = cand[5];
        if (mains.every(function(x){return x>=1 && x<=69;}) && pbCand>=1 && pbCand<=26){
          nums = mains.slice();
          pb = pbCand;
          break;
        }
      }
      if (nums.length===5) nums.sort(function(a,b){return a-b;});
      else nums = null;

      // jackpot and cash: find $ amounts
      var dollars = [];
      var dm;
      var reMoney = /\$\s*([0-9]{1,3}(?:,[0-9]{3})*(?:\.[0-9]{1,2})?)/g;
      while ((dm = reMoney.exec(t))){
        dollars.push(dm[1]);
      }
      var jackpot = dollars.length ? pb10ParseMoney('$'+dollars[0]) : null;
      var cashValue = (dollars.length>1) ? pb10ParseMoney('$'+dollars[1]) : null;

      // explicit jackpot won marker if present in row text
      var jw = null;
      var low = t.toLowerCase();
      if (low.includes('jackpot won') || low.includes('won jackpot') || low.includes('won!')) jw = true;
      if (low.includes('rollover')) jw = false;
      if (low.match(/no/) && low.includes('jackpot')) jw = false;
      if (low.match(/yes/) && low.includes('jackpot')) jw = true;

      rows.push({date:date, numbers:nums, powerball:pb, jackpot:jackpot, cashValue:cashValue, jackpotWon:jw, multiplier:null});
    });
  } catch(e){
    warnings.push('Unable to parse archive page: ' + (e && e.message ? e.message : 'unknown error'));
  }
  return rows;
}

function pb10BuildHistoryFromFetched(datasets, winDatesMap, retrievedAtIso, warnings){
  warnings = warnings || [];
  var byDate = {};

  // datasets: array of {rank, draws[]} where lower rank wins
  datasets.sort(function(a,b){return a.rank-b.rank;});
  datasets.forEach(function(ds){
    (ds.draws||[]).forEach(function(r){
      if (!r || !pb10IsoDateOk(r.date)) return;
      if (!byDate[r.date]) byDate[r.date] = {rank:ds.rank, row:r};
      else {
        // field-level merge: keep first non-null by precedence
        var cur = byDate[r.date].row;
        var next = r;
        function take(field){
          if (cur[field] === null || cur[field] === undefined || cur[field] === ''){
            if (!(next[field] === null || next[field] === undefined || next[field] === '')) cur[field] = next[field];
          }
        }
        take('numbers'); take('powerball'); take('jackpot'); take('cashValue'); take('multiplier');
        if (cur.jackpotWon === null || cur.jackpotWon === undefined){
          if (next.jackpotWon === true || next.jackpotWon === false) cur.jackpotWon = next.jackpotWon;
        }
      }
    });
  });

  // apply winners-derived win markers (confirmatory)
  try {
    Object.keys(winDatesMap||{}).forEach(function(d){
      if (!pb10IsoDateOk(d)) return;
      if (!byDate[d]) byDate[d] = {rank:99, row:{date:d,numbers:null,powerball:null,jackpot:null,cashValue:null,multiplier:null,jackpotWon:true}};
      else {
        byDate[d].row.jackpotWon = true;
      }
    });
  } catch(e){}

  var draws = Object.keys(byDate).map(function(k){return byDate[k].row;});
  draws.sort(function(a,b){return a.date.localeCompare(b.date);});

  // derive lastJackpotWinDate from jackpotWon true after normalize
  var obj = {
    schemaVersion: 'PB_POWERBALL_NET_DRAW_HISTORY_V1',
    generatedAt: new Date().toISOString(),
    source: {
      provider: 'powerball.net',
      retrievedAt: retrievedAtIso,
      note: 'Parsed from Powerball.net historical results page(s).'
    },
    lastJackpotWinDate: null,
    draws: draws,
    quality: {drawCount:draws.length, hasJackpotSeries:false, hasWinMarkers:false, warnings:(warnings||[]).slice(0)}
  };
  return obj;
}

function pb10DirectFetchFlow(openImportPicker){
  // One-click: probe, then ingest archives+winners+numbers if possible; else fallback to import.
  pb10UiSetBusy(true);
  try{ toast('Enhancement #10: Direct fetch enabled. Probing access...', 'info'); }catch(e){}

  // Read year range
  var startYear = null, endYear = null;
  try {
    startYear = parseInt((document.getElementById('pbNetHistoryFetchStartYear')||{}).value,10);
    endYear = parseInt((document.getElementById('pbNetHistoryFetchEndYear')||{}).value,10);
  } catch(e){}
  if (!isFinite(startYear)) startYear = (new Date().getFullYear() - 10);
  if (!isFinite(endYear)) endYear = (new Date().getFullYear());
  if (startYear > endYear){ var tmp = startYear; startYear = endYear; endYear = tmp; }
  if (endYear - startYear + 1 > 15){
    startYear = endYear - 14;
    try{ toast('Enhancement #10: Year range capped to 15 years for safety.', 'warning', 4500); }catch(e){}
  }

  // Probe
  try {
    fetch('https://www.powerball.net/numbers/', {method:'GET', mode:'cors', credentials:'omit'}).then(function(resp){
      if (!(resp && resp.ok)) throw new Error('Probe failed');
      return resp.text();
    }).then(function(numbersHtml){
      // proceed ingestion
      return (async function(){
        var warnings = [];
        var retrievedAt = new Date().toISOString();
        var pagesFetched = 0;
        // winners
        var winnersHtml = '';
        try {
          winnersHtml = await pb10FetchWithRetry('https://www.powerball.net/winners', 2);
          pagesFetched++;
          await pb10Sleep(750);
        } catch(e){
          warnings.push('Direct fetch: winners page unavailable (' + (e && e.message ? e.message : 'error') + ')');
        }
        var winDatesMap = winnersHtml ? pb10ParseWinnersWinDates(winnersHtml, warnings) : {};

        // archives
        var datasets = [];
        var years = [];
        for (var y=endYear; y>=startYear; y--) years.push(y);
        for (var i=0; i<years.length; i++){
          if (pagesFetched >= 25){ warnings.push('Direct fetch: page cap reached (25).'); break; }
          var yv = years[i];
          var url = 'https://www.powerball.net/archive/' + yv;
          try {
            var html = await pb10FetchWithRetry(url, 2);
            pagesFetched++;
            var draws = pb10ParseArchiveDrawRows(html, warnings);
            datasets.push({rank:20, draws:draws});
          } catch(e){
            warnings.push('Direct fetch: failed to fetch ' + url + ' (' + (e && e.message ? e.message : 'error') + ')');
            // fail-closed stop on hard fetch failure
            throw e;
          }
          await pb10Sleep(750);
        }

        // numbers index (already fetched in probe)
        try {
          var draws2 = pb10ParseArchiveDrawRows(numbersHtml, warnings); // use same parser heuristic
          datasets.push({rank:30, draws:draws2});
        } catch(e){
          warnings.push('Direct fetch: unable to parse numbers index.');
        }

        // Build and validate
        var built = pb10BuildHistoryFromFetched(datasets, winDatesMap, retrievedAt, warnings);
        var v = pb10ValidateAndNormalize(built);
        if (!v.ok){
          throw new Error('Direct fetch produced invalid schema: ' + (v.reason||'unknown'));
        }

        // Commit atomically (preserve last-known-good on failure)
        try {
          localStorage.setItem(PB10_CACHE_KEY, JSON.stringify(v.normalized));
        } catch(e){
          throw new Error('Unable to save cache to localStorage.');
        }

        // Publish + update UI
        try { window.PB_POWERBALL_NET_DRAW_HISTORY_V1 = v.normalized; } catch(e){}
        pb10UiUpdateFrom(v.normalized, v.derived);

        pb10UiSetBusy(false);
        try{ toast('Enhancement #10: Direct fetch complete. drawCount=' + v.derived.drawCount + (v.derived.jefReady ? ' (JEF-ready)' : ' (INSUFFICIENT for JEF)'), v.derived.jefReady ? 'success' : 'warning', 6500); }catch(e){}
      })();
    }).catch(function(err){
      pb10UiSetBusy(false);
      try{ toast('Enhancement #10: Direct fetch blocked or failed. Falling back to Import. (' + (err && err.message ? err.message : 'error') + ')', 'warning', 6500); }catch(e){}
      try{ if (typeof openImportPicker === 'function') openImportPicker(); }catch(e){}
    });
  } catch(e){
    pb10UiSetBusy(false);
    try{ toast('Enhancement #10: Direct fetch not available. Use Import.', 'warning', 6500); }catch(_e){}
    try{ if (typeof openImportPicker === 'function') openImportPicker(); }catch(_e){}
  }
}
function pb10WireScaffoldButtons(){
  try {
    var loadBtn = document.getElementById("pbNetHistoryLoadBtn");
    var expBtn = document.getElementById("pbNetHistoryExportBtn");
    var fileInput = document.getElementById("pbNetHistoryFileInput");

    if (fileInput){
      fileInput.addEventListener("change", function(){
        try {
          if (fileInput.files && fileInput.files.length){
            pb10HandleImportFiles(fileInput.files);
          }
        } finally {
          // allow re-selecting same file
          try { fileInput.value = ""; } catch(e){}
        }
      });
    }

    if (loadBtn){
      loadBtn.addEventListener("click", function(){
        // Deliverable 10.4: One-click workflow.
        // If Direct Fetch (probe) is enabled, attempt a lightweight probe first.
        var doProbe = false;
        try {
          var t = document.getElementById("pbNetHistoryFetchToggle");
          doProbe = !!(t && t.checked);
        } catch(e){ doProbe = false; }

        function openImportPicker(){
          if (fileInput){
            try{ fileInput.click(); }catch(e){
              try{ toast("Enhancement #10: File picker blocked. Use the import control directly.", "warning"); }catch(_e){}
            }
          } else {
            try{ toast("Enhancement #10: Import control unavailable.", "error"); }catch(_e){}
          }
        }

        if (!doProbe){
          openImportPicker();
          return;
        }

        // Deliverable 10.5: Direct fetch ingestion (archives + winners + numbers index)
        pb10DirectFetchFlow(openImportPicker);
      });
    }

    if (expBtn){
      expBtn.addEventListener("click", function(){
        pb10ExportDrawHistoryJson();
      });
    }
  } catch(e){}
}

// Initialize vE10 D3 publisher/cache loader

try {
  pb10WireScaffoldButtons();
  pb10PublishAndRenderFromCache();
} catch(e){}


// D6 self-test wiring (optional UI; does not alter production behavior)
var bInstall = $("jefD6InstallMocksBtn");
var bClear = $("jefD6ClearMocksBtn");
var bRun = $("jefD6RunTestsBtn");
if (bInstall) bInstall.addEventListener("click", function(){
  if (window.__PB_ALLOW_MOCKS === true){
    installJefD6Mocks();
    try{ toast("JEF D6: Deterministic mock inputs installed.", "info"); }catch(e){}
  } else {
    try{ toast("JEF D6 mocks are disabled in vE10. Load Powerball.net history via Enhancement #10 instead.", "warning"); }catch(e){}
  }
});
if (bClear) bClear.addEventListener("click", function(){
  try{ clearJefD6Mocks(); }catch(e){}
  try{ toast("JEF D6: Mocks cleared / restored.", "info"); }catch(e){}
});
if (bRun) bRun.addEventListener("click", function(){ runJefD6Tests(); });

  }

  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", wire);
  } else {
    wire();
  }
})();
</script>
</body></html>